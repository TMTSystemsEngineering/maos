<!DOCTYPE html>
<html lang="en">
    <head>
	<meta charset=utf-8 http-equiv="Content-Language" content="en"/>
	<title>MAOS Monitor</title>
	<style type="text/css">
	 .title { 
	     font-size:24pt; 
	     font: Arial; 
	     font-weight:normal; 
	     text-align:center; 
	     color:#000; 
	 }
	 
	 table.monitor{
	     border-spacing:0 0;
	     border-style:solid;
	     border-color:black;
	     border-width:2px 1px 1px 2px;
	     table-layout:fixed;
	     max-width:100%;
	 }
	 table.monitor tr td,th
	 {
	     border-width:0px 1px 1px 0;
	     border-style:solid;
	     border-color:#AAA;
	     vertical-align:top;
	     white-space:nowrap;
	 }
	 table.monitor tr th{
	     border-width:0px 1px 1px 0;
	     text-align: center;
	 }
	 table.monitor tr:nth-child(odd){
	     background-color:#EEE
	 }
	 table.monitor tr .expandable{
	     width:100%;
	     white-space:normal;
	     text-align:left;
	 }
	 div.progress {
	     background: white;
	     position: relative;
	     text-align:left;
	 }
	 div.bar {
	     background: #10DD10;
	     color: white;
	     height: 20px;
	     vertical-align:middle
	 } 
	 span.bar {
	     position: absolute;
	     top: 0px;
	     vertical-align:middle
	     z-index: 2;
	     color: #000;
	     text-align: center;
	     width: 100%;
	 }

	</style>
	<script>
	 var socket_lm;
	 function clear_all(kind){
	     var joblist=document.getElementById("joblist");
	     cmd=[];
	     for (irow=1; irow<joblist.rows.length; irow++){
                 var status=joblist.rows[irow].cells[9].firstChild.getAttribute("status");
                 if((status==11 && kind==1) || (status>11 && kind==2)){
                     var pid=joblist.rows[irow].cells[9].firstChild.getAttribute("pid");
		     cmd[cmd.length]=pid+"&REMOVE;";
	         }
	     }
	     for(icmd=0; icmd<cmd.length; icmd++){
		 socket_lm.send(cmd[icmd]);
	     }
	 }
	 function kill_all(){
	     if(!window.confirm("Kill all jobs?")){
	         return;
	     }
	     cmd=[];
	     var joblist=document.getElementById("joblist");
	     for (irow=1; irow<joblist.rows.length; irow++){
                 var status=joblist.rows[irow].cells[9].firstChild.getAttribute("status");
                 var pid=joblist.rows[irow].cells[9].firstChild.getAttribute("pid");
                 if(status<10){
		     cmd[cmd.length]=pid+"&KILL;";
	         }
	     }
	     for(icmd=0; icmd<cmd.length; icmd++){
		 socket_lm.send(cmd[icmd]);
	     }
	 }
	</script>
    </head>

    <body>
	<header></header>
	<article>
	    <table width="100%">
		<tr><td class="title">MAOS Monitor</td></tr>
		<tr><td align="center" id="monitor_status">Not initialized</td></tr>
	    </table>
	    <table>
		<tr>
		    <td><button onclick="clear_all(1)">Clear Finished</button></td>
		    <td><button onclick="clear_all(2)">Clear Crashed</button></td>
		    <td><button onclick="kill_all()">Kill All</button></td>
		</tr>
	    </table>
	    <table id="joblist" class="monitor">
		<tr>
		    <th>Time</th>
		    <th>PID</th>
		    <th class="expandable">Path</th>
		    <th>Out</th>
		    <th>Low</th>
		    <th>High</th>
		    <th>Seed</th>
		    <th>Step</th>
		    <th>Timing</th>
		    <th> </th>
		</tr>
	    </table>
	</article>
	
	<script>

	 function new_progbar(width){
	     var div1=document.createElement("div");
	     div1.className="progress";
	     div1.style.width=width;
	     var div2=document.createElement("div");
	     div2.className="bar";
	     div2.style.width="0%";
	     var span1=document.createElement("span");
	     span1.className="bar";
	     span1.innerHTML="test";
	     div1.appendChild(div2);
	     div1.appendChild(span1);
	     return div1;
	 }
	 function progbar_set(progbar, i1, i2){
	     frac=0;
	     if(parseInt(i2)>0){
		 frac=Math.round(parseInt(i1)/parseInt(i2)*100);
	     }
	     progbar.childNodes[0].style.width=frac+'%';
	     progbar.childNodes[1].innerHTML=i1+'/'+i2;
	 }
	 function new_button(name){
	     var button=document.createElement("input");
	     button.type="image";
	     button.src=name;
	     button.setAttribute("url", name);
	     return button;
	 }

	 var button_wait=new_button("button-wait.png")
	 var button_ok=new_button("button-ok.png")
	 var button_play=new_button("button-play.png");
	 var button_err=new_button("button-err.png");
	 var pos = 0;
	 function sec2str(secstr){
	     var sec=parseInt(secstr);
	     var min=Math.floor(sec/60);
	     var hr=Math.floor(min/60);
	     return hr+':'+min;
	 }
	 function get_appropriate_ws_url()
	 {
	     var pcol;
	     var u = document.URL;

	     /*
	      * We open the websocket encrypted if this page came on an
	      * https:// url itself, otherwise unencrypted
	      */

	     if (u.substring(0, 5) == "https") {
		 pcol = "wss://";
		 u = u.substr(8);
	     } else {
		 pcol = "ws://";
		 if (u.substring(0, 4) == "http")
		 u = u.substr(7);
	     }

	     u = u.split('/');

	     /* + "/xxx" bit is for IE10 workaround */

	     return pcol + u[0] + "/xxx";
	 }


	 /*document.getElementById("host_ip").textContent = document.URL.split('/')[2];*/

	 /* maos-monitor protocol */

	 function setchild(cell, button){
	     if(cell.firstChild){
		 cell.replaceChild(button.cloneNode(false), cell.firstChild);
	     }else{
		 cell.appendChild(button.cloneNode(false));
	     }
	 }
	 function websocket_start(){
	     if (typeof MozWebSocket != "undefined") {
		 socket_lm = new MozWebSocket(get_appropriate_ws_url(), "maos-monitor-protocol");
	     } else {
		 socket_lm = new WebSocket(get_appropriate_ws_url(), "maos-monitor-protocol");
	     }
	     socket_lm.onopen = function() {
		 document.getElementById("monitor_status").style.color = "#40dd40";
		 document.getElementById("monitor_status").textContent = "Connected";
		 var joblist=document.getElementById("joblist");
		 var nrow=joblist.rows.length;
		 for(irow=1; irow<nrow; irow++){
		     joblist.deleteRow(-1);
		 }
	     } 
	     socket_lm.onmessage =function got_packet(msg) {
		 j = msg.data.split(';');
		 var joblist=document.getElementById("joblist");
		 for (var f=0; f < j.length - 1; f++) {
		     i = j[f].split('&');
		     var row=null;
		     var irow;
		     for(irow=1; irow<joblist.rows.length; irow++){
			 if(joblist.rows[irow].cells[1].innerHTML == i[0]){
			     row=joblist.rows[irow];
			     break;
			 }
		     }
		     if(i[3]==14){/*remove*/
			 if(row){
			     joblist.deleteRow(irow);
			 }
			 continue;
		     }
		     if(!row){
			 row=joblist.insertRow(-1);
			 for(var j=0; j<10; j++){
			     row.insertCell(-1);
			     row.cells[j].align="right";
			     if(j==2){
				 row.cells[j].className="expandable";
			     }
			 }
			 row.cells[1].innerHTML=i[0];
			 row.cells[6].appendChild(new_progbar("50px"));
			 row.cells[7].appendChild(new_progbar("120px"));
		     }
		     if(i[1]=='PATH'){
			 var io=i[2].lastIndexOf("-o");
			 if(io>-1){
			     row.cells[3].innerHTML=i[2].substr(io+2).trim().split(' ')[0];
			     i[2]=i[2].replace(/[ \t]+-o[ \t]+[^ \t]+/g," ");
			 }
			 var slash;
			 if(i[2].length>100){
			     slash=i[2].indexOf(" ");
			 }else{
			     slash=-1;
			 }
			 if(slash>-1){
			     row.cells[2].innerHTML='<details><summary>'+i[2].substr(0, slash+1)+'</summary>'
			     +i[2].substr(slash+1)+'</details>'
			 }else{
			     row.cells[2].innerHTML=i[2];
			 }
		     }else{
			 if(i[0]!=i[2]){
			     row.cells[1].innerHTML=i[2];
			     i[0]=i[2];
			 }
			 row.cells[0].innerHTML=i[4];
			 row.cells[4].innerHTML=i[6];
			 row.cells[5].innerHTML=i[5];
			 var frac=0;
			 if(parseInt(i[8])>0){
			     frac=Math.round(parseInt(i[7])/parseInt(i[8])*100);
			 }
			 progbar_set(row.cells[6].firstChild, i[7], i[8]);
			 frac=0;
			 if(parseInt(i[10])>0){
			     frac=Math.round(parseInt(i[9])/parseInt(i[10])*100);
			 }
			 progbar_set(row.cells[7].firstChild, i[9], i[10]);
			 if(i[3]==1 || i[3]>10){
			     row.cells[8].innerHTML=i[13]+'s '+sec2str(i[11])+'/'+sec2str(i[12]);
			 }
			 if(row.cells[1].getAttribute("status")!=i[3]){
			     row.cells[1].setAttribute("status", i[3]);
			     var cell_tim=row.cells[8];
			     var cell_btn=row.cells[9];
			     if(i[3]==1){
				 setchild(cell_btn, button_play);
			     }else if(i[3]==2){
				 cell_tim.innerHTML="Waiting";
				 setchild(cell_btn, button_wait);
			     }else if(i[3]==3){
				 cell_tim.innerHTML="Started";
				 setchild(cell_btn, button_play);
			     }else if(i[3]==4){
				 cell_tim.innerHTML="Queued";
				 setchild(cell_btn, button_wait);
			     }else if(i[3]==11){
				 if(i[11]=='1'){
				     cell_tim.innerHTML="Skipped";
				 }
				 setchild(cell_btn, button_ok);
			     }else if(i[3]==12 || i[3]==15){
				 setchild(cell_btn, button_err);
				 row.cells[6].firstChild.style.background="red";
				 row.cells[7].firstChild.style.background="red";
			     }
			     cell_btn.firstChild.setAttribute("pid", i[0]);
			     cell_btn.firstChild.setAttribute("status", i[3]);
			     cell_btn.firstChild.onclick=function(){
				 pid=this.getAttribute("pid");
				 status=this.getAttribute("status");
				 if(status<10){
				     if(window.confirm("Kill the job "+pid+"?")){
					 socket_lm.send(pid+"&KILL;");
				     }
				 }else{
				     socket_lm.send(pid+"&REMOVE;");
				 }
			     }

			 }
		     }
		 }
	     }

	     socket_lm.onclose = function(){
		 document.getElementById("monitor_status").style.color = "#dd4040";
		 document.getElementById("monitor_status").textContent = "Disconnected";
		 setTimeout(websocket_start(), 5000);
	     }
	 } 
	 websocket_start();
	</script>

    </body>
</html>
