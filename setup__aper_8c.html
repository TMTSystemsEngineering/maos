<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.7.0: maos/setup_aper.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/setup_aper.c File Reference</h1>Contains routines that setup the telescope aperture.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__aper_8c.html#bf63108c7633e5a353e73cd913fc9c26">setup_aper</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *const parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setting up aperture cordinate grid aper_locs, and amplitude map for performance evaluation.  <a href="#bf63108c7633e5a353e73cd913fc9c26"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__aper_8c.html#ea65e60525339d2921549850d52e8464">free_aper</a> (<a class="el" href="structAPER__T.html">APER_T</a> *aper)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free the aper structure after simulation.  <a href="#ea65e60525339d2921549850d52e8464"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Contains routines that setup the telescope aperture. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="bf63108c7633e5a353e73cd913fc9c26"></a><!-- doxytag: member="setup_aper.c::setup_aper" ref="bf63108c7633e5a353e73cd913fc9c26" args="(const PARMS_T *const parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structAPER__T.html">APER_T</a>* setup_aper           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *const &nbsp;</td>
          <td class="paramname"> <em>parms</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setting up aperture cordinate grid aper_locs, and amplitude map for performance evaluation. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00034"></a>00034                                                {
<a name="l00035"></a>00035     <a class="code" href="structAPER__T.html" title="contains the data associated with the aperture and performance evaluation.">APER_T</a> *aper = calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structAPER__T.html" title="contains the data associated with the aperture and performance evaluation.">APER_T</a>));
<a name="l00036"></a>00036     <span class="keywordtype">double</span> d=parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>;
<a name="l00037"></a>00037     <span class="keywordtype">double</span> dx=parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#66e6d80a7720a91f8e4e13c1cfde9de6" title="sampling of aperture evaluation grid aper_locs">dx</a>;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     tic;
<a name="l00040"></a>00040     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#839e906a586c2d9152df418d24b46151">fnamp</a>){
<a name="l00041"></a>00041     aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>=sqmapread(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#839e906a586c2d9152df418d24b46151">fnamp</a>);
<a name="l00042"></a>00042     <span class="keywordflow">if</span>(fabs(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>-&gt;<a class="code" href="structMAP__T.html#7cad352b82624ab945b7808ea931f282" title="Heigh conjugation of this surface.">h</a>)&gt;1.e-14){
<a name="l00043"></a>00043         warning(<span class="stringliteral">"ampground is not on ground, this is not tested\n"</span>);
<a name="l00044"></a>00044     }
<a name="l00045"></a>00045     <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#bf64dffc1048f103b91ee16d94eee779" title="pupil rotation in degree">rotdeg</a>)&gt;1.e-12){
<a name="l00046"></a>00046         warning(<span class="stringliteral">"Pupil is rotated by %g deg\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#bf64dffc1048f103b91ee16d94eee779" title="pupil rotation in degree">rotdeg</a>);
<a name="l00047"></a>00047         <span class="keyword">const</span> <span class="keywordtype">long</span> nx=aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>;
<a name="l00048"></a>00048         <span class="keyword">const</span> <span class="keywordtype">long</span> ny=aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>;
<a name="l00049"></a>00049         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *A=<a class="code" href="dmat_8h.html#b14d47edec330a505cf684a2b0c4ff9c" title="Creat a X(mat) object to reference an already existing vector.">dnew_ref</a>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>, nx, ny);
<a name="l00050"></a>00050         <span class="keywordtype">double</span> *p2=calloc(nx*ny, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00051"></a>00051         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *B=<a class="code" href="dmat_8h.html#b14d47edec330a505cf684a2b0c4ff9c" title="Creat a X(mat) object to reference an already existing vector.">dnew_ref</a>(p2,nx,ny);
<a name="l00052"></a>00052         dembed(B,A,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#bf64dffc1048f103b91ee16d94eee779" title="pupil rotation in degree">rotdeg</a>/180.*M_PI);
<a name="l00053"></a>00053         dfree(A);dfree(B);
<a name="l00054"></a>00054         free(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>);
<a name="l00055"></a>00055         aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>=p2;
<a name="l00056"></a>00056     }
<a name="l00057"></a>00057     }
<a name="l00058"></a>00058  
<a name="l00059"></a>00059     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#5135392a069ae13d9ebde8adaffea62b" title="load aper_locs from">locs</a>){
<a name="l00060"></a>00060     <span class="keywordtype">char</span> *fn=parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#5135392a069ae13d9ebde8adaffea62b" title="load aper_locs from">locs</a>;
<a name="l00061"></a>00061     <span class="keywordflow">if</span>(!exist(fn)) error(<span class="stringliteral">"%s doesn't exist\n"</span>,fn);
<a name="l00062"></a>00062     warning(<span class="stringliteral">"Loading plocs from %s\n"</span>,fn);
<a name="l00063"></a>00063     aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>=locread(<span class="stringliteral">"%s"</span>,fn);
<a name="l00064"></a>00064     }<span class="keywordflow">else</span>{
<a name="l00065"></a>00065     <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a> &amp;&amp; fabs(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>-&gt;<a class="code" href="structMAP__T.html#49015864cb8861d6ecf4b6a88596ee3c" title="Sampling along x and y.">dx</a>-dx)&lt;1.e-6){
<a name="l00066"></a>00066         <span class="comment">//LOCSTAT records the starting of each row to speed up accphi</span>
<a name="l00067"></a>00067         aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structLOCSTAT__T.html" title="Stores array of LOCSTATCOL_T.">LOCSTAT_T</a>));
<a name="l00068"></a>00068         info2(<span class="stringliteral">"Using amplitude map to generate aper grid\n"</span>);
<a name="l00069"></a>00069         aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>=<a class="code" href="loc_8c.html#c39f6b04baf0ef52615a08bbaf436b5b" title="Create LOC map when amplitude map is specified, within a maximum diameter.">mkcirloc_amp</a>(&amp;(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>), aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>,
<a name="l00070"></a>00070              aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>, d, dx,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#81a255b232f654f6b7e2e9dd2814e4c4" title="1: if amplitude are nonzero outside of d, zero it.">cropamp</a>);
<a name="l00071"></a>00071     }<span class="keywordflow">else</span>{
<a name="l00072"></a>00072         <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> *pmap=<a class="code" href="maos_2utils_8c.html#aba5a9d494e2fc4ef56edd11248b41e9" title="Calls create_metapupil is simplified interface by returning a MAP_T object.">create_metapupil_wrap</a>(parms,0,dx,0,0,0,T_PLOC,0,0);
<a name="l00073"></a>00073         aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>=<a class="code" href="loc_8c.html#65eae1500aa879b31c5a7962ad9191c5" title="convert a sqmap to a loc object.">sqmap2loc</a>(pmap);
<a name="l00074"></a>00074         sqmapfree(pmap);
<a name="l00075"></a>00075         warning(<span class="stringliteral">"No amplitude map defined or matched to aperture dx.\n"</span>);
<a name="l00076"></a>00076     }  
<a name="l00077"></a>00077     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00078"></a>00078         locwrite(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>, <span class="stringliteral">"%s/aper_locs.bin.gz"</span>,dirsetup);
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081     <span class="keywordflow">if</span>(!aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>){
<a name="l00082"></a>00082     aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>=<a class="code" href="loc_8c.html#170d44a83173dd4e3295a4581bbdaf23" title="Gather information about the starting of each column in loc.">mklocstat</a>(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>);
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084     <span class="keywordflow">if</span>(!aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>){
<a name="l00085"></a>00085     aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>=calloc(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00086"></a>00086     <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>){
<a name="l00087"></a>00087         <a class="code" href="accphi_8c.html#ddff6b827e73815196b2a7bbd1b370f4" title="Propagate OPD defines on grid mapin to locstat_t that stores the starting point of...">prop_grid_stat</a>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>, aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>,
<a name="l00088"></a>00088                aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>, 1, 0, 0, 1, 0, 0, 0, 1);
<a name="l00089"></a>00089     }<span class="keywordflow">else</span>{
<a name="l00090"></a>00090         warning(<span class="stringliteral">"Using loccircle to create a gray pixel aperture\n"</span>);
<a name="l00091"></a>00091         <a class="code" href="loc_8c.html#f4c56dfe0e83ab030da1eaac733aae02" title="Create a gray pixel circular map in phi using coordinates defined in loc, center...">loccircle</a>(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,0,0,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>*0.5,1);
<a name="l00092"></a>00092         <a class="code" href="loc_8c.html#f4c56dfe0e83ab030da1eaac733aae02" title="Create a gray pixel circular map in phi using coordinates defined in loc, center...">loccircle</a>(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,0,0,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#5f2d4b89322d5de7b49f7f274807ff93" title="Telescope inner blocking diameter.">din</a>*0.5,-1);
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095     <span class="comment">//normalize amp to sum to 1.</span>
<a name="l00096"></a>00096     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#2208400c2f1150a63417cd38f3e01f53" title="Plot various information in setup process.">setup</a> ||parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a>){
<a name="l00097"></a>00097     aper-&gt;<a class="code" href="structAPER__T.html#bda68ec718e6c59283e9893dd9abd7db" title="amplitude map defined o locs, maximum is 1.">amp1</a>=malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>);
<a name="l00098"></a>00098     memcpy(aper-&gt;<a class="code" href="structAPER__T.html#bda68ec718e6c59283e9893dd9abd7db" title="amplitude map defined o locs, maximum is 1.">amp1</a>, aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>);
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100     <a class="code" href="mathmisc_8c.html#c80bb740d5184ab44318b505ee66d13b" title="normalize vector to sum to norm;">normalize</a>(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>, aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>, 1);
<a name="l00101"></a>00101     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#2208400c2f1150a63417cd38f3e01f53" title="Plot various information in setup process.">setup</a>){
<a name="l00102"></a>00102     <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"amp"</span>,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,aper-&gt;<a class="code" href="structAPER__T.html#bda68ec718e6c59283e9893dd9abd7db" title="amplitude map defined o locs, maximum is 1.">amp1</a>,<span class="stringliteral">"Aperture Amplitude Map"</span>,
<a name="l00103"></a>00103         <span class="stringliteral">"x (m)"</span>,<span class="stringliteral">"y (m)"</span>,<span class="stringliteral">"aper"</span>);
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105     aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>=<a class="code" href="loc_8c.html#922085291bebb517283cf380efe5cacf" title="assemble modes of piston/tip/tilt into Nx3 matrix M, and compute their inverse covariance...">loc_mcc_ptt</a>(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>, aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>);
<a name="l00106"></a>00106     aper-&gt;<a class="code" href="structAPER__T.html#a0c4649669d4a65aed9127f986efb5f6" title="piston term in imcc.">ipcc</a>=1./aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];<span class="comment">//piston inverse. should be 1 since amp is normlaized.</span>
<a name="l00107"></a>00107     aper-&gt;<a class="code" href="structAPER__T.html#a28b4297d4a9d7a58d2474f003b522a7" title="inverse of mode cross coupling for evaluations.">imcc</a>=<a class="code" href="dmat_8h.html#30ba84a58a9c9dd2e0a0afb5e389ffad" title="out of place version of dinvspd_inplace">dinvspd</a>(aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>);<span class="comment">//pttr inverse</span>
<a name="l00108"></a>00108     <span class="comment">//piston term correction in focus mode</span>
<a name="l00109"></a>00109     aper-&gt;<a class="code" href="structAPER__T.html#f051a7aef05263d8ee294756d19e9f0d" title="piston correction in focus term.">fcp</a>=(aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>+1]+aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[2*(aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>+1)])*aper-&gt;<a class="code" href="structAPER__T.html#a0c4649669d4a65aed9127f986efb5f6" title="piston term in imcc.">ipcc</a>;
<a name="l00110"></a>00110     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dca4ace9f4c301647cefd28a489320ce" title="max radial mode for performance evaluation.">rmax</a>!=1){
<a name="l00111"></a>00111     aper-&gt;<a class="code" href="structAPER__T.html#552e29223bf8c2355f6e85eb7e264b27" title="modal columne vectors if parms-&amp;gt;evl.nmax&amp;gt;1">mod</a>=<a class="code" href="loc_8c.html#a9cbc07c7f95ba6d238a2c3e29c4bed6" title="Create Zernike modes on loc with radius R and radial order upto nr nr=0 is piston...">loc_zernike</a>(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>, parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/2, parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dca4ace9f4c301647cefd28a489320ce" title="max radial mode for performance evaluation.">rmax</a>);
<a name="l00112"></a>00112     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00113"></a>00113         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(aper-&gt;<a class="code" href="structAPER__T.html#552e29223bf8c2355f6e85eb7e264b27" title="modal columne vectors if parms-&amp;gt;evl.nmax&amp;gt;1">mod</a>,<span class="stringliteral">"%s/aper_mode.bin.gz"</span>,dirsetup);
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115     <a class="code" href="dmat_8h.html#0131ec62b0a77d0df03e71b35f2d7b85" title="OrthNormalize column vector in Mod, with weighting from vector amp.">dgramschmidt</a>(aper-&gt;<a class="code" href="structAPER__T.html#552e29223bf8c2355f6e85eb7e264b27" title="modal columne vectors if parms-&amp;gt;evl.nmax&amp;gt;1">mod</a>, aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>);
<a name="l00116"></a>00116     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00117"></a>00117         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(aper-&gt;<a class="code" href="structAPER__T.html#552e29223bf8c2355f6e85eb7e264b27" title="modal columne vectors if parms-&amp;gt;evl.nmax&amp;gt;1">mod</a>,<span class="stringliteral">"%s/aper_mode_gramschmidt.bin.gz"</span>,dirsetup);
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00121"></a>00121     <a class="code" href="bin_8c.html#07e8fcd0256fd8377d0bb0d86bfd3c53" title="Write a double array of size nx*ny to file.">writedbl</a>(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>, aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>, 1,<span class="stringliteral">"%s/aper_amp.bin.gz"</span>,dirsetup);
<a name="l00122"></a>00122     <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>,<span class="stringliteral">"%s/aper_mcc.bin.gz"</span>,dirsetup);
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124     aper-&gt;<a class="code" href="structAPER__T.html#ae22ab80e1f50cc63e1d5333c4301341" title="sum of amplitude squared">sumamp2</a>=0;
<a name="l00125"></a>00125     <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>){
<a name="l00126"></a>00126     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> iloc=0; iloc&lt;aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>; iloc++){
<a name="l00127"></a>00127         aper-&gt;<a class="code" href="structAPER__T.html#ae22ab80e1f50cc63e1d5333c4301341" title="sum of amplitude squared">sumamp2</a>+=pow(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>[iloc],2);
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#3888974e340d614e8187d99c9e77c814" title="output time averaged psf">psfmean</a> || parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9af2db68bde5dc62130f77d10d2eee8e" title="output history of the psf (a lot of storage)">psfhist</a>){
<a name="l00131"></a>00131     <span class="keyword">const</span> <span class="keywordtype">int</span> nwvl=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#efa7d339640d46e883615e2de461ea60" title="Number of wavelength.">nwvl</a>;
<a name="l00132"></a>00132     aper-&gt;<a class="code" href="structAPER__T.html#49b02a4bc657ffae14011a1e79a9778b" title="dimension of embed.">nembed</a>=calloc(nwvl, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00133"></a>00133     aper-&gt;<a class="code" href="structAPER__T.html#3aeb7c35cb75523ee1cde9334ae24d96" title="Embedding index for PSF computing, one per wvl.">embed</a>=calloc(nwvl, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>*));
<a name="l00134"></a>00134     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00135"></a>00135         aper-&gt;<a class="code" href="structAPER__T.html#49b02a4bc657ffae14011a1e79a9778b" title="dimension of embed.">nembed</a>[iwvl]=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#37a1a5330f6e8e56af0a724024e19a46" title="grid size for FFT to generate PSF.">psfgridsize</a>[iwvl];
<a name="l00136"></a>00136         aper-&gt;<a class="code" href="structAPER__T.html#3aeb7c35cb75523ee1cde9334ae24d96" title="Embedding index for PSF computing, one per wvl.">embed</a>[iwvl]=<a class="code" href="loc_8c.html#443de4aabeb9c885a0d2b9490d7d58dc" title="Create an vector to embed OPD into square array for FFT purpose.">loc_create_embed</a>(&amp;(aper-&gt;<a class="code" href="structAPER__T.html#49b02a4bc657ffae14011a1e79a9778b" title="dimension of embed.">nembed</a>[iwvl]), aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>);
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139     toc2(<span class="stringliteral">"setup_aper"</span>);
<a name="l00140"></a>00140     <span class="keywordflow">return</span> aper;
<a name="l00141"></a>00141 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="ea65e60525339d2921549850d52e8464"></a><!-- doxytag: member="setup_aper.c::free_aper" ref="ea65e60525339d2921549850d52e8464" args="(APER_T *aper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_aper           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Free the aper structure after simulation. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00144"></a>00144                             {
<a name="l00145"></a>00145     <span class="comment">//aper-&gt;ampground is freed on setup_recon</span>
<a name="l00146"></a>00146     locfree(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>);
<a name="l00147"></a>00147     <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>){
<a name="l00148"></a>00148     free(aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>-&gt;<a class="code" href="structLOCSTAT__T.html#269d02410e146840c0487e2ffc6ee01a" title="Information about each column.">cols</a>);
<a name="l00149"></a>00149     free(aper-&gt;<a class="code" href="structAPER__T.html#6a91f03da0654196381718c098f23bfe" title="record the starting location of each column in locs, used to accelerate accphi">locs_stat</a>);
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151     free(aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>);
<a name="l00152"></a>00152     <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#bda68ec718e6c59283e9893dd9abd7db" title="amplitude map defined o locs, maximum is 1.">amp1</a>)
<a name="l00153"></a>00153     free(aper-&gt;<a class="code" href="structAPER__T.html#bda68ec718e6c59283e9893dd9abd7db" title="amplitude map defined o locs, maximum is 1.">amp1</a>);
<a name="l00154"></a>00154     dfree(aper-&gt;<a class="code" href="structAPER__T.html#a28b4297d4a9d7a58d2474f003b522a7" title="inverse of mode cross coupling for evaluations.">imcc</a>);
<a name="l00155"></a>00155     dfree(aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>);
<a name="l00156"></a>00156     dfree(aper-&gt;<a class="code" href="structAPER__T.html#552e29223bf8c2355f6e85eb7e264b27" title="modal columne vectors if parms-&amp;gt;evl.nmax&amp;gt;1">mod</a>);
<a name="l00157"></a>00157     <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#3aeb7c35cb75523ee1cde9334ae24d96" title="Embedding index for PSF computing, one per wvl.">embed</a>){
<a name="l00158"></a>00158     free(aper-&gt;<a class="code" href="structAPER__T.html#3aeb7c35cb75523ee1cde9334ae24d96" title="Embedding index for PSF computing, one per wvl.">embed</a>);
<a name="l00159"></a>00159     free(aper-&gt;<a class="code" href="structAPER__T.html#49b02a4bc657ffae14011a1e79a9778b" title="dimension of embed.">nembed</a>);
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161     free(aper);
<a name="l00162"></a>00162 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 21:16:58 2010 for maos-0.7.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
