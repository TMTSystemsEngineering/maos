<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.6.4: maos/cachedm.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/cachedm.c File Reference</h1>Contains routines that prepare and carry out DM shape caching on fine sampled grid to speed up ray tracing.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="1237ea98073c2bd635b0cc5982b03445"></a><!-- doxytag: member="cachedm.c::INTERLACED" ref="1237ea98073c2bd635b0cc5982b03445" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>INTERLACED</b></td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cachedm_8c.html#2923773c14f6b8673f1b6d9f63d1ae17">prep_cachedm</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Prepares the DM caching structs.  <a href="#2923773c14f6b8673f1b6d9f63d1ae17"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cachedm_8c.html#8d69760c7293b232f5d70ce4af9fecd5">calc_cachedm_ic</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Executed by threads.  <a href="#8d69760c7293b232f5d70ce4af9fecd5"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cachedm_8c.html#5adf2590e4ff92a8cd044a52cf9bd753">calc_cachedm</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Partition the ray tracing by DM/Destination combinations, as well as segments in each combination to maximum efficiency.  <a href="#5adf2590e4ff92a8cd044a52cf9bd753"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Contains routines that prepare and carry out DM shape caching on fine sampled grid to speed up ray tracing. 
<p>
Because the DM has coarse sampling, and cubic influence functions, directly interpolate from the DM to the WFS and science OPD takes a lot of computation. We can speed up this process by first propagating the DM commands to a square grid that matches the sampling of the WFS or science OPD, and then propagate from the square grid to different WFS or science directions. For each sampling and each DM, we only need one fine sampled square grid that will cover all the different directions in the FoV of the WFSs or science. For the ground DM, we need a plane of 1/64m sampling that matches the WFS and science OPD. For the upper DM, we need to two planes, one at 1/64m for the LGS WFS and science OPD, and another one at 1/64 m (1-11.2/90) for the LGS due to cone effect. The square grid are on axis. <hr><h2>Function Documentation</h2>
<a class="anchor" name="2923773c14f6b8673f1b6d9f63d1ae17"></a><!-- doxytag: member="cachedm.c::prep_cachedm" ref="2923773c14f6b8673f1b6d9f63d1ae17" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void prep_cachedm           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Prepares the DM caching structs. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00041"></a>00041                               {
<a name="l00042"></a>00042     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00043"></a>00043     <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>){
<a name="l00044"></a>00044     simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>, <span class="keyword">sizeof</span>(<a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a>*));
<a name="l00045"></a>00045     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00046"></a>00046         simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm]=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#87daddffcd964b97cfae786a7c9efaff" title="number of scale group for DM propagation cache.">nscale</a>, <span class="keyword">sizeof</span>(<a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a>));
<a name="l00047"></a>00047         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iscale=0; iscale&lt;parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#87daddffcd964b97cfae786a7c9efaff" title="number of scale group for DM propagation cache.">nscale</a>; iscale++){
<a name="l00048"></a>00048         <span class="keywordtype">long</span> nxout, nyout;
<a name="l00049"></a>00049         <span class="keywordtype">double</span> oxout, oyout;
<a name="l00050"></a>00050         <span class="keywordtype">double</span> scale=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#f8903a5291d9132441eab9a862c70e68" title="the scale for each scale group.">scales</a>[iscale];
<a name="l00051"></a>00051         <span class="keywordtype">double</span> dx=parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#66e6d80a7720a91f8e4e13c1cfde9de6" title="sampling of aperture evaluation grid aper_locs">dx</a>*scale;
<a name="l00052"></a>00052         <a class="code" href="maos_2utils_8c.html#480912f463af16b1beec7b915c32acde" title="create a metapupil map, with size nx*ny, origin at (ox,oy), sampling of dx, height...">create_metapupil</a>
<a name="l00053"></a>00053             (parms, parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>, dx,
<a name="l00054"></a>00054              0, &amp;nxout, &amp;nyout, &amp;oxout, &amp;oyout, NULL,
<a name="l00055"></a>00055              2, 0, T_ALOC,0,0);
<a name="l00056"></a>00056         simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#6d09f5bfa663ca7cc80fa16cd4f3bc5c" title="Origin in x.">ox</a>=oxout;
<a name="l00057"></a>00057         simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#edda94fda911d8718b7b25a3972aa23b" title="Origin in y.">oy</a>=oyout;
<a name="l00058"></a>00058         simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>=nxout;
<a name="l00059"></a>00059         simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>=nyout;
<a name="l00060"></a>00060         simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#49015864cb8861d6ecf4b6a88596ee3c" title="Sampling along x and y.">dx</a>=dx;
<a name="l00061"></a>00061         simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>=calloc(nxout*nyout,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00062"></a>00062         }
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064     }
<a name="l00065"></a>00065     <span class="keywordtype">int</span> count=0;
<a name="l00066"></a>00066     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00067"></a>00067     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iscale=0; iscale&lt;parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#87daddffcd964b97cfae786a7c9efaff" title="number of scale group for DM propagation cache.">nscale</a>; iscale++){
<a name="l00068"></a>00068         count++;
<a name="l00069"></a>00069     }
<a name="l00070"></a>00070     }
<a name="l00071"></a>00071     simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>=count;
<a name="l00072"></a>00072     simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>=malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*2*simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>);
<a name="l00073"></a>00073     count=0;
<a name="l00074"></a>00074     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00075"></a>00075     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iscale=0; iscale&lt;parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#87daddffcd964b97cfae786a7c9efaff" title="number of scale group for DM propagation cache.">nscale</a>; iscale++){
<a name="l00076"></a>00076         simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[count][0]=idm;
<a name="l00077"></a>00077         simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[count][1]=iscale;
<a name="l00078"></a>00078         count++;
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#1e7a8af66d62b8d1c0e6b1c31e1c248f" title="cache dm shape on fine sampled grid matched WFS or Science grid">cachedm</a>==1){<span class="comment">//new scheme for ray tracing</span>
<a name="l00082"></a>00082     simu-&gt;<a class="code" href="structSIM__T.html#94acc92cf68283f0ca866d4b3086cb37">cachedm_prop</a>=calloc(simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>*simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>, <span class="keyword">sizeof</span>(thread_t));
<a name="l00083"></a>00083     simu-&gt;<a class="code" href="structSIM__T.html#6766b9d62d3bf6c25f02d5b38b55cf50">cachedm_propdata</a>=calloc(simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>, <span class="keyword">sizeof</span>(PROPDATA_T));
<a name="l00084"></a>00084     thread_t (*cprop)[simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>]=(<span class="keywordtype">void</span>*)simu-&gt;<a class="code" href="structSIM__T.html#94acc92cf68283f0ca866d4b3086cb37">cachedm_prop</a>;
<a name="l00085"></a>00085     PROPDATA_T *cpropdata=simu-&gt;<a class="code" href="structSIM__T.html#6766b9d62d3bf6c25f02d5b38b55cf50">cachedm_propdata</a>;
<a name="l00086"></a>00086     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ic=0; ic&lt;simu-&gt;cachedm_n; ic++){
<a name="l00087"></a>00087         <span class="keywordtype">int</span> idm=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][0];
<a name="l00088"></a>00088         <span class="keywordtype">int</span> iscale=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][1];
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         cpropdata[ic].locin=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm];
<a name="l00091"></a>00091         <span class="comment">//cpropdata[ic].phiin=simu-&gt;dmreal-&gt;p[idm]-&gt;p;need to do this at execution</span>
<a name="l00092"></a>00092         cpropdata[ic].mapout=&amp;simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale];
<a name="l00093"></a>00093         cpropdata[ic].alpha=1;
<a name="l00094"></a>00094         cpropdata[ic].displacex=0;
<a name="l00095"></a>00095         cpropdata[ic].displacey=0;
<a name="l00096"></a>00096         cpropdata[ic].scale=1;
<a name="l00097"></a>00097         cpropdata[ic].cubic=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#cf71d816fd769fe830d2e03f82c28b12" title="use cubic spline.">cubic</a>;
<a name="l00098"></a>00098         cpropdata[ic].cubic_iac=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#fca1c9ed9b0f9ce5a25147eb5906947b" title="Inter-Actuator Coupling coefficient.">iac</a>;
<a name="l00099"></a>00099 <span class="preprocessor">#define INTERLACED 0</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>        thread_prep(cprop[ic], 0, cpropdata[ic].mapout-&gt;ny, INTERLACED, 
<a name="l00101"></a>00101             simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>, (<span class="keywordtype">void</span>*)&amp;cpropdata[ic]);
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#1e7a8af66d62b8d1c0e6b1c31e1c248f" title="cache dm shape on fine sampled grid matched WFS or Science grid">cachedm</a>==2){<span class="comment">//use sparse matrix instead of ray tracing.</span>
<a name="l00104"></a>00104     warning(<span class="stringliteral">"This approach takes too much memory and is not fast. Don't use.\n"</span>);
<a name="l00105"></a>00105     simu-&gt;<a class="code" href="structSIM__T.html#0241d38e89ddccb476d83c26163f67d9">HACT</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>, 1);
<a name="l00106"></a>00106     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ic=0; ic&lt;simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>; ic++){
<a name="l00107"></a>00107         <span class="keywordtype">int</span> idm=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][0];
<a name="l00108"></a>00108         <span class="keywordtype">int</span> iscale=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][1];
<a name="l00109"></a>00109         <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *locout=<a class="code" href="loc_8c.html#f4422a314360edf5af650cd73591dbbe" title="Create a loc array that covers the MAP_T.">mksqloc_map</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale]);
<a name="l00110"></a>00110         <span class="comment">//scale is one because the plane lives on the DM altitude.</span>
<a name="l00111"></a>00111         simu-&gt;<a class="code" href="structSIM__T.html#0241d38e89ddccb476d83c26163f67d9">HACT</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ic]=<a class="code" href="mkh_8c.html#ab2a5c3f1e01e34f9f9befd6813451ad" title="Create transpose of mkh() result.">mkhb</a>(simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], locout, NULL, 0, 0, 1, 
<a name="l00112"></a>00112                    simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#cf71d816fd769fe830d2e03f82c28b12" title="use cubic spline.">cubic</a>, simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#fca1c9ed9b0f9ce5a25147eb5906947b" title="Inter-Actuator Coupling coefficient.">iac</a>);
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114     }<span class="keywordflow">else</span>{
<a name="l00115"></a>00115     error(<span class="stringliteral">"simu-&gt;parms-&gt;sim.cachedm=%d is invalid\n"</span>, simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#1e7a8af66d62b8d1c0e6b1c31e1c248f" title="cache dm shape on fine sampled grid matched WFS or Science grid">cachedm</a>);
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="8d69760c7293b232f5d70ce4af9fecd5"></a><!-- doxytag: member="cachedm.c::calc_cachedm_ic" ref="8d69760c7293b232f5d70ce4af9fecd5" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void calc_cachedm_ic           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Executed by threads. 
<p>
Each thread handle the next job when done. <div class="fragment"><pre class="fragment"><a name="l00122"></a>00122                                         {
<a name="l00123"></a>00123     <span class="keywordtype">int</span> ic;
<a name="l00124"></a>00124     <span class="keywordtype">int</span> icend=simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>*simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>;
<a name="l00125"></a>00125     <span class="keywordflow">while</span>(LOCK(simu-&gt;mutex_cachedm),ic=simu-&gt;<a class="code" href="structSIM__T.html#5ef0623895ff7f7823b92c8fb8f8d50b">cachedm_i</a>++,UNLOCK(simu-&gt;mutex_cachedm), ic&lt;icend){
<a name="l00126"></a>00126     <a class="code" href="accphi_8c.html#56055820d17e7869e938c41ff78e087a" title="A wrapper prop routine that handles all the different cases by calling the different...">prop</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#94acc92cf68283f0ca866d4b3086cb37">cachedm_prop</a>[ic]);
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5adf2590e4ff92a8cd044a52cf9bd753"></a><!-- doxytag: member="cachedm.c::calc_cachedm" ref="5adf2590e4ff92a8cd044a52cf9bd753" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_cachedm           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Partition the ray tracing by DM/Destination combinations, as well as segments in each combination to maximum efficiency. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00134"></a>00134                               {
<a name="l00135"></a>00135     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#1e7a8af66d62b8d1c0e6b1c31e1c248f" title="cache dm shape on fine sampled grid matched WFS or Science grid">cachedm</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>){
<a name="l00136"></a>00136     simu-&gt;<a class="code" href="structSIM__T.html#5ef0623895ff7f7823b92c8fb8f8d50b">cachedm_i</a>=0;
<a name="l00137"></a>00137     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#1e7a8af66d62b8d1c0e6b1c31e1c248f" title="cache dm shape on fine sampled grid matched WFS or Science grid">cachedm</a>==1){
<a name="l00138"></a>00138         PROPDATA_T *cpropdata=simu-&gt;<a class="code" href="structSIM__T.html#6766b9d62d3bf6c25f02d5b38b55cf50">cachedm_propdata</a>;
<a name="l00139"></a>00139         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ic=0; ic&lt;simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>; ic++){
<a name="l00140"></a>00140         <span class="keywordtype">int</span> idm=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][0];
<a name="l00141"></a>00141         <span class="keywordtype">int</span> iscale=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][1];
<a name="l00142"></a>00142         cpropdata[ic].phiin=simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00143"></a>00143         memset(simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>,0, 
<a name="l00144"></a>00144                <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) 
<a name="l00145"></a>00145                *simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a> 
<a name="l00146"></a>00146                *simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>);
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148         CALL(<a class="code" href="cachedm_8c.html#8d69760c7293b232f5d70ce4af9fecd5" title="Executed by threads.">calc_cachedm_ic</a>,simu,simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>);
<a name="l00149"></a>00149     }<span class="keywordflow">else</span>{
<a name="l00150"></a>00150         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ic=0; ic&lt;simu-&gt;<a class="code" href="structSIM__T.html#69fdb47e9ffb4cdd5bf09039df2fa200">cachedm_n</a>; ic++){
<a name="l00151"></a>00151         <span class="keywordtype">int</span> idm=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][0];
<a name="l00152"></a>00152         <span class="keywordtype">int</span> iscale=simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>[ic][1];
<a name="l00153"></a>00153         <a class="code" href="dsp_8h.html#914f0cb44155fa214c1e64283b732f9e" title="Threaded version of sptmulvec.">sptmulvec_thread</a>(simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>, simu-&gt;<a class="code" href="structSIM__T.html#0241d38e89ddccb476d83c26163f67d9">HACT</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ic],
<a name="l00154"></a>00154                  simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 1, simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>);
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 14:37:09 2010 for maos-0.6.4 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
