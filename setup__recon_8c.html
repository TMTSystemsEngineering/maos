<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.6.1: maos/setup_recon.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/setup_recon.c File Reference</h1>Contains routines that setup the wavefront reconstructor and DM fitting.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#928f34035de84ed317aa075e7a7ddac9">setup_recon_ploc</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setting up PLOC grid, which is a coarse sampled (similar to subaperture spacing) grid that defines the circular aperture for wavefront reconstruction and DM fitting.  <a href="#928f34035de84ed317aa075e7a7ddac9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#0182734530b87fcf5498aea2e8d1e5c0">setup_recon_aloc</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the deformable mirrors grid aloc.  <a href="#0182734530b87fcf5498aea2e8d1e5c0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#93517d5a67108f02872fea3ca166df0a">setup_recon_xloc</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the tomography grids xloc which is used for Tomography.  <a href="#93517d5a67108f02872fea3ca166df0a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#61353f3760139816643f225db8e6d3bc">setup_recon_G0GA</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup gradient operator G0, GA on xloc, aloc.  <a href="#61353f3760139816643f225db8e6d3bc"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#3f6cf2f9b4c4e8dbe3cba7df6a41fa9b">setup_recon_saneai</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the matrix of the inverse of gradient measurement noise equivalent angle covariance matrix.  <a href="#3f6cf2f9b4c4e8dbe3cba7df6a41fa9b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#b1ee56bdc9100fcdae8743d1b9971027">setup_recon_TTR</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">setting up global tip/tilt remove operator from LGS gradients.  <a href="#b1ee56bdc9100fcdae8743d1b9971027"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#9a1d613f69803903ab0cb9f29ca5a4a3">setup_recon_DFR</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">operator to remove diffrential focus modes that might be caused by sodium layer horizontal structure.  <a href="#9a1d613f69803903ab0cb9f29ca5a4a3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#caa963e8fb3e5e0201f312327e4d94e8">setup_recon_TTFR</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">wrapps <a class="el" href="setup__recon_8c.html#b1ee56bdc9100fcdae8743d1b9971027" title="setting up global tip/tilt remove operator from LGS gradients.">setup_recon_TTR()</a> and <a class="el" href="setup__recon_8c.html#9a1d613f69803903ab0cb9f29ca5a4a3" title="operator to remove diffrential focus modes that might be caused by sodium layer horizontal...">setup_recon_DFR()</a> to removal global tip/tilt and differential focus.  <a href="#caa963e8fb3e5e0201f312327e4d94e8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#2ade74dd6feba7dba0a4b6f38fe134a8">setup_recon_tomo_prep</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Prepares for tomography.  <a href="#2ade74dd6feba7dba0a4b6f38fe134a8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#764bf903a38cfc81220e42699e911884">setup_recon_tomo_matrix</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">assemble tomography matrix.  <a href="#764bf903a38cfc81220e42699e911884"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#4aff68732e2560d8d421521ae47485a4">setup_recon_tomo_matrix_update</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update assembled tomography matrix with new L2.  <a href="#4aff68732e2560d8d421521ae47485a4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#fa92eb0639f142dd512c13688b21d813">setup_recon_HXHA</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup ray tracing operator HX,HA from xloc, aloc to aperture ploc.  <a href="#fa92eb0639f142dd512c13688b21d813"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#630c6d5a66160c402a727df359300f20">fit_prep_lrt</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup fitting low rank terms that are in the NULL space of DM fitting operator.  <a href="#630c6d5a66160c402a727df359300f20"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#b4a4784b2c4fff59fcdcdb3163fb1aea">free_recon_moao</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free <a class="el" href="structMOAO__T.html" title="contains MOAO related data">MOAO_T</a>.  <a href="#b4a4784b2c4fff59fcdcdb3163fb1aea"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#3a5b99570039882f39e51b69236b1a0e">setup_recon_moao</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structAPER__T.html">APER_T</a> *aper)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Prepare the propagation H matrix for MOAO and compute the reconstructor.  <a href="#3a5b99570039882f39e51b69236b1a0e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#f7a8a7478b06b8b4f0d27784819f41c2">setup_recon_fit_matrix</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Assemble the DM fitting matrix.  <a href="#f7a8a7478b06b8b4f0d27784819f41c2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#4f4abf13c9b0972de67fab348bb9f470">setup_recon_focus</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create the reconstructor to reconstruct the residual focus error due to LGS sodium tracking error.  <a href="#4f4abf13c9b0972de67fab348bb9f470"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#2bd8394adbdb99d342f9ac9d3a0faa6f">setup_recon_mvst</a> (<a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">compute the MVST split tomography NGS mode reconstructor.  <a href="#2bd8394adbdb99d342f9ac9d3a0faa6f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__recon_8c.html#6ec32666222d37047d7775b874969a2e">setup_recon</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, <a class="el" href="structAPER__T.html">APER_T</a> *aper)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sets up the reconstruction structs including wavefront reconstructor and DM fitting operator.  <a href="#6ec32666222d37047d7775b874969a2e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="810c17bd7027feae0decafb93f48efcf"></a><!-- doxytag: member="setup_recon.c::free_recon" ref="810c17bd7027feae0decafb93f48efcf" args="(const PARMS_T *parms, RECON_T *recon)" -->
void&nbsp;</td><td class="memItemRight" valign="bottom"><b>free_recon</b> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Contains routines that setup the wavefront reconstructor and DM fitting. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="928f34035de84ed317aa075e7a7ddac9"></a><!-- doxytag: member="setup_recon.c::setup_recon_ploc" ref="928f34035de84ed317aa075e7a7ddac9" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_ploc           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setting up PLOC grid, which is a coarse sampled (similar to subaperture spacing) grid that defines the circular aperture for wavefront reconstruction and DM fitting. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00036"></a>00036                                                       {
<a name="l00037"></a>00037     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>){<span class="comment">//free the old one in case of repeated call</span>
<a name="l00038"></a>00038     locfree(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>); recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>=NULL;
<a name="l00039"></a>00039     }
<a name="l00040"></a>00040     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#28b02d2097e9869b59af91324f5b9031" title="load ploc for recon from">ploc</a>){<span class="comment">//optionally load ploc from the file. see dbg.conf</span>
<a name="l00041"></a>00041     <span class="keywordtype">char</span> *fn=parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#28b02d2097e9869b59af91324f5b9031" title="load ploc for recon from">ploc</a>;
<a name="l00042"></a>00042     warning(<span class="stringliteral">"Loading ploc from %s\n"</span>,fn);
<a name="l00043"></a>00043     recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>=locread(<span class="stringliteral">"%s"</span>,fn);
<a name="l00044"></a>00044     <a class="code" href="loc_8c.html#0f574f9a5cca3684657e7030a1c6bf07" title="Compute the size of a map that is used to build loc or can fully contain loc (embed)...">loc_nxny</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#92a57151a11ec84ff53979e019459c8e">ploc_nx</a>, &amp;recon-&gt;<a class="code" href="structRECON__T.html#50f6e0ffd9f6b53c184585b73fb6da6c">ploc_ny</a>, recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>);
<a name="l00045"></a>00045     }<span class="keywordflow">else</span>{ 
<a name="l00046"></a>00046     <span class="comment">/*</span>
<a name="l00047"></a>00047 <span class="comment">      Create a circular PLOC with telescope diameter by calling</span>
<a name="l00048"></a>00048 <span class="comment">      create_metapupil with height of 0. We don't add any guard points.*/</span>
<a name="l00049"></a>00049     <span class="keywordtype">double</span> dxr=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#000509803902f7629b9ba04a57cb75e5" title="baseline sampling (when os=1).">dx</a>/parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#c64e4b93348f8c0544aa76f9c3908c57" title="over sampling factor of ploc over actuator spacing">pos</a>;<span class="comment">//sampling of ploc</span>
<a name="l00050"></a>00050     <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> *pmap=<a class="code" href="maos_2utils_8c.html#aba5a9d494e2fc4ef56edd11248b41e9" title="Calls create_metapupil is simplified interface by returning a MAP_T object.">create_metapupil_wrap</a> 
<a name="l00051"></a>00051         (parms,0,dxr,0,0,0,T_PLOC,0,parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#20b8cd5e2ec73f4eb4bff84f70f06bf4" title="using square grid on DM and ploc.">square</a>);
<a name="l00052"></a>00052     info2(<span class="stringliteral">"PLOC is %ldx%ld, with sampling of %.2fm\n"</span>,pmap-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>,pmap-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>,dxr);
<a name="l00053"></a>00053     recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>=<a class="code" href="loc_8c.html#65eae1500aa879b31c5a7962ad9191c5" title="convert a sqmap to a loc object.">sqmap2loc</a>(pmap);<span class="comment">//convert MAP_T to LOC_T</span>
<a name="l00054"></a>00054     recon-&gt;<a class="code" href="structRECON__T.html#92a57151a11ec84ff53979e019459c8e">ploc_nx</a>=pmap-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>;
<a name="l00055"></a>00055     recon-&gt;<a class="code" href="structRECON__T.html#50f6e0ffd9f6b53c184585b73fb6da6c">ploc_ny</a>=pmap-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>;
<a name="l00056"></a>00056     sqmapfree(pmap);<span class="comment">//free it.</span>
<a name="l00057"></a>00057     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00058"></a>00058         locwrite(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, <span class="stringliteral">"%s/ploc"</span>,dirsetup);
<a name="l00059"></a>00059     }
<a name="l00060"></a>00060     }
<a name="l00061"></a>00061     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00062"></a>00062     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l00063"></a>00063     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){<span class="comment">//this is a low order wfs</span>
<a name="l00064"></a>00064         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#7d2eaa30681d91e3267fe953462270c4" title="wfs type if not using physical optics in simulation.">gtype_recon</a>==0 
<a name="l00065"></a>00065            || parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#129c1dda529b641aac48415a110235b7" title="wfs type if not using physical optics in reconstruction.">gtype_sim</a>==0){
<a name="l00066"></a>00066         <span class="comment">//we are using gtilt for low order wfs</span>
<a name="l00067"></a>00067         recon-&gt;<a class="code" href="structRECON__T.html#509262c77bacced2232309272a6af2ab">lowfs_gtilt</a>=1;
<a name="l00068"></a>00068         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#129c1dda529b641aac48415a110235b7" title="wfs type if not using physical optics in reconstruction.">gtype_sim</a>==0)
<a name="l00069"></a>00069             warning(<span class="stringliteral">"Low order POWFS %d is using gtilt in sim. "</span>
<a name="l00070"></a>00070                 <span class="stringliteral">"This is not recommended\n"</span>,ipowfs);
<a name="l00071"></a>00071         }
<a name="l00072"></a>00072     }
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074     <span class="comment">//create the weighting W for bilinear influence function. See [Ellerbroek 2002]</span>
<a name="l00075"></a>00075     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#059a70c92c1cc12fcf7b63d7cbb01a68" title="if 1, load W0, W1">W</a>){
<a name="l00076"></a>00076     <span class="keywordflow">if</span>(!(exist(<span class="stringliteral">"W0.bin.gz"</span>)&amp;&amp;exist(<span class="stringliteral">"W1.bin.gz"</span>))){
<a name="l00077"></a>00077         error(<span class="stringliteral">"W0 or W1 not exist\n"</span>);
<a name="l00078"></a>00078     }
<a name="l00079"></a>00079     warning(<span class="stringliteral">"Loading W0, W1"</span>);
<a name="l00080"></a>00080     recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>=<a class="code" href="dmat_8h.html#06bbd169953a4a808c647bd0a9e6f0d3" title="User callable function to read sparse metrix from file.">spread</a>(<span class="stringliteral">"W0.bin.gz"</span>);
<a name="l00081"></a>00081     recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>=<a class="code" href="dmat_8h.html#6406403e91ec976bb0d6c2e12b5d5a0f" title="User callable function to read dense matrix into memory from file.">dread</a>(<span class="stringliteral">"W1.bin.gz"</span>);
<a name="l00082"></a>00082     }<span class="keywordflow">else</span>{
<a name="l00083"></a>00083     <span class="comment">/*</span>
<a name="l00084"></a>00084 <span class="comment">      Compute W0,W1 weighting matrix that can be used to compute piston</span>
<a name="l00085"></a>00085 <span class="comment">      removed wavefront variance of OPD: RMS=OPD'*(W0-W1*W1')*OPD; W0 is</span>
<a name="l00086"></a>00086 <span class="comment">      sparse. W1 is a vector. These matrices are used for weighting in DM</span>
<a name="l00087"></a>00087 <span class="comment">      fitting.</span>
<a name="l00088"></a>00088 <span class="comment">    */</span>
<a name="l00089"></a>00089     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#4bb7c6a03390440a21fe4eb4d43737af" title="Define the W0/W1 on annular aperture instead of circular.">annular_W</a>){
<a name="l00090"></a>00090         warning(<span class="stringliteral">"Define the W0/W1 on annular aperture instead of circular.\n"</span>);
<a name="l00091"></a>00091         <a class="code" href="mkw_8c.html#906ebb2ba8e44067e06845789d769132" title="compute the W0, W1 for bilinear influence function for a annular aperture of radius...">mkw_annular</a>(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, 0, 0, 
<a name="l00092"></a>00092             parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#5f2d4b89322d5de7b49f7f274807ff93" title="Telescope inner blocking diameter.">din</a>/2, parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/2,
<a name="l00093"></a>00093             &amp;(recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>), &amp;(recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>));
<a name="l00094"></a>00094         
<a name="l00095"></a>00095     }<span class="keywordflow">else</span>{
<a name="l00096"></a>00096         <a class="code" href="mkw_8c.html#14a6f51d037ddb45b21b651d78617eb4" title="compute the W0, W1 for bilinear influence function for a circular aperture of radius...">mkw_circular</a>(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>,0,0,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/2.,
<a name="l00097"></a>00097               &amp;(recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>), &amp;(recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>));
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00100"></a>00100         <a class="code" href="dmat_8h.html#779cefb17e24b648212cc59f9324f5ae" title="User callable function to write sparse matrix into file.">spwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>, <span class="stringliteral">"%s/W0"</span>,dirsetup);
<a name="l00101"></a>00101         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>, <span class="stringliteral">"%s/W1"</span>,dirsetup);
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103     }
<a name="l00104"></a>00104     
<a name="l00105"></a>00105     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#2208400c2f1150a63417cd38f3e01f53" title="Plot various information in setup process.">setup</a>){<span class="comment">//plot the ploc grid.</span>
<a name="l00106"></a>00106     <a class="code" href="maos_2utils_8c.html#ed87a0850d278bb80fe6906e7a8fa6f6" title="Plot the projection of all the different FoVs on a certain grid.">plotloc</a>(<span class="stringliteral">"FoV"</span>,parms,recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>,0, <span class="stringliteral">"ploc"</span>);
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0182734530b87fcf5498aea2e8d1e5c0"></a><!-- doxytag: member="setup_recon.c::setup_recon_aloc" ref="0182734530b87fcf5498aea2e8d1e5c0" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_aloc           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup the deformable mirrors grid aloc. 
<p>
This is used for DM fitting. <div class="fragment"><pre class="fragment"><a name="l00113"></a>00113                                                       {
<a name="l00114"></a>00114     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00115"></a>00115     <span class="keywordflow">if</span>(ndm==0) <span class="keywordflow">return</span>;
<a name="l00116"></a>00116     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>){
<a name="l00117"></a>00117     locarrfree(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>, ndm); recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>=NULL;
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#504d8d75ed87eeeff67a302dce0185b1" title="load DM aloc from">aloc</a>){
<a name="l00120"></a>00120     <span class="keywordtype">char</span> *fn=parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#504d8d75ed87eeeff67a302dce0185b1" title="load DM aloc from">aloc</a>;
<a name="l00121"></a>00121     warning(<span class="stringliteral">"Loading aloc from %s\n"</span>,fn);
<a name="l00122"></a>00122     <span class="keywordtype">int</span> naloc;
<a name="l00123"></a>00123     recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>=locarrread(&amp;naloc,<span class="stringliteral">"%s"</span>,fn);
<a name="l00124"></a>00124     <span class="keywordflow">if</span>(naloc!=ndm) error(<span class="stringliteral">"Invalid saved aloc"</span>);
<a name="l00125"></a>00125     recon-&gt;<a class="code" href="structRECON__T.html#47d071d1a6cdd265dcfd541027f57033">aloc_nx</a>=calloc(ndm, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00126"></a>00126     recon-&gt;<a class="code" href="structRECON__T.html#20d1e70b5e71633f144252da4f74a601">aloc_ny</a>=calloc(ndm, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00127"></a>00127     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00128"></a>00128         <a class="code" href="loc_8c.html#0f574f9a5cca3684657e7030a1c6bf07" title="Compute the size of a map that is used to build loc or can fully contain loc (embed)...">loc_nxny</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#47d071d1a6cdd265dcfd541027f57033">aloc_nx</a>[idm], &amp;recon-&gt;<a class="code" href="structRECON__T.html#20d1e70b5e71633f144252da4f74a601">aloc_ny</a>[idm], recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]);
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130     }<span class="keywordflow">else</span>{
<a name="l00131"></a>00131     recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>=calloc(ndm, <span class="keyword">sizeof</span>(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*));
<a name="l00132"></a>00132     recon-&gt;<a class="code" href="structRECON__T.html#47d071d1a6cdd265dcfd541027f57033">aloc_nx</a>=calloc(ndm, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00133"></a>00133     recon-&gt;<a class="code" href="structRECON__T.html#20d1e70b5e71633f144252da4f74a601">aloc_ny</a>=calloc(ndm, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00134"></a>00134     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00135"></a>00135         <span class="keywordtype">double</span> ht=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00136"></a>00136         <span class="keywordtype">double</span> dx=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#094b4f74b4260b1fac411e66d352146a" title="actuator separation">dx</a>;
<a name="l00137"></a>00137         <span class="keywordtype">double</span> offset=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#aaf7ff0a674b9a13c9c4bd8158a500e4" title="Center-most actuator offset from origin=0 means there is a act on center.">offset</a>+(parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#d51c7bdc88ea34b8b9b7577186f689de" title="Order of the DM within telescope clear subaperture.">order</a>%2)*0.5;
<a name="l00138"></a>00138         <span class="keyword">const</span> <span class="keywordtype">double</span> guard=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#d213b987d61f132cb2a790ecd674e607" title="extra DM actuator rings outside of aper.d">guard</a>*parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#094b4f74b4260b1fac411e66d352146a" title="actuator separation">dx</a>;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140         <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> *map=<a class="code" href="maos_2utils_8c.html#aba5a9d494e2fc4ef56edd11248b41e9" title="Calls create_metapupil is simplified interface by returning a MAP_T object.">create_metapupil_wrap</a>
<a name="l00141"></a>00141         (parms,ht,dx,offset,guard,0,T_ALOC,0,parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#20b8cd5e2ec73f4eb4bff84f70f06bf4" title="using square grid on DM and ploc.">square</a>);
<a name="l00142"></a>00142     
<a name="l00143"></a>00143         recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]=<a class="code" href="loc_8c.html#65eae1500aa879b31c5a7962ad9191c5" title="convert a sqmap to a loc object.">sqmap2loc</a>(map);
<a name="l00144"></a>00144         recon-&gt;<a class="code" href="structRECON__T.html#47d071d1a6cdd265dcfd541027f57033">aloc_nx</a>[idm]=map-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>;
<a name="l00145"></a>00145         recon-&gt;<a class="code" href="structRECON__T.html#20d1e70b5e71633f144252da4f74a601">aloc_ny</a>[idm]=map-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>;
<a name="l00146"></a>00146         free(map-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>);
<a name="l00147"></a>00147         free(map);
<a name="l00148"></a>00148         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#2208400c2f1150a63417cd38f3e01f53" title="Plot various information in setup process.">setup</a>){
<a name="l00149"></a>00149         <a class="code" href="maos_2utils_8c.html#ed87a0850d278bb80fe6906e7a8fa6f6" title="Plot the projection of all the different FoVs on a certain grid.">plotloc</a>(<span class="stringliteral">"FoV"</span>, parms, recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], ht, <span class="stringliteral">"aloc%d"</span>, idm);
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151     }<span class="comment">//idm</span>
<a name="l00152"></a>00152         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00153"></a>00153         locarrwrite(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>,parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>,<span class="stringliteral">"%s/aloc"</span>,dirsetup);
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156     recon-&gt;<a class="code" href="structRECON__T.html#3a9d4f9ba578d8d87d3b1b1226679e03">aimcc</a>=dcellnew(ndm,1);
<a name="l00157"></a>00157     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00158"></a>00158     recon-&gt;<a class="code" href="structRECON__T.html#3a9d4f9ba578d8d87d3b1b1226679e03">aimcc</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="loc_8c.html#922085291bebb517283cf380efe5cacf" title="assemble modes of piston/tip/tilt into Nx3 matrix M, and compute their inverse covariance...">loc_mcc_ptt</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], NULL);
<a name="l00159"></a>00159     <a class="code" href="dmat_8h.html#b48bc9b9c8f923e19dafc70b8fff5de2" title="inplace invert a small square SPD matrix using lapack dposv_, usually (A&amp;#39;*w*A)...">dinvspd_inplace</a>(recon-&gt;<a class="code" href="structRECON__T.html#3a9d4f9ba578d8d87d3b1b1226679e03">aimcc</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]);
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="93517d5a67108f02872fea3ca166df0a"></a><!-- doxytag: member="setup_recon.c::setup_recon_xloc" ref="93517d5a67108f02872fea3ca166df0a" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_xloc           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup the tomography grids xloc which is used for Tomography. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00166"></a>00166                                                       {
<a name="l00167"></a>00167     <span class="keyword">const</span> <span class="keywordtype">int</span> npsr=recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>;
<a name="l00168"></a>00168     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>){
<a name="l00169"></a>00169     locarrfree(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>, npsr); recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>=NULL;
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#34a2e5022dbe13370cc62c89200e3338" title="load xloc for recon from">xloc</a>){
<a name="l00172"></a>00172     <span class="keywordtype">char</span> *fn=parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#34a2e5022dbe13370cc62c89200e3338" title="load xloc for recon from">xloc</a>;
<a name="l00173"></a>00173     warning(<span class="stringliteral">"Loading xloc from %s\n"</span>,fn);
<a name="l00174"></a>00174     <span class="keywordtype">int</span> nxloc;
<a name="l00175"></a>00175     recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>=locarrread(&amp;nxloc,<span class="stringliteral">"%s"</span>,fn);
<a name="l00176"></a>00176     <span class="keywordflow">if</span>(nxloc!=npsr) 
<a name="l00177"></a>00177         error(<span class="stringliteral">"Invalid saved file. npsr=%d, nxloc=%d\n"</span>,npsr,nxloc);
<a name="l00178"></a>00178     recon-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>=calloc(npsr, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00179"></a>00179     recon-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>=calloc(npsr, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00180"></a>00180     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00181"></a>00181         <a class="code" href="loc_8c.html#0f574f9a5cca3684657e7030a1c6bf07" title="Compute the size of a map that is used to build loc or can fully contain loc (embed)...">loc_nxny</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>[ips], &amp;recon-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>[ips], recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]);
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183     }<span class="keywordflow">else</span>{
<a name="l00184"></a>00184     recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>=calloc(npsr, <span class="keyword">sizeof</span>(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *));
<a name="l00185"></a>00185     recon-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>=calloc(npsr, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00186"></a>00186     recon-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>=calloc(npsr, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00187"></a>00187     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#19f667fc7731b5bde53fd4761496f94a">calc_invpsd</a> &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#2a286e84160801fd89366d02f005a39e" title="use square/rectangular grid instead of tighter irregular grid">square</a>){
<a name="l00188"></a>00188         recon-&gt;<a class="code" href="structRECON__T.html#83165d76ec62ccf5b588c3cd9e38f761">xloc_embed</a>=calloc(npsr, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>*));
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00192"></a>00192         <span class="keyword">const</span> <span class="keywordtype">double</span> ht=recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips];
<a name="l00193"></a>00193         <span class="keyword">const</span> <span class="keywordtype">double</span> dxr=recon-&gt;<a class="code" href="structRECON__T.html#7e092b0677f74882da4fa83b5bd0b16c" title="sampling in meter of the layers">dx</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips];
<a name="l00194"></a>00194         <span class="keyword">const</span> <span class="keywordtype">double</span> guard=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#868c9e4b83b40ac1df7e6d580ef759f3" title="guard rings of reconstruction grid xloc">guard</a>*dxr;
<a name="l00195"></a>00195         <span class="keywordtype">long</span> nin=0;
<a name="l00196"></a>00196         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#2a286e84160801fd89366d02f005a39e" title="use square/rectangular grid instead of tighter irregular grid">square</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#55e4197464d1963dbff66662ec83f4b1" title="Tomography preconditioner.">precond</a>==1){
<a name="l00197"></a>00197         nin=(long)pow(2,ceil(log2(parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/recon-&gt;<a class="code" href="structRECON__T.html#7e092b0677f74882da4fa83b5bd0b16c" title="sampling in meter of the layers">dx</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]*2)))
<a name="l00198"></a>00198             *recon-&gt;<a class="code" href="structRECON__T.html#f80639ee1e2cefb3eb831d7777f38990" title="over sampling of the layers.">os</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]/recon-&gt;<a class="code" href="structRECON__T.html#f80639ee1e2cefb3eb831d7777f38990" title="over sampling of the layers.">os</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];
<a name="l00199"></a>00199         warning(<span class="stringliteral">"layer %d xloc is set to %ld for FDPCG\n"</span>,ips,nin);
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201         <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> *map=<a class="code" href="maos_2utils_8c.html#aba5a9d494e2fc4ef56edd11248b41e9" title="Calls create_metapupil is simplified interface by returning a MAP_T object.">create_metapupil_wrap</a>
<a name="l00202"></a>00202         (parms,ht,dxr,0,guard,nin,T_XLOC,0,parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#2a286e84160801fd89366d02f005a39e" title="use square/rectangular grid instead of tighter irregular grid">square</a>);
<a name="l00203"></a>00203         info(<span class="stringliteral">"layer %d: xloc map is %ldx%ld, "</span>
<a name="l00204"></a>00204          <span class="stringliteral">"with sampling of %.2f m\n"</span>,ips,
<a name="l00205"></a>00205          map-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>,map-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>,dxr);
<a name="l00206"></a>00206         recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]=<a class="code" href="loc_8c.html#65eae1500aa879b31c5a7962ad9191c5" title="convert a sqmap to a loc object.">sqmap2loc</a>(map);
<a name="l00207"></a>00207         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#19f667fc7731b5bde53fd4761496f94a">calc_invpsd</a> &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#2a286e84160801fd89366d02f005a39e" title="use square/rectangular grid instead of tighter irregular grid">square</a>){
<a name="l00208"></a>00208         recon-&gt;<a class="code" href="structRECON__T.html#83165d76ec62ccf5b588c3cd9e38f761">xloc_embed</a>[ips]=<a class="code" href="loc_8c.html#d651cb0fb5931a8510270b136a807bd2" title="Create an index array can put embed opd defined in loc from map2loc into a square...">sqmap2embed</a>(map);
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210         recon-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>[ips]=map-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>;
<a name="l00211"></a>00211         recon-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>[ips]=map-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>;
<a name="l00212"></a>00212         free(map-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>);free(map);
<a name="l00213"></a>00213      
<a name="l00214"></a>00214         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#2208400c2f1150a63417cd38f3e01f53" title="Plot various information in setup process.">setup</a>){
<a name="l00215"></a>00215         <a class="code" href="maos_2utils_8c.html#ed87a0850d278bb80fe6906e7a8fa6f6" title="Plot the projection of all the different FoVs on a certain grid.">plotloc</a>(<span class="stringliteral">"FoV"</span>,parms,recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips],ht, <span class="stringliteral">"xloc%d"</span>,ips);
<a name="l00216"></a>00216         }
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00219"></a>00219         locarrwrite(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>, recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>, <span class="stringliteral">"%s/xloc"</span>,dirsetup);
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     recon-&gt;<a class="code" href="structRECON__T.html#c87b109c8dea0d3ff40a09bb7218470d">xdim</a>=calloc(npsr,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00224"></a>00224     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipsr=0; ipsr&lt;npsr; ipsr++){
<a name="l00225"></a>00225     recon-&gt;<a class="code" href="structRECON__T.html#c87b109c8dea0d3ff40a09bb7218470d">xdim</a>[ipsr]=recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ipsr]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     recon-&gt;<a class="code" href="structRECON__T.html#d27512278909836e2b8fc1672b6c98b8">xmcc</a>=dcellnew(npsr,1);
<a name="l00228"></a>00228     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipsr=0; ipsr&lt;npsr; ipsr++){
<a name="l00229"></a>00229     recon-&gt;<a class="code" href="structRECON__T.html#d27512278909836e2b8fc1672b6c98b8">xmcc</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipsr]=<a class="code" href="loc_8c.html#922085291bebb517283cf380efe5cacf" title="assemble modes of piston/tip/tilt into Nx3 matrix M, and compute their inverse covariance...">loc_mcc_ptt</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ipsr],NULL);
<a name="l00230"></a>00230     <a class="code" href="dmat_8h.html#b48bc9b9c8f923e19dafc70b8fff5de2" title="inplace invert a small square SPD matrix using lapack dposv_, usually (A&amp;#39;*w*A)...">dinvspd_inplace</a>(recon-&gt;<a class="code" href="structRECON__T.html#d27512278909836e2b8fc1672b6c98b8">xmcc</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipsr]);
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="61353f3760139816643f225db8e6d3bc"></a><!-- doxytag: member="setup_recon.c::setup_recon_G0GA" ref="61353f3760139816643f225db8e6d3bc" args="(RECON_T *recon, const PARMS_T *parms, POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_G0GA           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup gradient operator G0, GA on xloc, aloc. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00237"></a>00237                                                                       {
<a name="l00238"></a>00238     <span class="keyword">const</span> <span class="keywordtype">int</span> nwfs=parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>;
<a name="l00239"></a>00239     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00240"></a>00240     <span class="keywordtype">int</span> npsr=recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>;
<a name="l00241"></a>00241     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*GA)[nwfs]=NULL;
<a name="l00242"></a>00242     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*G0)[nwfs]=NULL;
<a name="l00243"></a>00243     <span class="comment">//GA is used for pseudo open loop gradients computation.</span>
<a name="l00244"></a>00244     <span class="keywordtype">int</span> comp_G0=0;
<a name="l00245"></a>00245     <span class="keywordtype">int</span> comp_GA=0;
<a name="l00246"></a>00246     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>){
<a name="l00247"></a>00247     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>);
<a name="l00248"></a>00248     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#cd5664235d8ec047a69f515ee01bc4c6">G0hi</a>);
<a name="l00249"></a>00249     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#ca1bb5339687bb81a2ac0513f5e19d27">G0lo</a>);
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>){
<a name="l00252"></a>00252     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>); 
<a name="l00253"></a>00253     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#c27d4e8f776a38b7200e0bd09ba58447">GAlo</a>);
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#1ab194d4e5e60b6345074df9a8d6e630" title="load GA from.">GA</a> &amp;&amp; exist(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#1ab194d4e5e60b6345074df9a8d6e630" title="load GA from.">GA</a>)){
<a name="l00256"></a>00256     warning2(<span class="stringliteral">"Loading saved GA\n"</span>);
<a name="l00257"></a>00257     recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"GA.bin.gz"</span>);
<a name="l00258"></a>00258     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>!=nwfs || recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>!=ndm)
<a name="l00259"></a>00259         error(<span class="stringliteral">"Wrong saved file\n"</span>);
<a name="l00260"></a>00260     GA = (<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*)[nwfs]) recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l00261"></a>00261     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00262"></a>00262         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00263"></a>00263         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00264"></a>00264         <span class="keywordtype">int</span> ipowfs = parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00265"></a>00265         <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00266"></a>00266         <span class="keywordflow">if</span>(GA[idm][iwfs]-&gt;m!=nsa*2
<a name="l00267"></a>00267            || GA[idm][iwfs]-&gt;n!=nloc){
<a name="l00268"></a>00268             error(<span class="stringliteral">"Wrong saved file\n"</span>);
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272     }<span class="keywordflow">else</span>{
<a name="l00273"></a>00273     comp_GA=1;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#d60a7ecba460e1dbf76bf1a7503e1db1" title="load G0 from.">G0</a> &amp;&amp; exist(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#d60a7ecba460e1dbf76bf1a7503e1db1" title="load G0 from.">G0</a>)){
<a name="l00276"></a>00276     warning2(<span class="stringliteral">"Loading saved G0\n"</span>);
<a name="l00277"></a>00277     recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#d60a7ecba460e1dbf76bf1a7503e1db1" title="load G0 from.">G0</a>);
<a name="l00278"></a>00278     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>!=nwfs || recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>!=npsr)
<a name="l00279"></a>00279         error(<span class="stringliteral">"Wrong saved file\n"</span>);
<a name="l00280"></a>00280     
<a name="l00281"></a>00281     G0 = (<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*)[nwfs]) recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l00282"></a>00282     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00283"></a>00283         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00284"></a>00284         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00285"></a>00285         <span class="keywordtype">int</span> ipowfs = parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00286"></a>00286         <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00287"></a>00287         <span class="keywordflow">if</span>(!G0[ips][iwfs] ||G0[ips][iwfs]-&gt;m!=nsa*2
<a name="l00288"></a>00288            || G0[ips][iwfs]-&gt;n!=nloc){
<a name="l00289"></a>00289             error(<span class="stringliteral">"Wrong saved file\n"</span>);
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293     }<span class="keywordflow">else</span>{
<a name="l00294"></a>00294     comp_G0=1;
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296     <span class="keywordflow">if</span>(!comp_GA &amp;&amp; !comp_G0) <span class="keywordflow">return</span>;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="keywordflow">if</span>(comp_GA){
<a name="l00299"></a>00299     recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>= <a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(nwfs, ndm);
<a name="l00300"></a>00300     GA=(<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*)[nwfs]) recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302     <span class="keywordflow">if</span>(comp_G0){
<a name="l00303"></a>00303     recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(nwfs, npsr);
<a name="l00304"></a>00304     G0 = (<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*)[nwfs]) recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *GG=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>, 1);
<a name="l00307"></a>00307     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> **Gloc=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>, <span class="keyword">sizeof</span>(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*));
<a name="l00308"></a>00308     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *GS0sum=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>,1);
<a name="l00309"></a>00309     info(<span class="stringliteral">"Generating GG with "</span>);
<a name="l00310"></a>00310     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00311"></a>00311     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l00312"></a>00312     <span class="comment">//use ploc as an intermediate plane.</span>
<a name="l00313"></a>00313     Gloc[ipowfs]=recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>;
<a name="l00314"></a>00314     <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#7d2eaa30681d91e3267fe953462270c4" title="wfs type if not using physical optics in simulation.">gtype_recon</a>){
<a name="l00315"></a>00315     <span class="keywordflow">case</span> 0:{<span class="comment">//Gtilt</span>
<a name="l00316"></a>00316         <span class="comment">/*Create averaging gradient operator from PLOC, using fine sampled</span>
<a name="l00317"></a>00317 <span class="comment">          powfs.loc as intermediate plane*/</span>
<a name="l00318"></a>00318         <span class="keywordtype">double</span> displace[2]={0,0};
<a name="l00319"></a>00319         info2(<span class="stringliteral">" Gploc"</span>);
<a name="l00320"></a>00320         GG-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs]=<a class="code" href="mkg_8c.html#7a94831f1db656a61e22c6f1c5a85ebb" title="Returns the transpose of mkgt().">mkg</a>(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>,
<a name="l00321"></a>00321                   powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>,1,1,displace,1);
<a name="l00322"></a>00322         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00323"></a>00323         <a class="code" href="dmat_8h.html#779cefb17e24b648212cc59f9324f5ae" title="User callable function to write sparse matrix into file.">spwrite</a>(GG-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs], <span class="stringliteral">"%s/powfs%d_GG"</span>, dirsetup, ipowfs);
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326         <span class="keywordflow">break</span>;
<a name="l00327"></a>00327     <span class="keywordflow">case</span> 1:{<span class="comment">//Ztilt</span>
<a name="l00328"></a>00328         <span class="comment">/*Create ztilt operator from PLOC, using fine sampled powfs.loc as</span>
<a name="l00329"></a>00329 <span class="comment">          intermediate plane*/</span>
<a name="l00330"></a>00330         info2(<span class="stringliteral">" Zploc"</span>);
<a name="l00331"></a>00331         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *H=<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>, 0,0,1,0);
<a name="l00332"></a>00332         GG-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs]=<a class="code" href="dsp_8h.html#ccfcfe9fff4e25824ae3ad516f01b864" title="Multiply two sparse arrays: return A*B.">spmulsp</a>(powfs[ipowfs].ZS0,H);
<a name="l00333"></a>00333         spfree(H);
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335         <span class="keywordflow">break</span>;
<a name="l00336"></a>00336     <span class="keywordflow">default</span>:
<a name="l00337"></a>00337         error(<span class="stringliteral">"Invalid gtype_recon\n"</span>);
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339     <span class="keywordflow">break</span>;
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341     info2(<span class="stringliteral">" done\n"</span>);
<a name="l00342"></a>00342     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00343"></a>00343     <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(GG,<span class="stringliteral">"%s/GG"</span>,dirsetup);
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345     recon-&gt;<a class="code" href="structRECON__T.html#a3b783474293896824b711dff799620b" title="Gradient operator from H0.">GG</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(nwfs,1);
<a name="l00346"></a>00346     recon-&gt;<a class="code" href="structRECON__T.html#64e4da9140b619eca947f62d690f8474" title="Ray tracing operator for all WFS from each layer.">H0</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(nwfs,npsr);
<a name="l00347"></a>00347     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#64e4da9140b619eca947f62d690f8474" title="Ray tracing operator for all WFS from each layer.">H0</a>,H0);
<a name="l00348"></a>00348     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00349"></a>00349     <span class="keywordtype">int</span> ipowfs = parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00350"></a>00350     recon-&gt;<a class="code" href="structRECON__T.html#a3b783474293896824b711dff799620b" title="Gradient operator from H0.">GG</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(GG-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs]);
<a name="l00351"></a>00351     <span class="keywordtype">double</span>  hs = parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>;
<a name="l00352"></a>00352     <span class="keywordtype">double</span> *filterpoints=NULL;
<a name="l00353"></a>00353     <span class="keywordflow">if</span>(GS0sum-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipowfs]){
<a name="l00354"></a>00354         filterpoints=GS0sum-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipowfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     <span class="keywordflow">if</span>(comp_G0){
<a name="l00357"></a>00357         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00358"></a>00358         <span class="keywordtype">double</span>  ht = recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips];
<a name="l00359"></a>00359         <span class="keywordtype">double</span>  scale=1. - ht/hs;
<a name="l00360"></a>00360         <span class="keywordtype">double</span>  displace[2];
<a name="l00361"></a>00361         displace[0]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*ht;
<a name="l00362"></a>00362         displace[1]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*ht;
<a name="l00363"></a>00363         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *H=<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips], Gloc[ipowfs],filterpoints, displace[0],displace[1],scale,0);
<a name="l00364"></a>00364         G0[ips][iwfs]=<a class="code" href="dsp_8h.html#ccfcfe9fff4e25824ae3ad516f01b864" title="Multiply two sparse arrays: return A*B.">spmulsp</a>(GG-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs], H);
<a name="l00365"></a>00365         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00366"></a>00366             <a class="code" href="dmat_8h.html#779cefb17e24b648212cc59f9324f5ae" title="User callable function to write sparse matrix into file.">spwrite</a>(H,<span class="stringliteral">"%s/HXLOC_ips%d_wfs%d"</span>, dirsetup, ips, ipowfs);
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368         H0[ips][iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(H);
<a name="l00369"></a>00369         spfree(H);
<a name="l00370"></a>00370         }<span class="comment">//ips</span>
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372     <span class="keywordflow">if</span>(comp_GA){
<a name="l00373"></a>00373         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00374"></a>00374         <span class="keywordtype">double</span>  ht = parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00375"></a>00375         <span class="keywordtype">double</span>  scale=1. - ht/hs;
<a name="l00376"></a>00376         <span class="keywordtype">double</span>  displace[2];
<a name="l00377"></a>00377         displace[0]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*ht;
<a name="l00378"></a>00378         displace[1]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*ht;
<a name="l00379"></a>00379         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *H;
<a name="l00380"></a>00380         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#cf71d816fd769fe830d2e03f82c28b12" title="use cubic spline.">cubic</a>){
<a name="l00381"></a>00381             <span class="comment">//info("mkh_cubic for GA\n");</span>
<a name="l00382"></a>00382             H=<a class="code" href="mkh_8c.html#1a5857040746e6edea04ad2e9a80c140" title="Create ray tracing operator from coordinate locin to locout using cubic influence...">mkh_cubic</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm],Gloc[ipowfs],filterpoints, displace[0],displace[1],scale,
<a name="l00383"></a>00383                 parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#fca1c9ed9b0f9ce5a25147eb5906947b" title="Inter-Actuator Coupling coefficient.">iac</a>,1);
<a name="l00384"></a>00384         }<span class="keywordflow">else</span>{
<a name="l00385"></a>00385             H=<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], Gloc[ipowfs], filterpoints, displace[0],displace[1],scale,0);
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387         GA[idm][iwfs]=<a class="code" href="dsp_8h.html#ccfcfe9fff4e25824ae3ad516f01b864" title="Multiply two sparse arrays: return A*B.">spmulsp</a>(GG-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs],H);
<a name="l00388"></a>00388         spfree(H);
<a name="l00389"></a>00389         }<span class="comment">//idm</span>
<a name="l00390"></a>00390     }<span class="comment">//comp_GA.</span>
<a name="l00391"></a>00391     }<span class="comment">//iwfs</span>
<a name="l00392"></a>00392     <span class="comment">//G0tomo is used in tomography. skip NGS if split. replaced with H0tomo.</span>
<a name="l00393"></a>00393     recon-&gt;<a class="code" href="structRECON__T.html#6208af43c0f23db39923cb073823ef2e">G0tomo</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>, recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>);
<a name="l00394"></a>00394     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#6208af43c0f23db39923cb073823ef2e">G0tomo</a>,G0tomo);
<a name="l00395"></a>00395     recon-&gt;<a class="code" href="structRECON__T.html#12988e3824ca095af01bdaaedab72926" title="Like G0tomo.">H0tomo</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#64e4da9140b619eca947f62d690f8474" title="Ray tracing operator for all WFS from each layer.">H0</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>, recon-&gt;<a class="code" href="structRECON__T.html#64e4da9140b619eca947f62d690f8474" title="Ray tracing operator for all WFS from each layer.">H0</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>);
<a name="l00396"></a>00396     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#12988e3824ca095af01bdaaedab72926" title="Like G0tomo.">H0tomo</a>,H0tomo);
<a name="l00397"></a>00397     recon-&gt;<a class="code" href="structRECON__T.html#cd5664235d8ec047a69f515ee01bc4c6">G0hi</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>, recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>);
<a name="l00398"></a>00398     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#cd5664235d8ec047a69f515ee01bc4c6">G0hi</a>, G0hi);
<a name="l00399"></a>00399     recon-&gt;<a class="code" href="structRECON__T.html#ca1bb5339687bb81a2ac0513f5e19d27">G0lo</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>, recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>);
<a name="l00400"></a>00400     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#ca1bb5339687bb81a2ac0513f5e19d27">G0lo</a>, G0lo);
<a name="l00401"></a>00401     recon-&gt;<a class="code" href="structRECON__T.html#d488016296d1767cd96dd9614ce8ba55">G0focus</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>, recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>);
<a name="l00402"></a>00402     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#d488016296d1767cd96dd9614ce8ba55">G0focus</a>,G0focus);
<a name="l00403"></a>00403     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00404"></a>00404     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00405"></a>00405     <span class="keywordflow">if</span>(!(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a> &amp;&amp; recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs])){
<a name="l00406"></a>00406         <span class="comment">//for tomography</span>
<a name="l00407"></a>00407         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00408"></a>00408         G0tomo[ips][iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(G0[ips][iwfs]);
<a name="l00409"></a>00409         H0tomo[ips][iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(H0[ips][iwfs]);
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l00413"></a>00413         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00414"></a>00414         G0hi[ips][iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(G0[ips][iwfs]);
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416     }<span class="keywordflow">else</span>{
<a name="l00417"></a>00417         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00418"></a>00418         G0lo[ips][iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(G0[ips][iwfs]);
<a name="l00419"></a>00419         }
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421     <span class="comment">//for focus tracking.</span>
<a name="l00422"></a>00422     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#8c69a219924faa60ddf33137b2d35633" title="do DM fitting only, by replacing opdr with opdx.">fitonly</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#bf0ce35fd4cdfa16eefa42aea7c3300e" title="method for focus tracing.">mffocus</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a>){
<a name="l00423"></a>00423         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00424"></a>00424         G0focus[ips][iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(G0[ips][iwfs]);
<a name="l00425"></a>00425         }
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#64e4da9140b619eca947f62d690f8474" title="Ray tracing operator for all WFS from each layer.">H0</a>);
<a name="l00429"></a>00429     recon-&gt;<a class="code" href="structRECON__T.html#c27d4e8f776a38b7200e0bd09ba58447">GAlo</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>, recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>);
<a name="l00430"></a>00430     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#c27d4e8f776a38b7200e0bd09ba58447">GAlo</a>,GAlo);
<a name="l00431"></a>00431     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00432"></a>00432     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00433"></a>00433     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l00434"></a>00434         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00435"></a>00435         GAlo[idm][iwfs]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(GA[idm][iwfs]);
<a name="l00436"></a>00436         }
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#441772201383938aaa3c18dacbf222df" title="reduce uncoupled points in xloc.">xloc_tight</a> &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#2a286e84160801fd89366d02f005a39e" title="use square/rectangular grid instead of tighter irregular grid">square</a>){
<a name="l00440"></a>00440     warning(<span class="stringliteral">"Tightening xloc ... (generally not helpful)"</span>);
<a name="l00441"></a>00441     <span class="comment">//Don't do this. not good in preliminary testing.</span>
<a name="l00442"></a>00442     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00443"></a>00443         <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *sptmp=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00444"></a>00444         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00445"></a>00445         sptmp-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs]=G0[ips][iwfs];
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447         <a class="code" href="loc_8c.html#f4362de21aacbe4d0061c5d5dc59ef07" title="Remove uncoupled points in loc.">loc_reduce_spcell</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips],sptmp,2,1);
<a name="l00448"></a>00448         free(sptmp-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>); free(sptmp);
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450     info2(<span class="stringliteral">"done\n"</span>);
<a name="l00451"></a>00451     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00452"></a>00452         locarrwrite(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>, recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>, <span class="stringliteral">"%s/xloc"</span>,dirsetup);
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455     recon-&gt;<a class="code" href="structRECON__T.html#56d81fec03dea5a5305f6e3e4d8742a6">gdim</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00456"></a>00456     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00457"></a>00457     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00458"></a>00458     recon-&gt;<a class="code" href="structRECON__T.html#56d81fec03dea5a5305f6e3e4d8742a6">gdim</a>[iwfs]=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>*2;
<a name="l00459"></a>00459     }
<a name="l00460"></a>00460     spcellfree(GG);
<a name="l00461"></a>00461     <span class="comment">/*for(int ipowfs=0; ipowfs&lt;parms-&gt;npowfs; ipowfs++){</span>
<a name="l00462"></a>00462 <span class="comment">    if(parms-&gt;powfs[ipowfs].nwfs==0) continue;</span>
<a name="l00463"></a>00463 <span class="comment">    spfree(GG-&gt;p[ipowfs]);</span>
<a name="l00464"></a>00464 <span class="comment">    }</span>
<a name="l00465"></a>00465 <span class="comment">    free(GG-&gt;p); free(GG);*/</span>
<a name="l00466"></a>00466     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00467"></a>00467     <span class="keywordflow">if</span>(comp_GA)
<a name="l00468"></a>00468         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>, <span class="stringliteral">"%s/GA"</span>,dirsetup);
<a name="l00469"></a>00469     <span class="keywordflow">if</span>(comp_G0)
<a name="l00470"></a>00470         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>, <span class="stringliteral">"%s/G0"</span>,dirsetup);
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472     dcellfree(GS0sum);
<a name="l00473"></a>00473     free(Gloc);
<a name="l00474"></a>00474     free(freeGG);
<a name="l00475"></a>00475 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3f6cf2f9b4c4e8dbe3cba7df6a41fa9b"></a><!-- doxytag: member="setup_recon.c::setup_recon_saneai" ref="3f6cf2f9b4c4e8dbe3cba7df6a41fa9b" args="(RECON_T *recon, const PARMS_T *parms, const POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_saneai           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup the matrix of the inverse of gradient measurement noise equivalent angle covariance matrix. 
<p>
For physical optics wfs, the NEA is computed using matched filter output. For geometric optics, the NEA is from input. <div class="fragment"><pre class="fragment"><a name="l00483"></a>00483                                 {
<a name="l00484"></a>00484     <span class="keyword">const</span> <span class="keywordtype">int</span> nwfs=parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>;
<a name="l00485"></a>00485     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>){
<a name="l00486"></a>00486     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>);
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *saneai=recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(nwfs,nwfs);
<a name="l00489"></a>00489     info(<span class="stringliteral">"saneai:"</span>);
<a name="l00490"></a>00490     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00491"></a>00491     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00492"></a>00492     <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00493"></a>00493     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#432d38bdb2aca67608242b2e149666be" title="prefix of file contains noise equivalent angle in radian.">neareconfile</a>){<span class="comment">//taks precedance</span>
<a name="l00494"></a>00494         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *nea=<a class="code" href="dmat_8h.html#6406403e91ec976bb0d6c2e12b5d5a0f" title="User callable function to read dense matrix into memory from file.">dread</a>(<span class="stringliteral">"%s_wfs%d"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#432d38bdb2aca67608242b2e149666be" title="prefix of file contains noise equivalent angle in radian.">neareconfile</a>,iwfs);<span class="comment">//rad</span>
<a name="l00495"></a>00495         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a>||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d40a0a0fa416f92a27d2128a8653a578" title="use nea from physical optical precomputation in geometric simulations.">neaphy</a>){
<a name="l00496"></a>00496         <span class="comment">//sanity check on provided nea.</span>
<a name="l00497"></a>00497         <span class="keyword">const</span> <span class="keywordtype">int</span> nmtch=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#0165680cc8d86944018418a1e361df81">mtche</a>-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>;
<a name="l00498"></a>00498         <span class="keywordtype">int</span> indsanea=0;
<a name="l00499"></a>00499         <span class="keywordflow">if</span>(nmtch==1){
<a name="l00500"></a>00500             indsanea=0;
<a name="l00501"></a>00501         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(nmtch==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>){
<a name="l00502"></a>00502             indsanea=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ac1b34e2f1f4455c53212bc350f5064b" title="indwfs[iwfs] gives the index of the wfs in this powfs group">indwfs</a>[iwfs];
<a name="l00503"></a>00503         }<span class="keywordflow">else</span>{
<a name="l00504"></a>00504             error(<span class="stringliteral">"invalid\n"</span>);
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506         PDCELL(powfs[ipowfs].intstat-&gt;saneaixy, saneaixy);
<a name="l00507"></a>00507         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00508"></a>00508             <span class="keywordtype">double</span> nea1x=pow(saneaixy[indsanea][isa]-&gt;p[0],-0.5);
<a name="l00509"></a>00509             <span class="keywordtype">double</span> nea1y=pow(saneaixy[indsanea][isa]-&gt;p[3],-0.5);
<a name="l00510"></a>00510             <span class="keywordtype">double</span> nea2x=nea-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa];
<a name="l00511"></a>00511             <span class="keywordtype">double</span> nea2y=nea-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa+nsa];
<a name="l00512"></a>00512             <span class="keywordflow">if</span>(nea1x&lt;0.5*nea2x || nea1x&gt;2*nea2x || nea1y&lt;0.5*nea2y || nea1y&gt;2*nea2y){
<a name="l00513"></a>00513             warning(<span class="stringliteral">"\niwfs %d, isa %d : Phy nea: %g %g mas. Provided nea: %g %g mas.\n"</span>,
<a name="l00514"></a>00514                   iwfs,isa,nea1x*206265000, nea1y*206265000, 
<a name="l00515"></a>00515                   nea2x*206265000, nea2y*206265000);
<a name="l00516"></a>00516             }
<a name="l00517"></a>00517         }
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         info2(<span class="stringliteral">" FILE(%.2f)"</span>,<a class="code" href="dmat_8h.html#176e534c9042ace51d05a620a2294248" title="create sum of all the elements in A.">dsum</a>(nea)/(2*nsa)*206265000);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <a class="code" href="dmat_8h.html#b6f63a9e507f7a58e4f1ba98d7bb3288" title="Raise all elements to power power.">dcwpow</a>(nea,-2);<span class="comment">//rad^-2</span>
<a name="l00522"></a>00522         saneai-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+iwfs*nwfs]=<a class="code" href="dsp_8h.html#6a222ac146078e5f05857a7f93a697bf" title="Create a new sparse matrix with diagonal elements set to vec*alpha.">spnewdiag</a>(nsa*2,nea-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,1.);
<a name="l00523"></a>00523         dfree(nea);
<a name="l00524"></a>00524     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>((parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a>||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d40a0a0fa416f92a27d2128a8653a578" title="use nea from physical optical precomputation in geometric simulations.">neaphy</a>) &amp;&amp; 
<a name="l00525"></a>00525          !parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d5bf829d5ed5599aaa727ecd8df41922" title="force using supplied noise equivalent angle in physical optics simulations">phyusenea</a>){
<a name="l00526"></a>00526         <span class="comment">//Physical optics</span>
<a name="l00527"></a>00527         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#45900019b0a0d7d362460592c2c34775" title="physical optics type.">phytype</a>==1){
<a name="l00528"></a>00528         saneai-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+iwfs*nwfs] =<a class="code" href="dsp_8h.html#ad23f2152cd2622871367fd28ac0ff6b" title="Create a nx*ny X(sp) matrix with memory for nmax max elements allocated.">spnew</a>(nsa*2,nsa*2,nsa*4);
<a name="l00529"></a>00529         <span class="keywordtype">long</span> *pp=saneai-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+iwfs*nwfs]-&gt;<a class="code" href="structdsp.html#a9f3db1d7c4d321157e4efac11f3351a" title="column pointers (size n+1) or col indlces (size nzmax) when nz!=-1">p</a>;
<a name="l00530"></a>00530         <span class="keywordtype">long</span> *pi=saneai-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+iwfs*nwfs]-&gt;<a class="code" href="structdsp.html#1d87a5584935632deb8bf23ea8eb46bf" title="row indices, size nzmax">i</a>;
<a name="l00531"></a>00531         <span class="keywordtype">double</span> *px=saneai-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+iwfs*nwfs]-&gt;<a class="code" href="structdsp.html#72f5e4eabdf69453be2ec0708558f023" title="numerical values, size nzmax">x</a>;
<a name="l00532"></a>00532         <span class="keywordtype">long</span> count=0;
<a name="l00533"></a>00533         <span class="keyword">const</span> <span class="keywordtype">int</span> nmtch=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#0165680cc8d86944018418a1e361df81">mtche</a>-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>;
<a name="l00534"></a>00534         <span class="keywordtype">int</span> indsanea=0;
<a name="l00535"></a>00535         <span class="keywordflow">if</span>(nmtch==1){
<a name="l00536"></a>00536             indsanea=0;
<a name="l00537"></a>00537         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(nmtch==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>){
<a name="l00538"></a>00538             indsanea=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ac1b34e2f1f4455c53212bc350f5064b" title="indwfs[iwfs] gives the index of the wfs in this powfs group">indwfs</a>[iwfs];
<a name="l00539"></a>00539         }<span class="keywordflow">else</span>{
<a name="l00540"></a>00540             error(<span class="stringliteral">"invalid\n"</span>);
<a name="l00541"></a>00541         }
<a name="l00542"></a>00542         PDCELL(powfs[ipowfs].intstat-&gt;saneaixy, saneaixy);
<a name="l00543"></a>00543         <span class="comment">//dmat *(*saneaixy)[nsa]</span>
<a name="l00544"></a>00544         <span class="comment">//  =(void*)powfs[ipowfs].intstat-&gt;saneaixy-&gt;p;</span>
<a name="l00545"></a>00545         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00546"></a>00546             pp[isa]=count;
<a name="l00547"></a>00547             pi[count]=isa;<span class="comment">//xx</span>
<a name="l00548"></a>00548             px[count]=saneaixy[indsanea][isa]-&gt;p[0];
<a name="l00549"></a>00549             count++;
<a name="l00550"></a>00550             pi[count]=isa+nsa;<span class="comment">//yx</span>
<a name="l00551"></a>00551             px[count]=saneaixy[indsanea][isa]-&gt;p[1];
<a name="l00552"></a>00552             count++;
<a name="l00553"></a>00553         }
<a name="l00554"></a>00554         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00555"></a>00555             pp[isa+nsa]=count;
<a name="l00556"></a>00556             pi[count]=isa;<span class="comment">//xy</span>
<a name="l00557"></a>00557             px[count]=saneaixy[indsanea][isa]-&gt;p[2];
<a name="l00558"></a>00558             count++;
<a name="l00559"></a>00559             pi[count]=isa+nsa;<span class="comment">//yy</span>
<a name="l00560"></a>00560             px[count]=saneaixy[indsanea][isa]-&gt;p[3];
<a name="l00561"></a>00561             count++;
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563         pp[nsa*2]=count;
<a name="l00564"></a>00564         <span class="keywordtype">double</span> neasum=0;
<a name="l00565"></a>00565         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00566"></a>00566             neasum+=pow(saneaixy[indsanea][isa]-&gt;p[0],-0.5)+
<a name="l00567"></a>00567             pow(saneaixy[indsanea][isa]-&gt;p[3],-0.5);
<a name="l00568"></a>00568         }
<a name="l00569"></a>00569         info2(<span class="stringliteral">" mtch(%.2f)"</span>,neasum/(2*nsa)*206265000);
<a name="l00570"></a>00570         }<span class="keywordflow">else</span>{
<a name="l00571"></a>00571         error(<span class="stringliteral">"Not implemented yet\n"</span>);
<a name="l00572"></a>00572         }
<a name="l00573"></a>00573     }<span class="keywordflow">else</span>{
<a name="l00574"></a>00574         info2(<span class="stringliteral">" geom(%.2f)"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ccdc5486d22fdd52e06600a7aeed71b5" title="NEA used in reconstruction.">nearecon</a>);
<a name="l00575"></a>00575         <span class="keyword">const</span> <span class="keywordtype">double</span> nea=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ccdc5486d22fdd52e06600a7aeed71b5" title="NEA used in reconstruction.">nearecon</a>/206265000.;
<a name="l00576"></a>00576         <span class="keywordflow">if</span>(nea&lt;1.e-15) error(<span class="stringliteral">"nea is too small\n"</span>);
<a name="l00577"></a>00577         <span class="comment">//nea scales as sqrt(1/dtrat) so neaisq scales as dtrat.</span>
<a name="l00578"></a>00578         <span class="keyword">const</span> <span class="keywordtype">double</span> neaisq=pow(nea,-2)*parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00579"></a>00579         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *neai=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa,2);
<a name="l00580"></a>00580         <span class="comment">//scale neaisq by area. (seeing limited)</span>
<a name="l00581"></a>00581         <span class="comment">//scale neaisq by area^2 if diffraction limited</span>
<a name="l00582"></a>00582         <span class="comment">//only implementing seeing limited here.</span>
<a name="l00583"></a>00583         double (*neaip)[nsa]=(double(*)[nsa])neai-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00584"></a>00584         <span class="keywordtype">double</span> *area=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>;
<a name="l00585"></a>00585         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nsa; i++){
<a name="l00586"></a>00586         neaip[0][i]=neaip[1][i]=neaisq*(area[i]);
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588         saneai-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+iwfs*nwfs]=<a class="code" href="dsp_8h.html#6a222ac146078e5f05857a7f93a697bf" title="Create a new sparse matrix with diagonal elements set to vec*alpha.">spnewdiag</a>(nsa*2,neai-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,1.);
<a name="l00589"></a>00589         dfree(neai);
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592     info2(<span class="stringliteral">"\n"</span>);
<a name="l00593"></a>00593     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00594"></a>00594     <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>,<span class="stringliteral">"%s/saneai"</span>,dirsetup);
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b1ee56bdc9100fcdae8743d1b9971027"></a><!-- doxytag: member="setup_recon.c::setup_recon_TTR" ref="b1ee56bdc9100fcdae8743d1b9971027" args="(RECON_T *recon, const PARMS_T *parms, const POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_TTR           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
setting up global tip/tilt remove operator from LGS gradients. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00603"></a>00603                                     {
<a name="l00604"></a>00604     <span class="keywordflow">if</span>(!recon-&gt;<a class="code" href="structRECON__T.html#033a52251e3c28ded25b16d4bbefbe72">has_ttr</a>) <span class="keywordflow">return</span>;
<a name="l00605"></a>00605     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>){
<a name="l00606"></a>00606     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>);
<a name="l00607"></a>00607     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#b2a067a798303d820f88872c07ffddf6">PTT</a>);
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609     <span class="keywordtype">int</span> nwfs=parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>;
<a name="l00610"></a>00610     recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>=dcellnew(nwfs,nwfs);
<a name="l00611"></a>00611     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00612"></a>00612     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l00613"></a>00613     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#979789ab45a1f87cf251469dbedebe00" title="tip/tilt removal flag.">trs</a>){
<a name="l00614"></a>00614         warning(<span class="stringliteral">"powfs %d has tip/tilt removed in tomography\n"</span>, ipowfs);
<a name="l00615"></a>00615         <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00616"></a>00616         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *TT=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,2);
<a name="l00617"></a>00617         <span class="keywordtype">double</span> *TTx=TT-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00618"></a>00618         <span class="keywordtype">double</span> *TTy=TT-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nsa*2;
<a name="l00619"></a>00619         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00620"></a>00620         TTx[isa]=1;
<a name="l00621"></a>00621         TTy[isa]=0;
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=nsa; isa&lt;nsa*2; isa++){
<a name="l00624"></a>00624         TTx[isa]=0;
<a name="l00625"></a>00625         TTy[isa]=1;
<a name="l00626"></a>00626         }
<a name="l00627"></a>00627         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jwfs=0; jwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>; jwfs++){
<a name="l00628"></a>00628         <span class="keywordtype">int</span> iwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#be03195a4e1fece4903a6297931ac09c" title="array of wfs belongs to this powfs">wfs</a>[jwfs];
<a name="l00629"></a>00629         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>&amp;&amp;recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs]){
<a name="l00630"></a>00630             error(<span class="stringliteral">"This WFS %d should be included in Tomo.\n"</span>, iwfs);
<a name="l00631"></a>00631         }
<a name="l00632"></a>00632         <a class="code" href="dmat_8h.html#b5adc5cd1e79d9a79751ba482728f230" title="copy the values from one X(mat) to another.">dcp</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs+iwfs*nwfs], TT);
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634         dfree(TT);
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636     }
<a name="l00637"></a>00637     recon-&gt;<a class="code" href="structRECON__T.html#b2a067a798303d820f88872c07ffddf6">PTT</a>=dcellpinv(recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>,NULL,recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>);
<a name="l00638"></a>00638     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00639"></a>00639     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>, <span class="stringliteral">"%s/TT"</span>,dirsetup);
<a name="l00640"></a>00640     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#b2a067a798303d820f88872c07ffddf6">PTT</a>, <span class="stringliteral">"%s/PTT"</span>,dirsetup);
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="9a1d613f69803903ab0cb9f29ca5a4a3"></a><!-- doxytag: member="setup_recon.c::setup_recon_DFR" ref="9a1d613f69803903ab0cb9f29ca5a4a3" args="(RECON_T *recon, const PARMS_T *parms, const POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_DFR           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
operator to remove diffrential focus modes that might be caused by sodium layer horizontal structure. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00650"></a>00650                              {
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="keywordflow">if</span>(!recon-&gt;<a class="code" href="structRECON__T.html#fde892c07e5b7f3bd4be16df87d3ab10">has_dfr</a>) <span class="keywordflow">return</span>;
<a name="l00653"></a>00653     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>){ 
<a name="l00654"></a>00654     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>);
<a name="l00655"></a>00655     }
<a name="l00656"></a>00656     <span class="keywordtype">int</span> nwfs=parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>;
<a name="l00657"></a>00657     recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>=dcellnew(nwfs,nwfs);
<a name="l00658"></a>00658     <span class="comment">//Then differential focus modes.</span>
<a name="l00659"></a>00659     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00660"></a>00660     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l00661"></a>00661     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#4f79eb8e4c1f3ad39eebeeb845bdc7d5" title="differential focus removal flag.">dfrs</a>){
<a name="l00662"></a>00662         warning(<span class="stringliteral">"powfs %d has differential focus removed in tomography\n"</span>, ipowfs);
<a name="l00663"></a>00663         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>&lt;2){
<a name="l00664"></a>00664         error(<span class="stringliteral">"This powfs group has only 1 wfs. Could not remove diff focus\n"</span>);
<a name="l00665"></a>00665         }
<a name="l00666"></a>00666         <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00667"></a>00667         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a>* DF=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,1);
<a name="l00668"></a>00668      
<a name="l00669"></a>00669         memcpy(DF-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*nsa);
<a name="l00670"></a>00670         memcpy(DF-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nsa, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*nsa);<span class="comment"></span>
<a name="l00671"></a>00671 <span class="comment">        /**</span>
<a name="l00672"></a>00672 <span class="comment">           postive focus on first wfs. negative focus on diagnonal wfs.</span>
<a name="l00673"></a>00673 <span class="comment">         */</span>
<a name="l00674"></a>00674         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jwfs=1; jwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>; jwfs++){
<a name="l00675"></a>00675         <span class="keywordtype">int</span> iwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#be03195a4e1fece4903a6297931ac09c" title="array of wfs belongs to this powfs">wfs</a>[jwfs];
<a name="l00676"></a>00676         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>&amp;&amp;recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs]){
<a name="l00677"></a>00677             error(<span class="stringliteral">"This WFS %d should be included in Tomo.\n"</span>, iwfs);
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679         <a class="code" href="dmat_8h.html#b5adc5cd1e79d9a79751ba482728f230" title="copy the values from one X(mat) to another.">dcp</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs*nwfs], DF);
<a name="l00680"></a>00680         <a class="code" href="dmat_8h.html#4c4f53dc9572106deb6933eb103bf40b" title="compute B=bc*B+ac*A behavior changed on 2009-11-02.">dadd</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs+iwfs*nwfs], 0, DF, -1);
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682         dfree(DF);
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00686"></a>00686     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>, <span class="stringliteral">"%s/DF"</span>,dirsetup);
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="caa963e8fb3e5e0201f312327e4d94e8"></a><!-- doxytag: member="setup_recon.c::setup_recon_TTFR" ref="caa963e8fb3e5e0201f312327e4d94e8" args="(RECON_T *recon, const PARMS_T *parms, const POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_TTFR           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
wrapps <a class="el" href="setup__recon_8c.html#b1ee56bdc9100fcdae8743d1b9971027" title="setting up global tip/tilt remove operator from LGS gradients.">setup_recon_TTR()</a> and <a class="el" href="setup__recon_8c.html#9a1d613f69803903ab0cb9f29ca5a4a3" title="operator to remove diffrential focus modes that might be caused by sodium layer horizontal...">setup_recon_DFR()</a> to removal global tip/tilt and differential focus. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00695"></a>00695                               {
<a name="l00696"></a>00696   
<a name="l00697"></a>00697     <a class="code" href="setup__recon_8c.html#b1ee56bdc9100fcdae8743d1b9971027" title="setting up global tip/tilt remove operator from LGS gradients.">setup_recon_TTR</a>(recon,parms,powfs);
<a name="l00698"></a>00698     <a class="code" href="setup__recon_8c.html#9a1d613f69803903ab0cb9f29ca5a4a3" title="operator to remove diffrential focus modes that might be caused by sodium layer horizontal...">setup_recon_DFR</a>(recon,parms,powfs);
<a name="l00699"></a>00699     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>){
<a name="l00700"></a>00700     recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>=dcellcat(recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>,recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>,2);
<a name="l00701"></a>00701     }<span class="keywordflow">else</span>{
<a name="l00702"></a>00702     recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>=dcellref(recon-&gt;<a class="code" href="structRECON__T.html#0dc1c5f640a8d583f4b3b6b0737c777b">TT</a>);
<a name="l00703"></a>00703     }
<a name="l00704"></a>00704     recon-&gt;<a class="code" href="structRECON__T.html#35b159335cbe2615df14d3bed3085298">PTTF</a>=dcellpinv(recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>, NULL,recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>);
<a name="l00705"></a>00705     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#fd0320f8b10a68d37732981f2168ad81">DF</a>);
<a name="l00706"></a>00706     <span class="comment">//Keep TT, PTT, used in uplink pointing.</span>
<a name="l00707"></a>00707 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="2ade74dd6feba7dba0a4b6f38fe134a8"></a><!-- doxytag: member="setup_recon.c::setup_recon_tomo_prep" ref="2ade74dd6feba7dba0a4b6f38fe134a8" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_recon_tomo_prep           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Prepares for tomography. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00712"></a>00712                                                            {
<a name="l00713"></a>00713     <span class="comment">//make sure this is after setup G0 GA</span>
<a name="l00714"></a>00714     <span class="comment">//Free existing struct is already exist. </span>
<a name="l00715"></a>00715     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>);
<a name="l00716"></a>00716     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a>){
<a name="l00717"></a>00717     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#19712b797f289a287912eb95e1aa7d4a" title="save old L2 to update the tomography matrix.">L2save</a>);
<a name="l00718"></a>00718     recon-&gt;<a class="code" href="structRECON__T.html#19712b797f289a287912eb95e1aa7d4a" title="save old L2 to update the tomography matrix.">L2save</a>=recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>;
<a name="l00719"></a>00719     }<span class="keywordflow">else</span>{
<a name="l00720"></a>00720     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>);
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722     recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>=NULL;
<a name="l00723"></a>00723     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>; ips++){
<a name="l00724"></a>00724     <span class="comment">/*When layers get a weight less than 1%, we put it at 1% to avoid</span>
<a name="l00725"></a>00725 <span class="comment">      regularization unstability issues.*/</span>
<a name="l00726"></a>00726     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]&lt;0.01){
<a name="l00727"></a>00727         recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]=0.01;
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     <span class="comment">//normalize the weights to sum to 1.</span>
<a name="l00731"></a>00731     <a class="code" href="mathmisc_8c.html#c80bb740d5184ab44318b505ee66d13b" title="normalize vector to sum to norm;">normalize</a>(recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>, 1);
<a name="l00732"></a>00732     <span class="keyword">const</span> <span class="keywordtype">int</span> npsr=recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>;
<a name="l00733"></a>00733     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#840b2d7f2f18f6f28c218849be0588c0" title="load laplacian from to do Cxx^-1 in tomo.">L2</a>){
<a name="l00734"></a>00734     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#19f667fc7731b5bde53fd4761496f94a">calc_invpsd</a>){
<a name="l00735"></a>00735         recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#840b2d7f2f18f6f28c218849be0588c0" title="load laplacian from to do Cxx^-1 in tomo.">L2</a>);
<a name="l00736"></a>00736         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>!=npsr || recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>!=1){
<a name="l00737"></a>00737         error(<span class="stringliteral">"Wrong format of loaded invpsd\n"</span>);
<a name="l00738"></a>00738         }
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#6a050f8dc89b871fed9d590ba5885bb7" title="use inverse of PSD in tomography instead of biharmonic approx">invpsd</a>){
<a name="l00741"></a>00741         recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#840b2d7f2f18f6f28c218849be0588c0" title="load laplacian from to do Cxx^-1 in tomo.">L2</a>);
<a name="l00742"></a>00742         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#ba098ee8e31aa0222beb2c25c9ab1e3a" title="number of rows">nx</a>!=npsr || recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#0758b8001e69d1c246adfbe94bbf101c" title="number of columns">ny</a>!=npsr){
<a name="l00743"></a>00743         error(<span class="stringliteral">"Wrong format of loaded L2\n"</span>);
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746     }<span class="keywordflow">else</span>{
<a name="l00747"></a>00747     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#19f667fc7731b5bde53fd4761496f94a">calc_invpsd</a>){
<a name="l00748"></a>00748         recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>=dcellnew(npsr,1);
<a name="l00749"></a>00749         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00750"></a>00750         recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips]=<a class="code" href="turbulence_8c.html#2e0af40d287400ed37540da1b88cb3ea" title="inverse of PSD.">vonkarman_invpsd</a>
<a name="l00751"></a>00751             (recon-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>[ips], recon-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>[ips],
<a name="l00752"></a>00752              recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]-&gt;<a class="code" href="structLOC__T.html#ae9e38522a793c7d018028a38fc34ce0" title="Sampling.">dx</a>, recon-&gt;<a class="code" href="structRECON__T.html#537e1606a4a3c2d0da4c5461c7bb8f11" title="r0 used in reconstruction.">r0</a>*pow(recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips],-3./5.),
<a name="l00753"></a>00753              recon-&gt;<a class="code" href="structRECON__T.html#8a6984898c82e54ce7a4d9ad37db0a0b" title="l0 used in reconstruction.">l0</a>);
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755     }
<a name="l00756"></a>00756     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#6a050f8dc89b871fed9d590ba5885bb7" title="use inverse of PSD in tomography instead of biharmonic approx">invpsd</a>){
<a name="l00757"></a>00757         recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(npsr,npsr);
<a name="l00758"></a>00758         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00759"></a>00759         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#2a286e84160801fd89366d02f005a39e" title="use square/rectangular grid instead of tighter irregular grid">square</a>){<span class="comment">//periodic bc</span>
<a name="l00760"></a>00760             <span class="keywordflow">if</span>(ips==0){
<a name="l00761"></a>00761             info(<span class="stringliteral">"Laplacian reg. is using perodic bc\n"</span>);
<a name="l00762"></a>00762             }
<a name="l00763"></a>00763             recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips]=mklaplacian_map
<a name="l00764"></a>00764             (recon-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>[ips], recon-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>[ips],
<a name="l00765"></a>00765              recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]-&gt;<a class="code" href="structLOC__T.html#ae9e38522a793c7d018028a38fc34ce0" title="Sampling.">dx</a>, recon-&gt;<a class="code" href="structRECON__T.html#537e1606a4a3c2d0da4c5461c7bb8f11" title="r0 used in reconstruction.">r0</a>,
<a name="l00766"></a>00766              recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]);
<a name="l00767"></a>00767         }<span class="keywordflow">else</span>{<span class="comment">//reflecive bc</span>
<a name="l00768"></a>00768             <span class="keywordflow">if</span>(ips==0){
<a name="l00769"></a>00769             info(<span class="stringliteral">"Laplacian reg. is using reflective bc\n"</span>);
<a name="l00770"></a>00770             }
<a name="l00771"></a>00771             recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips]=mklaplacian_loc
<a name="l00772"></a>00772             (recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips], recon-&gt;<a class="code" href="structRECON__T.html#537e1606a4a3c2d0da4c5461c7bb8f11" title="r0 used in reconstruction.">r0</a>, 
<a name="l00773"></a>00773              recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]);
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00778"></a>00778         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>){
<a name="l00779"></a>00779         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>, <span class="stringliteral">"%s/invpsd"</span>,dirsetup);
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>){
<a name="l00782"></a>00782         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>, <span class="stringliteral">"%s/L2"</span>,dirsetup);
<a name="l00783"></a>00783         }
<a name="l00784"></a>00784     }
<a name="l00785"></a>00785     
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#92881e916c336aa7e5b337f4f1aab397" title="single point piston constraint.">piston_cr</a>){
<a name="l00788"></a>00788     <span class="comment">/*when add constraint, make sure the order of</span>
<a name="l00789"></a>00789 <span class="comment">      magnitude are at the same range.*/</span>
<a name="l00790"></a>00790     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>);
<a name="l00791"></a>00791     recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(npsr,npsr);
<a name="l00792"></a>00792     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00793"></a>00793         <span class="keywordtype">double</span> r0=recon-&gt;<a class="code" href="structRECON__T.html#537e1606a4a3c2d0da4c5461c7bb8f11" title="r0 used in reconstruction.">r0</a>;
<a name="l00794"></a>00794         <span class="keywordtype">double</span> dx=recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]-&gt;<a class="code" href="structLOC__T.html#ae9e38522a793c7d018028a38fc34ce0" title="Sampling.">dx</a>;
<a name="l00795"></a>00795         <span class="keywordtype">double</span> wt=recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips];
<a name="l00796"></a>00796         <span class="keywordtype">double</span> val=pow(laplacian_coef(r0,wt,dx),2);
<a name="l00797"></a>00797         <span class="comment">//info("Scaling of ZZT is %g\n",val);</span>
<a name="l00798"></a>00798         <span class="comment">//piston mode eq 47 in Brent 2002 paper</span>
<a name="l00799"></a>00799         <span class="keywordtype">int</span> icenter=<a class="code" href="loc_8c.html#60a7658b908d2b96ca3c9b48aba47e24" title="Find the point that closes to origin (0,0) in loc.">loccenter</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]);
<a name="l00800"></a>00800         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00801"></a>00801         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *ZZT=recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips]
<a name="l00802"></a>00802         =<a class="code" href="dsp_8h.html#ad23f2152cd2622871367fd28ac0ff6b" title="Create a nx*ny X(sp) matrix with memory for nmax max elements allocated.">spnew</a>(nloc,nloc,1);
<a name="l00803"></a>00803         <span class="keywordtype">int</span> icol;
<a name="l00804"></a>00804         <span class="keywordtype">int</span> count=0;
<a name="l00805"></a>00805         <span class="keywordflow">for</span>(icol=0; icol&lt;nloc; icol++){
<a name="l00806"></a>00806         ZZT-&gt;<a class="code" href="structdsp.html#a9f3db1d7c4d321157e4efac11f3351a" title="column pointers (size n+1) or col indlces (size nzmax) when nz!=-1">p</a>[icol]=count;
<a name="l00807"></a>00807         <span class="keywordflow">if</span>(icol==icenter){
<a name="l00808"></a>00808             ZZT-&gt;<a class="code" href="structdsp.html#1d87a5584935632deb8bf23ea8eb46bf" title="row indices, size nzmax">i</a>[count]=icenter;
<a name="l00809"></a>00809             ZZT-&gt;<a class="code" href="structdsp.html#72f5e4eabdf69453be2ec0708558f023" title="numerical values, size nzmax">x</a>[count]=val;
<a name="l00810"></a>00810             count++;
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813         ZZT-&gt;<a class="code" href="structdsp.html#a9f3db1d7c4d321157e4efac11f3351a" title="column pointers (size n+1) or col indlces (size nzmax) when nz!=-1">p</a>[nloc]=count;
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00816"></a>00816         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>, <span class="stringliteral">"%s/ZZT"</span>,dirsetup);
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#19f667fc7731b5bde53fd4761496f94a">calc_invpsd</a>){
<a name="l00820"></a>00820     ccellfree(recon-&gt;<a class="code" href="structRECON__T.html#fb207ca2a54ecb46e5ff16c995bb2fc2">fftxopd</a>);
<a name="l00821"></a>00821     recon-&gt;<a class="code" href="structRECON__T.html#fb207ca2a54ecb46e5ff16c995bb2fc2">fftxopd</a>=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>,1);
<a name="l00822"></a>00822     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>; ips++){
<a name="l00823"></a>00823         recon-&gt;<a class="code" href="structRECON__T.html#fb207ca2a54ecb46e5ff16c995bb2fc2">fftxopd</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>[ips],recon-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>[ips]);
<a name="l00824"></a>00824         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(recon-&gt;<a class="code" href="structRECON__T.html#fb207ca2a54ecb46e5ff16c995bb2fc2">fftxopd</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips],-1);
<a name="l00825"></a>00825         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(recon-&gt;<a class="code" href="structRECON__T.html#fb207ca2a54ecb46e5ff16c995bb2fc2">fftxopd</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips],1);
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827     }
<a name="l00828"></a>00828 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="764bf903a38cfc81220e42699e911884"></a><!-- doxytag: member="setup_recon.c::setup_recon_tomo_matrix" ref="764bf903a38cfc81220e42699e911884" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_recon_tomo_matrix           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
assemble tomography matrix. 
<p>
In CG mode, this function is not executed if tomo.assemble=0, Instead, the algorithm is contained in <a class="el" href="recon_8c.html" title="Wavefront reconstruction and DM fitting routines.">recon.c</a>. When you modify anything, make sure you also do it there.<p>
For integrated tomograhy:<p>
<img class="formulaInl" alt="$\hat{x}=(G_{lgs}^{T}C_{lgs}^{-1}G_{lgs}+C_{x}^{-1}+G_{ngs}^{T}C_{ngs}^{-1} G_{ngs})^{-1}(G_{lgs}^{T}C_{lgs}^{-1}s_{lgs}+G_{ngs}^{T}C_{ngs}^{-1}s_{ngs}){\equiv}RL^{-1}RR s.$" src="form_35.png"><p>
For split tomography, the terms regarding NGS are dropped:<p>
<img class="formulaInl" alt="$\hat{x}_{lgs}=(G_{lgs}^{T}C_{lgs}^{-1}G_{lgs}+C_{x}^{-1})^{-1} G_{lgs}^{T}C_{lgs}^{-1}s_{lgs}\equiv RL^{-1} RR s.$" src="form_36.png"><p>
The left hand side of linear equation (inside the inverse) is stored in RL. The right hand side of the linear equation (outside of the inverse) is stored in RR. The terms regarding the NGS are handled using low rank terms. The gradients from LGS and NGS and concatenated to <img class="formulaInl" alt="$s$" src="form_37.png">.<p>
In the LGS part, there is a global tip/tilt removal operator because LGS is insensitive to global tip/tilts.<p>
For details see <a href="http://www.opticsinfobase.org/abstract.cfm?URI=josaa-19-9-1803">http://www.opticsinfobase.org/abstract.cfm?URI=josaa-19-9-1803</a> <div class="fragment"><pre class="fragment"><a name="l00855"></a>00855                                                                   {
<a name="l00856"></a>00856     <span class="comment">//if not cg or forced, build explicitly the tomography matrix.</span>
<a name="l00857"></a>00857     <span class="keywordtype">int</span> npsr=recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>;
<a name="l00858"></a>00858     <span class="keywordtype">int</span> nwfs=parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>;
<a name="l00859"></a>00859     <span class="comment">//Free OLD matrices if any.</span>
<a name="l00860"></a>00860     <a class="code" href="muv_8c.html#8a899d10d6a3cae809525fcf0ec44b81" title="Free MUV_T struct.">muv_free</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>);
<a name="l00861"></a>00861     <a class="code" href="muv_8c.html#8a899d10d6a3cae809525fcf0ec44b81" title="Free MUV_T struct.">muv_free</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>);
<a name="l00862"></a>00862     info2(<span class="stringliteral">"Before assembling tomo matrix:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l00863"></a>00863 
<a name="l00864"></a>00864     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#6300bd2144c25191aa100662d299234f" title="if 1, load tomo matrix">tomo</a>){
<a name="l00865"></a>00865     <span class="comment">//right hand side.</span>
<a name="l00866"></a>00866     warning(<span class="stringliteral">"Loading saved recon-&gt;RR\n"</span>);
<a name="l00867"></a>00867     recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"RRM.bin.gz"</span>);
<a name="l00868"></a>00868     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#033a52251e3c28ded25b16d4bbefbe72">has_ttr</a>){
<a name="l00869"></a>00869         recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"RRU.bin.gz"</span>);
<a name="l00870"></a>00870         recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"RRV.bin.gz"</span>);
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872     <span class="comment">//Left hand side</span>
<a name="l00873"></a>00873     warning(<span class="stringliteral">"Loading saved recon-&gt;RL\n"</span>);
<a name="l00874"></a>00874     <span class="keywordflow">if</span>(exist(<span class="stringliteral">"RLM.bin"</span>))
<a name="l00875"></a>00875         recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"RLM.bin"</span>);
<a name="l00876"></a>00876     <span class="keywordflow">else</span>
<a name="l00877"></a>00877         recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"RLM.bin.gz"</span>);
<a name="l00878"></a>00878     recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"RLU.bin.gz"</span>);
<a name="l00879"></a>00879     recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"RLV.bin.gz"</span>);
<a name="l00880"></a>00880     }<span class="keywordflow">else</span>{
<a name="l00881"></a>00881     info(<span class="stringliteral">"Building recon-&gt;RR\n"</span>);
<a name="l00882"></a>00882     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*G0)[nwfs] = (<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*)[nwfs])recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l00883"></a>00883     <span class="keyword">const</span> <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *saneai=recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>;
<a name="l00884"></a>00884     <span class="comment">/*</span>
<a name="l00885"></a>00885 <span class="comment">      Reconstruction Right hand side matrix. In split tomography mode, low</span>
<a name="l00886"></a>00886 <span class="comment">      order NGS are skipped. recon-&gt;G0tomo contains G0s that only</span>
<a name="l00887"></a>00887 <span class="comment">      participate in tomography.</span>
<a name="l00888"></a>00888 <span class="comment">     */</span>
<a name="l00889"></a>00889     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *G0tomoT=<a class="code" href="dsp_8h.html#a4691afd2563e44ec261422a3648ff01" title="Transpose a sparse cell.">spcelltrans</a>(recon-&gt;<a class="code" href="structRECON__T.html#6208af43c0f23db39923cb073823ef2e">G0tomo</a>);
<a name="l00890"></a>00890     recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dsp_8h.html#5ba25787c1b6292d42da40d941cea273" title="Multiply two sparse cell.">spcellmulspcell</a>(G0tomoT, saneai, 1);
<a name="l00891"></a>00891     PDSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>, RRM);
<a name="l00892"></a>00892     <span class="comment">/*</span>
<a name="l00893"></a>00893 <span class="comment">      Tip/tilt and diff focus removal low rand terms for LGS WFS.</span>
<a name="l00894"></a>00894 <span class="comment">    */</span>
<a name="l00895"></a>00895     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>){
<a name="l00896"></a>00896         <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>, recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>, recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>, 1);
<a name="l00897"></a>00897         recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=dcelltrans(recon-&gt;<a class="code" href="structRECON__T.html#35b159335cbe2615df14d3bed3085298">PTTF</a>);
<a name="l00898"></a>00898     }
<a name="l00899"></a>00899  
<a name="l00900"></a>00900     info(<span class="stringliteral">"Building recon-&gt;RL\n"</span>); <span class="comment">//left hand side matrix</span>
<a name="l00901"></a>00901     recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dsp_8h.html#5ba25787c1b6292d42da40d941cea273" title="Multiply two sparse cell.">spcellmulspcell</a>(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,recon-&gt;<a class="code" href="structRECON__T.html#cd5664235d8ec047a69f515ee01bc4c6">G0hi</a>,1);
<a name="l00902"></a>00902     PDSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,RLM);
<a name="l00903"></a>00903     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#92881e916c336aa7e5b337f4f1aab397" title="single point piston constraint.">piston_cr</a>){ 
<a name="l00904"></a>00904         <span class="comment">/*single point piston constraint. no need tikholnov.*/</span>
<a name="l00905"></a>00905         info(<span class="stringliteral">"Adding ZZT to RLM\n"</span>);
<a name="l00906"></a>00906         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00907"></a>00907         <a class="code" href="dsp_8h.html#55a721406266e38174283509208e78c8" title="Add a sparse matrix to another: A0=A0+B.">spadd</a>(&amp;RLM[ips][ips], recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+ips*npsr]);
<a name="l00908"></a>00908         }
<a name="l00909"></a>00909     }<span class="keywordflow">else</span>{
<a name="l00910"></a>00910         <span class="comment">/*Apply tikholnov regularization.*/</span>
<a name="l00911"></a>00911         info(<span class="stringliteral">"Adding tikhonov constraint of %g to RLM\n"</span>, 
<a name="l00912"></a>00912          parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#cc33a933f0df8b5b7bc03d1d7a7b1fe5" title="tikhonov regularization.">tik_cstr</a>);
<a name="l00913"></a>00913         tic;
<a name="l00914"></a>00914         <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#cc33a933f0df8b5b7bc03d1d7a7b1fe5" title="tikhonov regularization.">tik_cstr</a>)&gt;1.e-200){
<a name="l00915"></a>00915         <span class="keywordtype">double</span> tikcr=parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#cc33a933f0df8b5b7bc03d1d7a7b1fe5" title="tikhonov regularization.">tik_cstr</a>;
<a name="l00916"></a>00916         <span class="keywordflow">if</span>(fabs(tikcr)&lt;1.e-14){
<a name="l00917"></a>00917             warning(<span class="stringliteral">"tikcr=%g is too small\n"</span>,tikcr);
<a name="l00918"></a>00918         }
<a name="l00919"></a>00919         <a class="code" href="eigs_8c.html#45367708d512ccf95ac48292c25419f8" title="Apply tikhonov regulation with threshold of thres*max(eig(A)).">spcelltikcr</a>(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,tikcr);
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921         toc(<span class="stringliteral">"done"</span>);
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923     <span class="comment">//add L2 and ZZT</span>
<a name="l00924"></a>00924     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#6a050f8dc89b871fed9d590ba5885bb7" title="use inverse of PSD in tomography instead of biharmonic approx">invpsd</a>){
<a name="l00925"></a>00925         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>!=1){
<a name="l00926"></a>00926         error(<span class="stringliteral">"Can not use invpsd in non-CG mode.\n"</span>);
<a name="l00927"></a>00927         }<span class="keywordflow">else</span>{
<a name="l00928"></a>00928         INVPSD_T *tmp= calloc(1, <span class="keyword">sizeof</span>(INVPSD_T));
<a name="l00929"></a>00929         tmp-&gt;invpsd  = recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>;
<a name="l00930"></a>00930         tmp-&gt;fftxopd = recon-&gt;<a class="code" href="structRECON__T.html#fb207ca2a54ecb46e5ff16c995bb2fc2">fftxopd</a>;
<a name="l00931"></a>00931         tmp-&gt;xembed  = 0;
<a name="l00932"></a>00932         recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#3e9fb771da66419d7d4b697405bdc9b6" title="Data used by fun to apply: (*exfun)(y,extra,x,alpha) to compute.">extra</a> = tmp;
<a name="l00933"></a>00933         recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#0a370be0b229e7b207dbb93f9e5c06fb" title="Optionally attach an extra function that applies extra data.">exfun</a> = (CGFUN)<a class="code" href="recon__utils_8c.html#4426460a3e86bfd2b5ff2457f6333740" title="Apply turbulence invpsd to x in Fourier space, scaled by alpha.">apply_invpsd</a>;
<a name="l00934"></a>00934         }
<a name="l00935"></a>00935     }<span class="keywordflow">else</span>{
<a name="l00936"></a>00936         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00937"></a>00937         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>* tmp=<a class="code" href="dsp_8h.html#b3929bab7dcd7cf4be34e9e4f7579c90" title="Multiply the transpose of a sparse with another: return A&amp;#39;*B.">sptmulsp</a>(recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips], 
<a name="l00938"></a>00938                   recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips]);
<a name="l00939"></a>00939         <span class="keywordflow">if</span>(!tmp){
<a name="l00940"></a>00940             error(<span class="stringliteral">"L2 is empty!!\n"</span>);
<a name="l00941"></a>00941         }
<a name="l00942"></a>00942         <a class="code" href="dsp_8h.html#55a721406266e38174283509208e78c8" title="Add a sparse matrix to another: A0=A0+B.">spadd</a>(&amp;RLM[ips][ips], tmp);
<a name="l00943"></a>00943         spfree(tmp);
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945     }
<a name="l00946"></a>00946     <span class="comment">//Symmetricize, remove values below 1e-15*max and sort RLM (optional).</span>
<a name="l00947"></a>00947     <span class="comment">//spcellsym(recon-&gt;RL.M);</span>
<a name="l00948"></a>00948 
<a name="l00949"></a>00949     <span class="comment">//Low rank terms for low order wfs. Only in Integrated tomography.</span>
<a name="l00950"></a>00950     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *ULo=dcellnew(npsr,nwfs);
<a name="l00951"></a>00951     PDCELL(ULo, pULo);
<a name="l00952"></a>00952     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *VLo=dcellnew(npsr,nwfs);
<a name="l00953"></a>00953     PDCELL(VLo, pVLo);
<a name="l00954"></a>00954     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00955"></a>00955         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>&amp;&amp;recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs]){
<a name="l00956"></a>00956         <span class="keywordflow">continue</span>;
<a name="l00957"></a>00957         }
<a name="l00958"></a>00958         <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00959"></a>00959         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l00960"></a>00960         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l00961"></a>00961             <a class="code" href="dsp_8h.html#1f816ec221da7595c0e1b598caaef328" title="Convert sparse matrix into dense matrix and add to output: out0=out0+full(A)*alpha...">spfull</a>(&amp;pULo[iwfs][ips], RRM[iwfs][ips],-1);
<a name="l00962"></a>00962             <a class="code" href="dsp_8h.html#f9a447cc8dfb7398a1d9b26b6b905bb4" title="Convert the transpose of a sparse matrix into dense matrix and add to output: out0=out0+full(A&amp;#39;)...">sptfull</a>(&amp;pVLo[iwfs][ips], G0[ips][iwfs],1);
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964         }
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966     recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>=dcellcat(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>, ULo, 2);
<a name="l00967"></a>00967     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *GPTTDF=NULL;
<a name="l00968"></a>00968     <a class="code" href="dsp_8h.html#730a5070a85111231144cdd535a9f952" title="C=C+A&amp;#39;*B*alpha.">sptcellmulmat</a>(&amp;GPTTDF, recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>, recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>, 1);
<a name="l00969"></a>00969     recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=dcellcat(GPTTDF, VLo, 2);
<a name="l00970"></a>00970     dcellfree(GPTTDF);
<a name="l00971"></a>00971     dcellfree(ULo);
<a name="l00972"></a>00972     dcellfree(VLo);
<a name="l00973"></a>00973     <span class="comment">//Remove empty cells.</span>
<a name="l00974"></a>00974     dcelldropempty(&amp;recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,2);
<a name="l00975"></a>00975     dcelldropempty(&amp;recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>,2);
<a name="l00976"></a>00976     dcelldropempty(&amp;recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,2);
<a name="l00977"></a>00977     dcelldropempty(&amp;recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>,2);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <span class="keywordtype">long</span> nll=0,nlr=0;
<a name="l00980"></a>00980     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>){
<a name="l00981"></a>00981         <span class="comment">/*</span>
<a name="l00982"></a>00982 <span class="comment">          balance UV. may not be necessary. Just to compare well against</span>
<a name="l00983"></a>00983 <span class="comment">          laos.</span>
<a name="l00984"></a>00984 <span class="comment">        */</span>
<a name="l00985"></a>00985         <span class="keywordtype">double</span> r0=recon-&gt;<a class="code" href="structRECON__T.html#537e1606a4a3c2d0da4c5461c7bb8f11" title="r0 used in reconstruction.">r0</a>;
<a name="l00986"></a>00986         <span class="keywordtype">double</span> dx=recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[0]-&gt;<a class="code" href="structLOC__T.html#ae9e38522a793c7d018028a38fc34ce0" title="Sampling.">dx</a>;
<a name="l00987"></a>00987         <span class="keywordtype">double</span> val=laplacian_coef(r0,1,dx);<span class="comment">//needs to be a constant</span>
<a name="l00988"></a>00988         dcellscale(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>, 1./val);
<a name="l00989"></a>00989         dcellscale(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>, val);
<a name="l00990"></a>00990         <span class="comment">//collect statistics.</span>
<a name="l00991"></a>00991         PDCELL(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,RRU);
<a name="l00992"></a>00992         PDCELL(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,RLU);
<a name="l00993"></a>00993         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>;i++){
<a name="l00994"></a>00994         <span class="keywordflow">if</span>(RRU[i][0]) nlr+=RRU[i][0]-&gt;ny;
<a name="l00995"></a>00995         }
<a name="l00996"></a>00996         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>;i++){
<a name="l00997"></a>00997         <span class="keywordflow">if</span>(RLU[i][0]) nll+=RLU[i][0]-&gt;ny;
<a name="l00998"></a>00998         }
<a name="l00999"></a>00999     }
<a name="l01000"></a>01000     info(<span class="stringliteral">"Tomography # of Low rank terms: %ld in RHS, %ld in LHS\n"</span>, 
<a name="l01001"></a>01001          nlr,nll);
<a name="l01002"></a>01002     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#487426d82238f2159c7d6e9ec0b58ad3" title="save reconstructor information.">recon</a>){
<a name="l01003"></a>01003         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,<span class="stringliteral">"%s/RRM"</span>,dirsetup);
<a name="l01004"></a>01004         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,<span class="stringliteral">"%s/RRU"</span>,dirsetup);
<a name="l01005"></a>01005         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>,<span class="stringliteral">"%s/RRV"</span>,dirsetup);
<a name="l01006"></a>01006 
<a name="l01007"></a>01007         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,<span class="stringliteral">"%s/RLM.bin"</span>,dirsetup);<span class="comment">//disable compression</span>
<a name="l01008"></a>01008         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,<span class="stringliteral">"%s/RLU"</span>,dirsetup);
<a name="l01009"></a>01009         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>,<span class="stringliteral">"%s/RLV"</span>,dirsetup); 
<a name="l01010"></a>01010     }
<a name="l01011"></a>01011     spcellfree(G0tomoT);
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013     info2(<span class="stringliteral">"After assemble matrix:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l01014"></a>01014     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>==0 || (parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==2 &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#af8875582b897aa7687b202b15b2f814" title="load MVST mvst_U and mvst_FU.">mvst</a>)){
<a name="l01015"></a>01015     <a class="code" href="muv_8c.html#0259762671f4caf31653363fe2483c5c" title="Cholesky factorization on the sparse matrix and its low rank terms.">muv_chol_prep</a>(&amp;(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>));
<a name="l01016"></a>01016     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#487426d82238f2159c7d6e9ec0b58ad3" title="save reconstructor information.">recon</a>){
<a name="l01017"></a>01017         <a class="code" href="chol_8c.html#3ff611672c83dc9ccf8f53ca9e299e71" title="Save cholesky factor: the lower left side and permutation vector.">chol_save</a>(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#94e4b5e2b57d787f3467a9f1c81354fb">C</a>,<span class="stringliteral">"%s/RLC"</span>,dirsetup);
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019     info2(<span class="stringliteral">"After cholesky on matrix:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l01020"></a>01020     }
<a name="l01021"></a>01021     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a> &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.tomo){
<a name="l01022"></a>01022     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>);
<a name="l01023"></a>01023     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#35b159335cbe2615df14d3bed3085298">PTTF</a>);
<a name="l01024"></a>01024     <span class="comment">//Don't free PTT. Used in forming LGS uplink err</span>
<a name="l01025"></a>01025     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#92881e916c336aa7e5b337f4f1aab397" title="single point piston constraint.">piston_cr</a>)
<a name="l01026"></a>01026         spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>);
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a> || parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>==0){
<a name="l01029"></a>01029     info(<span class="stringliteral">"Freeing RL.M,U,V\n"</span>);
<a name="l01030"></a>01030     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>);
<a name="l01031"></a>01031     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>);
<a name="l01032"></a>01032     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>);
<a name="l01033"></a>01033     }
<a name="l01034"></a>01034     info2(<span class="stringliteral">"At exit :\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l01035"></a>01035 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="4aff68732e2560d8d421521ae47485a4"></a><!-- doxytag: member="setup_recon.c::setup_recon_tomo_matrix_update" ref="4aff68732e2560d8d421521ae47485a4" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_recon_tomo_matrix_update           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Update assembled tomography matrix with new L2. 
<p>
<div class="fragment"><pre class="fragment"><a name="l01039"></a>01039                                                                          {
<a name="l01040"></a>01040     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>!=1){
<a name="l01041"></a>01041     error(<span class="stringliteral">"This is only to be used in CG mode\n"</span>);
<a name="l01042"></a>01042     }
<a name="l01043"></a>01043     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a>){<span class="comment">//no need to do anything</span>
<a name="l01044"></a>01044     <span class="keywordflow">return</span>;
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#6a050f8dc89b871fed9d590ba5885bb7" title="use inverse of PSD in tomography instead of biharmonic approx">invpsd</a>){
<a name="l01047"></a>01047     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>!=1){
<a name="l01048"></a>01048         error(<span class="stringliteral">"Can not use invpsd in non-CG mode.\n"</span>);
<a name="l01049"></a>01049     }<span class="keywordflow">else</span>{
<a name="l01050"></a>01050         INVPSD_T *tmp= calloc(1, <span class="keyword">sizeof</span>(INVPSD_T));
<a name="l01051"></a>01051         tmp-&gt;invpsd  = recon-&gt;<a class="code" href="structRECON__T.html#313519f327a94f69131d467277321d8a">invpsd</a>;
<a name="l01052"></a>01052         tmp-&gt;fftxopd = recon-&gt;<a class="code" href="structRECON__T.html#fb207ca2a54ecb46e5ff16c995bb2fc2">fftxopd</a>;
<a name="l01053"></a>01053         tmp-&gt;xembed  = 0;
<a name="l01054"></a>01054         recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#3e9fb771da66419d7d4b697405bdc9b6" title="Data used by fun to apply: (*exfun)(y,extra,x,alpha) to compute.">extra</a> = tmp;
<a name="l01055"></a>01055         recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#0a370be0b229e7b207dbb93f9e5c06fb" title="Optionally attach an extra function that applies extra data.">exfun</a> = (CGFUN)<a class="code" href="recon__utils_8c.html#4426460a3e86bfd2b5ff2457f6333740" title="Apply turbulence invpsd to x in Fourier space, scaled by alpha.">apply_invpsd</a>;
<a name="l01056"></a>01056     }
<a name="l01057"></a>01057     }<span class="keywordflow">else</span>{
<a name="l01058"></a>01058     <span class="comment">//Need to adjust RLM with the new L2.</span>
<a name="l01059"></a>01059     <span class="keywordflow">if</span>(!recon-&gt;<a class="code" href="structRECON__T.html#19712b797f289a287912eb95e1aa7d4a" title="save old L2 to update the tomography matrix.">L2save</a>){
<a name="l01060"></a>01060         error(<span class="stringliteral">"We need the L2save to update the tomography matrix\n"</span>);
<a name="l01061"></a>01061     }
<a name="l01062"></a>01062     PDSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,RLM);
<a name="l01063"></a>01063     <span class="keyword">const</span> <span class="keywordtype">int</span> npsr=recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>;
<a name="l01064"></a>01064     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l01065"></a>01065         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>* LL=<a class="code" href="dsp_8h.html#b3929bab7dcd7cf4be34e9e4f7579c90" title="Multiply the transpose of a sparse with another: return A&amp;#39;*B.">sptmulsp</a>(recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips], 
<a name="l01066"></a>01066                  recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips]);
<a name="l01067"></a>01067         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *LLold=<a class="code" href="dsp_8h.html#b3929bab7dcd7cf4be34e9e4f7579c90" title="Multiply the transpose of a sparse with another: return A&amp;#39;*B.">sptmulsp</a>(recon-&gt;<a class="code" href="structRECON__T.html#19712b797f289a287912eb95e1aa7d4a" title="save old L2 to update the tomography matrix.">L2save</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips], 
<a name="l01068"></a>01068                  recon-&gt;<a class="code" href="structRECON__T.html#19712b797f289a287912eb95e1aa7d4a" title="save old L2 to update the tomography matrix.">L2save</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips+npsr*ips]);
<a name="l01069"></a>01069         <span class="keywordflow">if</span>(!LL){
<a name="l01070"></a>01070         error(<span class="stringliteral">"L2 is empty!!\n"</span>);
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *LLdiff=<a class="code" href="dsp_8h.html#a55aa866dc8f53618cdb5ded64643f69" title="Added two sparse matrices: return A*a+B*b.">spadd2</a>(LL,LLold,1,-1);<span class="comment">//adjustment to RLM</span>
<a name="l01073"></a>01073         <a class="code" href="dsp_8h.html#55a721406266e38174283509208e78c8" title="Add a sparse matrix to another: A0=A0+B.">spadd</a>(&amp;RLM[ips][ips], LLdiff);
<a name="l01074"></a>01074         spfree(LLdiff);
<a name="l01075"></a>01075         spfree(LL);
<a name="l01076"></a>01076         spfree(LLold);
<a name="l01077"></a>01077     }
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="fa92eb0639f142dd512c13688b21d813"></a><!-- doxytag: member="setup_recon.c::setup_recon_HXHA" ref="fa92eb0639f142dd512c13688b21d813" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_HXHA           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup ray tracing operator HX,HA from xloc, aloc to aperture ploc. 
<p>
<div class="fragment"><pre class="fragment"><a name="l01083"></a>01083                                                       {
<a name="l01084"></a>01084     <span class="comment">//Greate HX and HA matrix;</span>
<a name="l01085"></a>01085     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#4b1fa60895a754e0fab46e71d84a384d" title="load HX from.">HX</a> &amp;&amp; exist(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#4b1fa60895a754e0fab46e71d84a384d" title="load HX from.">HX</a>)){
<a name="l01086"></a>01086     warning(<span class="stringliteral">"Loading saved HX\n"</span>);
<a name="l01087"></a>01087     recon-&gt;<a class="code" href="structRECON__T.html#41a461a54e2753a1714894878cc63f94">HX</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#4b1fa60895a754e0fab46e71d84a384d" title="load HX from.">HX</a>);
<a name="l01088"></a>01088     }<span class="keywordflow">else</span>{
<a name="l01089"></a>01089     <span class="keyword">const</span> <span class="keywordtype">int</span> nfit=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>;
<a name="l01090"></a>01090     <span class="keyword">const</span> <span class="keywordtype">int</span> npsr=recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>;
<a name="l01091"></a>01091     recon-&gt;<a class="code" href="structRECON__T.html#41a461a54e2753a1714894878cc63f94">HX</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(nfit, npsr);
<a name="l01092"></a>01092     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>* (*HX)[nfit]=(<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*)[nfit])recon-&gt;<a class="code" href="structRECON__T.html#41a461a54e2753a1714894878cc63f94">HX</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l01093"></a>01093     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ifit=0; ifit&lt;nfit; ifit++){
<a name="l01094"></a>01094         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l01095"></a>01095         <span class="keyword">const</span> <span class="keywordtype">double</span> scale=1.;
<a name="l01096"></a>01096         <span class="keyword">const</span> <span class="keywordtype">double</span> ht = recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips];
<a name="l01097"></a>01097         <span class="keywordtype">double</span> displace[2];
<a name="l01098"></a>01098         displace[0]=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#e546272f69aa60a0f5c435d438641001" title="x Coordinate of DM fitting directions.">thetax</a>[ifit]*ht;
<a name="l01099"></a>01099         displace[1]=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4c47b74e14e1521755410a9183d3ef6c" title="y Coordinate of DM fitting directions.">thetay</a>[ifit]*ht;
<a name="l01100"></a>01100         HX[ips][ifit]=<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips], recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, 
<a name="l01101"></a>01101                   NULL,displace[0], displace[1],
<a name="l01102"></a>01102                   scale,0);
<a name="l01103"></a>01103         }
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01106"></a>01106         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#41a461a54e2753a1714894878cc63f94">HX</a>,<span class="stringliteral">"%s/HX.bin.gz"</span>,dirsetup);
<a name="l01107"></a>01107     }
<a name="l01108"></a>01108     }
<a name="l01109"></a>01109     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#3eb9ae4eeeaed334aa9e04f74763f0d3" title="load HA from.">HA</a> &amp;&amp; exist(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#3eb9ae4eeeaed334aa9e04f74763f0d3" title="load HA from.">HA</a>)){
<a name="l01110"></a>01110     warning(<span class="stringliteral">"Loading saved HA\n"</span>);
<a name="l01111"></a>01111     recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#3eb9ae4eeeaed334aa9e04f74763f0d3" title="load HA from.">HA</a>);
<a name="l01112"></a>01112     }<span class="keywordflow">else</span>{
<a name="l01113"></a>01113     <span class="keyword">const</span> <span class="keywordtype">int</span> nfit=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>;
<a name="l01114"></a>01114     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l01115"></a>01115     recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(nfit, ndm);
<a name="l01116"></a>01116     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>,HA);
<a name="l01117"></a>01117     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ifit=0; ifit&lt;nfit; ifit++){
<a name="l01118"></a>01118         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01119"></a>01119         <span class="keyword">const</span> <span class="keywordtype">double</span> scale=1.;
<a name="l01120"></a>01120         <span class="keyword">const</span> <span class="keywordtype">double</span> ht=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l01121"></a>01121         <span class="keywordtype">double</span> displace[2];
<a name="l01122"></a>01122         displace[0]=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#e546272f69aa60a0f5c435d438641001" title="x Coordinate of DM fitting directions.">thetax</a>[ifit]*ht;
<a name="l01123"></a>01123         displace[1]=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4c47b74e14e1521755410a9183d3ef6c" title="y Coordinate of DM fitting directions.">thetay</a>[ifit]*ht;
<a name="l01124"></a>01124         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#cf71d816fd769fe830d2e03f82c28b12" title="use cubic spline.">cubic</a>){
<a name="l01125"></a>01125             HA[idm][ifit]=<a class="code" href="mkh_8c.html#1a5857040746e6edea04ad2e9a80c140" title="Create ray tracing operator from coordinate locin to locout using cubic influence...">mkh_cubic</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>,
<a name="l01126"></a>01126                         NULL,displace[0], displace[1], 
<a name="l01127"></a>01127                         scale,parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#fca1c9ed9b0f9ce5a25147eb5906947b" title="Inter-Actuator Coupling coefficient.">iac</a>,1);
<a name="l01128"></a>01128         }<span class="keywordflow">else</span>{
<a name="l01129"></a>01129             HA[idm][ifit]=<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>,
<a name="l01130"></a>01130                       NULL,displace[0], displace[1], 
<a name="l01131"></a>01131                       scale,0);
<a name="l01132"></a>01132         }
<a name="l01133"></a>01133         }
<a name="l01134"></a>01134     }
<a name="l01135"></a>01135     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01136"></a>01136         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>,<span class="stringliteral">"%s/HA"</span>,dirsetup);
<a name="l01137"></a>01137     }
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="630c6d5a66160c402a727df359300f20"></a><!-- doxytag: member="setup_recon.c::fit_prep_lrt" ref="630c6d5a66160c402a727df359300f20" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void fit_prep_lrt           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup fitting low rank terms that are in the NULL space of DM fitting operator. 
<p>
typically include piston on each DM and tip/tilt on certain DMs. Becareful with tip/tilt contraint when using CBS. <div class="fragment"><pre class="fragment"><a name="l01145"></a>01145                                                   {
<a name="l01146"></a>01146     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l01147"></a>01147     <span class="keywordflow">if</span>(ndm&gt;=3) warning(<span class="stringliteral">"Low rank terms for 3 or more dms are not tested\n"</span>);
<a name="l01148"></a>01148     recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>=dcellnew(ndm,1);
<a name="l01149"></a>01149     <span class="keywordtype">double</span> scl=recon-&gt;<a class="code" href="structRECON__T.html#84e975597a9d0042544267fc77a39f7e">fitscl</a>;
<a name="l01150"></a>01150     <span class="keywordflow">if</span>(fabs(scl)&lt;1.e-15){
<a name="l01151"></a>01151     error(<span class="stringliteral">"recon-&gt;fitscl is too small\n"</span>);
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153     <span class="comment">//computed outside.</span>
<a name="l01154"></a>01154     <span class="keywordtype">int</span> lrt_tt=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#ca277d524c4b2254cabecf77adfe5827" title="differential tip/tilt constraint on two DMs or tt on upper dms.">lrt_tt</a>;
<a name="l01155"></a>01155     <span class="keywordtype">int</span> nnw=0;
<a name="l01156"></a>01156     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#1e730c83ef1ca0115bddeb439c412d7f" title="Piston constraint low rank term in fit coefficient matrix.">lrt_piston</a>){
<a name="l01157"></a>01157     nnw+=ndm;
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159     <span class="keywordflow">if</span>(lrt_tt){
<a name="l01160"></a>01160     nnw+=2*(ndm-1);
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162     <span class="keywordflow">if</span>(nnw==0) <span class="keywordflow">return</span>;
<a name="l01163"></a>01163     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01164"></a>01164     <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01165"></a>01165     recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc, nnw);
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167     <span class="keywordtype">int</span> inw=0;<span class="comment">//current column</span>
<a name="l01168"></a>01168     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#1e730c83ef1ca0115bddeb439c412d7f" title="Piston constraint low rank term in fit coefficient matrix.">lrt_piston</a>){
<a name="l01169"></a>01169     info(<span class="stringliteral">"Adding piston cr to fit matrix\n"</span>);
<a name="l01170"></a>01170     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01171"></a>01171         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01172"></a>01172         <span class="keywordtype">double</span> *p=recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+(inw+idm)*nloc;
<a name="l01173"></a>01173         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l01174"></a>01174         p[iloc]=scl;
<a name="l01175"></a>01175         }
<a name="l01176"></a>01176     }
<a name="l01177"></a>01177     inw+=ndm;
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179     <span class="keywordflow">if</span>(lrt_tt){
<a name="l01180"></a>01180     <span class="keywordtype">double</span> factor=0;
<a name="l01181"></a>01181     <span class="keywordflow">if</span>(lrt_tt==1){
<a name="l01182"></a>01182         info(<span class="stringliteral">"Adding TT cr on upper DMs to fit matrix.\n"</span>);
<a name="l01183"></a>01183         factor=scl*2./parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>;
<a name="l01184"></a>01184         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=1; idm&lt;ndm; idm++){
<a name="l01185"></a>01185         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01186"></a>01186         <span class="keywordtype">double</span> *p=recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+(inw+(idm-1)*2)*nloc;
<a name="l01187"></a>01187         <span class="keywordtype">double</span> *p2x=p;
<a name="l01188"></a>01188         <span class="keywordtype">double</span> *p2y=p+nloc;
<a name="l01189"></a>01189         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l01190"></a>01190             p2x[iloc]=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[iloc]*factor;<span class="comment">//x tilt</span>
<a name="l01191"></a>01191             p2y[iloc]=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[iloc]*factor;<span class="comment">//y tilt</span>
<a name="l01192"></a>01192         }
<a name="l01193"></a>01193         }
<a name="l01194"></a>01194     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(lrt_tt==2){<span class="comment">//Canceling TT. only valid for 2 DMs</span>
<a name="l01195"></a>01195         warning(<span class="stringliteral">"Adding Canceling TT cr to fit matrix. Deprecated\n"</span>);
<a name="l01196"></a>01196         <span class="keywordflow">if</span>(ndm!=2){
<a name="l01197"></a>01197         error(<span class="stringliteral">"Only ndm=2 case is implemented\n"</span>);
<a name="l01198"></a>01198         }
<a name="l01199"></a>01199         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01200"></a>01200         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01201"></a>01201         <span class="keywordtype">double</span> *p=recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+inw*nloc;
<a name="l01202"></a>01202         <span class="keywordflow">if</span>(idm==0) factor=scl*2/parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>;
<a name="l01203"></a>01203         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(idm==1) factor=-scl*2./parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>;
<a name="l01204"></a>01204         <span class="keywordtype">double</span> *p2x=p;
<a name="l01205"></a>01205         <span class="keywordtype">double</span> *p2y=p+nloc;
<a name="l01206"></a>01206         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l01207"></a>01207             p2x[iloc]=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[iloc]*factor;<span class="comment">//x tilt</span>
<a name="l01208"></a>01208             p2y[iloc]=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[iloc]*factor;<span class="comment">//y tilt</span>
<a name="l01209"></a>01209         }
<a name="l01210"></a>01210         }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212     }
<a name="l01213"></a>01213     inw+=2*(ndm-1);
<a name="l01214"></a>01214     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01215"></a>01215         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>,<span class="stringliteral">"%s/NW.bin.gz"</span>,dirsetup);
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218   
<a name="l01219"></a>01219     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01220"></a>01220     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>,<span class="stringliteral">"%s/NW.bin.gz"</span>,dirsetup);
<a name="l01221"></a>01221     }
<a name="l01222"></a>01222 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b4a4784b2c4fff59fcdcdb3163fb1aea"></a><!-- doxytag: member="setup_recon.c::free_recon_moao" ref="b4a4784b2c4fff59fcdcdb3163fb1aea" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void free_recon_moao           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Free <a class="el" href="structMOAO__T.html" title="contains MOAO related data">MOAO_T</a>. 
<p>
<div class="fragment"><pre class="fragment"><a name="l01226"></a>01226                                                                  {
<a name="l01227"></a>01227     <span class="keywordflow">if</span>(!recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>) <span class="keywordflow">return</span>;
<a name="l01228"></a>01228     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imoao=0; imoao&lt;parms-&gt;<a class="code" href="structPARMS__T.html#477936fb54c33badc9ec9bf34db0e17f" title="Number of different MOAO type.">nmoao</a>; imoao++){
<a name="l01229"></a>01229     <span class="keywordflow">if</span>(!recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#b3d36bbbba309ffb9e21b61f75e1ed34">used</a>) <span class="keywordflow">continue</span>;
<a name="l01230"></a>01230     locfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>);
<a name="l01231"></a>01231     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>);
<a name="l01232"></a>01232     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>);
<a name="l01233"></a>01233     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#160a87d30e1b9b6532241adc70f7f3c3">actslave</a>);
<a name="l01234"></a>01234     spfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#5514e32cd4b953c45006a49ff429254c">W0</a>);
<a name="l01235"></a>01235     dfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#cc34b6bf2dc67f5346fe6d040bc699b0">W1</a>);
<a name="l01236"></a>01236     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#0df80d46c7bf95f1d200de75f76e98d7">HAW</a>);
<a name="l01237"></a>01237     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#53b1dde5cadc44c3523c4fcd76ebbc51">HAS</a>);
<a name="l01238"></a>01238     }
<a name="l01239"></a>01239 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3a5b99570039882f39e51b69236b1a0e"></a><!-- doxytag: member="setup_recon.c::setup_recon_moao" ref="3a5b99570039882f39e51b69236b1a0e" args="(RECON_T *recon, const PARMS_T *parms, const POWFS_T *powfs, const APER_T *aper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_moao           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Prepare the propagation H matrix for MOAO and compute the reconstructor. 
<p>
We only need a reconstructor for every different MOAO type. <div class="fragment"><pre class="fragment"><a name="l01244"></a>01244                                                           {
<a name="l01245"></a>01245     
<a name="l01246"></a>01246     <span class="keyword">const</span> <span class="keywordtype">int</span> nmoao=parms-&gt;<a class="code" href="structPARMS__T.html#477936fb54c33badc9ec9bf34db0e17f" title="Number of different MOAO type.">nmoao</a>;
<a name="l01247"></a>01247     <span class="keywordtype">int</span> used[parms-&gt;<a class="code" href="structPARMS__T.html#477936fb54c33badc9ec9bf34db0e17f" title="Number of different MOAO type.">nmoao</a>];
<a name="l01248"></a>01248     memset(used,0,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*nmoao);
<a name="l01249"></a>01249     
<a name="l01250"></a>01250     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l01251"></a>01251     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#5b96a7a535d6e320913d8821a41a8423" title="index into MOAO struct.">moao</a>&gt;-1){
<a name="l01252"></a>01252         <span class="keywordtype">int</span> imoao=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#5b96a7a535d6e320913d8821a41a8423" title="index into MOAO struct.">moao</a>;
<a name="l01253"></a>01253         <span class="keywordflow">if</span>(imoao&lt;parms-&gt;nmoao){
<a name="l01254"></a>01254         used[imoao]++;
<a name="l01255"></a>01255         }<span class="keywordflow">else</span>{
<a name="l01256"></a>01256         error(<span class="stringliteral">"powfs[%d].moao=%d is inused\n"</span>, ipowfs, imoao);
<a name="l01257"></a>01257         }
<a name="l01258"></a>01258     }
<a name="l01259"></a>01259     }
<a name="l01260"></a>01260     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#529a8acf247028c9e66cbe87c6edd84e" title="index into MOAO struct.">moao</a>&gt;-1){
<a name="l01261"></a>01261     <span class="keywordtype">int</span> imoao=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#529a8acf247028c9e66cbe87c6edd84e" title="index into MOAO struct.">moao</a>;
<a name="l01262"></a>01262     <span class="keywordflow">if</span>(imoao&lt;parms-&gt;nmoao){
<a name="l01263"></a>01263         used[imoao]++;
<a name="l01264"></a>01264     }<span class="keywordflow">else</span>{
<a name="l01265"></a>01265         error(<span class="stringliteral">"evl.moao=%d is inused\n"</span>,imoao);
<a name="l01266"></a>01266     }
<a name="l01267"></a>01267     }
<a name="l01268"></a>01268     <span class="keywordtype">int</span> nused=0;
<a name="l01269"></a>01269     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imoao=0; imoao&lt;nmoao; imoao++){
<a name="l01270"></a>01270     <span class="keywordflow">if</span>(used[imoao]){
<a name="l01271"></a>01271         nused++;
<a name="l01272"></a>01272     }
<a name="l01273"></a>01273     }
<a name="l01274"></a>01274     <span class="keywordflow">if</span>(nused==0) <span class="keywordflow">return</span>;<span class="comment">//nothing need to be done.</span>
<a name="l01275"></a>01275     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>){
<a name="l01276"></a>01276     <a class="code" href="setup__recon_8c.html#b4a4784b2c4fff59fcdcdb3163fb1aea" title="Free MOAO_T.">free_recon_moao</a>(recon, parms);
<a name="l01277"></a>01277     }
<a name="l01278"></a>01278     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>=calloc(nmoao, <span class="keyword">sizeof</span>(<a class="code" href="structMOAO__T.html" title="contains MOAO related data">MOAO_T</a>));
<a name="l01279"></a>01279     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imoao=0; imoao&lt;nmoao; imoao++){
<a name="l01280"></a>01280     <span class="keywordflow">if</span>(!used[imoao]) <span class="keywordflow">continue</span>;
<a name="l01281"></a>01281     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#b3d36bbbba309ffb9e21b61f75e1ed34">used</a>=1;
<a name="l01282"></a>01282     <span class="keywordtype">int</span> order=parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#d48b40cc8fa331e50d718f6ac50a2de3" title="Order of this MOAO.">order</a>;
<a name="l01283"></a>01283     <span class="keywordflow">if</span>(order==0){
<a name="l01284"></a>01284         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>&gt;0){
<a name="l01285"></a>01285         order=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[0].<a class="code" href="structDM__CFG__T.html#d51c7bdc88ea34b8b9b7577186f689de" title="Order of the DM within telescope clear subaperture.">order</a>;<span class="comment">//inherits.</span>
<a name="l01286"></a>01286         }<span class="keywordflow">else</span>{
<a name="l01287"></a>01287         error(<span class="stringliteral">"Please specify the order of the moao DM\n"</span>);
<a name="l01288"></a>01288         }
<a name="l01289"></a>01289     }
<a name="l01290"></a>01290     <span class="keywordtype">double</span> dxr=parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/order;
<a name="l01291"></a>01291     <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> *map=<a class="code" href="maos_2utils_8c.html#aba5a9d494e2fc4ef56edd11248b41e9" title="Calls create_metapupil is simplified interface by returning a MAP_T object.">create_metapupil_wrap</a>(parms,0,dxr,0,0,0,T_ALOC,0,parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#20b8cd5e2ec73f4eb4bff84f70f06bf4" title="using square grid on DM and ploc.">square</a>);
<a name="l01292"></a>01292     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>=<a class="code" href="loc_8c.html#65eae1500aa879b31c5a7962ad9191c5" title="convert a sqmap to a loc object.">sqmap2loc</a>(map);
<a name="l01293"></a>01293     sqmapfree(map);
<a name="l01294"></a>01294     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(1,1);
<a name="l01295"></a>01295     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#6ccaefa7d6eb62c0bd011e9c79f7cfef" title="Whether use cubic influence function.">cubic</a>){
<a name="l01296"></a>01296         recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[0]=<a class="code" href="mkh_8c.html#1a5857040746e6edea04ad2e9a80c140" title="Create ray tracing operator from coordinate locin to locout using cubic influence...">mkh_cubic</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, 
<a name="l01297"></a>01297                         NULL, 0, 0, 1, parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#f52f25ca1fec25148e7163d40d059691" title="Inter-actuator-coupling for cubic influence function.">iac</a>, 1);
<a name="l01298"></a>01298     }<span class="keywordflow">else</span>{
<a name="l01299"></a>01299         recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[0]=<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, 
<a name="l01300"></a>01300                       NULL, 0, 0, 1, 0); 
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#7a4a0f72cab64d5066a6a1e4fe10a51e" title="Piston/tip/tilt constraint.">lrt_ptt</a>){
<a name="l01303"></a>01303         recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>=dcellnew(1,1);
<a name="l01304"></a>01304         <span class="keywordtype">long</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01305"></a>01305         recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,3);
<a name="l01306"></a>01306         PDMAT(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0], pNW);
<a name="l01307"></a>01307         <span class="keywordtype">double</span> scl=1./nloc;
<a name="l01308"></a>01308         <span class="keywordtype">double</span> scl2=scl*2./parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>;
<a name="l01309"></a>01309         <span class="keyword">const</span> <span class="keywordtype">double</span> *locx=recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l01310"></a>01310         <span class="keyword">const</span> <span class="keywordtype">double</span> *locy=recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l01311"></a>01311         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l01312"></a>01312         <span class="comment">//We don't want piston/tip/tilt on the mems.</span>
<a name="l01313"></a>01313         pNW[0][iloc]=scl;<span class="comment">//piston;</span>
<a name="l01314"></a>01314         pNW[1][iloc]=scl2*locx[iloc];<span class="comment">//tip</span>
<a name="l01315"></a>01315         pNW[2][iloc]=scl2*locy[iloc];<span class="comment">//tilt</span>
<a name="l01316"></a>01316         }
<a name="l01317"></a>01317     }
<a name="l01318"></a>01318     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#5514e32cd4b953c45006a49ff429254c">W0</a>=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>);
<a name="l01319"></a>01319     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#cc34b6bf2dc67f5346fe6d040bc699b0">W1</a>=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>);
<a name="l01320"></a>01320     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#ba8ac60ba9a8b4791e088820716f8cdf" title="Do we do actuator slaving.">actslave</a>){
<a name="l01321"></a>01321         recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#160a87d30e1b9b6532241adc70f7f3c3">actslave</a>=<a class="code" href="recon__utils_8c.html#9a7179685cb86edbe6f89371ab9034f4" title="Compute slaving actuator regularization.">act_slaving</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, 
<a name="l01322"></a>01322                             recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>, 
<a name="l01323"></a>01323                             recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#cc34b6bf2dc67f5346fe6d040bc699b0">W1</a>,
<a name="l01324"></a>01324                             recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>);
<a name="l01325"></a>01325     }
<a name="l01326"></a>01326     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01327"></a>01327         locwrite(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>,<span class="stringliteral">"%s/moao%d_aloc"</span>,dirsetup,imoao);
<a name="l01328"></a>01328         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>, <span class="stringliteral">"%s/moao%d_HA"</span>,dirsetup,imoao);
<a name="l01329"></a>01329         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>, <span class="stringliteral">"%s/moao%d_NW"</span>,dirsetup,imoao);
<a name="l01330"></a>01330         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#160a87d30e1b9b6532241adc70f7f3c3">actslave</a>, <span class="stringliteral">"%s/moao%d_actslave"</span>,dirsetup,imoao);
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#2208400c2f1150a63417cd38f3e01f53" title="Plot various information in setup process.">setup</a>){
<a name="l01333"></a>01333         <a class="code" href="maos_2utils_8c.html#ed87a0850d278bb80fe6906e7a8fa6f6" title="Plot the projection of all the different FoVs on a certain grid.">plotloc</a>(<span class="stringliteral">"FoV"</span>,parms,recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>,0,<span class="stringliteral">"moao_aloc"</span>);
<a name="l01334"></a>01334     }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336     <span class="comment">//Create HAS,HAW, for science and wavefront sensor.</span>
<a name="l01337"></a>01337     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#53b1dde5cadc44c3523c4fcd76ebbc51">HAS</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(1,1);
<a name="l01338"></a>01338     recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#0df80d46c7bf95f1d200de75f76e98d7">HAW</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>,1);
<a name="l01339"></a>01339     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l01340"></a>01340         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#5b96a7a535d6e320913d8821a41a8423" title="index into MOAO struct.">moao</a> == imoao){
<a name="l01341"></a>01341         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#6ccaefa7d6eb62c0bd011e9c79f7cfef" title="Whether use cubic influence function.">cubic</a>){
<a name="l01342"></a>01342             recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#0df80d46c7bf95f1d200de75f76e98d7">HAW</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs]
<a name="l01343"></a>01343             =<a class="code" href="mkh_8c.html#1a5857040746e6edea04ad2e9a80c140" title="Create ray tracing operator from coordinate locin to locout using cubic influence...">mkh_cubic</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>, 
<a name="l01344"></a>01344                    powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>, 0, 0, 1, parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#f52f25ca1fec25148e7163d40d059691" title="Inter-actuator-coupling for cubic influence function.">iac</a>, 1);
<a name="l01345"></a>01345         }<span class="keywordflow">else</span>{
<a name="l01346"></a>01346             recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#0df80d46c7bf95f1d200de75f76e98d7">HAW</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ipowfs]
<a name="l01347"></a>01347             =<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>, 
<a name="l01348"></a>01348                  powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>, 0, 0, 1, 0); 
<a name="l01349"></a>01349         }
<a name="l01350"></a>01350         }
<a name="l01351"></a>01351     }
<a name="l01352"></a>01352     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#529a8acf247028c9e66cbe87c6edd84e" title="index into MOAO struct.">moao</a>==imoao){
<a name="l01353"></a>01353         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#6ccaefa7d6eb62c0bd011e9c79f7cfef" title="Whether use cubic influence function.">cubic</a>){
<a name="l01354"></a>01354         recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#53b1dde5cadc44c3523c4fcd76ebbc51">HAS</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[0]
<a name="l01355"></a>01355             =<a class="code" href="mkh_8c.html#1a5857040746e6edea04ad2e9a80c140" title="Create ray tracing operator from coordinate locin to locout using cubic influence...">mkh_cubic</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>, aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>, 
<a name="l01356"></a>01356                    0, 0, 1, parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#f52f25ca1fec25148e7163d40d059691" title="Inter-actuator-coupling for cubic influence function.">iac</a>, 1);
<a name="l01357"></a>01357         }<span class="keywordflow">else</span>{
<a name="l01358"></a>01358         recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#53b1dde5cadc44c3523c4fcd76ebbc51">HAS</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[0]
<a name="l01359"></a>01359             =<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>, aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,
<a name="l01360"></a>01360              0, 0, 1, 0); 
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363     }<span class="comment">//imoao</span>
<a name="l01364"></a>01364 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f7a8a7478b06b8b4f0d27784819f41c2"></a><!-- doxytag: member="setup_recon.c::setup_recon_fit_matrix" ref="f7a8a7478b06b8b4f0d27784819f41c2" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_fit_matrix           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Assemble the DM fitting matrix. 
<p>
The fitting is done by minimizing <img class="formulaInl" alt="$||H_X x - H_A a||^2_W$" src="form_38.png"> where <img class="formulaInl" alt="$H_X, H_A$" src="form_39.png"> are ray tracing operator from tomography grid xloc, and deformable mirror grid aloc to pupil grid ploc. The norm is weighted using bilinear influence functions within the telescope aperture. We have<p>
<img class="formulaInl" alt="$a=\left[H_A^T(W_0-W_1 W_1^T)H_A\right]^{-1} H_A^T (W_0-W_1) H_X x$" src="form_40.png"><p>
For details see <a href="http://www.opticsinfobase.org/abstract.cfm?URI=josaa-19-9-1803">http://www.opticsinfobase.org/abstract.cfm?URI=josaa-19-9-1803</a> <div class="fragment"><pre class="fragment"><a name="l01378"></a>01378                                                             {
<a name="l01379"></a>01379     <span class="keyword">const</span> <span class="keywordtype">int</span> nfit=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>;
<a name="l01380"></a>01380     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l01381"></a>01381     <span class="keywordflow">if</span>(ndm==0) <span class="keywordflow">return</span>;
<a name="l01382"></a>01382     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *HATc=<a class="code" href="dsp_8h.html#a4691afd2563e44ec261422a3648ff01" title="Transpose a sparse cell.">spcelltrans</a>(recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>);
<a name="l01383"></a>01383     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*HAT)[ndm]=(<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*)[ndm])HATc-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l01384"></a>01384     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*HX)[nfit]=(<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*)[nfit])recon-&gt;<a class="code" href="structRECON__T.html#41a461a54e2753a1714894878cc63f94">HX</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l01385"></a>01385     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*HA)[nfit]=(<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*)[nfit])recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l01386"></a>01386     info2(<span class="stringliteral">"Before assembling fit matrix:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l01387"></a>01387     <span class="comment">//Assemble Fit matrix.</span>
<a name="l01388"></a>01388     <span class="keywordtype">int</span> npsr=recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>;
<a name="l01389"></a>01389     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#df26dbe4454ff3de00641dbf5022b601" title="if 1, load fit matrix">fit</a>){
<a name="l01390"></a>01390     <span class="keywordflow">if</span>(!(exist(<span class="stringliteral">"FRM.bin.gz"</span>) &amp;&amp; 
<a name="l01391"></a>01391          exist(<span class="stringliteral">"FRU.bin.gz"</span>) &amp;&amp; exist(<span class="stringliteral">"FRV.bin.gz"</span>))){
<a name="l01392"></a>01392         error(<span class="stringliteral">"FRM, FRU, FRV (.bin.gz) not all exist\n"</span>);
<a name="l01393"></a>01393     }
<a name="l01394"></a>01394     warning(<span class="stringliteral">"Loading saved recon-&gt;FR\n"</span>);
<a name="l01395"></a>01395     recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"FRM.bin.gz"</span>);
<a name="l01396"></a>01396     recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"FRU.bin.gz"</span>);
<a name="l01397"></a>01397     recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"FRV.bin.gz"</span>);
<a name="l01398"></a>01398     }<span class="keywordflow">else</span>{
<a name="l01399"></a>01399     info(<span class="stringliteral">"Building recon-&gt;FR\n"</span>);
<a name="l01400"></a>01400     recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(ndm, npsr);
<a name="l01401"></a>01401     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*FRM)[ndm]=(<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*)[ndm])recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l01402"></a>01402 
<a name="l01403"></a>01403     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l01404"></a>01404         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ifit=0; ifit&lt;nfit; ifit++){
<a name="l01405"></a>01405         <span class="keywordflow">if</span>(fabs(recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l01406"></a>01406         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *tmp=<a class="code" href="dsp_8h.html#ccfcfe9fff4e25824ae3ad516f01b864" title="Multiply two sparse arrays: return A*B.">spmulsp</a>(recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>, HX[ips][ifit]);
<a name="l01407"></a>01407         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01408"></a>01408             <a class="code" href="dsp_8h.html#79439ae66ccac26a63d90b0937aa89a6" title="Multiply two sparse arrays and add to the third: C0=C0+A*B*scale.">spmulsp2</a>(&amp;FRM[ips][idm],HAT[ifit][idm], tmp, 
<a name="l01409"></a>01409                  recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit]);
<a name="l01410"></a>01410         }
<a name="l01411"></a>01411         spfree(tmp);
<a name="l01412"></a>01412         }
<a name="l01413"></a>01413     }
<a name="l01414"></a>01414     recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>=dcellnew(ndm, 1);
<a name="l01415"></a>01415     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **FRU=recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=dcellnew(npsr, 1);
<a name="l01418"></a>01418     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **FRV=recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;  
<a name="l01419"></a>01419     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){    
<a name="l01420"></a>01420         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01421"></a>01421         FRU[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc, nfit);
<a name="l01422"></a>01422         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ifit=0; ifit&lt;nfit; ifit++){
<a name="l01423"></a>01423         <span class="comment">//notice the sart.</span>
<a name="l01424"></a>01424         <span class="keywordflow">if</span>(fabs(recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l01425"></a>01425         <a class="code" href="dsp_8h.html#64f8516410a0672044fea7cc929eac7d" title="Multiply transpose of a sparse matrix with a vector.">sptmulvec</a>(FRU[idm]-&gt;p+ifit*nloc, 
<a name="l01426"></a>01426               HA[idm][ifit], recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l01427"></a>01427               sqrt(recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit]));
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429     }
<a name="l01430"></a>01430     
<a name="l01431"></a>01431     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;npsr; ips++){
<a name="l01432"></a>01432         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01433"></a>01433         FRV[ips]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,nfit);
<a name="l01434"></a>01434         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ifit=0; ifit&lt;nfit; ifit++){
<a name="l01435"></a>01435         <span class="comment">//notice the sart.</span>
<a name="l01436"></a>01436         <span class="keywordflow">if</span>(fabs(recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l01437"></a>01437         <a class="code" href="dsp_8h.html#64f8516410a0672044fea7cc929eac7d" title="Multiply transpose of a sparse matrix with a vector.">sptmulvec</a>(FRV[ips]-&gt;p+ifit*nloc, 
<a name="l01438"></a>01438               HX[ips][ifit], recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 
<a name="l01439"></a>01439               sqrt(recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit]));
<a name="l01440"></a>01440         }
<a name="l01441"></a>01441     }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443     
<a name="l01444"></a>01444     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#487426d82238f2159c7d6e9ec0b58ad3" title="save reconstructor information.">recon</a>){
<a name="l01445"></a>01445         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,<span class="stringliteral">"%s/FRM.bin.gz"</span>,dirsetup);
<a name="l01446"></a>01446         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,<span class="stringliteral">"%s/FRU.bin.gz"</span>,dirsetup);
<a name="l01447"></a>01447         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>,<span class="stringliteral">"%s/FRV.bin.gz"</span>,dirsetup);
<a name="l01448"></a>01448     }
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451     <span class="comment">//Compute the proper strength of the low rand terms in FLM</span>
<a name="l01452"></a>01452     recon-&gt;<a class="code" href="structRECON__T.html#84e975597a9d0042544267fc77a39f7e">fitscl</a>=0;
<a name="l01453"></a>01453     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a> &amp;&amp; recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>){
<a name="l01454"></a>01454     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **FRU=recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;
<a name="l01455"></a>01455     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01456"></a>01456         <span class="comment">//follow loas convention.</span>
<a name="l01457"></a>01457         <span class="keywordtype">double</span> scl0=<a class="code" href="mathmisc_8c.html#ac7d23a6f61a359934d93f1fbdc570ea" title="compute the maximum of the abs of double vector">maxabs</a>(FRU[idm]-&gt;p,FRU[idm]-&gt;nx*FRU[idm]-&gt;ny);
<a name="l01458"></a>01458         <span class="keywordflow">if</span>(scl0&gt;recon-&gt;<a class="code" href="structRECON__T.html#84e975597a9d0042544267fc77a39f7e">fitscl</a>) recon-&gt;<a class="code" href="structRECON__T.html#84e975597a9d0042544267fc77a39f7e">fitscl</a>=scl0;
<a name="l01459"></a>01459     }
<a name="l01460"></a>01460     }<span class="keywordflow">else</span>{
<a name="l01461"></a>01461     recon-&gt;<a class="code" href="structRECON__T.html#84e975597a9d0042544267fc77a39f7e">fitscl</a>=1./recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;<span class="comment">//scale the constraints. Important!!</span>
<a name="l01462"></a>01462     }
<a name="l01463"></a>01463     <span class="comment">//info("recon-&gt;fitscl=%g\n", recon-&gt;fitscl);</span>
<a name="l01464"></a>01464     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#df26dbe4454ff3de00641dbf5022b601" title="if 1, load fit matrix">fit</a>){
<a name="l01465"></a>01465     <span class="keywordflow">if</span>(!(exist(<span class="stringliteral">"FLM.bin.gz"</span>) &amp;&amp; 
<a name="l01466"></a>01466          exist(<span class="stringliteral">"FLU.bin.gz"</span>) &amp;&amp; exist(<span class="stringliteral">"FLV.bin.gz"</span>))){
<a name="l01467"></a>01467         error(<span class="stringliteral">"FLM, FLU, FLV (.bin.gz) not all exist\n"</span>);
<a name="l01468"></a>01468     }
<a name="l01469"></a>01469     warning(<span class="stringliteral">"Loading saved recon-&gt;FL\n"</span>);
<a name="l01470"></a>01470     recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dmat_8h.html#dda41e6426ecac836fa3dd576f0d2bd9" title="User callable function to read cell array of sparse matrix from file.">spcellread</a>(<span class="stringliteral">"FLM.bin.gz"</span>);
<a name="l01471"></a>01471     recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"FLU.bin.gz"</span>);
<a name="l01472"></a>01472     recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"FLV.bin.gz"</span>);
<a name="l01473"></a>01473     }<span class="keywordflow">else</span>{
<a name="l01474"></a>01474     <span class="comment">//Depends on FRU; Don't move forward</span>
<a name="l01475"></a>01475     <a class="code" href="setup__recon_8c.html#630c6d5a66160c402a727df359300f20" title="Setup fitting low rank terms that are in the NULL space of DM fitting operator.">fit_prep_lrt</a>(recon,parms);
<a name="l01476"></a>01476     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#a1fa2b2183ae0d824e4473be934cad14" title="slaving constraint for non-active actuators.">actslave</a>){
<a name="l01477"></a>01477         recon-&gt;<a class="code" href="structRECON__T.html#c10de3f0cd264b530013ae0f61c6e983">actslave</a>=<a class="code" href="recon__utils_8c.html#9a7179685cb86edbe6f89371ab9034f4" title="Compute slaving actuator regularization.">act_slaving</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>, recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>, recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>, recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>);
<a name="l01478"></a>01478         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01479"></a>01479         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#c10de3f0cd264b530013ae0f61c6e983">actslave</a>,<span class="stringliteral">"%s/actslave.bin.gz"</span>,dirsetup);
<a name="l01480"></a>01480         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>,<span class="stringliteral">"%s/NW2.bin.gz"</span>,dirsetup);
<a name="l01481"></a>01481         }
<a name="l01482"></a>01482     }
<a name="l01483"></a>01483     info(<span class="stringliteral">"Building recon-&gt;FL\n"</span>);
<a name="l01484"></a>01484     recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(ndm, ndm);
<a name="l01485"></a>01485     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*FLM)[ndm]=(<a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*)[ndm])recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l01486"></a>01486     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01487"></a>01487         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ifit=0; ifit&lt;nfit; ifit++){
<a name="l01488"></a>01488         <span class="keywordflow">if</span>(fabs(recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l01489"></a>01489         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *tmp=<a class="code" href="dsp_8h.html#ccfcfe9fff4e25824ae3ad516f01b864" title="Multiply two sparse arrays: return A*B.">spmulsp</a>(recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>, HA[idm][ifit]);
<a name="l01490"></a>01490         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jdm=0; jdm&lt;ndm; jdm++){
<a name="l01491"></a>01491             <a class="code" href="dsp_8h.html#79439ae66ccac26a63d90b0937aa89a6" title="Multiply two sparse arrays and add to the third: C0=C0+A*B*scale.">spmulsp2</a>(&amp;FLM[idm][jdm],HAT[ifit][jdm], tmp,
<a name="l01492"></a>01492                  recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ifit]);
<a name="l01493"></a>01493         }
<a name="l01494"></a>01494         spfree(tmp);
<a name="l01495"></a>01495         }
<a name="l01496"></a>01496     }
<a name="l01497"></a>01497     spcellfree(HATc);
<a name="l01498"></a>01498     <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#590601137022daed01328fbaf225e064" title="tikhonov regularization">tik_cstr</a>)&gt;1.e-200){
<a name="l01499"></a>01499         <span class="keywordtype">double</span> tikcr=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#590601137022daed01328fbaf225e064" title="tikhonov regularization">tik_cstr</a>;
<a name="l01500"></a>01500         <span class="keywordflow">if</span>(fabs(tikcr)&lt;1.e-14){
<a name="l01501"></a>01501         warning(<span class="stringliteral">"tickcr=%g is too small\n"</span>,tikcr);
<a name="l01502"></a>01502         }
<a name="l01503"></a>01503         <a class="code" href="eigs_8c.html#45367708d512ccf95ac48292c25419f8" title="Apply tikhonov regulation with threshold of thres*max(eig(A)).">spcelltikcr</a>(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,tikcr);
<a name="l01504"></a>01504     }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506     recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>=dcellnew(ndm, 1);
<a name="l01507"></a>01507     recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>=dcellnew(ndm, 1);
<a name="l01508"></a>01508     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **FLU=recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;
<a name="l01509"></a>01509     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **FLV=recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;
<a name="l01510"></a>01510     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **FRU=recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;
<a name="l01511"></a>01511     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l01512"></a>01512         <span class="keywordtype">int</span> nloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l01513"></a>01513         <span class="keywordtype">int</span> nnw=0;
<a name="l01514"></a>01514         <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]){
<a name="l01515"></a>01515         nnw=recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>;
<a name="l01516"></a>01516         }
<a name="l01517"></a>01517         FLU[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,nfit+nnw);
<a name="l01518"></a>01518         FLV[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,nfit+nnw);
<a name="l01519"></a>01519         memcpy(FLU[idm]-&gt;p, FRU[idm]-&gt;p,
<a name="l01520"></a>01520            nloc*nfit*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01521"></a>01521         memcpy(FLV[idm]-&gt;p, FRU[idm]-&gt;p, 
<a name="l01522"></a>01522            nloc*nfit*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01523"></a>01523         
<a name="l01524"></a>01524         <span class="comment">//null modes</span>
<a name="l01525"></a>01525         <span class="keywordflow">if</span>(nnw&gt;0){
<a name="l01526"></a>01526         memcpy(FLU[idm]-&gt;p+nfit*nloc, 
<a name="l01527"></a>01527                recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 
<a name="l01528"></a>01528                nnw*nloc*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01529"></a>01529         <span class="keywordtype">double</span> *restrict p2=FLU[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nfit*nloc;
<a name="l01530"></a>01530         <span class="keywordtype">double</span> *restrict p=FLV[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nfit*nloc;
<a name="l01531"></a>01531         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nnw*nloc; i++){
<a name="l01532"></a>01532             p[i]=-p2[i];
<a name="l01533"></a>01533         }
<a name="l01534"></a>01534         }
<a name="l01535"></a>01535     }
<a name="l01536"></a>01536     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#c10de3f0cd264b530013ae0f61c6e983">actslave</a>){
<a name="l01537"></a>01537         <a class="code" href="dsp_8h.html#50a4c44bf6e5fdbc087a94fa815ed94a" title="Add a sparse cell to another: A0=A0+B.">spcelladd</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>, recon-&gt;<a class="code" href="structRECON__T.html#c10de3f0cd264b530013ae0f61c6e983">actslave</a>);
<a name="l01538"></a>01538     }
<a name="l01539"></a>01539     <span class="comment">//spcellsym(recon-&gt;FL.M);</span>
<a name="l01540"></a>01540     info(<span class="stringliteral">"DM Fit # of Low rank terms: %ld in RHS, %ld in LHS\n"</span>,
<a name="l01541"></a>01541          FRU[0]-&gt;ny, FLU[0]-&gt;ny);
<a name="l01542"></a>01542     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#487426d82238f2159c7d6e9ec0b58ad3" title="save reconstructor information.">recon</a>){
<a name="l01543"></a>01543         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>,<span class="stringliteral">"%s/FLM.bin.gz"</span>,dirsetup);
<a name="l01544"></a>01544         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>,<span class="stringliteral">"%s/FLU.bin.gz"</span>,dirsetup);
<a name="l01545"></a>01545         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>,<span class="stringliteral">"%s/FLV.bin.gz"</span>,dirsetup);
<a name="l01546"></a>01546     }
<a name="l01547"></a>01547     }
<a name="l01548"></a>01548     info2(<span class="stringliteral">"After assemble matrix:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l01549"></a>01549     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#816490fc8c78b35c2fcd85934d7972bb" title="Fitting algorithm to solve the linear equation.">alg</a>==0  || (parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==2 &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#af8875582b897aa7687b202b15b2f814" title="load MVST mvst_U and mvst_FU.">mvst</a>)){
<a name="l01550"></a>01550     <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#590601137022daed01328fbaf225e064" title="tikhonov regularization">tik_cstr</a>)&lt;1.e-14){
<a name="l01551"></a>01551         warning(<span class="stringliteral">"tickcr=%g is too small or not applied\n"</span>, 
<a name="l01552"></a>01552             parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#590601137022daed01328fbaf225e064" title="tikhonov regularization">tik_cstr</a>);
<a name="l01553"></a>01553     }
<a name="l01554"></a>01554     <a class="code" href="muv_8c.html#0259762671f4caf31653363fe2483c5c" title="Cholesky factorization on the sparse matrix and its low rank terms.">muv_chol_prep</a>(&amp;(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>));
<a name="l01555"></a>01555     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#487426d82238f2159c7d6e9ec0b58ad3" title="save reconstructor information.">recon</a>){
<a name="l01556"></a>01556         <a class="code" href="chol_8c.html#3ff611672c83dc9ccf8f53ca9e299e71" title="Save cholesky factor: the lower left side and permutation vector.">chol_save</a>(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#94e4b5e2b57d787f3467a9f1c81354fb">C</a>,<span class="stringliteral">"%s/FLC"</span>,dirsetup);
<a name="l01557"></a>01557     }
<a name="l01558"></a>01558     info2(<span class="stringliteral">"After cholesky on matrix:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l01559"></a>01559     }
<a name="l01560"></a>01560     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#816490fc8c78b35c2fcd85934d7972bb" title="Fitting algorithm to solve the linear equation.">alg</a>==0){
<a name="l01561"></a>01561     info(<span class="stringliteral">"Freeing FL.M,U,V\n"</span>);
<a name="l01562"></a>01562     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#573a633efd57964aef3250a0d014f227" title="block sparse matrix">M</a>);
<a name="l01563"></a>01563     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#40294a9e5e8cd011fc71cdeda57837ec" title="low rank terms U">U</a>);
<a name="l01564"></a>01564     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>.<a class="code" href="structMUV__T.html#fa9644721152188dc815327f091610c0" title="low rank terms V">V</a>);
<a name="l01565"></a>01565     }
<a name="l01566"></a>01566 
<a name="l01567"></a>01567     info2(<span class="stringliteral">"At exit :\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l01568"></a>01568 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="4f4abf13c9b0972de67fab348bb9f470"></a><!-- doxytag: member="setup_recon.c::setup_recon_focus" ref="4f4abf13c9b0972de67fab348bb9f470" args="(RECON_T *recon, POWFS_T *powfs, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_focus           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Create the reconstructor to reconstruct the residual focus error due to LGS sodium tracking error. 
<p>
Need to average out the focus error caused by atmosphere when applying (a low pass filter is applied to the output). <div class="fragment"><pre class="fragment"><a name="l01575"></a>01575                                {
<a name="l01576"></a>01576     <span class="keywordtype">int</span> ilgs=-1;
<a name="l01577"></a>01577     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l01578"></a>01578     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l01579"></a>01579     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>){
<a name="l01580"></a>01580         <span class="keywordflow">if</span>(ilgs==-1){
<a name="l01581"></a>01581         ilgs=ipowfs;
<a name="l01582"></a>01582         }<span class="keywordflow">else</span>{
<a name="l01583"></a>01583         warning(<span class="stringliteral">"There are multiple LGS type\n"</span>);
<a name="l01584"></a>01584         }
<a name="l01585"></a>01585     }
<a name="l01586"></a>01586     }
<a name="l01587"></a>01587     <span class="keywordflow">if</span>(ilgs==-1){
<a name="l01588"></a>01588     warning(<span class="stringliteral">"There are no LGS with llt. \n"</span>);
<a name="l01589"></a>01589     <span class="keywordflow">return</span>;
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591     <span class="comment">//Create Gfocus: Focus mode -&gt; WFS grad</span>
<a name="l01592"></a>01592     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Gfocus=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>, 1);
<a name="l01593"></a>01593     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l01594"></a>01594     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l01595"></a>01595     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *opd=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(powfs[ipowfs].loc-&gt;nloc,1);
<a name="l01596"></a>01596     <a class="code" href="loc_8c.html#1bb7e8a161d93d741c642d7a5b750f13" title="Add val amount of focus to opd.">loc_add_focus</a>(opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>, 1);
<a name="l01597"></a>01597     <span class="keyword">const</span> <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l01598"></a>01598     Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,1);
<a name="l01599"></a>01599     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#7d2eaa30681d91e3267fe953462270c4" title="wfs type if not using physical optics in simulation.">gtype_recon</a>==1){
<a name="l01600"></a>01600         <a class="code" href="loc_8c.html#d445e3b2a45ec41744470c0b57ef44bb" title="Compute zernike best fit for all subapertures.">pts_ztilt</a>(Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>,
<a name="l01601"></a>01601               powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c1a97256a90efbb53166fc1ab5c16a9">imcc</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>, opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>);
<a name="l01602"></a>01602     }<span class="keywordflow">else</span>{
<a name="l01603"></a>01603         <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], powfs[ipowfs].<a class="code" href="structPOWFS__T.html#61ba7e824f0228b45378bbb92efaebe3">GS0</a>, opd, 1);
<a name="l01604"></a>01604     }
<a name="l01605"></a>01605     dfree(opd);
<a name="l01606"></a>01606     }
<a name="l01607"></a>01607     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *GMGngs=NULL;
<a name="l01608"></a>01608     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *GMngs=dcellnew(1, parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>);
<a name="l01609"></a>01609     <span class="comment">/*Compute focus constructor from NGS Grads. fuse grads</span>
<a name="l01610"></a>01610 <span class="comment">      together to construct a single focus measurement*/</span>
<a name="l01611"></a>01611     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l01612"></a>01612     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l01613"></a>01613     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#979789ab45a1f87cf251469dbedebe00" title="tip/tilt removal flag.">trs</a>==0 &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>&gt;1){
<a name="l01614"></a>01614         info(<span class="stringliteral">"wfs %d will be used to track focus\n"</span>, iwfs);
<a name="l01615"></a>01615     }<span class="keywordflow">else</span>{
<a name="l01616"></a>01616         <span class="keywordflow">continue</span>;
<a name="l01617"></a>01617     }
<a name="l01618"></a>01618     <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;GMngs-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>*iwfs], 
<a name="l01619"></a>01619          Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],1);
<a name="l01620"></a>01620     <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;GMGngs,Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], GMngs-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], <span class="stringliteral">"tn"</span>,1);
<a name="l01621"></a>01621     }
<a name="l01622"></a>01622     <a class="code" href="dmat_8h.html#b48bc9b9c8f923e19dafc70b8fff5de2" title="inplace invert a small square SPD matrix using lapack dposv_, usually (A&amp;#39;*w*A)...">dinvspd_inplace</a>(GMGngs);
<a name="l01623"></a>01623     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *RFngs=recon-&gt;<a class="code" href="structRECON__T.html#ab0482d17cd664cfd606c24e5b97d365">RFngs</a>=dcellnew(1, parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>);
<a name="l01624"></a>01624     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l01625"></a>01625     <span class="keywordflow">if</span>(!Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]) <span class="keywordflow">continue</span>;
<a name="l01626"></a>01626     <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;RFngs-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],GMGngs, GMngs-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],<span class="stringliteral">"nt"</span>,1);
<a name="l01627"></a>01627     }
<a name="l01628"></a>01628     dfree(GMGngs);
<a name="l01629"></a>01629     dcellfree(GMngs);
<a name="l01630"></a>01630     <span class="comment">/*</span>
<a name="l01631"></a>01631 <span class="comment">      Compute focus constructor from LGS grads. A</span>
<a name="l01632"></a>01632 <span class="comment">      constructor for each LGS.</span>
<a name="l01633"></a>01633 <span class="comment">     */</span>
<a name="l01634"></a>01634     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *RFlgs=recon-&gt;<a class="code" href="structRECON__T.html#9b8def53514d043f3a8528caad38baf5">RFlgs</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>, 1);
<a name="l01635"></a>01635     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l01636"></a>01636     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l01637"></a>01637     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>)
<a name="l01638"></a>01638         <span class="keywordflow">continue</span>;
<a name="l01639"></a>01639     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *GMtmp=NULL;
<a name="l01640"></a>01640     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *GMGtmp=NULL;
<a name="l01641"></a>01641     <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;GMtmp, recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[iwfs+parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>*iwfs], 
<a name="l01642"></a>01642          Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], 1);
<a name="l01643"></a>01643     <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;GMGtmp, Gfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], GMtmp, <span class="stringliteral">"tn"</span>,1);
<a name="l01644"></a>01644     <a class="code" href="dmat_8h.html#b48bc9b9c8f923e19dafc70b8fff5de2" title="inplace invert a small square SPD matrix using lapack dposv_, usually (A&amp;#39;*w*A)...">dinvspd_inplace</a>(GMGtmp);
<a name="l01645"></a>01645     <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;RFlgs-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], GMGtmp, GMtmp, <span class="stringliteral">"nt"</span>, 1);
<a name="l01646"></a>01646     dfree(GMtmp);
<a name="l01647"></a>01647     dfree(GMGtmp);
<a name="l01648"></a>01648     }
<a name="l01649"></a>01649     <span class="comment">/*{</span>
<a name="l01650"></a>01650 <span class="comment">    //testing</span>
<a name="l01651"></a>01651 <span class="comment">    dcell *focus=dcellnew(1,1);</span>
<a name="l01652"></a>01652 <span class="comment">    focus-&gt;p[0]=dnew(1,1);</span>
<a name="l01653"></a>01653 <span class="comment">    focus-&gt;p[0]-&gt;p[0]=1;</span>
<a name="l01654"></a>01654 <span class="comment">    dcell *grad=NULL;</span>
<a name="l01655"></a>01655 <span class="comment">    dcellmm(&amp;grad, Gfocus, focus, "nn",1);</span>
<a name="l01656"></a>01656 <span class="comment">    dcell *focus2=NULL;</span>
<a name="l01657"></a>01657 <span class="comment">    dcellmm(&amp;focus2, RFngs, grad, "nn",1);</span>
<a name="l01658"></a>01658 <span class="comment">    dshow(focus2-&gt;p[0]);</span>
<a name="l01659"></a>01659 <span class="comment">    for(int iwfs=0; iwfs&lt;parms-&gt;nwfs; iwfs++){</span>
<a name="l01660"></a>01660 <span class="comment">        int ipowfs=parms-&gt;wfs[iwfs].powfs;</span>
<a name="l01661"></a>01661 <span class="comment">        if(!parms-&gt;powfs[ipowfs].hasllt)</span>
<a name="l01662"></a>01662 <span class="comment">        continue;</span>
<a name="l01663"></a>01663 <span class="comment">        info("iwfs:%d",iwfs);</span>
<a name="l01664"></a>01664 <span class="comment">        dmat *focuslgs=NULL;</span>
<a name="l01665"></a>01665 <span class="comment">        dmm(&amp;focuslgs, RFlgs-&gt;p[iwfs], grad-&gt;p[iwfs], "nn",1);</span>
<a name="l01666"></a>01666 <span class="comment">        dshow(focuslgs);</span>
<a name="l01667"></a>01667 <span class="comment">        dfree(focuslgs);</span>
<a name="l01668"></a>01668 <span class="comment">    }</span>
<a name="l01669"></a>01669 <span class="comment">    }*/</span>
<a name="l01670"></a>01670     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01671"></a>01671     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(Gfocus,<span class="stringliteral">"%s/Gfocus.bin.gz"</span>,dirsetup);
<a name="l01672"></a>01672     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(RFngs,<span class="stringliteral">"%s/RFngs.bin.gz"</span>,dirsetup);
<a name="l01673"></a>01673     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(RFlgs,<span class="stringliteral">"%s/RFlgs.bin.gz"</span>,dirsetup);
<a name="l01674"></a>01674     }
<a name="l01675"></a>01675     dcellfree(Gfocus);
<a name="l01676"></a>01676 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="2bd8394adbdb99d342f9ac9d3a0faa6f"></a><!-- doxytag: member="setup_recon.c::setup_recon_mvst" ref="2bd8394adbdb99d342f9ac9d3a0faa6f" args="(RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_recon_mvst           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
compute the MVST split tomography NGS mode reconstructor. 
<p>
2010-03-16: New Implementation.<p>
Definition:<p>
<ul>
<li><img class="formulaInl" alt="$G_{lgs}$" src="form_41.png"> is LGS gradient operator from xloc, contained in recon-&gt;G0tomo as <a class="el" href="structspcell.html" title="an 2-d array of sparse.">spcell</a></li><li><img class="formulaInl" alt="$G_{ngs}$" src="form_42.png"> is NGS gradient operator from xloc, contained in recon-&gt;G0L as dense matrix</li><li><img class="formulaInl" alt="$C_{lgs}, C_{ngs}$" src="form_43.png"> is the LGS, and NGS measurement noise covariance matrix.</li><li><img class="formulaInl" alt="$\hat{x}_{lgs}$" src="form_44.png"> is LGS tomography output</li><li><img class="formulaInl" alt="$\hat{x}_{ngs}$" src="form_45.png"> is NGS minimum variance split tomography output</li><li><img class="formulaInl" alt="$a_{ngs}$" src="form_46.png"> is NGS minimum variance DM output.</li><li><img class="formulaInl" alt="$F$" src="form_47.png"> is the fitting operator</li><li><img class="formulaInl" alt="$H_A$" src="form_48.png"> is the ray tracing operator from aloc to ploc, contained in recon-&gt;HA.</li><li><img class="formulaInl" alt="$MVModes$" src="form_49.png"> is the MVST NGS modes</li><li><img class="formulaInl" alt="$MVRngs$" src="form_50.png"> is the MVST NGS reconstructor</li></ul>
<p>
We have<p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \hat{x}_{lgs}&amp;=&amp;A^{-1}G^{T}_{lgs}C_{lgs}^{-1}s_{lgs}\\ Uw&amp;=&amp;A^{-1}G_{ngs}^TC_{ngs}\\ \hat{x}_{ngs}&amp;=&amp;Uw(1+G_{ngs}Uw)^{-1}(s_{ngs}-G_{ngs}\hat{x}_{lgs});\\ a_{NGS}&amp;=&amp;F\hat{x}_{ngs}\\ MVModes&amp;=&amp;F\cdot Uw\\ MVRngs&amp;=&amp;(1+G_{ngs}Uw)^{-1} \end{eqnarray*}" src="form_51.png">
<p>
<p>
We need to orthnormalize the NGS modes. Propagate the NGS modes <img class="formulaInl" alt="$F\cdot Uw$" src="form_52.png"> to fitting directions and compute the cross-coupling matrix with weighting on <img class="formulaInl" alt="$W_0, W_1$" src="form_53.png">, we have<p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} Q&amp;=&amp;H_A\cdot F \cdot Uw\\ M_{CC}&amp;=&amp;Q^T(W_0-W_1 W_1^T)Q\\ \end{eqnarray*}" src="form_54.png">
<p>
<p>
Do SVD on <img class="formulaInl" alt="$MCC$" src="form_55.png"> we have <img class="formulaInl" alt="$M_{CC}=u\Sigma v^T $" src="form_56.png"> where <img class="formulaInl" alt="$u{\equiv}v$" src="form_57.png"> because <img class="formulaInl" alt="$MCC$" src="form_55.png"> is symmetric. Redefine the NGS modes and reconstructor as<p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} MVModes&amp;=&amp;F\cdot Uw\cdot u \Sigma^{-1/2}\\ MVRngs&amp;=&amp;\Sigma^{1/2}u^T (1+G_{ngs}A^{-1}G_{ngs}^T C_{ngs}^{-1})^{-1} \end{eqnarray*}" src="form_58.png">
<p>
 <div class="fragment"><pre class="fragment"><a name="l01727"></a>01727                                                       {
<a name="l01728"></a>01728     <span class="comment">/*</span>
<a name="l01729"></a>01729 <span class="comment">      Notice that: Solve Fitting on Uw and using FUw to form Rngs gives</span>
<a name="l01730"></a>01730 <span class="comment">      slightly different answer than solve fitting after assemble the</span>
<a name="l01731"></a>01731 <span class="comment">      reconstructor. 10^-6 relative difference.</span>
<a name="l01732"></a>01732 <span class="comment">      </span>
<a name="l01733"></a>01733 <span class="comment">      2010-03-10: Bug found and fixed: The MVST with CBS-CBS method gives worst</span>
<a name="l01734"></a>01734 <span class="comment">      performance than integrated tomography. The probelm is in PUm</span>
<a name="l01735"></a>01735 <span class="comment">      computing. I mistakenly called chol_solve, while I should have</span>
<a name="l01736"></a>01736 <span class="comment">      called muv_chol_solve. The former doesn ot apply the low rank</span>
<a name="l01737"></a>01737 <span class="comment">      terms.</span>
<a name="l01738"></a>01738 <span class="comment">    */</span>
<a name="l01739"></a>01739     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>!=2){
<a name="l01740"></a>01740     <span class="keywordflow">return</span>;
<a name="l01741"></a>01741     }
<a name="l01742"></a>01742     <a class="code" href="dsp_8h.html#515d52002c4c1055b5fd53004b6d7af7" title="Convert sparse cell to dense matrix cell: out0=out0+full(A)*alpha.">spcellfull</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#1aeb7777279f592934223920ff4be2f3">G0L</a>, recon-&gt;<a class="code" href="structRECON__T.html#ca1bb5339687bb81a2ac0513f5e19d27">G0lo</a>, 1);
<a name="l01743"></a>01743 
<a name="l01744"></a>01744     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *U=NULL; 
<a name="l01745"></a>01745     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *FU=NULL;
<a name="l01746"></a>01746     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#af8875582b897aa7687b202b15b2f814" title="load MVST mvst_U and mvst_FU.">mvst</a>){
<a name="l01747"></a>01747     U=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"mvst_U"</span>);
<a name="l01748"></a>01748     FU=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"mvst_FU"</span>);
<a name="l01749"></a>01749     }<span class="keywordflow">else</span>{
<a name="l01750"></a>01750     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *G0LT=dcelltrans(recon-&gt;<a class="code" href="structRECON__T.html#1aeb7777279f592934223920ff4be2f3">G0L</a>);
<a name="l01751"></a>01751     <a class="code" href="muv_8c.html#de96309b1d59bf9740f3c6eeed3b4a7a" title="convert the data from dcell to dmat and apply muv_chol_solve()">muv_chol_solve_cell</a>(&amp;U, &amp;recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>, G0LT);
<a name="l01752"></a>01752     dcellfree(G0LT);
<a name="l01753"></a>01753     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *rhs=NULL;
<a name="l01754"></a>01754     <a class="code" href="muv_8c.html#2bbd39c499e8875359bc94f9e4925793" title="Apply the sparse plug low rand compuation to xin without scaling of alpha: ; U,V...">muv</a>(&amp;rhs, &amp;recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>, U, 1);
<a name="l01755"></a>01755     <a class="code" href="muv_8c.html#de96309b1d59bf9740f3c6eeed3b4a7a" title="convert the data from dcell to dmat and apply muv_chol_solve()">muv_chol_solve_cell</a>(&amp;FU, &amp;recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>, rhs);
<a name="l01756"></a>01756     dcellfree(rhs);
<a name="l01757"></a>01757     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#76bd0e8cf3bef025b0b490f09d0f2f60" title="MVST computation intermediate matrices.">mvst</a> || parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01758"></a>01758         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(U, <span class="stringliteral">"%s/mvst_U"</span>, dirsetup);
<a name="l01759"></a>01759         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(FU, <span class="stringliteral">"%s/mvst_FU"</span>, dirsetup);
<a name="l01760"></a>01760     }
<a name="l01761"></a>01761     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>!=0){
<a name="l01762"></a>01762         <a class="code" href="muv_8c.html#9f12e851e069ceb3a39173ea24c099f4" title="Free cholesky decompositions.">muv_chol_free</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>);
<a name="l01763"></a>01763     }
<a name="l01764"></a>01764     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#816490fc8c78b35c2fcd85934d7972bb" title="Fitting algorithm to solve the linear equation.">alg</a>!=0){
<a name="l01765"></a>01765         <a class="code" href="muv_8c.html#9f12e851e069ceb3a39173ea24c099f4" title="Free cholesky decompositions.">muv_chol_free</a>(&amp;recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>);
<a name="l01766"></a>01766     }
<a name="l01767"></a>01767     }
<a name="l01768"></a>01768     
<a name="l01769"></a>01769     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Uw=NULL;
<a name="l01770"></a>01770     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *FUw=NULL;
<a name="l01771"></a>01771     
<a name="l01772"></a>01772     dcellmulsp(&amp;Uw, U, recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>, 1);
<a name="l01773"></a>01773     dcellmulsp(&amp;FUw, FU, recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>, 1);
<a name="l01774"></a>01774     
<a name="l01775"></a>01775     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *M=NULL;
<a name="l01776"></a>01776     dcellmm(&amp;M, recon-&gt;<a class="code" href="structRECON__T.html#1aeb7777279f592934223920ff4be2f3">G0L</a>, Uw, <span class="stringliteral">"nn"</span>, 1);
<a name="l01777"></a>01777     dcelladdI(M, 1);
<a name="l01778"></a>01778     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Minv=dcellinv(M);
<a name="l01779"></a>01779     dcellfree(M);
<a name="l01780"></a>01780    
<a name="l01781"></a>01781     {
<a name="l01782"></a>01782     <span class="comment">/*</span>
<a name="l01783"></a>01783 <span class="comment">      Change FUw*Minv -&gt; FUw*(U*sigma^-1/2) * (U*sigma^1/2)'*Minv</span>
<a name="l01784"></a>01784 <span class="comment">      columes of FUw*(U*sigma^-1/2) are the eigen vectors.</span>
<a name="l01785"></a>01785 <span class="comment">     */</span>
<a name="l01786"></a>01786     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Q=NULL;<span class="comment">//the NGS modes in ploc.</span>
<a name="l01787"></a>01787     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;Q, recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>, FUw, 1);
<a name="l01788"></a>01788     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *QwQc=<a class="code" href="recon__utils_8c.html#c2bca0565f72973497ae8d589a8be63d" title="Compute W0/W1 weighting dot product: .">calcWmcc</a>(Q,Q,recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>,recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>,recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>);
<a name="l01789"></a>01789     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *QwQ=dcell2m(QwQc);
<a name="l01790"></a>01790     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *QSdiag=NULL, *QU=NULL, *QVt=NULL;
<a name="l01791"></a>01791     <a class="code" href="dmat_8h.html#f6edae64ae92dc140f4a85679d6252ae" title="SVD of a general matrix.">dsvd</a>(&amp;QSdiag, &amp;QU, &amp;QVt, QwQ);
<a name="l01792"></a>01792     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>) <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(QSdiag,<span class="stringliteral">"%s/mvst_QSdiag"</span>,dirsetup);
<a name="l01793"></a>01793     <a class="code" href="dmat_8h.html#b6f63a9e507f7a58e4f1ba98d7bb3288" title="Raise all elements to power power.">dcwpow</a>(QSdiag, -1./2.);
<a name="l01794"></a>01794     <a class="code" href="dmat_8h.html#dd22a26474e6e6af8df941a6b25b0f05" title="A=A*B, where diag(B)=s.">dmuldiag</a>(QU,QSdiag);<span class="comment">//U*sigma^-1/2</span>
<a name="l01795"></a>01795     d2cell(&amp;QwQc,QU,NULL);
<a name="l01796"></a>01796     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *FUw_keep=FUw;FUw=NULL; 
<a name="l01797"></a>01797     dcellmm(&amp;FUw, FUw_keep, QwQc, <span class="stringliteral">"nn"</span>, 1);
<a name="l01798"></a>01798     dcellfree(FUw_keep);
<a name="l01799"></a>01799     <a class="code" href="dmat_8h.html#b6f63a9e507f7a58e4f1ba98d7bb3288" title="Raise all elements to power power.">dcwpow</a>(QSdiag,-2);
<a name="l01800"></a>01800     <a class="code" href="dmat_8h.html#dd22a26474e6e6af8df941a6b25b0f05" title="A=A*B, where diag(B)=s.">dmuldiag</a>(QU,QSdiag);<span class="comment">//U*sigma^1/2</span>
<a name="l01801"></a>01801     d2cell(&amp;QwQc,QU,NULL);
<a name="l01802"></a>01802     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Minv_keep=Minv; Minv=NULL;
<a name="l01803"></a>01803     dcellmm(&amp;Minv,QwQc,Minv_keep,<span class="stringliteral">"tn"</span>, 1);
<a name="l01804"></a>01804     dcellfree(Minv_keep);
<a name="l01805"></a>01805     dcellfree(Q);
<a name="l01806"></a>01806     dcellfree(QwQc);
<a name="l01807"></a>01807     dfree(QwQ);
<a name="l01808"></a>01808     dfree(QSdiag);
<a name="l01809"></a>01809     dfree(QVt);
<a name="l01810"></a>01810     dfree(QU);
<a name="l01811"></a>01811     }
<a name="l01812"></a>01812     <span class="comment">//Make MVRngs 1xn cell instead of nxn cell.</span>
<a name="l01813"></a>01813     recon-&gt;<a class="code" href="structRECON__T.html#5902b35daad9b93ccabda9abd74373dc">MVRngs</a>=dcellreduce(Minv,1);
<a name="l01814"></a>01814     recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>=dcellreduce(FUw,2);
<a name="l01815"></a>01815 
<a name="l01816"></a>01816   
<a name="l01817"></a>01817     dcellfree(Minv);
<a name="l01818"></a>01818     dcellfree(U);
<a name="l01819"></a>01819     dcellfree(FU);
<a name="l01820"></a>01820     dcellfree(FUw);
<a name="l01821"></a>01821     dcellfree(Uw);
<a name="l01822"></a>01822     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01823"></a>01823     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Qn=NULL;
<a name="l01824"></a>01824     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;Qn, recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>, recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>, 1);
<a name="l01825"></a>01825     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Qntt=dcellnew(Qn-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>,Qn-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>);
<a name="l01826"></a>01826     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *TTploc=<a class="code" href="loc_8c.html#7e0b28fc7b9234d93ec2af2a8b5ff33b" title="Create a dmat containing locx and locy in two columns.">loc2mat</a>(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>,1);<span class="comment">//TT mode. need piston mode too!</span>
<a name="l01827"></a>01827     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *PTTploc=<a class="code" href="dmat_8h.html#cac32a8e663201109abf36bd322e9a46" title="compute the pseudo inverse of matrix A with weigthing of full matrix W or sparse...">dpinv</a>(TTploc,NULL,recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>);<span class="comment">//TT projector. no need w1 since we have piston.</span>
<a name="l01828"></a>01828     dfree(TTploc);
<a name="l01829"></a>01829     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;Qn-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>*Qn-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>; ix++){
<a name="l01830"></a>01830         <span class="keywordflow">if</span>(!Qn-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ix]) <span class="keywordflow">continue</span>;
<a name="l01831"></a>01831         <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;Qntt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ix],PTTploc, Qn-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ix],<span class="stringliteral">"nn"</span>,1);
<a name="l01832"></a>01832     }
<a name="l01833"></a>01833     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(Qntt,<span class="stringliteral">"%s/mvst_modptt"</span>, dirsetup);
<a name="l01834"></a>01834     dcellfree(Qn);
<a name="l01835"></a>01835     dcellfree(Qntt);
<a name="l01836"></a>01836     dfree(PTTploc);
<a name="l01837"></a>01837     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#5902b35daad9b93ccabda9abd74373dc">MVRngs</a>, <span class="stringliteral">"%s/mvst_Rngs"</span>,dirsetup);
<a name="l01838"></a>01838     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>,<span class="stringliteral">"%s/mvst_Modes"</span>,dirsetup);
<a name="l01839"></a>01839     }
<a name="l01840"></a>01840     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#e24b278037c938fce784bab42147d5f1" title="Limit number of modes controled on MVST.">mvstlimit</a>&gt;0){<span class="comment">//limit number of modes used.</span>
<a name="l01841"></a>01841     warning(<span class="stringliteral">"MVST: Correction is limited to %d modes\n"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#e24b278037c938fce784bab42147d5f1" title="Limit number of modes controled on MVST.">mvstlimit</a>);
<a name="l01842"></a>01842     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *tmp;
<a name="l01843"></a>01843     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;recon-&gt;<a class="code" href="structRECON__T.html#5902b35daad9b93ccabda9abd74373dc">MVRngs</a>-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>; iy++){
<a name="l01844"></a>01844         tmp=recon-&gt;<a class="code" href="structRECON__T.html#5902b35daad9b93ccabda9abd74373dc">MVRngs</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iy];
<a name="l01845"></a>01845         <span class="keywordflow">if</span>(tmp){
<a name="l01846"></a>01846         recon-&gt;<a class="code" href="structRECON__T.html#5902b35daad9b93ccabda9abd74373dc">MVRngs</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iy]=<a class="code" href="dmat_8h.html#0e149114c808ff424f7fe215ee44d307" title="Create a new sub matrix of nx*ny starting from(sx,sy).">dsub</a>(tmp,0,parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#e24b278037c938fce784bab42147d5f1" title="Limit number of modes controled on MVST.">mvstlimit</a>,0,tmp-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>);
<a name="l01847"></a>01847         dfree(tmp);
<a name="l01848"></a>01848         }
<a name="l01849"></a>01849     }
<a name="l01850"></a>01850     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>; ix++){
<a name="l01851"></a>01851         tmp=recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ix];
<a name="l01852"></a>01852         <span class="keywordflow">if</span>(tmp){
<a name="l01853"></a>01853         recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ix]=<a class="code" href="dmat_8h.html#0e149114c808ff424f7fe215ee44d307" title="Create a new sub matrix of nx*ny starting from(sx,sy).">dsub</a>(tmp,0,tmp-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>,0,parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#e24b278037c938fce784bab42147d5f1" title="Limit number of modes controled on MVST.">mvstlimit</a>);
<a name="l01854"></a>01854         dfree(tmp);
<a name="l01855"></a>01855         }
<a name="l01856"></a>01856     }
<a name="l01857"></a>01857     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01858"></a>01858         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#5902b35daad9b93ccabda9abd74373dc">MVRngs</a>, <span class="stringliteral">"%s/mvst_Rngs_limit"</span>,dirsetup);
<a name="l01859"></a>01859         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>,<span class="stringliteral">"%s/mvst_Modes_limit"</span>,dirsetup);
<a name="l01860"></a>01860     }
<a name="l01861"></a>01861     }
<a name="l01862"></a>01862     {
<a name="l01863"></a>01863     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Q=NULL;
<a name="l01864"></a>01864     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;Q, recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>, recon-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>,1);
<a name="l01865"></a>01865     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *MCC=<a class="code" href="recon__utils_8c.html#c2bca0565f72973497ae8d589a8be63d" title="Compute W0/W1 weighting dot product: .">calcWmcc</a>(Q,Q,recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>,recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>,recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>);
<a name="l01866"></a>01866     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01867"></a>01867         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(MCC,<span class="stringliteral">"%s/mvst_MCC"</span>,dirsetup);
<a name="l01868"></a>01868     }
<a name="l01869"></a>01869     dcellfree(MCC);
<a name="l01870"></a>01870     dcellfree(Q);
<a name="l01871"></a>01871     }
<a name="l01872"></a>01872 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="6ec32666222d37047d7775b874969a2e"></a><!-- doxytag: member="setup_recon.c::setup_recon" ref="6ec32666222d37047d7775b874969a2e" args="(const PARMS_T *parms, POWFS_T *powfs, APER_T *aper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structRECON__T.html">RECON_T</a>* setup_recon           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Sets up the reconstruction structs including wavefront reconstructor and DM fitting operator. 
<p>
Calls <a class="el" href="setup__recon_8c.html#764bf903a38cfc81220e42699e911884" title="assemble tomography matrix.">setup_recon_tomo_matrix()</a> and <a class="el" href="setup__recon_8c.html#f7a8a7478b06b8b4f0d27784819f41c2" title="Assemble the DM fitting matrix.">setup_recon_fit_matrix()</a> to setup the tomography and DM fitting matrix.<p>
AHST is handled in <a class="el" href="ahst_8c.html#55c65679c193d90bc7f5175ebb17733f" title="setup NGS modes and reconstructor using AHST for one or two DMs.">setup_ngsmod()</a>.<p>
MVST is handled in <a class="el" href="setup__recon_8c.html#2bd8394adbdb99d342f9ac9d3a0faa6f" title="compute the MVST split tomography NGS mode reconstructor.">setup_recon_mvst()</a>.<p>
MOAO is handled in <a class="el" href="setup__recon_8c.html#3a5b99570039882f39e51b69236b1a0e" title="Prepare the propagation H matrix for MOAO and compute the reconstructor.">setup_recon_moao()</a>. <div class="fragment"><pre class="fragment"><a name="l01887"></a>01887                                                                         {
<a name="l01888"></a>01888     tic;
<a name="l01889"></a>01889     <span class="comment">//size_t mem0=get_job_mem();</span>
<a name="l01890"></a>01890     <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> * recon = calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a>));
<a name="l01891"></a>01891     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.pair){
<a name="l01892"></a>01892     <span class="comment">/*setup CN2 Estimator. It determines the reconstructed layer heigh can</span>
<a name="l01893"></a>01893 <span class="comment">      be fed to the tomography */</span>
<a name="l01894"></a>01894     recon-&gt;<a class="code" href="structRECON__T.html#55e2ed1c3bc81ac7c31078a40d814ddd" title="For Cn2 Estimation.">cn2est</a>=cn2est_prepare(parms,powfs);
<a name="l01895"></a>01895     }
<a name="l01896"></a>01896     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.tomo){
<a name="l01897"></a>01897     <span class="comment">/*Use cn2 estimation results for tomography. Use its ht to build</span>
<a name="l01898"></a>01898 <span class="comment">      reconstructor matrices.*/</span>
<a name="l01899"></a>01899     <a class="code" href="structCN2EST__T.html" title="contains the data related to Cn2 Estimation.">CN2EST_T</a> *cn2est=recon-&gt;<a class="code" href="structRECON__T.html#55e2ed1c3bc81ac7c31078a40d814ddd" title="For Cn2 Estimation.">cn2est</a>;
<a name="l01900"></a>01900     recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(cn2est-&gt;<a class="code" href="structCN2EST__T.html#680e74a22ab169f5e271559e6d2005d9" title="layer heights for tomography">htrecon</a>);
<a name="l01901"></a>01901     recon-&gt;<a class="code" href="structRECON__T.html#f80639ee1e2cefb3eb831d7777f38990" title="over sampling of the layers.">os</a>=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(cn2est-&gt;<a class="code" href="structCN2EST__T.html#90e9cc959cd1307832d97d6b4c97cbf1" title="over sampling factor of the layers in htrecon">os</a>);
<a name="l01902"></a>01902     recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(cn2est-&gt;<a class="code" href="structCN2EST__T.html#0e8887a2144b18f5640acd5886e0ab71" title="layer weights for tomography">wtrecon</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]);
<a name="l01903"></a>01903     <span class="comment">//the following will be updated later in simulation.</span>
<a name="l01904"></a>01904     <a class="code" href="dmat_8h.html#705d6399ce6e7f7064d12f4eb131d47d" title="set values of each element in a X(mat) to val.">dset</a>(recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>, 1./recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>);<span class="comment">//evenly distributed. delta function is bad for cbs</span>
<a name="l01905"></a>01905     recon-&gt;<a class="code" href="structRECON__T.html#537e1606a4a3c2d0da4c5461c7bb8f11" title="r0 used in reconstruction.">r0</a>=0.15;<span class="comment">//random guess</span>
<a name="l01906"></a>01906     recon-&gt;<a class="code" href="structRECON__T.html#8a6984898c82e54ce7a4d9ad37db0a0b" title="l0 used in reconstruction.">l0</a>=30;<span class="comment">//random guess</span>
<a name="l01907"></a>01907     }<span class="keywordflow">else</span>{<span class="comment">//use input information from atmr</span>
<a name="l01908"></a>01908     recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#14584f027f0a847b43f47fbbf53e6324" title="number of phase screens">nps</a>,1);
<a name="l01909"></a>01909     recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#14584f027f0a847b43f47fbbf53e6324" title="number of phase screens">nps</a>,1);
<a name="l01910"></a>01910     recon-&gt;<a class="code" href="structRECON__T.html#f80639ee1e2cefb3eb831d7777f38990" title="over sampling of the layers.">os</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#14584f027f0a847b43f47fbbf53e6324" title="number of phase screens">nps</a>,1);
<a name="l01911"></a>01911     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; ips++){
<a name="l01912"></a>01912         recon-&gt;<a class="code" href="structRECON__T.html#9ea2aeada827b00b36ade3789738a907" title="weight of the layers to to tomography.">wt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#a49819f62905b8043d11d4a2fe512bfa" title="weight of each layer (relative strength of )">wt</a>[ips];
<a name="l01913"></a>01913         recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#c2d70c6f4dd690896de2145333728abc" title="height of each layer">ht</a>[ips];
<a name="l01914"></a>01914         recon-&gt;<a class="code" href="structRECON__T.html#f80639ee1e2cefb3eb831d7777f38990" title="over sampling of the layers.">os</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ips]=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#7ef59da57ba267630d5fc5e067f75c99" title="over sampling factor of xloc over actuator spacing">os</a>[ips];
<a name="l01915"></a>01915     }
<a name="l01916"></a>01916     recon-&gt;<a class="code" href="structRECON__T.html#537e1606a4a3c2d0da4c5461c7bb8f11" title="r0 used in reconstruction.">r0</a>=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#26e119edbff7cfa6dfbd397181fde2ac" title="derived from r0z for zenith angle za">r0</a>;
<a name="l01917"></a>01917     recon-&gt;<a class="code" href="structRECON__T.html#8a6984898c82e54ce7a4d9ad37db0a0b" title="l0 used in reconstruction.">l0</a>=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#a1183e41c8d866fc77dfc08b5b229684" title="outer scale">l0</a>;
<a name="l01918"></a>01918     }
<a name="l01919"></a>01919     recon-&gt;<a class="code" href="structRECON__T.html#7e092b0677f74882da4fa83b5bd0b16c" title="sampling in meter of the layers">dx</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>, 1);
<a name="l01920"></a>01920     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iht=0; iht&lt;recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; iht++){
<a name="l01921"></a>01921     <span class="keywordtype">double</span> scale = 1.0 - recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iht]/parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#66c8146bade9913a842849b7579bef4e" title="height of the high order guide star.">hs</a>;
<a name="l01922"></a>01922     recon-&gt;<a class="code" href="structRECON__T.html#7e092b0677f74882da4fa83b5bd0b16c" title="sampling in meter of the layers">dx</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iht]=(parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#000509803902f7629b9ba04a57cb75e5" title="baseline sampling (when os=1).">dx</a>/recon-&gt;<a class="code" href="structRECON__T.html#f80639ee1e2cefb3eb831d7777f38990" title="over sampling of the layers.">os</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iht])*scale; 
<a name="l01923"></a>01923     }
<a name="l01924"></a>01924     <span class="comment">//number of reconstruction layers</span>
<a name="l01925"></a>01925     recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>= recon-&gt;<a class="code" href="structRECON__T.html#8650f6f382e5b3bd594aec2a22bdf0bb" title="height of the layers to do tomography.">ht</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>;
<a name="l01926"></a>01926     recon-&gt;<a class="code" href="structRECON__T.html#1fbfc84eb66bf5bee54a38e6b268e50a">ndm</a> = parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l01927"></a>01927     recon-&gt;<a class="code" href="structRECON__T.html#19f667fc7731b5bde53fd4761496f94a">calc_invpsd</a>=parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#6a050f8dc89b871fed9d590ba5885bb7" title="use inverse of PSD in tomography instead of biharmonic approx">invpsd</a> || parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#55e4197464d1963dbff66662ec83f4b1" title="Tomography preconditioner.">precond</a>==1;
<a name="l01928"></a>01928     <span class="keywordtype">int</span> nfit=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>;
<a name="l01929"></a>01929     recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nfit,1);
<a name="l01930"></a>01930     memcpy(recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#e921bb24d3f1439f4023b4009a004cd0" title="weight of each direction">wt</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*nfit);
<a name="l01931"></a>01931     <span class="comment">//to be used in tomography.</span>
<a name="l01932"></a>01932     recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7691a6a576a70e837fa68092a6ca26de" title="Number of threads to run the simulation.">nthread</a>;
<a name="l01933"></a>01933     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l01934"></a>01934     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l01935"></a>01935     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#979789ab45a1f87cf251469dbedebe00" title="tip/tilt removal flag.">trs</a>){
<a name="l01936"></a>01936         recon-&gt;<a class="code" href="structRECON__T.html#033a52251e3c28ded25b16d4bbefbe72">has_ttr</a>=1;
<a name="l01937"></a>01937         <span class="keywordflow">break</span>;
<a name="l01938"></a>01938     }
<a name="l01939"></a>01939     }
<a name="l01940"></a>01940     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l01941"></a>01941     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l01942"></a>01942     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#4f79eb8e4c1f3ad39eebeeb845bdc7d5" title="differential focus removal flag.">dfrs</a>){
<a name="l01943"></a>01943         recon-&gt;<a class="code" href="structRECON__T.html#fde892c07e5b7f3bd4be16df87d3ab10">has_dfr</a>=1;
<a name="l01944"></a>01944         <span class="keywordflow">break</span>;
<a name="l01945"></a>01945     }
<a name="l01946"></a>01946     }   
<a name="l01947"></a>01947     recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l01948"></a>01948     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l01949"></a>01949     info(<span class="stringliteral">"Split Tomo:"</span>);
<a name="l01950"></a>01950     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l01951"></a>01951         <span class="keyword">const</span> <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l01952"></a>01952         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l01953"></a>01953         recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs]=1;
<a name="l01954"></a>01954         info2(<span class="stringliteral">" Skip"</span>);
<a name="l01955"></a>01955         }<span class="keywordflow">else</span>{
<a name="l01956"></a>01956         info2(<span class="stringliteral">" Use"</span>);
<a name="l01957"></a>01957         }
<a name="l01958"></a>01958     }
<a name="l01959"></a>01959     info2(<span class="stringliteral">"\n"</span>);
<a name="l01960"></a>01960     }
<a name="l01961"></a>01961     
<a name="l01962"></a>01962     <span class="comment">//setup pupil coarse grid</span>
<a name="l01963"></a>01963     <a class="code" href="setup__recon_8c.html#928f34035de84ed317aa075e7a7ddac9" title="Setting up PLOC grid, which is a coarse sampled (similar to subaperture spacing)...">setup_recon_ploc</a>(recon,parms);
<a name="l01964"></a>01964     <span class="comment">//setup DM actuator grid</span>
<a name="l01965"></a>01965     <a class="code" href="setup__recon_8c.html#0182734530b87fcf5498aea2e8d1e5c0" title="Setup the deformable mirrors grid aloc.">setup_recon_aloc</a>(recon,parms);
<a name="l01966"></a>01966     <span class="comment">//setup atm reconstruction layer grid</span>
<a name="l01967"></a>01967     <a class="code" href="setup__recon_8c.html#93517d5a67108f02872fea3ca166df0a" title="Setup the tomography grids xloc which is used for Tomography.">setup_recon_xloc</a>(recon,parms);
<a name="l01968"></a>01968     <span class="comment">//setup xloc/aloc to WFS grad</span>
<a name="l01969"></a>01969     <a class="code" href="setup__recon_8c.html#61353f3760139816643f225db8e6d3bc" title="Setup gradient operator G0, GA on xloc, aloc.">setup_recon_G0GA</a>(recon,parms,powfs);
<a name="l01970"></a>01970     <span class="comment">//setup inverse noise covariance matrix.</span>
<a name="l01971"></a>01971     <a class="code" href="setup__recon_8c.html#3f6cf2f9b4c4e8dbe3cba7df6a41fa9b" title="Setup the matrix of the inverse of gradient measurement noise equivalent angle covariance...">setup_recon_saneai</a>(recon,parms,powfs);
<a name="l01972"></a>01972     <span class="comment">//tomo_prep should be after recon_G0GA as xloc maybe modified there.</span>
<a name="l01973"></a>01973     <a class="code" href="setup__recon_8c.html#2ade74dd6feba7dba0a4b6f38fe134a8" title="Prepares for tomography.">setup_recon_tomo_prep</a>(recon,parms);
<a name="l01974"></a>01974 
<a name="l01975"></a>01975     
<a name="l01976"></a>01976     <span class="comment">//setup LGS tip/tilt/diff focus removal</span>
<a name="l01977"></a>01977     <a class="code" href="setup__recon_8c.html#caa963e8fb3e5e0201f312327e4d94e8" title="wrapps setup_recon_TTR() and setup_recon_DFR() to removal global tip/tilt and differential...">setup_recon_TTFR</a>(recon,parms,powfs);
<a name="l01978"></a>01978     <a class="code" href="setup__recon_8c.html#fa92eb0639f142dd512c13688b21d813" title="Setup ray tracing operator HX,HA from xloc, aloc to aperture ploc.">setup_recon_HXHA</a>(recon,parms);
<a name="l01979"></a>01979     
<a name="l01980"></a>01980     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a> || (parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==2 &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#af8875582b897aa7687b202b15b2f814" title="load MVST mvst_U and mvst_FU.">mvst</a>)){
<a name="l01981"></a>01981     <span class="comment">//assemble the matrix only if not using CG</span>
<a name="l01982"></a>01982     <span class="comment">//CG apply the matrices on fly. </span>
<a name="l01983"></a>01983     <a class="code" href="setup__recon_8c.html#764bf903a38cfc81220e42699e911884" title="assemble tomography matrix.">setup_recon_tomo_matrix</a>(recon,parms);
<a name="l01984"></a>01984     }
<a name="l01985"></a>01985     <span class="comment">//always assemble fit matrix, faster</span>
<a name="l01986"></a>01986     <a class="code" href="setup__recon_8c.html#f7a8a7478b06b8b4f0d27784819f41c2" title="Assemble the DM fitting matrix.">setup_recon_fit_matrix</a>(recon,parms);
<a name="l01987"></a>01987     <span class="comment">//moao</span>
<a name="l01988"></a>01988     <a class="code" href="setup__recon_8c.html#3a5b99570039882f39e51b69236b1a0e" title="Prepare the propagation H matrix for MOAO and compute the reconstructor.">setup_recon_moao</a>(recon,parms,powfs,aper);
<a name="l01989"></a>01989     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#bf0ce35fd4cdfa16eefa42aea7c3300e" title="method for focus tracing.">mffocus</a>){
<a name="l01990"></a>01990     <a class="code" href="setup__recon_8c.html#4f4abf13c9b0972de67fab348bb9f470" title="Create the reconstructor to reconstruct the residual focus error due to LGS sodium...">setup_recon_focus</a>(recon, powfs, parms);
<a name="l01991"></a>01991     }
<a name="l01992"></a>01992     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>&gt;0){
<a name="l01993"></a>01993     <span class="comment">//split tomography</span>
<a name="l01994"></a>01994     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>&lt;=2){
<a name="l01995"></a>01995         <a class="code" href="ahst_8c.html#55c65679c193d90bc7f5175ebb17733f" title="setup NGS modes and reconstructor using AHST for one or two DMs.">setup_ngsmod</a>(parms,recon,aper,powfs);
<a name="l01996"></a>01996     }<span class="keywordflow">else</span>{
<a name="l01997"></a>01997         error(<span class="stringliteral">"Not implemented"</span>);
<a name="l01998"></a>01998     }
<a name="l01999"></a>01999     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==2){
<a name="l02000"></a>02000         <a class="code" href="setup__recon_8c.html#2bd8394adbdb99d342f9ac9d3a0faa6f" title="compute the MVST split tomography NGS mode reconstructor.">setup_recon_mvst</a>(recon,parms);
<a name="l02001"></a>02001     }
<a name="l02002"></a>02002     }
<a name="l02003"></a>02003     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#55e4197464d1963dbff66662ec83f4b1" title="Tomography preconditioner.">precond</a>==1){
<a name="l02004"></a>02004     toc2(<span class="stringliteral">"before fdpcg_prepare"</span>);
<a name="l02005"></a>02005     recon-&gt;<a class="code" href="structRECON__T.html#827909e242293f38820fe66212640b3d">fdpcg</a>=<a class="code" href="fdpcg_8c.html#8af00f91380661f9d85542ac9738ba95" title="Prepare data for Tomography Fourier Domain Preconditioner.">fdpcg_prepare</a>(parms, recon, powfs);
<a name="l02006"></a>02006     toc2(<span class="stringliteral">"fdpcg_prepare"</span>);
<a name="l02007"></a>02007     }
<a name="l02008"></a>02008  
<a name="l02009"></a>02009     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>);
<a name="l02010"></a>02010     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#c10de3f0cd264b530013ae0f61c6e983">actslave</a>);
<a name="l02011"></a>02011     spfree(recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>); 
<a name="l02012"></a>02012     dfree(recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>); 
<a name="l02013"></a>02013     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>); 
<a name="l02014"></a>02014  
<a name="l02015"></a>02015     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l02016"></a>02016     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l02017"></a>02017     <span class="keywordflow">if</span>(powfs[ipowfs].ZS0){
<a name="l02018"></a>02018         <span class="comment">//ZS0 is used in setup_recon. not in simulation, too large a matrix.</span>
<a name="l02019"></a>02019         spfree(powfs[ipowfs].ZS0);
<a name="l02020"></a>02020         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6af618140755d7b9cfbcebac9ab58453">ZS0</a>=NULL;
<a name="l02021"></a>02021     }
<a name="l02022"></a>02022     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#b490b1da338cd038e98d39547a2e75b8" title="need to compute GS0 (derived parameter)">hasGS0</a> &amp;&amp; powfs[ipowfs].<a class="code" href="structPOWFS__T.html#61ba7e824f0228b45378bbb92efaebe3">GS0</a>){
<a name="l02023"></a>02023         spfree(powfs[ipowfs].GS0);
<a name="l02024"></a>02024         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#61ba7e824f0228b45378bbb92efaebe3">GS0</a>=NULL;
<a name="l02025"></a>02025     }
<a name="l02026"></a>02026     }
<a name="l02027"></a>02027     <span class="comment">//Free memory that will not be used anymore in simulation</span>
<a name="l02028"></a>02028     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a> &amp;&amp; recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#46b52e4544e498d577399cec1f6e0baf">Mdm</a>) {
<a name="l02029"></a>02029     dcellfree(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#46b52e4544e498d577399cec1f6e0baf">Mdm</a>);
<a name="l02030"></a>02030     }
<a name="l02031"></a>02031     <span class="comment">/*</span>
<a name="l02032"></a>02032 <span class="comment">       The following arrys are not used after preparation is done.</span>
<a name="l02033"></a>02033 <span class="comment">     */</span>
<a name="l02034"></a>02034     sqmapfree(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>);
<a name="l02035"></a>02035     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#5f7dbe55ce06b266201e7ac3276357e4">G0</a>);
<a name="l02036"></a>02036     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#6208af43c0f23db39923cb073823ef2e">G0tomo</a>);<span class="comment">//we use H0tomo instead. faster</span>
<a name="l02037"></a>02037     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#ca1bb5339687bb81a2ac0513f5e19d27">G0lo</a>);
<a name="l02038"></a>02038     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#cd5664235d8ec047a69f515ee01bc4c6">G0hi</a>);
<a name="l02039"></a>02039     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a>){
<a name="l02040"></a>02040     spcellfree(recon-&gt;<a class="code" href="structRECON__T.html#12988e3824ca095af01bdaaedab72926" title="Like G0tomo.">H0tomo</a>);
<a name="l02041"></a>02041     }
<a name="l02042"></a>02042     toc2(<span class="stringliteral">"setup_recon"</span>);
<a name="l02043"></a>02043     <span class="keywordflow">return</span> recon;
<a name="l02044"></a>02044 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="setup__recon_8c_6ec32666222d37047d7775b874969a2e_cgraph.png" border="0" usemap="#setup__recon_8c_6ec32666222d37047d7775b874969a2e_cgraph_map" alt=""></center>
<map name="setup__recon_8c_6ec32666222d37047d7775b874969a2e_cgraph_map">
<area shape="rect" id="node3" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object." alt="" coords="208,5,259,35"><area shape="rect" id="node5" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat)." alt="" coords="212,59,255,88"><area shape="rect" id="node7" href="dmat_8h.html#705d6399ce6e7f7064d12f4eb131d47d" title="set values of each element in a X(mat) to val." alt="" coords="211,112,256,141"><area shape="rect" id="node9" href="fdpcg_8c.html#8af00f91380661f9d85542ac9738ba95" title="Prepare data for Tomography Fourier Domain Preconditioner." alt="" coords="183,165,284,195"><area shape="rect" id="node11" href="ahst_8c.html#55c65679c193d90bc7f5175ebb17733f" title="setup NGS modes and reconstructor using AHST for one or two DMs." alt="" coords="180,219,287,248"><area shape="rect" id="node13" href="setup__recon_8c.html#0182734530b87fcf5498aea2e8d1e5c0" title="Setup the deformable mirrors grid aloc." alt="" coords="172,272,295,301"><area shape="rect" id="node15" href="setup__recon_8c.html#f7a8a7478b06b8b4f0d27784819f41c2" title="Assemble the DM fitting matrix." alt="" coords="157,325,309,355"><area shape="rect" id="node17" href="setup__recon_8c.html#4f4abf13c9b0972de67fab348bb9f470" title="Create the reconstructor to reconstruct the residual focus error due to LGS sodium..." alt="" coords="168,379,299,408"><area shape="rect" id="node19" href="setup__recon_8c.html#61353f3760139816643f225db8e6d3bc" title="Setup gradient operator G0, GA on xloc, aloc." alt="" coords="165,432,301,461"><area shape="rect" id="node21" href="setup__recon_8c.html#fa92eb0639f142dd512c13688b21d813" title="Setup ray tracing operator HX,HA from xloc, aloc to aperture ploc." alt="" coords="167,485,300,515"><area shape="rect" id="node23" href="setup__recon_8c.html#3a5b99570039882f39e51b69236b1a0e" title="Prepare the propagation H matrix for MOAO and compute the reconstructor." alt="" coords="168,539,299,568"><area shape="rect" id="node25" href="setup__recon_8c.html#2bd8394adbdb99d342f9ac9d3a0faa6f" title="compute the MVST split tomography NGS mode reconstructor." alt="" coords="171,592,296,621"><area shape="rect" id="node27" href="setup__recon_8c.html#928f34035de84ed317aa075e7a7ddac9" title="Setting up PLOC grid, which is a coarse sampled (similar to subaperture spacing)..." alt="" coords="172,645,295,675"><area shape="rect" id="node29" href="setup__recon_8c.html#3f6cf2f9b4c4e8dbe3cba7df6a41fa9b" title="Setup the matrix of the inverse of gradient measurement noise equivalent angle covariance..." alt="" coords="164,699,303,728"><area shape="rect" id="node31" href="setup__recon_8c.html#764bf903a38cfc81220e42699e911884" title="assemble tomography matrix." alt="" coords="148,752,319,781"><area shape="rect" id="node33" href="setup__recon_8c.html#2ade74dd6feba7dba0a4b6f38fe134a8" title="Prepares for tomography." alt="" coords="153,805,313,835"><area shape="rect" id="node35" href="setup__recon_8c.html#caa963e8fb3e5e0201f312327e4d94e8" title="wrapps setup_recon_TTR() and setup_recon_DFR() to removal global tip/tilt and differential..." alt="" coords="168,859,299,888"><area shape="rect" id="node37" href="setup__recon_8c.html#93517d5a67108f02872fea3ca166df0a" title="Setup the tomography grids xloc which is used for Tomography." alt="" coords="172,912,295,941"></map>
</div>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 27 12:43:14 2010 for maos-0.6.1 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
