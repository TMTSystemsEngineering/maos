<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.7.0: maos/wfsgrad.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/wfsgrad.c File Reference</h1>contains functions that computes WFS gradients in geometric or physical optics mode.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="51b7a9c320bb9b58fc5632da0a44ab84"></a><!-- doxytag: member="wfsgrad.c::TIMING" ref="51b7a9c320bb9b58fc5632da0a44ab84" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>TIMING</b></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="52bfe1186605f34e3d77031297d538c3"></a><!-- doxytag: member="wfsgrad.c::TIM" ref="52bfe1186605f34e3d77031297d538c3" args="(A)" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>TIM</b>(A)</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="wfsgrad_8c.html#26b10ff13c0cde04aacfd78ec795aaae">wfsgrad_iwfs</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">computes close loop and pseudo open loop gradidents for both gometric and physical optics WFS.  <a href="#26b10ff13c0cde04aacfd78ec795aaae"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="wfsgrad_8c.html#99e7e23b2226afc767fc176f352f6e11">wfsgrad</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calls <a class="el" href="wfsgrad_8c.html#26b10ff13c0cde04aacfd78ec795aaae" title="computes close loop and pseudo open loop gradidents for both gometric and physical...">wfsgrad_iwfs()</a> to computes WFS gradient in parallel.  <a href="#99e7e23b2226afc767fc176f352f6e11"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
contains functions that computes WFS gradients in geometric or physical optics mode. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="26b10ff13c0cde04aacfd78ec795aaae"></a><!-- doxytag: member="wfsgrad.c::wfsgrad_iwfs" ref="26b10ff13c0cde04aacfd78ec795aaae" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void wfsgrad_iwfs           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
computes close loop and pseudo open loop gradidents for both gometric and physical optics WFS. 
<p>
Calls <a class="el" href="wfsints_8c.html#401f9870f0cf424f8899e389681671dc" title="compute physical optics images and add to ints.">wfsints()</a> to accumulate WFS subapertures images in physical optics mode. <div class="fragment"><pre class="fragment"><a name="l00038"></a>00038                                      {
<a name="l00039"></a>00039     <span class="comment">/*</span>
<a name="l00040"></a>00040 <span class="comment">      simu-&gt;gradcl is CL grad output</span>
<a name="l00041"></a>00041 <span class="comment">      simu-&gt;gradpsol is pseudo OL grad output.</span>
<a name="l00042"></a>00042 <span class="comment">      simu-&gt;gradacc is internal, to accumulate geometric grads.</span>
<a name="l00043"></a>00043 <span class="comment">      do not accumulate opd. accumate ints for phy, g for GS</span>
<a name="l00044"></a>00044 <span class="comment">    */</span>
<a name="l00045"></a>00045     <span class="comment">//input</span>
<a name="l00046"></a>00046     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00047"></a>00047     <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> **atm=simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>;
<a name="l00048"></a>00048     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00049"></a>00049     <span class="keyword">const</span> <a class="code" href="structPOWFS__T.html" title="contains the data associated with a certain type of WFS.">POWFS_T</a> *powfs=simu-&gt;<a class="code" href="structSIM__T.html#574e2dc6ebf0b42d7677c64eee329cac">powfs</a>;
<a name="l00050"></a>00050     <span class="keyword">const</span> <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmreal=simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>;
<a name="l00051"></a>00051     <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> **cachedm=simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>;
<a name="l00052"></a>00052     <span class="comment">//output</span>
<a name="l00053"></a>00053     <span class="keyword">const</span> <span class="keywordtype">int</span> CL=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a>;
<a name="l00054"></a>00054     <span class="keyword">const</span> <span class="keywordtype">int</span> isim=simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>;
<a name="l00055"></a>00055     <span class="keyword">const</span> <span class="keywordtype">int</span> nwfs=parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>;
<a name="l00056"></a>00056     <span class="keyword">const</span> <span class="keywordtype">int</span> nps=parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>;
<a name="l00057"></a>00057     <span class="keyword">const</span> <span class="keywordtype">double</span> dt=simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>;
<a name="l00058"></a>00058     <span class="keyword">const</span> <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*GA)[nwfs] = (<span class="keyword">const</span> <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *(*)[nwfs]) recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>;
<a name="l00059"></a>00059     <span class="keywordtype">int</span> iwfs;
<a name="l00060"></a>00060  repeat:
<a name="l00061"></a>00061     LOCK(simu-&gt;mutex_wfsgrad);
<a name="l00062"></a>00062     iwfs=simu-&gt;<a class="code" href="structSIM__T.html#e58d71938f9fa82ce8088e07c98c3da9">wfsgrad_iwfs</a>++;
<a name="l00063"></a>00063     UNLOCK(simu-&gt;mutex_wfsgrad);
<a name="l00064"></a>00064     <span class="keywordflow">if</span>(iwfs&lt;parms-&gt;nwfs){
<a name="l00065"></a>00065     TIM(0);
<a name="l00066"></a>00066     <span class="comment">//Truly constants</span>
<a name="l00067"></a>00067     <span class="keyword">const</span> <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00068"></a>00068     <span class="keyword">const</span> <span class="keywordtype">int</span> imoao=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#5b96a7a535d6e320913d8821a41a8423" title="index into MOAO struct.">moao</a>;
<a name="l00069"></a>00069     <span class="keyword">const</span> <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00070"></a>00070     <span class="keyword">const</span> <span class="keywordtype">int</span> pixpsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>*powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>;
<a name="l00071"></a>00071     <span class="keyword">const</span> <span class="keywordtype">int</span> indwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ac1b34e2f1f4455c53212bc350f5064b" title="indwfs[iwfs] gives the index of the wfs in this powfs group">indwfs</a>[iwfs];
<a name="l00072"></a>00072     <span class="keyword">const</span> <span class="keywordtype">double</span> hs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>;
<a name="l00073"></a>00073     <span class="keyword">const</span> <span class="keywordtype">int</span> npix=pixpsa*nsa;
<a name="l00074"></a>00074     <span class="keyword">const</span> <span class="keywordtype">int</span> dtrat=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00075"></a>00075     <span class="comment">//Depending on isim</span>
<a name="l00076"></a>00076     <span class="keyword">const</span> <span class="keywordtype">int</span> dtrat_reset=(!CL||dtrat==1||isim%dtrat==0);
<a name="l00077"></a>00077     <span class="keyword">const</span> <span class="keywordtype">int</span> dtrat_output=(!CL||dtrat==1||(isim+1)%dtrat==0);
<a name="l00078"></a>00078     <span class="keyword">const</span> <span class="keywordtype">int</span> do_phy=(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a>&amp;&amp;isim&gt;=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#97585440f1dc5d79451e775697d52452" title="frames to start using physical optics.">phystep</a>);
<a name="l00079"></a>00079     <span class="keyword">const</span> <span class="keywordtype">int</span> save_gradgeom=parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#a759e594e608dac31bec3f18e1d830bb" title="derived parameter to specify which powfs to save geometric grad">powfs_gradgeom</a>[ipowfs];
<a name="l00080"></a>00080     <span class="keyword">const</span> <span class="keywordtype">int</span> save_grad=parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#7903037b1cc5e3f3d57f0511d39de605" title="derived parameter to specify which powfs to save grad">powfs_grad</a>[ipowfs];
<a name="l00081"></a>00081     <span class="keyword">const</span> <span class="keywordtype">int</span> save_opd =parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#fc81107952639fb2bf16950bc6ec2bc6" title="derived parameter to specify which powfs to save opd">powfs_opd</a>[ipowfs];
<a name="l00082"></a>00082     <span class="keyword">const</span> <span class="keywordtype">int</span> save_ints=parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#77c3cafec871ddaf2d3212581f565d69" title="derived parameter to specify which powfs to save ints">wfsints</a>[ipowfs];
<a name="l00083"></a>00083     <span class="keyword">const</span> <span class="keywordtype">int</span> do_geom=!do_phy || save_gradgeom;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **gradacc=NULL;
<a name="l00086"></a>00086     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **gradout=&amp;simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs];
<a name="l00087"></a>00087     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *ints=NULL;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="keywordflow">if</span>(do_geom){ <span class="comment">//output to gradacc</span>
<a name="l00090"></a>00090         gradacc=&amp;simu-&gt;<a class="code" href="structSIM__T.html#a738e7a4294a049073428945f65695e0">gradacc</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs];
<a name="l00091"></a>00091         <span class="keywordflow">if</span>(!*gradacc)
<a name="l00092"></a>00092         *gradacc=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,1);
<a name="l00093"></a>00093         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dtrat_reset)
<a name="l00094"></a>00094         <a class="code" href="dmat_8h.html#e98618064b54869b4180d0c7fd895645" title="initialize all numbers in a X(mat) object to 0">dzero</a>(*gradacc);
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *opd=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(npix,1);
<a name="l00097"></a>00097     <span class="comment">/*</span>
<a name="l00098"></a>00098 <span class="comment">      Add surface</span>
<a name="l00099"></a>00099 <span class="comment">    */</span>
<a name="l00100"></a>00100     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#63db4cfd2859ab3331ea32ec21d7b747">surfwfs</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#63db4cfd2859ab3331ea32ec21d7b747">surfwfs</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]){
<a name="l00101"></a>00101         <a class="code" href="dmat_8h.html#4c4f53dc9572106deb6933eb103bf40b" title="compute B=bc*B+ac*A behavior changed on 2009-11-02.">dadd</a>(&amp;opd,1, simu-&gt;<a class="code" href="structSIM__T.html#63db4cfd2859ab3331ea32ec21d7b747">surfwfs</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],1);
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103     <span class="comment">/*</span>
<a name="l00104"></a>00104 <span class="comment">      Add NCPA to WFS as needed. Todo: merge surfwfs</span>
<a name="l00105"></a>00105 <span class="comment">      with ncpa. be careful about ncpa calibration.</span>
<a name="l00106"></a>00106 <span class="comment">    */</span>
<a name="l00107"></a>00107     <span class="keywordflow">if</span>(powfs[ipowfs].ncpa){
<a name="l00108"></a>00108         <span class="comment">//info2("Adding NCPA to wfs %d\n",iwfs);</span>
<a name="l00109"></a>00109         <a class="code" href="dmat_8h.html#4c4f53dc9572106deb6933eb103bf40b" title="compute B=bc*B+ac*A behavior changed on 2009-11-02.">dadd</a>(&amp;opd, 1, powfs[ipowfs].ncpa-&gt;p[indwfs], 1);
<a name="l00110"></a>00110     }
<a name="l00111"></a>00111     <span class="keywordtype">int</span> ilocm=-1;
<a name="l00112"></a>00112     <span class="keywordflow">if</span>(powfs[ipowfs].locm){
<a name="l00113"></a>00113         ilocm=(powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3f8067507fad08b3bcb049e7bbb6b65f">nlocm</a>&gt;1)?indwfs:0;
<a name="l00114"></a>00114         info(<span class="stringliteral">"ilocm=%d\n"</span>,ilocm);
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116     <span class="keywordtype">double</span> *realamp;
<a name="l00117"></a>00117     <span class="keywordflow">if</span>(powfs[ipowfs].locm){
<a name="l00118"></a>00118         realamp=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>[ilocm];
<a name="l00119"></a>00119     }<span class="keywordflow">else</span>{
<a name="l00120"></a>00120         realamp=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>;
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122     <span class="comment">/*</span>
<a name="l00123"></a>00123 <span class="comment">      Now begin ray tracing.</span>
<a name="l00124"></a>00124 <span class="comment">     */</span>
<a name="l00125"></a>00125     <span class="keywordflow">if</span>(atm){
<a name="l00126"></a>00126         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;nps; ips++){
<a name="l00127"></a>00127         <span class="comment">//most expensive 0.10 per LGS for </span>
<a name="l00128"></a>00128         <span class="keyword">const</span> <span class="keywordtype">double</span> hl=atm[ips]-&gt;<a class="code" href="structMAP__T.html#7cad352b82624ab945b7808ea931f282" title="Heigh conjugation of this surface.">h</a>;
<a name="l00129"></a>00129         <span class="keywordflow">if</span>(hl&gt;hs){
<a name="l00130"></a>00130             warning(<span class="stringliteral">"Layer is above guide star!\n"</span>);
<a name="l00131"></a>00131             <span class="keywordflow">continue</span>;
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133         <span class="keyword">const</span> <span class="keywordtype">double</span> scale=1.-hl/hs;
<a name="l00134"></a>00134         <span class="keyword">const</span> <span class="keywordtype">double</span> displacex=-atm[ips]-&gt;<a class="code" href="structMAP__T.html#0e1501d3055f92d8013c7f9e28b7dada">vx</a>*isim*dt
<a name="l00135"></a>00135             +parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*hl;
<a name="l00136"></a>00136         <span class="keyword">const</span> <span class="keywordtype">double</span> displacey=-atm[ips]-&gt;<a class="code" href="structMAP__T.html#18114c94e58dd22db69cb1cfbc050623">vy</a>*isim*dt
<a name="l00137"></a>00137             +parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*hl;
<a name="l00138"></a>00138         <span class="keywordflow">if</span>(powfs[ipowfs].locm){<span class="comment">//misregistration.</span>
<a name="l00139"></a>00139             <a class="code" href="accphi_8c.html#5ba7f2c5f6336b56caa056adcee4f11c" title="Propagate OPD defines on grid mapin to coordinate locout.">prop_grid</a>(atm[ips], powfs[ipowfs].locm[ilocm], opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 1, 
<a name="l00140"></a>00140                   displacex, displacey, scale, 1., 0, 0);
<a name="l00141"></a>00141         }<span class="keywordflow">else</span>{
<a name="l00142"></a>00142             <a class="code" href="accphi_8c.html#3f1a50d6e3d25fd04d66224ee0065ff0" title="Propagate OPD defines on grid mapin to subapertures.">prop_grid_pts</a>(atm[ips], powfs[ipowfs].pts,
<a name="l00143"></a>00143                   opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 1, displacex, displacey,
<a name="l00144"></a>00144                   scale, 1., 0, 0, 1);
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146         }
<a name="l00147"></a>00147     }
<a name="l00148"></a>00148     <span class="keywordflow">if</span>(CL &amp;&amp; dmreal){
<a name="l00149"></a>00149         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00150"></a>00150         thread_t *wfs_prop=&amp;(simu-&gt;<a class="code" href="structSIM__T.html#2201998d1bf3907a381f73a7ad3fa153" title="wrap of data for ray tracing from DM in wfsgrad.c">wfs_prop_dm</a>[iwfs+parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>*idm]);
<a name="l00151"></a>00151         PROPDATA_T *wfs_propdata=wfs_prop-&gt;data;
<a name="l00152"></a>00152         <span class="keywordflow">if</span>(!cachedm){
<a name="l00153"></a>00153             wfs_propdata-&gt;phiin=dmreal-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00154"></a>00154         }
<a name="l00155"></a>00155         wfs_propdata-&gt;phiout=opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00156"></a>00156         <a class="code" href="accphi_8c.html#56055820d17e7869e938c41ff78e087a" title="A wrapper prop routine that handles all the different cases by calling the different...">prop</a>(wfs_prop);
<a name="l00157"></a>00157         }<span class="comment">//idm</span>
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159     <span class="keywordflow">if</span>(imoao&gt;-1){
<a name="l00160"></a>00160         PDCELL(simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>, dmwfs);
<a name="l00161"></a>00161         <span class="keywordflow">if</span>(dmwfs[iwfs][simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>-1]){
<a name="l00162"></a>00162         info(<span class="stringliteral">"iwfs %d: Adding MOAO correction\n"</span>, iwfs);
<a name="l00163"></a>00163         <span class="comment">//No need to do mis registration here since the MOAO DM is attached to close to the WFS.</span>
<a name="l00164"></a>00164         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#6ccaefa7d6eb62c0bd011e9c79f7cfef" title="Whether use cubic influence function.">cubic</a>){
<a name="l00165"></a>00165             <a class="code" href="accphi_8c.html#2978e878c113c47804ae296f24a01661" title="like prop_nongrid_pts but with cubic influence functions.">prop_nongrid_pts_cubic</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, 
<a name="l00166"></a>00166                        dmwfs[iwfs][simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>-1]-&gt;p,
<a name="l00167"></a>00167                        powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>, realamp, opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, -1, 0, 0, 1, 
<a name="l00168"></a>00168                        parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#f52f25ca1fec25148e7163d40d059691" title="Inter-actuator-coupling for cubic influence function.">iac</a>, 0, 0, 1);
<a name="l00169"></a>00169         }<span class="keywordflow">else</span>{
<a name="l00170"></a>00170             <a class="code" href="accphi_8c.html#ffbc809aa885e1096d019ef1c627b25e" title="Propagate OPD defines on coordinate locin to subapertures pts.">prop_nongrid_pts</a>(recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, dmwfs[iwfs][simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>-1]-&gt;p,
<a name="l00171"></a>00171                      powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>, realamp, opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, -1, 0, 0, 1, 
<a name="l00172"></a>00172                      0, 0, 1);
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175     }
<a name="l00176"></a>00176     <span class="comment">/*</span>
<a name="l00177"></a>00177 <span class="comment">      Add defocus to OPD if needed.</span>
<a name="l00178"></a>00178 <span class="comment">     */</span>
<a name="l00179"></a>00179     <span class="keywordtype">double</span> focus=0;
<a name="l00180"></a>00180     <span class="keywordflow">if</span>(powfs[ipowfs].focus){
<a name="l00181"></a>00181         <span class="keywordtype">int</span> iy=0;
<a name="l00182"></a>00182         <span class="keywordtype">int</span> nx=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>;
<a name="l00183"></a>00183         <span class="keywordtype">int</span> ny=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>;
<a name="l00184"></a>00184         <span class="keywordflow">if</span>(ny==1){
<a name="l00185"></a>00185         iy=0;
<a name="l00186"></a>00186         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(ny==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>){
<a name="l00187"></a>00187         iy=indwfs;
<a name="l00188"></a>00188         }<span class="keywordflow">else</span>{
<a name="l00189"></a>00189         error(<span class="stringliteral">"powfs[%d].focus wrong format\n"</span>,ipowfs);
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191         <span class="keywordtype">int</span> ix=isim%nx;
<a name="l00192"></a>00192         <span class="keywordtype">double</span> focusadd=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ix+nx*iy];
<a name="l00193"></a>00193         <span class="keywordflow">if</span>(fabs(focusadd)&gt;1.e-200){
<a name="l00194"></a>00194         info(<span class="stringliteral">"WFS %d: adding %g focus from input.\n"</span>, iwfs, focusadd);
<a name="l00195"></a>00195         focus+=focusadd;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#cf19af635f4448413fce6adba8078d6e">focusint</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#cf19af635f4448413fce6adba8078d6e">focusint</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]){
<a name="l00199"></a>00199         info(<span class="stringliteral">"WFS %d: Adding focus adjust to %g\n"</span>, 
<a name="l00200"></a>00200          iwfs, simu-&gt;<a class="code" href="structSIM__T.html#cf19af635f4448413fce6adba8078d6e">focusint</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]);
<a name="l00201"></a>00201         focus+=simu-&gt;<a class="code" href="structSIM__T.html#cf19af635f4448413fce6adba8078d6e">focusint</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203     <span class="keywordflow">if</span>(fabs(focus)&gt;1.e-200){
<a name="l00204"></a>00204         <a class="code" href="loc_8c.html#1bb7e8a161d93d741c642d7a5b750f13" title="Add val amount of focus to opd.">loc_add_focus</a>(opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>, focus);
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206     <span class="keywordflow">if</span>(save_opd){
<a name="l00207"></a>00207         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(opd,<span class="stringliteral">"wfsopd_%d/wfsopd_%d_wfs%d.bin"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,isim,iwfs);
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="comment">/*</span>
<a name="l00211"></a>00211 <span class="comment">      Now begin Physical Optics Intensity calculations</span>
<a name="l00212"></a>00212 <span class="comment">     */</span>
<a name="l00213"></a>00213     <span class="keywordflow">if</span>(do_phy){ <span class="comment">//initialize ints is not already initlialized</span>
<a name="l00214"></a>00214         <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>[iwfs]){
<a name="l00215"></a>00215         simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>[iwfs]=dcellnew(nsa,1);
<a name="l00216"></a>00216         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00217"></a>00217             simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>[iwfs]-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(powfs[ipowfs].pixpsax,
<a name="l00218"></a>00218                           powfs[ipowfs].pixpsay);
<a name="l00219"></a>00219         }
<a name="l00220"></a>00220         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(dtrat_reset){
<a name="l00221"></a>00221         dcellzero(simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>[iwfs]);
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223         ints=simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>[iwfs];
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225     <span class="keywordflow">if</span>(do_geom){
<a name="l00226"></a>00226         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#129c1dda529b641aac48415a110235b7" title="wfs type if not using physical optics in reconstruction.">gtype_sim</a>==1){
<a name="l00227"></a>00227         <span class="comment">//compute ztilt.</span>
<a name="l00228"></a>00228         <a class="code" href="loc_8c.html#d445e3b2a45ec41744470c0b57ef44bb" title="Compute zernike best fit for all subapertures.">pts_ztilt</a>((*gradacc)-&gt;p,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>,
<a name="l00229"></a>00229               powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c1a97256a90efbb53166fc1ab5c16a9">imcc</a>,realamp,
<a name="l00230"></a>00230               opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>);
<a name="l00231"></a>00231         }<span class="keywordflow">else</span>{
<a name="l00232"></a>00232         <span class="comment">//G tilt</span>
<a name="l00233"></a>00233         <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(gradacc,powfs[ipowfs].GS0,opd,1);
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <a class="code" href="structccell.html" title="an 2-d block matrix of cmat.">ccell</a> *psfout=NULL;
<a name="l00238"></a>00238     <a class="code" href="structcellarr.html" title="used to save array of dmat, cmat, ccell or dcell.">cellarr</a> *psfoutcellarr=NULL;
<a name="l00239"></a>00239     <a class="code" href="structcellarr.html" title="used to save array of dmat, cmat, ccell or dcell.">cellarr</a> *ztiltoutcellarr=NULL;
<a name="l00240"></a>00240     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d0e06b302154b9b7a4a81bfdfd35a3d8" title="output time history of low order wfs PSF.">psfout</a>){
<a name="l00241"></a>00241         psfout=simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>[iwfs];
<a name="l00242"></a>00242         psfoutcellarr=simu-&gt;<a class="code" href="structSIM__T.html#1c33b2746b273def2a8b91c078e04e43">wfspsfoutcellarr</a>[iwfs];
<a name="l00243"></a>00243         ztiltoutcellarr=simu-&gt;<a class="code" href="structSIM__T.html#52a7f7ea349954a1de5660339c3d1246">ztiltoutcellarr</a>[iwfs];
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *pistatout=NULL;
<a name="l00246"></a>00246     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27067cb8df3c4a8b2eb27e32a0e309fd" title="output time averaged short exposure image.">pistatout</a>
<a name="l00247"></a>00247        &amp;&amp;isim&gt;=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#328b58d92aec3a1c2c17afc366ded8a1" title="time step to compute pistatout">pistatstart</a>){
<a name="l00248"></a>00248         <span class="comment">//assert(parms-&gt;powfs[ipowfs].dtrat==1);</span>
<a name="l00249"></a>00249         <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>[iwfs]){
<a name="l00250"></a>00250         simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>[iwfs]
<a name="l00251"></a>00251             =dcellnew(nsa,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>);
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253         pistatout=simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>[iwfs];
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     TIM(1);
<a name="l00256"></a>00256     <span class="keywordflow">if</span>(ints || psfout || pistatout){
<a name="l00257"></a>00257         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *lltopd=NULL;
<a name="l00258"></a>00258         <span class="keywordflow">if</span>(powfs[ipowfs].lotf){
<a name="l00259"></a>00259         lltopd=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>,
<a name="l00260"></a>00260                 powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#7d83094d1be8eca22ba36cbca2c6cf0f" title="The LLT lower left grid point location.">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>);
<a name="l00261"></a>00261         <span class="keyword">const</span> <span class="keywordtype">int</span> illt=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#8b48a0d2966a34279ed54edf5f5ed7a0" title="Index into llt for this iwfs.">i</a>[indwfs];
<a name="l00262"></a>00262         <span class="keywordflow">if</span>(atm){
<a name="l00263"></a>00263             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;nps; ips++){
<a name="l00264"></a>00264             <span class="keyword">const</span> <span class="keywordtype">double</span> hl=atm[ips]-&gt;<a class="code" href="structMAP__T.html#7cad352b82624ab945b7808ea931f282" title="Heigh conjugation of this surface.">h</a>;
<a name="l00265"></a>00265             <span class="keyword">const</span> <span class="keywordtype">double</span> scale=1.-hl/hs;
<a name="l00266"></a>00266             <span class="comment">/*</span>
<a name="l00267"></a>00267 <span class="comment">              Bug fixed: 2009-01-05: multiply ox,oy to hl/hs.</span>
<a name="l00268"></a>00268 <span class="comment">            */</span>
<a name="l00269"></a>00269             <span class="keyword">const</span> <span class="keywordtype">double</span> displacex=-atm[ips]-&gt;<a class="code" href="structMAP__T.html#0e1501d3055f92d8013c7f9e28b7dada">vx</a>*isim*dt
<a name="l00270"></a>00270                 +parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*hl
<a name="l00271"></a>00271                 +parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#ef2483dcc582462f3eb512d8afacbb0a" title="location x of LLT center wrt telescope aperture center">ox</a>[illt]*hl/hs;
<a name="l00272"></a>00272             <span class="keyword">const</span> <span class="keywordtype">double</span> displacey=-atm[ips]-&gt;<a class="code" href="structMAP__T.html#18114c94e58dd22db69cb1cfbc050623">vy</a>*isim*dt
<a name="l00273"></a>00273                 +parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*hl
<a name="l00274"></a>00274                 +parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#14e57fee894c978e597da00a6c0c092c" title="see ox.">oy</a>[illt]*hl/hs;
<a name="l00275"></a>00275             <a class="code" href="accphi_8c.html#3f1a50d6e3d25fd04d66224ee0065ff0" title="Propagate OPD defines on grid mapin to subapertures.">prop_grid_pts</a>(atm[ips],powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>,
<a name="l00276"></a>00276                       lltopd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,1,displacex,displacey,
<a name="l00277"></a>00277                       scale, 1., 0, 0, 1);
<a name="l00278"></a>00278             }
<a name="l00279"></a>00279         }
<a name="l00280"></a>00280         <span class="keywordflow">if</span>((simu-&gt;<a class="code" href="structSIM__T.html#1a1715f09be296fb2667b7a05c5fdc65">uptreal</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#1a1715f09be296fb2667b7a05c5fdc65">uptreal</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]) ||pistatout){
<a name="l00281"></a>00281             <span class="keyword">const</span> <span class="keywordtype">int</span> nx=lltopd-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>;
<a name="l00282"></a>00282             <span class="keyword">const</span> <span class="keywordtype">double</span> dx=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#7d83094d1be8eca22ba36cbca2c6cf0f" title="The LLT lower left grid point location.">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>;
<a name="l00283"></a>00283             <span class="keyword">const</span> <span class="keywordtype">double</span> ox=-nx*dx/2.;
<a name="l00284"></a>00284             <span class="keyword">const</span> <span class="keywordtype">double</span> oy=-nx*dx/2.;
<a name="l00285"></a>00285             <span class="keywordtype">double</span> ttx;
<a name="l00286"></a>00286             <span class="keywordtype">double</span> tty;
<a name="l00287"></a>00287             <span class="keywordflow">if</span>(pistatout||parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#604a71ce5bbb631f3caee65576c26221" title="ideal compensation for uplink pointing">uptideal</a>){
<a name="l00288"></a>00288             warning(<span class="stringliteral">"Remove tip/tilt in uplink ideally\n"</span>);
<a name="l00289"></a>00289             <span class="comment">//remove tip/tilt completely</span>
<a name="l00290"></a>00290             <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *lltg=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(2,1);
<a name="l00291"></a>00291             <a class="code" href="loc_8c.html#d445e3b2a45ec41744470c0b57ef44bb" title="Compute zernike best fit for all subapertures.">pts_ztilt</a>(lltg-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#7d83094d1be8eca22ba36cbca2c6cf0f" title="The LLT lower left grid point location.">pts</a>,
<a name="l00292"></a>00292                   powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#c215fc03005670b81049646eec9cfcf6" title="inverse of imcc">imcc</a>,
<a name="l00293"></a>00293                   powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#87490e75239e15d544b5e8a61ee084ae" title="The amplitude defined on loc.">amp</a>,
<a name="l00294"></a>00294                   lltopd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>);
<a name="l00295"></a>00295             ttx=-lltg-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];
<a name="l00296"></a>00296             tty=-lltg-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1];
<a name="l00297"></a>00297             <span class="comment">//dshow(lltg);</span>
<a name="l00298"></a>00298             dfree(lltg);
<a name="l00299"></a>00299             }<span class="keywordflow">else</span>{
<a name="l00300"></a>00300             ttx=simu-&gt;<a class="code" href="structSIM__T.html#1a1715f09be296fb2667b7a05c5fdc65">uptreal</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];
<a name="l00301"></a>00301             tty=simu-&gt;<a class="code" href="structSIM__T.html#1a1715f09be296fb2667b7a05c5fdc65">uptreal</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1];
<a name="l00302"></a>00302             }
<a name="l00303"></a>00303             <span class="comment">//copy uptreal to output</span>
<a name="l00304"></a>00304             PDMAT(simu-&gt;<a class="code" href="structSIM__T.html#071e7f2036849234d609e8179e809945">uptcmds</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], puptcmds);
<a name="l00305"></a>00305             puptcmds[isim][0]=ttx;
<a name="l00306"></a>00306             puptcmds[isim][1]=tty;
<a name="l00307"></a>00307             <span class="keywordtype">double</span> vty=0;
<a name="l00308"></a>00308             double (*pp)[nx]=(double(*)[nx])lltopd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00309"></a>00309             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;lltopd-&gt;ny; iy++){
<a name="l00310"></a>00310             vty=(oy+iy*dx)*tty;
<a name="l00311"></a>00311             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;nx; ix++){
<a name="l00312"></a>00312                 pp[iy][ix]+=vty+(ox+ix*dx)*ttx;
<a name="l00313"></a>00313             }
<a name="l00314"></a>00314             }
<a name="l00315"></a>00315         }
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317         <span class="keywordflow">if</span>(save_opd){
<a name="l00318"></a>00318         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(lltopd,<span class="stringliteral">"wfsopd_%d/wfslltopd_%d_wfs%d.bin"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,isim,iwfs);
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *gradref=NULL;
<a name="l00321"></a>00321         <span class="keywordflow">if</span>(pistatout){
<a name="l00322"></a>00322         <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#2a30293ecd8b6ad08b816b51cd34ec0f" title="1: shift to center using fft method.">pistatstc</a> &amp;&amp; do_geom){
<a name="l00323"></a>00323             gradref=*gradacc;
<a name="l00324"></a>00324             <span class="comment">//info("Using ztilt to shift pistat\n");</span>
<a name="l00325"></a>00325         }<span class="keywordflow">else</span>{
<a name="l00326"></a>00326             <span class="comment">//info("Using fft to shift pistat\n");</span>
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328         }
<a name="l00329"></a>00329         <a class="code" href="wfsints_8c.html#401f9870f0cf424f8899e389681671dc" title="compute physical optics images and add to ints.">wfsints</a>(ints,psfout,pistatout,gradref,
<a name="l00330"></a>00330                    parms,powfs,iwfs,isim,opd,lltopd);
<a name="l00331"></a>00331         dfree(lltopd);
<a name="l00332"></a>00332         <span class="keywordflow">if</span>(psfout){
<a name="l00333"></a>00333         <a class="code" href="cellarr_8c.html#8341c0f13efbd57caf27fa9f8586c613" title="Append a ccell A into the cellarr ca.">cellarr_ccell</a>(psfoutcellarr,psfout);
<a name="l00334"></a>00334         <a class="code" href="cellarr_8c.html#5777e543da91c740b0ee59adae70d6d8" title="Append a dmat A into the cellarr ca.">cellarr_dmat</a>(ztiltoutcellarr, *gradacc);
<a name="l00335"></a>00335         }
<a name="l00336"></a>00336         <span class="keywordflow">if</span>(save_ints &amp;&amp; ints &amp;&amp; dtrat_output){
<a name="l00337"></a>00337         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(ints, <span class="stringliteral">"ints_%d/ints_%d_wfs%d.bin"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,isim,iwfs);
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340     TIM(2);
<a name="l00341"></a>00341     <span class="keywordflow">if</span>(dtrat_output &amp;&amp; do_phy){
<a name="l00342"></a>00342         <span class="comment">/*</span>
<a name="l00343"></a>00343 <span class="comment">          In Physical optics mode, finish integration and</span>
<a name="l00344"></a>00344 <span class="comment">          output gradients to grad.</span>
<a name="l00345"></a>00345 <span class="comment">        */</span>
<a name="l00346"></a>00346         
<a name="l00347"></a>00347         <span class="comment">//matched filter</span>
<a name="l00348"></a>00348         <span class="comment">//index into matched filter.</span>
<a name="l00349"></a>00349         <span class="comment">//most useful for multillt</span>
<a name="l00350"></a>00350         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **mtche=NULL;
<a name="l00351"></a>00351         <span class="keywordtype">double</span> *i0sum=NULL;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#bd9d4d4a65743daf24311e58bc91fc67" title="physical optics type for simulation.">phytypesim</a>==1){
<a name="l00354"></a>00354         <span class="keywordflow">if</span>(powfs[ipowfs].intstat-&gt;mtche-&gt;ny==1){
<a name="l00355"></a>00355             mtche=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#0165680cc8d86944018418a1e361df81">mtche</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;
<a name="l00356"></a>00356             i0sum=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#c3579bfed8599c928d05aac5cd109d82">i0sum</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00357"></a>00357         }<span class="keywordflow">else</span>{
<a name="l00358"></a>00358             mtche=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#0165680cc8d86944018418a1e361df81">mtche</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>+nsa*indwfs;
<a name="l00359"></a>00359             i0sum=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#c3579bfed8599c928d05aac5cd109d82">i0sum</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nsa*indwfs;
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362         <span class="keywordtype">double</span> pixtheta=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#adf117b796aef86ac0b1759f81ad59fd" title="size of pixel pitch along x or y in radian">pixtheta</a>;
<a name="l00363"></a>00363         
<a name="l00364"></a>00364         <span class="comment">//Rayleigh scattering (bkgrnd)</span>
<a name="l00365"></a>00365         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> **bkgrnd2=NULL;
<a name="l00366"></a>00366         <span class="keywordflow">if</span>(powfs[ipowfs].bkgrnd){
<a name="l00367"></a>00367         <span class="keywordflow">if</span>(powfs[ipowfs].bkgrnd-&gt;ny==1){
<a name="l00368"></a>00368             bkgrnd2=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#ce22bc0f58b30c9ef182186ef59d18e1">bkgrnd</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>;
<a name="l00369"></a>00369         }<span class="keywordflow">else</span>{
<a name="l00370"></a>00370             bkgrnd2=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#ce22bc0f58b30c9ef182186ef59d18e1">bkgrnd</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>+nsa*indwfs;
<a name="l00371"></a>00371         }
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373         
<a name="l00374"></a>00374         <span class="keywordtype">double</span> *srot=NULL;
<a name="l00375"></a>00375         <span class="keywordflow">if</span>(powfs[ipowfs].srot){
<a name="l00376"></a>00376         <span class="keyword">const</span> <span class="keywordtype">int</span> illt=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#8b48a0d2966a34279ed54edf5f5ed7a0" title="Index into llt for this iwfs.">i</a>[indwfs];
<a name="l00377"></a>00377         <span class="comment">//this is in r/a coordinate, get angles</span>
<a name="l00378"></a>00378         srot=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fd0302013032e547054f9431d7aee502">srot</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380         <span class="comment">//output directly to simu-&gt;gradcl. replace</span>
<a name="l00381"></a>00381         double (*pgrad)[nsa]=(double(*)[nsa])(*gradout)-&gt;p;
<a name="l00382"></a>00382         <span class="keywordtype">double</span> gnf[2],gny[2];
<a name="l00383"></a>00383         <span class="keywordtype">double</span> rne=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a33b760c70db9950fd09ba10aad23931" title="read out noise in electron per pixel per frame">rne</a>;
<a name="l00384"></a>00384         <span class="keywordtype">double</span> bkgrnd=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#847860bab1665b17b5e85d502a4485e0" title="background in electron per pixel per LGS frame">bkgrnd</a>*parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00385"></a>00385         <span class="keywordtype">double</span> siglev=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#83582e7e6916eee3a62304b0dae680f8" title="Signal value used for simulation.">siglevsim</a>;<span class="comment">//don't multiply to dtrat.</span>
<a name="l00386"></a>00386         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00387"></a>00387         <a class="code" href="dmat_8h.html#9a9da6ac02ccf42247a8a78a131ca73a" title="scale each element of A by w">dscale</a>(ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa], siglev);
<a name="l00388"></a>00388         <span class="comment">/*</span>
<a name="l00389"></a>00389 <span class="comment">          TODO: Do something to remove negative pixels. shift image</span>
<a name="l00390"></a>00390 <span class="comment">          or mask out. This is important when bkgrndrm is greater</span>
<a name="l00391"></a>00391 <span class="comment">          than 1.</span>
<a name="l00392"></a>00392 <span class="comment">          </span>
<a name="l00393"></a>00393 <span class="comment">        */</span>
<a name="l00394"></a>00394         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#df2e5e35af169d9d5e702ef4c42b7163" title="noisy or not during *simulation*">noisy</a>){
<a name="l00395"></a>00395             <span class="keywordtype">double</span> pmax;
<a name="l00396"></a>00396             gnf[0]=0; gnf[1]=0;
<a name="l00397"></a>00397             <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#bd9d4d4a65743daf24311e58bc91fc67" title="physical optics type for simulation.">phytypesim</a>){
<a name="l00398"></a>00398             <span class="keywordflow">case</span> 1:
<a name="l00399"></a>00399             <a class="code" href="dmat_8h.html#108a4a2f57a5f271427d7af94a71abd8" title="multiply a X(mat) matrix with a vector and accumulate to y: y+=A*x*alpha">dmulvec</a>(gnf, mtche[isa], ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,1.);
<a name="l00400"></a>00400             <span class="keywordflow">break</span>;
<a name="l00401"></a>00401             <span class="keywordflow">case</span> 2:
<a name="l00402"></a>00402             pmax=<a class="code" href="dmat_8h.html#abb4fecd296ac9ec19263e0f9d853be7" title="find the maximum value of a X(mat) object">dmax</a>(ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa]);
<a name="l00403"></a>00403             <a class="code" href="dmat_8h.html#6531cfb8534d620420fbdf1deffb227c" title="Compute thresholded center of gravity.">dcog</a>(gnf,ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa],0.,0.,0.1*pmax,0.1*pmax);
<a name="l00404"></a>00404             gnf[0]*=pixtheta;
<a name="l00405"></a>00405             gnf[1]*=pixtheta;
<a name="l00406"></a>00406             <span class="keywordflow">break</span>;
<a name="l00407"></a>00407             <span class="keywordflow">default</span>:
<a name="l00408"></a>00408             error(<span class="stringliteral">"Invalid"</span>);
<a name="l00409"></a>00409             }
<a name="l00410"></a>00410             <span class="keywordtype">double</span> *bkgrnd2i;
<a name="l00411"></a>00411             <span class="keywordtype">double</span> bkgrnd2irm=0;
<a name="l00412"></a>00412             <span class="keywordflow">if</span>(bkgrnd2 &amp;&amp; bkgrnd2[isa]){
<a name="l00413"></a>00413             bkgrnd2i=bkgrnd2[isa]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00414"></a>00414             bkgrnd2irm=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#8525cf543d090902082c59c2c4ce1567" title="How much of the background in bkgrndfn can be calibrated out.">bkgrndrm</a>;
<a name="l00415"></a>00415             }<span class="keywordflow">else</span>{
<a name="l00416"></a>00416             bkgrnd2i=NULL;
<a name="l00417"></a>00417             }
<a name="l00418"></a>00418             <a class="code" href="maos_2utils_8c.html#5a2e23d34ba0e7d3614bd42f5eb8ccaa" title="add photon and read out noise.">addnoise</a>(ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa], &amp;simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>[iwfs],bkgrnd,1.,
<a name="l00419"></a>00419                  bkgrnd2i, bkgrnd2irm, rne);
<a name="l00420"></a>00420         }
<a name="l00421"></a>00421         gny[0]=0; gny[1]=0;
<a name="l00422"></a>00422         <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#bd9d4d4a65743daf24311e58bc91fc67" title="physical optics type for simulation.">phytypesim</a>){
<a name="l00423"></a>00423             <span class="keywordtype">double</span> pmax;
<a name="l00424"></a>00424         <span class="keywordflow">case</span> 1:
<a name="l00425"></a>00425             <a class="code" href="dmat_8h.html#108a4a2f57a5f271427d7af94a71abd8" title="multiply a X(mat) matrix with a vector and accumulate to y: y+=A*x*alpha">dmulvec</a>(gny, mtche[isa],ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,1.);
<a name="l00426"></a>00426             <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#2955dfacba62c468c7cc4028439c6eee" title="scale subaperture image to have the same intensity as i0.">mtchscl</a>){
<a name="l00427"></a>00427             <span class="keywordtype">double</span> scale=i0sum[isa]/<a class="code" href="dmat_8h.html#176e534c9042ace51d05a620a2294248" title="create sum of all the elements in A.">dsum</a>(ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa]);
<a name="l00428"></a>00428             <span class="comment">//info("scale wfs %d, isa %d by %g\n",iwfs,isa,scale);</span>
<a name="l00429"></a>00429             gny[0]*=scale;
<a name="l00430"></a>00430             gny[1]*=scale;
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432             <span class="keywordflow">break</span>;
<a name="l00433"></a>00433         <span class="keywordflow">case</span> 2:
<a name="l00434"></a>00434             pmax=<a class="code" href="dmat_8h.html#abb4fecd296ac9ec19263e0f9d853be7" title="find the maximum value of a X(mat) object">dmax</a>(ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa]);
<a name="l00435"></a>00435             <a class="code" href="dmat_8h.html#6531cfb8534d620420fbdf1deffb227c" title="Compute thresholded center of gravity.">dcog</a>(gny,ints-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[isa],0.,0.,0.1*pmax,0.1*pmax);
<a name="l00436"></a>00436             gny[0]*=pixtheta;
<a name="l00437"></a>00437             gny[1]*=pixtheta;
<a name="l00438"></a>00438             <span class="keywordflow">break</span>;
<a name="l00439"></a>00439         <span class="keywordflow">default</span>:
<a name="l00440"></a>00440             error(<span class="stringliteral">"Invalid"</span>);
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442     
<a name="l00443"></a>00443         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#df2e5e35af169d9d5e702ef4c42b7163" title="noisy or not during *simulation*">noisy</a>){
<a name="l00444"></a>00444             simu-&gt;<a class="code" href="structSIM__T.html#9fa58c6d12a9a59b829d2578c800ab20">sanea_sim</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa]+=pow(gny[0]-gnf[0],2);
<a name="l00445"></a>00445             simu-&gt;<a class="code" href="structSIM__T.html#9fa58c6d12a9a59b829d2578c800ab20">sanea_sim</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa+nsa]+=pow(gny[1]-gnf[1],2);
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beacabf44ba95b84fa2ec6b4460f5364" title="number of detector pixels along radial direction if radial CCD">radpix</a>){
<a name="l00448"></a>00448             <span class="comment">/*</span>
<a name="l00449"></a>00449 <span class="comment">              rotate gradients from ra to xy </span>
<a name="l00450"></a>00450 <span class="comment">              coordinate rotates cw by theta from ra to xy.</span>
<a name="l00451"></a>00451 <span class="comment">              therefore vector rotates ccw by theta.</span>
<a name="l00452"></a>00452 <span class="comment">              use standard R(theta)=[cos -sin; sin cos]</span>
<a name="l00453"></a>00453 <span class="comment">              |xnew|                 |x|</span>
<a name="l00454"></a>00454 <span class="comment">              |ynew|   =  R(theta) * |y|</span>
<a name="l00455"></a>00455 <span class="comment">            */</span>
<a name="l00456"></a>00456             <span class="keywordtype">double</span> theta;
<a name="l00457"></a>00457             theta=srot[isa]; 
<a name="l00458"></a>00458             
<a name="l00459"></a>00459             <span class="keyword">const</span> <span class="keywordtype">double</span> sth=sin(theta);
<a name="l00460"></a>00460             <span class="keyword">const</span> <span class="keywordtype">double</span> cth=cos(theta);
<a name="l00461"></a>00461             pgrad[0][isa]=gny[0]*cth-gny[1]*sth;
<a name="l00462"></a>00462             pgrad[1][isa]=gny[0]*sth+gny[1]*cth;
<a name="l00463"></a>00463         }<span class="keywordflow">else</span>{
<a name="l00464"></a>00464             <span class="comment">//already xy</span>
<a name="l00465"></a>00465             pgrad[0][isa]=gny[0];
<a name="l00466"></a>00466             pgrad[1][isa]=gny[1];
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468         };
<a name="l00469"></a>00469         <span class="keywordflow">if</span>(save_ints &amp;&amp; ints &amp;&amp; dtrat_output){
<a name="l00470"></a>00470         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(ints, <span class="stringliteral">"ints_%d/intsny_%d_wfs%d.bin"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>, isim,iwfs);
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>){
<a name="l00473"></a>00473         <span class="keywordflow">if</span>(!recon-&gt;<a class="code" href="structRECON__T.html#b2a067a798303d820f88872c07ffddf6">PTT</a> || !recon-&gt;<a class="code" href="structRECON__T.html#b2a067a798303d820f88872c07ffddf6">PTT</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs+iwfs*nwfs]){
<a name="l00474"></a>00474             warning(<span class="stringliteral">"powfs %d has llt, but TT removal is empty\n"</span>, 
<a name="l00475"></a>00475                 ipowfs);
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477         <span class="comment">/*LGS Uplink error*/</span>
<a name="l00478"></a>00478         <a class="code" href="dmat_8h.html#e98618064b54869b4180d0c7fd895645" title="initialize all numbers in a X(mat) object to 0">dzero</a>(simu-&gt;<a class="code" href="structSIM__T.html#bba8d28f43dad706c9d9669d409e5136">upterr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]);
<a name="l00479"></a>00479         <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#bba8d28f43dad706c9d9669d409e5136">upterr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], recon-&gt;<a class="code" href="structRECON__T.html#b2a067a798303d820f88872c07ffddf6">PTT</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs+iwfs*nwfs], 
<a name="l00480"></a>00480             simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], <span class="stringliteral">"nn"</span>, 1);
<a name="l00481"></a>00481         <span class="comment">//copy upterr to output.</span>
<a name="l00482"></a>00482         PDMAT(simu-&gt;<a class="code" href="structSIM__T.html#bfefb2f79338c2280a987cc512465ca5">upterrs</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], pupterrs);
<a name="l00483"></a>00483         pupterrs[isim][0]=simu-&gt;<a class="code" href="structSIM__T.html#bba8d28f43dad706c9d9669d409e5136">upterr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];
<a name="l00484"></a>00484         pupterrs[isim][1]=simu-&gt;<a class="code" href="structSIM__T.html#bba8d28f43dad706c9d9669d409e5136">upterr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1];
<a name="l00485"></a>00485     
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487      
<a name="l00488"></a>00488     }<span class="keywordflow">else</span> <span class="keywordflow">if</span> (dtrat_output &amp;&amp; !do_phy){
<a name="l00489"></a>00489         <span class="comment">//geomtric optics accumulation mode. copy results to output.</span>
<a name="l00490"></a>00490         <a class="code" href="dmat_8h.html#b5adc5cd1e79d9a79751ba482728f230" title="copy the values from one X(mat) to another.">dcp</a>(gradout,*gradacc);
<a name="l00491"></a>00491         <span class="keywordflow">if</span>(dtrat!=1)
<a name="l00492"></a>00492         <a class="code" href="dmat_8h.html#9a9da6ac02ccf42247a8a78a131ca73a" title="scale each element of A by w">dscale</a>(*gradout,1./dtrat);<span class="comment">//average</span>
<a name="l00493"></a>00493         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#df2e5e35af169d9d5e702ef4c42b7163" title="noisy or not during *simulation*">noisy</a>){
<a name="l00494"></a>00494         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a>){
<a name="l00495"></a>00495             info2(<span class="stringliteral">"Will not add noise at acquisition proccess for physical optics\n"</span>);
<a name="l00496"></a>00496         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d40a0a0fa416f92a27d2128a8653a578" title="use nea from physical optical precomputation in geometric simulations.">neaphy</a>){
<a name="l00497"></a>00497             <span class="keywordtype">double</span> *gg=(*gradout)-&gt;p;
<a name="l00498"></a>00498             <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *sanea=NULL;
<a name="l00499"></a>00499             <span class="keywordflow">if</span>(powfs[ipowfs].intstat-&gt;sanea-&gt;nx==1){
<a name="l00500"></a>00500             sanea=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#819af79d00b50193756b47c766425129">sanea</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0];
<a name="l00501"></a>00501             }<span class="keywordflow">else</span>{
<a name="l00502"></a>00502             sanea=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#819af79d00b50193756b47c766425129">sanea</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[indwfs];
<a name="l00503"></a>00503             }
<a name="l00504"></a>00504             <span class="keywordtype">double</span> *gn=sanea-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;<span class="comment">//rad^2;</span>
<a name="l00505"></a>00505             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa*2; isa++){
<a name="l00506"></a>00506             gg[isa]+=sqrt(gn[isa])*randn(&amp;simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>[iwfs]);
<a name="l00507"></a>00507             }
<a name="l00508"></a>00508         }<span class="keywordflow">else</span>{
<a name="l00509"></a>00509             <span class="keywordtype">double</span> neause=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#e43d6c16848ec5700bac72e327e2f7a1" title="NEA used in simulation.">neasim</a>;
<a name="l00510"></a>00510             <span class="keywordflow">if</span>(neause&lt;0){
<a name="l00511"></a>00511             neause=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ccdc5486d22fdd52e06600a7aeed71b5" title="NEA used in reconstruction.">nearecon</a>;
<a name="l00512"></a>00512             }
<a name="l00513"></a>00513             <span class="keywordtype">double</span> nea=neause/206265000./sqrt(dtrat);
<a name="l00514"></a>00514             <span class="keywordflow">if</span>(save_grad){
<a name="l00515"></a>00515             <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],
<a name="l00516"></a>00516                    <span class="stringliteral">"gradnf_%d/gradnf_iwfs%d_%d.bin.gz"</span>,
<a name="l00517"></a>00517                    simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,iwfs,isim);
<a name="l00518"></a>00518             }
<a name="l00519"></a>00519             <span class="keywordflow">if</span>(nea&gt;1.e-20){
<a name="l00520"></a>00520             <span class="comment">//info("Adding noise %g mas to geom grads\n", nea*206265000);</span>
<a name="l00521"></a>00521             <span class="keywordtype">double</span> *ggx=(*gradout)-&gt;p;
<a name="l00522"></a>00522             <span class="keywordtype">double</span> *ggy=(*gradout)-&gt;p+nsa;
<a name="l00523"></a>00523             <span class="keywordtype">double</span> *area=simu-&gt;<a class="code" href="structSIM__T.html#574e2dc6ebf0b42d7677c64eee329cac">powfs</a>[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>;
<a name="l00524"></a>00524             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00525"></a>00525                 <span class="comment">//scale nea by sqrt(1/area). (seeing limited)</span>
<a name="l00526"></a>00526                 <span class="comment">//scale nea by 1/area if diffraction limited (NGS)</span>
<a name="l00527"></a>00527                 <span class="keywordtype">double</span> neasc=nea*sqrt(1./area[isa]);
<a name="l00528"></a>00528                 ggx[isa]+=neasc*randn(&amp;simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>[iwfs]);
<a name="l00529"></a>00529                 ggy[isa]+=neasc*randn(&amp;simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>[iwfs]);
<a name="l00530"></a>00530             }
<a name="l00531"></a>00531             }<span class="keywordflow">else</span>{
<a name="l00532"></a>00532             warning(<span class="stringliteral">"powfs is noisy, but nea is 0"</span>);
<a name="l00533"></a>00533             }
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536     }
<a name="l00537"></a>00537     <span class="keywordflow">if</span>(dtrat_output &amp;&amp; save_gradgeom){
<a name="l00538"></a>00538         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *gradtmp=NULL;
<a name="l00539"></a>00539         <a class="code" href="dmat_8h.html#b5adc5cd1e79d9a79751ba482728f230" title="copy the values from one X(mat) to another.">dcp</a>(&amp;gradtmp,*gradacc);
<a name="l00540"></a>00540         <span class="keywordflow">if</span>(dtrat!=1){
<a name="l00541"></a>00541         <a class="code" href="dmat_8h.html#9a9da6ac02ccf42247a8a78a131ca73a" title="scale each element of A by w">dscale</a>(gradtmp,1./dtrat);
<a name="l00542"></a>00542         }
<a name="l00543"></a>00543         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(gradtmp,<span class="stringliteral">"gradgeom_%d/gradgeom_%d_wfs%d.bin"</span>,
<a name="l00544"></a>00544            simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,isim,iwfs);
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546     <span class="comment">/*</span>
<a name="l00547"></a>00547 <span class="comment">      if(dtrat_output){</span>
<a name="l00548"></a>00548 <span class="comment">      warning("WFS %d output\n",iwfs);</span>
<a name="l00549"></a>00549 <span class="comment">      }else{</span>
<a name="l00550"></a>00550 <span class="comment">      warning("WFS %d integrating\n",iwfs);</span>
<a name="l00551"></a>00551 <span class="comment">      }</span>
<a name="l00552"></a>00552 <span class="comment">    */</span>
<a name="l00553"></a>00553     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a>){
<a name="l00554"></a>00554         <a class="code" href="draw_8c.html#0aaab8cf8f5f9fa84865586e1f70722b" title="Plot opd*amp with coordinate loc.">drawopdamp</a>(<span class="stringliteral">"wfsopd"</span>,powfs[ipowfs].loc,opd-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>,
<a name="l00555"></a>00555                <span class="stringliteral">"WFS OPD"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y (m)"</span>, <span class="stringliteral">"WFS %d"</span>, iwfs);
<a name="l00556"></a>00556         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"Gclx"</span>,(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*)powfs[ipowfs].pts, 
<a name="l00557"></a>00557             simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 
<a name="l00558"></a>00558             <span class="stringliteral">"WFS Closeloop Gradients (x)"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y (m)"</span>,
<a name="l00559"></a>00559             <span class="stringliteral">"x %d"</span>,  iwfs);
<a name="l00560"></a>00560         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"Gcly"</span>,(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*)powfs[ipowfs].pts,
<a name="l00561"></a>00561             simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nsa, 
<a name="l00562"></a>00562             <span class="stringliteral">"WFS Closeloop Gradients (y)"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y (m)"</span>,
<a name="l00563"></a>00563             <span class="stringliteral">"y %d"</span>,  iwfs);
<a name="l00564"></a>00564     }
<a name="l00565"></a>00565     dfree(opd);
<a name="l00566"></a>00566     <span class="keywordflow">if</span>(dtrat_output &amp;&amp; powfs[ipowfs].ncpa_grad){
<a name="l00567"></a>00567         warning(<span class="stringliteral">"Applying ncpa_grad to gradout\n"</span>);
<a name="l00568"></a>00568         <a class="code" href="dmat_8h.html#4c4f53dc9572106deb6933eb103bf40b" title="compute B=bc*B+ac*A behavior changed on 2009-11-02.">dadd</a>(gradout, 1, powfs[ipowfs].ncpa_grad-&gt;p[indwfs], -1);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     <span class="comment">//create pseudo open loop gradients. in split mode 1, only do for high order wfs.</span>
<a name="l00571"></a>00571     <span class="keywordflow">if</span>((parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==2 || recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs]==0) &amp;&amp; dtrat_output){
<a name="l00572"></a>00572         <a class="code" href="dmat_8h.html#b5adc5cd1e79d9a79751ba482728f230" title="copy the values from one X(mat) to another.">dcp</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], *gradout);
<a name="l00573"></a>00573         <span class="keywordflow">if</span>(CL &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>){
<a name="l00574"></a>00574         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#af2fc0d68cf124447162f684585d5125">dmpsol</a>[ipowfs]){
<a name="l00575"></a>00575             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00576"></a>00576             <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], GA[idm][iwfs],
<a name="l00577"></a>00577                  simu-&gt;<a class="code" href="structSIM__T.html#af2fc0d68cf124447162f684585d5125">dmpsol</a>[ipowfs]-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm], 1.);
<a name="l00578"></a>00578             }
<a name="l00579"></a>00579         }
<a name="l00580"></a>00580         }
<a name="l00581"></a>00581         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a>){
<a name="l00582"></a>00582         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"Gpolx"</span>,(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*)powfs[ipowfs].pts,
<a name="l00583"></a>00583             simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00584"></a>00584             <span class="stringliteral">"WFS Pseudo Openloop Gradients (x)"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y (m)"</span>,
<a name="l00585"></a>00585             <span class="stringliteral">"x %d"</span>,  iwfs);
<a name="l00586"></a>00586         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"Gpoly"</span>,(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*)powfs[ipowfs].pts,
<a name="l00587"></a>00587             simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nsa, 
<a name="l00588"></a>00588             <span class="stringliteral">"WFS Pseudo Openloop Gradients (y)"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y (m)"</span>,
<a name="l00589"></a>00589             <span class="stringliteral">"y %d"</span>,  iwfs);
<a name="l00590"></a>00590         }
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592     <span class="keywordflow">if</span>(save_grad){
<a name="l00593"></a>00593         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],  <span class="stringliteral">"gradcl_%d/gradcl_%d_wfs%d.bin"</span>, 
<a name="l00594"></a>00594            simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>, simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>, iwfs);
<a name="l00595"></a>00595         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],<span class="stringliteral">"gradpsol_%d/gradpsol_%d_wfs%d.bin"</span>, 
<a name="l00596"></a>00596            simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>, simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>, iwfs);
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.pair &amp;&amp; recon-&gt;<a class="code" href="structRECON__T.html#55e2ed1c3bc81ac7c31078a40d814ddd" title="For Cn2 Estimation.">cn2est</a>-&gt;<a class="code" href="structCN2EST__T.html#a850f924c2584b577bee35105a7da7b4" title="Whether this wfs participates in covariance computation.">wfscov</a>[iwfs]){
<a name="l00599"></a>00599         cn2est_embed(recon-&gt;<a class="code" href="structRECON__T.html#55e2ed1c3bc81ac7c31078a40d814ddd" title="For Cn2 Estimation.">cn2est</a>, simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], iwfs);
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601     TIM(3);
<a name="l00602"></a>00602 <span class="preprocessor">#if TIMING==1</span>
<a name="l00603"></a>00603 <span class="preprocessor"></span>    info(<span class="stringliteral">"wfsgrad timing: %.2f %.2f %.2f\n"</span>,tk1-tk0,tk2-tk1,tk3-tk2);
<a name="l00604"></a>00604 <span class="preprocessor">#endif</span>
<a name="l00605"></a>00605 <span class="preprocessor"></span>    <span class="keywordflow">goto</span> repeat;
<a name="l00606"></a>00606     }<span class="comment">//iwfs</span>
<a name="l00607"></a>00607 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="99e7e23b2226afc767fc176f352f6e11"></a><!-- doxytag: member="wfsgrad.c::wfsgrad" ref="99e7e23b2226afc767fc176f352f6e11" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void wfsgrad           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calls <a class="el" href="wfsgrad_8c.html#26b10ff13c0cde04aacfd78ec795aaae" title="computes close loop and pseudo open loop gradidents for both gometric and physical...">wfsgrad_iwfs()</a> to computes WFS gradient in parallel. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00611"></a>00611                          {
<a name="l00612"></a>00612     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00613"></a>00613     <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00614"></a>00614     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#8c69a219924faa60ddf33137b2d35633" title="do DM fitting only, by replacing opdr with opdx.">fitonly</a>) <span class="keywordflow">return</span>;
<a name="l00615"></a>00615     <span class="comment">//Updating dmpsol averaging.</span>
<a name="l00616"></a>00616     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a>){
<a name="l00617"></a>00617     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00618"></a>00618         <span class="keywordtype">int</span> iwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#be03195a4e1fece4903a6297931ac09c" title="array of wfs belongs to this powfs">wfs</a>[0];
<a name="l00619"></a>00619         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==2 || recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs]==0){
<a name="l00620"></a>00620         <span class="keyword">const</span> <span class="keywordtype">int</span> dtrat=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00621"></a>00621         <span class="keywordflow">if</span>(dtrat==1 || simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>%dtrat==0){
<a name="l00622"></a>00622             dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#af2fc0d68cf124447162f684585d5125">dmpsol</a>[ipowfs]);
<a name="l00623"></a>00623             <span class="comment">//info("Freeing dmpsol for powfs %d\n", ipowfs);</span>
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmpsol;
<a name="l00626"></a>00626         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#db4659b6270e082c56fc70db6d1f24da" title="test add dm command offseted by 1 frame in the future to psol grad">psol</a>){
<a name="l00627"></a>00627             <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00628"></a>00628             dmpsol=simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>[0];
<a name="l00629"></a>00629             }<span class="keywordflow">else</span>{
<a name="l00630"></a>00630             dmpsol=simu-&gt;<a class="code" href="structSIM__T.html#bddc06629ca1d3fd07bba2db8e50be47">dmint_hi</a>[0];
<a name="l00631"></a>00631             }
<a name="l00632"></a>00632             <span class="comment">//warning("Using dmreal next step for psol\n");</span>
<a name="l00633"></a>00633         }<span class="keywordflow">else</span>{<span class="comment">//add DM command for the same time step.</span>
<a name="l00634"></a>00634             dmpsol=simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>;
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636         <span class="comment">//info("Accumulating dmpsol for powfs %d\n", ipowfs);</span>
<a name="l00637"></a>00637         dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#af2fc0d68cf124447162f684585d5125">dmpsol</a>[ipowfs], 1, dmpsol, 1./parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>);
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641     simu-&gt;<a class="code" href="structSIM__T.html#e58d71938f9fa82ce8088e07c98c3da9">wfsgrad_iwfs</a>=0;<span class="comment">//start from 0.</span>
<a name="l00642"></a>00642     CALL(<a class="code" href="wfsgrad_8c.html#26b10ff13c0cde04aacfd78ec795aaae" title="computes close loop and pseudo open loop gradidents for both gometric and physical...">wfsgrad_iwfs</a>,simu,recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);<span class="comment">//no splace allowd</span>
<a name="l00643"></a>00643   
<a name="l00644"></a>00644     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#7b62e7127ef7c49d9dda1a7d1f4c7910" title="number of pairs of gradient covariance to compute">ngcov</a>&gt;0){
<a name="l00645"></a>00645     <span class="comment">//Outputing psol gradient covariance.</span>
<a name="l00646"></a>00646     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> igcov=0; igcov&lt;parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#7b62e7127ef7c49d9dda1a7d1f4c7910" title="number of pairs of gradient covariance to compute">ngcov</a>; igcov++){
<a name="l00647"></a>00647         <span class="keywordtype">int</span> iwfs1=parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#91f7f5d1d1d97dbf460ffbf4f951837c" title="size of 2*ngcov, specifying wfs for each pair">gcov</a>[igcov*2];
<a name="l00648"></a>00648         <span class="keywordtype">int</span> iwfs2=parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#91f7f5d1d1d97dbf460ffbf4f951837c" title="size of 2*ngcov, specifying wfs for each pair">gcov</a>[igcov*2+1];
<a name="l00649"></a>00649         info(<span class="stringliteral">"Computing covariance between wfs %d and %d\n"</span>,iwfs1,iwfs2);
<a name="l00650"></a>00650         <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#a627421bfd2a0fa6b2c746463f075bef">gcov</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[igcov], simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs1], simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs2],<span class="stringliteral">"nt"</span>,1);
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.pair){
<a name="l00654"></a>00654     <a class="code" href="structCN2EST__T.html" title="contains the data related to Cn2 Estimation.">CN2EST_T</a> *cn2est=recon-&gt;<a class="code" href="structRECON__T.html#55e2ed1c3bc81ac7c31078a40d814ddd" title="For Cn2 Estimation.">cn2est</a>;
<a name="l00655"></a>00655     cn2est_cov(cn2est);<span class="comment">//convert gradients to cross covariance.</span>
<a name="l00656"></a>00656     <span class="keywordflow">if</span>((simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>+1-parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>)%parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.step == 0){
<a name="l00657"></a>00657         <a class="code" href="sim__utils_8c.html#6788ee66ba9c555c2fe1b7ffba18e7b0" title="Scale a dcell array and save to file.">dcell_mean_and_save</a>(cn2est-&gt;<a class="code" href="structCN2EST__T.html#41c72d0b41e56502208472d188f5d9e2" title="cross-covariance for each pair">cc</a>, 1./cn2est-&gt;<a class="code" href="structCN2EST__T.html#25d588de096f76f5128204cec01d0d80" title="number of time steps we have accumulated the covariance">nstep</a>, <span class="stringliteral">"cc_%d"</span>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>+1);
<a name="l00658"></a>00658         cn2est_est(cn2est, parms);<span class="comment">//do the CN2 estimation</span>
<a name="l00659"></a>00659         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.moveht){
<a name="l00660"></a>00660         cn2est_moveht(recon);
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#bc0c4384664b89b6777b64d77f18a0bc" title="Parameters for Cn2 estimation.">cn2</a>.tomo){
<a name="l00663"></a>00663         cn2est_updatetomo(recon,parms);
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     }<span class="comment">//if cn2est</span>
<a name="l00667"></a>00667 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 21:16:58 2010 for maos-0.7.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
