<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.6.1: maos/ahst.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/ahst.c File Reference</h1>Contains functions to setup NGS modes and reconstructor using AHST for one or two DMs.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#1d776ee51ff021d1842de5de8a004dc5">ngsmod_nmod</a> (int ndm)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compute number of ahst modes from number of DMs.  <a href="#1d776ee51ff021d1842de5de8a004dc5"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structdmat.html">dmat</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#e3448a34b3f6452515a74d17b770c52f">ngsmod_mcc</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structAPER__T.html">APER_T</a> *aper, const double *wt)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">computes the cross-coupling of NGS modes in science field.  <a href="#e3448a34b3f6452515a74d17b770c52f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structspcell.html">spcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#93a5f84318748435a67e0d7d3c4b228e">ngsmod_Wa</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structAPER__T.html">APER_T</a> *aper, int use_ploc)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compute NGS mode aperture weighting using science field.  <a href="#93a5f84318748435a67e0d7d3c4b228e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#7851621262fbc9e1d6bc1019c61bb139">ngsmod_Pngs_Wa</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structAPER__T.html">APER_T</a> *aper, int use_ploc)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">compute NGS mode removal from LGS commands using aperture weighting.  <a href="#7851621262fbc9e1d6bc1019c61bb139"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#e3113f442d824e6b7ffcc6ffe4d16361">ngsmod_Ptt_Wa</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structAPER__T.html">APER_T</a> *aper, int use_ploc)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">compute NGS mode removal from LGS commands using aperture weighting.  <a href="#e3113f442d824e6b7ffcc6ffe4d16361"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#d785d41e2aa4c2b2d4be48f52d4b37c3">ngsmod_m</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">DM modes for all the low order modes.  <a href="#d785d41e2aa4c2b2d4be48f52d4b37c3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#33d002b5a06f58a3b7b4b07a1f0f3b3d">ngsmod_g</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">from ngsmod to ztilt/gtilt gradients using GA  <a href="#33d002b5a06f58a3b7b4b07a1f0f3b3d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structdcell.html">dcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#7e3cbb7965f524ef7ab5c63a90466abd">ngsmod_hm_accphi</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structAPER__T.html">APER_T</a> *aper)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compute NGS modes Ha*M in the science directon using ray tracing.  <a href="#7e3cbb7965f524ef7ab5c63a90466abd"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structdcell.html">dcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#f38907f48ddcb69345df2d5ef6ecc615">ngsmod_hm_ana</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structAPER__T.html">APER_T</a> *aper)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compute NGS modes Ha*M in the science directon using analytic formula.  <a href="#f38907f48ddcb69345df2d5ef6ecc615"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#55c65679c193d90bc7f5175ebb17733f">setup_ngsmod</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, <a class="el" href="structAPER__T.html">APER_T</a> *aper, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">setup NGS modes and reconstructor using AHST for one or two DMs.  <a href="#55c65679c193d90bc7f5175ebb17733f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#bad45266bd29e9426cdbb40322c78c38">calc_ngsmod_dot</a> (double *pttr_out, double *pttrcoeff_out, double *ngsmod_out, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structAPER__T.html">APER_T</a> *aper, const double *opd, int ievl)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">used in performance evaluation on science opds.  <a href="#bad45266bd29e9426cdbb40322c78c38"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#3d2a474cd4a6fcebb9e1ff8f26855353">ngsmod2dm</a> (<a class="el" href="structdcell.html">dcell</a> **dmc, const <a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structdcell.html">dcell</a> *M, double gain)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Convert NGS modes to DM actuator commands using analytical expression.  <a href="#3d2a474cd4a6fcebb9e1ff8f26855353"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ahst_8c.html#23e700bf65ab8561bd8ff2f43cf0982d">ngsmod2science</a> (<a class="el" href="structdmat.html">dmat</a> *iopdevl, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structAPER__T.html">APER_T</a> *aper, const <a class="el" href="structdcell.html">dcell</a> *M, int ievl, double gain)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Convert NGS mode vector to aperture grid for science directions.  <a href="#23e700bf65ab8561bd8ff2f43cf0982d"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Contains functions to setup NGS modes and reconstructor using AHST for one or two DMs. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="1d776ee51ff021d1842de5de8a004dc5"></a><!-- doxytag: member="ahst.c::ngsmod_nmod" ref="1d776ee51ff021d1842de5de8a004dc5" args="(int ndm)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int ngsmod_nmod           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ndm</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Compute number of ahst modes from number of DMs. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00037"></a>00037                                {
<a name="l00038"></a>00038     <span class="keywordtype">int</span> nmod=0;
<a name="l00039"></a>00039     <span class="keywordflow">if</span>(ndm==1)
<a name="l00040"></a>00040     nmod=2;
<a name="l00041"></a>00041     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ndm==2)
<a name="l00042"></a>00042     nmod=5;
<a name="l00043"></a>00043     <span class="keywordflow">else</span>
<a name="l00044"></a>00044     error(<span class="stringliteral">"Invalid ndm: %d\n"</span>,ndm);
<a name="l00045"></a>00045     <span class="keywordflow">return</span> nmod;
<a name="l00046"></a>00046 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="e3448a34b3f6452515a74d17b770c52f"></a><!-- doxytag: member="ahst.c::ngsmod_mcc" ref="e3448a34b3f6452515a74d17b770c52f" args="(const PARMS_T *parms, RECON_T *recon, APER_T *aper, const double *wt)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structdmat.html">dmat</a>* ngsmod_mcc           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>wt</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
computes the cross-coupling of NGS modes in science field. 
<p>
MCC=(M'*Ha'*W*Ha*M) where M is ngsmod on DM, Ha is propagator from DM to science. W is weighting in science. <div class="fragment"><pre class="fragment"><a name="l00053"></a>00053                                                                                              {
<a name="l00054"></a>00054 
<a name="l00055"></a>00055     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>;
<a name="l00056"></a>00056     <span class="keywordtype">double</span> *x, *y;
<a name="l00057"></a>00057     <span class="keywordtype">int</span> nloc;
<a name="l00058"></a>00058     <span class="keywordtype">double</span> *amp=NULL;
<a name="l00059"></a>00059   
<a name="l00060"></a>00060     <span class="keyword">const</span> <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *plocs=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>;
<a name="l00061"></a>00061     x=plocs-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00062"></a>00062     y=plocs-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00063"></a>00063     nloc=plocs-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00064"></a>00064     amp=aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>;
<a name="l00065"></a>00065     
<a name="l00066"></a>00066     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *mcc=NULL;
<a name="l00067"></a>00067     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>==1){
<a name="l00068"></a>00068     <span class="comment">//Single conjugate. low order WFS only controls Tip/tilt</span>
<a name="l00069"></a>00069     mcc=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(2,2);
<a name="l00070"></a>00070     PDMAT(mcc,MCC);
<a name="l00071"></a>00071     PDMAT(aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>,aMCC);
<a name="l00072"></a>00072     <span class="comment">//not yet available in ngsmod</span>
<a name="l00073"></a>00073     MCC[0][0]=aMCC[1][1];
<a name="l00074"></a>00074     MCC[1][1]=aMCC[2][2];
<a name="l00075"></a>00075     MCC[1][0]=MCC[0][1]=aMCC[1][2];
<a name="l00076"></a>00076     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>==2){
<a name="l00077"></a>00077     <span class="keywordtype">double</span> *mod[5];
<a name="l00078"></a>00078     mcc=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(5,5);
<a name="l00079"></a>00079     PDMAT(mcc,MCC);
<a name="l00080"></a>00080     <span class="comment">//not yet available in ngsmod</span>
<a name="l00081"></a>00081     mod[0]=x;
<a name="l00082"></a>00082     mod[1]=y;
<a name="l00083"></a>00083     PDMAT(aper-&gt;<a class="code" href="structAPER__T.html#8dff9e2a536914fd7cf76bc77aa8c674" title="piston/tip/tilt mode cross-coupling.">mcc</a>,aMCC);
<a name="l00084"></a>00084     MCC[0][0]=aMCC[1][1];
<a name="l00085"></a>00085     MCC[1][1]=aMCC[2][2];
<a name="l00086"></a>00086     MCC[1][0]=MCC[0][1]=aMCC[1][2];
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     mod[2]=malloc(nloc*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00089"></a>00089     mod[3]=malloc(nloc*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00090"></a>00090     mod[4]=malloc(nloc*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00091"></a>00091     <span class="keyword">const</span> <span class="keywordtype">double</span> MCC_fcp=aper-&gt;<a class="code" href="structAPER__T.html#f051a7aef05263d8ee294756d19e9f0d" title="piston correction in focus term.">fcp</a>;
<a name="l00092"></a>00092     <span class="comment">//dc component of the focus mod. subtract during evaluation.</span>
<a name="l00093"></a>00093     <span class="comment">//this is not precisely R^2/2 due to obscuration</span>
<a name="l00094"></a>00094     <span class="keyword">const</span> <span class="keywordtype">double</span> ht=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>;
<a name="l00095"></a>00095     <span class="keyword">const</span> <span class="keywordtype">double</span> scale=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#04fe94fcd2b18eb124a0e5b1170d9387">scale</a>;
<a name="l00096"></a>00096     <span class="keyword">const</span> <span class="keywordtype">double</span> scale1=1.-scale;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00099"></a>00099         <span class="keywordflow">if</span>(fabs(wt[ievl])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l00100"></a>00100         <span class="keywordtype">double</span> thetax=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl];
<a name="l00101"></a>00101         <span class="keywordtype">double</span> thetay=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl];
<a name="l00102"></a>00102     
<a name="l00103"></a>00103         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00104"></a>00104         <span class="keywordtype">double</span> xx=x[iloc]*x[iloc];
<a name="l00105"></a>00105         <span class="keywordtype">double</span> xy=x[iloc]*y[iloc];
<a name="l00106"></a>00106         <span class="keywordtype">double</span> yy=y[iloc]*y[iloc];
<a name="l00107"></a>00107         <span class="comment">//remove piston in focus</span>
<a name="l00108"></a>00108         mod[2][iloc]=scale1*(xx+yy-MCC_fcp)
<a name="l00109"></a>00109             -2.*ht*scale*(thetax*x[iloc]+thetay*y[iloc]);
<a name="l00110"></a>00110         mod[3][iloc]=scale1*(xx-yy)
<a name="l00111"></a>00111             -2.*ht*scale*(thetax*x[iloc]-thetay*y[iloc]);
<a name="l00112"></a>00112         mod[4][iloc]=scale1*(xy)
<a name="l00113"></a>00113             -ht*scale*(thetay*x[iloc]+thetax*y[iloc]);
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jmod=0; jmod&lt;5; jmod++){
<a name="l00116"></a>00116         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imod=jmod; imod&lt;5; imod++){
<a name="l00117"></a>00117             <span class="keywordflow">if</span>(imod&lt;2&amp;&amp;jmod&lt;2) <span class="keywordflow">continue</span>;
<a name="l00118"></a>00118             <span class="keywordtype">double</span> tmp=<a class="code" href="mathmisc_8c.html#1642051eb049131a4dd20a4585f80d98" title="compute sum(p1.">dotdbl</a>(mod[imod],mod[jmod],amp,nloc);
<a name="l00119"></a>00119             MCC[imod][jmod]+=wt[ievl]*tmp;
<a name="l00120"></a>00120             <span class="keywordflow">if</span>(imod!=jmod)
<a name="l00121"></a>00121             MCC[jmod][imod]=MCC[imod][jmod];
<a name="l00122"></a>00122         }
<a name="l00123"></a>00123         }
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imod=2; imod&lt;5; imod++){
<a name="l00126"></a>00126         free(mod[imod]);
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129  
<a name="l00130"></a>00130     <span class="keywordflow">return</span> mcc;
<a name="l00131"></a>00131 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="93a5f84318748435a67e0d7d3c4b228e"></a><!-- doxytag: member="ahst.c::ngsmod_Wa" ref="93a5f84318748435a67e0d7d3c4b228e" args="(const PARMS_T *parms, RECON_T *recon, APER_T *aper, int use_ploc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structspcell.html">spcell</a>* ngsmod_Wa           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>use_ploc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Compute NGS mode aperture weighting using science field. 
<p>
Wa=Ha'*W*Ha where Ha is from ALOC to PLOCS and W is the amplitude weighting in PLOCS when use_ploc==0. Otherwise, Ha is from ALOC to PLOC and W is the amplitude weighting in PLOC. <div class="fragment"><pre class="fragment"><a name="l00138"></a>00138                                         {
<a name="l00139"></a>00139     <span class="keyword">const</span> <span class="keywordtype">double</span> *wt=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#1099d0a05e59fced8655347bbb50b9c8" title="weight of each direction">wt</a>;
<a name="l00140"></a>00140     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00141"></a>00141     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc;
<a name="l00142"></a>00142     <span class="keywordtype">double</span> *amp=NULL;
<a name="l00143"></a>00143     <span class="keywordflow">if</span>(use_ploc){
<a name="l00144"></a>00144     loc=recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>;
<a name="l00145"></a>00145     amp=calloc(loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00146"></a>00146     <a class="code" href="accphi_8c.html#71a4a35bc06d7a2db0d995da3da4f1c0" title="the following routine is used to do down sampling by doing *reverse* ray tracing...">prop_nongrid_reverse</a>(loc,amp,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>, aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,1,0,0,1);
<a name="l00147"></a>00147     <a class="code" href="mathmisc_8c.html#c80bb740d5184ab44318b505ee66d13b" title="normalize vector to sum to norm;">normalize</a>(amp,loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,1);
<a name="l00148"></a>00148     }<span class="keywordflow">else</span>{
<a name="l00149"></a>00149     amp=aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>;
<a name="l00150"></a>00150     loc=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>;
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *Wa=NULL;
<a name="l00153"></a>00153     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00154"></a>00154     <span class="keywordflow">if</span>(fabs(wt[ievl])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l00155"></a>00155     <span class="keywordtype">double</span> thetax=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl];
<a name="l00156"></a>00156     <span class="keywordtype">double</span> thetay=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl];
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *Hat=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(ndm,1);
<a name="l00159"></a>00159     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *Ha=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(1,ndm);
<a name="l00160"></a>00160     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00161"></a>00161         <span class="keywordtype">double</span> hc = parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00162"></a>00162         <span class="keywordtype">double</span> displacex=thetax*hc;
<a name="l00163"></a>00163         <span class="keywordtype">double</span> displacey=thetay*hc;
<a name="l00164"></a>00164         <span class="comment">//from DM to ploc (plocs) science beam</span>
<a name="l00165"></a>00165         Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]=<a class="code" href="mkh_8c.html#8d6ae4511d18adfbb15f19ae6873738e" title="Create the transpose of the interpolator matrix for from locin to locout.">mkhb</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], loc, NULL, 
<a name="l00166"></a>00166                  displacex,displacey,1.,0);
<a name="l00167"></a>00167         Ha-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]=<a class="code" href="dsp_8h.html#c8975e7b8152e52b2c8cd8e785c25310" title="Transpose a sparse array.">sptrans</a>(Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]);
<a name="l00168"></a>00168         <a class="code" href="dsp_8h.html#86006ab127b4b047f9a78d567be1aae8" title="Multiply a X(sp) matrix inplace with a diagonal weighting matrix whose diagonal values...">spmuldiag</a>(Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm], amp, wt[ievl]);
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *HatHai=<a class="code" href="dsp_8h.html#5ba25787c1b6292d42da40d941cea273" title="Multiply two sparse cell.">spcellmulspcell</a>(Hat,Ha,1);
<a name="l00171"></a>00171     <a class="code" href="dsp_8h.html#50a4c44bf6e5fdbc087a94fa815ed94a" title="Add a sparse cell to another: A0=A0+B.">spcelladd</a>(&amp;Wa, HatHai);
<a name="l00172"></a>00172     <span class="comment">/*</span>
<a name="l00173"></a>00173 <span class="comment">    for(int idm=0; idm&lt;ndm*ndm; idm++){</span>
<a name="l00174"></a>00174 <span class="comment">        spfull(&amp;(Wa-&gt;p[idm]), HatHai-&gt;p[idm], 1);</span>
<a name="l00175"></a>00175 <span class="comment">        }*/</span>
<a name="l00176"></a>00176     spcellfree(Hat);
<a name="l00177"></a>00177     spcellfree(Ha);
<a name="l00178"></a>00178     spcellfree(HatHai);
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180     <span class="keywordflow">if</span>(use_ploc){
<a name="l00181"></a>00181     free(amp);
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183     <span class="keywordflow">return</span> Wa;
<a name="l00184"></a>00184 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7851621262fbc9e1d6bc1019c61bb139"></a><!-- doxytag: member="ahst.c::ngsmod_Pngs_Wa" ref="7851621262fbc9e1d6bc1019c61bb139" args="(const PARMS_T *parms, RECON_T *recon, APER_T *aper, int use_ploc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structdcell.html">dcell</a>* ngsmod_Pngs_Wa           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>use_ploc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
compute NGS mode removal from LGS commands using aperture weighting. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00188"></a>00188                                         {
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>;
<a name="l00191"></a>00191     <span class="keyword">const</span> <span class="keywordtype">double</span> ht=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>;
<a name="l00192"></a>00192     <span class="keyword">const</span> <span class="keywordtype">double</span> scale=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#04fe94fcd2b18eb124a0e5b1170d9387">scale</a>;
<a name="l00193"></a>00193     <span class="keyword">const</span> <span class="keywordtype">double</span> scale1=1.-scale;
<a name="l00194"></a>00194     <span class="keyword">const</span> <span class="keywordtype">double</span> *wt=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#1099d0a05e59fced8655347bbb50b9c8" title="weight of each direction">wt</a>;
<a name="l00195"></a>00195     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00196"></a>00196     <span class="keyword">const</span> <span class="keywordtype">int</span> nmod=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>;
<a name="l00197"></a>00197     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc;
<a name="l00198"></a>00198     <span class="keywordtype">double</span> *x, *y;
<a name="l00199"></a>00199     <span class="keywordtype">int</span> nloc;
<a name="l00200"></a>00200     <span class="keywordtype">double</span> *amp=NULL;
<a name="l00201"></a>00201     <span class="keywordflow">if</span>(use_ploc){
<a name="l00202"></a>00202     loc=recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>;
<a name="l00203"></a>00203     amp=calloc(loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00204"></a>00204     <a class="code" href="accphi_8c.html#71a4a35bc06d7a2db0d995da3da4f1c0" title="the following routine is used to do down sampling by doing *reverse* ray tracing...">prop_nongrid_reverse</a>(loc,amp,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,
<a name="l00205"></a>00205                  aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,1,0,0,1);
<a name="l00206"></a>00206     <a class="code" href="mathmisc_8c.html#c80bb740d5184ab44318b505ee66d13b" title="normalize vector to sum to norm;">normalize</a>(amp,loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,1);
<a name="l00207"></a>00207     }<span class="keywordflow">else</span>{
<a name="l00208"></a>00208     amp=aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>;
<a name="l00209"></a>00209     loc=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>;
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211     x=loc-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00212"></a>00212     y=loc-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00213"></a>00213     nloc=loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *modc=dcellnew(1,1);<span class="comment">//W*Hm*M</span>
<a name="l00216"></a>00216     modc-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,nmod);
<a name="l00217"></a>00217     PDMAT(modc-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0],mod);
<a name="l00218"></a>00218     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00219"></a>00219     mod[0][iloc]=x[iloc]*amp[iloc];
<a name="l00220"></a>00220     mod[1][iloc]=y[iloc]*amp[iloc];
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     <span class="keyword">const</span> <span class="keywordtype">double</span> MCC_fcp=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#9980921108b4ea0d7f6ebafa6686304f">aper_fcp</a>;
<a name="l00223"></a>00223     <span class="comment">//dc component of the focus mod. subtract during evaluation.</span>
<a name="l00224"></a>00224     <span class="comment">//this is not precisely R^2/2 due to obscuration</span>
<a name="l00225"></a>00225     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *HatWHmt=dcellnew(ndm,1);
<a name="l00226"></a>00226     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *HatGround=NULL;
<a name="l00227"></a>00227     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00228"></a>00228     <span class="keywordflow">if</span>(fabs(wt[ievl])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l00229"></a>00229     <span class="keywordtype">double</span> thetax=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl];
<a name="l00230"></a>00230     <span class="keywordtype">double</span> thetay=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl];
<a name="l00231"></a>00231     <span class="keywordflow">if</span>(nmod==5){
<a name="l00232"></a>00232         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00233"></a>00233         <span class="keywordtype">double</span> xx=x[iloc]*x[iloc];
<a name="l00234"></a>00234         <span class="keywordtype">double</span> xy=x[iloc]*y[iloc];
<a name="l00235"></a>00235         <span class="keywordtype">double</span> yy=y[iloc]*y[iloc];
<a name="l00236"></a>00236         <span class="comment">//remove piston in focus</span>
<a name="l00237"></a>00237         mod[2][iloc]=amp[iloc]
<a name="l00238"></a>00238             *(scale1*(xx+yy-MCC_fcp)
<a name="l00239"></a>00239               -2.*ht*scale*(thetax*x[iloc]+thetay*y[iloc]));
<a name="l00240"></a>00240         mod[3][iloc]=amp[iloc]
<a name="l00241"></a>00241             *(scale1*(xx-yy)
<a name="l00242"></a>00242               -2.*ht*scale*(thetax*x[iloc]-thetay*y[iloc]));
<a name="l00243"></a>00243         mod[4][iloc]=amp[iloc]
<a name="l00244"></a>00244             *(scale1*(xy)
<a name="l00245"></a>00245               -ht*scale*(thetay*x[iloc]+thetax*y[iloc]));
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *Hat=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(ndm,1);
<a name="l00249"></a>00249     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00250"></a>00250         <span class="keywordtype">double</span> hc = parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00251"></a>00251         <span class="keywordtype">double</span> displacex=thetax*hc;
<a name="l00252"></a>00252         <span class="keywordtype">double</span> displacey=thetay*hc;
<a name="l00253"></a>00253         <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#b3eca0a0f00d7e45fb842d4a8dace867" title="Is this DM the ground DM (derived).">isground</a> || !HatGround){
<a name="l00254"></a>00254         <span class="comment">//from DM to ploc (plocs) science beam</span>
<a name="l00255"></a>00255         Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]=<a class="code" href="mkh_8c.html#8d6ae4511d18adfbb15f19ae6873738e" title="Create the transpose of the interpolator matrix for from locin to locout.">mkhb</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], loc, NULL, 
<a name="l00256"></a>00256                  displacex,displacey,1.,0);
<a name="l00257"></a>00257         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#b3eca0a0f00d7e45fb842d4a8dace867" title="Is this DM the ground DM (derived).">isground</a>){
<a name="l00258"></a>00258             HatGround=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]);
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260         }<span class="keywordflow">else</span>{
<a name="l00261"></a>00261         Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(HatGround);
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;HatWHmt,Hat,modc,wt[ievl]);
<a name="l00265"></a>00265     spcellfree(Hat);
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *IMCC=dcellnew(1,1);
<a name="l00268"></a>00268     IMCC-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#9109e1451b9bd21e3f5bc5d284caa591">IMCC</a>);
<a name="l00269"></a>00269     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Pngs=NULL;
<a name="l00270"></a>00270     dcellmm(&amp;Pngs,IMCC,HatWHmt,<span class="stringliteral">"nt"</span>,1);
<a name="l00271"></a>00271     dcellfree(IMCC);
<a name="l00272"></a>00272     dcellfree(modc);
<a name="l00273"></a>00273     <span class="keywordflow">if</span>(use_ploc){
<a name="l00274"></a>00274     free(amp);
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276     dcellfree(HatWHmt);
<a name="l00277"></a>00277     <span class="keywordflow">return</span> Pngs;
<a name="l00278"></a>00278 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="e3113f442d824e6b7ffcc6ffe4d16361"></a><!-- doxytag: member="ahst.c::ngsmod_Ptt_Wa" ref="e3113f442d824e6b7ffcc6ffe4d16361" args="(const PARMS_T *parms, RECON_T *recon, APER_T *aper, int use_ploc)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structdcell.html">dcell</a>* ngsmod_Ptt_Wa           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>use_ploc</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
compute NGS mode removal from LGS commands using aperture weighting. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00282"></a>00282                                            {
<a name="l00283"></a>00283     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>;
<a name="l00284"></a>00284     <span class="keyword">const</span> <span class="keywordtype">double</span> *wt=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#1099d0a05e59fced8655347bbb50b9c8" title="weight of each direction">wt</a>;
<a name="l00285"></a>00285     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00286"></a>00286     <span class="keyword">const</span> <span class="keywordtype">int</span> nmod=2;
<a name="l00287"></a>00287     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc;
<a name="l00288"></a>00288     <span class="keywordtype">double</span> *x, *y;
<a name="l00289"></a>00289     <span class="keywordtype">int</span> nloc;
<a name="l00290"></a>00290     <span class="keywordtype">double</span> *amp=NULL;
<a name="l00291"></a>00291     <span class="keywordflow">if</span>(use_ploc){
<a name="l00292"></a>00292     loc=recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>;
<a name="l00293"></a>00293     amp=calloc(loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00294"></a>00294     <a class="code" href="accphi_8c.html#71a4a35bc06d7a2db0d995da3da4f1c0" title="the following routine is used to do down sampling by doing *reverse* ray tracing...">prop_nongrid_reverse</a>(loc,amp,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,
<a name="l00295"></a>00295                  aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>,1,0,0,1);
<a name="l00296"></a>00296     <a class="code" href="mathmisc_8c.html#c80bb740d5184ab44318b505ee66d13b" title="normalize vector to sum to norm;">normalize</a>(amp,loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,1);
<a name="l00297"></a>00297     }<span class="keywordflow">else</span>{
<a name="l00298"></a>00298     amp=aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>;
<a name="l00299"></a>00299     loc=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301     x=loc-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00302"></a>00302     y=loc-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00303"></a>00303     nloc=loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *modc=dcellnew(1,1);<span class="comment">//W*Hm*M</span>
<a name="l00306"></a>00306     modc-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,nmod);
<a name="l00307"></a>00307     PDMAT(modc-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0],mod);
<a name="l00308"></a>00308     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00309"></a>00309     mod[0][iloc]=x[iloc]*amp[iloc];
<a name="l00310"></a>00310     mod[1][iloc]=y[iloc]*amp[iloc];
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *HatWHmt=dcellnew(ndm,1);
<a name="l00313"></a>00313     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *HatGround=NULL;
<a name="l00314"></a>00314     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00315"></a>00315     <span class="keywordflow">if</span>(fabs(wt[ievl])&lt;1.e-12) <span class="keywordflow">continue</span>;
<a name="l00316"></a>00316     <span class="keywordtype">double</span> thetax=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl];
<a name="l00317"></a>00317     <span class="keywordtype">double</span> thetay=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl];
<a name="l00318"></a>00318     <a class="code" href="structspcell.html" title="an 2-d array of sparse.">spcell</a> *Hat=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(ndm,1);
<a name="l00319"></a>00319     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00320"></a>00320         <span class="keywordtype">double</span> hc = parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00321"></a>00321         <span class="keywordtype">double</span> displacex=thetax*hc;
<a name="l00322"></a>00322         <span class="keywordtype">double</span> displacey=thetay*hc;
<a name="l00323"></a>00323         <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#b3eca0a0f00d7e45fb842d4a8dace867" title="Is this DM the ground DM (derived).">isground</a> || !HatGround){
<a name="l00324"></a>00324         <span class="comment">//from DM to ploc (plocs) science beam</span>
<a name="l00325"></a>00325         Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]=<a class="code" href="mkh_8c.html#8d6ae4511d18adfbb15f19ae6873738e" title="Create the transpose of the interpolator matrix for from locin to locout.">mkhb</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], loc, NULL, 
<a name="l00326"></a>00326                  displacex,displacey,1.,0);
<a name="l00327"></a>00327         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#b3eca0a0f00d7e45fb842d4a8dace867" title="Is this DM the ground DM (derived).">isground</a>){
<a name="l00328"></a>00328             HatGround=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]);
<a name="l00329"></a>00329         }
<a name="l00330"></a>00330         }<span class="keywordflow">else</span>{
<a name="l00331"></a>00331         Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm]=<a class="code" href="dsp_8h.html#1d8ab659242097d58923075d276a6f91" title="reference a sparse object.">spref</a>(HatGround);
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333         <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;HatWHmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm],Hat-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm],modc-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0],wt[ievl]);
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335     spcellfree(Hat);
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *IMCC=dcellnew(1,1);
<a name="l00338"></a>00338     IMCC-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#b75976d620d5c445e308977b3fdb6c6b">IMCC_TT</a>);
<a name="l00339"></a>00339     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Ptt=dcellnew(ndm,1);
<a name="l00340"></a>00340     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00341"></a>00341     <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;(Ptt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]),IMCC-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0],HatWHmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm],<span class="stringliteral">"nt"</span>,1);
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343     dcellfree(IMCC);
<a name="l00344"></a>00344     dcellfree(modc);
<a name="l00345"></a>00345     <span class="keywordflow">if</span>(use_ploc){
<a name="l00346"></a>00346     free(amp);
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348     dcellfree(HatWHmt);
<a name="l00349"></a>00349     <span class="keywordflow">return</span> Ptt;
<a name="l00350"></a>00350 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="d785d41e2aa4c2b2d4be48f52d4b37c3"></a><!-- doxytag: member="ahst.c::ngsmod_m" ref="d785d41e2aa4c2b2d4be48f52d4b37c3" args="(const PARMS_T *parms, RECON_T *recon)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structdcell.html">dcell</a>* ngsmod_m           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
DM modes for all the low order modes. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00353"></a>00353                                                             {
<a name="l00354"></a>00354     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>; 
<a name="l00355"></a>00355     <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00356"></a>00356     <span class="keywordtype">int</span> nmod=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>;
<a name="l00357"></a>00357     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *M=dcellnew(1,1);
<a name="l00358"></a>00358     M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nmod,1);
<a name="l00359"></a>00359     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *mod=dcellnew(ndm,1);
<a name="l00360"></a>00360     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmt=dcellnew(ndm,1);
<a name="l00361"></a>00361     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> **aloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>;
<a name="l00362"></a>00362     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00363"></a>00363     dmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(aloc[idm]-&gt;nloc,1);
<a name="l00364"></a>00364     mod-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(aloc[idm]-&gt;nloc,nmod);
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imod=0; imod&lt;nmod; imod++){
<a name="l00367"></a>00367     dcellzero(M);
<a name="l00368"></a>00368     M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[imod]=1;
<a name="l00369"></a>00369     dcellzero(dmt);
<a name="l00370"></a>00370     <a class="code" href="ahst_8c.html#3d2a474cd4a6fcebb9e1ff8f26855353" title="Convert NGS modes to DM actuator commands using analytical expression.">ngsmod2dm</a>(&amp;dmt,recon,M,1.);
<a name="l00371"></a>00371     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00372"></a>00372         memcpy(mod-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+imod*aloc[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>, dmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 
<a name="l00373"></a>00373            <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*aloc[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>);
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376     dcellfree(M);
<a name="l00377"></a>00377     dcellfree(dmt);
<a name="l00378"></a>00378     <span class="keywordflow">return</span> mod;
<a name="l00379"></a>00379 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="33d002b5a06f58a3b7b4b07a1f0f3b3d"></a><!-- doxytag: member="ahst.c::ngsmod_g" ref="33d002b5a06f58a3b7b4b07a1f0f3b3d" args="(const PARMS_T *parms, RECON_T *recon, POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structdcell.html">dcell</a>* ngsmod_g           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
from ngsmod to ztilt/gtilt gradients using GA 
<p>
<div class="fragment"><pre class="fragment"><a name="l00384"></a>00384                               {
<a name="l00385"></a>00385     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>;
<a name="l00386"></a>00386     <span class="comment">//double R=parms-&gt;aper.d/2;</span>
<a name="l00387"></a>00387     <span class="comment">//double R2=R*R;</span>
<a name="l00388"></a>00388     <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00389"></a>00389     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> **aloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>;
<a name="l00390"></a>00390     <span class="keywordtype">int</span> nmod=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>;
<a name="l00391"></a>00391     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *ZSN=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00392"></a>00392     <span class="comment">//NGS mode vector</span>
<a name="l00393"></a>00393     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *M=dcellnew(1,1);
<a name="l00394"></a>00394     M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nmod,1);
<a name="l00395"></a>00395     <span class="comment">//DM command sfor NGS mod</span>
<a name="l00396"></a>00396     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmt=dcellnew(ndm,1);
<a name="l00397"></a>00397     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00398"></a>00398     dmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(aloc[idm]-&gt;nloc,1);
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>,GA);
<a name="l00401"></a>00401     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00402"></a>00402     <span class="keywordflow">if</span>(!recon-&gt;<a class="code" href="structRECON__T.html#caab8c1082469216636b9506e2efee46">skipwfs</a>[iwfs])
<a name="l00403"></a>00403         <span class="keywordflow">continue</span>;
<a name="l00404"></a>00404     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00405"></a>00405     <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00406"></a>00406     ZSN-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,nmod);
<a name="l00407"></a>00407     PDMAT(ZSN-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],grad);
<a name="l00408"></a>00408     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *grad2=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a>));
<a name="l00409"></a>00409     grad2-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>=nsa*2; 
<a name="l00410"></a>00410     grad2-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>=1;
<a name="l00411"></a>00411     
<a name="l00412"></a>00412     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imod=0; imod&lt;nmod; imod++){
<a name="l00413"></a>00413         grad2-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>=grad[imod];
<a name="l00414"></a>00414         dcellzero(M);
<a name="l00415"></a>00415         M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[imod]=1;
<a name="l00416"></a>00416         dcellzero(dmt);
<a name="l00417"></a>00417         <span class="comment">//convert NGS mode vector to DM commands</span>
<a name="l00418"></a>00418         <a class="code" href="ahst_8c.html#3d2a474cd4a6fcebb9e1ff8f26855353" title="Convert NGS modes to DM actuator commands using analytical expression.">ngsmod2dm</a>(&amp;dmt,recon,M,1.);
<a name="l00419"></a>00419         <a class="code" href="dmat_8h.html#e98618064b54869b4180d0c7fd895645" title="initialize all numbers in a X(mat) object to 0">dzero</a>(grad2);
<a name="l00420"></a>00420         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00421"></a>00421         <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;grad2,GA[idm][iwfs],dmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm],1);
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     free(grad2);
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426     dcellfree(M);
<a name="l00427"></a>00427     dcellfree(dmt);
<a name="l00428"></a>00428     <span class="keywordflow">return</span> ZSN;
<a name="l00429"></a>00429 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7e3cbb7965f524ef7ab5c63a90466abd"></a><!-- doxytag: member="ahst.c::ngsmod_hm_accphi" ref="7e3cbb7965f524ef7ab5c63a90466abd" args="(const PARMS_T *parms, RECON_T *recon, APER_T *aper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structdcell.html">dcell</a>* ngsmod_hm_accphi           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Compute NGS modes Ha*M in the science directon using ray tracing. 
<p>
Not used <div class="fragment"><pre class="fragment"><a name="l00433"></a>00433                                                                            {
<a name="l00434"></a>00434     <span class="comment">//Build NGS mod in science direction using accphi</span>
<a name="l00435"></a>00435     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>;
<a name="l00436"></a>00436     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> **aloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>;
<a name="l00437"></a>00437     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;
<a name="l00438"></a>00438     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmt=dcellnew(ndm,1);
<a name="l00439"></a>00439     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00440"></a>00440     dmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(aloc[idm]-&gt;nloc,1);
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *M=dcellnew(1,1);
<a name="l00443"></a>00443     <span class="keyword">const</span> <span class="keywordtype">int</span> nmod=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>;
<a name="l00444"></a>00444     M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nmod,1);
<a name="l00445"></a>00445     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *HMC=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>,nmod);<span class="comment">//fine with SCAO or GLAO</span>
<a name="l00446"></a>00446     PDCELL(HMC,HM);
<a name="l00447"></a>00447     <span class="keywordtype">int</span> nloc=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00448"></a>00448     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imod=0; imod&lt;nmod; imod++){
<a name="l00449"></a>00449     <a class="code" href="dmat_8h.html#e98618064b54869b4180d0c7fd895645" title="initialize all numbers in a X(mat) object to 0">dzero</a>(M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]);
<a name="l00450"></a>00450     M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[imod]=1;
<a name="l00451"></a>00451     dcellzero(dmt);
<a name="l00452"></a>00452     <a class="code" href="ahst_8c.html#3d2a474cd4a6fcebb9e1ff8f26855353" title="Convert NGS modes to DM actuator commands using analytical expression.">ngsmod2dm</a>(&amp;dmt,recon,M,1.);
<a name="l00453"></a>00453     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00454"></a>00454         HM[imod][ievl]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,1);
<a name="l00455"></a>00455         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00456"></a>00456         <span class="keywordtype">double</span> ht=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00457"></a>00457         <span class="keywordtype">double</span> displacex=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl]*ht;
<a name="l00458"></a>00458         <span class="keywordtype">double</span> displacey=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl]*ht;
<a name="l00459"></a>00459         <a class="code" href="accphi_8c.html#33015a685252b9238783b98a8ec5b159" title="Propagate OPD defines on coordinate locin to coordinate locout.">prop_nongrid</a>(aloc[idm], 
<a name="l00460"></a>00460                  dmt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00461"></a>00461                  aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>, NULL, HM[imod][ievl]-&gt;p,1,
<a name="l00462"></a>00462                  displacex, displacey, 1.,0,0);
<a name="l00463"></a>00463         }
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     <span class="keywordflow">return</span> HMC;
<a name="l00467"></a>00467 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f38907f48ddcb69345df2d5ef6ecc615"></a><!-- doxytag: member="ahst.c::ngsmod_hm_ana" ref="f38907f48ddcb69345df2d5ef6ecc615" args="(const PARMS_T *parms, RECON_T *recon, APER_T *aper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structdcell.html">dcell</a>* ngsmod_hm_ana           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Compute NGS modes Ha*M in the science directon using analytic formula. 
<p>
Not used <div class="fragment"><pre class="fragment"><a name="l00472"></a>00472                              {
<a name="l00473"></a>00473     <span class="comment">//if(parms-&gt;tomo.split!=1) error("Only in split mode 1.");</span>
<a name="l00474"></a>00474     <span class="comment">//confirmed to agree with ngsmod_hm_accphi except DM artifacts</span>
<a name="l00475"></a>00475     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>;
<a name="l00476"></a>00476     <span class="keyword">const</span> <span class="keywordtype">double</span> hs=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#13b17076926281174eafb963077daab5">hs</a>;
<a name="l00477"></a>00477     <span class="keyword">const</span> <span class="keywordtype">double</span> ht=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>;
<a name="l00478"></a>00478     <span class="keyword">const</span> <span class="keywordtype">double</span> scale=pow(1.-ht/hs,-2);
<a name="l00479"></a>00479     <span class="keyword">const</span> <span class="keywordtype">double</span> scale1=1.-scale;
<a name="l00480"></a>00480     <span class="keyword">const</span> <span class="keywordtype">int</span> nmod=ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>;
<a name="l00481"></a>00481     <span class="keyword">const</span> <span class="keywordtype">double</span> MCC_fcp=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#9980921108b4ea0d7f6ebafa6686304f">aper_fcp</a>;
<a name="l00482"></a>00482     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *HMC=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>,nmod);
<a name="l00483"></a>00483     PDCELL(HMC,HM);
<a name="l00484"></a>00484     <span class="keywordtype">double</span> *x=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00485"></a>00485     <span class="keywordtype">double</span> *y=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00486"></a>00486     <span class="keywordtype">int</span> nloc=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00487"></a>00487     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00488"></a>00488     <span class="keywordtype">double</span> sx=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl];
<a name="l00489"></a>00489     <span class="keywordtype">double</span> sy=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl];
<a name="l00490"></a>00490     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> imod=0; imod&lt;nmod; imod++){
<a name="l00491"></a>00491         HM[imod][ievl]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nloc,1);
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493     <span class="keywordflow">if</span>(nmod==2){
<a name="l00494"></a>00494         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00495"></a>00495         HM[0][ievl]-&gt;p[iloc]=x[iloc];
<a name="l00496"></a>00496         HM[1][ievl]-&gt;p[iloc]=y[iloc];
<a name="l00497"></a>00497         }
<a name="l00498"></a>00498     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(nmod==5){
<a name="l00499"></a>00499         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00500"></a>00500         <span class="keywordtype">double</span> xx=pow(x[iloc],2);
<a name="l00501"></a>00501         <span class="keywordtype">double</span> yy=pow(y[iloc],2);
<a name="l00502"></a>00502         <span class="keywordtype">double</span> xy=x[iloc]*y[iloc];
<a name="l00503"></a>00503         HM[0][ievl]-&gt;p[iloc]=x[iloc];
<a name="l00504"></a>00504         HM[1][ievl]-&gt;p[iloc]=y[iloc];
<a name="l00505"></a>00505         HM[2][ievl]-&gt;p[iloc]=(xx+yy-MCC_fcp)*scale1
<a name="l00506"></a>00506             -2*ht*(sx*x[iloc]+sy*y[iloc])*scale;
<a name="l00507"></a>00507         HM[3][ievl]-&gt;p[iloc]=(xx-yy)*scale1-2*ht*(sx*x[iloc]-sy*y[iloc])*scale;
<a name="l00508"></a>00508         HM[4][ievl]-&gt;p[iloc]=(xy)*scale1-(sx*y[iloc]+sy*x[iloc])*ht*scale;
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510     }<span class="keywordflow">else</span>{
<a name="l00511"></a>00511         error(<span class="stringliteral">"Invalid nmod\n"</span>);
<a name="l00512"></a>00512     }
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514     <span class="keywordflow">return</span> HMC;
<a name="l00515"></a>00515 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="55c65679c193d90bc7f5175ebb17733f"></a><!-- doxytag: member="ahst.c::setup_ngsmod" ref="55c65679c193d90bc7f5175ebb17733f" args="(const PARMS_T *parms, RECON_T *recon, APER_T *aper, POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_ngsmod           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
setup NGS modes and reconstructor using AHST for one or two DMs. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00520"></a>00520                                        {
<a name="l00521"></a>00521     <span class="comment">//if(parms-&gt;tomo.split!=1) error("Only work in split mode 1.");</span>
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a>));
<a name="l00524"></a>00524     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>;   
<a name="l00525"></a>00525     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#9980921108b4ea0d7f6ebafa6686304f">aper_fcp</a>=aper-&gt;<a class="code" href="structAPER__T.html#f051a7aef05263d8ee294756d19e9f0d" title="piston correction in focus term.">fcp</a>;
<a name="l00526"></a>00526     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>=<a class="code" href="ahst_8c.html#1d776ee51ff021d1842de5de8a004dc5" title="Compute number of ahst modes from number of DMs.">ngsmod_nmod</a>(ndm);
<a name="l00527"></a>00527     <span class="keywordflow">if</span>(ndm==2 &amp;&amp; fabs(parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[0].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>)&gt;1.e-10){
<a name="l00528"></a>00528     error(<span class="stringliteral">"Error configuration. First DM is not on ground\n"</span>);
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530     <span class="keywordtype">double</span> hs=INFINITY;
<a name="l00531"></a>00531     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00532"></a>00532     <span class="keywordflow">if</span>(!isinf(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>)){
<a name="l00533"></a>00533         info(<span class="stringliteral">"ipowfs %d is LGS. hs=%g\n"</span>,ipowfs,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>);
<a name="l00534"></a>00534         <span class="keywordflow">if</span>(!isinf(hs) &amp;&amp; fabs(hs-parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>)&gt;1.e-5) 
<a name="l00535"></a>00535         error(<span class="stringliteral">"There are multiple LGS type with different hs.\n"</span>);
<a name="l00536"></a>00536         hs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>;
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     <span class="keywordflow">if</span>(isinf(hs)){
<a name="l00540"></a>00540     warning(<span class="stringliteral">"No LGS found. No Need split tomography\n"</span>);
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#13b17076926281174eafb963077daab5">hs</a>=hs;
<a name="l00543"></a>00543     <span class="keywordflow">if</span>(ndm&gt;1){
<a name="l00544"></a>00544     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>=parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[1].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00545"></a>00545     }<span class="keywordflow">else</span>{
<a name="l00546"></a>00546     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>=0;
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#04fe94fcd2b18eb124a0e5b1170d9387">scale</a>=pow(1.-ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>/ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#13b17076926281174eafb963077daab5">hs</a>,-2);
<a name="l00549"></a>00549     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#7a8f4d2ffc082c0a6180fcfd67bddb18">MCC</a>=<a class="code" href="ahst_8c.html#e3448a34b3f6452515a74d17b770c52f" title="computes the cross-coupling of NGS modes in science field.">ngsmod_mcc</a>(parms,recon,aper, parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#1099d0a05e59fced8655347bbb50b9c8" title="weight of each direction">wt</a>);
<a name="l00550"></a>00550     <span class="keywordtype">double</span> *wt_delta=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00551"></a>00551     wt_delta[parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#1a4adc47bdaa62f95418783e1506ac67" title="index of the on axis evluation point.">indoa</a>]=1;
<a name="l00552"></a>00552     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#d647f344bd6f0b22fa4e7d29251358e8">MCC_OA</a>=<a class="code" href="ahst_8c.html#e3448a34b3f6452515a74d17b770c52f" title="computes the cross-coupling of NGS modes in science field.">ngsmod_mcc</a>(parms,recon,aper, wt_delta);<span class="comment">//on axis point.</span>
<a name="l00553"></a>00553     free(wt_delta);
<a name="l00554"></a>00554     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#9109e1451b9bd21e3f5bc5d284caa591">IMCC</a>=<a class="code" href="dmat_8h.html#30ba84a58a9c9dd2e0a0afb5e389ffad" title="out of place version of dinvspd_inplace">dinvspd</a>(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#7a8f4d2ffc082c0a6180fcfd67bddb18">MCC</a>);
<a name="l00555"></a>00555     PDMAT(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#7a8f4d2ffc082c0a6180fcfd67bddb18">MCC</a>,MCC);
<a name="l00556"></a>00556     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#b75976d620d5c445e308977b3fdb6c6b">IMCC_TT</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(2,2);
<a name="l00557"></a>00557     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#b75976d620d5c445e308977b3fdb6c6b">IMCC_TT</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]=MCC[0][0];
<a name="l00558"></a>00558     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#b75976d620d5c445e308977b3fdb6c6b">IMCC_TT</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1]=MCC[0][1];
<a name="l00559"></a>00559     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#b75976d620d5c445e308977b3fdb6c6b">IMCC_TT</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[2]=MCC[1][0];
<a name="l00560"></a>00560     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#b75976d620d5c445e308977b3fdb6c6b">IMCC_TT</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[3]=MCC[1][1];
<a name="l00561"></a>00561     <a class="code" href="dmat_8h.html#b48bc9b9c8f923e19dafc70b8fff5de2" title="inplace invert a small square SPD matrix using lapack dposv_, usually (A&amp;#39;*w*A)...">dinvspd_inplace</a>(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#b75976d620d5c445e308977b3fdb6c6b">IMCC_TT</a>);
<a name="l00562"></a>00562     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00563"></a>00563     <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#7a8f4d2ffc082c0a6180fcfd67bddb18">MCC</a>, <span class="stringliteral">"%s/ahst_MCC"</span>, dirsetup);
<a name="l00564"></a>00564     }
<a name="l00565"></a>00565     <span class="comment">//if(parms-&gt;tomo.split!=1){</span>
<a name="l00566"></a>00566     <span class="comment">//  return;</span>
<a name="l00567"></a>00567     <span class="comment">//}</span>
<a name="l00568"></a>00568     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#46b52e4544e498d577399cec1f6e0baf">Mdm</a>=<a class="code" href="ahst_8c.html#d785d41e2aa4c2b2d4be48f52d4b37c3" title="DM modes for all the low order modes.">ngsmod_m</a>(parms,recon);
<a name="l00569"></a>00569     <span class="comment">/*</span>
<a name="l00570"></a>00570 <span class="comment">       W is recon-&gt;saneai;</span>
<a name="l00571"></a>00571 <span class="comment">       Rngs=(M'*G'*W*G*M)^-1*M'*G'*W</span>
<a name="l00572"></a>00572 <span class="comment">       Pngs=Rngs*GA</span>
<a name="l00573"></a>00573 <span class="comment">     */</span>
<a name="l00574"></a>00574     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#a4accdf268607c75aa27360648f8249c">GM</a>=<a class="code" href="ahst_8c.html#33d002b5a06f58a3b7b4b07a1f0f3b3d" title="from ngsmod to ztilt/gtilt gradients using GA">ngsmod_g</a>(parms,recon,powfs);
<a name="l00575"></a>00575     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#514dd751c537bb91de904edc719535df">Rngs</a>=dcellpinv(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#a4accdf268607c75aa27360648f8249c">GM</a>,NULL,recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#a9d49170afccefe4bdbf0507759dab89" title="0: use Wg, 1: using Wa">split_wt</a>==1){
<a name="l00578"></a>00578     <span class="comment">//Use gradient weighting.</span>
<a name="l00579"></a>00579     dcellmulsp(&amp;ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#3e0a759744994377aef5ba9eaefdb90d">Pngs</a>, ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#514dd751c537bb91de904edc719535df">Rngs</a>, recon-&gt;<a class="code" href="structRECON__T.html#c27d4e8f776a38b7200e0bd09ba58447">GAlo</a>, 1);
<a name="l00580"></a>00580     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#34e9b29344aab2d74ce12502e1c2e717" title="remote tip/tilt in high order DM fit output in split mode">split_rtt</a>){
<a name="l00581"></a>00581         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>,1);
<a name="l00582"></a>00582         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00583"></a>00583         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Matt=dcellnew(ndm,1);
<a name="l00584"></a>00584         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *GaM=NULL;
<a name="l00585"></a>00585         Matt-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="loc_8c.html#7e0b28fc7b9234d93ec2af2a8b5ff33b" title="Create a dmat containing locx and locy in two columns.">loc2mat</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm],0);
<a name="l00586"></a>00586         <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;GaM, recon-&gt;<a class="code" href="structRECON__T.html#c27d4e8f776a38b7200e0bd09ba58447">GAlo</a>, Matt, 1);
<a name="l00587"></a>00587         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *tmp=dcellpinv(GaM, NULL,recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>);
<a name="l00588"></a>00588         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *tmp2=NULL;
<a name="l00589"></a>00589         dcellmulsp(&amp;tmp2,tmp,recon-&gt;<a class="code" href="structRECON__T.html#c27d4e8f776a38b7200e0bd09ba58447">GAlo</a>, 1);
<a name="l00590"></a>00590         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(tmp2-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]);
<a name="l00591"></a>00591         dcellfree(tmp);
<a name="l00592"></a>00592         dcellfree(tmp2);
<a name="l00593"></a>00593         dcellfree(GaM);
<a name="l00594"></a>00594         dcellfree(Matt);
<a name="l00595"></a>00595         }
<a name="l00596"></a>00596     }
<a name="l00597"></a>00597     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#a9d49170afccefe4bdbf0507759dab89" title="0: use Wg, 1: using Wa">split_wt</a>==2){
<a name="l00598"></a>00598     <span class="comment">//Use aperture weighting.</span>
<a name="l00599"></a>00599     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#a26dd47b19f6a0d34b6835e82dbbea80" title="method to compute wa for ngsmod removal.">wamethod</a>==0){
<a name="l00600"></a>00600         info(<span class="stringliteral">"Wa using DM mode\n"</span>);
<a name="l00601"></a>00601         tic;
<a name="l00602"></a>00602         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#c152fb7687bbbc451a6cc7e7062ca49e">Wa</a>=<a class="code" href="ahst_8c.html#93a5f84318748435a67e0d7d3c4b228e" title="Compute NGS mode aperture weighting using science field.">ngsmod_Wa</a>(parms,recon,aper,0);
<a name="l00603"></a>00603         <a class="code" href="eigs_8c.html#45367708d512ccf95ac48292c25419f8" title="Apply tikhonov regulation with threshold of thres*max(eig(A)).">spcelltikcr</a>(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#c152fb7687bbbc451a6cc7e7062ca49e">Wa</a>, 1e-9);<span class="comment">//Always do this. Wa is not SPD.</span>
<a name="l00604"></a>00604         toc(<span class="stringliteral">"Wa"</span>);
<a name="l00605"></a>00605         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#3e0a759744994377aef5ba9eaefdb90d">Pngs</a>=dcellpinv(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#46b52e4544e498d577399cec1f6e0baf">Mdm</a>, NULL,ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#c152fb7687bbbc451a6cc7e7062ca49e">Wa</a>);
<a name="l00606"></a>00606         toc(<span class="stringliteral">"Pngs"</span>);
<a name="l00607"></a>00607         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#34e9b29344aab2d74ce12502e1c2e717" title="remote tip/tilt in high order DM fit output in split mode">split_rtt</a>){
<a name="l00608"></a>00608         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>,1);
<a name="l00609"></a>00609         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00610"></a>00610             <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *Matt=<a class="code" href="loc_8c.html#7e0b28fc7b9234d93ec2af2a8b5ff33b" title="Create a dmat containing locx and locy in two columns.">loc2mat</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm],0);
<a name="l00611"></a>00611             ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#cac32a8e663201109abf36bd322e9a46" title="compute the pseudo inverse of matrix A with weigthing of full matrix W or sparse...">dpinv</a>(Matt, NULL, ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#c152fb7687bbbc451a6cc7e7062ca49e">Wa</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[idm+idm*ndm]);
<a name="l00612"></a>00612             dfree(Matt);
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615     }<span class="keywordflow">else</span>{
<a name="l00616"></a>00616         info(<span class="stringliteral">"Wa using science mode\n"</span>);
<a name="l00617"></a>00617         tic;
<a name="l00618"></a>00618         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#3e0a759744994377aef5ba9eaefdb90d">Pngs</a>=<a class="code" href="ahst_8c.html#7851621262fbc9e1d6bc1019c61bb139" title="compute NGS mode removal from LGS commands using aperture weighting.">ngsmod_Pngs_Wa</a>(parms,recon,aper,0);
<a name="l00619"></a>00619         toc(<span class="stringliteral">"Pngs_Wa"</span>);
<a name="l00620"></a>00620         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#34e9b29344aab2d74ce12502e1c2e717" title="remote tip/tilt in high order DM fit output in split mode">split_rtt</a>){
<a name="l00621"></a>00621         tic;
<a name="l00622"></a>00622         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>=<a class="code" href="ahst_8c.html#e3113f442d824e6b7ffcc6ffe4d16361" title="compute NGS mode removal from LGS commands using aperture weighting.">ngsmod_Ptt_Wa</a>(parms,recon,aper,0);
<a name="l00623"></a>00623         toc(<span class="stringliteral">"Pngs_Ptt"</span>);
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#a9d49170afccefe4bdbf0507759dab89" title="0: use Wg, 1: using Wa">split_wt</a>==3){<span class="comment">//Identity weighting.</span>
<a name="l00627"></a>00627     ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#3e0a759744994377aef5ba9eaefdb90d">Pngs</a>=dcellpinv(ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#46b52e4544e498d577399cec1f6e0baf">Mdm</a>, NULL,NULL);
<a name="l00628"></a>00628     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#34e9b29344aab2d74ce12502e1c2e717" title="remote tip/tilt in high order DM fit output in split mode">split_rtt</a>){
<a name="l00629"></a>00629         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>,1);
<a name="l00630"></a>00630         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00631"></a>00631         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *Matt=<a class="code" href="loc_8c.html#7e0b28fc7b9234d93ec2af2a8b5ff33b" title="Create a dmat containing locx and locy in two columns.">loc2mat</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm],0);
<a name="l00632"></a>00632         ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]=<a class="code" href="dmat_8h.html#cac32a8e663201109abf36bd322e9a46" title="compute the pseudo inverse of matrix A with weigthing of full matrix W or sparse...">dpinv</a>(Matt, NULL,NULL);
<a name="l00633"></a>00633         dfree(Matt);
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636     }<span class="keywordflow">else</span>{
<a name="l00637"></a>00637     error(<span class="stringliteral">"Invalid parms-&gt;tomo.split_wt=%d\n"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#a9d49170afccefe4bdbf0507759dab89" title="0: use Wg, 1: using Wa">split_wt</a>);
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00640"></a>00640     <span class="comment">//ahst stands for ad hoc split tomography</span>
<a name="l00641"></a>00641         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#a4accdf268607c75aa27360648f8249c">GM</a>,  <span class="stringliteral">"%s/ahst_GM"</span>,  dirsetup);
<a name="l00642"></a>00642     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#514dd751c537bb91de904edc719535df">Rngs</a>,<span class="stringliteral">"%s/ahst_Rngs"</span>,dirsetup);
<a name="l00643"></a>00643     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#3e0a759744994377aef5ba9eaefdb90d">Pngs</a>,<span class="stringliteral">"%s/ahst_Pngs"</span>,dirsetup);
<a name="l00644"></a>00644     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>, <span class="stringliteral">"%s/ahst_Ptt"</span>, dirsetup);
<a name="l00645"></a>00645     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#46b52e4544e498d577399cec1f6e0baf">Mdm</a>, <span class="stringliteral">"%s/ahst_Mdm"</span>, dirsetup);
<a name="l00646"></a>00646     <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#c152fb7687bbbc451a6cc7e7062ca49e">Wa</a>, <span class="stringliteral">"%s/ahst_Wa"</span>, dirsetup);
<a name="l00647"></a>00647     }
<a name="l00648"></a>00648 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="bad45266bd29e9426cdbb40322c78c38"></a><!-- doxytag: member="ahst.c::calc_ngsmod_dot" ref="bad45266bd29e9426cdbb40322c78c38" args="(double *pttr_out, double *pttrcoeff_out, double *ngsmod_out, const PARMS_T *parms, const RECON_T *recon, const APER_T *aper, const double *opd, int ievl)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_ngsmod_dot           </td>
          <td>(</td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>pttr_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>pttrcoeff_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>ngsmod_out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>opd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ievl</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
used in performance evaluation on science opds. 
<p>
accumulate to out <div class="fragment"><pre class="fragment"><a name="l00655"></a>00655                                          {
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     <span class="keyword">const</span> <span class="keywordtype">double</span> *amp=aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>;
<a name="l00658"></a>00658     <span class="keyword">const</span> <span class="keywordtype">double</span> *locx=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00659"></a>00659     <span class="keyword">const</span> <span class="keywordtype">double</span> *locy=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00660"></a>00660     <span class="keyword">const</span> <span class="keywordtype">double</span> MCC_fcp=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#9980921108b4ea0d7f6ebafa6686304f">aper_fcp</a>;
<a name="l00661"></a>00661     <span class="keyword">const</span> <span class="keywordtype">double</span> ht=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>;
<a name="l00662"></a>00662     <span class="keyword">const</span> <span class="keywordtype">double</span> scale=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#04fe94fcd2b18eb124a0e5b1170d9387">scale</a>;
<a name="l00663"></a>00663     <span class="keyword">const</span> <span class="keywordtype">double</span> scale1=1.-scale;
<a name="l00664"></a>00664     <span class="keywordtype">double</span> coeff[6]={0,0,0,0,0,0};
<a name="l00665"></a>00665     <span class="keywordtype">double</span> tot=0;
<a name="l00666"></a>00666     <span class="keyword">const</span> <span class="keywordtype">double</span> thetax=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl]; 
<a name="l00667"></a>00667     <span class="keyword">const</span> <span class="keywordtype">double</span> thetay=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl]; 
<a name="l00668"></a>00668     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>==2){
<a name="l00669"></a>00669     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>; iloc++){
<a name="l00670"></a>00670         <span class="keyword">const</span> <span class="keywordtype">double</span> junk=amp[iloc]*opd[iloc];
<a name="l00671"></a>00671         tot+=junk*opd[iloc];
<a name="l00672"></a>00672         <span class="keyword">const</span> <span class="keywordtype">double</span> junkx=locx[iloc]*junk;
<a name="l00673"></a>00673         <span class="keyword">const</span> <span class="keywordtype">double</span> junky=locy[iloc]*junk;
<a name="l00674"></a>00674         coeff[0]+=junk;
<a name="l00675"></a>00675         coeff[1]+=junkx;
<a name="l00676"></a>00676         coeff[2]+=junky;
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>==5){
<a name="l00679"></a>00679     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>; iloc++){
<a name="l00680"></a>00680         <span class="keyword">const</span> <span class="keywordtype">double</span> junk=amp[iloc]*opd[iloc];
<a name="l00681"></a>00681         tot+=junk*opd[iloc];
<a name="l00682"></a>00682         <span class="keyword">const</span> <span class="keywordtype">double</span> junkx=locx[iloc]*junk;
<a name="l00683"></a>00683         <span class="keyword">const</span> <span class="keywordtype">double</span> junky=locy[iloc]*junk;
<a name="l00684"></a>00684         coeff[0]+=junk;
<a name="l00685"></a>00685         coeff[1]+=junkx;
<a name="l00686"></a>00686         coeff[2]+=junky;
<a name="l00687"></a>00687         coeff[3]+=locx[iloc]*junkx;
<a name="l00688"></a>00688         coeff[4]+=locy[iloc]*junky;
<a name="l00689"></a>00689         coeff[5]+=locx[iloc]*junky;
<a name="l00690"></a>00690     }
<a name="l00691"></a>00691     }<span class="keywordflow">else</span>{
<a name="l00692"></a>00692     error(<span class="stringliteral">"Invalid nmod\n"</span>);
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694     <span class="keywordflow">if</span>(pttrcoeff_out){
<a name="l00695"></a>00695     memset(pttrcoeff_out, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*3);
<a name="l00696"></a>00696     <a class="code" href="dmat_8h.html#108a4a2f57a5f271427d7af94a71abd8" title="multiply a X(mat) matrix with a vector and accumulate to y: y+=A*x*alpha">dmulvec</a>(pttrcoeff_out, aper-&gt;<a class="code" href="structAPER__T.html#a28b4297d4a9d7a58d2474f003b522a7" title="inverse of mode cross coupling for evaluations.">imcc</a>, coeff, 1);
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698     <span class="keywordflow">if</span>(pttr_out){
<a name="l00699"></a>00699     <span class="comment">//compute TT removed wavefront variance as a side product</span>
<a name="l00700"></a>00700     <span class="keywordtype">double</span> pis=aper-&gt;<a class="code" href="structAPER__T.html#a0c4649669d4a65aed9127f986efb5f6" title="piston term in imcc.">ipcc</a>*coeff[0]*coeff[0];
<a name="l00701"></a>00701     <span class="keywordtype">double</span> ptt=<a class="code" href="dmat_8h.html#2ad0b887d8ae79cd753310e095e2bd07" title="special version of dwdot for just 3 element vectors.">dwdot3</a>(coeff, aper-&gt;<a class="code" href="structAPER__T.html#a28b4297d4a9d7a58d2474f003b522a7" title="inverse of mode cross coupling for evaluations.">imcc</a>, coeff);
<a name="l00702"></a>00702     pttr_out[0]=tot-pis;<span class="comment">//PR</span>
<a name="l00703"></a>00703     pttr_out[1]=ptt-pis;<span class="comment">//TT</span>
<a name="l00704"></a>00704     pttr_out[2]=tot-ptt;<span class="comment">//PTTR</span>
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706     <span class="comment">//don't use +=. need locking</span>
<a name="l00707"></a>00707     ngsmod_out[0]=coeff[1];
<a name="l00708"></a>00708     ngsmod_out[1]=coeff[2];
<a name="l00709"></a>00709     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>==5){
<a name="l00710"></a>00710     ngsmod_out[2]=(scale1*(coeff[3]+coeff[4]-coeff[0]*MCC_fcp)
<a name="l00711"></a>00711                -2*scale*ht*(thetax*coeff[1]+thetay*coeff[2]));
<a name="l00712"></a>00712     ngsmod_out[3]=(scale1*(coeff[3]-coeff[4])
<a name="l00713"></a>00713                -2*scale*ht*(thetax*coeff[1]-thetay*coeff[2]));
<a name="l00714"></a>00714     ngsmod_out[4]=(scale1*(coeff[5])
<a name="l00715"></a>00715                -scale*ht*(thetay*coeff[1]+thetax*coeff[2]));
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3d2a474cd4a6fcebb9e1ff8f26855353"></a><!-- doxytag: member="ahst.c::ngsmod2dm" ref="3d2a474cd4a6fcebb9e1ff8f26855353" args="(dcell **dmc, const RECON_T *recon, const dcell *M, double gain)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngsmod2dm           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>dmc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>gain</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Convert NGS modes to DM actuator commands using analytical expression. 
<p>
<dl compact><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>switch to use mode vectors </dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00722"></a>00722                                                                               {
<a name="l00723"></a>00723     <span class="keywordflow">if</span>(!M) <span class="keywordflow">return</span>;
<a name="l00724"></a>00724     <span class="keywordtype">double</span> scale=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#04fe94fcd2b18eb124a0e5b1170d9387">scale</a>;
<a name="l00725"></a>00725     <span class="keywordtype">double</span> MCC_fcp=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#9980921108b4ea0d7f6ebafa6686304f">aper_fcp</a>;
<a name="l00726"></a>00726     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> **aloc=recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>;
<a name="l00727"></a>00727     <span class="comment">//convert mode vector and add to dm commands</span>
<a name="l00728"></a>00728     <span class="keyword">const</span> <span class="keywordtype">int</span> ndm=recon-&gt;<a class="code" href="structRECON__T.html#1fbfc84eb66bf5bee54a38e6b268e50a">ndm</a>;
<a name="l00729"></a>00729     <span class="keywordflow">if</span>(!*dmc){
<a name="l00730"></a>00730     *dmc=dcellnew(ndm,1);
<a name="l00731"></a>00731     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00732"></a>00732         (*dmc)-&gt;p[idm]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>, 1);
<a name="l00733"></a>00733     }
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">if</span>(ndm&gt;2) error(<span class="stringliteral">"Error Usage\n"</span>);
<a name="l00737"></a>00737     <span class="comment">//first dm</span>
<a name="l00738"></a>00738     assert(M-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>==1 &amp;&amp; M-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>==1);
<a name="l00739"></a>00739     <span class="keywordtype">double</span> *pm=M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00740"></a>00740     <span class="keywordflow">if</span>(ndm==1){
<a name="l00741"></a>00741     <span class="keywordflow">if</span>(M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>!=2) error(<span class="stringliteral">"Invalid mode\n"</span>);
<a name="l00742"></a>00742     <span class="keywordtype">int</span> idm=0;
<a name="l00743"></a>00743     <span class="keywordtype">double</span> *p=(*dmc)-&gt;p[idm]-&gt;p;
<a name="l00744"></a>00744     <span class="keywordtype">double</span> *xloc=aloc[idm]-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00745"></a>00745     <span class="keywordtype">double</span> *yloc=aloc[idm]-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00746"></a>00746     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> nloc=aloc[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00747"></a>00747     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00748"></a>00748         p[iloc]+=gain*(pm[0]*xloc[iloc]+pm[1]*yloc[iloc]);
<a name="l00749"></a>00749     }
<a name="l00750"></a>00750     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(ndm==2){
<a name="l00751"></a>00751     <span class="keywordflow">if</span>(M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>!=5) error(<span class="stringliteral">"Invalid mode\n"</span>);
<a name="l00752"></a>00752     <span class="keywordtype">double</span> scale2=-scale*gain;
<a name="l00753"></a>00753     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;ndm; idm++){
<a name="l00754"></a>00754         <span class="keywordtype">double</span> *p=(*dmc)-&gt;p[idm]-&gt;p;
<a name="l00755"></a>00755         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> nloc=aloc[idm]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00756"></a>00756         <span class="keywordtype">double</span> *xloc=aloc[idm]-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00757"></a>00757         <span class="keywordtype">double</span> *yloc=aloc[idm]-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00758"></a>00758         <span class="keywordflow">if</span>(idm==0){
<a name="l00759"></a>00759         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00760"></a>00760             <span class="keywordtype">double</span> xx=xloc[iloc]*xloc[iloc];
<a name="l00761"></a>00761             <span class="keywordtype">double</span> xy=xloc[iloc]*yloc[iloc];
<a name="l00762"></a>00762             <span class="keywordtype">double</span> yy=yloc[iloc]*yloc[iloc];
<a name="l00763"></a>00763             p[iloc]+=gain*(pm[0]*xloc[iloc]
<a name="l00764"></a>00764                    +pm[1]*yloc[iloc]
<a name="l00765"></a>00765                    +pm[2]*(xx+yy-MCC_fcp)
<a name="l00766"></a>00766                    +pm[3]*(xx-yy)
<a name="l00767"></a>00767                    +pm[4]*(xy));
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(idm==1){
<a name="l00770"></a>00770         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00771"></a>00771             <span class="keywordtype">double</span> xx=xloc[iloc]*xloc[iloc];
<a name="l00772"></a>00772             <span class="keywordtype">double</span> xy=xloc[iloc]*yloc[iloc];
<a name="l00773"></a>00773             <span class="keywordtype">double</span> yy=yloc[iloc]*yloc[iloc];
<a name="l00774"></a>00774             p[iloc]+=scale2*(pm[2]*(xx+yy-MCC_fcp)
<a name="l00775"></a>00775                      +pm[3]*(xx-yy)
<a name="l00776"></a>00776                      +pm[4]*(xy));
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778         }<span class="keywordflow">else</span>{
<a name="l00779"></a>00779         error(<span class="stringliteral">"Invalid\n"</span>);
<a name="l00780"></a>00780         }   
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782     }
<a name="l00783"></a>00783 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="23e700bf65ab8561bd8ff2f43cf0982d"></a><!-- doxytag: member="ahst.c::ngsmod2science" ref="23e700bf65ab8561bd8ff2f43cf0982d" args="(dmat *iopdevl, const PARMS_T *parms, const RECON_T *recon, const APER_T *aper, const dcell *M, int ievl, double gain)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ngsmod2science           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>iopdevl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ievl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>gain</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Convert NGS mode vector to aperture grid for science directions. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00788"></a>00788                                                   {
<a name="l00789"></a>00789     <span class="keyword">const</span> <span class="keywordtype">double</span> *locx=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00790"></a>00790     <span class="keyword">const</span> <span class="keywordtype">double</span> *locy=aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00791"></a>00791     <span class="keyword">const</span> <span class="keywordtype">double</span> *mod=M-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00792"></a>00792     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>==2){
<a name="l00793"></a>00793     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>; iloc++){
<a name="l00794"></a>00794         <span class="keywordtype">double</span> tmp=locx[iloc]*mod[0]+locy[iloc]*mod[1];
<a name="l00795"></a>00795         iopdevl-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iloc]+=tmp*gain;
<a name="l00796"></a>00796     }
<a name="l00797"></a>00797     }<span class="keywordflow">else</span>{
<a name="l00798"></a>00798     <span class="keyword">const</span> <span class="keywordtype">double</span> MCC_fcp=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#9980921108b4ea0d7f6ebafa6686304f">aper_fcp</a>;
<a name="l00799"></a>00799     <span class="keyword">const</span> <span class="keywordtype">double</span> ht=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#bfd835d27201eba2f87965d5650e3fd9">ht</a>;
<a name="l00800"></a>00800     <span class="keyword">const</span> <span class="keywordtype">double</span> scale=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#04fe94fcd2b18eb124a0e5b1170d9387">scale</a>;
<a name="l00801"></a>00801     <span class="keyword">const</span> <span class="keywordtype">double</span> scale1=1.-scale;
<a name="l00802"></a>00802     <span class="keyword">const</span> <span class="keywordtype">double</span> thetax=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl]; 
<a name="l00803"></a>00803     <span class="keyword">const</span> <span class="keywordtype">double</span> thetay=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl];
<a name="l00804"></a>00804     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>; iloc++){
<a name="l00805"></a>00805         <span class="keywordtype">double</span> x=locx[iloc];
<a name="l00806"></a>00806         <span class="keywordtype">double</span> y=locy[iloc];
<a name="l00807"></a>00807         <span class="keywordtype">double</span> xy=x*y;
<a name="l00808"></a>00808         <span class="keywordtype">double</span> x2=x*x;
<a name="l00809"></a>00809         <span class="keywordtype">double</span> y2=y*y;
<a name="l00810"></a>00810         <span class="keywordtype">double</span> tmp= locx[iloc]*mod[0]
<a name="l00811"></a>00811         +locy[iloc]*mod[1]
<a name="l00812"></a>00812         +mod[2]*((x2+y2-MCC_fcp)*scale1-2*scale*ht*(thetax*x+thetay*y))
<a name="l00813"></a>00813         +mod[3]*((x2-y2)*scale1 - 2*scale*ht*(thetax*x-thetay*y))
<a name="l00814"></a>00814         +mod[4]*(xy*scale1-scale*ht*(thetay*x+thetax*y));
<a name="l00815"></a>00815         iopdevl-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iloc]+=tmp*gain;
<a name="l00816"></a>00816     }
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 27 12:43:13 2010 for maos-0.6.1 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
