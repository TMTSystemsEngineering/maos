<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.6.1: maos/sim_utils.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/sim_utils.c File Reference</h1>Contains a few support functions for simulation.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#1e1e48b76ff317024b24ae00f7096a56">sim_evlol</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, <a class="el" href="structAPER__T.html">APER_T</a> *aper, <a class="el" href="structRECON__T.html">RECON_T</a> *recon)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Just do open loop error evalution.  <a href="#1e1e48b76ff317024b24ae00f7096a56"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#399be906c89239f2d06949ee5df937ee">genscreen</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">wrap of the generic vonkarman_genscreen to generate turbulence screens.  <a href="#399be906c89239f2d06949ee5df937ee"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structdcell.html">dcell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#5332882aafbf641fbc3da4c956ae3d96">atm2xloc</a> (const <a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Propagate the atmosphere to closest xloc.  <a href="#5332882aafbf641fbc3da4c956ae3d96"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#de5601f0c0ffa73c27aa90ec087d54ac">sim_update_etf</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Evolving the Sodium layer by updating the elongation transfer function.  <a href="#de5601f0c0ffa73c27aa90ec087d54ac"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#6788ee66ba9c555c2fe1b7ffba18e7b0">dcell_mean_and_save</a> (<a class="el" href="structdcell.html">dcell</a> *A, double scale, const char *format,...)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Scale a <a class="el" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> array and save to file.  <a href="#6788ee66ba9c555c2fe1b7ffba18e7b0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#77fdd69488c4c7061a098e3d10b09abe">seeding</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">use random number dirived from input seed to seed other stream.  <a href="#77fdd69488c4c7061a098e3d10b09abe"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#27c195134fbcb70dbf90b5ff2ee82a84">init_simu</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, <a class="el" href="structAPER__T.html">APER_T</a> *aper, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, int iseed)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initialize simu (of type <a class="el" href="structSIM__T.html" title="contains all the run time data struct.">SIM_T</a>) and various simulation data structs.  <a href="#27c195134fbcb70dbf90b5ff2ee82a84"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#84b825eee317f2e6b919c95773cd847f">free_simu</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Release memory of simu (of type <a class="el" href="structSIM__T.html" title="contains all the run time data struct.">SIM_T</a>) and close files.  <a href="#84b825eee317f2e6b919c95773cd847f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#245796513a02d7892e76cea88316394e">save_simu</a> (const <a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Save telemetry data during simulation every 50 time steps.  <a href="#245796513a02d7892e76cea88316394e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#0be16bd01f2529c9b983cbc5db7fe691">print_progress</a> (const <a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Print out wavefront error information and timing at each time step.  <a href="#0be16bd01f2529c9b983cbc5db7fe691"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="sim__utils_8c.html#f566f334aaf19cf9ad3ed5a847c2aee9">save_skyc</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, <a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Output parameters necessary to run postproc using <a class="el" href="skyc_8c.html" title="This file contains main routine that does the job management and calls setup_parms...">skyc/skyc.c</a>.  <a href="#f566f334aaf19cf9ad3ed5a847c2aee9"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Contains a few support functions for simulation. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="1e1e48b76ff317024b24ae00f7096a56"></a><!-- doxytag: member="sim_utils.c::sim_evlol" ref="1e1e48b76ff317024b24ae00f7096a56" args="(const PARMS_T *parms, POWFS_T *powfs, APER_T *aper, RECON_T *recon)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sim_evlol           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Just do open loop error evalution. 
<p>
Usually not used. <div class="fragment"><pre class="fragment"><a name="l00036"></a>00036                                          {
<a name="l00037"></a>00037     <span class="keywordtype">int</span> simend=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>;
<a name="l00038"></a>00038     <span class="keywordtype">int</span> simstart=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>;
<a name="l00039"></a>00039     <span class="keywordflow">if</span>(simstart&gt;=simend){
<a name="l00040"></a>00040     maos_done(0);
<a name="l00041"></a>00041     <span class="keywordflow">return</span>;
<a name="l00042"></a>00042     }
<a name="l00043"></a>00043     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iseed=0; iseed&lt;parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#6021b395d1b8ca9bb3f3449b67ed7935" title="How many simulation seed.">nseed</a>; iseed++){
<a name="l00044"></a>00044     <a class="code" href="structSIM__T.html" title="contains all the run time data struct.">SIM_T</a> *simu=<a class="code" href="sim__utils_8c.html#27c195134fbcb70dbf90b5ff2ee82a84" title="Initialize simu (of type SIM_T) and various simulation data structs.">init_simu</a>(parms,powfs,aper,recon,iseed);
<a name="l00045"></a>00045     <span class="keywordflow">if</span>(!simu) <span class="keywordflow">continue</span>;<span class="comment">//skip</span>
<a name="l00046"></a>00046     <a class="code" href="sim__utils_8c.html#399be906c89239f2d06949ee5df937ee" title="wrap of the generic vonkarman_genscreen to generate turbulence screens.">genscreen</a>(simu);
<a name="l00047"></a>00047     simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#345f9deab3e2b21f28284e29732af51e" title="sampling period.">dt</a>;
<a name="l00048"></a>00048     <span class="keywordtype">double</span> tk_1=myclockd();
<a name="l00049"></a>00049     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isim=simstart; isim&lt;simend; isim++){
<a name="l00050"></a>00050         <span class="keywordtype">double</span> ck_0=myclockd();
<a name="l00051"></a>00051         simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>=isim;
<a name="l00052"></a>00052         simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;isim=isim;
<a name="l00053"></a>00053         <a class="code" href="perfevl_8c.html#19afa47f9c816174b2fab7b46eba5c32" title="Evaluate performance by calling perfevl_ievl in parallel and then calls perfevl_mean...">perfevl</a>(simu);
<a name="l00054"></a>00054         <span class="keywordtype">double</span> ck_1=myclockd();
<a name="l00055"></a>00055         
<a name="l00056"></a>00056         simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;rest=((ck_1-tk_1)*(<span class="keywordtype">double</span>)(simend-isim-1)
<a name="l00057"></a>00057                 /(<span class="keywordtype">double</span>)(isim-simstart+1));
<a name="l00058"></a>00058         simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;laps=(ck_1-tk_1);
<a name="l00059"></a>00059         
<a name="l00060"></a>00060         simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;eval=(double)(ck_1-ck_0);
<a name="l00061"></a>00061         simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;tot=(double)(ck_1-ck_0);
<a name="l00062"></a>00062         simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;scale=1;
<a name="l00063"></a>00063         simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;info=S_RUNNING;
<a name="l00064"></a>00064         scheduler_report(simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>);
<a name="l00065"></a>00065         <a class="code" href="sim__utils_8c.html#0be16bd01f2529c9b983cbc5db7fe691" title="Print out wavefront error information and timing at each time step.">print_progress</a>(simu);
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067     <a class="code" href="sim__utils_8c.html#84b825eee317f2e6b919c95773cd847f" title="Release memory of simu (of type SIM_T) and close files.">free_simu</a>(simu);
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069     maos_done(0);
<a name="l00070"></a>00070 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="sim__utils_8c_1e1e48b76ff317024b24ae00f7096a56_cgraph.png" border="0" usemap="#sim__utils_8c_1e1e48b76ff317024b24ae00f7096a56_cgraph_map" alt=""></center>
<map name="sim__utils_8c_1e1e48b76ff317024b24ae00f7096a56_cgraph_map">
<area shape="rect" id="node3" href="sim__utils_8c.html#84b825eee317f2e6b919c95773cd847f" title="Release memory of simu (of type SIM_T) and close files." alt="" coords="141,32,219,61"><area shape="rect" id="node5" href="sim__utils_8c.html#399be906c89239f2d06949ee5df937ee" title="wrap of the generic vonkarman_genscreen to generate turbulence screens." alt="" coords="139,85,221,115"><area shape="rect" id="node15" href="sim__utils_8c.html#27c195134fbcb70dbf90b5ff2ee82a84" title="Initialize simu (of type SIM_T) and various simulation data structs." alt="" coords="143,139,217,168"><area shape="rect" id="node17" href="perfevl_8c.html#19afa47f9c816174b2fab7b46eba5c32" title="Evaluate performance by calling perfevl_ievl in parallel and then calls perfevl_mean..." alt="" coords="151,192,209,221"><area shape="rect" id="node19" href="sim__utils_8c.html#0be16bd01f2529c9b983cbc5db7fe691" title="Print out wavefront error information and timing at each time step." alt="" coords="128,245,232,275"><area shape="rect" id="node7" href="turbulence_8c.html#0ee9d0775731bbaf8324ad8e617ac15b" title="Generate screens from PSD with power of 12/3 instead of 11/3." alt="" coords="280,5,411,35"><area shape="rect" id="node9" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object." alt="" coords="320,59,371,88"><area shape="rect" id="node11" href="draw_8c.html#cd04347e8f08fcef0e42ee57056d32ed" title="like ddraw, acting on sqmap object." alt="" coords="308,112,383,141"><area shape="rect" id="node13" href="turbulence_8c.html#ded1c5f6bbc8fb085bf74c8da452dfb2" title="Generate vonkarman screens from turbulence statistics." alt="" coords="280,165,411,195"></map>
</div>

</div>
</div><p>
<a class="anchor" name="399be906c89239f2d06949ee5df937ee"></a><!-- doxytag: member="sim_utils.c::genscreen" ref="399be906c89239f2d06949ee5df937ee" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void genscreen           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
wrap of the generic vonkarman_genscreen to generate turbulence screens. 
<p>
Wind velocities are set for each screen. <div class="fragment"><pre class="fragment"><a name="l00074"></a>00074                            { 
<a name="l00075"></a>00075     struct_rand *rstat=&amp;simu-&gt;<a class="code" href="structSIM__T.html#aaaffcb8a2ecae5b338e79471d71e2c4">atm_rand</a>;
<a name="l00076"></a>00076     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00077"></a>00077     <span class="keyword">const</span> <a class="code" href="structATM__CFG__T.html" title="contains input parameters for the atmospheric turbulence.">ATM_CFG_T</a> *atm=&amp;(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>);
<a name="l00078"></a>00078     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>){
<a name="l00079"></a>00079     sqmaparrfree(simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>, parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>);
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#ee78f00d55f891ff2749327794c3ba86" title="disable atmosphere">noatm</a>){
<a name="l00082"></a>00082     warning(<span class="stringliteral">"dbg.noatm flag is on. will not generate atmoshere\n"</span>);
<a name="l00083"></a>00083     <span class="keywordflow">return</span>;
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085   
<a name="l00086"></a>00086     <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> **screens=NULL;
<a name="l00087"></a>00087     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#b64e566442f063d9268c468159a68450" title="load atmosphere from.">atm</a>){
<a name="l00088"></a>00088     <span class="keyword">const</span> <span class="keywordtype">char</span> *fn=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#b64e566442f063d9268c468159a68450" title="load atmosphere from.">atm</a>;
<a name="l00089"></a>00089     info2(<span class="stringliteral">"loading atm from %s\n"</span>,fn);
<a name="l00090"></a>00090     <span class="keywordtype">int</span> nlayer;
<a name="l00091"></a>00091     screens = sqmaparrread(&amp;nlayer,<span class="stringliteral">"%s"</span>,fn);
<a name="l00092"></a>00092     <span class="keywordflow">if</span>(nlayer!=atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>)
<a name="l00093"></a>00093         error(<span class="stringliteral">"Mismatch\n"</span>);
<a name="l00094"></a>00094     }<span class="keywordflow">else</span>{
<a name="l00095"></a>00095     TIC;
<a name="l00096"></a>00096     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#388536eb4fba9ee67554d927d599dc4e" title="test special atmosphere">atm</a>==0){
<a name="l00097"></a>00097         info2(<span class="stringliteral">"Generating Atmospheric Screen..."</span>);
<a name="l00098"></a>00098         tic;
<a name="l00099"></a>00099         screens = <a class="code" href="turbulence_8c.html#ded1c5f6bbc8fb085bf74c8da452dfb2" title="Generate vonkarman screens from turbulence statistics.">vonkarman_screen</a>(rstat,atm-&gt;<a class="code" href="structATM__CFG__T.html#17d5dd2613f05038cccb672e12671459" title="turbulence screen size alog x">nx</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#bcdc09a016c8d4bfe1a0b6c6f8a261a4" title="turbulence screen size along y">ny</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#b47d65c892430196c01fa5c05c802608" title="sampling of turbulence screens">dx</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#ea9e24d04a414ec33916763092f6a486" title="derived from r0z for zenith angle za">r0</a>,
<a name="l00100"></a>00100                        atm-&gt;<a class="code" href="structATM__CFG__T.html#d6a52fa85cd299be46eef6c58bc426b0" title="outer scale">l0</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#d539b2f97fd31f5e5dc999b852b71228" title="weight of each layer (relative strength of )">wt</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>,simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>);
<a name="l00101"></a>00101         toc2(<span class="stringliteral">"done"</span>);
<a name="l00102"></a>00102     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#388536eb4fba9ee67554d927d599dc4e" title="test special atmosphere">atm</a>==-1){
<a name="l00103"></a>00103         info2(<span class="stringliteral">"Generating Biharmonic Atmospheric Screen..."</span>);
<a name="l00104"></a>00104         tic;
<a name="l00105"></a>00105         screens = <a class="code" href="turbulence_8c.html#0ee9d0775731bbaf8324ad8e617ac15b" title="Generate screens from PSD with power of 12/3 instead of 11/3.">biharmonic_screen</a>(rstat,atm-&gt;<a class="code" href="structATM__CFG__T.html#17d5dd2613f05038cccb672e12671459" title="turbulence screen size alog x">nx</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#bcdc09a016c8d4bfe1a0b6c6f8a261a4" title="turbulence screen size along y">ny</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#b47d65c892430196c01fa5c05c802608" title="sampling of turbulence screens">dx</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#ea9e24d04a414ec33916763092f6a486" title="derived from r0z for zenith angle za">r0</a>,
<a name="l00106"></a>00106                     atm-&gt;<a class="code" href="structATM__CFG__T.html#d6a52fa85cd299be46eef6c58bc426b0" title="outer scale">l0</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#d539b2f97fd31f5e5dc999b852b71228" title="weight of each layer (relative strength of )">wt</a>,atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>,simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>);
<a name="l00107"></a>00107         toc2(<span class="stringliteral">"done"</span>);
<a name="l00108"></a>00108     }<span class="keywordflow">else</span>{
<a name="l00109"></a>00109         info2(<span class="stringliteral">"Generating Testing Atmosphere Screen\n"</span>);
<a name="l00110"></a>00110         <span class="comment">/*</span>
<a name="l00111"></a>00111 <span class="comment">          create screens on two layers that produce pure</span>
<a name="l00112"></a>00112 <span class="comment">          tip/tilt for LGS to debug split tomography test</span>
<a name="l00113"></a>00113 <span class="comment">          pass in open loop mode for both Z and G tilt for</span>
<a name="l00114"></a>00114 <span class="comment">          NGS.</span>
<a name="l00115"></a>00115 <span class="comment">          </span>
<a name="l00116"></a>00116 <span class="comment">          The residual error is pure fit error if</span>
<a name="l00117"></a>00117 <span class="comment">          layer 5 is at dm layer. otherwise the error is a</span>
<a name="l00118"></a>00118 <span class="comment">          little larger.</span>
<a name="l00119"></a>00119 <span class="comment">        */</span>
<a name="l00120"></a>00120         <span class="keywordtype">int</span> nx=atm-&gt;<a class="code" href="structATM__CFG__T.html#17d5dd2613f05038cccb672e12671459" title="turbulence screen size alog x">nx</a>;
<a name="l00121"></a>00121         <span class="keywordtype">int</span> ny=atm-&gt;<a class="code" href="structATM__CFG__T.html#bcdc09a016c8d4bfe1a0b6c6f8a261a4" title="turbulence screen size along y">ny</a>;
<a name="l00122"></a>00122         screens=calloc(atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>,<span class="keyword">sizeof</span>(<a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a>*));
<a name="l00123"></a>00123         <span class="keywordtype">double</span> hs=90000;
<a name="l00124"></a>00124         <span class="keywordtype">double</span> dx=atm-&gt;<a class="code" href="structATM__CFG__T.html#b47d65c892430196c01fa5c05c802608" title="sampling of turbulence screens">dx</a>;
<a name="l00125"></a>00125         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> is=0; is&lt;atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>; is++){
<a name="l00126"></a>00126         screens[is]=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a>));
<a name="l00127"></a>00127         screens[is]-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>=calloc(nx*ny,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00128"></a>00128         screens[is]-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>=nx;
<a name="l00129"></a>00129         screens[is]-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>=ny;
<a name="l00130"></a>00130         screens[is]-&gt;<a class="code" href="structMAP__T.html#49015864cb8861d6ecf4b6a88596ee3c" title="Sampling along x and y.">dx</a>=dx;
<a name="l00131"></a>00131         screens[is]-&gt;<a class="code" href="structMAP__T.html#6d09f5bfa663ca7cc80fa16cd4f3bc5c" title="Origin in x.">ox</a>=-nx/2*dx;
<a name="l00132"></a>00132         screens[is]-&gt;<a class="code" href="structMAP__T.html#edda94fda911d8718b7b25a3972aa23b" title="Origin in y.">oy</a>=-ny/2*dx;
<a name="l00133"></a>00133         screens[is]-&gt;<a class="code" href="structMAP__T.html#7cad352b82624ab945b7808ea931f282" title="Heigh conjugation of this surface.">h</a>=atm-&gt;<a class="code" href="structATM__CFG__T.html#59642a891abc1d24aaeee4521a82c91b" title="height of each layer">ht</a>[is];
<a name="l00134"></a>00134         }
<a name="l00135"></a>00135         <span class="keywordtype">double</span> scale=-pow(1.-screens[5]-&gt;h/hs,-2);
<a name="l00136"></a>00136         <span class="keywordtype">double</span> strength=1./20626500.;
<a name="l00137"></a>00137         info(<span class="stringliteral">"strength=%g, scale=%g\n"</span>,strength,scale);
<a name="l00138"></a>00138         <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#388536eb4fba9ee67554d927d599dc4e" title="test special atmosphere">atm</a>){
<a name="l00139"></a>00139         <span class="keywordflow">case</span> 1:{
<a name="l00140"></a>00140         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;ny; iy++){
<a name="l00141"></a>00141             <span class="keywordtype">double</span> *p0=screens[0]-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>+iy*nx;
<a name="l00142"></a>00142             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;nx; ix++){
<a name="l00143"></a>00143             <span class="keywordtype">double</span> x=(ix-nx/2)*dx;
<a name="l00144"></a>00144             p0[ix]=x*strength;
<a name="l00145"></a>00145             }
<a name="l00146"></a>00146         }
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148         <span class="keywordflow">break</span>;
<a name="l00149"></a>00149         <span class="keywordflow">case</span> 2:{
<a name="l00150"></a>00150         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;ny; iy++){
<a name="l00151"></a>00151             <span class="keywordtype">double</span> *p0=screens[0]-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>+iy*nx;
<a name="l00152"></a>00152             <span class="keywordtype">double</span> *p1=screens[5]-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>+iy*nx;
<a name="l00153"></a>00153             <span class="keywordtype">double</span> y=(iy-ny/2)*dx;
<a name="l00154"></a>00154             <span class="keywordtype">double</span> yy=y*y;
<a name="l00155"></a>00155             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;nx; ix++){
<a name="l00156"></a>00156             <span class="keywordtype">double</span> x=(ix-nx/2)*dx;
<a name="l00157"></a>00157             <span class="keywordtype">double</span> xx=x*x;
<a name="l00158"></a>00158             <span class="comment">//double xy=x*y;</span>
<a name="l00159"></a>00159             <span class="comment">//p0[ix]=(iy-nx/2)*dx*strength;</span>
<a name="l00160"></a>00160             <span class="comment">//p0[ix]=(x*0.2+y*0.1+xx*0.3-yy*0.7+xy*0.3)*strength;</span>
<a name="l00161"></a>00161             p0[ix]=(xx+yy)*strength;
<a name="l00162"></a>00162             p1[ix]=scale*(p0[ix]);
<a name="l00163"></a>00163             }
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166         <span class="keywordflow">break</span>;
<a name="l00167"></a>00167         <span class="keywordflow">default</span>:
<a name="l00168"></a>00168         error(<span class="stringliteral">"Invalid\n"</span>);
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#7e19a6b97476eaefd13dc838468042d4" title="save atmosphere">atm</a>){
<a name="l00172"></a>00172         sqmaparrwrite(screens,atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>,<span class="stringliteral">"atm_%d.bin"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>);
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175     <span class="keywordtype">int</span> i;
<a name="l00176"></a>00176     info2(<span class="stringliteral">"Wind dir:"</span>);
<a name="l00177"></a>00177     simu-&gt;<a class="code" href="structSIM__T.html#90b521b076481fe938a37cbe4b1c5b79">winddir</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>,1);
<a name="l00178"></a>00178     <span class="keywordtype">int</span> wdnz=0;
<a name="l00179"></a>00179     <span class="keywordflow">for</span>(i=0; i&lt;atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>; i++){
<a name="l00180"></a>00180     screens[i]-&gt;<a class="code" href="structMAP__T.html#7cad352b82624ab945b7808ea931f282" title="Heigh conjugation of this surface.">h</a>=atm-&gt;<a class="code" href="structATM__CFG__T.html#59642a891abc1d24aaeee4521a82c91b" title="height of each layer">ht</a>[i];
<a name="l00181"></a>00181     <span class="keywordtype">double</span> angle;
<a name="l00182"></a>00182     <span class="keywordflow">if</span>(atm-&gt;<a class="code" href="structATM__CFG__T.html#9816d084ed9a1126c1edbcf2f38955f6" title="randomize wind direction">wdrand</a>){
<a name="l00183"></a>00183         <span class="keywordflow">if</span>(fabs(atm-&gt;<a class="code" href="structATM__CFG__T.html#c14a4c67cce4eab1f36b6cf7cd497754" title="wind direction of each layer">wddeg</a>[i])&gt;EPS){
<a name="l00184"></a>00184         wdnz=1;
<a name="l00185"></a>00185         }
<a name="l00186"></a>00186         angle=randu(&amp;simu-&gt;<a class="code" href="structSIM__T.html#ece4f6a3512229a2bb0b062e1158965f">atmwd_rand</a>)*M_PI*2;
<a name="l00187"></a>00187     }<span class="keywordflow">else</span>{
<a name="l00188"></a>00188         angle=atm-&gt;<a class="code" href="structATM__CFG__T.html#c14a4c67cce4eab1f36b6cf7cd497754" title="wind direction of each layer">wddeg</a>[i]*M_PI/180;
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190     simu-&gt;<a class="code" href="structSIM__T.html#90b521b076481fe938a37cbe4b1c5b79">winddir</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i]=angle;
<a name="l00191"></a>00191     info2(<span class="stringliteral">" %5.1f"</span>, angle*180/M_PI);
<a name="l00192"></a>00192     screens[i]-&gt;<a class="code" href="structMAP__T.html#0e1501d3055f92d8013c7f9e28b7dada">vx</a>=cos(angle)*atm-&gt;<a class="code" href="structATM__CFG__T.html#a9a86b3cc0c73d0d27cbad43f9706108" title="wind speed of each layer">ws</a>[i];
<a name="l00193"></a>00193     screens[i]-&gt;<a class="code" href="structMAP__T.html#18114c94e58dd22db69cb1cfbc050623">vy</a>=sin(angle)*atm-&gt;<a class="code" href="structATM__CFG__T.html#a9a86b3cc0c73d0d27cbad43f9706108" title="wind speed of each layer">ws</a>[i];
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195     info2(<span class="stringliteral">" deg\n"</span>);
<a name="l00196"></a>00196     <span class="keywordflow">if</span>(wdnz){
<a name="l00197"></a>00197     error(<span class="stringliteral">"wdrand is specified, but wddeg are not all zero. \n"</span>
<a name="l00198"></a>00198           <span class="stringliteral">"possible confliction of intension!\n"</span>);
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200     simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>=screens;
<a name="l00201"></a>00201     info2(<span class="stringliteral">"After genscreen:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l00202"></a>00202     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#68943838c435f728ef34bbb8d7fdda0f" title="Plot the generated atmosphere.">atm</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>){
<a name="l00203"></a>00203     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;atm-&gt;<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>; ips++){
<a name="l00204"></a>00204         <a class="code" href="draw_8c.html#cd04347e8f08fcef0e42ee57056d32ed" title="like ddraw, acting on sqmap object.">drawmap</a>(<span class="stringliteral">"atm"</span>, simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>[ips],
<a name="l00205"></a>00205             <span class="stringliteral">"Atmosphere OPD"</span>,<span class="stringliteral">"x (m)"</span>,<span class="stringliteral">"y (m)"</span>,<span class="stringliteral">"layer%d"</span>,ips);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#c524d5bd3cfcdc5ca45ba1641c8d1b0e" title="frozen flow.">frozenflow</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a>){
<a name="l00209"></a>00209     warning(<span class="stringliteral">"Creating new screen in CL mode will not work\n"</span>);
<a name="l00210"></a>00210     warning(<span class="stringliteral">"Creating new screen in CL mode will not work\n"</span>);
<a name="l00211"></a>00211     warning(<span class="stringliteral">"Creating new screen in CL mode will not work\n"</span>);
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="sim__utils_8c_399be906c89239f2d06949ee5df937ee_cgraph.png" border="0" usemap="#sim__utils_8c_399be906c89239f2d06949ee5df937ee_cgraph_map" alt=""></center>
<map name="sim__utils_8c_399be906c89239f2d06949ee5df937ee_cgraph_map">
<area shape="rect" id="node3" href="turbulence_8c.html#0ee9d0775731bbaf8324ad8e617ac15b" title="Generate screens from PSD with power of 12/3 instead of 11/3." alt="" coords="136,5,267,35"><area shape="rect" id="node5" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object." alt="" coords="176,59,227,88"><area shape="rect" id="node7" href="draw_8c.html#cd04347e8f08fcef0e42ee57056d32ed" title="like ddraw, acting on sqmap object." alt="" coords="164,112,239,141"><area shape="rect" id="node9" href="turbulence_8c.html#ded1c5f6bbc8fb085bf74c8da452dfb2" title="Generate vonkarman screens from turbulence statistics." alt="" coords="136,165,267,195"></map>
</div>

</div>
</div><p>
<a class="anchor" name="5332882aafbf641fbc3da4c956ae3d96"></a><!-- doxytag: member="sim_utils.c::atm2xloc" ref="5332882aafbf641fbc3da4c956ae3d96" args="(const SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structdcell.html">dcell</a>* atm2xloc           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Propagate the atmosphere to closest xloc. 
<p>
skip wavefront sensing and reconstruction. <div class="fragment"><pre class="fragment"><a name="l00219"></a>00219                                   {
<a name="l00220"></a>00220     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00221"></a>00221     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00222"></a>00222     <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>)
<a name="l00223"></a>00223     <span class="keywordflow">return</span> NULL;
<a name="l00224"></a>00224     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *opdx=dcellnew(recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>,1);
<a name="l00225"></a>00225     <span class="keywordtype">int</span> isim=simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>;
<a name="l00226"></a>00226     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>; ips++){
<a name="l00227"></a>00227     <span class="keywordtype">double</span> disx=-simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>[ips]-&gt;<a class="code" href="structMAP__T.html#0e1501d3055f92d8013c7f9e28b7dada">vx</a>*isim*simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>;
<a name="l00228"></a>00228     <span class="keywordtype">double</span> disy=-simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>[ips]-&gt;<a class="code" href="structMAP__T.html#18114c94e58dd22db69cb1cfbc050623">vy</a>*isim*simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>;
<a name="l00229"></a>00229     <span class="keywordtype">int</span> ipsr=parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#26569c7a3b382ec5e71016b2719f6734" title="corresponding reconstruction layer">ipsr</a>[ips];
<a name="l00230"></a>00230     opdx-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipsr]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ipsr]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,1);
<a name="l00231"></a>00231     <a class="code" href="accphi_8c.html#5ba7f2c5f6336b56caa056adcee4f11c" title="Propagate OPD defines on grid mapin to coordinate locout.">prop_grid</a>(simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>[ips],recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ipsr],opdx-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipsr]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00232"></a>00232           1,disx,disy,1,1,0,0);
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234     <span class="keywordflow">return</span> opdx;
<a name="l00235"></a>00235 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="de5601f0c0ffa73c27aa90ec087d54ac"></a><!-- doxytag: member="sim_utils.c::sim_update_etf" ref="de5601f0c0ffa73c27aa90ec087d54ac" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sim_update_etf           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Evolving the Sodium layer by updating the elongation transfer function. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00240"></a>00240                                 {
<a name="l00241"></a>00241     <span class="keywordtype">int</span> isim=simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>;
<a name="l00242"></a>00242     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00243"></a>00243     <a class="code" href="structPOWFS__T.html" title="contains the data associated with a certain type of WFS.">POWFS_T</a> *powfs=simu-&gt;<a class="code" href="structSIM__T.html#574e2dc6ebf0b42d7677c64eee329cac">powfs</a>;
<a name="l00244"></a>00244     <span class="keywordflow">if</span>(isim&gt;0){
<a name="l00245"></a>00245     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00246"></a>00246         <span class="comment">// Update ETF if necessary.</span>
<a name="l00247"></a>00247         <span class="keywordflow">if</span>((parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a>
<a name="l00248"></a>00248         ||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d0e06b302154b9b7a4a81bfdfd35a3d8" title="output time history of low order wfs PSF.">psfout</a>
<a name="l00249"></a>00249         ||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27067cb8df3c4a8b2eb27e32a0e309fd" title="output time averaged short exposure image.">pistatout</a>) 
<a name="l00250"></a>00250            &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>
<a name="l00251"></a>00251            &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#c8b3e202f9c4be878eb3a9a599c1de4f" title="change to next sodium profile during simulation every colsimdtrat time step">colsimdtrat</a>&gt;0
<a name="l00252"></a>00252            &amp;&amp; isim %parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#c8b3e202f9c4be878eb3a9a599c1de4f" title="change to next sodium profile during simulation every colsimdtrat time step">colsimdtrat</a> == 0){
<a name="l00253"></a>00253         warning(<span class="stringliteral">"powfs %d: Updating ETF\n"</span>,ipowfs);
<a name="l00254"></a>00254         <a class="code" href="maos_2setup__powfs_8c.html#bd59ad37c2a3372a70066e4b5cf34ac1" title="Compute Elongation Transfer function.">setup_powfs_etf</a>(powfs,parms,ipowfs,1,
<a name="l00255"></a>00255                 isim/parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#c8b3e202f9c4be878eb3a9a599c1de4f" title="change to next sodium profile during simulation every colsimdtrat time step">colsimdtrat</a>);
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="6788ee66ba9c555c2fe1b7ffba18e7b0"></a><!-- doxytag: member="sim_utils.c::dcell_mean_and_save" ref="6788ee66ba9c555c2fe1b7ffba18e7b0" args="(dcell *A, double scale, const char *format,...)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dcell_mean_and_save           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>scale</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>format</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&nbsp;</td>
          <td class="paramname"> <em>...</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Scale a <a class="el" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> array and save to file. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00265"></a>00265                                                                          {
<a name="l00266"></a>00266     format2fn;
<a name="l00267"></a>00267     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *tmp=NULL;
<a name="l00268"></a>00268     <span class="keywordflow">if</span>(scale&lt;1.e-14){
<a name="l00269"></a>00269     error(<span class="stringliteral">"scale=%g\n"</span>,scale);
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271     dcelladd(&amp;tmp, 0, A, scale);
<a name="l00272"></a>00272     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(tmp,<span class="stringliteral">"%s"</span>,fn);
<a name="l00273"></a>00273     dcellfree(tmp);
<a name="l00274"></a>00274 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="77fdd69488c4c7061a098e3d10b09abe"></a><!-- doxytag: member="sim_utils.c::seeding" ref="77fdd69488c4c7061a098e3d10b09abe" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void seeding           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
use random number dirived from input seed to seed other stream. 
<p>
necessary to have independant streams for different wfs in threading routines to avoid race condition and have consitent result <div class="fragment"><pre class="fragment"><a name="l00279"></a>00279                          {
<a name="l00280"></a>00280     info2(<span class="stringliteral">"Running seed %d\n"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>);
<a name="l00281"></a>00281     seed_rand(&amp;simu-&gt;<a class="code" href="structSIM__T.html#aed2790ae0fbcdf99ab9952dcd41b5c7">init</a>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>);
<a name="l00282"></a>00282   
<a name="l00283"></a>00283     seed_rand(&amp;simu-&gt;<a class="code" href="structSIM__T.html#aaaffcb8a2ecae5b338e79471d71e2c4">atm_rand</a>,   lrand(&amp;simu-&gt;<a class="code" href="structSIM__T.html#aed2790ae0fbcdf99ab9952dcd41b5c7">init</a>));
<a name="l00284"></a>00284     seed_rand(&amp;simu-&gt;<a class="code" href="structSIM__T.html#ece4f6a3512229a2bb0b062e1158965f">atmwd_rand</a>, lrand(&amp;simu-&gt;<a class="code" href="structSIM__T.html#aed2790ae0fbcdf99ab9952dcd41b5c7">init</a>));
<a name="l00285"></a>00285     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00286"></a>00286     <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>){
<a name="l00287"></a>00287     simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>, <span class="keyword">sizeof</span>(struct_rand));
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00290"></a>00290     seed_rand(&amp;simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>[iwfs],lrand(&amp;simu-&gt;<a class="code" href="structSIM__T.html#aed2790ae0fbcdf99ab9952dcd41b5c7">init</a>));
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="27c195134fbcb70dbf90b5ff2ee82a84"></a><!-- doxytag: member="sim_utils.c::init_simu" ref="27c195134fbcb70dbf90b5ff2ee82a84" args="(const PARMS_T *parms, POWFS_T *powfs, APER_T *aper, RECON_T *recon, int iseed)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structSIM__T.html">SIM_T</a>* init_simu           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>iseed</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initialize simu (of type <a class="el" href="structSIM__T.html" title="contains all the run time data struct.">SIM_T</a>) and various simulation data structs. 
<p>
Called for every seed. <div class="fragment"><pre class="fragment"><a name="l00298"></a>00298                                                 {
<a name="l00299"></a>00299     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#9056c1024a1abf5fac4ac86f7edaf195" title="Records the fd of the seed lock file.">fdlock</a>[iseed]&lt;0){
<a name="l00300"></a>00300     warning(<span class="stringliteral">"Another MAOS is already running. Skip seed %d\n"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#483429d04a2de324a443780025083dda" title="simulation seeds">seeds</a>[iseed]);
<a name="l00301"></a>00301     <span class="keywordflow">return</span> NULL;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303    
<a name="l00304"></a>00304     <a class="code" href="structSIM__T.html" title="contains all the run time data struct.">SIM_T</a> *simu=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structSIM__T.html" title="contains all the run time data struct.">SIM_T</a>));
<a name="l00305"></a>00305     PINIT(simu-&gt;mutex_plot);
<a name="l00306"></a>00306     PINIT(simu-&gt;mutex_wfsgrad);
<a name="l00307"></a>00307     PINIT(simu-&gt;mutex_perfevl);
<a name="l00308"></a>00308     PINIT(simu-&gt;mutex_cachedm);
<a name="l00309"></a>00309     simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>=parms;
<a name="l00310"></a>00310     simu-&gt;<a class="code" href="structSIM__T.html#574e2dc6ebf0b42d7677c64eee329cac">powfs</a>=powfs;
<a name="l00311"></a>00311     simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>=recon;
<a name="l00312"></a>00312     simu-&gt;<a class="code" href="structSIM__T.html#32c1411e2b4624790b8506e9b54449d4">aper</a>=aper;    
<a name="l00313"></a>00313     simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#483429d04a2de324a443780025083dda" title="simulation seeds">seeds</a>[iseed];
<a name="l00314"></a>00314     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>==0){
<a name="l00315"></a>00315     simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>=myclocki();
<a name="l00316"></a>00316     warning(<span class="stringliteral">"Seed is 0, using time as seed: %d\n"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>);
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318     <span class="keywordtype">int</span> seed=simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>;
<a name="l00319"></a>00319     simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,<span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00320"></a>00320     simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,<span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00321"></a>00321     simu-&gt;<a class="code" href="structSIM__T.html#1c33b2746b273def2a8b91c078e04e43">wfspsfoutcellarr</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,<span class="keyword">sizeof</span>(<a class="code" href="structcellarr.html" title="used to save array of dmat, cmat, ccell or dcell.">cellarr</a>*));
<a name="l00322"></a>00322     simu-&gt;<a class="code" href="structSIM__T.html#52a7f7ea349954a1de5660339c3d1246">ztiltoutcellarr</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,<span class="keyword">sizeof</span>(<a class="code" href="structcellarr.html" title="used to save array of dmat, cmat, ccell or dcell.">cellarr</a>*));
<a name="l00323"></a>00323     simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,<span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00324"></a>00324     simu-&gt;<a class="code" href="structSIM__T.html#9fa58c6d12a9a59b829d2578c800ab20">sanea_sim</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00325"></a>00325     simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);<span class="comment">//output</span>
<a name="l00326"></a>00326     simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);<span class="comment">//output</span>
<a name="l00327"></a>00327     simu-&gt;<a class="code" href="structSIM__T.html#a738e7a4294a049073428945f65695e0">gradacc</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);<span class="comment">//wfsgrad internal</span>
<a name="l00328"></a>00328     simu-&gt;<a class="code" href="structSIM__T.html#4f9c43677faa9f6745d3220bed8b8977">nthread</a>=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7691a6a576a70e837fa68092a6ca26de" title="Number of threads to run the simulation.">nthread</a>;
<a name="l00329"></a>00329     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#50827ebc23e85d5b8c052af5436827d9" title="servo type for low order loop.">servotype_lo</a>==2){
<a name="l00330"></a>00330     simu-&gt;<a class="code" href="structSIM__T.html#7f1f7e6320e5a18c9662e14316f7ea28">gtypeII_lo</a>=<a class="code" href="dmat_8h.html#6406403e91ec976bb0d6c2e12b5d5a0f" title="User callable function to read dense matrix into memory from file.">dread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#f0e66665827c92aefc31d47c000069ec" title="contains 3x1 or 3xnmod type II gains.">gtypeII_lo</a>);
<a name="l00331"></a>00331     simu-&gt;<a class="code" href="structSIM__T.html#0637d5bd3ccd951ee328c83af2bdfc5b">MtypeII_lo</a>=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structTYPEII__T.html" title="contains internal data for a type II integrator">TYPEII_T</a>));
<a name="l00332"></a>00332     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#7f1f7e6320e5a18c9662e14316f7ea28">gtypeII_lo</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>!=3){
<a name="l00333"></a>00333         error(<span class="stringliteral">"%s has wrong format. should have 3 rows\n"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#f0e66665827c92aefc31d47c000069ec" title="contains 3x1 or 3xnmod type II gains.">gtypeII_lo</a>);
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00337"></a>00337     simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#953c553bdd3d3252dd833702d2b9fe1c" title="number of entries in apdm">napdm</a>, <span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00338"></a>00338     }<span class="keywordflow">else</span>{
<a name="l00339"></a>00339     simu-&gt;<a class="code" href="structSIM__T.html#bddc06629ca1d3fd07bba2db8e50be47">dmint_hi</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#953c553bdd3d3252dd833702d2b9fe1c" title="number of entries in apdm">napdm</a>, <span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00340"></a>00340     simu-&gt;<a class="code" href="structSIM__T.html#d8fad0a83bdeed5dc290068f05bd8b0b">Mint_lo</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#953c553bdd3d3252dd833702d2b9fe1c" title="number of entries in apdm">napdm</a>, <span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342     simu-&gt;<a class="code" href="structSIM__T.html#66934ca62e886bf8b24470dbb403d117">uptint</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#21abf2c17974a27111b44429091940d8" title="number of entries in apupt">napupt</a>, <span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00343"></a>00343     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#3888974e340d614e8187d99c9e77c814" title="output time averaged psf">psfmean</a>){
<a name="l00344"></a>00344     simu-&gt;<a class="code" href="structSIM__T.html#4037361401c5977a3798921e2e5b8a2c">evlpsfmean</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#efa7d339640d46e883615e2de461ea60" title="Number of wavelength.">nwvl</a>,parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>);
<a name="l00345"></a>00345     simu-&gt;<a class="code" href="structSIM__T.html#62461b878ba4da08a310c2edd070de64">evlpsfolmean</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#efa7d339640d46e883615e2de461ea60" title="Number of wavelength.">nwvl</a>,1);
<a name="l00346"></a>00346     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>){
<a name="l00347"></a>00347         simu-&gt;<a class="code" href="structSIM__T.html#3543ea582865503921076eb72e4ef9c9">evlpsftomomean</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#efa7d339640d46e883615e2de461ea60" title="Number of wavelength.">nwvl</a>,parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>);
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350     simu-&gt;<a class="code" href="structSIM__T.html#2ee38673dc380b119869dc5349c87e23">opdevl</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>,1);
<a name="l00351"></a>00351     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9af2db68bde5dc62130f77d10d2eee8e" title="output history of the psf (a lot of storage)">psfhist</a>){
<a name="l00352"></a>00352     <span class="keyword">const</span> <span class="keywordtype">int</span> nevl=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>;
<a name="l00353"></a>00353     simu-&gt;<a class="code" href="structSIM__T.html#bf25c10a8c8ac84b7745e2834bb52a16">evlpsfhist</a>=calloc(nevl, <span class="keyword">sizeof</span>(<a class="code" href="structcellarr.html" title="used to save array of dmat, cmat, ccell or dcell.">cellarr</a>*));
<a name="l00354"></a>00354     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;nevl; ievl++){
<a name="l00355"></a>00355         <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#653e8a6165a7a3a7918554c6482ddab0" title="1: participant in psf evaluation.">psf</a>[ievl]) <span class="keywordflow">continue</span>;
<a name="l00356"></a>00356         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>!=2){
<a name="l00357"></a>00357         simu-&gt;<a class="code" href="structSIM__T.html#bf25c10a8c8ac84b7745e2834bb52a16">evlpsfhist</a>[ievl]=<a class="code" href="cellarr_8c.html#c696b3f9a8263e4cc1b2186dba9c38bb" title="Initializing an cellarray object that contains arrays of dmat, cmat, dcell or ccell...">cellarr_init</a>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>-parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#b5a659df6062a81bed28af92cdda3b7f" title="time step to start psfmean.">psfisim</a>, 
<a name="l00358"></a>00358                             <span class="stringliteral">"evlpsfhist_%d_ievl%d.bin"</span>,
<a name="l00359"></a>00359                             seed,ievl);
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>){
<a name="l00362"></a>00362         simu-&gt;<a class="code" href="structSIM__T.html#4cb9542747fe08a763f0f70da1111214">evlpsftomohist</a>[ievl]=<a class="code" href="cellarr_8c.html#c696b3f9a8263e4cc1b2186dba9c38bb" title="Initializing an cellarray object that contains arrays of dmat, cmat, dcell or ccell...">cellarr_init</a>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>-parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#b5a659df6062a81bed28af92cdda3b7f" title="time step to start psfmean.">psfisim</a>, 
<a name="l00363"></a>00363                             <span class="stringliteral">"evlpsftomohist_%d_ievl%d.bin"</span>,
<a name="l00364"></a>00364                             seed,ievl);
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#3888974e340d614e8187d99c9e77c814" title="output time averaged psf">psfmean</a> || parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9af2db68bde5dc62130f77d10d2eee8e" title="output history of the psf (a lot of storage)">psfhist</a>){
<a name="l00369"></a>00369     <span class="comment">//compute diffraction limited PSF.</span>
<a name="l00370"></a>00370     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *iopdevl=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(simu-&gt;<a class="code" href="structSIM__T.html#32c1411e2b4624790b8506e9b54449d4">aper</a>-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,1);
<a name="l00371"></a>00371     <a class="code" href="structccell.html" title="an 2-d block matrix of cmat.">ccell</a> *psf2s=<a class="code" href="maos_2utils_8c.html#ae7f6abee9a2af7836c61f3d76e3eda2" title="Computes PSF from OPD by doing FFT.">psfcomp</a>(iopdevl, aper-&gt;<a class="code" href="structAPER__T.html#cde71207f6ad1532a957fba93f3505f5" title="amplitude map defined on locs, if exists.">amp</a>, aper-&gt;<a class="code" href="structAPER__T.html#3aeb7c35cb75523ee1cde9334ae24d96" title="Embedding index for PSF computing, one per wvl.">embed</a>, aper-&gt;<a class="code" href="structAPER__T.html#49b02a4bc657ffae14011a1e79a9778b" title="dimension of embed.">nembed</a>,
<a name="l00372"></a>00372                  parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#e559598fb2203ac0a50bc81d774f7904" title="FFT size for outputing PSF.">psfsize</a>, parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#efa7d339640d46e883615e2de461ea60" title="Number of wavelength.">nwvl</a>, parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#e36c873b00a4bbc1a3dae8a6aa1549fd" title="wavelength for PSF and strehl computation">wvl</a>);
<a name="l00373"></a>00373     dfree(iopdevl);
<a name="l00374"></a>00374     <span class="keywordtype">int</span> nwvl=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#efa7d339640d46e883615e2de461ea60" title="Number of wavelength.">nwvl</a>;
<a name="l00375"></a>00375     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *evlpsfdl=dcellnew(nwvl,1);
<a name="l00376"></a>00376     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00377"></a>00377         <a class="code" href="cmat__extra_8c.html#d50c3f29262e58d4032225e69edc892f" title="Copy abs squared of a cmat to dmat with optional scaling: A0=A0*alpha+abs(B).">cabs22d</a>(&amp;evlpsfdl-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwvl], 1, psf2s-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[iwvl], 1);
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379     ccellfree(psf2s);
<a name="l00380"></a>00380     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(evlpsfdl, <span class="stringliteral">"evlpsfdl_%d.bin"</span>,seed);
<a name="l00381"></a>00381     dcellfree(evlpsfdl);
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     simu-&gt;<a class="code" href="structSIM__T.html#3cb4d8b6835f5d6e7295c05788750665">has_upt</a>=0;<span class="comment">//flag for uplink tip/tilt control</span>
<a name="l00385"></a>00385     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#b05030e94f2d0bda933420bdb15d45ef" title="error gain for LGS focus tracking with zoom optics">epfocus</a>&gt;1.e-15){
<a name="l00386"></a>00386     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#033ef0d6b40663166860f533d731000d" title="parameter for low pass filter of LGS focus tracking with offset">lpfocus</a>&lt;1.e-15){
<a name="l00387"></a>00387         error(<span class="stringliteral">"When epfocus is nonzero, lpfocus need to be zero\n"</span>);
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389     warning(<span class="stringliteral">"Creating simu-&gt;focus\n"</span>);
<a name="l00390"></a>00390     simu-&gt;<a class="code" href="structSIM__T.html#cf19af635f4448413fce6adba8078d6e">focusint</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00391"></a>00391     simu-&gt;<a class="code" href="structSIM__T.html#dd680e809db812c7b0493e18b816a68e">focuslpf</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00394"></a>00394     <span class="keyword">const</span> <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00395"></a>00395     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>){
<a name="l00396"></a>00396         <span class="comment">//has LGS pointing loop.</span>
<a name="l00397"></a>00397         simu-&gt;<a class="code" href="structSIM__T.html#3cb4d8b6835f5d6e7295c05788750665">has_upt</a>=1;
<a name="l00398"></a>00398         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#979789ab45a1f87cf251469dbedebe00" title="tip/tilt removal flag.">trs</a> &amp;&amp; !recon-&gt;<a class="code" href="structRECON__T.html#b2a067a798303d820f88872c07ffddf6">PTT</a>) 
<a name="l00399"></a>00399         <span class="comment">//needed to form upterr from LGS gradients.</span>
<a name="l00400"></a>00400         error(<span class="stringliteral">"PTT is not specified for an LGS!"</span>);
<a name="l00401"></a>00401         <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#bba8d28f43dad706c9d9669d409e5136">upterr</a>){
<a name="l00402"></a>00402         simu-&gt;<a class="code" href="structSIM__T.html#bba8d28f43dad706c9d9669d409e5136">upterr</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00403"></a>00403         simu-&gt;<a class="code" href="structSIM__T.html#1a1715f09be296fb2667b7a05c5fdc65">uptreal</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00404"></a>00404         <span class="keywordflow">break</span>;
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406     }
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408     {
<a name="l00409"></a>00409     <span class="keywordtype">int</span> moao_wfs=0;
<a name="l00410"></a>00410     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00411"></a>00411         <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00412"></a>00412         <span class="keywordtype">int</span> imoao=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#5b96a7a535d6e320913d8821a41a8423" title="index into MOAO struct.">moao</a>;
<a name="l00413"></a>00413         <span class="keywordflow">if</span>(imoao&gt;-1){
<a name="l00414"></a>00414         moao_wfs=1;
<a name="l00415"></a>00415         <span class="keywordflow">break</span>;
<a name="l00416"></a>00416         }
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418     <span class="keywordflow">if</span>(moao_wfs){
<a name="l00419"></a>00419         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a>){
<a name="l00420"></a>00420         simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>=dcellnew(3,parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>);
<a name="l00421"></a>00421         }<span class="keywordflow">else</span>{
<a name="l00422"></a>00422         simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>=dcellnew(1,parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>);
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#529a8acf247028c9e66cbe87c6edd84e" title="index into MOAO struct.">moao</a>&gt;-1){
<a name="l00426"></a>00426         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a>){
<a name="l00427"></a>00427         <span class="comment">//we only need 2 here because perfevl is ahead of recon</span>
<a name="l00428"></a>00428         simu-&gt;<a class="code" href="structSIM__T.html#b637adfa4528f55e986cfc7df75f2b01">moao_evl</a>=dcellnew(2,parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>);
<a name="l00429"></a>00429         }<span class="keywordflow">else</span>{
<a name="l00430"></a>00430         simu-&gt;<a class="code" href="structSIM__T.html#b637adfa4528f55e986cfc7df75f2b01">moao_evl</a>=dcellnew(1,parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>);
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     simu-&gt;<a class="code" href="structSIM__T.html#f3ef56bd760168170d2bb3089ac9864d">perfevl_iground</a>=parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#d776c7ea8c0f802bd0e025afc6202083" title="index into the ground layer">iground</a>;
<a name="l00435"></a>00435     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#1e7a8af66d62b8d1c0e6b1c31e1c248f" title="cache dm shape on fine sampled grid matched WFS or Science grid">cachedm</a>)
<a name="l00436"></a>00436     <a class="code" href="cachedm_8c.html#2923773c14f6b8673f1b6d9f63d1ae17" title="Prepares the DM caching structs.">prep_cachedm</a>(simu);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00439"></a>00439     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00440"></a>00440     <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00441"></a>00441     simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,1);
<a name="l00442"></a>00442     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a>){
<a name="l00443"></a>00443         simu-&gt;<a class="code" href="structSIM__T.html#9fa58c6d12a9a59b829d2578c800ab20">sanea_sim</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,1);
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446     simu-&gt;<a class="code" href="structSIM__T.html#1a656b8e93b33589d4899dc65c098e52">dtrat_hi</a>=1;
<a name="l00447"></a>00447     simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>=1;
<a name="l00448"></a>00448     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00449"></a>00449     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>&gt;1){
<a name="l00450"></a>00450         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l00451"></a>00451         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>==1){
<a name="l00452"></a>00452             simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00453"></a>00453         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>!=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>){
<a name="l00454"></a>00454             error(<span class="stringliteral">"We don't handle multiple framerate of the LO WFS yet\n"</span>);
<a name="l00455"></a>00455         }
<a name="l00456"></a>00456         }<span class="keywordflow">else</span>{
<a name="l00457"></a>00457         warning(<span class="stringliteral">"This is high order wfs, but dtrat=%d"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>);
<a name="l00458"></a>00458         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#1a656b8e93b33589d4899dc65c098e52">dtrat_hi</a>==1){
<a name="l00459"></a>00459             simu-&gt;<a class="code" href="structSIM__T.html#1a656b8e93b33589d4899dc65c098e52">dtrat_hi</a>=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00460"></a>00460         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#1a656b8e93b33589d4899dc65c098e52">dtrat_hi</a>!=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>){
<a name="l00461"></a>00461             error(<span class="stringliteral">"We don't handle multiple framerate of the LO WFS yet\n"</span>);
<a name="l00462"></a>00462         }
<a name="l00463"></a>00463         }
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#c524d5bd3cfcdc5ca45ba1641c8d1b0e" title="frozen flow.">frozenflow</a>){
<a name="l00467"></a>00467     simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#345f9deab3e2b21f28284e29732af51e" title="sampling period.">dt</a>;
<a name="l00468"></a>00468     }<span class="keywordflow">else</span>{
<a name="l00469"></a>00469     simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>=0;
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471     simu-&gt;<a class="code" href="structSIM__T.html#710cca584fede7acc2dd64cb2e598f23">dtlo</a>=simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>*simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>;
<a name="l00472"></a>00472     simu-&gt;<a class="code" href="structSIM__T.html#b5fbb14ecc0a7bc801bc4191f67cc3a3">dthi</a>=simu-&gt;<a class="code" href="structSIM__T.html#1a656b8e93b33589d4899dc65c098e52">dtrat_hi</a>*simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>;
<a name="l00473"></a>00473     <span class="comment">//evaluation.</span>
<a name="l00474"></a>00474     <span class="keywordtype">int</span> nsim=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>;
<a name="l00475"></a>00475     <span class="keyword">const</span> <span class="keywordtype">int</span> nevl=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>;
<a name="l00476"></a>00476     <span class="keyword">const</span> <span class="keywordtype">int</span> nmod=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#0401d88cccdc0585b83e8cb919d82d54" title="Number of modes.">nmod</a>;
<a name="l00477"></a>00477     
<a name="l00478"></a>00478     {<span class="comment">//USE MMAP for data that need to save at every time step</span>
<a name="l00479"></a>00479     <span class="keywordtype">long</span> nnx[nevl];
<a name="l00480"></a>00480     <span class="keywordtype">long</span> nny[nevl];
<a name="l00481"></a>00481     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;nevl; ievl++){
<a name="l00482"></a>00482         nnx[ievl]=nmod;
<a name="l00483"></a>00483         nny[ievl]=nsim;
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485     simu-&gt;<a class="code" href="structSIM__T.html#c65e9ce3a4423029555fa2efec78b435">olep</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1,nnx,nny,<span class="stringliteral">"Resolep_%d.bin"</span>,seed);
<a name="l00486"></a>00486     simu-&gt;<a class="code" href="structSIM__T.html#549cb58b9176ad9c3010e10a1c49e183">clep</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1,nnx,nny,<span class="stringliteral">"Resclep_%d.bin"</span>,seed);
<a name="l00487"></a>00487     simu-&gt;<a class="code" href="structSIM__T.html#4280db22efbabe02df141c3a7af83b93">olmp</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1,nnx,nny,<span class="stringliteral">"Resolmp_%d.bin"</span>,seed);
<a name="l00488"></a>00488     simu-&gt;<a class="code" href="structSIM__T.html#74c93d556aa71e088d126fc9b46a8b05">clmp</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1,nnx,nny,<span class="stringliteral">"Resclmp_%d.bin"</span>,seed);
<a name="l00489"></a>00489     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>){
<a name="l00490"></a>00490         simu-&gt;<a class="code" href="structSIM__T.html#5624b2fcac9387ae85b62b5e44859ccb">cleptomo</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1,nnx,nny,<span class="stringliteral">"Rescleptomo_%d.bin"</span>,seed); 
<a name="l00491"></a>00491         simu-&gt;<a class="code" href="structSIM__T.html#cb2343b0ab41ed2017b12161da590ab4">clmptomo</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1,nnx,nny,<span class="stringliteral">"Resclmptomo_%d.bin"</span>,seed);  
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>&lt;=2){
<a name="l00494"></a>00494         <span class="keywordtype">long</span> nnx_split[nevl];
<a name="l00495"></a>00495         <span class="keywordtype">long</span> nnx_3[nevl];
<a name="l00496"></a>00496         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;nevl; ievl++){
<a name="l00497"></a>00497         nnx_3[ievl]=3;
<a name="l00498"></a>00498         nnx_split[ievl]=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>;
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500         simu-&gt;<a class="code" href="structSIM__T.html#829764afdeb37528717cab28e1bbd0ed">clemp</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1, nnx_3, nny, <span class="stringliteral">"Resclemp_%d.bin"</span>,seed);
<a name="l00501"></a>00501         simu-&gt;<a class="code" href="structSIM__T.html#627edda515a52ab3fbdcfc51c9eac958">cleNGSm</a>=<a class="code" href="dmat_8h.html#316507e4c46251f724a2c22f1db76353" title="Create a new X(mat) matrix object, mmapped from file.">dnew_mmap</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>,nsim,<span class="stringliteral">"RescleNGSm_%d.bin"</span>,seed);
<a name="l00502"></a>00502         simu-&gt;<a class="code" href="structSIM__T.html#cee2a0d50823b17fb488974140b4cf36">cleNGSmp</a>=<a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(nevl,1,nnx_split,nny,<span class="stringliteral">"RescleNGSmp_%d.bin"</span>,seed);
<a name="l00503"></a>00503         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==1 &amp;&amp; !parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00504"></a>00504         simu-&gt;<a class="code" href="structSIM__T.html#20b5e3a20c72f11e59e3ba4551a4bc48">corrNGSm</a>=<a class="code" href="dmat_8h.html#316507e4c46251f724a2c22f1db76353" title="Create a new X(mat) matrix object, mmapped from file.">dnew_mmap</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>,nsim,<span class="stringliteral">"RescorrNGSm_%d.bin"</span>,seed);
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#8615676f068e88311d6f774e6cb92354" title="1: we are doing skycoverage preprocessing">skysim</a>){
<a name="l00507"></a>00507         <span class="keywordtype">char</span> fnold[PATH_MAX];
<a name="l00508"></a>00508         <span class="keywordtype">char</span> fnnew[PATH_MAX];
<a name="l00509"></a>00509         snprintf(fnnew, PATH_MAX, <span class="stringliteral">"%s/RescleNGSm_%d.bin"</span>,dirskysim,seed);
<a name="l00510"></a>00510         snprintf(fnold, PATH_MAX, <span class="stringliteral">"RescleNGSm_%d.bin"</span>, seed);
<a name="l00511"></a>00511         <span class="keywordflow">if</span>(link(fnold, fnnew)){
<a name="l00512"></a>00512             error(<span class="stringliteral">"Error link\n"</span>);
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514         snprintf(fnnew, PATH_MAX, <span class="stringliteral">"%s/RescleNGSmp_%d.bin"</span>,dirskysim,seed);
<a name="l00515"></a>00515         snprintf(fnold, PATH_MAX, <span class="stringliteral">"RescleNGSmp_%d.bin"</span>, seed);
<a name="l00516"></a>00516         <span class="keywordflow">if</span>(link(fnold, fnnew)){
<a name="l00517"></a>00517             error(<span class="stringliteral">"Error link\n"</span>);
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522     {<span class="comment">//MMAP the main result file</span>
<a name="l00523"></a>00523     <span class="keywordtype">long</span> nnx[4]={nmod,nmod,nmod,nmod};
<a name="l00524"></a>00524     <span class="keywordtype">long</span> nny[4]={nsim,nsim,nsim,nsim};
<a name="l00525"></a>00525     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>){
<a name="l00526"></a>00526         nnx[1]=0;
<a name="l00527"></a>00527         nny[1]=0;
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00530"></a>00530         nnx[3]=0; 
<a name="l00531"></a>00531         nny[3]=0;
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533     simu-&gt;<a class="code" href="structSIM__T.html#b7ed28903f3831b3433b7c8a7175cfd9">res</a>     = <a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(4,1,nnx,nny,<span class="stringliteral">"Res_%d.bin"</span>,seed);
<a name="l00534"></a>00534     simu-&gt;<a class="code" href="structSIM__T.html#cb6e3153c3ba12a9310f503d1cb5fa8e">ole</a>     = <a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(simu-&gt;<a class="code" href="structSIM__T.html#b7ed28903f3831b3433b7c8a7175cfd9">res</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]);
<a name="l00535"></a>00535     simu-&gt;<a class="code" href="structSIM__T.html#fe4ac255e40b5ebc4c1bab33c1e13550">cletomo</a> = <a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(simu-&gt;<a class="code" href="structSIM__T.html#b7ed28903f3831b3433b7c8a7175cfd9">res</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[1]);
<a name="l00536"></a>00536     simu-&gt;<a class="code" href="structSIM__T.html#1e10c517d94504ae3b0d3368735364ba">cle</a>     = <a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(simu-&gt;<a class="code" href="structSIM__T.html#b7ed28903f3831b3433b7c8a7175cfd9">res</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[2]);
<a name="l00537"></a>00537     simu-&gt;<a class="code" href="structSIM__T.html#172a004f720d68b39d1239c39b4c1faa">clem</a>    = <a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(simu-&gt;<a class="code" href="structSIM__T.html#b7ed28903f3831b3433b7c8a7175cfd9">res</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[3]);
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     {<span class="comment">//MMAP the LGS uptlink error/command output</span>
<a name="l00540"></a>00540     <span class="keywordtype">long</span> nnx[parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>];
<a name="l00541"></a>00541     <span class="keywordtype">long</span> nny[parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>];
<a name="l00542"></a>00542     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00543"></a>00543         <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00544"></a>00544         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>){
<a name="l00545"></a>00545         nnx[iwfs]=2;
<a name="l00546"></a>00546         nny[iwfs]=nsim;
<a name="l00547"></a>00547         }<span class="keywordflow">else</span>{
<a name="l00548"></a>00548         nnx[iwfs]=0;
<a name="l00549"></a>00549         nny[iwfs]=0;
<a name="l00550"></a>00550         }
<a name="l00551"></a>00551     }
<a name="l00552"></a>00552     simu-&gt;<a class="code" href="structSIM__T.html#bfefb2f79338c2280a987cc512465ca5">upterrs</a> = <a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>, 1, nnx, nny, <span class="stringliteral">"Resupterr_%d.bin"</span>, seed);
<a name="l00553"></a>00553     simu-&gt;<a class="code" href="structSIM__T.html#071e7f2036849234d609e8179e809945">uptcmds</a> = <a class="code" href="dmat_8h.html#a3b557cdaaf833c08dba873203894db5" title="Create a new X(cell) matrix cell object, mmapped from file.">dcellnew_mmap</a>(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>, 1, nnx, nny, <span class="stringliteral">"Resuptcmd_%d.bin"</span>, seed);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00557"></a>00557     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00558"></a>00558     <span class="keywordtype">long</span> ncompx=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#67bf34f36dd078a571e7a14cdf0755de">ncompx</a>;
<a name="l00559"></a>00559     <span class="keywordtype">long</span> ncompy=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#21071d969e8a6f006203a6c004339e0f">ncompy</a>;
<a name="l00560"></a>00560     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d0e06b302154b9b7a4a81bfdfd35a3d8" title="output time history of low order wfs PSF.">psfout</a>){
<a name="l00561"></a>00561         <span class="keyword">const</span> <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00562"></a>00562         <span class="comment">//assert(parms-&gt;powfs[ipowfs].dtrat==1);</span>
<a name="l00563"></a>00563         simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>[iwfs]=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(nsa,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>);
<a name="l00564"></a>00564         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ipsf=0; ipsf&lt;simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>[iwfs]-&gt;<a class="code" href="structccell.html#b08666a33e3b77dc0ebad13f58cd6f86" title="number of rows">nx</a>*simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>[iwfs]-&gt;<a class="code" href="structccell.html#02882865ece8aa1dab5515077834d67e" title="number of columns">ny</a>; ipsf++){
<a name="l00565"></a>00565         simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>[iwfs]-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ipsf]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompx/2,ncompy/2);
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567         mymkdir(<span class="stringliteral">"%s/wvfout/"</span>, dirskysim);
<a name="l00568"></a>00568         mymkdir(<span class="stringliteral">"%s/ztiltout/"</span>, dirskysim);
<a name="l00569"></a>00569         simu-&gt;<a class="code" href="structSIM__T.html#1c33b2746b273def2a8b91c078e04e43">wfspsfoutcellarr</a>[iwfs]=<a class="code" href="cellarr_8c.html#c696b3f9a8263e4cc1b2186dba9c38bb" title="Initializing an cellarray object that contains arrays of dmat, cmat, dcell or ccell...">cellarr_init</a>
<a name="l00570"></a>00570         (parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>-parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>,
<a name="l00571"></a>00571          <span class="stringliteral">"%s/wvfout/wvfout_seed%d_sa%d_x%g_y%g.bin"</span>,
<a name="l00572"></a>00572          dirskysim, seed,
<a name="l00573"></a>00573          parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>,
<a name="l00574"></a>00574          parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*206265,
<a name="l00575"></a>00575          parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*206265);
<a name="l00576"></a>00576     
<a name="l00577"></a>00577         simu-&gt;<a class="code" href="structSIM__T.html#52a7f7ea349954a1de5660339c3d1246">ztiltoutcellarr</a>[iwfs]=<a class="code" href="cellarr_8c.html#c696b3f9a8263e4cc1b2186dba9c38bb" title="Initializing an cellarray object that contains arrays of dmat, cmat, dcell or ccell...">cellarr_init</a>
<a name="l00578"></a>00578         (parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>-parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>,
<a name="l00579"></a>00579          <span class="stringliteral">"%s/ztiltout/ztiltout_seed%d_sa%d_x%g_y%g.bin"</span>,
<a name="l00580"></a>00580          dirskysim, seed,
<a name="l00581"></a>00581          parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>,
<a name="l00582"></a>00582          parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*206265,
<a name="l00583"></a>00583          parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*206265);
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27067cb8df3c4a8b2eb27e32a0e309fd" title="output time averaged short exposure image.">pistatout</a>){
<a name="l00587"></a>00587         mymkdir(<span class="stringliteral">"%s/pistat/"</span>,dirskysim);
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590  
<a name="l00591"></a>00591     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#7b62e7127ef7c49d9dda1a7d1f4c7910" title="number of pairs of gradient covariance to compute">ngcov</a>&gt;0){
<a name="l00592"></a>00592     simu-&gt;<a class="code" href="structSIM__T.html#a627421bfd2a0fa6b2c746463f075bef">gcov</a>=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#7b62e7127ef7c49d9dda1a7d1f4c7910" title="number of pairs of gradient covariance to compute">ngcov</a>,1);
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#758d4e6367bf5ecb3574be68505cf7d0" title="save computed DM actuator commands for each time step">dm</a>){
<a name="l00595"></a>00595     mymkdir(<span class="stringliteral">"dmerr_hi_%d"</span>, seed);
<a name="l00596"></a>00596     mymkdir(<span class="stringliteral">"dmfit_hi_%d"</span>, seed);
<a name="l00597"></a>00597     mymkdir(<span class="stringliteral">"dmreal_%d/"</span>, seed);
<a name="l00598"></a>00598     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00599"></a>00599         mymkdir(<span class="stringliteral">"dmint_%d"</span>, seed);
<a name="l00600"></a>00600     }<span class="keywordflow">else</span>{
<a name="l00601"></a>00601         mymkdir(<span class="stringliteral">"dmint_hi_%d"</span>, seed);
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603     mymkdir(<span class="stringliteral">"Merr_lo_%d"</span>, seed);
<a name="l00604"></a>00604     mymkdir(<span class="stringliteral">"Mint_lo_%d"</span>, seed);
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#a4595ac42f4762887f4e9cf9b4b926fb" title="save reconstructed OPD on XLOC for each time step">opdr</a>){
<a name="l00607"></a>00607     mymkdir(<span class="stringliteral">"opdr_%d"</span>, seed);
<a name="l00608"></a>00608     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#e68041518c7f2199b10e52d161bfe0f9" title="propagate turbulence to reconstructor grid xloc">opdx</a>){
<a name="l00609"></a>00609         mymkdir(<span class="stringliteral">"opdx_%d"</span>, seed);
<a name="l00610"></a>00610     }
<a name="l00611"></a>00611     }
<a name="l00612"></a>00612     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#176c03585612472231ab6a4be1211817" title="save high order WFS OPD">wfsopdhi</a> || parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#10d1345f20457fbeae19109b83c5d9d8" title="save low order WFS OPD">wfsopdlo</a>){
<a name="l00613"></a>00613     mymkdir(<span class="stringliteral">"wfsopd_%d"</span>,seed);
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#95a38cc1b078f10ba097b03a0ac8109d" title="save high orrder WFS integration">intshi</a> || parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#581b02d30795c0e1549fdd803d7911af" title="save low orrder WFS integration">intslo</a>){
<a name="l00616"></a>00616     mymkdir(<span class="stringliteral">"ints_%d"</span>,seed);
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#e62e9ccee9da7a163ada86892a3a118c" title="save WFS gradients for high order wfs">gradhi</a> || parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#9c7561530faefcb0f199b7415bb9e322" title="save WFS gradients for low order wfs">gradlo</a>){
<a name="l00619"></a>00619     mymkdir(<span class="stringliteral">"gradcl_%d"</span>, seed);
<a name="l00620"></a>00620     mymkdir(<span class="stringliteral">"gradnf_%d"</span>, seed);
<a name="l00621"></a>00621     mymkdir(<span class="stringliteral">"gradpsol_%d"</span>, seed);
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#0d62d847fd7526f9b95844891342bbdd" title="save WFS geometric gradient during physical optics simulations.">gradgeomhi</a> || parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#b21009e665fc49489f6f9f1e4bd3b024" title="save WFS geometric gradient during physical optics simulations.">gradgeomlo</a>){
<a name="l00624"></a>00624     mymkdir(<span class="stringliteral">"gradgeom_%d"</span>,seed);
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#22d270e374e3d951d8463542e3dac27b" title="save p/t/t removed dm act cmds at each time step">dmpttr</a>){
<a name="l00627"></a>00627     mymkdir(<span class="stringliteral">"dmpttr_%d/"</span>, seed);
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#7b62e7127ef7c49d9dda1a7d1f4c7910" title="number of pairs of gradient covariance to compute">ngcov</a>&gt;0){
<a name="l00630"></a>00630     mymkdir(<span class="stringliteral">"gcov_%d/"</span>, seed);
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#34a4c23843708f2e41eae5d31718112a" title="save run time informaton for each time step">run</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>){
<a name="l00633"></a>00633     mymkdir(<span class="stringliteral">"moao_%d/"</span>, seed);
<a name="l00634"></a>00634     }
<a name="l00635"></a>00635     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#2a0a94c2fe2c5321d032fe60113531ad" title="save science OPD for each time step">evlopd</a>){
<a name="l00636"></a>00636     mymkdir(<span class="stringliteral">"evlopd_%d/"</span>, seed);
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638     simu-&gt;<a class="code" href="structSIM__T.html#af2fc0d68cf124447162f684585d5125">dmpsol</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>, <span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l00639"></a>00639  
<a name="l00640"></a>00640     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>=calloc(1, <span class="keyword">sizeof</span>(STATUS_T));
<a name="l00641"></a>00641     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;iseed=iseed;
<a name="l00642"></a>00642     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;nseed=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#6021b395d1b8ca9bb3f3449b67ed7935" title="How many simulation seed.">nseed</a>;
<a name="l00643"></a>00643     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;simstart=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>;
<a name="l00644"></a>00644     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;simend=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>;
<a name="l00645"></a>00645     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;nthread=parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7691a6a576a70e837fa68092a6ca26de" title="Number of threads to run the simulation.">nthread</a>;
<a name="l00646"></a>00646     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;timstart=myclocki();
<a name="l00647"></a>00647     simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>-&gt;info=S_RUNNING;
<a name="l00648"></a>00648     <a class="code" href="sim__utils_8c.html#77fdd69488c4c7061a098e3d10b09abe" title="use random number dirived from input seed to seed other stream.">seeding</a>(simu);
<a name="l00649"></a>00649     <a class="code" href="setup__surf_8c.html#8459c99560347707f39d9174b0e2d1c3" title="Setup tilted surface (M3) by ray tracing from the tilted surface to WFS and Science...">setup_tsurf</a>(simu);<span class="comment">//setting up M3 tilted surf.</span>
<a name="l00650"></a>00650     <a class="code" href="setup__surf_8c.html#76466b6b93d7698b94dc4a9ec9c00e85" title="Setup surface perpendicular to the beam by ray tracing from the surface to WFS and...">setup_surf</a>(simu);<span class="comment">//setting up M1/M2/M3 surface OPD.</span>
<a name="l00651"></a>00651     <span class="keywordflow">return</span> simu;
<a name="l00652"></a>00652 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="84b825eee317f2e6b919c95773cd847f"></a><!-- doxytag: member="sim_utils.c::free_simu" ref="84b825eee317f2e6b919c95773cd847f" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_simu           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Release memory of simu (of type <a class="el" href="structSIM__T.html" title="contains all the run time data struct.">SIM_T</a>) and close files. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00656"></a>00656                            {
<a name="l00657"></a>00657  
<a name="l00658"></a>00658     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00659"></a>00659     sqmaparrfree(simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>, parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>);
<a name="l00660"></a>00660     PDEINIT(simu-&gt;mutex_plot);
<a name="l00661"></a>00661     PDEINIT(simu-&gt;mutex_wfsgrad);
<a name="l00662"></a>00662     PDEINIT(simu-&gt;mutex_perfevl);
<a name="l00663"></a>00663     PDEINIT(simu-&gt;mutex_cachedm);
<a name="l00664"></a>00664     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#1e7a8af66d62b8d1c0e6b1c31e1c248f" title="cache dm shape on fine sampled grid matched WFS or Science grid">cachedm</a>){
<a name="l00665"></a>00665     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00666"></a>00666         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iscale=0; 
<a name="l00667"></a>00667         iscale&lt;parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#87daddffcd964b97cfae786a7c9efaff" title="number of scale group for DM propagation cache.">nscale</a>; 
<a name="l00668"></a>00668         iscale++){
<a name="l00669"></a>00669         free(simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm][iscale].<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>);
<a name="l00670"></a>00670         }
<a name="l00671"></a>00671         free(simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>[idm]);
<a name="l00672"></a>00672     }
<a name="l00673"></a>00673     free(simu-&gt;<a class="code" href="structSIM__T.html#a33c072fbed475a7a22f7b4fc7e27334">cachedm</a>);
<a name="l00674"></a>00674     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#23aa8a9bcecfe29c0e170b50fe0423d3">cacheatm</a>){
<a name="l00675"></a>00675         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00676"></a>00676         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#23aa8a9bcecfe29c0e170b50fe0423d3">cacheatm</a>[ipowfs]){
<a name="l00677"></a>00677             free(simu-&gt;<a class="code" href="structSIM__T.html#23aa8a9bcecfe29c0e170b50fe0423d3">cacheatm</a>[ipowfs]);
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680         free(simu-&gt;<a class="code" href="structSIM__T.html#23aa8a9bcecfe29c0e170b50fe0423d3">cacheatm</a>);
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682     free(simu-&gt;<a class="code" href="structSIM__T.html#06e13fc279426037c8f829719720f432">pcachedm</a>); 
<a name="l00683"></a>00683     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#94acc92cf68283f0ca866d4b3086cb37">cachedm_prop</a>){
<a name="l00684"></a>00684         free(simu-&gt;<a class="code" href="structSIM__T.html#94acc92cf68283f0ca866d4b3086cb37">cachedm_prop</a>);
<a name="l00685"></a>00685         free(simu-&gt;<a class="code" href="structSIM__T.html#6766b9d62d3bf6c25f02d5b38b55cf50">cachedm_propdata</a>);
<a name="l00686"></a>00686     }
<a name="l00687"></a>00687     spcellfree(simu-&gt;<a class="code" href="structSIM__T.html#0241d38e89ddccb476d83c26163f67d9">HACT</a>);
<a name="l00688"></a>00688     }
<a name="l00689"></a>00689     
<a name="l00690"></a>00690     free(simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>);
<a name="l00691"></a>00691     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>);
<a name="l00692"></a>00692     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#a738e7a4294a049073428945f65695e0">gradacc</a>);
<a name="l00693"></a>00693     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>);
<a name="l00694"></a>00694     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>);
<a name="l00695"></a>00695     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#fe6605f55d778938848f8e7caccac524">opdrmvst</a>);
<a name="l00696"></a>00696     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#2ee38673dc380b119869dc5349c87e23">opdevl</a>);
<a name="l00697"></a>00697     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>);
<a name="l00698"></a>00698     dcellfreearr(simu-&gt;<a class="code" href="structSIM__T.html#af2fc0d68cf124447162f684585d5125">dmpsol</a>, parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>);
<a name="l00699"></a>00699     dfree(simu-&gt;<a class="code" href="structSIM__T.html#7f1f7e6320e5a18c9662e14316f7ea28">gtypeII_lo</a>);
<a name="l00700"></a>00700     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00701"></a>00701     dcellfreearr(simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#953c553bdd3d3252dd833702d2b9fe1c" title="number of entries in apdm">napdm</a>);
<a name="l00702"></a>00702     }<span class="keywordflow">else</span>{
<a name="l00703"></a>00703     dcellfreearr(simu-&gt;<a class="code" href="structSIM__T.html#bddc06629ca1d3fd07bba2db8e50be47">dmint_hi</a>, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#953c553bdd3d3252dd833702d2b9fe1c" title="number of entries in apdm">napdm</a>);
<a name="l00704"></a>00704     dcellfreearr(simu-&gt;<a class="code" href="structSIM__T.html#d8fad0a83bdeed5dc290068f05bd8b0b">Mint_lo</a>, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#18721e88bd6e37b5710bce0d5d6399e8" title="number of entries in apngs">napngs</a>);
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#a627421bfd2a0fa6b2c746463f075bef">gcov</a>);
<a name="l00707"></a>00707     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>);
<a name="l00708"></a>00708     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a>);
<a name="l00709"></a>00709     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#7a78096b3a9ce0681a6c0c0548b41942">dmhist</a>);
<a name="l00710"></a>00710     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>);
<a name="l00711"></a>00711     
<a name="l00712"></a>00712     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#0637d5bd3ccd951ee328c83af2bdfc5b">MtypeII_lo</a>){
<a name="l00713"></a>00713     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#0637d5bd3ccd951ee328c83af2bdfc5b">MtypeII_lo</a>-&gt;<a class="code" href="structTYPEII__T.html#aa57df2c19134a28f95374de81906cd5">lead</a>);
<a name="l00714"></a>00714     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#0637d5bd3ccd951ee328c83af2bdfc5b">MtypeII_lo</a>-&gt;<a class="code" href="structTYPEII__T.html#834bcf7d3bffae4e4dfda2f6e474ef45">firstint</a>);
<a name="l00715"></a>00715     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#0637d5bd3ccd951ee328c83af2bdfc5b">MtypeII_lo</a>-&gt;<a class="code" href="structTYPEII__T.html#3c0f8346bb49e5312b7a2c349f5aa913">errlast</a>);
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#bba8d28f43dad706c9d9669d409e5136">upterr</a>);
<a name="l00718"></a>00718     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#3916ecec49d28516ab554abc7e00abac">upterrlast</a>);
<a name="l00719"></a>00719     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#1a1715f09be296fb2667b7a05c5fdc65">uptreal</a>);
<a name="l00720"></a>00720     dcellfreearr(simu-&gt;<a class="code" href="structSIM__T.html#66934ca62e886bf8b24470dbb403d117">uptint</a>, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#21abf2c17974a27111b44429091940d8" title="number of entries in apupt">napupt</a>);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>);
<a name="l00723"></a>00723     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#b637adfa4528f55e986cfc7df75f2b01">moao_evl</a>);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#b7ed28903f3831b3433b7c8a7175cfd9">res</a>);
<a name="l00726"></a>00726     dfree(simu-&gt;<a class="code" href="structSIM__T.html#cb6e3153c3ba12a9310f503d1cb5fa8e">ole</a>);
<a name="l00727"></a>00727     dfree(simu-&gt;<a class="code" href="structSIM__T.html#1e10c517d94504ae3b0d3368735364ba">cle</a>);
<a name="l00728"></a>00728     dfree(simu-&gt;<a class="code" href="structSIM__T.html#fe4ac255e40b5ebc4c1bab33c1e13550">cletomo</a>);
<a name="l00729"></a>00729     dfree(simu-&gt;<a class="code" href="structSIM__T.html#172a004f720d68b39d1239c39b4c1faa">clem</a>);
<a name="l00730"></a>00730     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#c65e9ce3a4423029555fa2efec78b435">olep</a>);
<a name="l00731"></a>00731     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#4280db22efbabe02df141c3a7af83b93">olmp</a>);
<a name="l00732"></a>00732     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#549cb58b9176ad9c3010e10a1c49e183">clep</a>);
<a name="l00733"></a>00733     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#74c93d556aa71e088d126fc9b46a8b05">clmp</a>);
<a name="l00734"></a>00734     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#9fa58c6d12a9a59b829d2578c800ab20">sanea_sim</a>);
<a name="l00735"></a>00735     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#bfefb2f79338c2280a987cc512465ca5">upterrs</a>);
<a name="l00736"></a>00736     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#071e7f2036849234d609e8179e809945">uptcmds</a>);
<a name="l00737"></a>00737     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00738"></a>00738     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#829764afdeb37528717cab28e1bbd0ed">clemp</a>);
<a name="l00739"></a>00739     dfree(simu-&gt;<a class="code" href="structSIM__T.html#627edda515a52ab3fbdcfc51c9eac958">cleNGSm</a>);
<a name="l00740"></a>00740     dfree(simu-&gt;<a class="code" href="structSIM__T.html#20b5e3a20c72f11e59e3ba4551a4bc48">corrNGSm</a>);
<a name="l00741"></a>00741     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#cee2a0d50823b17fb488974140b4cf36">cleNGSmp</a>);
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>){
<a name="l00744"></a>00744     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#5624b2fcac9387ae85b62b5e44859ccb">cleptomo</a>);
<a name="l00745"></a>00745     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#cb2343b0ab41ed2017b12161da590ab4">clmptomo</a>);
<a name="l00746"></a>00746     }
<a name="l00747"></a>00747     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00748"></a>00748     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>[iwfs])
<a name="l00749"></a>00749         dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>[iwfs]);
<a name="l00750"></a>00750     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>[iwfs])
<a name="l00751"></a>00751         ccellfree(simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>[iwfs]);
<a name="l00752"></a>00752     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>[iwfs])
<a name="l00753"></a>00753         dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>[iwfs]);
<a name="l00754"></a>00754     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#1c33b2746b273def2a8b91c078e04e43">wfspsfoutcellarr</a>[iwfs])
<a name="l00755"></a>00755         <a class="code" href="cellarr_8c.html#1befd9e7d6ab8731df1fcc80e6c35b57" title="Close the cellarr.">cellarr_close</a>(simu-&gt;<a class="code" href="structSIM__T.html#1c33b2746b273def2a8b91c078e04e43">wfspsfoutcellarr</a>[iwfs]);
<a name="l00756"></a>00756     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#52a7f7ea349954a1de5660339c3d1246">ztiltoutcellarr</a>[iwfs])
<a name="l00757"></a>00757         <a class="code" href="cellarr_8c.html#1befd9e7d6ab8731df1fcc80e6c35b57" title="Close the cellarr.">cellarr_close</a>(simu-&gt;<a class="code" href="structSIM__T.html#52a7f7ea349954a1de5660339c3d1246">ztiltoutcellarr</a>[iwfs]);
<a name="l00758"></a>00758     <span class="comment">//free(simu-&gt;wfs_rand[iwfs]);</span>
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#bf25c10a8c8ac84b7745e2834bb52a16">evlpsfhist</a>){
<a name="l00761"></a>00761     <span class="keyword">const</span> <span class="keywordtype">int</span> nevl=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>;
<a name="l00762"></a>00762     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;nevl; ievl++){
<a name="l00763"></a>00763         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#bf25c10a8c8ac84b7745e2834bb52a16">evlpsfhist</a>[ievl]){
<a name="l00764"></a>00764         <a class="code" href="cellarr_8c.html#1befd9e7d6ab8731df1fcc80e6c35b57" title="Close the cellarr.">cellarr_close</a>(simu-&gt;<a class="code" href="structSIM__T.html#bf25c10a8c8ac84b7745e2834bb52a16">evlpsfhist</a>[ievl]);
<a name="l00765"></a>00765         }
<a name="l00766"></a>00766         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#4cb9542747fe08a763f0f70da1111214">evlpsftomohist</a>[ievl]){
<a name="l00767"></a>00767         <a class="code" href="cellarr_8c.html#1befd9e7d6ab8731df1fcc80e6c35b57" title="Close the cellarr.">cellarr_close</a>(simu-&gt;<a class="code" href="structSIM__T.html#4cb9542747fe08a763f0f70da1111214">evlpsftomohist</a>[ievl]);
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     free(simu-&gt;<a class="code" href="structSIM__T.html#bf25c10a8c8ac84b7745e2834bb52a16">evlpsfhist</a>);
<a name="l00771"></a>00771     }
<a name="l00772"></a>00772     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#4037361401c5977a3798921e2e5b8a2c">evlpsfmean</a>){
<a name="l00773"></a>00773     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#4037361401c5977a3798921e2e5b8a2c">evlpsfmean</a>);
<a name="l00774"></a>00774     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#62461b878ba4da08a310c2edd070de64">evlpsfolmean</a>);
<a name="l00775"></a>00775     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#3543ea582865503921076eb72e4ef9c9">evlpsftomomean</a>);
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777     free(simu-&gt;<a class="code" href="structSIM__T.html#da7dc24074ead7e87d800f8b99584fce">ints</a>);
<a name="l00778"></a>00778     free(simu-&gt;<a class="code" href="structSIM__T.html#7175cc941d5dbae02503ff90df35a7b3">wfspsfout</a>);
<a name="l00779"></a>00779     free(simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>);
<a name="l00780"></a>00780     free(simu-&gt;<a class="code" href="structSIM__T.html#1c33b2746b273def2a8b91c078e04e43">wfspsfoutcellarr</a>);
<a name="l00781"></a>00781     free(simu-&gt;<a class="code" href="structSIM__T.html#52a7f7ea349954a1de5660339c3d1246">ztiltoutcellarr</a>);
<a name="l00782"></a>00782     <span class="comment">//free(simu-&gt;atm_rand);</span>
<a name="l00783"></a>00783     free(simu-&gt;<a class="code" href="structSIM__T.html#c734b503cc64094c916e677bade1313e">wfs_rand</a>);
<a name="l00784"></a>00784     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#ee3d52037a51574e3d11586be7c2d708">surfevl</a>);
<a name="l00785"></a>00785     dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#63db4cfd2859ab3331ea32ec21d7b747">surfwfs</a>);
<a name="l00786"></a>00786     dfree(simu-&gt;<a class="code" href="structSIM__T.html#90b521b076481fe938a37cbe4b1c5b79">winddir</a>);
<a name="l00787"></a>00787     dfree(simu-&gt;<a class="code" href="structSIM__T.html#ec5148b2cbcb290d3f6d3e9c6f587b58">windest</a>);
<a name="l00788"></a>00788     spcellfree(simu-&gt;<a class="code" href="structSIM__T.html#c13a335178113fe760f472df5990463b">windshift</a>);
<a name="l00789"></a>00789     close(parms-&gt;<a class="code" href="structPARMS__T.html#9056c1024a1abf5fac4ac86f7edaf195" title="Records the fd of the seed lock file.">fdlock</a>[simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>]);<span class="comment">//release the lock and close the file.</span>
<a name="l00790"></a>00790     {
<a name="l00791"></a>00791     <span class="keywordtype">char</span> fn[80];
<a name="l00792"></a>00792     snprintf(fn, 80, <span class="stringliteral">"Res_%d.lock"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>);
<a name="l00793"></a>00793     (void)<span class="keyword">remove</span>(fn);
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795     free(simu);
<a name="l00796"></a>00796 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="245796513a02d7892e76cea88316394e"></a><!-- doxytag: member="sim_utils.c::save_simu" ref="245796513a02d7892e76cea88316394e" args="(const SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void save_simu           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Save telemetry data during simulation every 50 time steps. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00800"></a>00800                                  {
<a name="l00801"></a>00801     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00802"></a>00802     <span class="keyword">const</span> <span class="keywordtype">int</span> isim=simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>;
<a name="l00803"></a>00803     <span class="keyword">const</span> <span class="keywordtype">int</span> seed=simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>;
<a name="l00804"></a>00804     <span class="keywordflow">if</span>((isim % 50 ==0) || isim+1==parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>){
<a name="l00805"></a>00805     <span class="keywordtype">double</span> scale;
<a name="l00806"></a>00806     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#3888974e340d614e8187d99c9e77c814" title="output time averaged psf">psfmean</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>&gt;=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#b5a659df6062a81bed28af92cdda3b7f" title="time step to start psfmean.">psfisim</a>){
<a name="l00807"></a>00807         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>!=2){
<a name="l00808"></a>00808         scale=1./(double)(simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>-parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#b5a659df6062a81bed28af92cdda3b7f" title="time step to start psfmean.">psfisim</a>+1);
<a name="l00809"></a>00809         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#4037361401c5977a3798921e2e5b8a2c">evlpsfmean</a>){
<a name="l00810"></a>00810             <a class="code" href="sim__utils_8c.html#6788ee66ba9c555c2fe1b7ffba18e7b0" title="Scale a dcell array and save to file.">dcell_mean_and_save</a>(simu-&gt;<a class="code" href="structSIM__T.html#4037361401c5977a3798921e2e5b8a2c">evlpsfmean</a>, scale,
<a name="l00811"></a>00811                     <span class="stringliteral">"evlpsf_%d.bin"</span>,seed);
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813         scale=1./(double)(simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>-parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>+1);
<a name="l00814"></a>00814         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#a5c96a7075da2aba93e96cf95cced062" title="compute Open loop PSF.">psfol</a>==2){
<a name="l00815"></a>00815             scale=scale/parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#93a2b47b0ff2f1e9be0d9453d10c0b44" title="how many directions we compute psf for">npsf</a>;
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#a5c96a7075da2aba93e96cf95cced062" title="compute Open loop PSF.">psfol</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#62461b878ba4da08a310c2edd070de64">evlpsfolmean</a>){
<a name="l00818"></a>00818             <a class="code" href="sim__utils_8c.html#6788ee66ba9c555c2fe1b7ffba18e7b0" title="Scale a dcell array and save to file.">dcell_mean_and_save</a>(simu-&gt;<a class="code" href="structSIM__T.html#62461b878ba4da08a310c2edd070de64">evlpsfolmean</a>,scale,
<a name="l00819"></a>00819                     <span class="stringliteral">"evlpsfol_%d.bin"</span>,seed);
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821         }
<a name="l00822"></a>00822         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#4037361401c5977a3798921e2e5b8a2c">evlpsfmean</a>){
<a name="l00823"></a>00823         scale=1./(double)(simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>-parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#b5a659df6062a81bed28af92cdda3b7f" title="time step to start psfmean.">psfisim</a>+1);
<a name="l00824"></a>00824         <a class="code" href="sim__utils_8c.html#6788ee66ba9c555c2fe1b7ffba18e7b0" title="Scale a dcell array and save to file.">dcell_mean_and_save</a>(simu-&gt;<a class="code" href="structSIM__T.html#3543ea582865503921076eb72e4ef9c9">evlpsftomomean</a>, scale,
<a name="l00825"></a>00825                     <span class="stringliteral">"evlpsftomo_%d.bin"</span>,seed);
<a name="l00826"></a>00826         }
<a name="l00827"></a>00827     }
<a name="l00828"></a>00828     
<a name="l00829"></a>00829     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *sanea=NULL;
<a name="l00830"></a>00830     dcellcp(&amp;sanea, simu-&gt;<a class="code" href="structSIM__T.html#9fa58c6d12a9a59b829d2578c800ab20">sanea_sim</a>);
<a name="l00831"></a>00831     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00832"></a>00832         <span class="keyword">const</span> <span class="keywordtype">int</span> ipowfs=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00833"></a>00833         <span class="keyword">const</span> <span class="keywordtype">int</span> dtrat=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00834"></a>00834         <span class="keywordflow">if</span>(sanea-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs] &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a> &gt;=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#97585440f1dc5d79451e775697d52452" title="frames to start using physical optics.">phystep</a>){
<a name="l00835"></a>00835         <a class="code" href="dmat_8h.html#9a9da6ac02ccf42247a8a78a131ca73a" title="scale each element of A by w">dscale</a>(sanea-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],
<a name="l00836"></a>00836                (<span class="keywordtype">double</span>)dtrat/(<span class="keywordtype">double</span>)(simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>+1-simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#97585440f1dc5d79451e775697d52452" title="frames to start using physical optics.">phystep</a>));
<a name="l00837"></a>00837         }
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(sanea,<span class="stringliteral">"sanea_sim_%d.bin"</span>,seed);
<a name="l00840"></a>00840     dcellfree(sanea);
<a name="l00841"></a>00841     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>){
<a name="l00842"></a>00842         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00843"></a>00843         <span class="keyword">const</span> <span class="keywordtype">int</span> ipowfs=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00844"></a>00844         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>[iwfs]){
<a name="l00845"></a>00845             <span class="keywordtype">int</span> nstep=isim+1-parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#328b58d92aec3a1c2c17afc366ded8a1" title="time step to compute pistatout">pistatstart</a>;
<a name="l00846"></a>00846             <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>* tmp=NULL;
<a name="l00847"></a>00847             dcelladd(&amp;tmp,0,simu-&gt;<a class="code" href="structSIM__T.html#9150a4d2687fb6e309da0a1857930e2e">pistatout</a>[iwfs],1./(<span class="keywordtype">double</span>)nstep);
<a name="l00848"></a>00848             <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#8615676f068e88311d6f774e6cb92354" title="1: we are doing skycoverage preprocessing">skysim</a>){<span class="comment">//need peak in corner</span>
<a name="l00849"></a>00849             <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ic=0; ic&lt;tmp-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>*tmp-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>; ic++){
<a name="l00850"></a>00850                 <a class="code" href="dmat_8h.html#9d9ed91255390f1e4649fc623dfa17ce" title="shift frequency components by n/2">dfftshift</a>(tmp-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ic]);
<a name="l00851"></a>00851             }
<a name="l00852"></a>00852             <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(tmp,<span class="stringliteral">"%s/pistat/pistat_seed%d_sa%d_x%g_y%g.bin"</span>,
<a name="l00853"></a>00853                    dirskysim,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,
<a name="l00854"></a>00854                    parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>,
<a name="l00855"></a>00855                    parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*206265,
<a name="l00856"></a>00856                    parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*206265);
<a name="l00857"></a>00857             }<span class="keywordflow">else</span>{<span class="comment">//need peak in center</span>
<a name="l00858"></a>00858             <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(tmp,<span class="stringliteral">"pistat_seed%d_wfs%d.bin"</span>, simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,iwfs);
<a name="l00859"></a>00859             }
<a name="l00860"></a>00860             dcellfree(tmp);
<a name="l00861"></a>00861         }
<a name="l00862"></a>00862         }
<a name="l00863"></a>00863     }
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#7b62e7127ef7c49d9dda1a7d1f4c7910" title="number of pairs of gradient covariance to compute">ngcov</a>&gt;0 &amp;&amp; ((simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>+1-parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>) % parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#d9d946845f79d17d253a152437f8347e" title="output cumulative gradient covariance average every gcovp step">gcovp</a>) == 0){
<a name="l00866"></a>00866     <span class="keywordtype">double</span> scale=1./(double)(simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>-parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>+1);
<a name="l00867"></a>00867     <a class="code" href="sim__utils_8c.html#6788ee66ba9c555c2fe1b7ffba18e7b0" title="Scale a dcell array and save to file.">dcell_mean_and_save</a>(simu-&gt;<a class="code" href="structSIM__T.html#a627421bfd2a0fa6b2c746463f075bef">gcov</a>, scale, <span class="stringliteral">"gcov_%d/gcov_%d_%d.bin"</span>,
<a name="l00868"></a>00868                 seed,seed,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>+1);
<a name="l00869"></a>00869     }
<a name="l00870"></a>00870 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0be16bd01f2529c9b983cbc5db7fe691"></a><!-- doxytag: member="sim_utils.c::print_progress" ref="0be16bd01f2529c9b983cbc5db7fe691" args="(const SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void print_progress           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Print out wavefront error information and timing at each time step. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00874"></a>00874                                       {
<a name="l00875"></a>00875     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00876"></a>00876     <span class="keyword">const</span> STATUS_T *status=simu-&gt;<a class="code" href="structSIM__T.html#26aad0819c9a098cfc44f9c2ac25ffc7">status</a>;
<a name="l00877"></a>00877     <span class="keyword">const</span> <span class="keywordtype">double</span> tkmean=status-&gt;scale;
<a name="l00878"></a>00878     <span class="keyword">const</span> <span class="keywordtype">long</span> rest=status-&gt;rest;
<a name="l00879"></a>00879     <span class="keyword">const</span> <span class="keywordtype">long</span> laps=status-&gt;laps;
<a name="l00880"></a>00880     <span class="keyword">const</span> <span class="keywordtype">long</span> resth=rest/3600;
<a name="l00881"></a>00881     <span class="keyword">const</span> <span class="keywordtype">long</span> restm=(rest-resth*3600)/60;
<a name="l00882"></a>00882     <span class="keyword">const</span> <span class="keywordtype">long</span> lapsh=laps/3600;
<a name="l00883"></a>00883     <span class="keyword">const</span> <span class="keywordtype">long</span> lapsm=(laps-lapsh*3600)/60;
<a name="l00884"></a>00884     <span class="keyword">const</span> <span class="keywordtype">int</span> isim=simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>;
<a name="l00885"></a>00885     <span class="keyword">const</span> <span class="keywordtype">int</span> nmod=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#0401d88cccdc0585b83e8cb919d82d54" title="Number of modes.">nmod</a>;
<a name="l00886"></a>00886   
<a name="l00887"></a>00887     
<a name="l00888"></a>00888     
<a name="l00889"></a>00889     fprintf(stderr,<span class="stringliteral">"\033[00;32mStep %3d: OL: %6.1f %6.1f %6.1f nm; CL %6.1f %6.1f %6.1f nm;"</span>,
<a name="l00890"></a>00890         isim,
<a name="l00891"></a>00891         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#cb6e3153c3ba12a9310f503d1cb5fa8e">ole</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isim*nmod])*1e9,
<a name="l00892"></a>00892         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#cb6e3153c3ba12a9310f503d1cb5fa8e">ole</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1+isim*nmod])*1e9,
<a name="l00893"></a>00893         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#cb6e3153c3ba12a9310f503d1cb5fa8e">ole</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[2+isim*nmod])*1e9,
<a name="l00894"></a>00894         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#1e10c517d94504ae3b0d3368735364ba">cle</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isim*nmod])*1e9,
<a name="l00895"></a>00895         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#1e10c517d94504ae3b0d3368735364ba">cle</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1+isim*nmod])*1e9,
<a name="l00896"></a>00896         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#1e10c517d94504ae3b0d3368735364ba">cle</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[2+isim*nmod])*1e9);
<a name="l00897"></a>00897     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00898"></a>00898     fprintf(stderr,<span class="stringliteral">" Split %6.1f %6.1f %6.1f nm;"</span>,
<a name="l00899"></a>00899         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#172a004f720d68b39d1239c39b4c1faa">clem</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isim*3])*1e9,
<a name="l00900"></a>00900         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#172a004f720d68b39d1239c39b4c1faa">clem</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1+isim*3])*1e9,
<a name="l00901"></a>00901         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#172a004f720d68b39d1239c39b4c1faa">clem</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[2+isim*3])*1e9);
<a name="l00902"></a>00902     }
<a name="l00903"></a>00903     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9204ffd6eaf3c92a575b306c4a401903" title="evaluate tomography performance.">tomo</a>){
<a name="l00904"></a>00904     fprintf(stderr,<span class="stringliteral">" TOMO %6.1f nm %6.1f nm;"</span>,
<a name="l00905"></a>00905         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#fe4ac255e40b5ebc4c1bab33c1e13550">cletomo</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isim*nmod])*1e9,
<a name="l00906"></a>00906         mysqrt(simu-&gt;<a class="code" href="structSIM__T.html#fe4ac255e40b5ebc4c1bab33c1e13550">cletomo</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[2+isim*nmod])*1e9);
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908     fprintf(stderr,<span class="stringliteral">"\033[00;00m\n"</span>);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     fprintf(stderr,<span class="stringliteral">"Timing:   WFS:%5.2fs Recon:%5.2fs CACHE:%5.2fs EVAL:%5.2fs Tot:%6.2fs."</span>
<a name="l00911"></a>00911         <span class="stringliteral">" Used %ld:%02ld, Left %ld:%02ld\n"</span>,
<a name="l00912"></a>00912         status-&gt;wfs*tkmean, status-&gt;recon*tkmean, 
<a name="l00913"></a>00913         status-&gt;cache*tkmean, status-&gt;eval*tkmean, 
<a name="l00914"></a>00914         status-&gt;tot*tkmean,
<a name="l00915"></a>00915         lapsh,lapsm,resth,restm);
<a name="l00916"></a>00916 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f566f334aaf19cf9ad3ed5a847c2aee9"></a><!-- doxytag: member="sim_utils.c::save_skyc" ref="f566f334aaf19cf9ad3ed5a847c2aee9" args="(POWFS_T *powfs, RECON_T *recon, const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void save_skyc           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Output parameters necessary to run postproc using <a class="el" href="skyc_8c.html" title="This file contains main routine that does the job management and calls setup_parms...">skyc/skyc.c</a>. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00920"></a>00920                                                                     {
<a name="l00921"></a>00921     <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l00922"></a>00922     <span class="keywordtype">int</span> zadeg=(int)round(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#8bec09f88dc7ab71730f50f54bca225e" title="zenith angle in radian">za</a>*180/M_PI);
<a name="l00923"></a>00923     snprintf(fn,PATH_MAX,<span class="stringliteral">"%s/maos.conf"</span>,dirskysim);
<a name="l00924"></a>00924     FILE *fp=fopen(fn,<span class="stringliteral">"w"</span>);
<a name="l00925"></a>00925     fprintf(fp,<span class="stringliteral">"maos.r0z=%g\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#311b33269454ff4d1dbbb5e1d84abf41" title="r0 at zenith">r0z</a>);
<a name="l00926"></a>00926     fprintf(fp,<span class="stringliteral">"maos.dt=%g\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#345f9deab3e2b21f28284e29732af51e" title="sampling period.">dt</a>);
<a name="l00927"></a>00927     fprintf(fp,<span class="stringliteral">"maos.zadeg=%d\n"</span>,zadeg);
<a name="l00928"></a>00928     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>==2){
<a name="l00929"></a>00929     fprintf(fp,<span class="stringliteral">"maos.hc=%g\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[1].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>);
<a name="l00930"></a>00930     }<span class="keywordflow">else</span>{
<a name="l00931"></a>00931     error(<span class="stringliteral">"Invalid"</span>);
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933     fprintf(fp,<span class="stringliteral">"maos.hs=%g\n"</span>,recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#13b17076926281174eafb963077daab5">hs</a>);
<a name="l00934"></a>00934     fprintf(fp,<span class="stringliteral">"maos.nmod=%d\n"</span>,recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#cae8e0b2e457d89909ae6a3a6c670dd8">nmod</a>);
<a name="l00935"></a>00935     fprintf(fp,<span class="stringliteral">"maos.D=%g\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>);
<a name="l00936"></a>00936     fprintf(fp,<span class="stringliteral">"maos.wvl=["</span>);
<a name="l00937"></a>00937     <span class="keywordtype">int</span> nwvl=0;
<a name="l00938"></a>00938     <span class="keywordtype">int</span> npowfs_ngs=0;
<a name="l00939"></a>00939     <span class="keywordtype">int</span> powfs_ngs[parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>];
<a name="l00940"></a>00940     <span class="keywordtype">double</span> ngsgrid=0;
<a name="l00941"></a>00941     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l00942"></a>00942     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l00943"></a>00943         powfs_ngs[npowfs_ngs++]=ipowfs;
<a name="l00944"></a>00944         <span class="keywordflow">if</span>(nwvl==0){
<a name="l00945"></a>00945         nwvl=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;
<a name="l00946"></a>00946         }<span class="keywordflow">else</span>{
<a name="l00947"></a>00947         <span class="keywordflow">if</span>(nwvl!=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>){
<a name="l00948"></a>00948             error(<span class="stringliteral">"Different low order WFS has different wvl\n"</span>);
<a name="l00949"></a>00949         }
<a name="l00950"></a>00950         }
<a name="l00951"></a>00951         <span class="keywordtype">double</span> sepmean=0;
<a name="l00952"></a>00952         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> indwfs=0; indwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>-1; indwfs++){
<a name="l00953"></a>00953         <span class="keywordtype">int</span> iwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ac1b34e2f1f4455c53212bc350f5064b" title="indwfs[iwfs] gives the index of the wfs in this powfs group">indwfs</a>[indwfs];
<a name="l00954"></a>00954         <span class="keywordtype">int</span> iwfs2=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ac1b34e2f1f4455c53212bc350f5064b" title="indwfs[iwfs] gives the index of the wfs in this powfs group">indwfs</a>[indwfs+1];
<a name="l00955"></a>00955         <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>-parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs2].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>)&lt;1.e-10){
<a name="l00956"></a>00956             <span class="keywordtype">double</span> sep=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs2].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>-parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>;
<a name="l00957"></a>00957             <span class="keywordflow">if</span>(fabs(sepmean)&lt;1e-20){
<a name="l00958"></a>00958             sepmean=sep;
<a name="l00959"></a>00959             }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(fabs(sep-sepmean)&gt;1.e-10){
<a name="l00960"></a>00960             error(<span class="stringliteral">"NGS WFS are not evenly spaced. Unable to determine ngs spacing.\n"</span>);
<a name="l00961"></a>00961             }
<a name="l00962"></a>00962         }
<a name="l00963"></a>00963         <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>-parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs2].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>)&lt;1.e-10){
<a name="l00964"></a>00964             <span class="keywordtype">double</span> sep=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs2].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>-parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>;
<a name="l00965"></a>00965             <span class="keywordflow">if</span>(fabs(sepmean)&lt;1e-20){
<a name="l00966"></a>00966             sepmean=sep;
<a name="l00967"></a>00967             }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(fabs(sep-sepmean)&gt;1.e-10){
<a name="l00968"></a>00968             error(<span class="stringliteral">"NGS WFS are not evenly spaced. Unable to determine ngs spacing.\n"</span>);
<a name="l00969"></a>00969             }
<a name="l00970"></a>00970         }
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972         <span class="keywordflow">if</span>(fabs(sepmean)&gt;1.e-20){
<a name="l00973"></a>00973         <span class="keywordflow">if</span>(fabs(ngsgrid)&lt;1.e-20){
<a name="l00974"></a>00974             ngsgrid=sepmean;
<a name="l00975"></a>00975         }<span class="keywordflow">else</span>{
<a name="l00976"></a>00976             <span class="keywordflow">if</span>(fabs(sepmean-ngsgrid)&gt;1.e-10){
<a name="l00977"></a>00977             error(<span class="stringliteral">"Different NGS POWFS have different spacing\n"</span>);
<a name="l00978"></a>00978             }
<a name="l00979"></a>00979         }
<a name="l00980"></a>00980         }
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982     }
<a name="l00983"></a>00983     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00984"></a>00984     fprintf(fp,<span class="stringliteral">"%g "</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[powfs_ngs[0]].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[iwvl]);
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986     fprintf(fp,<span class="stringliteral">"]\n"</span>);  
<a name="l00987"></a>00987     fprintf(fp,<span class="stringliteral">"maos.ngsgrid=%g\n"</span>,ngsgrid*206265);
<a name="l00988"></a>00988     fprintf(fp,<span class="stringliteral">"maos.npowfs=%d\n"</span>,npowfs_ngs);
<a name="l00989"></a>00989     fprintf(fp,<span class="stringliteral">"maos.msa=["</span>);
<a name="l00990"></a>00990     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l00991"></a>00991     fprintf(fp,<span class="stringliteral">"%d "</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[powfs_ngs[ipowfs]].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>);
<a name="l00992"></a>00992     }
<a name="l00993"></a>00993     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l00994"></a>00994     fprintf(fp,<span class="stringliteral">"maos.nsa=["</span>);
<a name="l00995"></a>00995     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l00996"></a>00996     fprintf(fp,<span class="stringliteral">"%ld "</span>,powfs[powfs_ngs[ipowfs]].pts-&gt;nsa);
<a name="l00997"></a>00997     }
<a name="l00998"></a>00998     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l00999"></a>00999     fprintf(fp,<span class="stringliteral">"maos.ncomp=["</span>);
<a name="l01000"></a>01000     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l01001"></a>01001     fprintf(fp,<span class="stringliteral">"%d "</span>,powfs[powfs_ngs[ipowfs]].ncompx);
<a name="l01002"></a>01002     <span class="keywordflow">if</span>(powfs[powfs_ngs[ipowfs]].ncompx!=powfs[powfs_ngs[ipowfs]].ncompy){
<a name="l01003"></a>01003         error(<span class="stringliteral">"Invalid\n"</span>);
<a name="l01004"></a>01004     }
<a name="l01005"></a>01005     }
<a name="l01006"></a>01006     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01007"></a>01007     fprintf(fp,<span class="stringliteral">"maos.embfac=["</span>);
<a name="l01008"></a>01008     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l01009"></a>01009     fprintf(fp,<span class="stringliteral">"%d "</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[powfs_ngs[ipowfs]].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>);
<a name="l01010"></a>01010     }
<a name="l01011"></a>01011     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01012"></a>01012     
<a name="l01013"></a>01013     fprintf(fp,<span class="stringliteral">"maos.dxsa=["</span>);
<a name="l01014"></a>01014     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l01015"></a>01015     fprintf(fp,<span class="stringliteral">"%g "</span>,powfs[powfs_ngs[ipowfs]].pts-&gt;dsa);
<a name="l01016"></a>01016     }
<a name="l01017"></a>01017     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01018"></a>01018     
<a name="l01019"></a>01019     fprintf(fp,<span class="stringliteral">"maos.fnwfsloc=["</span>);
<a name="l01020"></a>01020     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l01021"></a>01021     fprintf(fp,<span class="stringliteral">"\"powfs%d_loc.bin.gz\","</span> ,powfs_ngs[ipowfs]);
<a name="l01022"></a>01022     }
<a name="l01023"></a>01023     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01024"></a>01024     
<a name="l01025"></a>01025     fprintf(fp,<span class="stringliteral">"maos.fnwfsamp=["</span>);
<a name="l01026"></a>01026     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l01027"></a>01027     fprintf(fp,<span class="stringliteral">"\"powfs%d_amp.bin.gz\","</span> ,powfs_ngs[ipowfs]);
<a name="l01028"></a>01028     }
<a name="l01029"></a>01029     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01030"></a>01030     
<a name="l01031"></a>01031     fprintf(fp,<span class="stringliteral">"maos.fnsaloc=["</span>);
<a name="l01032"></a>01032     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l01033"></a>01033     fprintf(fp,<span class="stringliteral">"\"powfs%d_saloc.bin.gz\","</span> ,powfs_ngs[ipowfs]);
<a name="l01034"></a>01034     }
<a name="l01035"></a>01035     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01036"></a>01036     
<a name="l01037"></a>01037     fprintf(fp,<span class="stringliteral">"maos.fnmideal=\"RescleNGSm\"\n"</span>);
<a name="l01038"></a>01038     fprintf(fp,<span class="stringliteral">"maos.fnmidealp=\"RescleNGSmp\"\n"</span>);
<a name="l01039"></a>01039     fprintf(fp,<span class="stringliteral">"maos.evlindoa=%d\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#1a4adc47bdaa62f95418783e1506ac67" title="index of the on axis evluation point.">indoa</a>);
<a name="l01040"></a>01040     fprintf(fp,<span class="stringliteral">"maos.fnmcc=\"MCC_za%d.bin.gz\"\n"</span>,zadeg);
<a name="l01041"></a>01041     fprintf(fp,<span class="stringliteral">"maos.fnmcc_oa=\"MCC_OA_za%d.bin.gz\"\n"</span>,zadeg);
<a name="l01042"></a>01042     
<a name="l01043"></a>01043     fprintf(fp,<span class="stringliteral">"maos.seeds=["</span>);
<a name="l01044"></a>01044     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iseed=0; iseed&lt;parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#6021b395d1b8ca9bb3f3449b67ed7935" title="How many simulation seed.">nseed</a>; iseed++){
<a name="l01045"></a>01045     fprintf(fp,<span class="stringliteral">"%d "</span> ,parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#483429d04a2de324a443780025083dda" title="simulation seeds">seeds</a>[iseed]);
<a name="l01046"></a>01046     }
<a name="l01047"></a>01047     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01048"></a>01048 
<a name="l01049"></a>01049     fprintf(fp,<span class="stringliteral">"include=\"skyc.conf\"\n"</span>);
<a name="l01050"></a>01050     fprintf(fp,<span class="stringliteral">"include=\"skyc_za%d.conf\"\n"</span>,zadeg);
<a name="l01051"></a>01051     fprintf(fp,<span class="stringliteral">"maos.wddeg=["</span>);
<a name="l01052"></a>01052     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#f377ac265c4e8778949386b5c78c9ba6" title="number of phase screens">nps</a>; ips++){
<a name="l01053"></a>01053     fprintf(fp, <span class="stringliteral">"%.2f "</span>, parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#c14a4c67cce4eab1f36b6cf7cd497754" title="wind direction of each layer">wddeg</a>[ips]);
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055     fprintf(fp,<span class="stringliteral">"]\n"</span>);
<a name="l01056"></a>01056     fprintf(fp,<span class="stringliteral">"maos.nstep=%d\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7939a4003b5c376eb09702a8a1572ce5" title="time step to stop simulation.">end</a>);
<a name="l01057"></a>01057     fclose(fp);
<a name="l01058"></a>01058     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs_ngs; ipowfs++){
<a name="l01059"></a>01059     <span class="keywordtype">int</span> jpowfs=powfs_ngs[ipowfs];
<a name="l01060"></a>01060     locwrite(powfs[jpowfs].loc,<span class="stringliteral">"%s/powfs%d_loc.bin.gz"</span>,dirskysim,jpowfs);
<a name="l01061"></a>01061     <a class="code" href="bin_8c.html#07e8fcd0256fd8377d0bb0d86bfd3c53" title="Write a double array of size nx*ny to file.">writedbl</a>(powfs[jpowfs].amp,powfs[jpowfs].loc-&gt;nloc,1,
<a name="l01062"></a>01062          <span class="stringliteral">"%s/powfs%d_amp.bin.gz"</span>,dirskysim,jpowfs);
<a name="l01063"></a>01063     locwrite(powfs[jpowfs].saloc,<span class="stringliteral">"%s/powfs%d_saloc.bin.gz"</span>,dirskysim,jpowfs);
<a name="l01064"></a>01064     }
<a name="l01065"></a>01065     <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#7a8f4d2ffc082c0a6180fcfd67bddb18">MCC</a>,<span class="stringliteral">"%s/MCC_za%d.bin.gz"</span>, dirskysim,zadeg);
<a name="l01066"></a>01066     <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#d647f344bd6f0b22fa4e7d29251358e8">MCC_OA</a>,<span class="stringliteral">"%s/MCC_OA_za%d.bin.gz"</span>, dirskysim,zadeg);
<a name="l01067"></a>01067 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 27 12:43:14 2010 for maos-0.6.1 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
