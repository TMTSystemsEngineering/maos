<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.6.4: maos/mtch.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/mtch.c File Reference</h1>Setting up matched filter.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2mtch_8c.html#4e92fad39aa9b75b81c20b9a4c3d12a2">mki0shx</a> (double *i0x1, double *i0x2, <a class="el" href="structdmat.html">dmat</a> *i0, double scale)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">shift i0 without wraping into i0x1 (+1) and i0x2 (-1)  <a href="#4e92fad39aa9b75b81c20b9a4c3d12a2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2mtch_8c.html#339982ae0e776543172cef78798ccba6">mki0shy</a> (double *i0y1, double *i0y2, <a class="el" href="structdmat.html">dmat</a> *i0, double scale)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">shift i0 without wraping into i0y1 (+1) and i0y2 (-1)  <a href="#339982ae0e776543172cef78798ccba6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2mtch_8c.html#23fcbf812ba1ea247e03dab86cd69df0">genmtch</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The routine used to generate matched filter from WFS mean short exposure pixel intensities.  <a href="#23fcbf812ba1ea247e03dab86cd69df0"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Setting up matched filter. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="4e92fad39aa9b75b81c20b9a4c3d12a2"></a><!-- doxytag: member="mtch.c::mki0shx" ref="4e92fad39aa9b75b81c20b9a4c3d12a2" args="(double *i0x1, double *i0x2, dmat *i0, double scale)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void mki0shx           </td>
          <td>(</td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>i0x1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>i0x2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>i0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>scale</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
shift i0 without wraping into i0x1 (+1) and i0x2 (-1) 
<p>
<div class="fragment"><pre class="fragment"><a name="l00028"></a>00028                                                                        {
<a name="l00029"></a>00029     <span class="keywordtype">int</span> nx=i0-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>;
<a name="l00030"></a>00030     double (*i0p)[nx]=(<span class="keywordtype">void</span>*)i0-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00031"></a>00031     double (*i0x1p)[nx]=(<span class="keywordtype">void</span>*)i0x1;
<a name="l00032"></a>00032     double (*i0x2p)[nx]=(<span class="keywordtype">void</span>*)i0x2;
<a name="l00033"></a>00033     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;i0-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>; iy++){
<a name="l00034"></a>00034     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;i0-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>-1; ix++){
<a name="l00035"></a>00035         i0x1p[iy][ix+1]=i0p[iy][ix]*scale;
<a name="l00036"></a>00036         i0x2p[iy][ix]=i0p[iy][ix+1]*scale;
<a name="l00037"></a>00037     }
<a name="l00038"></a>00038     }
<a name="l00039"></a>00039 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="339982ae0e776543172cef78798ccba6"></a><!-- doxytag: member="mtch.c::mki0shy" ref="339982ae0e776543172cef78798ccba6" args="(double *i0y1, double *i0y2, dmat *i0, double scale)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void mki0shy           </td>
          <td>(</td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>i0y1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>i0y2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>i0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>scale</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
shift i0 without wraping into i0y1 (+1) and i0y2 (-1) 
<p>
<div class="fragment"><pre class="fragment"><a name="l00044"></a>00044                                                                        {
<a name="l00045"></a>00045     <span class="keywordtype">int</span> nx=i0-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>;
<a name="l00046"></a>00046     double (*i0p)[nx]=(<span class="keywordtype">void</span>*)i0-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00047"></a>00047     double (*i0y1p)[nx]=(<span class="keywordtype">void</span>*)i0y1;
<a name="l00048"></a>00048     double (*i0y2p)[nx]=(<span class="keywordtype">void</span>*)i0y2;
<a name="l00049"></a>00049     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;i0-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>-1; iy++){
<a name="l00050"></a>00050     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;i0-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; ix++){
<a name="l00051"></a>00051         i0y1p[iy+1][ix]=i0p[iy][ix]*scale;
<a name="l00052"></a>00052         i0y2p[iy][ix]=i0p[iy+1][ix]*scale;
<a name="l00053"></a>00053     }
<a name="l00054"></a>00054     }
<a name="l00055"></a>00055 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="23fcbf812ba1ea247e03dab86cd69df0"></a><!-- doxytag: member="mtch.c::genmtch" ref="23fcbf812ba1ea247e03dab86cd69df0" args="(const PARMS_T *parms, POWFS_T *powfs, const int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void genmtch           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
The routine used to generate matched filter from WFS mean short exposure pixel intensities. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00060"></a>00060                                                                     {
<a name="l00061"></a>00061     <span class="keywordflow">if</span>(!powfs[ipowfs].intstat){
<a name="l00062"></a>00062     error(<span class="stringliteral">"Please create intstat before calling mtch"</span>);
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064     <span class="keyword">const</span> <span class="keywordtype">double</span> pixtheta=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#adf117b796aef86ac0b1759f81ad59fd" title="size of pixel pitch along x or y in radian">pixtheta</a>;
<a name="l00065"></a>00065     <span class="keyword">const</span> <span class="keywordtype">double</span> kp=1./pixtheta;
<a name="l00066"></a>00066     <span class="keyword">const</span> <span class="keywordtype">double</span> rne=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a33b760c70db9950fd09ba10aad23931" title="read out noise in electron per pixel per frame">rne</a>;
<a name="l00067"></a>00067     <span class="keyword">const</span> <span class="keywordtype">double</span> bkgrndfn_res=(1.-parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#8525cf543d090902082c59c2c4ce1567" title="How much of the background in bkgrndfn can be calibrated out.">bkgrndrm</a>);
<a name="l00068"></a>00068     <span class="keyword">const</span> <span class="keywordtype">double</span> bkgrnd=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#847860bab1665b17b5e85d502a4485e0" title="background in electron per pixel per LGS frame">bkgrnd</a>*parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00069"></a>00069     <span class="keyword">const</span> <span class="keywordtype">int</span> sub_i0=1;<span class="comment">//doesn't make any difference.</span>
<a name="l00070"></a>00070     <span class="keywordtype">int</span> ni0=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#17e9e1cb4c6fa2c3d568309f19536c6b">i0</a>-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>;
<a name="l00071"></a>00071     <span class="keywordflow">if</span>(ni0!=1 &amp;&amp; ni0!=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>){
<a name="l00072"></a>00072     error(<span class="stringliteral">"ni0 should be either 1 or %d\n"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>);
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074     <span class="keyword">const</span> <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00075"></a>00075     <span class="keywordflow">if</span>(powfs[ipowfs].intstat-&gt;mtche){
<a name="l00076"></a>00076     warning(<span class="stringliteral">"powfs %d: matched filter already exists. free them\n"</span>,ipowfs);
<a name="l00077"></a>00077     dcellfree(powfs[ipowfs].intstat-&gt;mtche);
<a name="l00078"></a>00078     dcellfree(powfs[ipowfs].intstat-&gt;sanea);
<a name="l00079"></a>00079     dcellfree(powfs[ipowfs].intstat-&gt;saneara);
<a name="l00080"></a>00080     dcellfree(powfs[ipowfs].intstat-&gt;saneaxy);
<a name="l00081"></a>00081     dcellfree(powfs[ipowfs].intstat-&gt;saneaixy);
<a name="l00082"></a>00082     dfree(powfs[ipowfs].intstat-&gt;i0sum);
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#0165680cc8d86944018418a1e361df81">mtche</a>=dcellnew(nsa,ni0);
<a name="l00085"></a>00085     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#819af79d00b50193756b47c766425129">sanea</a>=dcellnew(ni0,1);
<a name="l00086"></a>00086     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#5283c52d0c42cde7190b481307cabf46">saneara</a>=dcellnew(nsa,ni0);
<a name="l00087"></a>00087     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#02032157ea0454eaee56b5f9d9ebed16">saneaxy</a>=dcellnew(nsa,ni0);
<a name="l00088"></a>00088     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#98a206f564e70b7e42ffea0f441f86b3">saneaixy</a>=dcellnew(nsa,ni0);
<a name="l00089"></a>00089     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#c3579bfed8599c928d05aac5cd109d82">i0sum</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa,ni0);
<a name="l00090"></a>00090     PDCELL(powfs[ipowfs].intstat-&gt;i0,i0s);
<a name="l00091"></a>00091     PDCELL(powfs[ipowfs].intstat-&gt;gx,gxs);
<a name="l00092"></a>00092     PDCELL(powfs[ipowfs].intstat-&gt;gy,gys);
<a name="l00093"></a>00093     PDMAT(powfs[ipowfs].intstat-&gt;i0sum,i0sum);
<a name="l00094"></a>00094     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *(*mtche)[nsa]=
<a name="l00095"></a>00095     (<a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a>*(*)[nsa])powfs[ipowfs].intstat-&gt;mtche-&gt;p;
<a name="l00096"></a>00096     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *(*saneaxy)[nsa]
<a name="l00097"></a>00097     =(<span class="keywordtype">void</span>*)powfs[ipowfs].intstat-&gt;saneaxy-&gt;p;
<a name="l00098"></a>00098     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *(*saneaixy)[nsa]
<a name="l00099"></a>00099     =(<span class="keywordtype">void</span>*)powfs[ipowfs].intstat-&gt;saneaixy-&gt;p;
<a name="l00100"></a>00100     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *(*saneara)[nsa]=NULL;
<a name="l00101"></a>00101     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beacabf44ba95b84fa2ec6b4460f5364" title="number of detector pixels along radial direction if radial CCD">radpix</a>){
<a name="l00102"></a>00102     saneara=(<span class="keywordtype">void</span>*)powfs[ipowfs].intstat-&gt;saneara-&gt;p;
<a name="l00103"></a>00103     }
<a name="l00104"></a>00104     <span class="keywordtype">int</span> nllt;
<a name="l00105"></a>00105     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>){
<a name="l00106"></a>00106     nllt=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#4b3cd998f117485fdcb8de6805fef38b" title="number of launch telescopes in this powfs">n</a>;
<a name="l00107"></a>00107     }<span class="keywordflow">else</span>{
<a name="l00108"></a>00108     nllt=0;
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110     <span class="keywordtype">int</span> irot_multiplier=nllt&gt;1?1:0;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="keywordtype">int</span> nmod=3;
<a name="l00113"></a>00113     <span class="keywordtype">int</span> mtchcrx=0;
<a name="l00114"></a>00114     <span class="keywordtype">int</span> mtchcry=0;
<a name="l00115"></a>00115     <span class="keywordtype">double</span> shiftx=0, shifty=0;
<a name="l00116"></a>00116     <span class="comment">//always use saved i0. cyclic shift is not good</span>
<a name="l00117"></a>00117     <span class="comment">//because of the wrapped ring.</span>
<a name="l00118"></a>00118     <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#e98503e618818d78c41ba76c168df7b0" title="if &amp;gt;0 use constrained mtch for x for this amount of pixels">mtchcrx</a>)&gt;1.e-10){
<a name="l00119"></a>00119     shiftx=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#e98503e618818d78c41ba76c168df7b0" title="if &amp;gt;0 use constrained mtch for x for this amount of pixels">mtchcrx</a>;
<a name="l00120"></a>00120     mtchcrx=nmod;
<a name="l00121"></a>00121     nmod+=2;
<a name="l00122"></a>00122     <span class="keywordflow">if</span>(fabs(shiftx-1)&gt;1.e-10){
<a name="l00123"></a>00123         error(<span class="stringliteral">"Only constraint of 1 pixel is implemented\n"</span>);
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126     <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#cee927819560b5eff64b0d2d7ec1f7b2" title="if &amp;gt;0 use constrained mtch for y for this amount of pixels">mtchcry</a>)&gt;1.e-10){
<a name="l00127"></a>00127     shifty=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#cee927819560b5eff64b0d2d7ec1f7b2" title="if &amp;gt;0 use constrained mtch for y for this amount of pixels">mtchcry</a>;
<a name="l00128"></a>00128     mtchcry=nmod;
<a name="l00129"></a>00129     nmod+=2;
<a name="l00130"></a>00130     <span class="keywordflow">if</span>(fabs(shifty-1)&gt;1.e-10){
<a name="l00131"></a>00131         error(<span class="stringliteral">"Only constraint of 1 pixel is implemented\n"</span>);
<a name="l00132"></a>00132     }
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134     <span class="keyword">const</span> <span class="keywordtype">int</span> i0n=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#9ec5687c5268785533c22d746016e663">pixpsax</a>*powfs[ipowfs].<a class="code" href="structPOWFS__T.html#091e911bea2900efcc9b160126ebf4ca">pixpsay</a>;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *i0m=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(2,nmod);
<a name="l00137"></a>00137     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *i0g=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(i0n,nmod);
<a name="l00138"></a>00138     PDMAT(i0g, pi0g);
<a name="l00139"></a>00139     PDMAT(i0m, pi0m);
<a name="l00140"></a>00140     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *i0x1=NULL, *i0x2=NULL, *i0y1=NULL, *i0y2=NULL;
<a name="l00141"></a>00141     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *wt=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(i0n,1);
<a name="l00142"></a>00142     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii0=0; ii0&lt;ni0; ii0++){
<a name="l00143"></a>00143     <span class="keywordtype">int</span> iwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#be03195a4e1fece4903a6297931ac09c" title="array of wfs belongs to this powfs">wfs</a>[ii0];
<a name="l00144"></a>00144     <span class="keywordtype">double</span> *srot=NULL;
<a name="l00145"></a>00145     <span class="keywordflow">if</span>(powfs[ipowfs].srot){
<a name="l00146"></a>00146         <span class="keywordtype">int</span> irot=ii0*irot_multiplier;
<a name="l00147"></a>00147         srot=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fd0302013032e547054f9431d7aee502">srot</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[irot]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>-&gt;<a class="code" href="structINTSTAT__T.html#819af79d00b50193756b47c766425129">sanea</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ii0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa,2);
<a name="l00150"></a>00150     PDMAT(powfs[ipowfs].intstat-&gt;sanea-&gt;p[ii0], psanea);
<a name="l00151"></a>00151     pi0m[0][0]=1;
<a name="l00152"></a>00152     pi0m[1][1]=1;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordflow">if</span>(mtchcrx){<span class="comment">//constrained x(radial)</span>
<a name="l00155"></a>00155         <span class="keywordtype">double</span> shift=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#adf117b796aef86ac0b1759f81ad59fd" title="size of pixel pitch along x or y in radian">pixtheta</a>*shiftx;
<a name="l00156"></a>00156         pi0m[mtchcrx][0]=shift*kp;<span class="comment">//k is here to ensure good conditioning</span>
<a name="l00157"></a>00157         pi0m[mtchcrx+1][0]=-shift*kp;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159     <span class="keywordflow">if</span>(mtchcry){<span class="comment">//constrained y(azimuthal).</span>
<a name="l00160"></a>00160         <span class="keywordtype">double</span> shift=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#adf117b796aef86ac0b1759f81ad59fd" title="size of pixel pitch along x or y in radian">pixtheta</a>*shifty;
<a name="l00161"></a>00161         pi0m[mtchcry][1]=shift*kp;
<a name="l00162"></a>00162         pi0m[mtchcry+1][1]=-shift*kp;
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00166"></a>00166         i0sum[ii0][isa]=<a class="code" href="dmat_8h.html#176e534c9042ace51d05a620a2294248" title="create sum of all the elements in A.">dsum</a>(i0s[ii0][isa]);
<a name="l00167"></a>00167         <span class="keywordtype">double</span> siglev=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>*parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ac67dd456e4d3d31400fc9830daf9735" title="Total signal value for all wavelength.">siglev</a>;
<a name="l00168"></a>00168         <span class="keywordflow">if</span>(i0sum[ii0][isa]&lt;siglev*0.05 || i0sum[ii0][isa]&gt;siglev){
<a name="l00169"></a>00169         warning(<span class="stringliteral">"powfs %d: i0 sum to %g, but wfs %d has siglev of %g\n"</span>,
<a name="l00170"></a>00170             ipowfs, i0sum[ii0][isa], iwfs, siglev);
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172         <span class="keywordtype">double</span>* bkgrnd2=NULL;
<a name="l00173"></a>00173         <span class="keywordflow">if</span>(powfs[ipowfs].bkgrnd &amp;&amp; powfs[ipowfs].bkgrnd-&gt;p[ii0*nsa+isa]){
<a name="l00174"></a>00174         bkgrnd2= powfs[ipowfs].<a class="code" href="structPOWFS__T.html#ce22bc0f58b30c9ef182186ef59d18e1">bkgrnd</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ii0*nsa+isa]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>; 
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176         <a class="code" href="dmat_8h.html#e98618064b54869b4180d0c7fd895645" title="initialize all numbers in a X(mat) object to 0">dzero</a>(i0g);<span class="comment">//don't forget to zero out</span>
<a name="l00177"></a>00177         <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[0], 1,gxs[ii0][isa]-&gt;p, i0n, 1);
<a name="l00178"></a>00178         <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[1], 1,gys[ii0][isa]-&gt;p, i0n, 1);
<a name="l00179"></a>00179         <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[2], 1,i0s[ii0][isa]-&gt;p, i0n, kp);
<a name="l00180"></a>00180         <span class="keywordflow">if</span>(powfs[ipowfs].bkgrnd &amp;&amp; powfs[ipowfs].bkgrnd-&gt;p[ii0*nsa+isa]){
<a name="l00181"></a>00181         <span class="comment">//notice that the bkgrnd is already scaled by sim.dt and dtrat properly.</span>
<a name="l00182"></a>00182         <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[2], 1, bkgrnd2, i0n, bkgrndfn_res);
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184         <span class="keywordflow">if</span>(mtchcrx){
<a name="l00185"></a>00185         <span class="comment">/*</span>
<a name="l00186"></a>00186 <span class="comment">          constrained matched filter. compute separately for each wfs.</span>
<a name="l00187"></a>00187 <span class="comment">        */</span>
<a name="l00188"></a>00188         <a class="code" href="maos_2mtch_8c.html#4e92fad39aa9b75b81c20b9a4c3d12a2" title="shift i0 without wraping into i0x1 (+1) and i0x2 (-1)">mki0shx</a>(pi0g[mtchcrx],pi0g[mtchcrx+1],i0s[ii0][isa],kp);
<a name="l00189"></a>00189         <span class="keywordflow">if</span>(sub_i0){
<a name="l00190"></a>00190             <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcrx],1,i0s[ii0][isa]-&gt;p, i0n, -kp);
<a name="l00191"></a>00191             <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcrx+1],1,i0s[ii0][isa]-&gt;p, i0n, -kp);
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193         <span class="keywordflow">if</span>(bkgrnd2){
<a name="l00194"></a>00194             <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcrx], 1, bkgrnd2, i0n, bkgrndfn_res);
<a name="l00195"></a>00195             <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcrx+1],1,bkgrnd2,i0n,  bkgrndfn_res);
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198         <span class="keywordflow">if</span>(mtchcry){
<a name="l00199"></a>00199         <a class="code" href="maos_2mtch_8c.html#339982ae0e776543172cef78798ccba6" title="shift i0 without wraping into i0y1 (+1) and i0y2 (-1)">mki0shy</a>(pi0g[mtchcry],pi0g[mtchcry+1],i0s[ii0][isa],kp);
<a name="l00200"></a>00200         <span class="keywordflow">if</span>(sub_i0){
<a name="l00201"></a>00201             <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcry],1,i0s[ii0][isa]-&gt;p, i0n, -kp);
<a name="l00202"></a>00202             <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcry+1],1,i0s[ii0][isa]-&gt;p,i0n, -kp);
<a name="l00203"></a>00203         }
<a name="l00204"></a>00204          <span class="keywordflow">if</span>(bkgrnd2){ 
<a name="l00205"></a>00205              <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcry], 1, bkgrnd2, i0n, bkgrndfn_res);
<a name="l00206"></a>00206              <a class="code" href="mathmisc_8c.html#e6678a16da8597133231f3c10f1adb40" title="add two double vectors: out=out*alpha+in*beta">adddbl</a>(pi0g[mtchcry+1],1, bkgrnd2,i0n,  bkgrndfn_res);
<a name="l00207"></a>00207         }
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209       
<a name="l00210"></a>00210         <span class="keywordflow">if</span>(bkgrnd2){
<a name="l00211"></a>00211         <span class="comment">//adding rayleigh backscatter poisson noise.</span>
<a name="l00212"></a>00212         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;i0n; i++){<span class="comment">//noise weighting.</span>
<a name="l00213"></a>00213             wt-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i]=1./(rne*rne+bkgrnd+i0s[ii0][isa]-&gt;p[i]+bkgrnd2[i]);
<a name="l00214"></a>00214         }   
<a name="l00215"></a>00215         }<span class="keywordflow">else</span>{
<a name="l00216"></a>00216         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;i0n; i++){<span class="comment">//noise weighting.</span>
<a name="l00217"></a>00217             wt-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i]=1./(rne*rne+bkgrnd+i0s[ii0][isa]-&gt;p[i]);
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219         }
<a name="l00220"></a>00220         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *tmp=<a class="code" href="dmat_8h.html#cac32a8e663201109abf36bd322e9a46" title="compute the pseudo inverse of matrix A with weigthing of full matrix W or sparse...">dpinv</a>(i0g, wt, NULL);
<a name="l00221"></a>00221         
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;mtche[ii0][isa],i0m, tmp, <span class="stringliteral">"nn"</span>, 1);
<a name="l00224"></a>00224         dfree(tmp);
<a name="l00225"></a>00225         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;i0n; i++){<span class="comment">//noise weighting.</span>
<a name="l00226"></a>00226         wt-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i]=1./wt-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i];
<a name="l00227"></a>00227         }
<a name="l00228"></a>00228         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *nea2=<a class="code" href="dmat_8h.html#81d6ed373bf09f884a5114c8b0f543ac" title="compute (A*W*A&amp;#39;); where diag(W)=wt">dtmcc</a>(mtche[ii0][isa], wt);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d4d4430a7f1ecd79ead4a000521a5f47" title="use coupling between r/a measure error">mtchcpl</a>==0){
<a name="l00231"></a>00231         <span class="comment">//remove coupling between r/a measurements.</span>
<a name="l00232"></a>00232         nea2-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1]=nea2-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[2]=0;
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234         psanea[0][isa]=nea2-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];
<a name="l00235"></a>00235         psanea[1][isa]=nea2-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[3];
<a name="l00236"></a>00236         
<a name="l00237"></a>00237         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beacabf44ba95b84fa2ec6b4460f5364" title="number of detector pixels along radial direction if radial CCD">radpix</a>){
<a name="l00238"></a>00238         saneara[ii0][isa]=nea2;
<a name="l00239"></a>00239         <span class="keywordtype">double</span> theta=srot[isa]; 
<a name="l00240"></a>00240         <a class="code" href="dmat_8h.html#b4e3ddd0d5e6249c6d90c26991d8028c" title="rotate a 2x2 covariance matrix A by theta CCW (coordinate rotate -theta CCW) or from...">drotvecnn</a>(&amp;saneaxy[ii0][isa], saneara[ii0][isa], theta);
<a name="l00241"></a>00241         }<span class="keywordflow">else</span>{
<a name="l00242"></a>00242         saneaxy[ii0][isa]=nea2;
<a name="l00243"></a>00243         }
<a name="l00244"></a>00244         saneaixy[ii0][isa]=<a class="code" href="dmat_8h.html#30ba84a58a9c9dd2e0a0afb5e389ffad" title="out of place version of dinvspd_inplace">dinvspd</a>(saneaxy[ii0][isa]);
<a name="l00245"></a>00245     }<span class="comment">//isa </span>
<a name="l00246"></a>00246     }<span class="comment">//ii0</span>
<a name="l00247"></a>00247     info2(<span class="stringliteral">"powfs %d: matched filter sanea:\n"</span>,ipowfs);
<a name="l00248"></a>00248     <span class="keywordflow">if</span>(powfs[ipowfs].sprint){
<a name="l00249"></a>00249     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#4b3cd998f117485fdcb8de6805fef38b" title="number of launch telescopes in this powfs">n</a>!=ni0){
<a name="l00250"></a>00250         warning(<span class="stringliteral">"nllt!=ni0\n"</span>);
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii0=0; ii0&lt;ni0; ii0++){
<a name="l00253"></a>00253         <span class="keywordtype">int</span> illt=0;
<a name="l00254"></a>00254         <span class="keywordflow">if</span>(ni0==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#4b3cd998f117485fdcb8de6805fef38b" title="number of launch telescopes in this powfs">n</a>){
<a name="l00255"></a>00255         illt=ii0;
<a name="l00256"></a>00256         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(ni0==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#4b3cd998f117485fdcb8de6805fef38b" title="number of launch telescopes in this powfs">n</a>==1){
<a name="l00257"></a>00257         illt=0;
<a name="l00258"></a>00258         }<span class="keywordflow">else</span>{
<a name="l00259"></a>00259         error(<span class="stringliteral">"Invalid combination\n"</span>);
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261         info2(<span class="stringliteral">"llt %d:\n"</span>,illt);
<a name="l00262"></a>00262         PDMAT(powfs[ipowfs].intstat-&gt;sanea-&gt;p[ii0], psanea);
<a name="l00263"></a>00263         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ksa=0; ksa&lt;powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6c60f2cb244e43a6dd87887c98a37c20">sprint</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; ksa++){
<a name="l00264"></a>00264         <span class="keywordtype">int</span> isa=(int)powfs[ipowfs].sprint-&gt;p[illt]-&gt;p[ksa];
<a name="l00265"></a>00265         <span class="keywordflow">if</span>(isa&gt;0){
<a name="l00266"></a>00266             info2(<span class="stringliteral">"sa %4d: %5.1f m, (%6.2f, %6.2f) mas\n"</span>, 
<a name="l00267"></a>00267               isa, powfs[ipowfs].srsa-&gt;p[illt]-&gt;p[isa], 
<a name="l00268"></a>00268               sqrt(psanea[0][isa])*206265000,
<a name="l00269"></a>00269               sqrt(psanea[1][isa])*206265000);
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273     }<span class="keywordflow">else</span>{
<a name="l00274"></a>00274     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii0=0; ii0&lt;ni0; ii0++){
<a name="l00275"></a>00275         info(<span class="stringliteral">"ii0=%d:\n"</span>,ii0);
<a name="l00276"></a>00276         PDMAT(powfs[ipowfs].intstat-&gt;sanea-&gt;p[ii0], psanea);
<a name="l00277"></a>00277         <span class="keywordtype">double</span> dsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ae9e38522a793c7d018028a38fc34ce0" title="Sampling.">dx</a>;
<a name="l00278"></a>00278         <span class="keywordtype">double</span> llimit=-dsa/2;
<a name="l00279"></a>00279         <span class="keywordtype">double</span> ulimit=dsa/2;
<a name="l00280"></a>00280         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00281"></a>00281         <span class="keywordtype">double</span> locx=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[isa];
<a name="l00282"></a>00282         <span class="keywordtype">double</span> locy=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[isa];
<a name="l00283"></a>00283         <span class="keywordflow">if</span>(nsa&lt;10 || (locx&gt;0&amp;&amp;locy&gt;llimit&amp;&amp;locy&lt;ulimit)){
<a name="l00284"></a>00284             info2(<span class="stringliteral">"sa %5d: %5.1f m, (%6.2f, %6.2f) mas\n"</span>, 
<a name="l00285"></a>00285               isa, locx, sqrt(psanea[0][isa])*206265000,
<a name="l00286"></a>00286               sqrt(psanea[1][isa])*206265000);
<a name="l00287"></a>00287         }
<a name="l00288"></a>00288         }<span class="comment">//isa </span>
<a name="l00289"></a>00289     }<span class="comment">//ii0</span>
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00292"></a>00292     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].intstat-&gt;mtche,
<a name="l00293"></a>00293            <span class="stringliteral">"%s/powfs%d_mtche"</span>,dirsetup,ipowfs);
<a name="l00294"></a>00294     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].intstat-&gt;saneara,
<a name="l00295"></a>00295            <span class="stringliteral">"%s/powfs%d_saneara"</span>,dirsetup,ipowfs);
<a name="l00296"></a>00296     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].intstat-&gt;saneaxy,
<a name="l00297"></a>00297            <span class="stringliteral">"%s/powfs%d_saneaxy"</span>,dirsetup,ipowfs);
<a name="l00298"></a>00298     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].intstat-&gt;saneaixy,
<a name="l00299"></a>00299            <span class="stringliteral">"%s/powfs%d_saneaixy"</span>,dirsetup,ipowfs);
<a name="l00300"></a>00300     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].intstat-&gt;sanea,
<a name="l00301"></a>00301            <span class="stringliteral">"%s/powfs%d_sanea"</span>,dirsetup,ipowfs);
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303     dfree(i0m);
<a name="l00304"></a>00304     dfree(i0g);
<a name="l00305"></a>00305     dfree(i0x1); dfree(i0x2); dfree(i0y1); dfree(i0y2);
<a name="l00306"></a>00306     dfree(wt);
<a name="l00307"></a>00307 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 14:37:09 2010 for maos-0.6.4 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
