<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.6.1: maos/setup_powfs.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/setup_powfs.c File Reference</h1>Setting up WFS geometry like the subaperture location, subaperture grid points, physical optics detection transfer function, LGS elongation transfer function, etc.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="e2f2638a878b96a88d02c346d003a0fa"></a><!-- doxytag: member="maos/setup_powfs.c::TEST_POWFS" ref="e2f2638a878b96a88d02c346d003a0fa" args="" -->
#define&nbsp;</td><td class="memItemRight" valign="bottom"><b>TEST_POWFS</b></td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#f500bd9800a3b3f47a36b855a9f88ae9">free_powfs_geom</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free the powfs geometric parameters.  <a href="#f500bd9800a3b3f47a36b855a9f88ae9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#77b6fd986d6105964adf2c844ee9df87">setup_powfs_geom</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structAPER__T.html">APER_T</a> *aper, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">setting up subaperture geometry.  <a href="#77b6fd986d6105964adf2c844ee9df87"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#e92ae33f8f650cb9c7975044bd82432f">setup_powfs_grad</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Creating geometric wavefront gradient operator GS0 and ZA0 from WFS OPD to subaperture grads.  <a href="#e92ae33f8f650cb9c7975044bd82432f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#b1409e69dddf8131559ea35731109bda">setup_powfs_prep_phy</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Prepare the parameters for physical optics setup.  <a href="#b1409e69dddf8131559ea35731109bda"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#2589e29c8b5c4bd05b33da3638e8ae53">setup_powfs_ncpa</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Set up NCPA maps for each WFS.  <a href="#2589e29c8b5c4bd05b33da3638e8ae53"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#692825f333d5738b213e2d6d4f1ab5d5">free_powfs_dtf</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free the detector transfer function.  <a href="#692825f333d5738b213e2d6d4f1ab5d5"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#b1890fbc6facc2013338054962b1398a">setup_powfs_dtf</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setting up Detector transfer function used to translate PSFs from FFTs to detector pixel images.  <a href="#b1890fbc6facc2013338054962b1398a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#7bbae2bc69e06f553d55c7c2d8c68ff3">setup_powfs_focus</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">setup the range to sodium layer as an additional parameter.  <a href="#7bbae2bc69e06f553d55c7c2d8c68ff3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#e2eab1b8ad97f659e38afe630140834e">setup_powfs_sodium</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Load and smooth out sodium profile.  <a href="#e2eab1b8ad97f659e38afe630140834e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#bd59ad37c2a3372a70066e4b5cf34ac1">setup_powfs_etf</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs, int mode, int istep)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compute Elongation Transfer function.  <a href="#bd59ad37c2a3372a70066e4b5cf34ac1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#a8ee626a374ebefb84c2d560793c4c1e">setup_powfs_llt</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">setting up uplink pts/amp lotf  <a href="#a8ee626a374ebefb84c2d560793c4c1e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#a16bf88378b48f5765294689df77c22f">setup_powfs_mtch</a> (<a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int ipowfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the matched filter pixel processing parameters for physical optics wfs.  <a href="#a16bf88378b48f5765294689df77c22f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#c7b704504acb96d7fbcbdd60f15c6cf8">setup_powfs</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structAPER__T.html">APER_T</a> *aper)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the powfs struct based on parms and aper.  <a href="#c7b704504acb96d7fbcbdd60f15c6cf8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2setup__powfs_8c.html#4fdd29141f0d60af1fd7c6b2385f0031">free_powfs</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structPOWFS__T.html">POWFS_T</a> *powfs)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free all parameters of powfs at the end of simulation.  <a href="#4fdd29141f0d60af1fd7c6b2385f0031"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Setting up WFS geometry like the subaperture location, subaperture grid points, physical optics detection transfer function, LGS elongation transfer function, etc. 
<p>
<dl compact><dt><b><a class="el" href="todo.html#_todo000009">Todo:</a></b></dt><dd>isolate DTF, ETF, routines, make then generic interface and relocate to the lib folder.</dd></dl>
Do not use sparse interpolation to replace ray tracing for fine sampled destination grid, especially cubic splines. The interpolation marix takes too much space. <hr><h2>Function Documentation</h2>
<a class="anchor" name="f500bd9800a3b3f47a36b855a9f88ae9"></a><!-- doxytag: member="setup_powfs.c::free_powfs_geom" ref="f500bd9800a3b3f47a36b855a9f88ae9" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void free_powfs_geom           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Free the powfs geometric parameters. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00050"></a>00050                                                                   {
<a name="l00051"></a>00051     <span class="keywordflow">if</span>(!powfs[ipowfs].pts){
<a name="l00052"></a>00052     <span class="keywordflow">return</span>;
<a name="l00053"></a>00053     }
<a name="l00054"></a>00054     ptsfree(powfs[ipowfs].pts);
<a name="l00055"></a>00055     locfree(powfs[ipowfs].saloc);
<a name="l00056"></a>00056     locfree(powfs[ipowfs].loc);
<a name="l00057"></a>00057     free(powfs[ipowfs].amp);
<a name="l00058"></a>00058     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0726938bc2f30c0d62117c0cb34d36d9">misreg</a>){
<a name="l00059"></a>00059     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ilocm=0; ilocm&lt;powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3f8067507fad08b3bcb049e7bbb6b65f">nlocm</a>; ilocm++){
<a name="l00060"></a>00060         locfree(powfs[ipowfs].locm[ilocm]);
<a name="l00061"></a>00061         free(powfs[ipowfs].ampm[ilocm]);
<a name="l00062"></a>00062         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>[ilocm]=NULL;
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064     free(powfs[ipowfs].locm);powfs[ipowfs].<a class="code" href="structPOWFS__T.html#0c80663120f8c0e599a063147043edda">locm</a>=NULL;
<a name="l00065"></a>00065     free(powfs[ipowfs].ampm);powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>=NULL;
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="77b6fd986d6105964adf2c844ee9df87"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_geom" ref="77b6fd986d6105964adf2c844ee9df87" args="(POWFS_T *powfs, const PARMS_T *parms, APER_T *aper, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_geom           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
setting up subaperture geometry. 
<p>
<ul>
<li>powfs-&gt;pts: the location of the lower left grid coordinate in this subaperture &gt;=saloc.</li></ul>
<p>
<ul>
<li>powfs-&gt;saloc: the lower left corner of the subaperture</li></ul>
<p>
<ul>
<li>powfs-&gt;loc: the x,y coordinates of all the points, ordered acoording to subaperture. </li></ul>
<div class="fragment"><pre class="fragment"><a name="l00081"></a>00081                                  {
<a name="l00082"></a>00082     <a class="code" href="maos_2setup__powfs_8c.html#f500bd9800a3b3f47a36b855a9f88ae9" title="Free the powfs geometric parameters.">free_powfs_geom</a>(powfs, parms, ipowfs);
<a name="l00083"></a>00083     <span class="keywordtype">double</span> r2max,offset,dxoffset;
<a name="l00084"></a>00084     <span class="keywordtype">int</span> count;
<a name="l00085"></a>00085  
<a name="l00086"></a>00086     <span class="comment">//order of the system. 60 for TMT</span>
<a name="l00087"></a>00087     <span class="keyword">const</span> <span class="keywordtype">int</span> order  = parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>;
<a name="l00088"></a>00088     <span class="comment">//Subaperture lateral length. 0.5 for TMT.</span>
<a name="l00089"></a>00089     <span class="keyword">const</span> <span class="keywordtype">double</span> dxsa = parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/(double)order;
<a name="l00090"></a>00090     <span class="comment">//The subaperture area that are considered as full.</span>
<a name="l00091"></a>00091     <span class="keywordtype">double</span> areafulli;
<a name="l00092"></a>00092     <span class="keywordflow">if</span>(order&gt;2){
<a name="l00093"></a>00093     areafulli=1.;
<a name="l00094"></a>00094     }<span class="keywordflow">else</span>{
<a name="l00095"></a>00095     areafulli=4./M_PI;
<a name="l00096"></a>00096     }
<a name="l00097"></a>00097     <span class="comment">//The threashold for normalized area (by areafulli) to keep subaperture.</span>
<a name="l00098"></a>00098     <span class="keyword">const</span> <span class="keywordtype">double</span> thresarea=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#97262ee0e2c8b1200594b70cd28b0325" title="subaperture area (normalized) threshold to drop subaperture.">saat</a>;
<a name="l00099"></a>00099     r2max = (order/2+1)*(order/2+1);
<a name="l00100"></a>00100     <span class="comment">//Offset of the coordinate of the center most subaperture from the center.</span>
<a name="l00101"></a>00101     <span class="keywordflow">if</span>(order &amp; 1){<span class="comment">//odd</span>
<a name="l00102"></a>00102     offset = -0.5;
<a name="l00103"></a>00103     }<span class="keywordflow">else</span>{
<a name="l00104"></a>00104     offset = 0.0;
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106     <span class="comment">//r2max: Maximum distance^2 from the center to keep a subaperture</span>
<a name="l00107"></a>00107     r2max -= 2.*(0.5+offset)*(0.5+offset);
<a name="l00108"></a>00108     <span class="comment">//the lower left *grid* coordinate of the subaperture</span>
<a name="l00109"></a>00109     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a> =calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structPTS__T.html" title="low left point of each subaperture.">PTS_T</a>));
<a name="l00110"></a>00110     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a> =malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*order*order);
<a name="l00111"></a>00111     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a> =malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*order*order);
<a name="l00112"></a>00112     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>  =malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*order*order);
<a name="l00113"></a>00113     <span class="comment">//The coordinate of the subaperture (lower left coordinate)</span>
<a name="l00114"></a>00114     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>=calloc(1,<span class="keyword">sizeof</span>(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>));
<a name="l00115"></a>00115     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a> =malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*order*order);
<a name="l00116"></a>00116     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a> =malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*order*order);
<a name="l00117"></a>00117     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>   =dxsa;
<a name="l00118"></a>00118     <span class="comment">/*Number of OPD pixels in 1 direction in each</span>
<a name="l00119"></a>00119 <span class="comment">      subaperture. Make it even to do fft.*/</span>
<a name="l00120"></a>00120     <span class="keywordtype">int</span> nx = 2*(int)round(0.5*dxsa/parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d4d9c6fffdd734c54ceb97cb450b772a" title="sampling of opd points in each subaperture.">dx</a>);
<a name="l00121"></a>00121     <span class="keyword">const</span> <span class="keywordtype">double</span> dx=dxsa/nx;<span class="comment">//adjust dx.</span>
<a name="l00122"></a>00122     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a> = dx;<span class="comment">//sampling</span>
<a name="l00123"></a>00123     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a> = nx;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d4d9c6fffdd734c54ceb97cb450b772a" title="sampling of opd points in each subaperture.">dx</a>-powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>)&gt;EPS)
<a name="l00126"></a>00126     warning(<span class="stringliteral">"powfs %d: Adjusting dx from %g to %g\n"</span>,
<a name="l00127"></a>00127         ipowfs,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d4d9c6fffdd734c54ceb97cb450b772a" title="sampling of opd points in each subaperture.">dx</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>);
<a name="l00128"></a>00128     <span class="keywordflow">if</span>(fabs(dxsa - nx * powfs[ipowfs].pts-&gt;dx)&gt;EPS)
<a name="l00129"></a>00129     warning(<span class="stringliteral">"nx=%d,dsa=%f,dx=%f for powfs %d not agree\n"</span>,
<a name="l00130"></a>00130         nx, dxsa, dx, ipowfs);
<a name="l00131"></a>00131     <span class="keywordtype">int</span> dxonedge=0;
<a name="l00132"></a>00132     <span class="keywordflow">if</span>(dxonedge){<span class="comment">//do we want to put a point on edge.</span>
<a name="l00133"></a>00133     dxoffset=0;
<a name="l00134"></a>00134     }<span class="keywordflow">else</span>{
<a name="l00135"></a>00135     dxoffset=dx/2;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137     
<a name="l00138"></a>00138     <span class="keyword">const</span> <span class="keywordtype">int</span> nxsa=nx*nx;<span class="comment">//Total Number of OPD points.</span>
<a name="l00139"></a>00139     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>=calloc(order*order*nxsa,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00140"></a>00140     count = 0;
<a name="l00141"></a>00141     <span class="comment">/*Collect all the subapertures that are within the allowed</span>
<a name="l00142"></a>00142 <span class="comment">      radius*/</span>
<a name="l00143"></a>00143     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=-order/2; j&lt;=(order-1)/2; j++){
<a name="l00144"></a>00144     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=-order/2; i&lt;=(order-1)/2; i++){
<a name="l00145"></a>00145         <span class="comment">/*subaperture center is at </span>
<a name="l00146"></a>00146 <span class="comment">          (i+1/2+offset, j+1/2+offset)*dxsa*/</span>
<a name="l00147"></a>00147         <span class="keywordflow">if</span>((i*i+j*j+(i+j)*(1+iceil(2.*offset)))
<a name="l00148"></a>00148            &lt;r2max){
<a name="l00149"></a>00149         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a>[count]=
<a name="l00150"></a>00150             ((double)i+offset)*dxsa+dxoffset;
<a name="l00151"></a>00151         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a>[count]=
<a name="l00152"></a>00152             ((double)j+offset)*dxsa+dxoffset;
<a name="l00153"></a>00153         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[count]=
<a name="l00154"></a>00154             ((double)i+offset)*dxsa;
<a name="l00155"></a>00155         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[count]=
<a name="l00156"></a>00156             ((double)j+offset)*dxsa;
<a name="l00157"></a>00157         count++;
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161     <span class="comment">/*Calculate the amplitude for each subaperture OPD point by</span>
<a name="l00162"></a>00162 <span class="comment">      ray tracing from the pupil amplitude map.*/</span>
<a name="l00163"></a>00163     <span class="keywordtype">double</span> *ampcircle=NULL;
<a name="l00164"></a>00164     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>=count;
<a name="l00165"></a>00165     <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>){
<a name="l00166"></a>00166     <a class="code" href="accphi_8c.html#3f1a50d6e3d25fd04d66224ee0065ff0" title="Propagate OPD defines on grid mapin to subapertures.">prop_grid_pts</a>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>, 
<a name="l00167"></a>00167               powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>, 1,0,0,1,0,0,0,1);
<a name="l00168"></a>00168     }<span class="keywordflow">else</span>{
<a name="l00169"></a>00169     <span class="comment">/*don't use aper-&gt;amp here because aper-&gt;amp is</span>
<a name="l00170"></a>00170 <span class="comment">      normalized to sum to 1. We want it to max to 1.*/</span>
<a name="l00171"></a>00171     ampcircle=calloc(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00172"></a>00172     <a class="code" href="loc_8c.html#f4c56dfe0e83ab030da1eaac733aae02" title="Create a gray pixel circular map in phi using coordinates defined in loc, center...">loccircle</a>(ampcircle,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,0,0,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>*0.5,1);
<a name="l00173"></a>00173     <a class="code" href="loc_8c.html#f4c56dfe0e83ab030da1eaac733aae02" title="Create a gray pixel circular map in phi using coordinates defined in loc, center...">loccircle</a>(ampcircle,aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,0,0,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#5f2d4b89322d5de7b49f7f274807ff93" title="Telescope inner blocking diameter.">din</a>*0.5,-1);
<a name="l00174"></a>00174     <a class="code" href="accphi_8c.html#ffbc809aa885e1096d019ef1c627b25e" title="Propagate OPD defines on coordinate locin to subapertures pts.">prop_nongrid_pts</a>(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,ampcircle,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>,
<a name="l00175"></a>00175              NULL,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>,1,0,0,1,0,0,1);
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178     count=0;
<a name="l00179"></a>00179     <span class="keywordtype">double</span> maxarea=0;
<a name="l00180"></a>00180     <span class="keywordtype">double</span> areanormfactor=1./(double)(nxsa);
<a name="l00181"></a>00181     <span class="comment">/*Go over all the subapertures, calculate the normalized</span>
<a name="l00182"></a>00182 <span class="comment">      subaperture illumination area and remove all that are below</span>
<a name="l00183"></a>00183 <span class="comment">      the are threshold*/</span>
<a name="l00184"></a>00184     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>; isa++){
<a name="l00185"></a>00185     <span class="keywordtype">double</span> area=0.;
<a name="l00186"></a>00186     <span class="keywordtype">double</span> *amp=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>+nxsa*isa;
<a name="l00187"></a>00187     <span class="keywordtype">double</span> *amp0=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>+nxsa*count;
<a name="l00188"></a>00188     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;nxsa; k++){
<a name="l00189"></a>00189         area+=amp[k]*amp[k];
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191     area*=areanormfactor;<span class="comment">//normalized the area.</span>
<a name="l00192"></a>00192     <span class="keywordflow">if</span>(area&gt;1+EPS){<span class="comment">//sanity check. impossible.</span>
<a name="l00193"></a>00193         error(<span class="stringliteral">"area %g is larger than full.\n"</span>, area);
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195     <span class="keywordflow">if</span>(area&gt;thresarea){<span class="comment">//Area is above threshold, keep.</span>
<a name="l00196"></a>00196         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>[count]=area;
<a name="l00197"></a>00197         <span class="keywordflow">if</span>(maxarea &lt; area) maxarea=area;
<a name="l00198"></a>00198         <span class="comment">//area is already normalized that maxes to 1.</span>
<a name="l00199"></a>00199         <span class="keywordflow">if</span>(count!=isa){
<a name="l00200"></a>00200         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a>[count]=
<a name="l00201"></a>00201             powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a>[isa];
<a name="l00202"></a>00202         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a>[count]=
<a name="l00203"></a>00203             powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a>[isa];
<a name="l00204"></a>00204         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[count]=
<a name="l00205"></a>00205             powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[isa];
<a name="l00206"></a>00206         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[count]=
<a name="l00207"></a>00207             powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[isa];
<a name="l00208"></a>00208         memcpy(amp0, amp, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*nxsa);
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210         count++;
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213     <span class="comment">/*area was already normalized against square subaperture.  to</span>
<a name="l00214"></a>00214 <span class="comment">      scale the physical optics i0. After FFT, the PSF sum to 1</span>
<a name="l00215"></a>00215 <span class="comment">      for square subapertures, but sum to PI/4 for circular TT or</span>
<a name="l00216"></a>00216 <span class="comment">      TTF subapertures. maxarea is 1 for square subapertures, and</span>
<a name="l00217"></a>00217 <span class="comment">      PI/4 for TT and TTF WFS due to cut off by pupil. for square</span>
<a name="l00218"></a>00218 <span class="comment">      subapertures, areascale=1, no effect. for TT or TTF WFS,</span>
<a name="l00219"></a>00219 <span class="comment">      areascale is 4/PI, which scales the PSF from sum to PI/4 to</span>
<a name="l00220"></a>00220 <span class="comment">      sum to 1 again. Used in wfsints*/</span>
<a name="l00221"></a>00221     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fa84bfe5be5b4a95270aeddf7ffe8d55">areascale</a>=1./maxarea;
<a name="l00222"></a>00222     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;count; isa++){
<a name="l00223"></a>00223     <span class="comment">/*noramlize area against 1 for square or PI/4 for arc</span>
<a name="l00224"></a>00224 <span class="comment">      subapertures. The area is not used in physical</span>
<a name="l00225"></a>00225 <span class="comment">      optics. It is used to scale geometric sanea.*/</span>
<a name="l00226"></a>00226     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>[isa]*=areafulli;
<a name="l00227"></a>00227     }
<a name="l00228"></a>00228     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#c45bc64d4ee12ed2fdfbbc8956dd699c">npts</a> = count*nxsa;
<a name="l00229"></a>00229     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>=count;
<a name="l00230"></a>00230     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a>=realloc(powfs[ipowfs].pts-&gt;origx,
<a name="l00231"></a>00231                      <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*count);
<a name="l00232"></a>00232     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a>=realloc(powfs[ipowfs].pts-&gt;origy,
<a name="l00233"></a>00233                      <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*count);
<a name="l00234"></a>00234     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>=realloc(powfs[ipowfs].pts-&gt;area,
<a name="l00235"></a>00235                     <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*count);
<a name="l00236"></a>00236     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>=realloc(powfs[ipowfs].saloc-&gt;locx,
<a name="l00237"></a>00237                      <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*count);
<a name="l00238"></a>00238     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>=realloc(powfs[ipowfs].saloc-&gt;locy,
<a name="l00239"></a>00239                      <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*count);
<a name="l00240"></a>00240     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>=count;
<a name="l00241"></a>00241     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ae9e38522a793c7d018028a38fc34ce0" title="Sampling.">dx</a>=dxsa;
<a name="l00242"></a>00242     
<a name="l00243"></a>00243     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>=realloc(powfs[ipowfs].amp, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*count*nxsa);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>=<a class="code" href="loc_8c.html#6049d3a303daf76b035f2e1c428f5baa" title="Convert PTS_T to LOC_T.">pts2loc</a>(powfs[ipowfs].pts);
<a name="l00246"></a>00246     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#2208400c2f1150a63417cd38f3e01f53" title="Plot various information in setup process.">setup</a>){
<a name="l00247"></a>00247     <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"amp"</span>, powfs[ipowfs].loc, powfs[ipowfs].amp,
<a name="l00248"></a>00248         <span class="stringliteral">"WFS Amplitude Map"</span>,<span class="stringliteral">"x (m)"</span>,<span class="stringliteral">"y (m)"</span>,<span class="stringliteral">"powfs %d"</span>, ipowfs);
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0726938bc2f30c0d62117c0cb34d36d9">misreg</a>){
<a name="l00251"></a>00251     <span class="comment">/*Create misregistered coordinate and amplitude map to do</span>
<a name="l00252"></a>00252 <span class="comment">      physical optics wavefront sensing. the un-misregistered</span>
<a name="l00253"></a>00253 <span class="comment">      coordinate and amplitude map is still used to do the</span>
<a name="l00254"></a>00254 <span class="comment">      reconstructor because the RTC is not aware of the</span>
<a name="l00255"></a>00255 <span class="comment">      misregistration.</span>
<a name="l00256"></a>00256 <span class="comment">     */</span>
<a name="l00257"></a>00257     warning(<span class="stringliteral">"Creating misregistration between DM and WFS.\n"</span>);
<a name="l00258"></a>00258     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *misreg=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0726938bc2f30c0d62117c0cb34d36d9">misreg</a>); 
<a name="l00259"></a>00259     <span class="keywordflow">if</span>(misreg-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>!=2)
<a name="l00260"></a>00260         error(<span class="stringliteral">"%s is in wrong format\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0726938bc2f30c0d62117c0cb34d36d9">misreg</a>);
<a name="l00261"></a>00261     <span class="keywordflow">if</span>(misreg-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>==1){
<a name="l00262"></a>00262         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3f8067507fad08b3bcb049e7bbb6b65f">nlocm</a>=1;
<a name="l00263"></a>00263     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(misreg-&gt;<a class="code" href="structdcell.html#cd7579d2c13ae676bbfba099ae78b35c" title="number of columns">ny</a>==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>){
<a name="l00264"></a>00264         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3f8067507fad08b3bcb049e7bbb6b65f">nlocm</a>=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>;
<a name="l00265"></a>00265     }<span class="keywordflow">else</span>{
<a name="l00266"></a>00266         error(<span class="stringliteral">"%s is in wrong format\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0726938bc2f30c0d62117c0cb34d36d9">misreg</a>);
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#0c80663120f8c0e599a063147043edda">locm</a>=calloc(powfs[ipowfs].nlocm, <span class="keyword">sizeof</span>(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*));
<a name="l00269"></a>00269     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>=calloc(powfs[ipowfs].nlocm, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>*));
<a name="l00270"></a>00270     PDCELL(misreg,pmisreg);
<a name="l00271"></a>00271     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ilocm=0; ilocm&lt;powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3f8067507fad08b3bcb049e7bbb6b65f">nlocm</a>; ilocm++){
<a name="l00272"></a>00272         <span class="comment">/*Transforms loc using misregistration</span>
<a name="l00273"></a>00273 <span class="comment">          information. The do ray tracing to determine the</span>
<a name="l00274"></a>00274 <span class="comment">          misregistered ampltidue map*/</span>
<a name="l00275"></a>00275         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#0c80663120f8c0e599a063147043edda">locm</a>[ilocm]=<a class="code" href="loc_8c.html#5ecb83987d7b0afcd6cedba9c74febc7" title="Transform coordinate.">loctransform</a>(powfs[ipowfs].loc, 
<a name="l00276"></a>00276                            pmisreg[ilocm]);
<a name="l00277"></a>00277         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>[ilocm]=calloc(powfs[ipowfs].loc-&gt;nloc, 
<a name="l00278"></a>00278                          <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00279"></a>00279         <span class="keywordflow">if</span>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>){
<a name="l00280"></a>00280         <a class="code" href="accphi_8c.html#5ba7f2c5f6336b56caa056adcee4f11c" title="Propagate OPD defines on grid mapin to coordinate locout.">prop_grid</a>(aper-&gt;<a class="code" href="structAPER__T.html#5718bd50cf398a113f1e5adb151da2ca" title="The input amplitude map on ground level read from file.">ampground</a>, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#0c80663120f8c0e599a063147043edda">locm</a>[ilocm], 
<a name="l00281"></a>00281               powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>[ilocm], 1,0,0,1,0,0,0);
<a name="l00282"></a>00282         }<span class="keywordflow">else</span>{
<a name="l00283"></a>00283         <a class="code" href="accphi_8c.html#33015a685252b9238783b98a8ec5b159" title="Propagate OPD defines on coordinate locin to coordinate locout.">prop_nongrid</a>(aper-&gt;<a class="code" href="structAPER__T.html#d5b31b5785d613903670f270a00c3e3e" title="PLOCS in laos.">locs</a>,ampcircle,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#0c80663120f8c0e599a063147043edda">locm</a>[ilocm],
<a name="l00284"></a>00284                  NULL,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>[ilocm],1,0,0,1,0,0);
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00287"></a>00287         locwrite(powfs[ipowfs].locm[ilocm],<span class="stringliteral">"%s/powfs%d_locm%d.bin.gz"</span>,
<a name="l00288"></a>00288              dirsetup,ipowfs,ilocm);
<a name="l00289"></a>00289         <a class="code" href="bin_8c.html#07e8fcd0256fd8377d0bb0d86bfd3c53" title="Write a double array of size nx*ny to file.">writedbl</a>(powfs[ipowfs].ampm[ilocm],powfs[ipowfs].loc-&gt;nloc,1,
<a name="l00290"></a>00290              <span class="stringliteral">"%s/powfs%d_ampm%d.bin.gz"</span>, dirsetup,ipowfs,ilocm);
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00295"></a>00295     locwrite((<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*)powfs[ipowfs].pts,
<a name="l00296"></a>00296          <span class="stringliteral">"%s/powfs%d_pts.bin.gz"</span>,dirsetup,ipowfs);
<a name="l00297"></a>00297     locwrite(powfs[ipowfs].saloc,
<a name="l00298"></a>00298          <span class="stringliteral">"%s/powfs%d_saloc.bin.gz"</span>,dirsetup,ipowfs); 
<a name="l00299"></a>00299     <a class="code" href="bin_8c.html#07e8fcd0256fd8377d0bb0d86bfd3c53" title="Write a double array of size nx*ny to file.">writedbl</a>((<span class="keywordtype">double</span>*)powfs[ipowfs].pts-&gt;area,
<a name="l00300"></a>00300          powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>,1,<span class="stringliteral">"%s/powfs%d_area.bin.gz"</span>,
<a name="l00301"></a>00301          dirsetup,ipowfs);
<a name="l00302"></a>00302     locwrite(powfs[ipowfs].loc,<span class="stringliteral">"%s/powfs%d_loc.bin.gz"</span>,dirsetup,ipowfs);
<a name="l00303"></a>00303     <a class="code" href="bin_8c.html#07e8fcd0256fd8377d0bb0d86bfd3c53" title="Write a double array of size nx*ny to file.">writedbl</a>((<span class="keywordtype">double</span>*)powfs[ipowfs].amp,
<a name="l00304"></a>00304          powfs[ipowfs].loc-&gt;nloc,1, <span class="stringliteral">"%s/powfs%d_amp.bin.gz"</span>,
<a name="l00305"></a>00305          dirsetup,ipowfs);
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     <span class="keywordflow">if</span>(ampcircle){
<a name="l00308"></a>00308     free(ampcircle);
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="e92ae33f8f650cb9c7975044bd82432f"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_grad" ref="e92ae33f8f650cb9c7975044bd82432f" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_grad           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Creating geometric wavefront gradient operator GS0 and ZA0 from WFS OPD to subaperture grads. 
<p>
Use loc, not locm. locm is only used to do ray tracing. <div class="fragment"><pre class="fragment"><a name="l00317"></a>00317                     {
<a name="l00318"></a>00318     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#7d2eaa30681d91e3267fe953462270c4" title="wfs type if not using physical optics in simulation.">gtype_recon</a>==0
<a name="l00319"></a>00319        ||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#129c1dda529b641aac48415a110235b7" title="wfs type if not using physical optics in reconstruction.">gtype_sim</a>==0){
<a name="l00320"></a>00320     spfree(powfs[ipowfs].GS0);
<a name="l00321"></a>00321     <span class="comment">//Setting up every gradient tilt (g-ztilt)</span>
<a name="l00322"></a>00322     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#f0058a2e1d8cf4726c1c80eb21e35491" title="if 1, load GS0 from powfsd_GS0.bin.gz">GS0</a>){
<a name="l00323"></a>00323         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#61ba7e824f0228b45378bbb92efaebe3">GS0</a>=<a class="code" href="dmat_8h.html#06bbd169953a4a808c647bd0a9e6f0d3" title="User callable function to read sparse metrix from file.">spread</a>(<span class="stringliteral">"powfs%d_GS0.bin.gz"</span>,ipowfs);
<a name="l00324"></a>00324     }<span class="keywordflow">else</span>{
<a name="l00325"></a>00325         <span class="keywordtype">double</span> displace[2]={0,0};
<a name="l00326"></a>00326         <span class="comment">//This mkg takes about 5 seconds.</span>
<a name="l00327"></a>00327         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#61ba7e824f0228b45378bbb92efaebe3">GS0</a>=<a class="code" href="mkg_8c.html#7a94831f1db656a61e22c6f1c5a85ebb" title="Returns the transpose of mkgt().">mkg</a>(powfs[ipowfs].loc, 
<a name="l00328"></a>00328                   powfs[ipowfs].loc,
<a name="l00329"></a>00329                   powfs[ipowfs].amp,
<a name="l00330"></a>00330                   powfs[ipowfs].saloc,
<a name="l00331"></a>00331                   1, 1, displace, 1);
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333     }
<a name="l00334"></a>00334     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#7d2eaa30681d91e3267fe953462270c4" title="wfs type if not using physical optics in simulation.">gtype_recon</a>==1
<a name="l00335"></a>00335        ||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#129c1dda529b641aac48415a110235b7" title="wfs type if not using physical optics in reconstruction.">gtype_sim</a>==1){
<a name="l00336"></a>00336     <span class="comment">//setting up zernike best fit (ztilt) inv(M'*W*M). good for NGS.</span>
<a name="l00337"></a>00337     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>&gt;4) 
<a name="l00338"></a>00338         warning(<span class="stringliteral">"Ztilt for high order wfs is not good"</span>);
<a name="l00339"></a>00339     spfree(powfs[ipowfs].ZS0);
<a name="l00340"></a>00340     dcellfree(powfs[ipowfs].mcc);
<a name="l00341"></a>00341     dcellfree(powfs[ipowfs].imcc);
<a name="l00342"></a>00342     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#706fa25774d7c7dbfc0ab1c3925196b8">mcc</a>=<a class="code" href="loc_8c.html#02791a06a46428dcc5797051dbb8cf88" title="same as loc_mcc_ptt, except using pts instead of loc.">pts_mcc_ptt</a>(powfs[ipowfs].pts, powfs[ipowfs].amp);
<a name="l00343"></a>00343     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c1a97256a90efbb53166fc1ab5c16a9">imcc</a>=dcellinvspd_each(powfs[ipowfs].mcc);
<a name="l00344"></a>00344     <span class="keywordtype">double</span> displace[2]={0,0};
<a name="l00345"></a>00345     <span class="comment">//ZS0 is a large matrix. </span>
<a name="l00346"></a>00346     <span class="comment">//only use for generating GA, G0 and testing</span>
<a name="l00347"></a>00347     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6af618140755d7b9cfbcebac9ab58453">ZS0</a>=mkz(powfs[ipowfs].loc,powfs[ipowfs].amp,
<a name="l00348"></a>00348                   (<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*)powfs[ipowfs].pts, 1,1,displace);
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00351"></a>00351     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].imcc,<span class="stringliteral">"%s/powfs%d_imcc.bin.gz"</span>, dirsetup,ipowfs);
<a name="l00352"></a>00352     <span class="keywordflow">if</span>(powfs[ipowfs].GS0)
<a name="l00353"></a>00353         <a class="code" href="dmat_8h.html#779cefb17e24b648212cc59f9324f5ae" title="User callable function to write sparse matrix into file.">spwrite</a>(powfs[ipowfs].GS0,<span class="stringliteral">"%s/powfs%d_GS0.bin.gz"</span>,dirsetup,ipowfs);
<a name="l00354"></a>00354     <span class="keywordflow">if</span>(powfs[ipowfs].ZS0)
<a name="l00355"></a>00355         <a class="code" href="dmat_8h.html#779cefb17e24b648212cc59f9324f5ae" title="User callable function to write sparse matrix into file.">spwrite</a>(powfs[ipowfs].ZS0,<span class="stringliteral">"%s/powfs%d_ZS0.bin.gz"</span>,dirsetup,ipowfs);
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b1409e69dddf8131559ea35731109bda"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_prep_phy" ref="b1409e69dddf8131559ea35731109bda" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_prep_phy           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Prepare the parameters for physical optics setup. 
<p>
<dl compact><dt><b><a class="el" href="todo.html#_todo000010">Todo:</a></b></dt><dd>Make LGS number of pixels depend on subapertue elongation in radial coordinate CCD mode. Make ncompx, ncompy dependent on number of pixels for radial ccd.</dd></dl>
<div class="fragment"><pre class="fragment"><a name="l00367"></a>00367                                                                     {
<a name="l00368"></a>00368     <span class="keyword">const</span> <span class="keywordtype">double</span> pixtheta=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#adf117b796aef86ac0b1759f81ad59fd" title="size of pixel pitch along x or y in radian">pixtheta</a>;
<a name="l00369"></a>00369     <span class="keyword">const</span> <span class="keywordtype">int</span> nwvl=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;
<a name="l00370"></a>00370     <span class="keyword">const</span> <span class="keywordtype">int</span> pixpsay=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#38299ac6010a75cf1c8132217746890e" title="number of detector pixels along x/y or azimuthal if radial CCD.">pixpsa</a>;
<a name="l00371"></a>00371     <span class="keyword">const</span> <span class="keywordtype">int</span> radpix=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beacabf44ba95b84fa2ec6b4460f5364" title="number of detector pixels along radial direction if radial CCD">radpix</a>;
<a name="l00372"></a>00372     <span class="keyword">const</span> <span class="keywordtype">double</span> dxsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>;
<a name="l00373"></a>00373     <span class="keyword">const</span> <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00374"></a>00374     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>){
<a name="l00375"></a>00375     <span class="keyword">const</span> <span class="keywordtype">int</span> nllt=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#4b3cd998f117485fdcb8de6805fef38b" title="number of launch telescopes in this powfs">n</a>;
<a name="l00376"></a>00376     <span class="keywordtype">double</span> rsa2, rsa2max=0;
<a name="l00377"></a>00377     dcellfree(powfs[ipowfs].srot);
<a name="l00378"></a>00378     dcellfree(powfs[ipowfs].srsa);
<a name="l00379"></a>00379     dcellfree(powfs[ipowfs].sprint);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fd0302013032e547054f9431d7aee502">srot</a>=dcellnew(nllt,1);
<a name="l00382"></a>00382     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#1aeacf2ddfafb73167818e8a23dcdf59">srsa</a>=dcellnew(nllt,1);
<a name="l00383"></a>00383     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a47d02cbb65e3d42a7d2d0ef062b17a">srsamax</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nllt,1);
<a name="l00384"></a>00384     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6c60f2cb244e43a6dd87887c98a37c20">sprint</a>=dcellnew(nllt,1);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> illt=0;illt&lt;nllt;illt++){
<a name="l00387"></a>00387         <span class="comment">//adjusted llt center because pts-&gt;orig is corner</span>
<a name="l00388"></a>00388         <span class="keywordtype">double</span> ox2=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#ef2483dcc582462f3eb512d8afacbb0a" title="location x of LLT center wrt telescope aperture center">ox</a>[illt]-dxsa*0.5;
<a name="l00389"></a>00389         <span class="keywordtype">double</span> oy2=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#14e57fee894c978e597da00a6c0c092c" title="see ox.">oy</a>[illt]-dxsa*0.5;
<a name="l00390"></a>00390         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fd0302013032e547054f9431d7aee502">srot</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa,1);
<a name="l00391"></a>00391         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#1aeacf2ddfafb73167818e8a23dcdf59">srsa</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa,1);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00394"></a>00394         <span class="keywordtype">double</span> ddx=(powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[isa]-ox2);
<a name="l00395"></a>00395         <span class="keywordtype">double</span> ddy=(powfs[ipowfs].<a class="code" href="structPOWFS__T.html#12924bc2d4136e38b777d78e4c618f9e">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[isa]-oy2);
<a name="l00396"></a>00396         rsa2=pow(ddx,2)+pow(ddy,2);
<a name="l00397"></a>00397         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fd0302013032e547054f9431d7aee502">srot</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa]=atan2(ddy,ddx);
<a name="l00398"></a>00398         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#1aeacf2ddfafb73167818e8a23dcdf59">srsa</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa]=sqrt(rsa2);
<a name="l00399"></a>00399         <span class="keywordflow">if</span>(rsa2&gt;rsa2max) rsa2max=rsa2;
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a47d02cbb65e3d42a7d2d0ef062b17a">srsamax</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[illt]=sqrt(rsa2max);
<a name="l00402"></a>00402         <span class="keywordtype">int</span> pnsa=(int)ceil(sqrt(rsa2max)/dxsa)+1;
<a name="l00403"></a>00403         
<a name="l00404"></a>00404         <span class="keywordtype">double</span> prot[pnsa];
<a name="l00405"></a>00405         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6c60f2cb244e43a6dd87887c98a37c20">sprint</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(pnsa,1);
<a name="l00406"></a>00406         <span class="keywordtype">double</span> *pp=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6c60f2cb244e43a6dd87887c98a37c20">sprint</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00407"></a>00407         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ind=0; ind&lt;pnsa; ind++){
<a name="l00408"></a>00408         prot[ind]=INFINITY;
<a name="l00409"></a>00409         pp[ind]=-1;
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411         <span class="keywordtype">double</span> desrot=0;
<a name="l00412"></a>00412         <span class="keywordflow">if</span>(fabs(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#ef2483dcc582462f3eb512d8afacbb0a" title="location x of LLT center wrt telescope aperture center">ox</a>[illt])&lt;dxsa 
<a name="l00413"></a>00413            &amp;&amp; fabs(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#14e57fee894c978e597da00a6c0c092c" title="see ox.">oy</a>[illt])&lt;dxsa){
<a name="l00414"></a>00414         desrot=0;
<a name="l00415"></a>00415         }<span class="keywordflow">else</span>{
<a name="l00416"></a>00416         <span class="keywordtype">double</span> ddx=(0-parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#ef2483dcc582462f3eb512d8afacbb0a" title="location x of LLT center wrt telescope aperture center">ox</a>[illt]);
<a name="l00417"></a>00417         <span class="keywordtype">double</span> ddy=(0-parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#14e57fee894c978e597da00a6c0c092c" title="see ox.">oy</a>[illt]);
<a name="l00418"></a>00418         desrot=atan2(ddy,ddx);
<a name="l00419"></a>00419         }
<a name="l00420"></a>00420         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l00421"></a>00421         <span class="keywordtype">int</span> ind=(int)round(powfs[ipowfs].srsa-&gt;p[illt]-&gt;p[isa]/dxsa);
<a name="l00422"></a>00422         <span class="keywordtype">double</span> irot=fabs(powfs[ipowfs].srot-&gt;p[illt]-&gt;p[isa]-desrot);
<a name="l00423"></a>00423         <span class="keywordflow">if</span>(irot&lt;prot[ind]){
<a name="l00424"></a>00424             prot[ind]=irot;
<a name="l00425"></a>00425             pp[ind]=(double)isa;
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00430"></a>00430         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].sprint,<span class="stringliteral">"%s/powfs%d_sprint"</span>,
<a name="l00431"></a>00431                dirsetup,ipowfs);
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     <span class="keywordtype">int</span> pixpsax=pixpsay;
<a name="l00435"></a>00435     <span class="keywordflow">if</span>(radpix&lt;0){<span class="comment">//determine radpix adaptively</span>
<a name="l00436"></a>00436     <span class="comment">//use rsa2max to determine radpix</span>
<a name="l00437"></a>00437     error(<span class="stringliteral">"Not emplemented yet\n"</span>);
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439     pixpsax=(radpix)?radpix:pixpsay;
<a name="l00440"></a>00440     
<a name="l00441"></a>00441     <span class="comment">//record # of detector pixels.</span>
<a name="l00442"></a>00442     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#9ec5687c5268785533c22d746016e663">pixpsax</a>=pixpsax;
<a name="l00443"></a>00443     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#091e911bea2900efcc9b160126ebf4ca">pixpsay</a>=pixpsay;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="comment">//to avoid aliasing, fft warping. usually 2.</span>
<a name="l00446"></a>00446     <span class="keyword">const</span> <span class="keywordtype">double</span> embfac=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>;
<a name="l00447"></a>00447  
<a name="l00448"></a>00448     <span class="comment">//size required to form detector image.</span>
<a name="l00449"></a>00449     <span class="keywordtype">int</span> ncompx, ncompy;
<a name="l00450"></a>00450     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#296970cf1e80a4ea22532f6ea2c6d113" title="number of PSF points before forming detector image.">ncomp</a>){
<a name="l00451"></a>00451     ncompx=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#296970cf1e80a4ea22532f6ea2c6d113" title="number of PSF points before forming detector image.">ncomp</a>;
<a name="l00452"></a>00452     ncompy=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#296970cf1e80a4ea22532f6ea2c6d113" title="number of PSF points before forming detector image.">ncomp</a>;
<a name="l00453"></a>00453     warning(<span class="stringliteral">"powfs %d: ncomp is specified "</span>
<a name="l00454"></a>00454         <span class="stringliteral">"in input file to %dx%d\n"</span>,
<a name="l00455"></a>00455         ipowfs,ncompx,ncompy);
<a name="l00456"></a>00456     }<span class="keywordflow">else</span>{
<a name="l00457"></a>00457     <span class="comment">/*</span>
<a name="l00458"></a>00458 <span class="comment">      compute required otf size to cover the detector FoV</span>
<a name="l00459"></a>00459 <span class="comment">      Need to revise this part: when ncomp is less than the</span>
<a name="l00460"></a>00460 <span class="comment">      size of the full psf, may need padding.  study aliasing</span>
<a name="l00461"></a>00461 <span class="comment">      extensively with full, cropped psf and detector</span>
<a name="l00462"></a>00462 <span class="comment">      transfer function.</span>
<a name="l00463"></a>00463 <span class="comment">     */</span>
<a name="l00464"></a>00464     <span class="keywordtype">double</span> wvlmin=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[0];
<a name="l00465"></a>00465     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00466"></a>00466         <span class="keywordflow">if</span>(wvlmin&gt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[iwvl])
<a name="l00467"></a>00467         wvlmin=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[iwvl];
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469     <span class="keywordtype">double</span> dtheta=wvlmin/(dxsa*embfac);<span class="comment">//Min PSF sampling.</span>
<a name="l00470"></a>00470     ncompx=4*(int)round(0.25*pixpsax*pixtheta/dtheta);
<a name="l00471"></a>00471     ncompy=4*(int)round(0.25*pixpsay*pixtheta/dtheta);
<a name="l00472"></a>00472     
<a name="l00473"></a>00473     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#421d5f37ceb33e1a40262faf7ec4ef1d" title="For radial format CCD, rotate OTF into coordinate plane.">radrot</a>){
<a name="l00474"></a>00474         <span class="comment">//Follow laos method, need square </span>
<a name="l00475"></a>00475         ncompx=ncompx&gt;ncompy?ncompx:ncompy;
<a name="l00476"></a>00476         ncompy=ncompx;
<a name="l00477"></a>00477     }<span class="keywordflow">else</span>{
<a name="l00478"></a>00478         <span class="comment">/*Found that: Must set ncompx==ncompy for</span>
<a name="l00479"></a>00479 <span class="comment">          rotationg either psf or otf. reduce aliasing</span>
<a name="l00480"></a>00480 <span class="comment">          and scattering of image intensities.</span>
<a name="l00481"></a>00481 <span class="comment">         */</span>
<a name="l00482"></a>00482         ncompx=ncompx&gt;ncompy?ncompx:ncompy;
<a name="l00483"></a>00483         ncompy=ncompx;
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485     <span class="comment">//A few manual optimizations.</span>
<a name="l00486"></a>00486     <span class="keywordflow">if</span>(ncompx==ncompy){
<a name="l00487"></a>00487         <span class="keywordflow">if</span>(ncompx&gt;8 &amp;&amp; ncompx&lt;16){
<a name="l00488"></a>00488         ncompx=ncompy=16;
<a name="l00489"></a>00489         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(ncompx&gt;16 &amp;&amp; ncompx&lt;32){
<a name="l00490"></a>00490         ncompx=ncompy=32;
<a name="l00491"></a>00491         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(ncompx&gt;64 &amp;&amp; ncompx&lt;67){
<a name="l00492"></a>00492         ncompx=ncompy=64;
<a name="l00493"></a>00493         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(ncompx&lt;128 &amp;&amp; ncompx&gt;120){
<a name="l00494"></a>00494         ncompx=ncompy=128;
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497     info2(<span class="stringliteral">"ipowfs %d: ncompx=%d, ncompy=%d\n"</span>, ipowfs,ncompx,ncompy);
<a name="l00498"></a>00498     }<span class="comment">//ncomp</span>
<a name="l00499"></a>00499     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#67bf34f36dd078a571e7a14cdf0755de">ncompx</a>=ncompx;
<a name="l00500"></a>00500     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#21071d969e8a6f006203a6c004339e0f">ncompy</a>=ncompy;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#515dc9bdd5e364e97d32a0c58c30531d" title="file contains sky background/rayleigh scatter input for each subaperture in each...">bkgrndfn</a>){
<a name="l00503"></a>00503     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#8525cf543d090902082c59c2c4ce1567" title="How much of the background in bkgrndfn can be calibrated out.">bkgrndrm</a>&gt;2 || parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#8525cf543d090902082c59c2c4ce1567" title="How much of the background in bkgrndfn can be calibrated out.">bkgrndrm</a>&lt;0){
<a name="l00504"></a>00504         error(<span class="stringliteral">"parms-&gt;powfs[%d].bkgrndrm has illegal value of %g. "</span>
<a name="l00505"></a>00505           <span class="stringliteral">"should be between [0,2]"</span>,
<a name="l00506"></a>00506           ipowfs, parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#8525cf543d090902082c59c2c4ce1567" title="How much of the background in bkgrndfn can be calibrated out.">bkgrndrm</a>);
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     <span class="keywordtype">char</span> *fn=<a class="code" href="path_8c.html#25730e4c54130615ab7657ac89c39150" title="Locate a file in path and return its absolute filename.">find_file</a>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#515dc9bdd5e364e97d32a0c58c30531d" title="file contains sky background/rayleigh scatter input for each subaperture in each...">bkgrndfn</a>);
<a name="l00509"></a>00509     info(<span class="stringliteral">"Loading sky background/rayleigh backscatter from %s\n"</span>,fn);
<a name="l00510"></a>00510     dcellfree(powfs[ipowfs].bkgrnd);
<a name="l00511"></a>00511     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#ce22bc0f58b30c9ef182186ef59d18e1">bkgrnd</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"%s"</span>,fn);
<a name="l00512"></a>00512     free(fn);
<a name="l00513"></a>00513     <span class="keywordtype">double</span> bkscale = parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#345f9deab3e2b21f28284e29732af51e" title="sampling period.">dt</a>*800*parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#998a10ce3a6ac1154b764e31bc2e9470" title="ratio of sample period over fast loop (LGS)">dtrat</a>;
<a name="l00514"></a>00514     <span class="keywordflow">if</span>(fabs(bkscale-1)&gt;1.e-20){
<a name="l00515"></a>00515         dcellscale(powfs[ipowfs].bkgrnd, bkscale);
<a name="l00516"></a>00516         warning(<span class="stringliteral">"powfs %d: Scaling bkgrndfn by %g"</span>, ipowfs, bkscale);
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     <span class="keywordflow">if</span>(powfs[ipowfs].bkgrnd-&gt;nx!=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>){
<a name="l00519"></a>00519         error(<span class="stringliteral">"powfs %d: number of rows in bkgrndfn must be %ld, but is %ld\n"</span>,
<a name="l00520"></a>00520           ipowfs, powfs[ipowfs].pts-&gt;nsa, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#ce22bc0f58b30c9ef182186ef59d18e1">bkgrnd</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>);
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="2589e29c8b5c4bd05b33da3638e8ae53"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_ncpa" ref="2589e29c8b5c4bd05b33da3638e8ae53" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_ncpa           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Set up NCPA maps for each WFS. 
<p>
Load NCPA maps and ray trace to grid of loc <div class="fragment"><pre class="fragment"><a name="l00527"></a>00527                                                                   {
<a name="l00528"></a>00528     <span class="keyword">const</span> <span class="keywordtype">double</span> rot=-parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#bf64dffc1048f103b91ee16d94eee779" title="pupil rotation in degree">rotdeg</a>/180.*M_PI;
<a name="l00529"></a>00529     <span class="keywordtype">int</span> do_rot=(fabs(rot)&gt;1.e-10);
<a name="l00530"></a>00530     <span class="keyword">const</span> <span class="keywordtype">char</span> *fn_ncpa = parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#fcc8c1a482355c14b07ecf887212afc5" title="misregistration from DM to WFS, described by file containing a cell array A of 2xp...">ncpa</a>;
<a name="l00531"></a>00531     <span class="keywordflow">if</span>(fn_ncpa){<span class="comment">//Always make nwfs NCPA's</span>
<a name="l00532"></a>00532     <span class="keywordtype">char</span> *fn=<a class="code" href="path_8c.html#25730e4c54130615ab7657ac89c39150" title="Locate a file in path and return its absolute filename.">find_file</a>(fn_ncpa);
<a name="l00533"></a>00533     <span class="keywordtype">int</span> nncpa_in;
<a name="l00534"></a>00534     <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> **ncpa=sqmaparrread(&amp;nncpa_in, <span class="stringliteral">"%s"</span>,fn);
<a name="l00535"></a>00535     free(fn);
<a name="l00536"></a>00536     <span class="keyword">const</span> <span class="keywordtype">int</span> nwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>;
<a name="l00537"></a>00537     <span class="keywordflow">if</span>(nncpa_in != 1 &amp;&amp; nncpa_in != nwfs){
<a name="l00538"></a>00538         error(<span class="stringliteral">"powfs[%d].ncpa is in wrong format. nncpa_in=%d, nwfs=%d\n"</span>,
<a name="l00539"></a>00539           ipowfs,nncpa_in, nwfs);
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordtype">int</span> incpa_mul=0;
<a name="l00543"></a>00543     <span class="keywordflow">if</span>(nncpa_in==nwfs){
<a name="l00544"></a>00544         incpa_mul=1;
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546     info(<span class="stringliteral">"Creating NCPA\n"</span>);
<a name="l00547"></a>00547     dcellfree(powfs[ipowfs].ncpa);
<a name="l00548"></a>00548     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2990d6343a6195f3d0be9b133069a114">ncpa</a>=dcellnew(nwfs,1);
<a name="l00549"></a>00549     
<a name="l00550"></a>00550     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00551"></a>00551         <span class="keywordtype">int</span> ilocm=0;
<a name="l00552"></a>00552         <span class="keywordflow">if</span>(powfs[ipowfs].locm &amp;&amp; powfs[ipowfs].nlocm&gt;1){<span class="comment">//misregistration.</span>
<a name="l00553"></a>00553         ilocm=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#ac1b34e2f1f4455c53212bc350f5064b" title="indwfs[iwfs] gives the index of the wfs in this powfs group">indwfs</a>[iwfs];
<a name="l00554"></a>00554         }
<a name="l00555"></a>00555         <span class="keywordtype">int</span> incpa_in=incpa_mul*iwfs;
<a name="l00556"></a>00556         info(<span class="stringliteral">"iwfs=%d, incpa_in=%d\n"</span>, iwfs, incpa_in);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         <span class="keywordflow">if</span>(!powfs[ipowfs].ncpa-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>[iwfs]){
<a name="l00559"></a>00559         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2990d6343a6195f3d0be9b133069a114">ncpa</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(powfs[ipowfs].npts,1);
<a name="l00560"></a>00560         }
<a name="l00561"></a>00561         <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *locwfsin, *locwfs;
<a name="l00562"></a>00562         <span class="keywordflow">if</span>(powfs[ipowfs].locm){
<a name="l00563"></a>00563         locwfsin=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#0c80663120f8c0e599a063147043edda">locm</a>[ilocm];
<a name="l00564"></a>00564         }<span class="keywordflow">else</span>{
<a name="l00565"></a>00565         locwfsin=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>;
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567         <span class="keywordflow">if</span>(do_rot){
<a name="l00568"></a>00568         info(<span class="stringliteral">"Rotating telescope pupil\n"</span>);
<a name="l00569"></a>00569         locwfs=<a class="code" href="loc_8c.html#b579e505c2c50d59e69519da150c8f7b" title="duplicate a LOC_T object;">locdup</a>(locwfsin);
<a name="l00570"></a>00570         <a class="code" href="loc_8c.html#181d4d51ddcecd01146183b5c26ca886" title="Rotate the coordinates by theta CCW.">locrot</a>(locwfs,rot);
<a name="l00571"></a>00571         }<span class="keywordflow">else</span>{
<a name="l00572"></a>00572         locwfs=locwfsin;
<a name="l00573"></a>00573         }
<a name="l00574"></a>00574         <span class="keywordtype">double</span> hl=ncpa[incpa_in]-&gt;<a class="code" href="structMAP__T.html#7cad352b82624ab945b7808ea931f282" title="Heigh conjugation of this surface.">h</a>;
<a name="l00575"></a>00575         <span class="keywordtype">double</span> hs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>;
<a name="l00576"></a>00576         <span class="keyword">const</span> <span class="keywordtype">double</span> scale=1.-hl/hs;
<a name="l00577"></a>00577         <span class="keyword">const</span> <span class="keywordtype">double</span> displacex=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*hl;
<a name="l00578"></a>00578         <span class="keyword">const</span> <span class="keywordtype">double</span> displacey=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*hl;
<a name="l00579"></a>00579         <span class="keywordflow">if</span>(ncpa[incpa_in]-&gt;nx==1 || ncpa[incpa_in]-&gt;ny==1){
<a name="l00580"></a>00580         error(<span class="stringliteral">"ncpa is a vector: Invalid format\n"</span>);
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582         <a class="code" href="accphi_8c.html#5ba7f2c5f6336b56caa056adcee4f11c" title="Propagate OPD defines on grid mapin to coordinate locout.">prop_grid</a>(ncpa[incpa_in], locwfs, powfs[ipowfs].ncpa-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>[iwfs]-&gt;p,
<a name="l00583"></a>00583               1, displacex, displacey, scale, 1, 0, 0);
<a name="l00584"></a>00584         <span class="keywordflow">if</span>(do_rot){
<a name="l00585"></a>00585         locfree(locwfs);
<a name="l00586"></a>00586         }
<a name="l00587"></a>00587     }<span class="comment">//iwfs;</span>
<a name="l00588"></a>00588     sqmaparrfree(ncpa,nncpa_in);
<a name="l00589"></a>00589     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beee70263e01f8571a2c5884760e6051" title="Method to correct ncpa.">ncpa_method</a>&lt;0 || parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beee70263e01f8571a2c5884760e6051" title="Method to correct ncpa.">ncpa_method</a>&gt;2){
<a name="l00590"></a>00590         error(<span class="stringliteral">"Invalid ncpa_method=%d\n"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beee70263e01f8571a2c5884760e6051" title="Method to correct ncpa.">ncpa_method</a>);
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592     
<a name="l00593"></a>00593     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beee70263e01f8571a2c5884760e6051" title="Method to correct ncpa.">ncpa_method</a>==1){
<a name="l00594"></a>00594         info2(<span class="stringliteral">"Calculating gradient offset due to NCPA\n"</span>);
<a name="l00595"></a>00595         dcellfree(powfs[ipowfs].ncpa_grad);
<a name="l00596"></a>00596         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#18e39eb0dc4dee989858507587ea37fa">ncpa_grad</a>=dcellnew(nwfs,1);
<a name="l00597"></a>00597         <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00598"></a>00598         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;nwfs; iwfs++){
<a name="l00599"></a>00599         <span class="keywordtype">double</span> *realamp;
<a name="l00600"></a>00600         <span class="keywordflow">if</span>(powfs[ipowfs].locm){
<a name="l00601"></a>00601             <span class="keywordflow">if</span>(powfs[ipowfs].nlocm&gt;1)
<a name="l00602"></a>00602             realamp=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>[iwfs];
<a name="l00603"></a>00603             <span class="keywordflow">else</span>
<a name="l00604"></a>00604             realamp=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c4f3f1f3e24ea9b5e2d08c5798a901b">ampm</a>[0];
<a name="l00605"></a>00605         }<span class="keywordflow">else</span>{
<a name="l00606"></a>00606             realamp=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>;
<a name="l00607"></a>00607         }
<a name="l00608"></a>00608         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#18e39eb0dc4dee989858507587ea37fa">ncpa_grad</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2,1);
<a name="l00609"></a>00609         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#129c1dda529b641aac48415a110235b7" title="wfs type if not using physical optics in reconstruction.">gtype_sim</a>==1){
<a name="l00610"></a>00610             <a class="code" href="loc_8c.html#d445e3b2a45ec41744470c0b57ef44bb" title="Compute zernike best fit for all subapertures.">pts_ztilt</a>(powfs[ipowfs].ncpa_grad-&gt;p[iwfs]-&gt;p, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>,
<a name="l00611"></a>00611                   powfs[ipowfs].<a class="code" href="structPOWFS__T.html#8c1a97256a90efbb53166fc1ab5c16a9">imcc</a>, realamp, powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2990d6343a6195f3d0be9b133069a114">ncpa</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>);
<a name="l00612"></a>00612         }<span class="keywordflow">else</span>{
<a name="l00613"></a>00613             <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;powfs[ipowfs].ncpa_grad-&gt;p[iwfs],powfs[ipowfs].<a class="code" href="structPOWFS__T.html#61ba7e824f0228b45378bbb92efaebe3">GS0</a>,
<a name="l00614"></a>00614                  powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2990d6343a6195f3d0be9b133069a114">ncpa</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],1);
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00618"></a>00618         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].ncpa_grad, <span class="stringliteral">"%s/powfs%d_ncpa_grad"</span>,dirsetup,ipowfs);
<a name="l00619"></a>00619         }
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00622"></a>00622         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].ncpa, <span class="stringliteral">"%s/powfs%d_ncpa"</span>,dirsetup,ipowfs);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625     }<span class="comment">//if(fn_ncpa)</span>
<a name="l00626"></a>00626 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="692825f333d5738b213e2d6d4f1ab5d5"></a><!-- doxytag: member="setup_powfs.c::free_powfs_dtf" ref="692825f333d5738b213e2d6d4f1ab5d5" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void free_powfs_dtf           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Free the detector transfer function. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00631"></a>00631                                                                 {
<a name="l00632"></a>00632     <span class="keywordflow">if</span>(powfs[ipowfs].dtf){
<a name="l00633"></a>00633         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0;iwvl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;iwvl++){
<a name="l00634"></a>00634         ccellfree(powfs[ipowfs].dtf[iwvl].nominal);
<a name="l00635"></a>00635         spcellfree(powfs[ipowfs].dtf[iwvl].si);
<a name="l00636"></a>00636         cfree(powfs[ipowfs].dtf[iwvl].Ux);
<a name="l00637"></a>00637         cfree(powfs[ipowfs].dtf[iwvl].Uy);
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639         free(powfs[ipowfs].dtf);
<a name="l00640"></a>00640         dfree(powfs[ipowfs].dtheta);
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b1890fbc6facc2013338054962b1398a"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_dtf" ref="b1890fbc6facc2013338054962b1398a" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_dtf           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setting up Detector transfer function used to translate PSFs from FFTs to detector pixel images. 
<p>
Integration over pixel size and leaking between pixels are considered.<p>
We are going to sample the PSF <img class="formulaInl" alt="$\phi(\theta)$" src="form_19.png"> onto detectors. For a detector pixel <img class="formulaInl" alt="$i$" src="form_20.png"> at <img class="formulaInl" alt="$\theta_{i}$" src="form_21.png">, oriented along angle <img class="formulaInl" alt="$\alpha$" src="form_22.png">, we have <p class="formulaDsp">
<img class="formulaDsp" alt="\[ I(\theta_{i})=\int\textrm{d}\theta\phi(\theta)S(\theta-\theta_{i})=\int\textrm{d}\theta\phi(\theta-\theta_{i})S(\theta)\]" src="form_23.png">
<p>
 where <img class="formulaInl" alt="$S(\theta)$" src="form_24.png"> is the pixel weighting function. Rewrite the equation in Fourier domain,<p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} I(\theta_{i}) &amp; = &amp; \int\textrm{d}\theta\int\textrm{d} u\hat{\phi}(u)e^{2\pi i(\theta-\theta_{i})u}S(\theta)\\ &amp; = &amp; \int\textrm{d} u\hat{\phi}(u)\hat{S}(-u)e^{2\pi i\theta_{i}u}\\ &amp; = &amp; \mathcal{F}^{-1}[\hat{\phi}(u)\hat{S}(-u)](\theta_{i})\end{eqnarray*}" src="form_25.png">
<p>
<p>
For a polar coordinate CCD with pixel edges alonging , we have<p>
The detector pixels can be modeled as a square, convolved with a Gaussian to model the pixel blurring (charge leaking) <p class="formulaDsp">
<img class="formulaDsp" alt="\[ S(\theta)=S^{\prime}(\theta_{ra})=\sqcap(\theta_{r}/\Delta)\sqcap(\theta_{a}/\Delta)*\frac{1}{2\pi \theta_b^2}\exp(-\frac{\theta_r^2+\theta_u^2}{2\theta_b^2}) \]" src="form_26.png">
<p>
, where <img class="formulaInl" alt="$R$" src="form_27.png"> is the rotation matrix and <img class="formulaInl" alt="$\theta_{ra}=R^{T}\theta$" src="form_28.png"> is the coordinate in the local radial-azimuthal coordinate system for a Polar coordinate CCD, <img class="formulaInl" alt="$\theta_b$" src="form_29.png"> is a measure of the blurring of the pixel. For a pixel aligned along <img class="formulaInl" alt="$x/y$" src="form_30.png"> directions, <img class="formulaInl" alt="$R$" src="form_27.png"> is simply identity.<p>
The Fourier transform of the detector pixel function <img class="formulaInl" alt="$S(\theta)$" src="form_24.png"> is then<p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \hat{S}(u) &amp; = &amp; \int\textrm{d}\theta S(\theta)e^{-2\pi i\theta^{T}u}\\ &amp; = &amp; \int\textrm{d}\theta S^{\prime}(R^{T}\theta)e^{-2\pi i\theta^{T}u}\\ &amp; = &amp;\int\textrm{d}(R^{T}\theta)S^{\prime}(R^{T}\theta)e^{-2\pi i(R^{T}\theta)^{T}(R^{T}u)}\\ &amp; = &amp; \hat{S^{\prime}}(R^{T}u)\end{eqnarray*}" src="form_31.png">
<p>
<p>
The Fourier transform of <img class="formulaInl" alt="$\hat{S^{\prime}}$" src="form_32.png"> is <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \hat{S^{\prime}}(u_{ra})=\Delta^{2}\textrm{sinc}(u_{r}\Delta)\textrm{sinc}(u_{\theta}\Delta) \exp[-2\pi^2\theta_b^2(u_r^2+u_a^2)] \]" src="form_33.png">
<p>
<p>
Finally, we have <p class="formulaDsp">
<img class="formulaDsp" alt="\[ I(\theta_{i})=\mathcal{F}^{-1}[\hat{\phi}(u)\Delta^{2}\textrm{sinc}(\Delta(u_{x}\cos\theta+u_{y}\sin\theta))\textrm{sinc}(\Delta(-u_{x}\sin\theta+u_{y}\cos\theta))\exp[-2\pi^2\theta_b^2(u_r^2+u_a^2)](\theta_{i})\]" src="form_34.png">
<p>
 the last <img class="formulaInl" alt="$\theta_{i}$" src="form_21.png"> means evaluate the function at <img class="formulaInl" alt="$\theta_{i}$" src="form_21.png"> by interpolation. When there is leaking between actuators. We can multiply the sinc functions with a Gaussian blurring function. <div class="fragment"><pre class="fragment"><a name="l00693"></a>00693                                                                {
<a name="l00694"></a>00694     tic;
<a name="l00695"></a>00695     <span class="comment">//wvl independent parameters</span>
<a name="l00696"></a>00696     <span class="keyword">const</span> <span class="keywordtype">double</span> dxsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>;
<a name="l00697"></a>00697     <span class="keyword">const</span> <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00698"></a>00698     <span class="keyword">const</span> <span class="keywordtype">double</span> pixtheta=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#adf117b796aef86ac0b1759f81ad59fd" title="size of pixel pitch along x or y in radian">pixtheta</a>;
<a name="l00699"></a>00699     <span class="keyword">const</span> <span class="keywordtype">double</span> blur=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#4094009000b266064441565ba5f02407" title="pixel bluring due to leakage.">pixblur</a>*pixtheta;
<a name="l00700"></a>00700     <span class="keyword">const</span> <span class="keywordtype">double</span> e0=exp(-2*M_PI*M_PI*blur*blur);<span class="comment">//blurring factors</span>
<a name="l00701"></a>00701     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompx=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#67bf34f36dd078a571e7a14cdf0755de">ncompx</a>;
<a name="l00702"></a>00702     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompy=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#21071d969e8a6f006203a6c004339e0f">ncompy</a>;
<a name="l00703"></a>00703     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompx2=ncompx&gt;&gt;1;
<a name="l00704"></a>00704     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompy2=ncompy&gt;&gt;1;
<a name="l00705"></a>00705     <span class="keyword">const</span> <span class="keywordtype">int</span> nwvl=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;
<a name="l00706"></a>00706     <span class="keyword">const</span> <span class="keywordtype">int</span> pixpsax=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#9ec5687c5268785533c22d746016e663">pixpsax</a>;
<a name="l00707"></a>00707     <span class="keyword">const</span> <span class="keywordtype">int</span> pixpsay=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#091e911bea2900efcc9b160126ebf4ca">pixpsay</a>;
<a name="l00708"></a>00708     <span class="keyword">const</span> <span class="keywordtype">double</span> embfac=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>;
<a name="l00709"></a>00709     <span class="keyword">const</span> <span class="keywordtype">double</span> pxo=-(pixpsax/2-0.5+parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#8ee802eb87cf570b564cd2d8e73d153b" title="offset of image center from center of detector">pixoffx</a>)*pixtheta;
<a name="l00710"></a>00710     <span class="keyword">const</span> <span class="keywordtype">double</span> pyo=-(pixpsay/2-0.5+parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13af893d9ac11f1ebab08b690f39e78e" title="see pixoffx">pixoffy</a>)*pixtheta;
<a name="l00711"></a>00711     <span class="keywordtype">int</span> ndtf;
<a name="l00712"></a>00712     <span class="keywordtype">int</span> nllt;
<a name="l00713"></a>00713     <span class="keywordtype">int</span> multi_dtf=0;
<a name="l00714"></a>00714     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>&amp;&amp;!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#421d5f37ceb33e1a40262faf7ec4ef1d" title="For radial format CCD, rotate OTF into coordinate plane.">radrot</a>
<a name="l00715"></a>00715        &amp;&amp;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beacabf44ba95b84fa2ec6b4460f5364" title="number of detector pixels along radial direction if radial CCD">radpix</a>){
<a name="l00716"></a>00716     <span class="comment">/*When we have llt, there is elongation, radial pix but</span>
<a name="l00717"></a>00717 <span class="comment">      not use rotating psf/otf Need to create nominal/si for</span>
<a name="l00718"></a>00718 <span class="comment">      each subaperture. DTF is on x/y coordinate, so pixels</span>
<a name="l00719"></a>00719 <span class="comment">      and pixel coordinates need to rotated to r/a</span>
<a name="l00720"></a>00720 <span class="comment">      direction. */</span>
<a name="l00721"></a>00721     ndtf=nsa;
<a name="l00722"></a>00722     nllt=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#4b3cd998f117485fdcb8de6805fef38b" title="number of launch telescopes in this powfs">n</a>;
<a name="l00723"></a>00723     multi_dtf=1;
<a name="l00724"></a>00724     }<span class="keywordflow">else</span>{
<a name="l00725"></a>00725     <span class="comment">//We only need a single DTF.</span>
<a name="l00726"></a>00726     ndtf=1;
<a name="l00727"></a>00727     nllt=1;
<a name="l00728"></a>00728     multi_dtf=0;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>=calloc(nwvl,<span class="keyword">sizeof</span>(<a class="code" href="structDTF__T.html" title="contains the data associated with a detector transfer function for a subaperture...">DTF_T</a>));
<a name="l00731"></a>00731     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#48b216d44f49a49cd1e5f6e32534739d">dtheta</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nwvl,1);
<a name="l00732"></a>00732     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00733"></a>00733     <span class="keyword">const</span> <span class="keywordtype">double</span> wvl=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[iwvl];
<a name="l00734"></a>00734     <span class="keyword">const</span> <span class="keywordtype">double</span> dtheta=wvl/(dxsa*embfac);<span class="comment">//PSF sampling.</span>
<a name="l00735"></a>00735     <span class="keyword">const</span> <span class="keywordtype">double</span> dux=1./(dtheta*ncompx);
<a name="l00736"></a>00736     <span class="keyword">const</span> <span class="keywordtype">double</span> duy=1./(dtheta*ncompy);
<a name="l00737"></a>00737     <span class="keyword">const</span> <span class="keywordtype">double</span> dux2=dux*dux;
<a name="l00738"></a>00738     <span class="keyword">const</span> <span class="keywordtype">double</span> duy2=duy*duy;
<a name="l00739"></a>00739     <span class="keyword">const</span> <span class="keywordtype">double</span> pdtheta=pixtheta*pixtheta/(dtheta*dtheta);
<a name="l00740"></a>00740     <span class="keyword">const</span> <span class="keywordtype">double</span> duyp=duy*pixtheta;
<a name="l00741"></a>00741     <span class="keyword">const</span> <span class="keywordtype">double</span> duxp=dux*pixtheta;
<a name="l00742"></a>00742     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#48b216d44f49a49cd1e5f6e32534739d">dtheta</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iwvl]=dtheta;
<a name="l00743"></a>00743     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#09ef991e4e93b35bef6106fb80030ffd" title="The FFT of the pixel functions.">nominal</a>=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(ndtf,nllt);
<a name="l00744"></a>00744     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#e3f3495e330b12ff92cbd0370793df26" title="The pixel selection.">si</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(ndtf,nllt);
<a name="l00745"></a>00745     <a class="code" href="structcmat.html" title="a double complex matrix object contains 2-d arrays of double complex numbers.">cmat</a>*(*nominals)[ndtf]=
<a name="l00746"></a>00746         (<span class="keywordtype">void</span>*)powfs[ipowfs].dtf[iwvl].nominal-&gt;p;
<a name="l00747"></a>00747     <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a>*(*sis)[ndtf]=(<span class="keywordtype">void</span>*)powfs[ipowfs].dtf[iwvl].si-&gt;p;
<a name="l00748"></a>00748     <a class="code" href="structcmat.html" title="a double complex matrix object contains 2-d arrays of double complex numbers.">cmat</a> *nominal=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompx,ncompy);
<a name="l00749"></a>00749     <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(nominal,-1);
<a name="l00750"></a>00750     <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(nominal,1);
<a name="l00751"></a>00751     PCMAT(nominal,pn);
<a name="l00752"></a>00752     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc_psf=<a class="code" href="loc_8c.html#9b68fa77107ecb06a9407fe1ad31eb24" title="Create a loc array contains coorindates in a square map of size nx*ny, with sampling...">mksqloc</a>(ncompx,ncompy,dtheta,
<a name="l00753"></a>00753                    -ncompx2*dtheta,
<a name="l00754"></a>00754                    -ncompy2*dtheta);
<a name="l00755"></a>00755     <span class="keywordtype">double</span> theta=0;
<a name="l00756"></a>00756     <span class="keywordtype">double</span> ct=cos(theta);
<a name="l00757"></a>00757     <span class="keywordtype">double</span> st=sin(theta);
<a name="l00758"></a>00758     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> illt=0; illt&lt;nllt; illt++){
<a name="l00759"></a>00759         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;ndtf; isa++){
<a name="l00760"></a>00760         <span class="keywordflow">if</span>(multi_dtf){
<a name="l00761"></a>00761             theta=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fd0302013032e547054f9431d7aee502">srot</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa];
<a name="l00762"></a>00762             ct=cos(theta);
<a name="l00763"></a>00763             st=sin(theta);
<a name="l00764"></a>00764         }
<a name="l00765"></a>00765         
<a name="l00766"></a>00766         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;ncompy; iy++){
<a name="l00767"></a>00767             <span class="keywordtype">int</span> jy=iy-ncompy2;
<a name="l00768"></a>00768             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;ncompx; ix++){
<a name="l00769"></a>00769             <span class="keywordtype">int</span> jx=ix-ncompx2;
<a name="l00770"></a>00770             <span class="keywordtype">double</span> ir=ct*jx+st*jy;
<a name="l00771"></a>00771             <span class="keywordtype">double</span> ia=-st*jx+ct*jy;
<a name="l00772"></a>00772             pn[iy][ix]=sinc(ir*duyp)*sinc(ia*duxp)
<a name="l00773"></a>00773                 *pow(e0, ir*ir*duy2 + ia*ia*dux2)
<a name="l00774"></a>00774                 *pdtheta;
<a name="l00775"></a>00775             }
<a name="l00776"></a>00776         }
<a name="l00777"></a>00777         <span class="comment">/*put peak in corner. pretreat nominal so</span>
<a name="l00778"></a>00778 <span class="comment">          that we avoid fftshift when forming i0.*/</span>
<a name="l00779"></a>00779         
<a name="l00780"></a>00780         <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(nominal);
<a name="l00781"></a>00781         <a class="code" href="fft_8c.html#5e22d51b30da1c5c057cb5b8f121273d" title="Do 2d FFT transforms.">cfft2</a>(nominal,-1);
<a name="l00782"></a>00782         <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(nominal);
<a name="l00783"></a>00783         <a class="code" href="fft_8c.html#5e22d51b30da1c5c057cb5b8f121273d" title="Do 2d FFT transforms.">cfft2</a>(nominal,1);
<a name="l00784"></a>00784         <a class="code" href="cmat_8h.html#204751357459432e00c5f5ee8d261f56" title="scale each element of A by w">cscale</a>(nominal,1./(<span class="keywordtype">double</span>)(nominal-&gt;nx*nominal-&gt;ny));
<a name="l00785"></a>00785         
<a name="l00786"></a>00786         <a class="code" href="cmat_8h.html#db3c55ee96a9e7249403f738d251688c" title="copy the values from one X(mat) to another.">ccp</a>(&amp;nominals[illt][isa], nominal);
<a name="l00787"></a>00787         <span class="comment">//nominals[illt][isa]=cffttreat(nominal);</span>
<a name="l00788"></a>00788         <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc_ccd=<a class="code" href="loc_8c.html#48d564e72a73a72f918e62fd877e0a34" title="like mksqloc, but roated theta CCW.">mksqlocrot</a>(pixpsax,pixpsay,
<a name="l00789"></a>00789                       pixtheta,pxo,pyo,theta);
<a name="l00790"></a>00790         sis[illt][isa]=<a class="code" href="mkh_8c.html#30a870f4967f90f2b169b56e2338cf24" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(loc_psf,loc_ccd,NULL,0,0,1,1);
<a name="l00791"></a>00791         locfree(loc_ccd);
<a name="l00792"></a>00792         }<span class="comment">//isa</span>
<a name="l00793"></a>00793     }<span class="comment">//illt</span>
<a name="l00794"></a>00794     cfree(nominal);
<a name="l00795"></a>00795     locfree(loc_psf);
<a name="l00796"></a>00796     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00797"></a>00797         <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(powfs[ipowfs].dtf[iwvl].nominal,
<a name="l00798"></a>00798                <span class="stringliteral">"%s/powfs%d_dtf%d_nominal.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l00799"></a>00799         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(powfs[ipowfs].dtf[iwvl].si,
<a name="l00800"></a>00800             <span class="stringliteral">"%s/powfs%d_dtf%d_si.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l00801"></a>00801     }
<a name="l00802"></a>00802     <span class="comment">/*Create an excessive high frequency in nominal so that</span>
<a name="l00803"></a>00803 <span class="comment">      we don't have to do fftshift later.*/</span>
<a name="l00804"></a>00804     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#56335bbc907da081ba1a8b9602799f28" title="Special frequency vector along x.">Ux</a>=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompx,1);
<a name="l00805"></a>00805     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#e73dd5b0a9a0e4d72fffbb68f1e2abaf" title="Special frequency vector along y.">Uy</a>=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompy,1);
<a name="l00806"></a>00806     dcomplex *Ux=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#56335bbc907da081ba1a8b9602799f28" title="Special frequency vector along x.">Ux</a>-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>;
<a name="l00807"></a>00807     dcomplex *Uy=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#e73dd5b0a9a0e4d72fffbb68f1e2abaf" title="Special frequency vector along y.">Uy</a>-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="comment">/*The following is used in genseotf to compute shifted</span>
<a name="l00810"></a>00810 <span class="comment">      i0.  not used currently*/</span>
<a name="l00811"></a>00811     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;ncompx; ix++){
<a name="l00812"></a>00812         <span class="keywordtype">int</span> jx=ix&lt;ncompx2?ix:(ix-ncompx);
<a name="l00813"></a>00813         Ux[ix]=-2.*I*M_PI*jx*dux;
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;ncompy; iy++){
<a name="l00816"></a>00816         <span class="keywordtype">int</span> jy=iy&lt;ncompy2?iy:(iy-ncompy);
<a name="l00817"></a>00817         Uy[iy]=-2.*I*M_PI*jy*duy;
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     }<span class="comment">//iwvl</span>
<a name="l00821"></a>00821     toc(<span class="stringliteral">"dtf"</span>);
<a name="l00822"></a>00822 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="7bbae2bc69e06f553d55c7c2d8c68ff3"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_focus" ref="7bbae2bc69e06f553d55c7c2d8c68ff3" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_focus           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
setup the range to sodium layer as an additional parameter. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00826"></a>00826                                                                                {
<a name="l00827"></a>00827     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a> || !parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#c169cd8bd15a4ee86824d5d40ec9038d" title="File contains range to sodium layer.">fnrange</a>) <span class="keywordflow">return</span>;
<a name="l00828"></a>00828     <span class="keywordtype">char</span> *fnrange=<a class="code" href="path_8c.html#25730e4c54130615ab7657ac89c39150" title="Locate a file in path and return its absolute filename.">find_file</a>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#c169cd8bd15a4ee86824d5d40ec9038d" title="File contains range to sodium layer.">fnrange</a>);
<a name="l00829"></a>00829     warning(<span class="stringliteral">"ipowfs %d: loading sodium range from %s\n"</span>, ipowfs, fnrange);
<a name="l00830"></a>00830     <span class="keywordflow">if</span>(powfs[ipowfs].focus) dfree(powfs[ipowfs].focus);
<a name="l00831"></a>00831     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>=<a class="code" href="dmat_8h.html#6406403e91ec976bb0d6c2e12b5d5a0f" title="User callable function to read dense matrix into memory from file.">dread</a>(<span class="stringliteral">"%s"</span>,fnrange);
<a name="l00832"></a>00832     free(fnrange);
<a name="l00833"></a>00833     <span class="keywordflow">if</span>(powfs[ipowfs].focus-&gt;ny!=1 &amp;&amp;powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>!=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>){
<a name="l00834"></a>00834     error(<span class="stringliteral">"fnrange has wrong format. Must be column vectors of 1 or %d columns\n"</span>,
<a name="l00835"></a>00835           parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>);
<a name="l00836"></a>00836     }
<a name="l00837"></a>00837     <span class="keywordtype">double</span> *p=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00838"></a>00838     <span class="comment">//Convert range to focus.</span>
<a name="l00839"></a>00839     <span class="keywordtype">double</span> range2focus=pow(parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>,2)/(16.*sqrt(3));
<a name="l00840"></a>00840     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii=0; ii&lt;powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>*powfs[ipowfs].<a class="code" href="structPOWFS__T.html#6a873a35f09a8cbf5a924eb55f0d7c6f">focus</a>-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>; ii++){
<a name="l00841"></a>00841     p[ii]*=range2focus;
<a name="l00842"></a>00842     }
<a name="l00843"></a>00843 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="e2eab1b8ad97f659e38afe630140834e"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_sodium" ref="e2eab1b8ad97f659e38afe630140834e" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_sodium           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Load and smooth out sodium profile. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00848"></a>00848                                                                                 {
<a name="l00849"></a>00849     <span class="keywordtype">char</span> *lltfn=<a class="code" href="path_8c.html#25730e4c54130615ab7657ac89c39150" title="Locate a file in path and return its absolute filename.">find_file</a>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#70eb04f0807122abd12ef33b39c30b76" title="File contains sodium profile.">fn</a>);
<a name="l00850"></a>00850     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *nain=<a class="code" href="dmat_8h.html#6406403e91ec976bb0d6c2e12b5d5a0f" title="User callable function to read dense matrix into memory from file.">dread</a>(<span class="stringliteral">"%s"</span>,lltfn);
<a name="l00851"></a>00851     <span class="keywordflow">if</span>(nain-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>&lt;2){
<a name="l00852"></a>00852     error(<span class="stringliteral">"nain %s is in wrong fromat\n"</span>, lltfn);
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854     free(lltfn);
<a name="l00855"></a>00855     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[0].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#7597ec8512d1f9c6b4ae809b09c3d9e7" title="smooth the sodium profile or not">smooth</a>){
<a name="l00856"></a>00856     <span class="comment">//Make new sampling:</span>
<a name="l00857"></a>00857     <span class="keywordtype">double</span> rsamax=<a class="code" href="dmat_8h.html#abb4fecd296ac9ec19263e0f9d853be7" title="find the maximum value of a X(mat) object">dmax</a>(powfs[ipowfs].srsamax);
<a name="l00858"></a>00858     <span class="keywordtype">double</span> dthetamin=<a class="code" href="dmat_8h.html#00004b652c3485c94f4f64cfdafe5577" title="find the minimum value of a X(mat) object">dmin</a>(powfs[ipowfs].dtheta);
<a name="l00859"></a>00859     <span class="keyword">const</span> <span class="keywordtype">double</span> x0in=nain-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0];
<a name="l00860"></a>00860     <span class="keyword">const</span> <span class="keywordtype">long</span> nxin=nain-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>;
<a name="l00861"></a>00861     <span class="keywordtype">double</span> dxin=(nain-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[nxin-1]-x0in)/(nxin-1);
<a name="l00862"></a>00862     <span class="comment">//minimum sampling required.</span>
<a name="l00863"></a>00863     <span class="keywordtype">double</span> dxnew=pow(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>,2)/rsamax*dthetamin;
<a name="l00864"></a>00864     
<a name="l00865"></a>00865     <span class="keywordflow">if</span>(dxnew &gt; dxin * 2){
<a name="l00866"></a>00866         info(<span class="stringliteral">"Smoothing sodium profile\n"</span>);
<a name="l00867"></a>00867         <span class="keyword">const</span> <span class="keywordtype">long</span> nxnew=ceil((nain-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[nxin-1]-x0in)/dxnew);
<a name="l00868"></a>00868         <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc_in=<a class="code" href="loc_8c.html#f03553e36377e6d1d8d64239b40557a6" title="Create 1 dimensional loc with given vector.">mk1dloc_vec</a>(nain-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, nxin);
<a name="l00869"></a>00869         <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc_out=<a class="code" href="loc_8c.html#2e267a4b3cd9e8dba1138abf0ef0e303" title="Create 1 dimensional loc with origin at x0, sampling of dx, and nx numbers.">mk1dloc</a>(x0in, dxnew, nxnew);
<a name="l00870"></a>00870         <a class="code" href="structdsp.html" title="a sparse array of double numbers stored in compressed column format, i.e.">dsp</a> *ht=<a class="code" href="mkh_8c.html#8d6ae4511d18adfbb15f19ae6873738e" title="Create the transpose of the interpolator matrix for from locin to locout.">mkhb</a>(loc_out, loc_in, NULL, 0, 0, 1, 0);
<a name="l00871"></a>00871         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nxnew, nain-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>);
<a name="l00872"></a>00872         memcpy(powfs[ipowfs].sodium-&gt;p, loc_out-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*nxnew);
<a name="l00873"></a>00873         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> icol=1; icol&lt;nain-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>; icol++){
<a name="l00874"></a>00874         <a class="code" href="dsp_8h.html#901d9dc69e7cba48bd4426cb95f9c740" title="sparse matrix multiply with a vector">spmulvec</a>(powfs[ipowfs].sodium-&gt;p + nxnew*icol,
<a name="l00875"></a>00875              ht, nain-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a> + nxin * icol, 1);
<a name="l00876"></a>00876         }
<a name="l00877"></a>00877         spfree(ht);
<a name="l00878"></a>00878         locfree(loc_in);
<a name="l00879"></a>00879         locfree(loc_out);
<a name="l00880"></a>00880         dfree(nain);
<a name="l00881"></a>00881     }<span class="keywordflow">else</span>{
<a name="l00882"></a>00882         warning(<span class="stringliteral">"Not smoothing sodium profile\n"</span>);
<a name="l00883"></a>00883         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>=nain;
<a name="l00884"></a>00884     }
<a name="l00885"></a>00885     }<span class="keywordflow">else</span>{
<a name="l00886"></a>00886     warning(<span class="stringliteral">"Not smoothing sodium profile\n"</span>);
<a name="l00887"></a>00887     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>=nain;
<a name="l00888"></a>00888     }
<a name="l00889"></a>00889     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> icol=1; icol&lt;powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>; icol++){
<a name="l00890"></a>00890     <span class="keywordtype">double</span> *p=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+icol*powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>;
<a name="l00891"></a>00891     <span class="comment">//Zero the two ends.</span>
<a name="l00892"></a>00892     p[0]=0; p[powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>-1]=0;
<a name="l00893"></a>00893     <a class="code" href="mathmisc_8c.html#4ed0395a68a0c06d7bab414a7ba61ca2" title="normalize vector to max to max;">normalize_max</a>(p, powfs[ipowfs].sodium-&gt;nx,1);
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00896"></a>00896     <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(powfs[ipowfs].sodium, <span class="stringliteral">"%s/powfs%d_sodium"</span>,dirsetup,ipowfs);
<a name="l00897"></a>00897     }
<a name="l00898"></a>00898 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="bd59ad37c2a3372a70066e4b5cf34ac1"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_etf" ref="bd59ad37c2a3372a70066e4b5cf34ac1" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs, int mode, int istep)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_powfs_etf           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>istep</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Compute Elongation Transfer function. 
<p>
<ul>
<li>mode=0: for preparation.</li><li>mode=1: for simulation. </li></ul>
<div class="fragment"><pre class="fragment"><a name="l00904"></a>00904                                                                                            {
<a name="l00905"></a>00905     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>) <span class="keywordflow">return</span>;
<a name="l00906"></a>00906     <span class="keyword">const</span> <span class="keywordtype">double</span> dxsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>;
<a name="l00907"></a>00907     <span class="keyword">const</span> <span class="keywordtype">int</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l00908"></a>00908     <span class="keyword">const</span> <span class="keywordtype">int</span> nllt=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#4b3cd998f117485fdcb8de6805fef38b" title="number of launch telescopes in this powfs">n</a>;
<a name="l00909"></a>00909     <span class="keyword">const</span> <span class="keywordtype">int</span> nwvl=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;
<a name="l00910"></a>00910     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompx=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#67bf34f36dd078a571e7a14cdf0755de">ncompx</a>;
<a name="l00911"></a>00911     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompy=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#21071d969e8a6f006203a6c004339e0f">ncompy</a>;
<a name="l00912"></a>00912     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompx2=ncompx&gt;&gt;1;
<a name="l00913"></a>00913     <span class="keyword">const</span> <span class="keywordtype">int</span> ncompy2=ncompy&gt;&gt;1;
<a name="l00914"></a>00914     <a class="code" href="structETF__T.html" title="contains the data associated with an elongation transfer function for a subaperture...">ETF_T</a> *powfsetf=NULL;
<a name="l00915"></a>00915     <span class="keywordtype">int</span> colstart, colskip;
<a name="l00916"></a>00916     <span class="keywordflow">if</span>(mode==0){<span class="comment">//preparation.</span>
<a name="l00917"></a>00917     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#09d11667df6efd9bab59b16505ea524e">etfprep</a>=calloc(nwvl, <span class="keyword">sizeof</span>(<a class="code" href="structETF__T.html" title="contains the data associated with an elongation transfer function for a subaperture...">ETF_T</a>));
<a name="l00918"></a>00918     powfsetf=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#09d11667df6efd9bab59b16505ea524e">etfprep</a>;
<a name="l00919"></a>00919     colskip=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#5248186f49c163e6b557564e17125807" title="starting column to use in fn for ETF in preparation of matched filter">colprep</a>;
<a name="l00920"></a>00920     }<span class="keywordflow">else</span>{
<a name="l00921"></a>00921     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#5248186f49c163e6b557564e17125807" title="starting column to use in fn for ETF in preparation of matched filter">colprep</a>==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#b98cc62458a0880ce23196c961b11008" title="starting column to use in fn for ETF in simulation">colsim</a>
<a name="l00922"></a>00922        &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#c8b3e202f9c4be878eb3a9a599c1de4f" title="change to next sodium profile during simulation every colsimdtrat time step">colsimdtrat</a>==0){
<a name="l00923"></a>00923         <span class="keywordflow">if</span>(powfs[ipowfs].etfsim){
<a name="l00924"></a>00924         error(<span class="stringliteral">"powfs %d: etfsim should be empty\n"</span>,ipowfs);
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926         <span class="keywordflow">if</span>(!powfs[ipowfs].etfprep){
<a name="l00927"></a>00927         error(<span class="stringliteral">"powfs %d: Please call setup_powfs_etf with mode = 0 first\n"</span>,ipowfs);
<a name="l00928"></a>00928         }
<a name="l00929"></a>00929         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#a7f1f27f5404099b70ac042a2db8bb3d">etfsim</a>=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#09d11667df6efd9bab59b16505ea524e">etfprep</a>;
<a name="l00930"></a>00930         warning(<span class="stringliteral">"powfs %d: simulation and reconstruction using same etf\n"</span>,ipowfs);
<a name="l00931"></a>00931         <span class="keywordflow">return</span>;
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933     <span class="keywordflow">if</span>(powfs[ipowfs].etfsim){
<a name="l00934"></a>00934         info(<span class="stringliteral">"powfs %d: Free previous etfsim\n"</span>,ipowfs);
<a name="l00935"></a>00935         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0;iwvl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;iwvl++){
<a name="l00936"></a>00936         ccellfree(powfs[ipowfs].etfsim[iwvl].p1);
<a name="l00937"></a>00937         ccellfree(powfs[ipowfs].etfsim[iwvl].p2);
<a name="l00938"></a>00938         }
<a name="l00939"></a>00939         free(powfs[ipowfs].etfsim);
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#a7f1f27f5404099b70ac042a2db8bb3d">etfsim</a>=calloc(nwvl, <span class="keyword">sizeof</span>(<a class="code" href="structETF__T.html" title="contains the data associated with an elongation transfer function for a subaperture...">ETF_T</a>));
<a name="l00942"></a>00942     powfsetf=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#a7f1f27f5404099b70ac042a2db8bb3d">etfsim</a>;
<a name="l00943"></a>00943     colskip=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#b98cc62458a0880ce23196c961b11008" title="starting column to use in fn for ETF in simulation">colsim</a>;
<a name="l00944"></a>00944     }
<a name="l00945"></a>00945     <span class="comment">//find maximum elongation. </span>
<a name="l00946"></a>00946     <span class="comment">//Then test if # of pixels large enough.</span>
<a name="l00947"></a>00947  
<a name="l00948"></a>00948     assert(nwvl==1);<span class="comment">//sanity check. need to double check the code is nwvl!=1.</span>
<a name="l00949"></a>00949     <span class="keyword">const</span> <span class="keywordtype">double</span> embfac=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>;
<a name="l00950"></a>00950     <span class="comment">//setup elongation along radial direction. don't care azimuthal.</span>
<a name="l00951"></a>00951     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00952"></a>00952     <span class="keyword">const</span> <span class="keywordtype">double</span> wvl=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[iwvl];
<a name="l00953"></a>00953     <span class="keyword">const</span> <span class="keywordtype">double</span> dtheta=wvl/(dxsa*embfac);<span class="comment">//PSF sampling.</span><span class="comment"></span>
<a name="l00954"></a>00954 <span class="comment">    /**</span>
<a name="l00955"></a>00955 <span class="comment">       fixme: should do integrate instead of just interpolating closest point. </span>
<a name="l00956"></a>00956 <span class="comment">    */</span>
<a name="l00957"></a>00957     <a class="code" href="structcmat.html" title="a double complex matrix object contains 2-d arrays of double complex numbers.">cmat</a> *(*petf)[nsa]=NULL;
<a name="l00958"></a>00958     <span class="keyword">const</span> <span class="keywordtype">int</span> ndtf=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#09ef991e4e93b35bef6106fb80030ffd" title="The FFT of the pixel functions.">nominal</a>-&gt;<a class="code" href="structccell.html#b08666a33e3b77dc0ebad13f58cd6f86" title="number of rows">nx</a>;
<a name="l00959"></a>00959     <a class="code" href="structcmat.html" title="a double complex matrix object contains 2-d arrays of double complex numbers.">cmat</a> *(*pnominal)[ndtf]=(<span class="keywordtype">void</span>*)powfs[ipowfs].dtf[iwvl].nominal-&gt;p;
<a name="l00960"></a>00960     <span class="keywordtype">int</span> mnominal;<span class="comment">//multiply with isa to get index into pnominal.</span>
<a name="l00961"></a>00961     <span class="keywordflow">if</span>(ndtf==1)
<a name="l00962"></a>00962         mnominal=0;
<a name="l00963"></a>00963     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ndtf==nsa)
<a name="l00964"></a>00964         mnominal=1;
<a name="l00965"></a>00965     <span class="keywordflow">else</span>{
<a name="l00966"></a>00966         mnominal=-1;
<a name="l00967"></a>00967         error(<span class="stringliteral">"Invalid nominal.\n"</span>);
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969     <span class="keywordtype">int</span> use1d;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#421d5f37ceb33e1a40262faf7ec4ef1d" title="For radial format CCD, rotate OTF into coordinate plane.">radrot</a>){
<a name="l00972"></a>00972         <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beacabf44ba95b84fa2ec6b4460f5364" title="number of detector pixels along radial direction if radial CCD">radpix</a>){
<a name="l00973"></a>00973         error(<span class="stringliteral">"radrot can only be used with radpix\n"</span>);
<a name="l00974"></a>00974         }
<a name="l00975"></a>00975         <span class="comment">/*</span>
<a name="l00976"></a>00976 <span class="comment">          Use rotating psf/otf method to do radial</span>
<a name="l00977"></a>00977 <span class="comment">          pixel. ETF is 1D only. Good for off-axis</span>
<a name="l00978"></a>00978 <span class="comment">          launch, otherwise, ETF and DTF takes a lot of</span>
<a name="l00979"></a>00979 <span class="comment">          space for 6 LGS in NFIRAOS setup</span>
<a name="l00980"></a>00980 <span class="comment">          warning("Using rot psf/otf method to do radial</span>
<a name="l00981"></a>00981 <span class="comment">          pixel detector\n");</span>
<a name="l00982"></a>00982 <span class="comment">        */</span>
<a name="l00983"></a>00983 <span class="preprocessor">#if ROT_OTF == 1</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span>        warning(<span class="stringliteral">"powfs %d: rotate OTF to do radial format detector (non-preferred)\n"</span>,ipowfs);
<a name="l00985"></a>00985 <span class="preprocessor">#elif ROT_OTF==0</span>
<a name="l00986"></a>00986 <span class="preprocessor"></span>        warning(<span class="stringliteral">"powfs %d: rotate PSF to do radial format detector (preferred)\n"</span>,ipowfs);
<a name="l00987"></a>00987 <span class="preprocessor">#else</span>
<a name="l00988"></a>00988 <span class="preprocessor"></span>        error(<span class="stringliteral">"Invalid option\n"</span>);
<a name="l00989"></a>00989 <span class="preprocessor">#endif</span>
<a name="l00990"></a>00990 <span class="preprocessor"></span>        powfsetf[iwvl].<a class="code" href="structETF__T.html#b781758d05064148c2d4a7b1c586d3d7" title="Store the ETF along radial direction when radrot==1.">p1</a>=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(nsa,nllt);
<a name="l00991"></a>00991         petf=(<span class="keywordtype">void</span>*)powfsetf[iwvl].p1-&gt;p;
<a name="l00992"></a>00992         use1d=1;
<a name="l00993"></a>00993     }<span class="keywordflow">else</span>{
<a name="l00994"></a>00994         <span class="comment">/*</span>
<a name="l00995"></a>00995 <span class="comment">          Applied to 2 cases: </span>
<a name="l00996"></a>00996 <span class="comment">          1) radial ccd, not rotating PSF or OTF</span>
<a name="l00997"></a>00997 <span class="comment">          2) Non-radial ccd</span>
<a name="l00998"></a>00998 <span class="comment">          2010-01-04: Fuse dtf nominal into etf for this case.</span>
<a name="l00999"></a>00999 <span class="comment">        */</span>
<a name="l01000"></a>01000         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beacabf44ba95b84fa2ec6b4460f5364" title="number of detector pixels along radial direction if radial CCD">radpix</a>){
<a name="l01001"></a>01001         warning(<span class="stringliteral">"powfs %d: 2D ETF for Radial CCD\n"</span>,ipowfs);
<a name="l01002"></a>01002         }<span class="keywordflow">else</span>{
<a name="l01003"></a>01003         warning(<span class="stringliteral">"powfs %d: Non-Radial CCD\n"</span>,ipowfs);
<a name="l01004"></a>01004         }
<a name="l01005"></a>01005         powfsetf[iwvl].<a class="code" href="structETF__T.html#4bae81d27069a58c66e58a04b09be814" title="Store the 2D ETF when radrot==0.">p2</a>=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(nsa,nllt);
<a name="l01006"></a>01006         petf=(<span class="keywordtype">void</span>*)powfsetf[iwvl].p2-&gt;p;
<a name="l01007"></a>01007         use1d=0;
<a name="l01008"></a>01008     }
<a name="l01009"></a>01009     <span class="keyword">const</span> <span class="keywordtype">int</span> fuse_etf=(use1d==0);
<a name="l01010"></a>01010     <a class="code" href="structcmat.html" title="a double complex matrix object contains 2-d arrays of double complex numbers.">cmat</a> *etf=NULL;
<a name="l01011"></a>01011     <span class="keywordtype">int</span> netf;
<a name="l01012"></a>01012     <span class="keywordtype">double</span> dusc;
<a name="l01013"></a>01013     <span class="keywordtype">double</span> dtetf;
<a name="l01014"></a>01014     <span class="keywordtype">int</span> npad;
<a name="l01015"></a>01015     <span class="keywordtype">int</span> nover;
<a name="l01016"></a>01016     <span class="keywordflow">if</span>(use1d){
<a name="l01017"></a>01017         <span class="comment">/*</span>
<a name="l01018"></a>01018 <span class="comment">          2009-12-18:Thinking of padding here also to reduce aliasing. </span>
<a name="l01019"></a>01019 <span class="comment">          result: helps little, not much.</span>
<a name="l01020"></a>01020 <span class="comment">        */</span>
<a name="l01021"></a>01021         npad=2;<span class="comment">//zero padding to reduce aliasing?</span>
<a name="l01022"></a>01022         nover=2;
<a name="l01023"></a>01023         <span class="comment">//padding by x2.</span>
<a name="l01024"></a>01024         netf=ncompx*nover*npad;
<a name="l01025"></a>01025         dtetf=dtheta/nover;
<a name="l01026"></a>01026     }<span class="keywordflow">else</span>{
<a name="l01027"></a>01027         <span class="comment">/*</span>
<a name="l01028"></a>01028 <span class="comment">          We padd the array to incrase the sampling of</span>
<a name="l01029"></a>01029 <span class="comment">          du. Don't shrink dtheta.  in use1d==0 case, du in</span>
<a name="l01030"></a>01030 <span class="comment">          etf is smaller.  so interpolation will be more</span>
<a name="l01031"></a>01031 <span class="comment">          accurate.</span>
<a name="l01032"></a>01032 <span class="comment">        */</span>
<a name="l01033"></a>01033         npad=2;
<a name="l01034"></a>01034         nover=2;<span class="comment">//doesn't change a lot. reduce aliasing</span>
<a name="l01035"></a>01035         <span class="comment">//padding by x2.</span>
<a name="l01036"></a>01036         netf=ncompx*nover*npad;
<a name="l01037"></a>01037         <span class="comment">//make du array bigger so that rotation is covered</span>
<a name="l01038"></a>01038         dtetf=dtheta/nover;
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040     dusc=(netf*dtetf)/(dtheta*ncompx);
<a name="l01041"></a>01041     etf=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(netf,1);
<a name="l01042"></a>01042     <span class="keywordtype">double</span> *thetas=calloc(netf, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01043"></a>01043     <span class="keywordtype">int</span> netf2=netf&gt;&gt;1;
<a name="l01044"></a>01044     <span class="comment">//Only interpolating the center part. the rest is padding.</span>
<a name="l01045"></a>01045     <span class="keywordtype">int</span> etf0=netf2-(int)round(ncompx2*(dtheta/dtetf));
<a name="l01046"></a>01046     <span class="keywordtype">int</span> etf1=etf0+(int)round(ncompx*(dtheta/dtetf));
<a name="l01047"></a>01047     <span class="keywordflow">if</span>(etf0&lt;0) error(<span class="stringliteral">"Invalid configuration\n"</span>);
<a name="l01048"></a>01048     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> it=etf0; it&lt;etf1; it++){
<a name="l01049"></a>01049         thetas[it]=(it-netf2)*dtetf;
<a name="l01050"></a>01050     }
<a name="l01051"></a>01051     <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(etf, -1);
<a name="l01052"></a>01052     <span class="keywordflow">if</span>(!powfs[ipowfs].sodium){
<a name="l01053"></a>01053         error(<span class="stringliteral">"Sodium profile is NULL\n"</span>);
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *sodium=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#009cd8a55bb6dd1c05e3119bf229458a">sodium</a>;
<a name="l01056"></a>01056         <span class="keywordtype">int</span> nhp=sodium-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; 
<a name="l01057"></a>01057 
<a name="l01058"></a>01058     <span class="keyword">const</span> <span class="keywordtype">double</span> hs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>;
<a name="l01059"></a>01059     <span class="keywordtype">double</span> hpmin=sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]/cos(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#8bec09f88dc7ab71730f50f54bca225e" title="zenith angle in radian">za</a>);
<a name="l01060"></a>01060     <span class="keywordtype">double</span> dhp1=1./(sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1]-sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]);
<a name="l01061"></a>01061     <span class="comment">//assume linear spacing. check the assumption valid</span>
<a name="l01062"></a>01062     <span class="keywordflow">if</span>(fabs(sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[nhp-1]-sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]-(nhp-1)/dhp1)&gt;1.e-7){
<a name="l01063"></a>01063         error(<span class="stringliteral">"llt profile is not evenly spaced:%g\n"</span>,
<a name="l01064"></a>01064           fabs(sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[nhp-1]-sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]-(nhp-1)/dhp1));
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066     dhp1=dhp1*cos(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#8bec09f88dc7ab71730f50f54bca225e" title="zenith angle in radian">za</a>);
<a name="l01067"></a>01067     <span class="keywordflow">if</span>((sodium-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>-1-colskip)&lt;0){
<a name="l01068"></a>01068         error(<span class="stringliteral">"Invalid configuration. colprep or colsim is too big\n"</span>);
<a name="l01069"></a>01069     }
<a name="l01070"></a>01070     colstart=colskip+istep%(sodium-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>-1-colskip);
<a name="l01071"></a>01071     warning(<span class="stringliteral">"powfs %d: Na using column %d in %s\n"</span>,ipowfs,colstart,
<a name="l01072"></a>01072         mode==0?<span class="stringliteral">"preparation"</span>:<span class="stringliteral">"simulation"</span>);
<a name="l01073"></a>01073     <span class="keywordtype">double</span>* pp=sodium-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+nhp*(1+colstart);
<a name="l01074"></a>01074     <span class="keywordflow">if</span>(fabs(pp[0])&gt;1.e-15 || fabs(pp[nhp-1])&gt;1.e-15){
<a name="l01075"></a>01075         warning(<span class="stringliteral">"Changed sodium profile both ends to zero.\n"</span>);
<a name="l01076"></a>01076         pp[0]=0;
<a name="l01077"></a>01077         pp[nhp-1]=0;
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> illt=0; illt&lt;nllt; illt++){
<a name="l01081"></a>01081         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> isa=0; isa&lt;nsa; isa++){
<a name="l01082"></a>01082         <span class="comment">//1d ETF along radius.</span>
<a name="l01083"></a>01083         <span class="keywordtype">double</span> rsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#1aeacf2ddfafb73167818e8a23dcdf59">srsa</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa];
<a name="l01084"></a>01084         <span class="keywordtype">double</span> etf2sum=0;
<a name="l01085"></a>01085         <a class="code" href="cmat_8h.html#5f6b5be2adda9848d051174da45fc340" title="initialize all numbers in a X(mat) object to 0">czero</a>(etf);
<a name="l01086"></a>01086         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> icomp=etf0; icomp&lt;etf1; icomp++){
<a name="l01087"></a>01087             <span class="comment">//peak in center</span>
<a name="l01088"></a>01088             <span class="keyword">const</span> <span class="keywordtype">double</span> itheta=thetas[icomp];
<a name="l01089"></a>01089             <span class="comment">//non linear mapping.</span>
<a name="l01090"></a>01090             <span class="keyword">const</span> <span class="keywordtype">double</span> ih=hs*rsa/(rsa-itheta*hs);
<a name="l01091"></a>01091             <span class="comment">//interpolating to get Na profile strenght.</span>
<a name="l01092"></a>01092             <span class="comment">//this is bilinear interpolation. not good. </span>
<a name="l01093"></a>01093             <span class="comment">//need to do averaging</span>
<a name="l01094"></a>01094             <span class="keyword">const</span> <span class="keywordtype">double</span> iih=(ih-hpmin)*dhp1;
<a name="l01095"></a>01095             <span class="keyword">const</span> <span class="keywordtype">int</span> iihf=ifloor(iih);
<a name="l01096"></a>01096             <span class="keyword">const</span> <span class="keywordtype">double</span> iihw=iih-iihf;
<a name="l01097"></a>01097             <span class="keywordflow">if</span>(iihf&lt;0 || iihf&gt;nhp-2){
<a name="l01098"></a>01098             etf-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[icomp]=0.;
<a name="l01099"></a>01099             }<span class="keywordflow">else</span>{
<a name="l01100"></a>01100             <span class="keywordtype">double</span> tmp=pp[iihf]*(1.-iihw)+pp[iihf+1]*iihw;
<a name="l01101"></a>01101             <span class="comment">//neglected rsa1 due to renormalization.</span>
<a name="l01102"></a>01102             etf-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[icomp]=tmp;
<a name="l01103"></a>01103             etf2sum+=tmp;
<a name="l01104"></a>01104             }
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106         <span class="keywordflow">if</span>(fabs(etf2sum)&gt;1.e-20){
<a name="l01107"></a>01107             <span class="comment">/*normalize the etf before fft so that</span>
<a name="l01108"></a>01108 <span class="comment">              after fft it max to 1. The strength of</span>
<a name="l01109"></a>01109 <span class="comment">              original profile doesn't matter.*/</span>
<a name="l01110"></a>01110             <a class="code" href="cmat_8h.html#204751357459432e00c5f5ee8d261f56" title="scale each element of A by w">cscale</a>(etf,1./etf2sum);
<a name="l01111"></a>01111             <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(etf);<span class="comment">//put peak in corner;</span>
<a name="l01112"></a>01112             <a class="code" href="fft_8c.html#5e22d51b30da1c5c057cb5b8f121273d" title="Do 2d FFT transforms.">cfft2</a>(etf, -1);
<a name="l01113"></a>01113             <span class="keywordflow">if</span>(use1d){
<a name="l01114"></a>01114             <span class="keywordflow">if</span>(npad==1 &amp;&amp; nover==1){
<a name="l01115"></a>01115                 <a class="code" href="cmat_8h.html#db3c55ee96a9e7249403f738d251688c" title="copy the values from one X(mat) to another.">ccp</a>(&amp;petf[illt][isa],etf);
<a name="l01116"></a>01116             }<span class="keywordflow">else</span>{
<a name="l01117"></a>01117                 <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(etf);
<a name="l01118"></a>01118                 petf[illt][isa]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompx,1);
<a name="l01119"></a>01119                 dcomplex *etf1d=petf[illt][isa]-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>;
<a name="l01120"></a>01120                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> icompx=0; icompx&lt;ncompx; icompx++){
<a name="l01121"></a>01121                 <span class="keywordtype">double</span> ir=dusc*(icompx-ncompx2)+netf2;
<a name="l01122"></a>01122                 <span class="keywordtype">int</span> iir=ifloor(ir);
<a name="l01123"></a>01123                 ir=ir-iir;
<a name="l01124"></a>01124                 <span class="keywordflow">if</span>(iir&gt;=0 &amp;&amp; iir&lt;netf-1){
<a name="l01125"></a>01125                     etf1d[icompx]=etf-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[iir]*(1.-ir)
<a name="l01126"></a>01126                     +etf-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[iir+1]*ir;
<a name="l01127"></a>01127                 }<span class="comment">/*else{etf1d[icompx]=0;}*/</span>
<a name="l01128"></a>01128                 }
<a name="l01129"></a>01129                 <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(petf[illt][isa]);
<a name="l01130"></a>01130             }
<a name="l01131"></a>01131             }<span class="keywordflow">else</span>{
<a name="l01132"></a>01132             <span class="comment">//Rotate the ETF.</span>
<a name="l01133"></a>01133             <span class="comment">//need to put peak in center.</span>
<a name="l01134"></a>01134             <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(etf);
<a name="l01135"></a>01135             <span class="keywordtype">double</span> theta=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#fd0302013032e547054f9431d7aee502">srot</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[illt]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[isa];
<a name="l01136"></a>01136             <span class="keywordtype">double</span> ct=cos(theta);
<a name="l01137"></a>01137             <span class="keywordtype">double</span> st=sin(theta);
<a name="l01138"></a>01138             petf[illt][isa]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompx,ncompy);
<a name="l01139"></a>01139             dcomplex (*etf2d)[ncompx]=(<span class="keywordtype">void</span>*)petf[illt][isa]-&gt;p;
<a name="l01140"></a>01140             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> icompy=0; icompy&lt;ncompy; icompy++){
<a name="l01141"></a>01141                 <span class="keywordtype">double</span> iy=(icompy-ncompy2);
<a name="l01142"></a>01142                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> icompx=0; icompx&lt;ncompx; icompx++){
<a name="l01143"></a>01143                 <span class="keywordtype">double</span> ix=(icompx-ncompx2);
<a name="l01144"></a>01144                 <span class="keywordtype">double</span> ir=(dusc*(ct*ix+st*iy))+netf2;<span class="comment">//index in etf</span>
<a name="l01145"></a>01145                 <span class="keywordtype">int</span> iir=ifloor(ir);
<a name="l01146"></a>01146                 ir=ir-iir;
<a name="l01147"></a>01147                 <span class="keywordflow">if</span>(iir&gt;=0 &amp;&amp; iir&lt;netf-1){
<a name="l01148"></a>01148                     <span class="comment">//bilinear interpolation.</span>
<a name="l01149"></a>01149                     etf2d[icompy][icompx]=etf-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[iir]*(1.-ir)
<a name="l01150"></a>01150                     +etf-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[iir+1]*ir;
<a name="l01151"></a>01151                 }<span class="comment">/*else{etf2d[icompy][icompx]=0;}*/</span>
<a name="l01152"></a>01152                 }
<a name="l01153"></a>01153             }
<a name="l01154"></a>01154             <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(petf[illt][isa]);<span class="comment">//peak in corner;</span>
<a name="l01155"></a>01155             }
<a name="l01156"></a>01156         }<span class="keywordflow">else</span>{
<a name="l01157"></a>01157             warning(<span class="stringliteral">"Wrong focus!\n"</span>);
<a name="l01158"></a>01158             <span class="keywordflow">if</span>(use1d){
<a name="l01159"></a>01159             petf[illt][isa]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompx,1);
<a name="l01160"></a>01160             }<span class="keywordflow">else</span>{
<a name="l01161"></a>01161             petf[illt][isa]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncompx,ncompy);
<a name="l01162"></a>01162             }
<a name="l01163"></a>01163             <a class="code" href="cmat_8h.html#aa3be1e7b9926d4753d27b833b4735aa" title="set values of each element in a X(mat) to val.">cset</a>(petf[illt][isa],1);
<a name="l01164"></a>01164         }
<a name="l01165"></a>01165         <span class="keywordflow">if</span>(fuse_etf){
<a name="l01166"></a>01166             <span class="comment">//Fuse dtf into this 2d etf.</span>
<a name="l01167"></a>01167             <a class="code" href="cmat_8h.html#2417a6c93f1245cf129586dce262aba3" title="Compute component wise multiply B=B.">ccwm</a>(petf[illt][isa], pnominal[illt][isa*mnominal]);
<a name="l01168"></a>01168         }
<a name="l01169"></a>01169         }
<a name="l01170"></a>01170     }
<a name="l01171"></a>01171     <span class="keywordflow">if</span>(fuse_etf){
<a name="l01172"></a>01172         powfs[ipowfs].<a class="code" href="structPOWFS__T.html#e9fc7510d040ab4d3b80fdd1b4194f9e">dtf</a>[iwvl].<a class="code" href="structDTF__T.html#d32f72ad19d1f4f2fb6fd34f8d074323" title="Whether the DTF has been fused to ETF.">fused</a>=1;
<a name="l01173"></a>01173         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#5248186f49c163e6b557564e17125807" title="starting column to use in fn for ETF in preparation of matched filter">colprep</a>==parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#b98cc62458a0880ce23196c961b11008" title="starting column to use in fn for ETF in simulation">colsim</a>
<a name="l01174"></a>01174            &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#c8b3e202f9c4be878eb3a9a599c1de4f" title="change to next sodium profile during simulation every colsimdtrat time step">colsimdtrat</a>==0){
<a name="l01175"></a>01175         ccellfree(powfs[ipowfs].dtf[iwvl].nominal);
<a name="l01176"></a>01176         info(<span class="stringliteral">"powfs %d: DTF nominal is fused to ETF and freed\n"</span>, ipowfs);
<a name="l01177"></a>01177         }<span class="keywordflow">else</span>{
<a name="l01178"></a>01178         info(<span class="stringliteral">"powfs %d: DTF nominal is fused to ETF but kept\n"</span>, ipowfs);
<a name="l01179"></a>01179         }
<a name="l01180"></a>01180     }       
<a name="l01181"></a>01181     
<a name="l01182"></a>01182     cfree(etf);
<a name="l01183"></a>01183     free(thetas);
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a8ee626a374ebefb84c2d560793c4c1e"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_llt" ref="a8ee626a374ebefb84c2d560793c4c1e" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_llt           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
setting up uplink pts/amp lotf 
<p>
<div class="fragment"><pre class="fragment"><a name="l01191"></a>01191                                                                  {
<a name="l01192"></a>01192 
<a name="l01193"></a>01193     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>) <span class="keywordflow">return</span>;
<a name="l01194"></a>01194     <span class="keyword">const</span> <span class="keywordtype">double</span> dxsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>;
<a name="l01195"></a>01195     <span class="keyword">const</span> <span class="keywordtype">int</span> nwvl=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;
<a name="l01196"></a>01196     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structLOTF__T.html" title="contains the data associated with a LLT uplink path.">LOTF_T</a>));
<a name="l01197"></a>01197     <a class="code" href="structPTS__T.html" title="low left point of each subaperture.">PTS_T</a> *lpts=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#7d83094d1be8eca22ba36cbca2c6cf0f" title="The LLT lower left grid point location.">pts</a>=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structPTS__T.html" title="low left point of each subaperture.">PTS_T</a>));
<a name="l01198"></a>01198     lpts-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>=1;
<a name="l01199"></a>01199     <span class="keyword">const</span> <span class="keywordtype">double</span> dx = powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>;
<a name="l01200"></a>01200     <span class="keywordtype">double</span> lltd=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#45577fb34c3fb5753225c7417276d0eb" title="LLT clear aperture diameter.">d</a>;
<a name="l01201"></a>01201     <span class="keyword">const</span> <span class="keywordtype">int</span> nx = powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>;
<a name="l01202"></a>01202     <span class="keywordflow">if</span>(lltd&gt;dxsa){
<a name="l01203"></a>01203     warning(<span class="stringliteral">"The LLT has a diameter greater than subaperture diameter. Will be cropped\n"</span>);
<a name="l01204"></a>01204     }
<a name="l01205"></a>01205     <span class="comment">//llt is no larger than subaperture.</span>
<a name="l01206"></a>01206     lpts-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>=dx;
<a name="l01207"></a>01207     lpts-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>=dxsa;
<a name="l01208"></a>01208     lpts-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>=nx;
<a name="l01209"></a>01209     
<a name="l01210"></a>01210     lpts-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a>=calloc(1, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01211"></a>01211     lpts-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a>=calloc(1, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01212"></a>01212     lpts-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>=calloc(1, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     <span class="keywordtype">double</span> oy=lpts-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a>[0]=-dxsa/2+dx/2;
<a name="l01215"></a>01215     <span class="keywordtype">double</span> ox=lpts-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a>[0]=-dxsa/2+dx/2;
<a name="l01216"></a>01216     lpts-&gt;<a class="code" href="structPTS__T.html#7d3fcee525cfce7d121c5b79e0592a79" title="subaperture area, sum(amp^2)">area</a>[0]=1;
<a name="l01217"></a>01217     <span class="comment">//fixme: when LLT is larger than dsa, need to change this.</span>
<a name="l01218"></a>01218     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#87490e75239e15d544b5e8a61ee084ae" title="The amplitude defined on loc.">amp</a> 
<a name="l01219"></a>01219     =calloc(nx*nx,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01220"></a>01220     double (*amps)[nx]
<a name="l01221"></a>01221     =(double(*)[nx])powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>;
<a name="l01222"></a>01222     <span class="keywordtype">double</span> l2max
<a name="l01223"></a>01223     =pow(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#45577fb34c3fb5753225c7417276d0eb" title="LLT clear aperture diameter.">d</a>*0.5,2);
<a name="l01224"></a>01224     <span class="keywordtype">double</span> r2eff=l2max
<a name="l01225"></a>01225     *pow(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#44ba41f20ea071d782ff70c5fbdc5aaa" title="Gaussian beam width percentage of d.">widthp</a>,2);
<a name="l01226"></a>01226     <span class="keywordtype">double</span> sumamp2=0;
<a name="l01227"></a>01227     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;nx; iy++){
<a name="l01228"></a>01228     <span class="keywordtype">double</span> yy=iy*dx+oy;
<a name="l01229"></a>01229     yy*=yy;
<a name="l01230"></a>01230     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;nx; ix++){
<a name="l01231"></a>01231         <span class="keywordtype">double</span> xx=ix*dx+ox;
<a name="l01232"></a>01232         xx*=xx;
<a name="l01233"></a>01233         <span class="keywordtype">double</span> r2=xx+yy;
<a name="l01234"></a>01234         <span class="keywordflow">if</span>(r2&lt;=l2max){
<a name="l01235"></a>01235         amps[iy][ix]=exp(-r2/r2eff);
<a name="l01236"></a>01236         sumamp2+=pow(amps[iy][ix],2);
<a name="l01237"></a>01237         }
<a name="l01238"></a>01238     }
<a name="l01239"></a>01239     }
<a name="l01240"></a>01240     <span class="comment">//normalized</span>
<a name="l01241"></a>01241     <span class="comment">//so that max(otf)=1;</span>
<a name="l01242"></a>01242     sumamp2=1./(sqrt(sumamp2));
<a name="l01243"></a>01243     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nx*nx; i++){
<a name="l01244"></a>01244     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#87490e75239e15d544b5e8a61ee084ae" title="The amplitude defined on loc.">amp</a>[i]*=sumamp2;
<a name="l01245"></a>01245     }
<a name="l01246"></a>01246     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#88e54a1faa17d163258aac521a46b393" title="The grid that defines the LLT pupil.">loc</a>=<a class="code" href="loc_8c.html#9b68fa77107ecb06a9407fe1ad31eb24" title="Create a loc array contains coorindates in a square map of size nx*ny, with sampling...">mksqloc</a>(nx,nx,dx,
<a name="l01247"></a>01247                     lpts-&gt;<a class="code" href="structPTS__T.html#6b242c69a4cfd72887cf17f52750a7da" title="The x origin of each subaperture.">origx</a>[0],
<a name="l01248"></a>01248                     lpts-&gt;<a class="code" href="structPTS__T.html#91b264432cf6519dd5c1694359589d6f" title="The y origin of each subaperture.">origy</a>[0]);
<a name="l01249"></a>01249     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#32a270c01990439057b1531261af0466" title="modal cross coupling matrix">mcc</a>
<a name="l01250"></a>01250     =<a class="code" href="loc_8c.html#02791a06a46428dcc5797051dbb8cf88" title="same as loc_mcc_ptt, except using pts instead of loc.">pts_mcc_ptt</a>(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>,
<a name="l01251"></a>01251              powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#87490e75239e15d544b5e8a61ee084ae" title="The amplitude defined on loc.">amp</a>);
<a name="l01252"></a>01252     powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#c215fc03005670b81049646eec9cfcf6" title="inverse of imcc">imcc</a>
<a name="l01253"></a>01253     =dcellinvspd_each(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#706fa25774d7c7dbfc0ab1c3925196b8">mcc</a>);
<a name="l01254"></a>01254 
<a name="l01255"></a>01255     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l01256"></a>01256     <a class="code" href="bin_8c.html#07e8fcd0256fd8377d0bb0d86bfd3c53" title="Write a double array of size nx*ny to file.">writedbl</a>(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>,powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>,
<a name="l01257"></a>01257          powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>, <span class="stringliteral">"%s/powfs%d_lotfamp.bin.gz"</span>, dirsetup,ipowfs);
<a name="l01258"></a>01258     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].srot, <span class="stringliteral">"%s/powfs%d_srot"</span>,dirsetup,ipowfs);
<a name="l01259"></a>01259     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].srsa, <span class="stringliteral">"%s/powfs%d_srsa"</span>,dirsetup,ipowfs);
<a name="l01260"></a>01260     <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#8c1a97256a90efbb53166fc1ab5c16a9">imcc</a>, <span class="stringliteral">"%s/powfs%d_lotf_imcc"</span>,dirsetup,ipowfs);
<a name="l01261"></a>01261     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l01262"></a>01262         <span class="keywordflow">if</span>(powfs[ipowfs].etfprep[iwvl].p1){
<a name="l01263"></a>01263         <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(powfs[ipowfs].etfprep[iwvl].p1, 
<a name="l01264"></a>01264                <span class="stringliteral">"%s/powfs%d_etfprep%d_1d.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l01265"></a>01265         }
<a name="l01266"></a>01266         <span class="keywordflow">if</span>(powfs[ipowfs].etfprep[iwvl].p2){
<a name="l01267"></a>01267         <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(powfs[ipowfs].etfprep[iwvl].p2,
<a name="l01268"></a>01268                <span class="stringliteral">"%s/powfs%d_etfprep%d_2d.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l01269"></a>01269         }
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271     <span class="keywordflow">if</span>(powfs[ipowfs].etfsim != powfs[ipowfs].etfsim){
<a name="l01272"></a>01272         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l01273"></a>01273         <span class="keywordflow">if</span>(powfs[ipowfs].etfsim[iwvl].p1){
<a name="l01274"></a>01274             <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(powfs[ipowfs].etfsim[iwvl].p1, 
<a name="l01275"></a>01275                    <span class="stringliteral">"%s/powfs%d_etfsim%d_1d.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l01276"></a>01276         }
<a name="l01277"></a>01277         <span class="keywordflow">if</span>(powfs[ipowfs].etfsim[iwvl].p2){
<a name="l01278"></a>01278             <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(powfs[ipowfs].etfsim[iwvl].p2,
<a name="l01279"></a>01279                    <span class="stringliteral">"%s/powfs%d_etfsim%d_2d.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l01280"></a>01280         }
<a name="l01281"></a>01281         }
<a name="l01282"></a>01282     }
<a name="l01283"></a>01283     }
<a name="l01284"></a>01284 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a16bf88378b48f5765294689df77c22f"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_mtch" ref="a16bf88378b48f5765294689df77c22f" args="(POWFS_T *powfs, const PARMS_T *parms, int ipowfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_mtch           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ipowfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup the matched filter pixel processing parameters for physical optics wfs. 
<p>
<div class="fragment"><pre class="fragment"><a name="l01290"></a>01290                     {
<a name="l01291"></a>01291     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#45900019b0a0d7d362460592c2c34775" title="physical optics type.">phytype</a>!=1){<span class="comment">//not matched filter</span>
<a name="l01292"></a>01292     error(<span class="stringliteral">"This is only intended for matched filter\n"</span>);
<a name="l01293"></a>01293     }
<a name="l01294"></a>01294     <span class="keywordtype">long</span> nsa=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#0ee420c53f81102c0120b6a1014d4673" title="number of subapertures.">nsa</a>;
<a name="l01295"></a>01295     <span class="keywordflow">if</span>(powfs[ipowfs].intstat){
<a name="l01296"></a>01296     dcellfree(powfs[ipowfs].intstat-&gt;mtche);
<a name="l01297"></a>01297     dcellfree(powfs[ipowfs].intstat-&gt;sanea);
<a name="l01298"></a>01298     dcellfree(powfs[ipowfs].intstat-&gt;saneaixy);
<a name="l01299"></a>01299     dfree(powfs[ipowfs].intstat-&gt;i0sum);
<a name="l01300"></a>01300     free(powfs[ipowfs].intstat);
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     <a class="code" href="structINTSTAT__T.html" title="contains the intensity statistics assiciated with a certain powfs">INTSTAT_T</a> *intstat=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#3c0808eeb946b29d473da332466e827d">intstat</a>=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structINTSTAT__T.html" title="contains the intensity statistics assiciated with a certain powfs">INTSTAT_T</a>));
<a name="l01303"></a>01303     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#81b69d85af4c28961cc299c618dd4124" title="Specify what matrices to load for debugging.">load</a>.<a class="code" href="structLOAD__CFG__T.html#2c1b0048501283f30e0b07e06de55f4b" title="if 1, load i0 for powfs">i0</a>){
<a name="l01304"></a>01304     warning(<span class="stringliteral">"Loading i0, gx, gy\n"</span>);
<a name="l01305"></a>01305     intstat-&gt;<a class="code" href="structINTSTAT__T.html#17e9e1cb4c6fa2c3d568309f19536c6b">i0</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"powfs%d_i0.bin.gz"</span>,ipowfs);
<a name="l01306"></a>01306     intstat-&gt;<a class="code" href="structINTSTAT__T.html#800c51d63ee0be89023dd40d94ab0212">gx</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"powfs%d_gx.bin.gz"</span>,ipowfs);
<a name="l01307"></a>01307     intstat-&gt;<a class="code" href="structINTSTAT__T.html#0cee55e1121df68253f8e51abcae8899">gy</a>=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"powfs%d_gy.bin.gz"</span>,ipowfs);
<a name="l01308"></a>01308     }<span class="keywordflow">else</span>{
<a name="l01309"></a>01309     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#438b4b01c97554294090afe1c6bab3f2" title="input averaged pixel intensities for matched filter.">piinfile</a>){
<a name="l01310"></a>01310         <span class="comment">//load psf. 1 for each wavefront sensor.</span>
<a name="l01311"></a>01311         info2(<span class="stringliteral">"Using 1 sepsf for each wfs when loading sepsf\n"</span>);
<a name="l01312"></a>01312         intstat-&gt;<a class="code" href="structINTSTAT__T.html#4c4e98be2b8a57d4feb99abb892574b0">nsepsf</a>=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>;
<a name="l01313"></a>01313         intstat-&gt;<a class="code" href="structINTSTAT__T.html#9cdbda1504aa0508c1a5821801268569">sepsf</a>=calloc(intstat-&gt;<a class="code" href="structINTSTAT__T.html#4c4e98be2b8a57d4feb99abb892574b0">nsepsf</a>, <span class="keyword">sizeof</span>(<a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a>*));
<a name="l01314"></a>01314         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jwfs=0; jwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>; jwfs++){
<a name="l01315"></a>01315         <span class="keywordtype">int</span> iwfs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#be03195a4e1fece4903a6297931ac09c" title="array of wfs belongs to this powfs">wfs</a>[jwfs];
<a name="l01316"></a>01316         intstat-&gt;<a class="code" href="structINTSTAT__T.html#9cdbda1504aa0508c1a5821801268569">sepsf</a>[jwfs]=<a class="code" href="dmat_8h.html#dfec4b5637fce6a1cdb10b84d744c8fe" title="User callable function to read cell array of dense matrix into memory from file.">dcellread</a>(<span class="stringliteral">"%s_wfs%d"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#438b4b01c97554294090afe1c6bab3f2" title="input averaged pixel intensities for matched filter.">piinfile</a>,iwfs);
<a name="l01317"></a>01317         <span class="keywordtype">double</span> pmax=<a class="code" href="dmat_8h.html#abb4fecd296ac9ec19263e0f9d853be7" title="find the maximum value of a X(mat) object">dmax</a>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#9cdbda1504aa0508c1a5821801268569">sepsf</a>[jwfs]-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]);
<a name="l01318"></a>01318         <span class="keywordflow">if</span>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#9cdbda1504aa0508c1a5821801268569">sepsf</a>[jwfs]-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]&gt;pmax/2){
<a name="l01319"></a>01319             error(<span class="stringliteral">"wfs %d:  psf must have peak at center, not corner.\n"</span>, iwfs);
<a name="l01320"></a>01320         }
<a name="l01321"></a>01321         <span class="keywordflow">if</span>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#9cdbda1504aa0508c1a5821801268569">sepsf</a>[jwfs]-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>!=nsa){
<a name="l01322"></a>01322             error(<span class="stringliteral">"piinfile doesn't match\n"</span>);
<a name="l01323"></a>01323         }
<a name="l01324"></a>01324         }
<a name="l01325"></a>01325     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l01326"></a>01326         error(<span class="stringliteral">"Please specify piinfile for lo order phy wfs\n"</span>);
<a name="l01327"></a>01327     }<span class="keywordflow">else</span>{
<a name="l01328"></a>01328         <span class="comment">//LGS</span>
<a name="l01329"></a>01329             <span class="keywordtype">int</span> npsfx=powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#b91d3c743b83de5ad8bda5920e3ee0e4" title="number of col and row of points per subaperture">nx</a>
<a name="l01330"></a>01330         *parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>;
<a name="l01331"></a>01331         <span class="keywordtype">int</span> npsfy=npsfx;
<a name="l01332"></a>01332         <span class="keywordtype">char</span> *fnprefix;
<a name="l01333"></a>01333         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#839e906a586c2d9152df418d24b46151">fnamp</a>){
<a name="l01334"></a>01334         <span class="keywordtype">char</span> *tmp=mybasename(parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#839e906a586c2d9152df418d24b46151">fnamp</a>);
<a name="l01335"></a>01335         uint32_t key=<a class="code" href="hashlittle_8c.html#8fcafa39241f09d13a63a0f9756772cc" title="hash the data and return an hash number.">hashlittle</a>(powfs[ipowfs].amp,
<a name="l01336"></a>01336                     powfs[ipowfs].loc-&gt;nloc*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>),0);
<a name="l01337"></a>01337     
<a name="l01338"></a>01338         <span class="keywordtype">char</span> tmp2[80];
<a name="l01339"></a>01339         snprintf(tmp2,80,<span class="stringliteral">"_%ud"</span>,key);
<a name="l01340"></a>01340         fnprefix=stradd(tmp,tmp2,NULL);
<a name="l01341"></a>01341         free(tmp);
<a name="l01342"></a>01342         }<span class="keywordflow">else</span>{
<a name="l01343"></a>01343         fnprefix=strdup(<span class="stringliteral">"noamp"</span>);
<a name="l01344"></a>01344         }
<a name="l01345"></a>01345         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#fcc8c1a482355c14b07ecf887212afc5" title="misregistration from DM to WFS, described by file containing a cell array A of 2xp...">ncpa</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beee70263e01f8571a2c5884760e6051" title="Method to correct ncpa.">ncpa_method</a>==2){
<a name="l01346"></a>01346         <span class="keywordtype">char</span> *tmp=fnprefix;
<a name="l01347"></a>01347         uint32_t key=0;
<a name="l01348"></a>01348         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>; iwfs++){
<a name="l01349"></a>01349             key=<a class="code" href="hashlittle_8c.html#8fcafa39241f09d13a63a0f9756772cc" title="hash the data and return an hash number.">hashlittle</a>(powfs[ipowfs].ncpa-&gt;p[iwfs]-&gt;p,
<a name="l01350"></a>01350                    powfs[ipowfs].<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>),key);
<a name="l01351"></a>01351         }
<a name="l01352"></a>01352         <span class="keywordtype">char</span> tmp2[80];
<a name="l01353"></a>01353         snprintf(tmp2,80,<span class="stringliteral">"_%ud"</span>,key);
<a name="l01354"></a>01354         fnprefix=stradd(tmp,tmp2,NULL);
<a name="l01355"></a>01355         free(tmp);
<a name="l01356"></a>01356         }
<a name="l01357"></a>01357         
<a name="l01358"></a>01358         <span class="keywordtype">char</span> fnotf[PATH_MAX];
<a name="l01359"></a>01359         snprintf(fnotf,PATH_MAX,<span class="stringliteral">"%s/.aos/otfc/"</span>,getenv(<span class="stringliteral">"HOME"</span>));
<a name="l01360"></a>01360         <span class="keywordflow">if</span>(!exist(fnotf)) 
<a name="l01361"></a>01361         mymkdir(<span class="stringliteral">"%s"</span>,fnotf);
<a name="l01362"></a>01362         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#fcc8c1a482355c14b07ecf887212afc5" title="misregistration from DM to WFS, described by file containing a cell array A of 2xp...">ncpa</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#beee70263e01f8571a2c5884760e6051" title="Method to correct ncpa.">ncpa_method</a>==2){
<a name="l01363"></a>01363         intstat-&gt;<a class="code" href="structINTSTAT__T.html#c36294be21c9b94bd24d5eeea089f996">notf</a>=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>;
<a name="l01364"></a>01364         }<span class="keywordflow">else</span>{
<a name="l01365"></a>01365         intstat-&gt;<a class="code" href="structINTSTAT__T.html#c36294be21c9b94bd24d5eeea089f996">notf</a>=1;
<a name="l01366"></a>01366         }
<a name="l01367"></a>01367         intstat-&gt;<a class="code" href="structINTSTAT__T.html#b5ffa44764b98913ef1f26ab075f493d" title="short exposure OTF.">otf</a>=calloc(intstat-&gt;<a class="code" href="structINTSTAT__T.html#c36294be21c9b94bd24d5eeea089f996">notf</a>, <span class="keyword">sizeof</span>(<a class="code" href="structccell.html" title="an 2-d block matrix of cmat.">ccell</a>*));
<a name="l01368"></a>01368         <span class="keywordtype">int</span> calc_otf=0;
<a name="l01369"></a>01369         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iotf=0; iotf&lt;intstat-&gt;<a class="code" href="structINTSTAT__T.html#c36294be21c9b94bd24d5eeea089f996">notf</a>; iotf++){
<a name="l01370"></a>01370         snprintf(fnotf,PATH_MAX,<span class="stringliteral">"%s/.aos/otfc/%s_D%g_%g_"</span>
<a name="l01371"></a>01371              <span class="stringliteral">"r0_%g_L0%g_dsa%g_nsa%ld_dx1_%g_"</span>
<a name="l01372"></a>01372              <span class="stringliteral">"nwvl%d_%g_embfac%d_%dx%d_SEOTF_%d.bin.gz"</span>,
<a name="l01373"></a>01373              getenv(<span class="stringliteral">"HOME"</span>), fnprefix,
<a name="l01374"></a>01374              parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#5f2d4b89322d5de7b49f7f274807ff93" title="Telescope inner blocking diameter.">din</a>, 
<a name="l01375"></a>01375              parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#ea9e24d04a414ec33916763092f6a486" title="derived from r0z for zenith angle za">r0</a>, parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#d6a52fa85cd299be46eef6c58bc426b0" title="outer scale">l0</a>, 
<a name="l01376"></a>01376              powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>,nsa,
<a name="l01377"></a>01377              1./powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>, 
<a name="l01378"></a>01378              parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>,
<a name="l01379"></a>01379              parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[0]*1.e6,
<a name="l01380"></a>01380              parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>,npsfx,npsfy, iotf);
<a name="l01381"></a>01381         <span class="keywordflow">if</span>(exist(fnotf)){
<a name="l01382"></a>01382             info2(<span class="stringliteral">"Loading otf from %s\n"</span>,fnotf);
<a name="l01383"></a>01383             intstat-&gt;<a class="code" href="structINTSTAT__T.html#b5ffa44764b98913ef1f26ab075f493d" title="short exposure OTF.">otf</a>[iotf]=<a class="code" href="cmat_8h.html#0a22a48812769ec4f65d0cc94b727059" title="User callable function to read cell array of dense matrix into memory from file.">ccellread</a>(<span class="stringliteral">"%s"</span>,fnotf);
<a name="l01384"></a>01384             touch(fnotf);
<a name="l01385"></a>01385         }<span class="keywordflow">else</span>{
<a name="l01386"></a>01386             calc_otf=1;
<a name="l01387"></a>01387             <span class="keywordflow">break</span>;
<a name="l01388"></a>01388         }
<a name="l01389"></a>01389         }
<a name="l01390"></a>01390         <span class="keywordflow">if</span>(calc_otf){
<a name="l01391"></a>01391         info2(<span class="stringliteral">"Not found:%s\nGenerating seotf..."</span>,fnotf);tic;
<a name="l01392"></a>01392         <a class="code" href="genseotf_8c.html#8af32636d2faf44199899565c2f16a72" title="Master routine that generates short exposure OTF by calling genotf() in the library...">genseotf</a>(parms,powfs,ipowfs);
<a name="l01393"></a>01393         toc2(<span class="stringliteral">"done"</span>);
<a name="l01394"></a>01394         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iotf=0; iotf&lt;intstat-&gt;<a class="code" href="structINTSTAT__T.html#c36294be21c9b94bd24d5eeea089f996">notf</a>; iotf++){
<a name="l01395"></a>01395             snprintf(fnotf,PATH_MAX,<span class="stringliteral">"%s/.aos/otfc/%s_D%g_%g_"</span>
<a name="l01396"></a>01396                  <span class="stringliteral">"r0_%g_L0%g_dsa%g_nsa%ld_dx1_%g_"</span>
<a name="l01397"></a>01397                  <span class="stringliteral">"nwvl%d_%g_embfac%d_%dx%d_SEOTF_%d.bin.gz"</span>,
<a name="l01398"></a>01398                  getenv(<span class="stringliteral">"HOME"</span>), fnprefix,
<a name="l01399"></a>01399                  parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#5f2d4b89322d5de7b49f7f274807ff93" title="Telescope inner blocking diameter.">din</a>, 
<a name="l01400"></a>01400                  parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#ea9e24d04a414ec33916763092f6a486" title="derived from r0z for zenith angle za">r0</a>, parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#d6a52fa85cd299be46eef6c58bc426b0" title="outer scale">l0</a>, 
<a name="l01401"></a>01401                  powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>,nsa,
<a name="l01402"></a>01402                  1./powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>, 
<a name="l01403"></a>01403                  parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>,
<a name="l01404"></a>01404                  parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[0]*1.e6,
<a name="l01405"></a>01405                  parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>,npsfx,npsfy, iotf);
<a name="l01406"></a>01406             info(<span class="stringliteral">"saving otf to %s\n"</span>, fnotf);
<a name="l01407"></a>01407             <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#b5ffa44764b98913ef1f26ab075f493d" title="short exposure OTF.">otf</a>[iotf], <span class="stringliteral">"%s"</span>,fnotf);
<a name="l01408"></a>01408         }
<a name="l01409"></a>01409         }
<a name="l01410"></a>01410      
<a name="l01411"></a>01411         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>){
<a name="l01412"></a>01412         <span class="keywordtype">char</span> fnlotf[PATH_MAX];
<a name="l01413"></a>01413         snprintf(fnlotf,PATH_MAX,<span class="stringliteral">"%s/.aos/otfc/%s_D%g_%g_"</span>
<a name="l01414"></a>01414              <span class="stringliteral">"r0_%g_L0%g_dsa%g_lltd%g_dx1_%g_"</span>
<a name="l01415"></a>01415              <span class="stringliteral">"nwvl%d_%g_embfac%d_%dx%d_SELOTF.bin.gz"</span>, 
<a name="l01416"></a>01416              getenv(<span class="stringliteral">"HOME"</span>), fnprefix,
<a name="l01417"></a>01417              parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>,parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#5f2d4b89322d5de7b49f7f274807ff93" title="Telescope inner blocking diameter.">din</a>, 
<a name="l01418"></a>01418              parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#ea9e24d04a414ec33916763092f6a486" title="derived from r0z for zenith angle za">r0</a>, parms-&gt;<a class="code" href="structPARMS__T.html#cd5a6a6293cfd185c782e7d8b14365ec" title="atmospheric parameters">atm</a>.<a class="code" href="structATM__CFG__T.html#d6a52fa85cd299be46eef6c58bc426b0" title="outer scale">l0</a>, 
<a name="l01419"></a>01419              powfs[ipowfs].<a class="code" href="structPOWFS__T.html#34262914f5314a1e008aa158010dab9d">lotf</a>-&gt;<a class="code" href="structLOTF__T.html#7d83094d1be8eca22ba36cbca2c6cf0f" title="The LLT lower left grid point location.">pts</a>-&gt;<a class="code" href="structPTS__T.html#c719d677f4114b4654d40bb0f00ecc58" title="side length of subaperture">dsa</a>,
<a name="l01420"></a>01420              parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#13e13c12137584448baeae372526550e" title="configuration for LLT">llt</a>-&gt;<a class="code" href="structLLT__CFG__T.html#45577fb34c3fb5753225c7417276d0eb" title="LLT clear aperture diameter.">d</a>,
<a name="l01421"></a>01421              1./powfs[ipowfs].<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>-&gt;<a class="code" href="structPTS__T.html#bb59cf5f9d52f9eb787a71f78d23f5cf" title="sampling of points in each subaperture">dx</a>, 
<a name="l01422"></a>01422              parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>,
<a name="l01423"></a>01423              parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#086be0f3919fffb2809d891e895bab83" title="list of wavelength">wvl</a>[0]*1.e6,
<a name="l01424"></a>01424              parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d58b943a21a2fabebd9e9acdc83ff3d4" title="Embed subaperture atm OPD before fft.">embfac</a>,npsfx,npsfy);
<a name="l01425"></a>01425         <span class="keywordflow">if</span>(exist(fnlotf)){
<a name="l01426"></a>01426             intstat-&gt;<a class="code" href="structINTSTAT__T.html#631d102615175b2c467b2deb56c1a5f4" title="llt otf">lotf</a>=<a class="code" href="cmat_8h.html#0a22a48812769ec4f65d0cc94b727059" title="User callable function to read cell array of dense matrix into memory from file.">ccellread</a>(<span class="stringliteral">"%s"</span>,fnlotf);
<a name="l01427"></a>01427             touch (fnlotf);
<a name="l01428"></a>01428         }<span class="keywordflow">else</span>{
<a name="l01429"></a>01429             <a class="code" href="genseotf_8c.html#4ffba9d4d90f4b65147fc4a3440c78d8" title="Creating short exposure OTF caused by turbulence within LLT uplink aperture.">genselotf</a>(parms,powfs,ipowfs);
<a name="l01430"></a>01430             <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#631d102615175b2c467b2deb56c1a5f4" title="llt otf">lotf</a>, <span class="stringliteral">"%s"</span>,fnlotf);
<a name="l01431"></a>01431         }
<a name="l01432"></a>01432         }
<a name="l01433"></a>01433         free(fnprefix);
<a name="l01434"></a>01434         <span class="comment">//Generating short exposure images.</span>
<a name="l01435"></a>01435         <a class="code" href="genseotf_8c.html#cce63392ca96c45182348456539fa954" title="Createing subaperture short exposure PSF from the tip/tilt removed turbulence OTF...">gensepsf</a>(parms,powfs,ipowfs);
<a name="l01436"></a>01436         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a> &amp;&amp; intstat){
<a name="l01437"></a>01437         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#9cdbda1504aa0508c1a5821801268569">sepsf</a>[0],
<a name="l01438"></a>01438                <span class="stringliteral">"%s/powfs%d_sepsf"</span>,dirsetup,ipowfs);
<a name="l01439"></a>01439         }
<a name="l01440"></a>01440         <span class="comment">//Free short exposure otf.</span>
<a name="l01441"></a>01441         ccellfree(intstat-&gt;<a class="code" href="structINTSTAT__T.html#631d102615175b2c467b2deb56c1a5f4" title="llt otf">lotf</a>);
<a name="l01442"></a>01442         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iotf=0; iotf&lt;intstat-&gt;<a class="code" href="structINTSTAT__T.html#c36294be21c9b94bd24d5eeea089f996">notf</a>; iotf++){
<a name="l01443"></a>01443         ccellfree(intstat-&gt;<a class="code" href="structINTSTAT__T.html#b5ffa44764b98913ef1f26ab075f493d" title="short exposure OTF.">otf</a>[iotf]);
<a name="l01444"></a>01444         }
<a name="l01445"></a>01445         free(intstat-&gt;<a class="code" href="structINTSTAT__T.html#b5ffa44764b98913ef1f26ab075f493d" title="short exposure OTF.">otf</a>);
<a name="l01446"></a>01446     }
<a name="l01447"></a>01447     <span class="comment">//generate short exposure i0,gx,gy from psf.</span>
<a name="l01448"></a>01448     <a class="code" href="genseotf_8c.html#5b7605cad8168d3a00b8c10faefc9d69" title="generate subaperture short exposure average pixel intensities sampled on detector...">gensei</a>(parms,powfs,ipowfs);
<a name="l01449"></a>01449     dcellfreearr(intstat-&gt;<a class="code" href="structINTSTAT__T.html#9cdbda1504aa0508c1a5821801268569">sepsf</a>,intstat-&gt;<a class="code" href="structINTSTAT__T.html#4c4e98be2b8a57d4feb99abb892574b0">nsepsf</a>);
<a name="l01450"></a>01450     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a> &amp;&amp; intstat){
<a name="l01451"></a>01451         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#17e9e1cb4c6fa2c3d568309f19536c6b">i0</a>,<span class="stringliteral">"%s/powfs%d_i0"</span>,dirsetup,ipowfs);
<a name="l01452"></a>01452         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#800c51d63ee0be89023dd40d94ab0212">gx</a>,<span class="stringliteral">"%s/powfs%d_gx"</span>,dirsetup,ipowfs);
<a name="l01453"></a>01453         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(intstat-&gt;<a class="code" href="structINTSTAT__T.html#0cee55e1121df68253f8e51abcae8899">gy</a>,<span class="stringliteral">"%s/powfs%d_gy"</span>,dirsetup,ipowfs);
<a name="l01454"></a>01454     }
<a name="l01455"></a>01455     }
<a name="l01456"></a>01456     <span class="comment">//Generating Matched filter</span>
<a name="l01457"></a>01457     <a class="code" href="maos_2mtch_8c.html#23fcbf812ba1ea247e03dab86cd69df0" title="The routine used to generate matched filter from WFS mean short exposure pixel intensities...">genmtch</a>(parms,powfs,ipowfs);
<a name="l01458"></a>01458     dcellfree(intstat-&gt;<a class="code" href="structINTSTAT__T.html#17e9e1cb4c6fa2c3d568309f19536c6b">i0</a>);
<a name="l01459"></a>01459     dcellfree(intstat-&gt;<a class="code" href="structINTSTAT__T.html#800c51d63ee0be89023dd40d94ab0212">gx</a>);
<a name="l01460"></a>01460     dcellfree(intstat-&gt;<a class="code" href="structINTSTAT__T.html#0cee55e1121df68253f8e51abcae8899">gy</a>);
<a name="l01461"></a>01461     dcellfree(intstat-&gt;<a class="code" href="structINTSTAT__T.html#5283c52d0c42cde7190b481307cabf46">saneara</a>);
<a name="l01462"></a>01462     dcellfree(intstat-&gt;<a class="code" href="structINTSTAT__T.html#02032157ea0454eaee56b5f9d9ebed16">saneaxy</a>);
<a name="l01463"></a>01463     <span class="comment">//Remove OTFs that are older than 30 days.</span>
<a name="l01464"></a>01464     <span class="keywordtype">char</span> *dirotf=stradd(getenv(<span class="stringliteral">"HOME"</span>), <span class="stringliteral">"/.aos/otfc"</span>, NULL);
<a name="l01465"></a>01465     remove_file_older(dirotf, 30*24*3600);
<a name="l01466"></a>01466     free(dirotf);
<a name="l01467"></a>01467 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="c7b704504acb96d7fbcbdd60f15c6cf8"></a><!-- doxytag: member="setup_powfs.c::setup_powfs" ref="c7b704504acb96d7fbcbdd60f15c6cf8" args="(const PARMS_T *parms, APER_T *aper)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structPOWFS__T.html">POWFS_T</a>* setup_powfs           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structAPER__T.html">APER_T</a> *&nbsp;</td>
          <td class="paramname"> <em>aper</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup the powfs struct based on parms and aper. 
<p>
Everything about wfs are setup here. <div class="fragment"><pre class="fragment"><a name="l01471"></a>01471                                                          {
<a name="l01472"></a>01472     <a class="code" href="structPOWFS__T.html" title="contains the data associated with a certain type of WFS.">POWFS_T</a> *powfs=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>, <span class="keyword">sizeof</span>(<a class="code" href="structPOWFS__T.html" title="contains the data associated with a certain type of WFS.">POWFS_T</a>));
<a name="l01473"></a>01473     <span class="keywordtype">int</span> ipowfs;
<a name="l01474"></a>01474     tic;
<a name="l01475"></a>01475     <span class="keywordflow">for</span>(ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l01476"></a>01476     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#a27c8ce02a72294c46d8db61c68c4e61" title="number of wfs belonging to this powfs">nwfs</a>==0) <span class="keywordflow">continue</span>;
<a name="l01477"></a>01477     <a class="code" href="maos_2setup__powfs_8c.html#77b6fd986d6105964adf2c844ee9df87" title="setting up subaperture geometry.">setup_powfs_geom</a>(powfs,parms,aper,ipowfs);
<a name="l01478"></a>01478         <a class="code" href="maos_2setup__powfs_8c.html#e92ae33f8f650cb9c7975044bd82432f" title="Creating geometric wavefront gradient operator GS0 and ZA0 from WFS OPD to subaperture...">setup_powfs_grad</a>(powfs,parms,ipowfs);
<a name="l01479"></a>01479     <a class="code" href="maos_2setup__powfs_8c.html#2589e29c8b5c4bd05b33da3638e8ae53" title="Set up NCPA maps for each WFS.">setup_powfs_ncpa</a>(powfs,parms,ipowfs);
<a name="l01480"></a>01480     <span class="keywordflow">if</span>(TEST_POWFS||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a>
<a name="l01481"></a>01481        ||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d0e06b302154b9b7a4a81bfdfd35a3d8" title="output time history of low order wfs PSF.">psfout</a>
<a name="l01482"></a>01482        ||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27067cb8df3c4a8b2eb27e32a0e309fd" title="output time averaged short exposure image.">pistatout</a>
<a name="l01483"></a>01483        ||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d40a0a0fa416f92a27d2128a8653a578" title="use nea from physical optical precomputation in geometric simulations.">neaphy</a>){
<a name="l01484"></a>01484         <span class="comment">/*</span>
<a name="l01485"></a>01485 <span class="comment">        if(parms-&gt;powfs[ipowfs].pistatout </span>
<a name="l01486"></a>01486 <span class="comment">           &amp;&amp;parms-&gt;powfs[ipowfs].usephy){</span>
<a name="l01487"></a>01487 <span class="comment">        error("Must use geometric grad for pistatout\n");</span>
<a name="l01488"></a>01488 <span class="comment">        }</span>
<a name="l01489"></a>01489 <span class="comment">        */</span>
<a name="l01490"></a>01490         <span class="comment">//We have physical optics. setup necessary struct</span>
<a name="l01491"></a>01491         <a class="code" href="maos_2setup__powfs_8c.html#b1409e69dddf8131559ea35731109bda" title="Prepare the parameters for physical optics setup.">setup_powfs_prep_phy</a>(powfs,parms,ipowfs);
<a name="l01492"></a>01492         <a class="code" href="maos_2setup__powfs_8c.html#b1890fbc6facc2013338054962b1398a" title="Setting up Detector transfer function used to translate PSFs from FFTs to detector...">setup_powfs_dtf</a>(powfs,parms,ipowfs);
<a name="l01493"></a>01493         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>){
<a name="l01494"></a>01494         <span class="comment">//prepare Laser launch telescope.</span>
<a name="l01495"></a>01495         <a class="code" href="maos_2setup__powfs_8c.html#e2eab1b8ad97f659e38afe630140834e" title="Load and smooth out sodium profile.">setup_powfs_sodium</a>(powfs,parms,ipowfs);<span class="comment">//read sodium profile and smooth it</span>
<a name="l01496"></a>01496         <a class="code" href="maos_2setup__powfs_8c.html#bd59ad37c2a3372a70066e4b5cf34ac1" title="Compute Elongation Transfer function.">setup_powfs_etf</a>(powfs,parms,ipowfs,0,0);<span class="comment">//etf for prep</span>
<a name="l01497"></a>01497         <a class="code" href="maos_2setup__powfs_8c.html#bd59ad37c2a3372a70066e4b5cf34ac1" title="Compute Elongation Transfer function.">setup_powfs_etf</a>(powfs,parms,ipowfs,1,0);<span class="comment">//etf for sim</span>
<a name="l01498"></a>01498         <a class="code" href="maos_2setup__powfs_8c.html#a8ee626a374ebefb84c2d560793c4c1e" title="setting up uplink pts/amp lotf">setup_powfs_llt</a>(powfs,parms,ipowfs);
<a name="l01499"></a>01499         }
<a name="l01500"></a>01500     }
<a name="l01501"></a>01501     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>){
<a name="l01502"></a>01502         <span class="comment">//If there is LLT, setup the extra focus term if needed.</span>
<a name="l01503"></a>01503         <a class="code" href="maos_2setup__powfs_8c.html#7bbae2bc69e06f553d55c7c2d8c68ff3" title="setup the range to sodium layer as an additional parameter.">setup_powfs_focus</a>(powfs,parms,ipowfs);
<a name="l01504"></a>01504     }
<a name="l01505"></a>01505     <span class="keywordflow">if</span>(TEST_POWFS||parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3ed2651dd13ae9327644808da9ac6cb3" title="whether physical optics is used at all during simulation.">usephy</a> || parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#d40a0a0fa416f92a27d2128a8653a578" title="use nea from physical optical precomputation in geometric simulations.">neaphy</a>){
<a name="l01506"></a>01506         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#45900019b0a0d7d362460592c2c34775" title="physical optics type.">phytype</a>==1){<span class="comment">//matched filter</span>
<a name="l01507"></a>01507         <a class="code" href="maos_2setup__powfs_8c.html#a16bf88378b48f5765294689df77c22f" title="Setup the matched filter pixel processing parameters for physical optics wfs.">setup_powfs_mtch</a>(powfs,parms,ipowfs);
<a name="l01508"></a>01508         }<span class="keywordflow">else</span>{
<a name="l01509"></a>01509         error(<span class="stringliteral">"Please fill in this part\n"</span>);
<a name="l01510"></a>01510         }
<a name="l01511"></a>01511     }
<a name="l01512"></a>01512     }<span class="comment">//ipowfs</span>
<a name="l01513"></a>01513     toc(<span class="stringliteral">"setup_powfs"</span>);
<a name="l01514"></a>01514     <span class="keywordflow">return</span> powfs;
<a name="l01515"></a>01515 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="maos_2setup__powfs_8c_c7b704504acb96d7fbcbdd60f15c6cf8_cgraph.png" border="0" usemap="#maos_2setup__powfs_8c_c7b704504acb96d7fbcbdd60f15c6cf8_cgraph_map" alt=""></center>
<map name="maos_2setup__powfs_8c_c7b704504acb96d7fbcbdd60f15c6cf8_cgraph_map">
<area shape="rect" id="node3" href="maos_2setup__powfs_8c.html#b1890fbc6facc2013338054962b1398a" title="Setting up Detector transfer function used to translate PSFs from FFTs to detector..." alt="" coords="169,5,284,35"><area shape="rect" id="node5" href="maos_2setup__powfs_8c.html#bd59ad37c2a3372a70066e4b5cf34ac1" title="Compute Elongation Transfer function." alt="" coords="169,59,284,88"><area shape="rect" id="node7" href="maos_2setup__powfs_8c.html#7bbae2bc69e06f553d55c7c2d8c68ff3" title="setup the range to sodium layer as an additional parameter." alt="" coords="161,112,292,141"><area shape="rect" id="node9" href="maos_2setup__powfs_8c.html#77b6fd986d6105964adf2c844ee9df87" title="setting up subaperture geometry." alt="" coords="160,165,293,195"><area shape="rect" id="node11" href="maos_2setup__powfs_8c.html#e92ae33f8f650cb9c7975044bd82432f" title="Creating geometric wavefront gradient operator GS0 and ZA0 from WFS OPD to subaperture..." alt="" coords="164,219,289,248"><area shape="rect" id="node13" href="maos_2setup__powfs_8c.html#a8ee626a374ebefb84c2d560793c4c1e" title="setting up uplink pts/amp lotf" alt="" coords="172,272,281,301"><area shape="rect" id="node15" href="maos_2setup__powfs_8c.html#a16bf88378b48f5765294689df77c22f" title="Setup the matched filter pixel processing parameters for physical optics wfs." alt="" coords="161,325,292,355"><area shape="rect" id="node17" href="maos_2setup__powfs_8c.html#2589e29c8b5c4bd05b33da3638e8ae53" title="Set up NCPA maps for each WFS." alt="" coords="163,379,291,408"><area shape="rect" id="node19" href="maos_2setup__powfs_8c.html#b1409e69dddf8131559ea35731109bda" title="Prepare the parameters for physical optics setup." alt="" coords="149,432,304,461"><area shape="rect" id="node21" href="maos_2setup__powfs_8c.html#e2eab1b8ad97f659e38afe630140834e" title="Load and smooth out sodium profile." alt="" coords="156,485,297,515"></map>
</div>

</div>
</div><p>
<a class="anchor" name="4fdd29141f0d60af1fd7c6b2385f0031"></a><!-- doxytag: member="setup_powfs.c::free_powfs" ref="4fdd29141f0d60af1fd7c6b2385f0031" args="(const PARMS_T *parms, POWFS_T *powfs)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_powfs           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__T.html">POWFS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Free all parameters of powfs at the end of simulation. 
<p>
<div class="fragment"><pre class="fragment"><a name="l01519"></a>01519                                                      {
<a name="l01520"></a>01520     <span class="keywordtype">int</span> ipowfs;
<a name="l01521"></a>01521     <span class="keywordflow">for</span>(ipowfs=0; ipowfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#184dc967ffbedc29f2d48cd49889ddd2" title="Number of wfs types.">npowfs</a>; ipowfs++){
<a name="l01522"></a>01522     <a class="code" href="maos_2setup__powfs_8c.html#f500bd9800a3b3f47a36b855a9f88ae9" title="Free the powfs geometric parameters.">free_powfs_geom</a>(powfs, parms, ipowfs);
<a name="l01523"></a>01523     <a class="code" href="maos_2setup__powfs_8c.html#692825f333d5738b213e2d6d4f1ab5d5" title="Free the detector transfer function.">free_powfs_dtf</a>(powfs, parms, ipowfs);
<a name="l01524"></a>01524     spfree(powfs[ipowfs].GS0);
<a name="l01525"></a>01525     spfree(powfs[ipowfs].ZS0);
<a name="l01526"></a>01526     <span class="keywordflow">if</span>(powfs[ipowfs].intstat){
<a name="l01527"></a>01527         dcellfree(powfs[ipowfs].intstat-&gt;mtche);
<a name="l01528"></a>01528         dcellfree(powfs[ipowfs].intstat-&gt;sanea);
<a name="l01529"></a>01529         dcellfree(powfs[ipowfs].intstat-&gt;saneaixy);
<a name="l01530"></a>01530         dfree(powfs[ipowfs].intstat-&gt;i0sum);
<a name="l01531"></a>01531         free(powfs[ipowfs].intstat);
<a name="l01532"></a>01532     }
<a name="l01533"></a>01533     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>){
<a name="l01534"></a>01534         dcellfree(powfs[ipowfs].srot);
<a name="l01535"></a>01535         dcellfree(powfs[ipowfs].srsa);
<a name="l01536"></a>01536         dfree(powfs[ipowfs].srsamax);
<a name="l01537"></a>01537         dcellfree(powfs[ipowfs].sprint);
<a name="l01538"></a>01538     }
<a name="l01539"></a>01539     dcellfree(powfs[ipowfs].mcc);
<a name="l01540"></a>01540     dcellfree(powfs[ipowfs].imcc);
<a name="l01541"></a>01541     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#b490b1da338cd038e98d39547a2e75b8" title="need to compute GS0 (derived parameter)">hasGS0</a>){
<a name="l01542"></a>01542         spfree(powfs[ipowfs].GS0);
<a name="l01543"></a>01543     }
<a name="l01544"></a>01544     <span class="keywordflow">if</span>(powfs[ipowfs].lotf){
<a name="l01545"></a>01545         ptsfree(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#b60c0105ea57177379331a702f3bf054">pts</a>);
<a name="l01546"></a>01546         free(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#f406342d034ac6bda9785ba035e61ceb">amp</a>);
<a name="l01547"></a>01547         locfree(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#2a4eca6c9237397fb7383b557f87adea">loc</a>);
<a name="l01548"></a>01548         dcellfree(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#706fa25774d7c7dbfc0ab1c3925196b8">mcc</a>);
<a name="l01549"></a>01549         dcellfree(powfs[ipowfs].lotf-&gt;<a class="code" href="structPOWFS__T.html#8c1a97256a90efbb53166fc1ab5c16a9">imcc</a>);
<a name="l01550"></a>01550         free(powfs[ipowfs].lotf);
<a name="l01551"></a>01551     }
<a name="l01552"></a>01552     dfree(powfs[ipowfs].sodium);
<a name="l01553"></a>01553     <span class="keywordflow">if</span>(powfs[ipowfs].etfprep){
<a name="l01554"></a>01554         <span class="keywordflow">if</span>(powfs[ipowfs].etfprep!=powfs[ipowfs].etfsim){
<a name="l01555"></a>01555         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0;iwvl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;iwvl++){
<a name="l01556"></a>01556             ccellfree(powfs[ipowfs].etfsim[iwvl].p1);
<a name="l01557"></a>01557             ccellfree(powfs[ipowfs].etfsim[iwvl].p2);
<a name="l01558"></a>01558         }
<a name="l01559"></a>01559         free(powfs[ipowfs].etfsim);
<a name="l01560"></a>01560         }
<a name="l01561"></a>01561         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0;iwvl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#6e5b056212ee8f0d6c64d447b87f19e7" title="Number of wavelength.">nwvl</a>;iwvl++){
<a name="l01562"></a>01562         ccellfree(powfs[ipowfs].etfprep[iwvl].p1);
<a name="l01563"></a>01563         ccellfree(powfs[ipowfs].etfprep[iwvl].p2);
<a name="l01564"></a>01564         }
<a name="l01565"></a>01565         free(powfs[ipowfs].etfprep);
<a name="l01566"></a>01566     }
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568     free(powfs);
<a name="l01569"></a>01569 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 27 12:43:14 2010 for maos-0.6.1 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
