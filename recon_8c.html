<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.7.0: maos/recon.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/recon.c File Reference</h1>Wavefront reconstruction and DM fitting routines.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#7fe706adaaba472f96aaae11af439ec1">spcellmulmat_each_do</a> (EACH_T *info)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">added temporarily to test speed  <a href="#7fe706adaaba472f96aaae11af439ec1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="41f5e6d4ce5b0640f6eb99ee14476b41"></a><!-- doxytag: member="recon.c::spcellmulmat_each" ref="41f5e6d4ce5b0640f6eb99ee14476b41" args="(dcell **xout, spcell *A, dcell *xin, double alpha, int trans, int nthread)" -->
static void&nbsp;</td><td class="memItemRight" valign="bottom"><b>spcellmulmat_each</b> (<a class="el" href="structdcell.html">dcell</a> **xout, <a class="el" href="structspcell.html">spcell</a> *A, <a class="el" href="structdcell.html">dcell</a> *xin, double alpha, int trans, int nthread)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#98112ae2ee582d001eb0307d79eda59a">TomoR</a> (<a class="el" href="structdcell.html">dcell</a> **xout, const void *A, const <a class="el" href="structdcell.html">dcell</a> *gin, const double alpha)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Apply tomography right hand operator without using assembled matrix.  <a href="#98112ae2ee582d001eb0307d79eda59a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#3099e480359dfa43b2fe6b4868f1a704">TomoL</a> (<a class="el" href="structdcell.html">dcell</a> **xout, const void *A, const <a class="el" href="structdcell.html">dcell</a> *xin, const double alpha)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Apply tomography left hand side operator without using assembled matrix.  <a href="#3099e480359dfa43b2fe6b4868f1a704"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#168e09881164d7f61ac8e0620ec7135b">FitR</a> (<a class="el" href="structdcell.html">dcell</a> **xout, const void *A, const <a class="el" href="structdcell.html">dcell</a> *xin, const double alpha)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Apply fit right hand side matrix in CG mode without using assembled matrix.  <a href="#168e09881164d7f61ac8e0620ec7135b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#4a4842b145e88d09b903f986fe8951f2">FitL</a> (<a class="el" href="structdcell.html">dcell</a> **xout, const void *A, const <a class="el" href="structdcell.html">dcell</a> *xin, const double alpha)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Apply fit left hand side matrix in CG mode without using assembled matrix.  <a href="#4a4842b145e88d09b903f986fe8951f2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#44159203334924b9277408e81a49a893">tomo</a> (<a class="el" href="structdcell.html">dcell</a> **opdr, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structdcell.html">dcell</a> *grad)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Carry out tomography.  <a href="#44159203334924b9277408e81a49a893"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#861c4d9312ead5560557940f35618e17">fit</a> (<a class="el" href="structdcell.html">dcell</a> **adm, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, const <a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structdcell.html">dcell</a> *opdr)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Carry out DM fit.  <a href="#861c4d9312ead5560557940f35618e17"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#3c8efd1ec94a9fdaae9021172da85d7a">focus_tracking</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update LGS focus or reference vector.  <a href="#3c8efd1ec94a9fdaae9021172da85d7a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#511ecedaadb45f492744ecb02a1d06de">remove_dm_ngsmod</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu, <a class="el" href="structdcell.html">dcell</a> *dmerr)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">remove NGS modes from LGS DM commands if split_wt==1 Rngs*GA*dmerr is zero if split_wt==2 Doesn't perturb NGS modes in science direction.  <a href="#511ecedaadb45f492744ecb02a1d06de"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#83953e6f6306cb14c5ad00854c8df2b4">remove_dm_tt</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu, <a class="el" href="structdcell.html">dcell</a> *dmerr)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Removal tip/tilt on invidual DMs.  <a href="#83953e6f6306cb14c5ad00854c8df2b4"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#4312f074d4f65a3b3258c6e29f22578f">windest</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Experimental routine to do wind estimation using correlation tracking of tomography outputs.  <a href="#4312f074d4f65a3b3258c6e29f22578f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#c1922d6404880ae75380e8c876e55044">shift_ring</a> (int nap, <a class="el" href="structdmat.html">dmat</a> **ring, <a class="el" href="structdmat.html">dmat</a> *new)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">cyclic shift the dmats.  <a href="#c1922d6404880ae75380e8c876e55044"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#5a08339d5c9a918e99995b4dd016aa91">moao_FitR</a> (<a class="el" href="structdcell.html">dcell</a> **xout, const <a class="el" href="structRECON__T.html">RECON_T</a> *recon, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, int imoao, double thetax, double thetay, double hs, const <a class="el" href="structdcell.html">dcell</a> *opdr, const <a class="el" href="structdcell.html">dcell</a> *dmcommon, <a class="el" href="structdcell.html">dcell</a> **rhsout, const double alpha)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Apply fit right hand side matrix in CG mode without using assembled matrix for MOAO.  <a href="#5a08339d5c9a918e99995b4dd016aa91"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#f3f1b61e90e1b7f99f0ef80960511f8b">moao_FitL</a> (<a class="el" href="structdcell.html">dcell</a> **xout, const void *A, const <a class="el" href="structdcell.html">dcell</a> *xin, const double alpha)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Apply fit left hand side matrix in CG mode without using assembled matrix.  <a href="#f3f1b61e90e1b7f99f0ef80960511f8b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#f62a4685464fea7bdd37d04c821c3caf">moao_recon</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">mao_recon happens after the common DM fitting and its integrator output to take into account the delay in DM commands.  <a href="#f62a4685464fea7bdd37d04c821c3caf"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="recon_8c.html#17defa53668245c14cd494b9fab761f1">tomofit</a> (<a class="el" href="structSIM__T.html">SIM_T</a> *simu)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calls <a class="el" href="recon_8c.html#44159203334924b9277408e81a49a893" title="Carry out tomography.">tomo()</a> and <a class="el" href="recon_8c.html#861c4d9312ead5560557940f35618e17" title="Carry out DM fit.">fit()</a> to do the tomography and DM fit.  <a href="#17defa53668245c14cd494b9fab761f1"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Wavefront reconstruction and DM fitting routines. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="7fe706adaaba472f96aaae11af439ec1"></a><!-- doxytag: member="recon.c::spcellmulmat_each_do" ref="7fe706adaaba472f96aaae11af439ec1" args="(EACH_T *info)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void spcellmulmat_each_do           </td>
          <td>(</td>
          <td class="paramtype">EACH_T *&nbsp;</td>
          <td class="paramname"> <em>info</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
added temporarily to test speed 
<p>
<div class="fragment"><pre class="fragment"><a name="l00046"></a>00046                                               {
<a name="l00047"></a>00047     <span class="keywordtype">int</span> ic;
<a name="l00048"></a>00048     <span class="keywordflow">while</span>(LOCK(info-&gt;ilock),ic=info-&gt;ic++,UNLOCK(info-&gt;ilock),ic&lt;info-&gt;nc){
<a name="l00049"></a>00049     <span class="keywordflow">if</span>(info-&gt;trans){
<a name="l00050"></a>00050         <a class="code" href="dsp_8h.html#7f7a73c20dd1397db2034e9b39e05bff" title="y=y+alpha*A&amp;#39;*x;">sptmulmat</a>(&amp;info-&gt;xout-&gt;p[ic], info-&gt;A-&gt;p[ic], info-&gt;xin-&gt;p[ic], info-&gt;alpha);
<a name="l00051"></a>00051     }<span class="keywordflow">else</span>{
<a name="l00052"></a>00052         <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;info-&gt;xout-&gt;p[ic], info-&gt;A-&gt;p[ic], info-&gt;xin-&gt;p[ic], info-&gt;alpha);
<a name="l00053"></a>00053     }
<a name="l00054"></a>00054     }
<a name="l00055"></a>00055 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="98112ae2ee582d001eb0307d79eda59a"></a><!-- doxytag: member="recon.c::TomoR" ref="98112ae2ee582d001eb0307d79eda59a" args="(dcell **xout, const void *A, const dcell *gin, const double alpha)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TomoR           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>xout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>gin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>alpha</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Apply tomography right hand operator without using assembled matrix. 
<p>
Fast and saves memory. <div class="fragment"><pre class="fragment"><a name="l00077"></a>00077                                             {
<a name="l00078"></a>00078     
<a name="l00079"></a>00079     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=(<span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *)A;
<a name="l00080"></a>00080     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *g2=NULL;
<a name="l00081"></a>00081     dcellcp(&amp;g2, gin);
<a name="l00082"></a>00082     <a class="code" href="recon__utils_8c.html#08347b75d2ff1eb95c0a179873921e98" title="Removing Tip/Tilt/Focus from LGS grads.">TTFR</a>(g2, recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>, recon-&gt;<a class="code" href="structRECON__T.html#35b159335cbe2615df14d3bed3085298">PTTF</a>);
<a name="l00083"></a>00083     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *g3=NULL;
<a name="l00084"></a>00084     <a class="code" href="dsp_8h.html#982d5b6a6ebe469d8fc222eab370da9d" title="threaded version of Y(spcellmulmat)">spcellmulmat_thread</a>(&amp;g3,recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>, g2, 1,recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00085"></a>00085     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *xx2=NULL;
<a name="l00086"></a>00086     spcellmulmat_each(&amp;xx2, recon-&gt;<a class="code" href="structRECON__T.html#a3b783474293896824b711dff799620b" title="Gradient operator from H0.">GG</a>, g3, alpha, 1, recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00087"></a>00087     <a class="code" href="dsp_8h.html#22d09bf9b395e05d1fd28865ef4db635" title="threaded version of Y(sptcellmulmat">sptcellmulmat_thread</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#12988e3824ca095af01bdaaedab72926" title="Like G0tomo.">H0tomo</a>, xx2, 1, recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00088"></a>00088     dcellfree(xx2);
<a name="l00089"></a>00089     dcellfree(g2);
<a name="l00090"></a>00090     dcellfree(g3);
<a name="l00091"></a>00091 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3099e480359dfa43b2fe6b4868f1a704"></a><!-- doxytag: member="recon.c::TomoL" ref="3099e480359dfa43b2fe6b4868f1a704" args="(dcell **xout, const void *A, const dcell *xin, const double alpha)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void TomoL           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>xout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>xin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>alpha</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Apply tomography left hand side operator without using assembled matrix. 
<p>
Fast and saves memory. Only useful in CG. Accumulates to xout; <div class="fragment"><pre class="fragment"><a name="l00097"></a>00097                                             {
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=(<span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *)A;
<a name="l00100"></a>00100     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *gg=NULL;
<a name="l00101"></a>00101     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *xx=NULL;
<a name="l00102"></a>00102     <a class="code" href="dsp_8h.html#982d5b6a6ebe469d8fc222eab370da9d" title="threaded version of Y(spcellmulmat)">spcellmulmat_thread</a>(&amp;xx, recon-&gt;<a class="code" href="structRECON__T.html#12988e3824ca095af01bdaaedab72926" title="Like G0tomo.">H0tomo</a>, xin, 1., recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00103"></a>00103     spcellmulmat_each(&amp;gg, recon-&gt;<a class="code" href="structRECON__T.html#a3b783474293896824b711dff799620b" title="Gradient operator from H0.">GG</a>, xx, 1., 0, recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00104"></a>00104     dcellfree(xx);
<a name="l00105"></a>00105     <a class="code" href="recon__utils_8c.html#08347b75d2ff1eb95c0a179873921e98" title="Removing Tip/Tilt/Focus from LGS grads.">TTFR</a>(gg, recon-&gt;<a class="code" href="structRECON__T.html#3048a826f3dade40655bc464a3b624bc">TTF</a>, recon-&gt;<a class="code" href="structRECON__T.html#35b159335cbe2615df14d3bed3085298">PTTF</a>);
<a name="l00106"></a>00106     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *gg2=NULL;
<a name="l00107"></a>00107     <a class="code" href="dsp_8h.html#982d5b6a6ebe469d8fc222eab370da9d" title="threaded version of Y(spcellmulmat)">spcellmulmat_thread</a>(&amp;gg2, recon-&gt;<a class="code" href="structRECON__T.html#d6469def51098529c4067356e4427429">saneai</a>, gg,1,recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00108"></a>00108     dcellfree(gg);
<a name="l00109"></a>00109     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *xx2=NULL;
<a name="l00110"></a>00110     spcellmulmat_each(&amp;xx2, recon-&gt;<a class="code" href="structRECON__T.html#a3b783474293896824b711dff799620b" title="Gradient operator from H0.">GG</a>, gg2, alpha, 1, recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00111"></a>00111     <a class="code" href="dsp_8h.html#22d09bf9b395e05d1fd28865ef4db635" title="threaded version of Y(sptcellmulmat">sptcellmulmat_thread</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#12988e3824ca095af01bdaaedab72926" title="Like G0tomo.">H0tomo</a>, xx2, 1, recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00112"></a>00112     dcellfree(xx2);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     dcellfree(gg2);
<a name="l00115"></a>00115     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>){
<a name="l00116"></a>00116     <a class="code" href="recon__utils_8c.html#d59691de300baba36caae207d8ec691b" title="Apply Laplacian2 to xin and accumulates to xout.">apply_L2</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#6b77529f7c42bb0d6a2fd545d5dcf623">L2</a>, xin, alpha, recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00117"></a>00117     }<span class="keywordflow">else</span>{
<a name="l00118"></a>00118     <a class="code" href="recon__utils_8c.html#4426460a3e86bfd2b5ff2457f6333740" title="Apply turbulence invpsd to x in Fourier space, scaled by alpha.">apply_invpsd</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>.<a class="code" href="structMUV__T.html#3e9fb771da66419d7d4b697405bdc9b6" title="Data used by fun to apply: (*exfun)(y,extra,x,alpha) to compute.">extra</a>, xin, alpha);
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     <span class="keywordflow">if</span>(recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>){<span class="comment">//single point piston constraint</span>
<a name="l00121"></a>00121     <a class="code" href="dsp_8h.html#22d09bf9b395e05d1fd28865ef4db635" title="threaded version of Y(sptcellmulmat">sptcellmulmat_thread</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#dafac44fb018d6c245653816e2b42fdd">ZZT</a>, xin, alpha,
<a name="l00122"></a>00122                  recon-&gt;<a class="code" href="structRECON__T.html#b4fef9ce2df8e8c5b05f3b6ea35f506a">nthread</a>);
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124     <span class="comment">/*Tikhonov regularization is not added because it is not necessary in CG</span>
<a name="l00125"></a>00125 <span class="comment">      mode.*/</span>
<a name="l00126"></a>00126 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="168e09881164d7f61ac8e0620ec7135b"></a><!-- doxytag: member="recon.c::FitR" ref="168e09881164d7f61ac8e0620ec7135b" args="(dcell **xout, const void *A, const dcell *xin, const double alpha)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void FitR           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>xout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>xin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>alpha</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Apply fit right hand side matrix in CG mode without using assembled matrix. 
<p>
Slow. don't use. Assembled matrix is faster because of multiple directions. <div class="fragment"><pre class="fragment"><a name="l00132"></a>00132                                            {
<a name="l00133"></a>00133     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=(<span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *)A;
<a name="l00134"></a>00134     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *xp=NULL;
<a name="l00135"></a>00135     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;xp, recon-&gt;<a class="code" href="structRECON__T.html#41a461a54e2753a1714894878cc63f94">HX</a>, xin, 1.);
<a name="l00136"></a>00136     <a class="code" href="recon__utils_8c.html#ac31a93d205900027f62a385a321de0b" title="apply weighting W0/W1 with weighting wt for each block.">applyW</a>(xp, recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>, recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>, recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>);
<a name="l00137"></a>00137     <a class="code" href="dsp_8h.html#730a5070a85111231144cdd535a9f952" title="C=C+A&amp;#39;*B*alpha.">sptcellmulmat</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>, xp, alpha);
<a name="l00138"></a>00138     dcellfree(xp);
<a name="l00139"></a>00139 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="4a4842b145e88d09b903f986fe8951f2"></a><!-- doxytag: member="recon.c::FitL" ref="4a4842b145e88d09b903f986fe8951f2" args="(dcell **xout, const void *A, const dcell *xin, const double alpha)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void FitL           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>xout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>xin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>alpha</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Apply fit left hand side matrix in CG mode without using assembled matrix. 
<p>
Slow. don't use. Assembled matridx is faster because of multiple directions. <div class="fragment"><pre class="fragment"><a name="l00145"></a>00145                                            {
<a name="l00146"></a>00146     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=(<span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *)A;
<a name="l00147"></a>00147     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *xp=NULL;
<a name="l00148"></a>00148     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;xp, recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>, xin, 1.);
<a name="l00149"></a>00149     <a class="code" href="recon__utils_8c.html#ac31a93d205900027f62a385a321de0b" title="apply weighting W0/W1 with weighting wt for each block.">applyW</a>(xp, recon-&gt;<a class="code" href="structRECON__T.html#aee99fee4d59198a65cae179a75079c8">W0</a>, recon-&gt;<a class="code" href="structRECON__T.html#aa074ebc911745f317217447e84d8360">W1</a>, recon-&gt;<a class="code" href="structRECON__T.html#9ce0a15713ec297c402c8d63cf1d2c60">fitwt</a>-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>);
<a name="l00150"></a>00150     <a class="code" href="dsp_8h.html#730a5070a85111231144cdd535a9f952" title="C=C+A&amp;#39;*B*alpha.">sptcellmulmat</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#4d98d1338f29dfd15b0b561636d94477">HA</a>, xp, alpha);
<a name="l00151"></a>00151     dcellfree(xp);xp=NULL;
<a name="l00152"></a>00152     dcellmm(&amp;xp,recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>, xin, <span class="stringliteral">"tn"</span>, 1);
<a name="l00153"></a>00153     dcellmm(xout,recon-&gt;<a class="code" href="structRECON__T.html#683d40139eb362ad92f9eee29ecdcf9d">NW</a>, xp, <span class="stringliteral">"nn"</span>, alpha);
<a name="l00154"></a>00154     dcellfree(xp);
<a name="l00155"></a>00155 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="44159203334924b9277408e81a49a893"></a><!-- doxytag: member="recon.c::tomo" ref="44159203334924b9277408e81a49a893" args="(dcell **opdr, const PARMS_T *parms, const RECON_T *recon, const dcell *grad)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tomo           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>opdr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>grad</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Carry out tomography. 
<p>
(Precondition) CG with pcg() and Cholesky Backsubtitution with <a class="el" href="muv_8c.html#a4328cb15b28f10526bb59c0e1a8ab38" title="Apply cholesky backsubstitution solve to xin to get xout.">muv_chol_solve()</a> is implemented. <div class="fragment"><pre class="fragment"><a name="l00161"></a>00161                                                                                       {
<a name="l00162"></a>00162     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *rhs=NULL;
<a name="l00163"></a>00163     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a>){
<a name="l00164"></a>00164     <a class="code" href="muv_8c.html#2bbd39c499e8875359bc94f9e4925793" title="Apply the sparse plug low rand compuation to xin without scaling of alpha: ; U,V...">muv</a>(&amp;rhs, &amp;(recon-&gt;<a class="code" href="structRECON__T.html#153eef0b3f78088e72b50753006d5126">RR</a>), grad, 1);
<a name="l00165"></a>00165     }<span class="keywordflow">else</span>{
<a name="l00166"></a>00166     <a class="code" href="recon_8c.html#98112ae2ee582d001eb0307d79eda59a" title="Apply tomography right hand operator without using assembled matrix.">TomoR</a>(&amp;rhs, recon, grad, 1);
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>){
<a name="l00169"></a>00169     <span class="keywordflow">case</span> 0:
<a name="l00170"></a>00170     <a class="code" href="muv_8c.html#de96309b1d59bf9740f3c6eeed3b4a7a" title="convert the data from dcell to dmat and apply muv_chol_solve()">muv_chol_solve_cell</a>(opdr,&amp;(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>), rhs);
<a name="l00171"></a>00171     <span class="keywordflow">break</span>;
<a name="l00172"></a>00172     <span class="keywordflow">case</span> 1:{
<a name="l00173"></a>00173     PREFUN pfun=NULL;
<a name="l00174"></a>00174     <span class="keyword">const</span> <span class="keywordtype">void</span> *pdata=NULL;
<a name="l00175"></a>00175     <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#55e4197464d1963dbff66662ec83f4b1" title="Tomography preconditioner.">precond</a>){
<a name="l00176"></a>00176     <span class="keywordflow">case</span> 0:
<a name="l00177"></a>00177         pfun=NULL;
<a name="l00178"></a>00178         pdata=NULL;
<a name="l00179"></a>00179         <span class="keywordflow">break</span>;
<a name="l00180"></a>00180     <span class="keywordflow">case</span> 1:
<a name="l00181"></a>00181         pfun=<a class="code" href="fdpcg_8c.html#2fe70a98a8797a50a58639f9c032a996" title="Apply the Fourier domain preconditioner.">fdpcg_precond</a>;
<a name="l00182"></a>00182         pdata=(<span class="keywordtype">void</span>*)recon;
<a name="l00183"></a>00183         <span class="keywordflow">break</span>;
<a name="l00184"></a>00184     <span class="keywordflow">default</span>:
<a name="l00185"></a>00185         error(<span class="stringliteral">"Invalid tomo.precond\n"</span>);
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b3d83877db6d942c80c35d3ae0829e78" title="force assemble tomography matrix in CG">assemble</a>){
<a name="l00188"></a>00188         pcg(opdr, (CGFUN)<a class="code" href="muv_8c.html#2bbd39c499e8875359bc94f9e4925793" title="Apply the sparse plug low rand compuation to xin without scaling of alpha: ; U,V...">muv</a>, &amp;(recon-&gt;<a class="code" href="structRECON__T.html#0bd16a8ead29c586c1027bbc194042de">RL</a>), pfun, pdata,rhs, 1, parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#51f34eccc5590bde667bc522829c5be4" title="max iterations.">maxit</a>);
<a name="l00189"></a>00189     }<span class="keywordflow">else</span>{
<a name="l00190"></a>00190         pcg(opdr, <a class="code" href="recon_8c.html#3099e480359dfa43b2fe6b4868f1a704" title="Apply tomography left hand side operator without using assembled matrix.">TomoL</a>, recon, pfun,pdata,rhs, 1, parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#51f34eccc5590bde667bc522829c5be4" title="max iterations.">maxit</a>);
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193     <span class="keywordflow">break</span>;
<a name="l00194"></a>00194     <span class="keywordflow">default</span>:
<a name="l00195"></a>00195     error(<span class="stringliteral">"Not implemented: alg=%d\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>);
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197     dcellfree(rhs);
<a name="l00198"></a>00198 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="861c4d9312ead5560557940f35618e17"></a><!-- doxytag: member="recon.c::fit" ref="861c4d9312ead5560557940f35618e17" args="(dcell **adm, const PARMS_T *parms, const RECON_T *recon, const dcell *opdr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void fit           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>adm</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>opdr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Carry out DM fit. 
<p>
Un-Precondition CG and Cholesky Backsubtitution is implemented. <div class="fragment"><pre class="fragment"><a name="l00203"></a>00203                                              {
<a name="l00204"></a>00204     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>==0) <span class="keywordflow">return</span>;
<a name="l00205"></a>00205     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *rhs=NULL;
<a name="l00206"></a>00206     <a class="code" href="muv_8c.html#2bbd39c499e8875359bc94f9e4925793" title="Apply the sparse plug low rand compuation to xin without scaling of alpha: ; U,V...">muv</a>(&amp;rhs, &amp;(recon-&gt;<a class="code" href="structRECON__T.html#2f4fd359bc3f9a7b954f389f3d31d384">FR</a>), opdr, 1);
<a name="l00207"></a>00207     <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#816490fc8c78b35c2fcd85934d7972bb" title="Fitting algorithm to solve the linear equation.">alg</a>){
<a name="l00208"></a>00208     <span class="keywordflow">case</span> 0:
<a name="l00209"></a>00209     <a class="code" href="muv_8c.html#de96309b1d59bf9740f3c6eeed3b4a7a" title="convert the data from dcell to dmat and apply muv_chol_solve()">muv_chol_solve_cell</a>(adm,&amp;(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>),rhs);
<a name="l00210"></a>00210     <span class="keywordflow">break</span>;
<a name="l00211"></a>00211     <span class="keywordflow">case</span> 1:
<a name="l00212"></a>00212     pcg(adm, (CGFUN)<a class="code" href="muv_8c.html#2bbd39c499e8875359bc94f9e4925793" title="Apply the sparse plug low rand compuation to xin without scaling of alpha: ; U,V...">muv</a>, &amp;(recon-&gt;<a class="code" href="structRECON__T.html#e471a9a73f20d6f544f1ad69ca54dd42">FL</a>),NULL,NULL, rhs, 1, parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4533eef0ce553366cefd0e2d02de4b2d" title="max iterations.">maxit</a>);
<a name="l00213"></a>00213     <span class="keywordflow">break</span>;
<a name="l00214"></a>00214     <span class="keywordflow">default</span>:
<a name="l00215"></a>00215     error(<span class="stringliteral">"Not implemented: alg=%d\n"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#816490fc8c78b35c2fcd85934d7972bb" title="Fitting algorithm to solve the linear equation.">alg</a>);
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217     dcellfree(rhs);
<a name="l00218"></a>00218 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3c8efd1ec94a9fdaae9021172da85d7a"></a><!-- doxytag: member="recon.c::focus_tracking" ref="3c8efd1ec94a9fdaae9021172da85d7a" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void focus_tracking           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Update LGS focus or reference vector. 
<p>
<div class="fragment"><pre class="fragment">
       LGS: CL grads works, but not as good.
       LGS: CL grads + DM grads does not work
       LGS: CL grads + DM grads - Xhat grad is the choice.

       mffocus is 0: no focus tracking.
       mffocus is 1: use CL grads + DM grads - Xhat grad for LGS and NGS
       mffocus is 2: use CL grads + DM grads - Xhat grad for LGS; 
       CL grads for NGS.
    </pre></div> <div class="fragment"><pre class="fragment"><a name="l00233"></a>00233                                {
<a name="l00234"></a>00234     <span class="comment">//Updating LGS focus or reference vector.</span>
<a name="l00235"></a>00235     <span class="comment">//fixme: what if strat!=1</span>
<a name="l00236"></a>00236     <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#9b8def53514d043f3a8528caad38baf5">RFlgs</a>){
<a name="l00237"></a>00237     warning(<span class="stringliteral">"There is no LGS. No need to do focus tracking\n"</span>);
<a name="l00238"></a>00238     <span class="keywordflow">return</span>;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00241"></a>00241     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00242"></a>00242     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *graduse=dcellnew(parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>,1);
<a name="l00243"></a>00243     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#7bf5539b03cc7caebf92df2ef1696ce1">GA</a>,GA);
<a name="l00244"></a>00244     PSPCELL(recon-&gt;<a class="code" href="structRECON__T.html#d488016296d1767cd96dd9614ce8ba55">G0focus</a>,G0);
<a name="l00245"></a>00245     <span class="keywordtype">int</span> ngs_psol=0;
<a name="l00246"></a>00246     <span class="keywordtype">int</span> ngs_x=0;
<a name="l00247"></a>00247     <span class="keywordtype">int</span> lgs_psol=0;
<a name="l00248"></a>00248     <span class="keywordtype">int</span> lgs_x=0;
<a name="l00249"></a>00249     lgs_psol=1;
<a name="l00250"></a>00250     lgs_x=1;
<a name="l00251"></a>00251     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#bf0ce35fd4cdfa16eefa42aea7c3300e" title="method for focus tracing.">mffocus</a>==1){
<a name="l00252"></a>00252     ngs_psol=1;
<a name="l00253"></a>00253     ngs_x=1;
<a name="l00254"></a>00254     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#bf0ce35fd4cdfa16eefa42aea7c3300e" title="method for focus tracing.">mffocus</a>!=2){
<a name="l00255"></a>00255     error(<span class="stringliteral">"Invalid mffocus: %d\n"</span>, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#bf0ce35fd4cdfa16eefa42aea7c3300e" title="method for focus tracing.">mffocus</a>);
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00258"></a>00258     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00259"></a>00259     <span class="keywordtype">int</span> gs_psol, gs_x;
<a name="l00260"></a>00260     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>){<span class="comment">//LGS</span>
<a name="l00261"></a>00261         gs_psol=lgs_psol;
<a name="l00262"></a>00262         gs_x=lgs_x;
<a name="l00263"></a>00263     }<span class="keywordflow">else</span>{<span class="comment">//NGS</span>
<a name="l00264"></a>00264         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>==1) <span class="keywordflow">continue</span>;<span class="comment">//no bother with TT NGS.</span>
<a name="l00265"></a>00265         gs_psol=ngs_psol;
<a name="l00266"></a>00266         gs_x=ngs_x;
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268     <span class="keywordflow">if</span>(gs_psol){<span class="comment">//psol</span>
<a name="l00269"></a>00269         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]){
<a name="l00270"></a>00270         graduse-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#7ecadca31195b8b40135b7dbeb808906" title="duplicate a X(mat) array">ddup</a>(simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]);
<a name="l00271"></a>00271         }<span class="keywordflow">else</span>{
<a name="l00272"></a>00272         info(<span class="stringliteral">"Forming PSOL grads for wfs %d\n"</span>,iwfs);
<a name="l00273"></a>00273         graduse-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#7ecadca31195b8b40135b7dbeb808906" title="duplicate a X(mat) array">ddup</a>(simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]);
<a name="l00274"></a>00274         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>){
<a name="l00275"></a>00275             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00276"></a>00276             <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;graduse-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],GA[idm][iwfs],
<a name="l00277"></a>00277                  simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm],1);
<a name="l00278"></a>00278             }
<a name="l00279"></a>00279         }
<a name="l00280"></a>00280         }
<a name="l00281"></a>00281     }<span class="keywordflow">else</span>{<span class="comment">//cl</span>
<a name="l00282"></a>00282         graduse-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]=<a class="code" href="dmat_8h.html#7ecadca31195b8b40135b7dbeb808906" title="duplicate a X(mat) array">ddup</a>(simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs]);
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284     <span class="keywordflow">if</span>(gs_x){
<a name="l00285"></a>00285         info(<span class="stringliteral">"Subtracing tomo grad from wfs %d\n"</span>,iwfs);
<a name="l00286"></a>00286         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>; ips++){
<a name="l00287"></a>00287         <span class="keywordflow">if</span>(!G0[ips][iwfs]){
<a name="l00288"></a>00288             error(<span class="stringliteral">"G0[%d][%d] is empty\n"</span>,ips,iwfs);
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290         <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;graduse-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],G0[ips][iwfs],simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips],-1);
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *NGSfocus=NULL;
<a name="l00295"></a>00295     dcellmm(&amp;NGSfocus, recon-&gt;<a class="code" href="structRECON__T.html#ab0482d17cd664cfd606c24e5b97d365">RFngs</a>, graduse, <span class="stringliteral">"nn"</span>, 1);
<a name="l00296"></a>00296     info(<span class="stringliteral">"NGSfocus is %g\n"</span>, NGSfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]);
<a name="l00297"></a>00297     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00298"></a>00298     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00299"></a>00299     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#649a628036ca2785673990cc5af15c13" title="whether having llt.">hasllt</a>) 
<a name="l00300"></a>00300         <span class="keywordflow">continue</span>;
<a name="l00301"></a>00301     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *LGSfocus=NULL;
<a name="l00302"></a>00302     <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a> (&amp;LGSfocus,recon-&gt;<a class="code" href="structRECON__T.html#9b8def53514d043f3a8528caad38baf5">RFlgs</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],graduse-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs],<span class="stringliteral">"nn"</span>,1);
<a name="l00303"></a>00303     <span class="comment">//Use NGS focus - LGS focus to drive the zoom optics/reference vector</span>
<a name="l00304"></a>00304     <a class="code" href="dmat_8h.html#4c4f53dc9572106deb6933eb103bf40b" title="compute B=bc*B+ac*A behavior changed on 2009-11-02.">dadd</a>(&amp;LGSfocus,-1, NGSfocus-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0], 1);
<a name="l00305"></a>00305     <a class="code" href="dmat_8h.html#4c4f53dc9572106deb6933eb103bf40b" title="compute B=bc*B+ac*A behavior changed on 2009-11-02.">dadd</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#dd680e809db812c7b0493e18b816a68e">focuslpf</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], 1.-parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#033ef0d6b40663166860f533d731000d" title="parameter for low pass filter of LGS focus tracking with offset">lpfocus</a>, 
<a name="l00306"></a>00306          LGSfocus, parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#033ef0d6b40663166860f533d731000d" title="parameter for low pass filter of LGS focus tracking with offset">lpfocus</a>);
<a name="l00307"></a>00307     <a class="code" href="dmat_8h.html#4c4f53dc9572106deb6933eb103bf40b" title="compute B=bc*B+ac*A behavior changed on 2009-11-02.">dadd</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#cf19af635f4448413fce6adba8078d6e">focusint</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], 1, 
<a name="l00308"></a>00308          simu-&gt;<a class="code" href="structSIM__T.html#dd680e809db812c7b0493e18b816a68e">focuslpf</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[iwfs], parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#b05030e94f2d0bda933420bdb15d45ef" title="error gain for LGS focus tracking with zoom optics">epfocus</a>);
<a name="l00309"></a>00309     dfree(LGSfocus);
<a name="l00310"></a>00310     }
<a name="l00311"></a>00311     dcellfree(NGSfocus);
<a name="l00312"></a>00312     dcellfree(graduse);
<a name="l00313"></a>00313 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="511ecedaadb45f492744ecb02a1d06de"></a><!-- doxytag: member="recon.c::remove_dm_ngsmod" ref="511ecedaadb45f492744ecb02a1d06de" args="(SIM_T *simu, dcell *dmerr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void remove_dm_ngsmod           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>dmerr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
remove NGS modes from LGS DM commands if split_wt==1 Rngs*GA*dmerr is zero if split_wt==2 Doesn't perturb NGS modes in science direction. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00321"></a>00321                                                               {
<a name="l00322"></a>00322     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00323"></a>00323     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *Mngs=NULL;
<a name="l00324"></a>00324     dcellmm(&amp;Mngs, recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#3e0a759744994377aef5ba9eaefdb90d">Pngs</a>, dmerr, <span class="stringliteral">"nn"</span>,1);
<a name="l00325"></a>00325     <a class="code" href="ahst_8c.html#3d2a474cd4a6fcebb9e1ff8f26855353" title="Convert NGS modes to DM actuator commands using analytical expression.">ngsmod2dm</a>(&amp;dmerr,recon, Mngs,-1);
<a name="l00326"></a>00326     <span class="comment">/*{</span>
<a name="l00327"></a>00327 <span class="comment">      info("NGSmod before removal\n");</span>
<a name="l00328"></a>00328 <span class="comment">      dshow(Mngs-&gt;p[0]);</span>
<a name="l00329"></a>00329 <span class="comment">      dcellzero(Mngs);</span>
<a name="l00330"></a>00330 <span class="comment">      dcellmm(&amp;Mngs, recon-&gt;ngsmod-&gt;Pngs, dmerr, "nn",1);</span>
<a name="l00331"></a>00331 <span class="comment">      info("NGSmod after removal\n");</span>
<a name="l00332"></a>00332 <span class="comment">      dshow(Mngs-&gt;p[0]);</span>
<a name="l00333"></a>00333 <span class="comment">      }*/</span>
<a name="l00334"></a>00334     dcellfree(Mngs);
<a name="l00335"></a>00335 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="83953e6f6306cb14c5ad00854c8df2b4"></a><!-- doxytag: member="recon.c::remove_dm_tt" ref="83953e6f6306cb14c5ad00854c8df2b4" args="(SIM_T *simu, dcell *dmerr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void remove_dm_tt           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>dmerr</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [inline, static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Removal tip/tilt on invidual DMs. 
<p>
Be careful about the roll off near the edge. <div class="fragment"><pre class="fragment"><a name="l00339"></a>00339                                                           {
<a name="l00340"></a>00340     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00341"></a>00341     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00342"></a>00342     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *utt=NULL;
<a name="l00343"></a>00343     <a class="code" href="dmat_8h.html#a9ddb63c56fcc2219955260936ee9e40" title="compute matrix product using blas dgemm with beta=1; C=beta*C+ alpha *trans(A)*trans(B);...">dmm</a>(&amp;utt, recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>-&gt;<a class="code" href="structNGSMOD__T.html#e45f01f0921c2ad9c9c599ff9e0bd072">Ptt</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm], dmerr-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm], <span class="stringliteral">"nn"</span>, -1);
<a name="l00344"></a>00344     <span class="keywordtype">double</span> *ptt;
<a name="l00345"></a>00345     <span class="keywordflow">if</span>(utt-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>==2){
<a name="l00346"></a>00346         ptt=alloca(3*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00347"></a>00347         ptt[0]=0; ptt[1]=utt-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[0]; ptt[2]=utt-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[1];
<a name="l00348"></a>00348     }<span class="keywordflow">else</span>{
<a name="l00349"></a>00349         ptt=utt-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351     <a class="code" href="loc_8c.html#dfcc248edb1f99a3682140719a26d802" title="Add Piston/Tip/Tilt from OPD.">loc_add_ptt</a>(dmerr-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, ptt, recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm]);
<a name="l00352"></a>00352     info(<span class="stringliteral">"Adding P/T/T %g m %f %f mas to dm %d\n"</span>,
<a name="l00353"></a>00353          ptt[0],ptt[1]*206265000,ptt[2]*206265000,idm);
<a name="l00354"></a>00354     dfree(utt);
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="4312f074d4f65a3b3258c6e29f22578f"></a><!-- doxytag: member="recon.c::windest" ref="4312f074d4f65a3b3258c6e29f22578f" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void windest           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Experimental routine to do wind estimation using correlation tracking of tomography outputs. 
<p>
Not finished. Not verified. <div class="fragment"><pre class="fragment"><a name="l00360"></a>00360                                 {
<a name="l00361"></a>00361     <span class="keywordtype">long</span> nps=simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>;
<a name="l00362"></a>00362     <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>){
<a name="l00363"></a>00363     simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(nps,1);
<a name="l00364"></a>00364     simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(nps,1);
<a name="l00365"></a>00365     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ips=0; ips&lt;nps; ips++){
<a name="l00366"></a>00366         simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>[ips],
<a name="l00367"></a>00367                        simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>[ips]);
<a name="l00368"></a>00368         simu-&gt;<a class="code" href="structSIM__T.html#b7219d0797daeda112563e0f0d6bed9b">opdrhatlast</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#54e253baae89cc860fb94219b4f03a69">xloc_nx</a>[ips],
<a name="l00369"></a>00369                        simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#e7353a5a6f858993ef8dc77eb0e4294b">xloc_ny</a>[ips]);
<a name="l00370"></a>00370         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips], -1);
<a name="l00371"></a>00371         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(simu-&gt;<a class="code" href="structSIM__T.html#b7219d0797daeda112563e0f0d6bed9b">opdrhatlast</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips], -1);
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373     simu-&gt;<a class="code" href="structSIM__T.html#ec5148b2cbcb290d3f6d3e9c6f587b58">windest</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(2, nps);
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375     <a class="code" href="structccell.html" title="an 2-d block matrix of cmat.">ccell</a> *temp;
<a name="l00376"></a>00376     temp=simu-&gt;<a class="code" href="structSIM__T.html#b7219d0797daeda112563e0f0d6bed9b">opdrhatlast</a>;
<a name="l00377"></a>00377     simu-&gt;<a class="code" href="structSIM__T.html#b7219d0797daeda112563e0f0d6bed9b">opdrhatlast</a>=simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>;
<a name="l00378"></a>00378     simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>=temp;
<a name="l00379"></a>00379     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ips=0; ips&lt;nps; ips++){
<a name="l00380"></a>00380     dcomplex *restrict dest=simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips]-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>;
<a name="l00381"></a>00381     <span class="keywordtype">double</span> *restrict source=simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00382"></a>00382     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ipix=0; ipix&lt;simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips]-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>*simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips]-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; ipix++){
<a name="l00383"></a>00383         dest[ipix]=source[ipix];
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385     <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips]);<span class="comment">//may be able to remove</span>
<a name="l00386"></a>00386     <a class="code" href="fft_8c.html#5e22d51b30da1c5c057cb5b8f121273d" title="Do 2d FFT transforms.">cfft2</a>(simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips], -1);
<a name="l00387"></a>00387     <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[ips]);
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a> &gt; simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#9e65d6a0d29a750075158ff470386f5e" title="time step to start simulation.">start</a>){
<a name="l00390"></a>00390     <span class="comment">//Compute Wind. not done yet.</span>
<a name="l00391"></a>00391     <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#e7c3be846a2bcf3ce66afb764880604c">opdrhat</a>,<span class="stringliteral">"opdrhat"</span>);
<a name="l00392"></a>00392     <a class="code" href="cmat_8h.html#e75214457fa1e5c394d311b307a7f5e4" title="User callable function to write cell array of dense matrix into a file.">ccellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#b7219d0797daeda112563e0f0d6bed9b">opdrhatlast</a>,<span class="stringliteral">"opdrhatlast"</span>);
<a name="l00393"></a>00393     exit(0);
<a name="l00394"></a>00394     }
<a name="l00395"></a>00395 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="c1922d6404880ae75380e8c876e55044"></a><!-- doxytag: member="recon.c::shift_ring" ref="c1922d6404880ae75380e8c876e55044" args="(int nap, dmat **ring, dmat *new)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void shift_ring           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>nap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> **&nbsp;</td>
          <td class="paramname"> <em>ring</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>new</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
cyclic shift the dmats. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00398"></a>00398                                                        {
<a name="l00399"></a>00399     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *keep=ring[nap-1];
<a name="l00400"></a>00400     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iap=nap-1; iap&gt;=0; iap--){
<a name="l00401"></a>00401     <span class="keywordflow">if</span>(!iap){
<a name="l00402"></a>00402         ring[iap]=<a class="code" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat).">dref</a>(<span class="keyword">new</span>);
<a name="l00403"></a>00403     }<span class="keywordflow">else</span>{
<a name="l00404"></a>00404         ring[iap]=ring[iap-1];
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406     }
<a name="l00407"></a>00407     dfree(keep);
<a name="l00408"></a>00408 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5a08339d5c9a918e99995b4dd016aa91"></a><!-- doxytag: member="recon.c::moao_FitR" ref="5a08339d5c9a918e99995b4dd016aa91" args="(dcell **xout, const RECON_T *recon, const PARMS_T *parms, int imoao, double thetax, double thetay, double hs, const dcell *opdr, const dcell *dmcommon, dcell **rhsout, const double alpha)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void moao_FitR           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>xout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structRECON__T.html">RECON_T</a> *&nbsp;</td>
          <td class="paramname"> <em>recon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>imoao</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>thetax</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>thetay</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>hs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>opdr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>dmcommon</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>rhsout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>alpha</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Apply fit right hand side matrix in CG mode without using assembled matrix for MOAO. 
<p>
subtract contributions from DMs that are in common path. Be careful which time step the dmcommon is. The DM common should use the commands on the step that you are going to apply the MOAO command for. That is the integrator output after this computation. <div class="fragment"><pre class="fragment"><a name="l00420"></a>00420                                                                                    {
<a name="l00421"></a>00421   
<a name="l00422"></a>00422     <span class="comment">//LOC_T *maloc=recon-&gt;moao[imoao].aloc;</span>
<a name="l00423"></a>00423     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *xp=dcellnew(1,1);
<a name="l00424"></a>00424     xp-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>,1);
<a name="l00425"></a>00425     
<a name="l00426"></a>00426     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipsr=0; ipsr&lt;recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>; ipsr++){
<a name="l00427"></a>00427     <span class="keyword">const</span> <span class="keywordtype">double</span> ht = parms-&gt;<a class="code" href="structPARMS__T.html#654d89a9becf3ea9e32d11e470416f7c" title="information about reconstructed atm">atmr</a>.<a class="code" href="structATMR__CFG__T.html#c2d70c6f4dd690896de2145333728abc" title="height of each layer">ht</a>[ipsr];
<a name="l00428"></a>00428     <span class="keywordtype">double</span> scale=1.-ht/hs;
<a name="l00429"></a>00429     <a class="code" href="accphi_8c.html#33015a685252b9238783b98a8ec5b159" title="Propagate OPD defines on coordinate locin to coordinate locout.">prop_nongrid</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ipsr], opdr-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipsr]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00430"></a>00430              recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, NULL, xp-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 1, 
<a name="l00431"></a>00431              thetax*ht, thetay*ht, scale, 
<a name="l00432"></a>00432              0, 0);
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;recon-&gt;<a class="code" href="structRECON__T.html#1fbfc84eb66bf5bee54a38e6b268e50a">ndm</a>; idm++){
<a name="l00435"></a>00435     <span class="keyword">const</span> <span class="keywordtype">double</span> ht = parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#bf49acebd195a6705ddf3ed1c3f662ea" title="height conjugation range">ht</a>;
<a name="l00436"></a>00436     <span class="keywordtype">double</span> scale=1.-ht/hs;
<a name="l00437"></a>00437     <a class="code" href="accphi_8c.html#653ec67b44b3a2fb82cd2616c38e16ef" title="like prop_nongrid but with cubic influence functions.">prop_nongrid_cubic</a>(recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], dmcommon-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00438"></a>00438                recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, NULL, xp-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, -1, 
<a name="l00439"></a>00439                thetax*ht, thetay*ht, scale, 
<a name="l00440"></a>00440                parms-&gt;<a class="code" href="structPARMS__T.html#c2f69a649e1ac2d2e55e790ac067d46c" title="Array of DM.">dm</a>[idm].<a class="code" href="structDM__CFG__T.html#fca1c9ed9b0f9ce5a25147eb5906947b" title="Inter-Actuator Coupling coefficient.">iac</a>, 0, 0);
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442     <span class="keywordflow">if</span>(rhsout){
<a name="l00443"></a>00443     *rhsout=dcelldup(xp);
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445     <span class="keywordtype">double</span> wt=1;
<a name="l00446"></a>00446     <a class="code" href="recon__utils_8c.html#ac31a93d205900027f62a385a321de0b" title="apply weighting W0/W1 with weighting wt for each block.">applyW</a>(xp, recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#5514e32cd4b953c45006a49ff429254c">W0</a>, recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#cc34b6bf2dc67f5346fe6d040bc699b0">W1</a>, &amp;wt);
<a name="l00447"></a>00447     <a class="code" href="dsp_8h.html#730a5070a85111231144cdd535a9f952" title="C=C+A&amp;#39;*B*alpha.">sptcellmulmat</a>(xout, recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>, xp, alpha);
<a name="l00448"></a>00448     dcellfree(xp);
<a name="l00449"></a>00449 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f3f1b61e90e1b7f99f0ef80960511f8b"></a><!-- doxytag: member="recon.c::moao_FitL" ref="f3f1b61e90e1b7f99f0ef80960511f8b" args="(dcell **xout, const void *A, const dcell *xin, const double alpha)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void moao_FitL           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdcell.html">dcell</a> **&nbsp;</td>
          <td class="paramname"> <em>xout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structdcell.html">dcell</a> *&nbsp;</td>
          <td class="paramname"> <em>xin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>alpha</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Apply fit left hand side matrix in CG mode without using assembled matrix. 
<p>
Slow. don't use. Assembled matridx is faster because of multiple directions. <div class="fragment"><pre class="fragment"><a name="l00459"></a>00459                                            {
<a name="l00460"></a>00460     <span class="keyword">const</span> <a class="code" href="structMOAO__T.html" title="contains MOAO related data">MOAO_T</a> *moao=(<span class="keyword">const</span> <a class="code" href="structMOAO__T.html" title="contains MOAO related data">MOAO_T</a> *)A;
<a name="l00461"></a>00461     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *xp=NULL;
<a name="l00462"></a>00462     <span class="keywordtype">double</span> wt=1;
<a name="l00463"></a>00463     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(&amp;xp, moao-&gt;<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>, xin, 1.);
<a name="l00464"></a>00464     <a class="code" href="recon__utils_8c.html#ac31a93d205900027f62a385a321de0b" title="apply weighting W0/W1 with weighting wt for each block.">applyW</a>(xp, moao-&gt;<a class="code" href="structMOAO__T.html#5514e32cd4b953c45006a49ff429254c">W0</a>, moao-&gt;<a class="code" href="structMOAO__T.html#cc34b6bf2dc67f5346fe6d040bc699b0">W1</a>, &amp;wt);
<a name="l00465"></a>00465     <a class="code" href="dsp_8h.html#730a5070a85111231144cdd535a9f952" title="C=C+A&amp;#39;*B*alpha.">sptcellmulmat</a>(xout, moao-&gt;<a class="code" href="structMOAO__T.html#51d7142e549668b6838d7a971d1ec6cf">HA</a>, xp, alpha);
<a name="l00466"></a>00466     dcellfree(xp);xp=NULL;
<a name="l00467"></a>00467     dcellmm(&amp;xp, moao-&gt;<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>, xin, <span class="stringliteral">"tn"</span>, 1);
<a name="l00468"></a>00468     dcellmm(xout,moao-&gt;<a class="code" href="structMOAO__T.html#18a8d037759579b4bc6550e0df533c90">NW</a>, xp, <span class="stringliteral">"nn"</span>, alpha);
<a name="l00469"></a>00469     dcellfree(xp);
<a name="l00470"></a>00470     <a class="code" href="dsp_8h.html#8d54733ac98a65ca9f99c97713362125" title="Multiply a spcell with a dense cell: C=C+A*B*alpha.">spcellmulmat</a>(xout, moao-&gt;<a class="code" href="structMOAO__T.html#160a87d30e1b9b6532241adc70f7f3c3">actslave</a>, xin, alpha);
<a name="l00471"></a>00471 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f62a4685464fea7bdd37d04c821c3caf"></a><!-- doxytag: member="recon.c::moao_recon" ref="f62a4685464fea7bdd37d04c821c3caf" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void moao_recon           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
mao_recon happens after the common DM fitting and its integrator output to take into account the delay in DM commands. 
<p>
there is no close loop filtering in MOAO DM commands, but there is still a time delay of 2 cycles. <div class="fragment"><pre class="fragment"><a name="l00479"></a>00479                             {
<a name="l00480"></a>00480     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00481"></a>00481     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00482"></a>00482     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmcommon=NULL;
<a name="l00483"></a>00483     <span class="keywordflow">if</span>(1){<span class="comment">//Take OL result</span>
<a name="l00484"></a>00484     dcellcp(&amp;dmcommon, simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a>);
<a name="l00485"></a>00485     }<span class="keywordflow">else</span>{<span class="comment">//CL result</span>
<a name="l00486"></a>00486     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a>){
<a name="l00487"></a>00487         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00488"></a>00488         dcellcp(&amp;dmcommon, simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>[0]);
<a name="l00489"></a>00489         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00490"></a>00490             <a class="code" href="recon_8c.html#511ecedaadb45f492744ecb02a1d06de" title="remove NGS modes from LGS DM commands if split_wt==1 Rngs*GA*dmerr is zero if split_wt==2...">remove_dm_ngsmod</a>(simu, dmcommon);
<a name="l00491"></a>00491         }
<a name="l00492"></a>00492         }<span class="keywordflow">else</span>{
<a name="l00493"></a>00493         dcellcp(&amp;dmcommon, simu-&gt;<a class="code" href="structSIM__T.html#bddc06629ca1d3fd07bba2db8e50be47">dmint_hi</a>[0]);
<a name="l00494"></a>00494         <span class="comment">//addlow2dm(&amp;dmcommon, simu,simu-&gt;Mint_lo[0], 1);</span>
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496     }<span class="keywordflow">else</span>{
<a name="l00497"></a>00497         dcellcp(&amp;dmcommon, simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>);
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500     <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *rhs=NULL;
<a name="l00501"></a>00501     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>){
<a name="l00502"></a>00502     PDCELL(simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>, dmwfs);
<a name="l00503"></a>00503     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00504"></a>00504         <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00505"></a>00505         <span class="keywordtype">int</span> imoao=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#5b96a7a535d6e320913d8821a41a8423" title="index into MOAO struct.">moao</a>;
<a name="l00506"></a>00506         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmmoao=NULL;
<a name="l00507"></a>00507         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *rhsout=NULL;
<a name="l00508"></a>00508         <span class="keywordflow">if</span>(imoao&gt;-1){
<a name="l00509"></a>00509         <span class="keywordtype">double</span> hs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>;
<a name="l00510"></a>00510         dcellzero(rhs);
<a name="l00511"></a>00511         <a class="code" href="recon_8c.html#5a08339d5c9a918e99995b4dd016aa91" title="Apply fit right hand side matrix in CG mode without using assembled matrix for MOAO...">moao_FitR</a>(&amp;rhs, recon, parms,  imoao, 
<a name="l00512"></a>00512               parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>, parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>, 
<a name="l00513"></a>00513               hs, simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>, dmcommon, &amp;rhsout, 1);
<a name="l00514"></a>00514         pcg(&amp;dmmoao, <a class="code" href="recon_8c.html#f3f1b61e90e1b7f99f0ef80960511f8b" title="Apply fit left hand side matrix in CG mode without using assembled matrix.">moao_FitL</a>, &amp;recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao], NULL, NULL, rhs, 
<a name="l00515"></a>00515             1, parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4533eef0ce553366cefd0e2d02de4b2d" title="max iterations.">maxit</a>);
<a name="l00516"></a>00516         <span class="keywordflow">if</span>(!isinf(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#1b1ca7610bf9f5c71664e582d83d6604" title="Stroke of the MOAO DM.">stroke</a>)){
<a name="l00517"></a>00517             <span class="keywordtype">int</span> nclip=<a class="code" href="dmat_8h.html#30e08db08cab036374dc0635df4665d6" title="Limit numbers in A to within [min, max].">dclip</a>(dmmoao-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0],
<a name="l00518"></a>00518                     -parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#1b1ca7610bf9f5c71664e582d83d6604" title="Stroke of the MOAO DM.">stroke</a>,
<a name="l00519"></a>00519                     parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#1b1ca7610bf9f5c71664e582d83d6604" title="Stroke of the MOAO DM.">stroke</a>);
<a name="l00520"></a>00520             <span class="keywordflow">if</span>(nclip&gt;0){
<a name="l00521"></a>00521             info(<span class="stringliteral">"wfs %d: %d actuators clipped\n"</span>, iwfs, nclip);
<a name="l00522"></a>00522             }
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524         <a class="code" href="recon_8c.html#c1922d6404880ae75380e8c876e55044" title="cyclic shift the dmats.">shift_ring</a>(simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>, dmwfs[iwfs], dmmoao-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]);
<a name="l00525"></a>00525         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a>){
<a name="l00526"></a>00526             <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"MOAO WFS RHS"</span>, recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, rhsout-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 
<a name="l00527"></a>00527                 <span class="stringliteral">"MOAO for WFS"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y(m)"</span>, <span class="stringliteral">"Wfs rhs %d"</span>, iwfs);
<a name="l00528"></a>00528             <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"MOAO WFS"</span>, recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, dmmoao-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00529"></a>00529                 <span class="stringliteral">"MOAO for WFS"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y(m)"</span>, <span class="stringliteral">"Wfs %d"</span>, iwfs);
<a name="l00530"></a>00530         }
<a name="l00531"></a>00531         dcellfree(rhsout);
<a name="l00532"></a>00532         dcellfree(dmmoao);
<a name="l00533"></a>00533         }<span class="comment">//if imoao</span>
<a name="l00534"></a>00534     }<span class="comment">//if wfs</span>
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#34a4c23843708f2e41eae5d31718112a" title="save run time informaton for each time step">run</a>){
<a name="l00537"></a>00537         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#40ec16c1de056c1350fa3bda4ca65da1">moao_wfs</a>,<span class="stringliteral">"moao_%d/moao_wfs_%d"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>, simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540     <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#b637adfa4528f55e986cfc7df75f2b01">moao_evl</a>){
<a name="l00541"></a>00541     PDCELL(simu-&gt;<a class="code" href="structSIM__T.html#b637adfa4528f55e986cfc7df75f2b01">moao_evl</a>, dmevl);
<a name="l00542"></a>00542     <span class="keywordtype">int</span> imoao=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#529a8acf247028c9e66cbe87c6edd84e" title="index into MOAO struct.">moao</a>;
<a name="l00543"></a>00543     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00544"></a>00544         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmmoao=dcellnew(1,1);
<a name="l00545"></a>00545         dmmoao-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]=<a class="code" href="dmat_8h.html#7ecadca31195b8b40135b7dbeb808906" title="duplicate a X(mat) array">ddup</a>(dmevl[ievl][0]);<span class="comment">//warm restart.</span>
<a name="l00546"></a>00546         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *rhsout=NULL;
<a name="l00547"></a>00547         dcellzero(rhs);
<a name="l00548"></a>00548         <a class="code" href="recon_8c.html#5a08339d5c9a918e99995b4dd016aa91" title="Apply fit right hand side matrix in CG mode without using assembled matrix for MOAO...">moao_FitR</a>(&amp;rhs, recon, parms, imoao, 
<a name="l00549"></a>00549               parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl], parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl],
<a name="l00550"></a>00550               INFINITY, simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>, dmcommon, &amp;rhsout, 1);
<a name="l00551"></a>00551         
<a name="l00552"></a>00552         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#34a4c23843708f2e41eae5d31718112a" title="save run time informaton for each time step">run</a>){
<a name="l00553"></a>00553         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(rhsout-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0],<span class="stringliteral">"moao_%d/moao_rhs_evl%d_%d"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,ievl,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00554"></a>00554         }
<a name="l00555"></a>00555         pcg(&amp;dmmoao, <a class="code" href="recon_8c.html#f3f1b61e90e1b7f99f0ef80960511f8b" title="Apply fit left hand side matrix in CG mode without using assembled matrix.">moao_FitL</a>, &amp;recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao], NULL, NULL, rhs,
<a name="l00556"></a>00556         1, parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4533eef0ce553366cefd0e2d02de4b2d" title="max iterations.">maxit</a>);
<a name="l00557"></a>00557         <span class="keywordflow">if</span>(!isinf(parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#1b1ca7610bf9f5c71664e582d83d6604" title="Stroke of the MOAO DM.">stroke</a>)){
<a name="l00558"></a>00558         <span class="keywordtype">int</span> nclip=<a class="code" href="dmat_8h.html#30e08db08cab036374dc0635df4665d6" title="Limit numbers in A to within [min, max].">dclip</a>(dmmoao-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0],
<a name="l00559"></a>00559                 -parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#1b1ca7610bf9f5c71664e582d83d6604" title="Stroke of the MOAO DM.">stroke</a>,
<a name="l00560"></a>00560                 parms-&gt;<a class="code" href="structPARMS__T.html#2de7b678eb1df1bcc6fd4af8a3340fd0" title="Array of MOAO.">moao</a>[imoao].<a class="code" href="structMOAO__CFG__T.html#1b1ca7610bf9f5c71664e582d83d6604" title="Stroke of the MOAO DM.">stroke</a>);
<a name="l00561"></a>00561         <span class="keywordflow">if</span>(nclip&gt;0){
<a name="l00562"></a>00562             info(<span class="stringliteral">"evl %d: %d actuators clipped\n"</span>, ievl, nclip);
<a name="l00563"></a>00563         }
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565         <a class="code" href="recon_8c.html#c1922d6404880ae75380e8c876e55044" title="cyclic shift the dmats.">shift_ring</a>(simu-&gt;<a class="code" href="structSIM__T.html#b637adfa4528f55e986cfc7df75f2b01">moao_evl</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>, dmevl[ievl], dmmoao-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]);
<a name="l00566"></a>00566         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a>){
<a name="l00567"></a>00567         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"MOAO EVL RHS"</span>, recon-&gt;<a class="code" href="structRECON__T.html#ed60e4b55311547421d1e84b56bba36f">ploc</a>, rhsout-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 
<a name="l00568"></a>00568             <span class="stringliteral">"MOAO for WFS"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y(m)"</span>, <span class="stringliteral">"Evl %d"</span>, ievl);
<a name="l00569"></a>00569         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"MOAO EVL"</span>, recon-&gt;<a class="code" href="structRECON__T.html#da6266bf34011ea0bdf22ad4863dca9b">moao</a>[imoao].<a class="code" href="structMOAO__T.html#79a3e21d8953ba5034820ecc3957b9ca">aloc</a>, dmevl[ievl][0]-&gt;p,
<a name="l00570"></a>00570             <span class="stringliteral">"MOAO for EVL"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y(m)"</span>, <span class="stringliteral">"Evl %d"</span>, ievl);
<a name="l00571"></a>00571         }
<a name="l00572"></a>00572         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#758d4e6367bf5ecb3574be68505cf7d0" title="save computed DM actuator commands for each time step">dm</a>){
<a name="l00573"></a>00573         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(rhsout-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0], <span class="stringliteral">"moao_evlrhs_%d_%d"</span>, imoao, simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00574"></a>00574         <a class="code" href="dmat_8h.html#37ebad9e8c582e694664b562a78114d2" title="User callable function to write dense matrix into a file.">dwrite</a>(dmmoao-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0], <span class="stringliteral">"moao_evl_%d_%d"</span>, imoao, simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         dcellfree(dmmoao);
<a name="l00577"></a>00577         dcellfree(rhsout);
<a name="l00578"></a>00578     }<span class="comment">//ievl</span>
<a name="l00579"></a>00579     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#34a4c23843708f2e41eae5d31718112a" title="save run time informaton for each time step">run</a>){
<a name="l00580"></a>00580         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#b637adfa4528f55e986cfc7df75f2b01">moao_evl</a>,<span class="stringliteral">"moao_%d/moao_evl_%d"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583     dcellfree(dmcommon);
<a name="l00584"></a>00584     dcellfree(rhs);
<a name="l00585"></a>00585 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="17defa53668245c14cd494b9fab761f1"></a><!-- doxytag: member="recon.c::tomofit" ref="17defa53668245c14cd494b9fab761f1" args="(SIM_T *simu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void tomofit           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSIM__T.html">SIM_T</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calls <a class="el" href="recon_8c.html#44159203334924b9277408e81a49a893" title="Carry out tomography.">tomo()</a> and <a class="el" href="recon_8c.html#861c4d9312ead5560557940f35618e17" title="Carry out DM fit.">fit()</a> to do the tomography and DM fit. 
<p>
Do error signal and split tomography. <div class="fragment"><pre class="fragment"><a name="l00589"></a>00589                          {
<a name="l00590"></a>00590     <span class="keyword">const</span> <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> *parms=simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>;
<a name="l00591"></a>00591     <span class="keyword">const</span> <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> *recon=simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>;
<a name="l00592"></a>00592     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a> || parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#8c69a219924faa60ddf33137b2d35633" title="do DM fitting only, by replacing opdr with opdx.">fitonly</a> || 
<a name="l00593"></a>00593        simu-&gt;<a class="code" href="structSIM__T.html#1a656b8e93b33589d4899dc65c098e52">dtrat_hi</a>==1 || (simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>+1)%simu-&gt;<a class="code" href="structSIM__T.html#1a656b8e93b33589d4899dc65c098e52">dtrat_hi</a>==0){
<a name="l00594"></a>00594     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#8c69a219924faa60ddf33137b2d35633" title="do DM fitting only, by replacing opdr with opdx.">fitonly</a>){
<a name="l00595"></a>00595         dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>);
<a name="l00596"></a>00596         simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>=<a class="code" href="sim__utils_8c.html#5332882aafbf641fbc3da4c956ae3d96" title="Propagate the atmosphere to closest xloc.">atm2xloc</a>(simu);
<a name="l00597"></a>00597     }<span class="keywordflow">else</span>{
<a name="l00598"></a>00598         <a class="code" href="recon_8c.html#44159203334924b9277408e81a49a893" title="Carry out tomography.">tomo</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>,parms,recon,simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>);
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#ca7b490ba52cfa6226d84a4248cfc65b" title="estimate wind.">windest</a>){
<a name="l00601"></a>00601         info2(<span class="stringliteral">"Estimating wind direction and speed using FFT method\n"</span>);
<a name="l00602"></a>00602         <a class="code" href="recon_8c.html#4312f074d4f65a3b3258c6e29f22578f" title="Experimental routine to do wind estimation using correlation tracking of tomography...">windest</a>(simu);
<a name="l00603"></a>00603         <span class="comment">//Update wind, and interpolation matrix.</span>
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b55475bb28aee1940de2fe860707e33f" title="shift opdr using wind velocity (from input if windest=0)">windshift</a>){
<a name="l00606"></a>00606         <span class="keywordtype">int</span> factor=parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#b55475bb28aee1940de2fe860707e33f" title="shift opdr using wind velocity (from input if windest=0)">windshift</a>;
<a name="l00607"></a>00607         <span class="keywordflow">if</span>(!simu-&gt;<a class="code" href="structSIM__T.html#c13a335178113fe760f472df5990463b">windshift</a>){
<a name="l00608"></a>00608         simu-&gt;<a class="code" href="structSIM__T.html#c13a335178113fe760f472df5990463b">windshift</a>=<a class="code" href="dsp_8h.html#af5362fa0fc6afc00fc3af29e4fb536d" title="Create a new sparse cell.">spcellnew</a>(recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>, 1);
<a name="l00609"></a>00609         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>; ips++){
<a name="l00610"></a>00610             <span class="keywordtype">double</span> dispx=simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>*simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>[ips]-&gt;<a class="code" href="structMAP__T.html#0e1501d3055f92d8013c7f9e28b7dada">vx</a>*factor;<span class="comment">//2 is two cycle delay.</span>
<a name="l00611"></a>00611             <span class="keywordtype">double</span> dispy=simu-&gt;<a class="code" href="structSIM__T.html#083c2102dc1e5f022aee842e76e25a75">dt</a>*simu-&gt;<a class="code" href="structSIM__T.html#6a36b9c3590a438ecb1985dfaf33cb58">atm</a>[ips]-&gt;<a class="code" href="structMAP__T.html#18114c94e58dd22db69cb1cfbc050623">vy</a>*factor;
<a name="l00612"></a>00612             info(<span class="stringliteral">"ips=%d: dispx=%g, dispy=%g\n"</span>, ips, dispx, dispy);
<a name="l00613"></a>00613             simu-&gt;<a class="code" href="structSIM__T.html#c13a335178113fe760f472df5990463b">windshift</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips]=<a class="code" href="mkh_8c.html#ab2a5c3f1e01e34f9f9befd6813451ad" title="Create transpose of mkh() result.">mkhb</a>(recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips], recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[ips], NULL,
<a name="l00614"></a>00614                          dispx,dispy,1,0,0);
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         <a class="code" href="dmat_8h.html#fa58b8e2aea2a94ae0422ede37957a0f" title="User callable function to write cell array of sparse matrix into file.">spcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#c13a335178113fe760f472df5990463b">windshift</a>,<span class="stringliteral">"windshift"</span>);
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618         info2(<span class="stringliteral">"Using wind information to shift opdr by %d v*dt.\n"</span>, factor);
<a name="l00619"></a>00619         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ips=0; ips&lt;recon-&gt;<a class="code" href="structRECON__T.html#85cbd136845ab75a8af2e315bd6be75e">npsr</a>; ips++){
<a name="l00620"></a>00620         <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *tmp=simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips];
<a name="l00621"></a>00621         simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips]=NULL;
<a name="l00622"></a>00622         <a class="code" href="dsp_8h.html#4c30a51c7a0d15e4ff0e58bdbc43c932" title="Multiply a sparse matrix X(sp) with a dense matrix X(mat).">spmulmat</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ips], simu-&gt;<a class="code" href="structSIM__T.html#c13a335178113fe760f472df5990463b">windshift</a>-&gt;<a class="code" href="structspcell.html#43b142bc607510084f627498b7b0431b" title="Contains an array of pointers to dsp.">p</a>[ips], tmp, 1);
<a name="l00623"></a>00623         dfree(tmp);
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <a class="code" href="recon_8c.html#861c4d9312ead5560557940f35618e17" title="Carry out DM fit.">fit</a>(&amp;simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a>,parms,recon,simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>);
<a name="l00628"></a>00628     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#a4595ac42f4762887f4e9cf9b4b926fb" title="save reconstructed OPD on XLOC for each time step">opdr</a>){
<a name="l00629"></a>00629         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>,<span class="stringliteral">"opdr_%d/opdr_%d.bin"</span>, simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#5eca85a138e0b80cd41732e70a9f61f9" title="save ATM propagated to XLOC for each time step">opdx</a>){
<a name="l00632"></a>00632         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *opdx=<a class="code" href="sim__utils_8c.html#5332882aafbf641fbc3da4c956ae3d96" title="Propagate the atmosphere to closest xloc.">atm2xloc</a>(simu);
<a name="l00633"></a>00633         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(opdx,<span class="stringliteral">"opdx_%d/opdx_%d.bin.gz"</span>,simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00634"></a>00634         dcellfree(opdx);
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#758d4e6367bf5ecb3574be68505cf7d0" title="save computed DM actuator commands for each time step">dm</a>){
<a name="l00637"></a>00637         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a>,<span class="stringliteral">"dmfit_hi_%d/dmfit_hi_%d.bin.gz"</span>,
<a name="l00638"></a>00638                simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640     <span class="comment">//Ploting.</span>
<a name="l00641"></a>00641     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a>){
<a name="l00642"></a>00642         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a> &amp;&amp; i&lt;simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>; i++){
<a name="l00643"></a>00643         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"Recon"</span>, recon-&gt;<a class="code" href="structRECON__T.html#36b84d627a34e401174d98e5a2daaafe">xloc</a>[i], simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[i]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>, 
<a name="l00644"></a>00644             <span class="stringliteral">"Reconstructed Atmosphere"</span>,<span class="stringliteral">"x (m)"</span>,<span class="stringliteral">"y (m)"</span>,<span class="stringliteral">"opdr %d"</span>,i);
<a name="l00645"></a>00645         }
<a name="l00646"></a>00646         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a> &amp;&amp; i&lt;simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a>-&gt;<a class="code" href="structdcell.html#c88fed44e9f978c6757ec8dfcfb31589" title="number of rows">nx</a>; i++){
<a name="l00647"></a>00647         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"DM"</span>, recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[i], simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[i]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00648"></a>00648             <span class="stringliteral">"DM Fitting Output"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y (m)"</span>,<span class="stringliteral">"Fit %d"</span>,i);
<a name="l00649"></a>00649         }
<a name="l00650"></a>00650         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a> &amp;&amp; idm&lt;simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00651"></a>00651         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"DM"</span>, simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], simu-&gt;<a class="code" href="structSIM__T.html#e4b9c297eaa0b2ceb57bb9885caef135">dmreal</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00652"></a>00652             <span class="stringliteral">"Actual DM Actuator Commands"</span>,<span class="stringliteral">"x (m)"</span>, <span class="stringliteral">"y (m)"</span>,
<a name="l00653"></a>00653             <span class="stringliteral">"Real %d"</span>,idm);
<a name="l00654"></a>00654         }
<a name="l00655"></a>00655     }
<a name="l00656"></a>00656     dcellcp(&amp;simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>, simu-&gt;<a class="code" href="structSIM__T.html#d248dc53ba37345772d26a2ea1e32472">dmfit_hi</a>);<span class="comment">//keep dmfit_hi for warm restart</span>
<a name="l00657"></a>00657     
<a name="l00658"></a>00658     <span class="comment">/*</span>
<a name="l00659"></a>00659 <span class="comment">      Forming LGS error signal.</span>
<a name="l00660"></a>00660 <span class="comment">      2010-01-07: changed dmreal_hi to dmreal to comply with</span>
<a name="l00661"></a>00661 <span class="comment">      the block diagram. This is before NGS mode removal</span>
<a name="l00662"></a>00662 <span class="comment">      keep dmfit for warm restart. </span>
<a name="l00663"></a>00663 <span class="comment">    */</span>
<a name="l00664"></a>00664  
<a name="l00665"></a>00665     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00666"></a>00666         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#db4659b6270e082c56fc70db6d1f24da" title="test add dm command offseted by 1 frame in the future to psol grad">psol</a>){
<a name="l00667"></a>00667         warning(<span class="stringliteral">"Using dm for next step to form err signal\n"</span>);
<a name="l00668"></a>00668         dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>, 1., simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>[0], -1);
<a name="l00669"></a>00669         }<span class="keywordflow">else</span>{
<a name="l00670"></a>00670         dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>, 1., simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>[1], -1);
<a name="l00671"></a>00671         }
<a name="l00672"></a>00672     }<span class="keywordflow">else</span>{<span class="comment"></span>
<a name="l00673"></a>00673 <span class="comment">        /**</span>
<a name="l00674"></a>00674 <span class="comment">           2010-07-23: Moved remove_dm_ngsmod to after forming error signal. </span>
<a name="l00675"></a>00675 <span class="comment">        */</span>
<a name="l00676"></a>00676         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#db4659b6270e082c56fc70db6d1f24da" title="test add dm command offseted by 1 frame in the future to psol grad">psol</a>){
<a name="l00677"></a>00677         warning(<span class="stringliteral">"Using dm for next step to form err signal\n"</span>);
<a name="l00678"></a>00678         dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>, 1., simu-&gt;<a class="code" href="structSIM__T.html#bddc06629ca1d3fd07bba2db8e50be47">dmint_hi</a>[0], -1);
<a name="l00679"></a>00679         }<span class="keywordflow">else</span>{
<a name="l00680"></a>00680         dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>, 1., simu-&gt;<a class="code" href="structSIM__T.html#bddc06629ca1d3fd07bba2db8e50be47">dmint_hi</a>[1], -1);
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#758d4e6367bf5ecb3574be68505cf7d0" title="save computed DM actuator commands for each time step">dm</a>){
<a name="l00685"></a>00685         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>,<span class="stringliteral">"dmerr_hi_%d/dmerr_hi_%d_raw.bin.gz"</span>,
<a name="l00686"></a>00686                simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00687"></a>00687         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00688"></a>00688         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>[0],<span class="stringliteral">"dmint_%d/dmint_%d.bin"</span>,
<a name="l00689"></a>00689                simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00690"></a>00690         }<span class="keywordflow">else</span>{
<a name="l00691"></a>00691         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#bddc06629ca1d3fd07bba2db8e50be47">dmint_hi</a>[0],<span class="stringliteral">"dmint_hi_%d/dmint_hi_%d.bin"</span>,
<a name="l00692"></a>00692                simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);   
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#8c69a219924faa60ddf33137b2d35633" title="do DM fitting only, by replacing opdr with opdx.">fitonly</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==1){<span class="comment">//ahst</span>
<a name="l00697"></a>00697         <a class="code" href="recon_8c.html#511ecedaadb45f492744ecb02a1d06de" title="remove NGS modes from LGS DM commands if split_wt==1 Rngs*GA*dmerr is zero if split_wt==2...">remove_dm_ngsmod</a>(simu, simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>);
<a name="l00698"></a>00698     }
<a name="l00699"></a>00699     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#34e9b29344aab2d74ce12502e1c2e717" title="remote tip/tilt in high order DM fit output in split mode">split_rtt</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00700"></a>00700         <a class="code" href="recon_8c.html#83953e6f6306cb14c5ad00854c8df2b4" title="Removal tip/tilt on invidual DMs.">remove_dm_tt</a>(simu, simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>);
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702     
<a name="l00703"></a>00703     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#758d4e6367bf5ecb3574be68505cf7d0" title="save computed DM actuator commands for each time step">dm</a>){
<a name="l00704"></a>00704         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>,<span class="stringliteral">"dmerr_hi_%d/dmerr_hi_%d_net.bin.gz"</span>,
<a name="l00705"></a>00705                simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a>){
<a name="l00708"></a>00708         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00709"></a>00709         <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"DM"</span>,recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], simu-&gt;<a class="code" href="structSIM__T.html#a70fe28180281a0771c8c2d17ff63e50">dmerr_hi</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00710"></a>00710             <span class="stringliteral">"DM Error Signal (Hi)"</span>,<span class="stringliteral">"x (m)"</span>,<span class="stringliteral">"y (m)"</span>,
<a name="l00711"></a>00711             <span class="stringliteral">"Err Hi %d"</span>,idm);
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714     }<span class="comment">//if high order has output</span>
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#8c69a219924faa60ddf33137b2d35633" title="do DM fitting only, by replacing opdr with opdx.">fitonly</a> &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00717"></a>00717     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==2){
<a name="l00718"></a>00718         info(<span class="stringliteral">"accumulating opdrmvst\n"</span>);
<a name="l00719"></a>00719         dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#fe6605f55d778938848f8e7caccac524">opdrmvst</a>, 1, simu-&gt;<a class="code" href="structSIM__T.html#2f33626ab1590a06d8897380abb49c00">opdr</a>, 1./simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>);
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721     <span class="comment">//Low order</span>
<a name="l00722"></a>00722     <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#0408bb89e89669682cba86f7fb98b2dc" title="closed loop or open loop">closeloop</a> || simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>==1 || (simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>+1)%simu-&gt;<a class="code" href="structSIM__T.html#9f39b6479237b645bd05cc13cf4b7e7c">dtrat_lo</a>==0){
<a name="l00723"></a>00723         dcellzero(simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>);
<a name="l00724"></a>00724         <span class="keywordflow">switch</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00725"></a>00725         <span class="keywordflow">case</span> 1:{
<a name="l00726"></a>00726         <a class="code" href="structNGSMOD__T.html" title="NGS mode in ad hoc split tomography.">NGSMOD_T</a> *ngsmod=recon-&gt;<a class="code" href="structRECON__T.html#9fbf97b35015b06fdd972be4bb0f31b0">ngsmod</a>;
<a name="l00727"></a>00727         <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#a518c9befdd8bd0bb179ef516ff20f19" title="ideal correction on NGS modes.">split_idealngs</a>){<span class="comment">//Low order NGS recon.</span>
<a name="l00728"></a>00728             dcellmm(&amp;simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>,ngsmod-&gt;<a class="code" href="structNGSMOD__T.html#514dd751c537bb91de904edc719535df">Rngs</a>,simu-&gt;<a class="code" href="structSIM__T.html#1ce78a265b859aa46fe4bd4d055073e8">gradcl</a>,<span class="stringliteral">"nn"</span>,1);
<a name="l00729"></a>00729         }<span class="comment">//else: there is ideal NGS correction done in perfevl.</span>
<a name="l00730"></a>00730         }
<a name="l00731"></a>00731         <span class="keywordflow">break</span>;
<a name="l00732"></a>00732         <span class="keywordflow">case</span> 2:{
<a name="l00733"></a>00733         dcellmm(&amp;simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>, recon-&gt;<a class="code" href="structRECON__T.html#1aeb7777279f592934223920ff4be2f3">G0L</a>, simu-&gt;<a class="code" href="structSIM__T.html#fe6605f55d778938848f8e7caccac524">opdrmvst</a>, <span class="stringliteral">"nn"</span>,-1);
<a name="l00734"></a>00734         dcellmm(&amp;simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>, recon-&gt;<a class="code" href="structRECON__T.html#5902b35daad9b93ccabda9abd74373dc">MVRngs</a>, simu-&gt;<a class="code" href="structSIM__T.html#d6da04a1c5a9dcaa24db9167ed1a8014">gradpsol</a>, <span class="stringliteral">"nn"</span>,1);
<a name="l00735"></a>00735         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#16a3a1b709068ad2f3ed43b343cce6d6" title="fuse the high and low order integrators in split tomography">fuseint</a>){
<a name="l00736"></a>00736             dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>, 1., simu-&gt;<a class="code" href="structSIM__T.html#de7f377f433b1b9f08b9b8fc01624cba">dmint</a>[1], -1);
<a name="l00737"></a>00737             error(<span class="stringliteral">"This mode is not finished\n"</span>);
<a name="l00738"></a>00738         }<span class="keywordflow">else</span>{<span class="comment">//form error signal</span>
<a name="l00739"></a>00739             dcelladd(&amp;simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>, 1., simu-&gt;<a class="code" href="structSIM__T.html#d8fad0a83bdeed5dc290068f05bd8b0b">Mint_lo</a>[1], -1);
<a name="l00740"></a>00740         }
<a name="l00741"></a>00741         dcellzero(simu-&gt;<a class="code" href="structSIM__T.html#fe6605f55d778938848f8e7caccac524">opdrmvst</a>);info(<span class="stringliteral">"zero opdrmvst\n"</span>);
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743         <span class="keywordflow">break</span>;
<a name="l00744"></a>00744         <span class="keywordflow">default</span>:
<a name="l00745"></a>00745         error(<span class="stringliteral">"Invalid parms-&gt;tomo.split: %d"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>);
<a name="l00746"></a>00746         }
<a name="l00747"></a>00747         <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8d13a796ed190abb42f190c74d52b5b1" title="Specify what to plot during simulation.">plot</a>.<a class="code" href="structPLOT__CFG__T.html#08ef54666c6518cc32abea8ad20b02bb" title="Plot information during simulation.">run</a> &amp;&amp; simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>){
<a name="l00748"></a>00748         <a class="code" href="structdcell.html" title="an 2-d block matrix of dmat.">dcell</a> *dmlo=NULL;
<a name="l00749"></a>00749         <span class="keywordflow">switch</span>(simu-&gt;<a class="code" href="structSIM__T.html#085df4ec8f2e9f439643ca1fff3db942">parms</a>-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>){
<a name="l00750"></a>00750         <span class="keywordflow">case</span> 1:
<a name="l00751"></a>00751             <a class="code" href="ahst_8c.html#3d2a474cd4a6fcebb9e1ff8f26855353" title="Convert NGS modes to DM actuator commands using analytical expression.">ngsmod2dm</a>(&amp;dmlo, recon, simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>, 1);
<a name="l00752"></a>00752             <span class="keywordflow">break</span>;
<a name="l00753"></a>00753         <span class="keywordflow">case</span> 2:
<a name="l00754"></a>00754             dcellmm(&amp;dmlo, simu-&gt;<a class="code" href="structSIM__T.html#632412546828fc6e45a9538c42f9ed53">recon</a>-&gt;<a class="code" href="structRECON__T.html#e0bc4bd022b5ea5b29f544b7efbef70e">MVModes</a>, simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>, <span class="stringliteral">"nn"</span>, 1);
<a name="l00755"></a>00755             <span class="keywordflow">break</span>;
<a name="l00756"></a>00756         }
<a name="l00757"></a>00757         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idm=0; idm&lt;parms-&gt;<a class="code" href="structPARMS__T.html#6492c3b89e0243fe23d88ebedb044b0e" title="Number of DMs.">ndm</a>; idm++){
<a name="l00758"></a>00758             <a class="code" href="draw_8c.html#ea2a96b41c5f08d3929a3f451e46feb3" title="Plot the opd using coordinate loc.">drawopd</a>(<span class="stringliteral">"DM"</span>,recon-&gt;<a class="code" href="structRECON__T.html#f3c06f40df1bcd845129fc9944f438ed">aloc</a>[idm], dmlo-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[idm]-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>,
<a name="l00759"></a>00759                 <span class="stringliteral">"DM Error Signal (Lo)"</span>,<span class="stringliteral">"x (m)"</span>,<span class="stringliteral">"y (m)"</span>,
<a name="l00760"></a>00760                 <span class="stringliteral">"Err Lo %d"</span>,idm);
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762         dcellfree(dmlo);
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764     }<span class="keywordflow">else</span>{
<a name="l00765"></a>00765         dcellfree(simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>);<span class="comment">//don't have output.</span>
<a name="l00766"></a>00766     }
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#758d4e6367bf5ecb3574be68505cf7d0" title="save computed DM actuator commands for each time step">dm</a>){
<a name="l00769"></a>00769         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#9fcd4a9ae6ec0828b3e6700dfe52730d">Merr_lo</a>, <span class="stringliteral">"Merr_lo_%d/Merr_lo_%d"</span>, simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00770"></a>00770         <span class="keywordflow">if</span>(simu-&gt;<a class="code" href="structSIM__T.html#d8fad0a83bdeed5dc290068f05bd8b0b">Mint_lo</a>){
<a name="l00771"></a>00771         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(simu-&gt;<a class="code" href="structSIM__T.html#d8fad0a83bdeed5dc290068f05bd8b0b">Mint_lo</a>[0], <span class="stringliteral">"Mint_lo_%d/Mint_lo_%d"</span>, simu-&gt;<a class="code" href="structSIM__T.html#57edb71c63c975b466252cc9d9322b14">seed</a>,simu-&gt;<a class="code" href="structSIM__T.html#04f684f8fb2c48643e6fcaa4bbf519a8">isim</a>);
<a name="l00772"></a>00772         }
<a name="l00773"></a>00773     }
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#bf0ce35fd4cdfa16eefa42aea7c3300e" title="method for focus tracing.">mffocus</a>){
<a name="l00776"></a>00776     <a class="code" href="recon_8c.html#3c8efd1ec94a9fdaae9021172da85d7a" title="Update LGS focus or reference vector.">focus_tracking</a>(simu);
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 21:16:58 2010 for maos-0.7.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
