<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.7.0: maos/utils.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/utils.c File Reference</h1>A few utility routines.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#5a2e23d34ba0e7d3614bd42f5eb8ccaa">addnoise</a> (<a class="el" href="structdmat.html">dmat</a> *A, <a class="el" href="structmt__state.html">mt_state</a> *rstat, const double bkgrnd, const double pcalib, const double *bkgrnd2, const double pcalib2, const double rne)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">add photon and read out noise.  <a href="#5a2e23d34ba0e7d3614bd42f5eb8ccaa"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structMAP__T.html">MAP_T</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#aba5a9d494e2fc4ef56edd11248b41e9">create_metapupil_wrap</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, double ht, double dx, double offset, double guard, long nin, T_TYPE type, int pad, int square)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calls create_metapupil is simplified interface by returning a <a class="el" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> object.  <a href="#aba5a9d494e2fc4ef56edd11248b41e9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#480912f463af16b1beec7b915c32acde">create_metapupil</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, double ht, double dx, double offset, long *nxout, long *nyout, double *oxout, double *oyout, double **map, double guard, long nin, T_TYPE type, int pad, int square)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">create a metapupil map, with size nx*ny, origin at (ox,oy), sampling of dx, height of ht, that can cover all the WFS and science beams.  <a href="#480912f463af16b1beec7b915c32acde"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#ed87a0850d278bb80fe6906e7a8fa6f6">plotloc</a> (char *fig, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, <a class="el" href="structLOC__T.html">LOC_T</a> *loc, double ht, char *format,...)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Plot the projection of all the different FoVs on a certain grid.  <a href="#ed87a0850d278bb80fe6906e7a8fa6f6"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#17f83b9d00296996ebdaff0335ef4340">plotdir</a> (char *fig, const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms, double totfov, char *format,...)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">ploted all the different beam directions as points.  <a href="#17f83b9d00296996ebdaff0335ef4340"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#f83a1d1fc29af913013c954d41d34490">rename_file</a> (int sig)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Rename the log files when simulation exits.  <a href="#f83a1d1fc29af913013c954d41d34490"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#6331baae7550213ee98a12f9c3bbc5ce">maos_signal_handler</a> (int sig)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Handles signals.  <a href="#6331baae7550213ee98a12f9c3bbc5ce"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#0edd37fe65f6a8b1e530370f6e6402f3">print_usage</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Print out usage information.  <a href="#0edd37fe65f6a8b1e530370f6e6402f3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structARG__T.html">ARG_T</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#cb9c938dc842d5c52a16c7443fdb4ae3">parse_args</a> (int argc, char **argv)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Parse command line arguments argc, argv.  <a href="#cb9c938dc842d5c52a16c7443fdb4ae3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structccell.html">ccell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#23f278c19893472d21761319c7eb4ebc">strehlcomp</a> (const <a class="el" href="structdmat.html">dmat</a> *iopdevl, const double *amp, const int nwvl, const double *wvl)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Computes strehl from OPD without doing FFT.  <a href="#23f278c19893472d21761319c7eb4ebc"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structccell.html">ccell</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#ae7f6abee9a2af7836c61f3d76e3eda2">psfcomp</a> (const <a class="el" href="structdmat.html">dmat</a> *iopdevl, const double *amp, int **embeds, const int *nembeds, const int psfsize, const int nwvl, const double *wvl)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Computes PSF from OPD by doing FFT.  <a href="#ae7f6abee9a2af7836c61f3d76e3eda2"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#bd8c62a4ca2f063bea3a863d2f7e0107">embed_in</a> (double *out, const double *in, long nin, long *embed)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Simple embed and accumulation.  <a href="#bd8c62a4ca2f063bea3a863d2f7e0107"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#82fb97c6bab04cdbdc0867c62c76626a">embed_out</a> (const double *out, double *in, long nin, long *embed)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Simple embed and accumulation.  <a href="#82fb97c6bab04cdbdc0867c62c76626a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#a54aacd870579af5c2d7f1023f7a5624">lock_seeds</a> (<a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Try to lock file for each seed.  <a href="#a54aacd870579af5c2d7f1023f7a5624"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#5c7b446004c896c4369a93a863815d77">calc_aniso</a> (double r0, int nht, double *ht, double *wt)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Estimate anisoplanatic angle theta0 from Fried parameter r0, layer height and weights.  <a href="#5c7b446004c896c4369a93a863815d77"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_2utils_8c.html#066f38258e20d362d1e184a397697828">calc_aniso2</a> (double r0, int nht, double *ht, double *wt, double hc1, double hc2)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Estimate generalized aniso angle theta2 from Fried parameter r0, and layer height and weights, and deformable mirror conjugation heights hc1 hc2 of the ground and altitude DMs.  <a href="#066f38258e20d362d1e184a397697828"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
A few utility routines. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="5a2e23d34ba0e7d3614bd42f5eb8ccaa"></a><!-- doxytag: member="utils.c::addnoise" ref="5a2e23d34ba0e7d3614bd42f5eb8ccaa" args="(dmat *A, mt_state *rstat, const double bkgrnd, const double pcalib, const double *bkgrnd2, const double pcalib2, const double rne)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void addnoise           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>A</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structmt__state.html">mt_state</a> *&nbsp;</td>
          <td class="paramname"> <em>rstat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>bkgrnd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>pcalib</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>bkgrnd2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>pcalib2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double&nbsp;</td>
          <td class="paramname"> <em>rne</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
add photon and read out noise. 
<p>
pcalib part of bkgrnd is calibrated out. pcalib2 part of bkgrnd2 is calibrated out. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>A</em>&nbsp;</td><td>The pixel intensity array </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>rstat</em>&nbsp;</td><td>The random stream </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>bkgrnd</em>&nbsp;</td><td>background in PDEs per pixel per frame </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pcalib</em>&nbsp;</td><td>Fraction of bkgrnd that is calibrated out </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>bkgrnd2</em>&nbsp;</td><td>background in PDEs of each pixel per frame. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pcalib2</em>&nbsp;</td><td>Fraction of bkgrnd taht is calibrated out </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>rne</em>&nbsp;</td><td>Read out noise per pixel per read </td></tr>
  </table>
</dl>
<div class="fragment"><pre class="fragment"><a name="l00050"></a>00050            {
<a name="l00051"></a>00051  
<a name="l00052"></a>00052     <span class="keywordflow">if</span>(bkgrnd2){
<a name="l00053"></a>00053     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;A-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>*A-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>; ix++){
<a name="l00054"></a>00054         A-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ix]=randp(rstat,A-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ix]+bkgrnd+bkgrnd2[ix])
<a name="l00055"></a>00055         -bkgrnd*pcalib-bkgrnd2[ix]*pcalib2
<a name="l00056"></a>00056         +rne*randn(rstat);
<a name="l00057"></a>00057     }
<a name="l00058"></a>00058     }<span class="keywordflow">else</span>{
<a name="l00059"></a>00059     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;A-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>*A-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>; ix++){
<a name="l00060"></a>00060         A-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ix]=randp(rstat,A-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[ix]+bkgrnd)
<a name="l00061"></a>00061                -bkgrnd*pcalib+rne*randn(rstat);
<a name="l00062"></a>00062     }
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="aba5a9d494e2fc4ef56edd11248b41e9"></a><!-- doxytag: member="utils.c::create_metapupil_wrap" ref="aba5a9d494e2fc4ef56edd11248b41e9" args="(const PARMS_T *parms, double ht, double dx, double offset, double guard, long nin, T_TYPE type, int pad, int square)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structMAP__T.html">MAP_T</a>* create_metapupil_wrap           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>ht</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>guard</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&nbsp;</td>
          <td class="paramname"> <em>nin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">T_TYPE&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>pad</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>square</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Calls create_metapupil is simplified interface by returning a <a class="el" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> object. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00070"></a>00070                                                 {
<a name="l00071"></a>00071     <a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a> * amp=calloc(<span class="keyword">sizeof</span>(<a class="code" href="structMAP__T.html" title="OPD or Amplitude map defined on square/rectangular grids.">MAP_T</a>),1);
<a name="l00072"></a>00072     <a class="code" href="maos_2utils_8c.html#480912f463af16b1beec7b915c32acde" title="create a metapupil map, with size nx*ny, origin at (ox,oy), sampling of dx, height...">create_metapupil</a>(parms,ht,dx,offset,&amp;(amp-&gt;<a class="code" href="structMAP__T.html#e7003c76b669b6547f0cf76883e4ae9e" title="Number of points along x.">nx</a>),&amp;(amp-&gt;<a class="code" href="structMAP__T.html#122764d79d9e115f057f73f38f26b0b8" title="Number of points along y.">ny</a>),
<a name="l00073"></a>00073              &amp;(amp-&gt;<a class="code" href="structMAP__T.html#6d09f5bfa663ca7cc80fa16cd4f3bc5c" title="Origin in x.">ox</a>),&amp;(amp-&gt;<a class="code" href="structMAP__T.html#edda94fda911d8718b7b25a3972aa23b" title="Origin in y.">oy</a>),&amp;(amp-&gt;<a class="code" href="structMAP__T.html#5d370c46ec22b469f87691d90a855030" title="The OPD.">p</a>),guard, nin, type,pad,square);
<a name="l00074"></a>00074     amp-&gt;<a class="code" href="structMAP__T.html#49015864cb8861d6ecf4b6a88596ee3c" title="Sampling along x and y.">dx</a>=dx;
<a name="l00075"></a>00075     amp-&gt;<a class="code" href="structMAP__T.html#7cad352b82624ab945b7808ea931f282" title="Heigh conjugation of this surface.">h</a>=ht;
<a name="l00076"></a>00076     <span class="keywordflow">return</span> amp;
<a name="l00077"></a>00077 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="480912f463af16b1beec7b915c32acde"></a><!-- doxytag: member="utils.c::create_metapupil" ref="480912f463af16b1beec7b915c32acde" args="(const PARMS_T *parms, double ht, double dx, double offset, long *nxout, long *nyout, double *oxout, double *oyout, double **map, double guard, long nin, T_TYPE type, int pad, int square)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void create_metapupil           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>ht</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>dx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long *&nbsp;</td>
          <td class="paramname"> <em>nxout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long *&nbsp;</td>
          <td class="paramname"> <em>nyout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>oxout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>oyout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double **&nbsp;</td>
          <td class="paramname"> <em>map</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>guard</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&nbsp;</td>
          <td class="paramname"> <em>nin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">T_TYPE&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>pad</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>square</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
create a metapupil map, with size nx*ny, origin at (ox,oy), sampling of dx, height of ht, that can cover all the WFS and science beams. 
<p>
offset: distance in pixel from the point closest to the origin to origin (right side). 0: there is a point on the origin. 1/2: the closest point to origin is 1/2 pixel.<p>
pad: 1: round nx, ny to power of 2. <div class="fragment"><pre class="fragment"><a name="l00092"></a>00092                                                                      {
<a name="l00093"></a>00093     <span class="keywordtype">double</span> R=parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>/2;
<a name="l00094"></a>00094     <span class="keywordtype">double</span> maxx=0,maxy=0;
<a name="l00095"></a>00095     <span class="keywordtype">double</span> sx,sy;<span class="comment">//temporary variables</span>
<a name="l00096"></a>00096     <span class="keywordtype">int</span> i;
<a name="l00097"></a>00097     <span class="keywordtype">int</span> use_wfs_hi=1;
<a name="l00098"></a>00098     <span class="keywordtype">int</span> use_wfs_lo=1;
<a name="l00099"></a>00099     <span class="keywordtype">int</span> use_evl=1;
<a name="l00100"></a>00100     <span class="keywordtype">int</span> use_fit=1;
<a name="l00101"></a>00101     <span class="keyword">const</span> <span class="keywordtype">char</span> *typestr[]={
<a name="l00102"></a>00102     <span class="stringliteral">"PLOC"</span>,<span class="stringliteral">"ALOC"</span>,<span class="stringliteral">"XLOC"</span>,<span class="stringliteral">"ATM"</span>
<a name="l00103"></a>00103     };
<a name="l00104"></a>00104     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#78278efa786e9d15e8de3a3af9525101" title="Tomography algorithm to solve the linear equation.">alg</a>==0 &amp;&amp; parms-&gt;<a class="code" href="structPARMS__T.html#97445ce9015e982a22199e400b2271e4" title="tomography parameters">tomo</a>.<a class="code" href="structTOMO__CFG__T.html#0b1183e68cda2c750bc3aa9b23648685" title="split tomography type.">split</a>==1){
<a name="l00105"></a>00105     <span class="keywordflow">switch</span>(type){
<a name="l00106"></a>00106     <span class="keywordflow">case</span> T_PLOC:
<a name="l00107"></a>00107         <span class="keywordflow">break</span>;
<a name="l00108"></a>00108     <span class="keywordflow">case</span> T_ALOC:
<a name="l00109"></a>00109         <span class="keywordflow">break</span>;
<a name="l00110"></a>00110     <span class="keywordflow">case</span> T_XLOC:
<a name="l00111"></a>00111         <span class="comment">/*use_evl=0;</span>
<a name="l00112"></a>00112 <span class="comment">        use_fit=1;</span>
<a name="l00113"></a>00113 <span class="comment">        if(parms-&gt;tomo.split==1){</span>
<a name="l00114"></a>00114 <span class="comment">        use_wfs_lo=0;</span>
<a name="l00115"></a>00115 <span class="comment">        }*/</span>
<a name="l00116"></a>00116         <span class="keywordflow">break</span>;
<a name="l00117"></a>00117     <span class="keywordflow">case</span> T_ATM:
<a name="l00118"></a>00118         <span class="keywordflow">break</span>;
<a name="l00119"></a>00119     <span class="keywordflow">default</span>:
<a name="l00120"></a>00120         warning(<span class="stringliteral">"Unknown type\n"</span>);
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122     }
<a name="l00123"></a>00123     <span class="comment">//find minimum map size to cover all the beams</span>
<a name="l00124"></a>00124     <span class="keywordflow">for</span>(i=0; i&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; i++){
<a name="l00125"></a>00125     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[i].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00126"></a>00126     <span class="keywordflow">if</span>((parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a> &amp;&amp; !use_wfs_lo) 
<a name="l00127"></a>00127        ||(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a> &amp;&amp; !use_wfs_hi)){
<a name="l00128"></a>00128         warning(<span class="stringliteral">"Skip wfs %d when making grid for type %s\n"</span>,i,typestr[type]);
<a name="l00129"></a>00129         <span class="keywordflow">continue</span>;
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131     sx=fabs(parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[i].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*ht)
<a name="l00132"></a>00132         +(1.-ht/parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>)*R+guard;
<a name="l00133"></a>00133     sy=fabs(parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[i].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*ht)
<a name="l00134"></a>00134         +(1.-ht/parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>)*R+guard;
<a name="l00135"></a>00135     <span class="keywordflow">if</span>(sx&gt;maxx) maxx=sx;
<a name="l00136"></a>00136     <span class="keywordflow">if</span>(sy&gt;maxy) maxy=sy;
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138     <span class="keywordflow">if</span>(use_evl){
<a name="l00139"></a>00139     <span class="keywordflow">for</span>(i=0; i&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; i++){
<a name="l00140"></a>00140         sx=fabs(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[i]*ht)+R+guard;
<a name="l00141"></a>00141         sy=fabs(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[i]*ht)+R+guard;
<a name="l00142"></a>00142         <span class="keywordflow">if</span>(sx&gt;maxx) maxx=sx;
<a name="l00143"></a>00143         <span class="keywordflow">if</span>(sy&gt;maxy) maxy=sy;
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145     }<span class="keywordflow">else</span>{
<a name="l00146"></a>00146     warning(<span class="stringliteral">"Skip evl when making grid for type %s\n"</span>, typestr[type]);
<a name="l00147"></a>00147     }
<a name="l00148"></a>00148     <span class="keywordflow">if</span>(use_fit){
<a name="l00149"></a>00149     <span class="keywordflow">for</span>(i=0; i&lt;parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>; i++){
<a name="l00150"></a>00150         sx=fabs(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#e546272f69aa60a0f5c435d438641001" title="x Coordinate of DM fitting directions.">thetax</a>[i]*ht)+R+guard;
<a name="l00151"></a>00151         sy=fabs(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4c47b74e14e1521755410a9183d3ef6c" title="y Coordinate of DM fitting directions.">thetay</a>[i]*ht)+R+guard;
<a name="l00152"></a>00152         <span class="keywordflow">if</span>(sx&gt;maxx) maxx=sx;
<a name="l00153"></a>00153         <span class="keywordflow">if</span>(sy&gt;maxy) maxy=sy;
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155     }<span class="keywordflow">else</span>{
<a name="l00156"></a>00156     warning(<span class="stringliteral">"Skip fit when making grid for type %s\n"</span>, typestr[type]);
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158     <span class="comment">//normalized grid size +3 is extra guard band</span>
<a name="l00159"></a>00159     maxx=ceil(maxx/dx)+2;
<a name="l00160"></a>00160     maxy=ceil(maxy/dx)+2;
<a name="l00161"></a>00161     <span class="keywordtype">long</span> nx,ny;
<a name="l00162"></a>00162     nx=iceil(maxx+offset+1)*2;
<a name="l00163"></a>00163     ny=iceil(maxy+offset+1)*2;
<a name="l00164"></a>00164     <span class="keywordflow">if</span>(pad){<span class="comment">//pad to power of 2</span>
<a name="l00165"></a>00165     nx=1&lt;&lt;iceil(log2((<span class="keywordtype">double</span>)nx));
<a name="l00166"></a>00166     ny=1&lt;&lt;iceil(log2((<span class="keywordtype">double</span>)ny));
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <span class="comment">//Make it square</span>
<a name="l00169"></a>00169     nx=(nx&lt;ny)?ny:nx;
<a name="l00170"></a>00170     ny=nx;
<a name="l00171"></a>00171     <span class="keywordflow">if</span>(nin&gt;1){
<a name="l00172"></a>00172     <span class="keywordflow">if</span>(nin&lt;nx){
<a name="l00173"></a>00173         warning(<span class="stringliteral">"nin=%ld is too small\n"</span>,nin);
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175     <span class="comment">//warning("overriding nx=%ld, ny=%ld by supplied nin=%ld\n",nx,ny,nin);</span>
<a name="l00176"></a>00176     nx=nin;
<a name="l00177"></a>00177     ny=nin;
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179     <span class="keywordtype">double</span> ox,oy;
<a name="l00180"></a>00180     ox=((nx/2)-offset);
<a name="l00181"></a>00181     oy=((ny/2)-offset);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="keywordflow">if</span>(nxout)
<a name="l00184"></a>00184     *nxout=nx;
<a name="l00185"></a>00185     <span class="keywordflow">if</span>(nyout)
<a name="l00186"></a>00186     *nyout=ny;
<a name="l00187"></a>00187     <span class="keywordflow">if</span>(oxout)
<a name="l00188"></a>00188     *oxout=-ox*dx;
<a name="l00189"></a>00189     <span class="keywordflow">if</span>(oyout)
<a name="l00190"></a>00190     *oyout=-oy*dx;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="keywordflow">if</span>(map &amp;&amp; square){
<a name="l00193"></a>00193     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *dmap=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nx,ny);
<a name="l00194"></a>00194     *map=dmap-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00195"></a>00195     <a class="code" href="dmat_8h.html#705d6399ce6e7f7064d12f4eb131d47d" title="set values of each element in a X(mat) to val.">dset</a>(dmap,1);
<a name="l00196"></a>00196     <a class="code" href="dmat_8h.html#d1c7365b3e3f0da49ddbf496bd46514b" title="Free the X(mat), but keep the data.">dfree_keepdata</a>(dmap);
<a name="l00197"></a>00197     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(map){
<a name="l00198"></a>00198     <span class="comment">//guard+=0.707;//necessary with dcircle_deprecated. not with current dcircle</span>
<a name="l00199"></a>00199     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *dmap=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nx,ny);
<a name="l00200"></a>00200     *map=dmap-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>;
<a name="l00201"></a>00201     <span class="keywordtype">double</span> Rn=R/dx;
<a name="l00202"></a>00202     <span class="keywordtype">double</span> Rg=guard/dx;
<a name="l00203"></a>00203     <span class="keywordflow">for</span>(i=0; i&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; i++){
<a name="l00204"></a>00204         <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[i].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00205"></a>00205         <span class="keywordflow">if</span>((parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a> &amp;&amp; !use_wfs_lo) 
<a name="l00206"></a>00206            ||(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a> &amp;&amp; !use_wfs_hi)){
<a name="l00207"></a>00207         <span class="comment">//warning("Skip wfs %d when making grid for type %s\n",i,typestr[type]);</span>
<a name="l00208"></a>00208         <span class="keywordflow">continue</span>;
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210         sx=ox+(parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[i].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*ht)/dx;
<a name="l00211"></a>00211         sy=oy+(parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[i].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*ht)/dx;
<a name="l00212"></a>00212         <span class="keywordtype">double</span> RR=Rn*(1.-ht/parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>)+Rg;
<a name="l00213"></a>00213         <a class="code" href="dmat_8h.html#bb7ee19f9a9bd8c7d4f3fc680a202601" title="similar to X(circle).">dcircle_symbolic</a>(dmap,sx,sy,RR);
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">if</span>(use_evl){
<a name="l00217"></a>00217         <span class="keywordflow">for</span>(i=0; i&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; i++){
<a name="l00218"></a>00218         sx=ox+(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[i]*ht)/dx;
<a name="l00219"></a>00219         sy=oy+(parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[i]*ht)/dx;
<a name="l00220"></a>00220         <span class="keywordtype">double</span> RR=Rn+Rg;
<a name="l00221"></a>00221         <a class="code" href="dmat_8h.html#bb7ee19f9a9bd8c7d4f3fc680a202601" title="similar to X(circle).">dcircle_symbolic</a>(dmap,sx,sy,RR);
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223     }<span class="keywordflow">else</span>{
<a name="l00224"></a>00224         warning(<span class="stringliteral">"Skip evl when making grid for type %s\n"</span>, typestr[type]);
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226     <span class="keywordflow">if</span>(use_fit){
<a name="l00227"></a>00227         <span class="keywordflow">for</span>(i=0; i&lt;parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>; i++){
<a name="l00228"></a>00228         sx=ox+(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#e546272f69aa60a0f5c435d438641001" title="x Coordinate of DM fitting directions.">thetax</a>[i]*ht)/dx;
<a name="l00229"></a>00229         sy=oy+(parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4c47b74e14e1521755410a9183d3ef6c" title="y Coordinate of DM fitting directions.">thetay</a>[i]*ht)/dx;
<a name="l00230"></a>00230         <span class="keywordtype">double</span> RR=Rn+Rg;
<a name="l00231"></a>00231         <a class="code" href="dmat_8h.html#bb7ee19f9a9bd8c7d4f3fc680a202601" title="similar to X(circle).">dcircle_symbolic</a>(dmap,sx,sy,RR);
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233     }<span class="keywordflow">else</span>{
<a name="l00234"></a>00234         warning(<span class="stringliteral">"Skip fit when making grid for type %s\n"</span>, typestr[type]);
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <span class="keywordflow">for</span>(i=0; i&lt;nx*ny; i++){
<a name="l00238"></a>00238         dmap-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i]=(dmap-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i])&gt;1.e-15?1:0;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     <a class="code" href="dmat_8h.html#d1c7365b3e3f0da49ddbf496bd46514b" title="Free the X(mat), but keep the data.">dfree_keepdata</a>(dmap);
<a name="l00241"></a>00241     <span class="comment">//free(dmap-&gt;nref);</span>
<a name="l00242"></a>00242     <span class="comment">//free(dmap);//don't free data</span>
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="ed87a0850d278bb80fe6906e7a8fa6f6"></a><!-- doxytag: member="utils.c::plotloc" ref="ed87a0850d278bb80fe6906e7a8fa6f6" args="(char *fig, const PARMS_T *parms, LOC_T *loc, double ht, char *format,...)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void plotloc           </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fig</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structLOC__T.html">LOC_T</a> *&nbsp;</td>
          <td class="paramname"> <em>loc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>ht</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>format</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&nbsp;</td>
          <td class="paramname"> <em>...</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Plot the projection of all the different FoVs on a certain grid. 
<p>
used in setup_recon <div class="fragment"><pre class="fragment"><a name="l00249"></a>00249                                                  {
<a name="l00250"></a>00250     format2fn;
<a name="l00251"></a>00251     <span class="keywordtype">int</span> ncir=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a> + parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>;
<a name="l00252"></a>00252     double (*cir)[4];
<a name="l00253"></a>00253     cir=(double(*)[4])calloc(ncir*4,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00254"></a>00254     <span class="keywordtype">int</span> count=0;
<a name="l00255"></a>00255     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>; ievl++){
<a name="l00256"></a>00256     cir[count][0]=ht*parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl];
<a name="l00257"></a>00257     cir[count][1]=ht*parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl];
<a name="l00258"></a>00258     cir[count][2]=parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>*0.5;
<a name="l00259"></a>00259     cir[count][3]=900;<span class="comment">//rgb color</span>
<a name="l00260"></a>00260     count++;
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00263"></a>00263     <span class="keywordtype">double</span> hs=parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>;
<a name="l00264"></a>00264     cir[count][0]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*ht;
<a name="l00265"></a>00265     cir[count][1]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*ht;
<a name="l00266"></a>00266     cir[count][2]=parms-&gt;<a class="code" href="structPARMS__T.html#674d3d0b966b2d7c27767e909dfcb30f" title="aperture parameters">aper</a>.<a class="code" href="structAPER__CFG__T.html#ce3d5df3fe365f555ce1b851f833e961" title="Telescope aperture diameter.">d</a>*0.5*(1.-ht/hs);
<a name="l00267"></a>00267     <span class="keywordflow">if</span>(isinf(hs)){
<a name="l00268"></a>00268         cir[count][3]=290;<span class="comment">//rgb color</span>
<a name="l00269"></a>00269     }<span class="keywordflow">else</span>{
<a name="l00270"></a>00270         cir[count][3]=992;
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272     count++;
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274     <a class="code" href="draw_8c.html#3d11dad9ce3744359ec458551c53f393" title="Plot the coordinates ptsx, ptsy using style, and optionally plot ncir circles.">plot_coord</a>(fig, loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>, loc-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>, loc-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>,NULL, NULL,ncir, cir, 
<a name="l00275"></a>00275            <span class="stringliteral">"Coordinate"</span>,<span class="stringliteral">"x (m)"</span>,<span class="stringliteral">"y (m)"</span>, <span class="stringliteral">"%s"</span>,fn);
<a name="l00276"></a>00276     free(cir);
<a name="l00277"></a>00277 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="17f83b9d00296996ebdaff0335ef4340"></a><!-- doxytag: member="utils.c::plotdir" ref="17f83b9d00296996ebdaff0335ef4340" args="(char *fig, const PARMS_T *parms, double totfov, char *format,...)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void plotdir           </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fig</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>totfov</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>format</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&nbsp;</td>
          <td class="paramname"> <em>...</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
ploted all the different beam directions as points. 
<p>
used in setup_parms <div class="fragment"><pre class="fragment"><a name="l00280"></a>00280                                                                               {
<a name="l00281"></a>00281     format2fn;
<a name="l00282"></a>00282     <span class="keywordtype">int</span> ncir=1;
<a name="l00283"></a>00283     double (*cir)[4];
<a name="l00284"></a>00284     cir=(double(*)[4])calloc(ncir*4,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00285"></a>00285     <span class="keywordtype">long</span> npts=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a> + parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a> + parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>;
<a name="l00286"></a>00286     cir[0][0]=0;
<a name="l00287"></a>00287     cir[0][1]=0;
<a name="l00288"></a>00288     cir[0][2]=totfov/2;
<a name="l00289"></a>00289     cir[0][3]=000;<span class="comment">//rgb color</span>
<a name="l00290"></a>00290     <span class="keywordtype">double</span> *ptsx=calloc(npts,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00291"></a>00291     <span class="keywordtype">double</span> *ptsy=calloc(npts,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00292"></a>00292     <span class="keywordtype">long</span> *style=calloc(npts, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00293"></a>00293     <span class="keywordtype">int</span> nevl=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#9f76679213a98ac7e3eb0fe92d645799" title="Number of evaluation directions.">nevl</a>;
<a name="l00294"></a>00294     <span class="keywordtype">int</span> ind=0;
<a name="l00295"></a>00295     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ievl=0; ievl&lt;nevl; ievl++){
<a name="l00296"></a>00296     ptsx[ind]=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#dcb390bcffd7629411575788c77de50e" title="x Coordinate of evaluation directions">thetax</a>[ievl]*206265;
<a name="l00297"></a>00297     ptsy[ind]=parms-&gt;<a class="code" href="structPARMS__T.html#4121e9dc728705be0ad2c58dcaf4cd75" title="Performance evaluation parameters.">evl</a>.<a class="code" href="structEVL__CFG__T.html#76b3e6506ff40743e8e28ad6aa36afa4" title="y Coordinate of evaluation directions">thetay</a>[ievl]*206265;
<a name="l00298"></a>00298     style[ind]=(900&lt;&lt;8)+(4&lt;&lt;4)+3;
<a name="l00299"></a>00299     ind++;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ifit=0; ifit&lt;parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#6e582e718e6c2418d8b9238fdcdfcb9d" title="Number of DM fit directions.">nfit</a>; ifit++){
<a name="l00302"></a>00302     ptsx[ind]=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#e546272f69aa60a0f5c435d438641001" title="x Coordinate of DM fitting directions.">thetax</a>[ifit]*206265;
<a name="l00303"></a>00303     ptsy[ind]=parms-&gt;<a class="code" href="structPARMS__T.html#3b8ffe6fa411ea23ef7c1383fe61abbf" title="DM fit parameters.">fit</a>.<a class="code" href="structFIT__CFG__T.html#4c47b74e14e1521755410a9183d3ef6c" title="y Coordinate of DM fitting directions.">thetay</a>[ifit]*206265;
<a name="l00304"></a>00304     style[ind]=(918&lt;&lt;8)+(4&lt;&lt;4)+3;
<a name="l00305"></a>00305     ind++;
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwfs=0; iwfs&lt;parms-&gt;<a class="code" href="structPARMS__T.html#b6833beca5a29a5936d41ac934e66d24" title="Number of wfs.">nwfs</a>; iwfs++){
<a name="l00308"></a>00308     ptsx[ind]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#ebd74c669d9a3f057f4d4b4a43eda163" title="x direction">thetax</a>*206265;
<a name="l00309"></a>00309     ptsy[ind]=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#3344f596561dfaf1d9d197112e2cefbd" title="y direction">thetay</a>*206265;
<a name="l00310"></a>00310     <span class="keywordtype">int</span> ipowfs=parms-&gt;<a class="code" href="structPARMS__T.html#19246602a8b7d0261d79416e281d6ca4" title="Array of wfs.">wfs</a>[iwfs].<a class="code" href="structWFS__CFG__T.html#c6eeef5eba99a8dea64c1692bb60f5ff" title="powfs type">powfs</a>;
<a name="l00311"></a>00311     <span class="keywordflow">if</span>(!isinf(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#3b65158c197ddc07b117b5f8b1aa567b" title="height of guide star">hs</a>)){
<a name="l00312"></a>00312         style[ind]=(940&lt;&lt;8)+(4&lt;&lt;4)+2;
<a name="l00313"></a>00313     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(!parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#0324889316992d35cd3e1e3df9d17382" title="whether this is a low order wfs.">lo</a>){
<a name="l00314"></a>00314         style[ind]=(990&lt;&lt;8)+(4&lt;&lt;4)+1;
<a name="l00315"></a>00315     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#5cfc96549c1047f9f39a888842cdef92" title="Array of wfs type.">powfs</a>[ipowfs].<a class="code" href="structPOWFS__CFG__T.html#27c7dcb36cf4ff0b070eab1b80491266" title="order of wavefront sensing along one dimension.">order</a>&gt;1){
<a name="l00316"></a>00316         style[ind]=(9&lt;&lt;8)+(4&lt;&lt;4)+4;
<a name="l00317"></a>00317     }<span class="keywordflow">else</span>{
<a name="l00318"></a>00318         style[ind]=(9&lt;&lt;8)+(4&lt;&lt;4)+1;
<a name="l00319"></a>00319     }
<a name="l00320"></a>00320     ind++;
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322     <span class="keywordtype">double</span> limit[4];
<a name="l00323"></a>00323     limit[0]=limit[2]=-totfov/2;
<a name="l00324"></a>00324     limit[1]=limit[3]=totfov/2;
<a name="l00325"></a>00325     <a class="code" href="draw_8c.html#3d11dad9ce3744359ec458551c53f393" title="Plot the coordinates ptsx, ptsy using style, and optionally plot ncir circles.">plot_coord</a>(fig, npts, ptsx, ptsy, style,limit,ncir,cir,
<a name="l00326"></a>00326            <span class="stringliteral">"Asterism"</span>,<span class="stringliteral">"x (arcsec)"</span>, <span class="stringliteral">"y (arcsec)"</span>, <span class="stringliteral">"%s"</span>,fn);
<a name="l00327"></a>00327     free(cir);
<a name="l00328"></a>00328     free(ptsx);
<a name="l00329"></a>00329     free(ptsy);
<a name="l00330"></a>00330     free(style);
<a name="l00331"></a>00331 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f83a1d1fc29af913013c954d41d34490"></a><!-- doxytag: member="utils.c::rename_file" ref="f83a1d1fc29af913013c954d41d34490" args="(int sig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void rename_file           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sig</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Rename the log files when simulation exits. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00335"></a>00335                          {
<a name="l00336"></a>00336     <span class="keywordtype">char</span> fnnew[256];
<a name="l00337"></a>00337     <span class="keywordtype">char</span> fnold[256];
<a name="l00338"></a>00338     <span class="keywordtype">char</span> suffix[16];
<a name="l00339"></a>00339     <span class="keywordtype">int</span> pid=getpid();
<a name="l00340"></a>00340     <span class="keywordflow">switch</span>(sig){
<a name="l00341"></a>00341     <span class="keywordflow">case</span> 0:
<a name="l00342"></a>00342     sprintf(suffix,<span class="stringliteral">"done"</span>);
<a name="l00343"></a>00343     <span class="keywordflow">break</span>;
<a name="l00344"></a>00344     <span class="keywordflow">case</span> SIGBUS:
<a name="l00345"></a>00345     <span class="keywordflow">case</span> SIGILL:
<a name="l00346"></a>00346     <span class="keywordflow">case</span> SIGSEGV:
<a name="l00347"></a>00347     <span class="keywordflow">case</span> SIGABRT:
<a name="l00348"></a>00348     sprintf(suffix,<span class="stringliteral">"err"</span>);
<a name="l00349"></a>00349     <span class="keywordflow">break</span>;
<a name="l00350"></a>00350     <span class="keywordflow">case</span> SIGKILL:
<a name="l00351"></a>00351     <span class="keywordflow">case</span> SIGINT: <span class="comment">//Ctrl-C</span>
<a name="l00352"></a>00352     <span class="keywordflow">case</span> SIGTERM:
<a name="l00353"></a>00353     <span class="keywordflow">case</span> SIGQUIT: <span class="comment">//Ctrl-'\'</span>
<a name="l00354"></a>00354     sprintf(suffix,<span class="stringliteral">"killed"</span>);
<a name="l00355"></a>00355     <span class="keywordflow">break</span>;
<a name="l00356"></a>00356     <span class="keywordflow">default</span>:
<a name="l00357"></a>00357     sprintf(suffix,<span class="stringliteral">"unknown"</span>);
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359     snprintf(fnnew,256,<span class="stringliteral">"kill_%d"</span>,pid);
<a name="l00360"></a>00360     <span class="keywordflow">if</span>(exist(fnnew)) <span class="keyword">remove</span>(fnnew);
<a name="l00361"></a>00361     
<a name="l00362"></a>00362     snprintf(fnold,256,<span class="stringliteral">"run_%d.log"</span>,pid);
<a name="l00363"></a>00363     snprintf(fnnew,256,<span class="stringliteral">"run_%d.%s"</span>, pid,suffix);
<a name="l00364"></a>00364     rename(fnold,fnnew);
<a name="l00365"></a>00365     mysymlink(fnnew, <span class="stringliteral">"run_recent.log"</span>);
<a name="l00366"></a>00366 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="6331baae7550213ee98a12f9c3bbc5ce"></a><!-- doxytag: member="utils.c::maos_signal_handler" ref="6331baae7550213ee98a12f9c3bbc5ce" args="(int sig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void maos_signal_handler           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sig</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Handles signals. 
<p>
We don't want to exit the simulation when SIGPIPE happens (when we are writing to closed sockets) <div class="fragment"><pre class="fragment"><a name="l00371"></a>00371                                  {
<a name="l00372"></a>00372     <span class="keywordflow">if</span>(sig==SIGPIPE){
<a name="l00373"></a>00373     warning3(<span class="stringliteral">"Program received signal SIGPIPE, broken pipe.\n"</span>);
<a name="l00374"></a>00374     <span class="keywordflow">return</span>;
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376     disable_signal_handler;
<a name="l00377"></a>00377     <a class="code" href="maos_2utils_8c.html#f83a1d1fc29af913013c954d41d34490" title="Rename the log files when simulation exits.">rename_file</a>(sig);<span class="comment">//handles signal</span>
<a name="l00378"></a>00378     <span class="keywordflow">if</span>(sig!=0){
<a name="l00379"></a>00379     info2(<span class="stringliteral">"Caught signal %d\n"</span>,sig);
<a name="l00380"></a>00380     <span class="keywordflow">if</span>(sig == SIGSEGV){
<a name="l00381"></a>00381         print_backtrace(0);
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383     scheduler_finish(1);
<a name="l00384"></a>00384     exit(sig);
<a name="l00385"></a>00385     }
<a name="l00386"></a>00386 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0edd37fe65f6a8b1e530370f6e6402f3"></a><!-- doxytag: member="utils.c::print_usage" ref="0edd37fe65f6a8b1e530370f6e6402f3" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void print_usage           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Print out usage information. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00390"></a>00390                              {
<a name="l00391"></a>00391     info2(
<a name="l00392"></a>00392 <span class="stringliteral">"Usage: maos [OPTION...] [FILE]...\n"</span>
<a name="l00393"></a>00393 <span class="stringliteral">"maos is a simulation tool developed to simulate scao/mcao systems\n\n"</span>
<a name="l00394"></a>00394 <span class="stringliteral">"Examples:\n"</span>
<a name="l00395"></a>00395 <span class="stringliteral">"maos   # Run the default configuration of NFIRAOS: nfiaros.conf as the baseline.\n"</span>
<a name="l00396"></a>00396 <span class="stringliteral">"maos -c scao_ngs.conf -s 2 -n 2 -d -o scao_ngs override.conf chol.conf\n"</span>
<a name="l00397"></a>00397 <span class="stringliteral">"       # Run a single conjugate natural guide star case, with seed 2, 2 threads\n"</span>
<a name="l00398"></a>00398 <span class="stringliteral">"       # detach from the terminal and output results to folder scao_ngs\n"</span>
<a name="l00399"></a>00399 <span class="stringliteral">"       # and read in overriding parameters stored in override.conf and chol.conf\n"</span>
<a name="l00400"></a>00400 <span class="stringliteral">"\n"</span>
<a name="l00401"></a>00401 <span class="stringliteral">"Options: \n"</span>
<a name="l00402"></a>00402 <span class="stringliteral">"-h, --help        to print out this message\n"</span>
<a name="l00403"></a>00403 <span class="stringliteral">"-d, --detach      to detach from terminal and run in background\n"</span>
<a name="l00404"></a>00404 <span class="stringliteral">"-f, --force       force starting simulation without scheduler\n"</span>
<a name="l00405"></a>00405 <span class="stringliteral">"-n N, --nthread=N Use N threads, default is 1\n"</span>
<a name="l00406"></a>00406 <span class="stringliteral">"-s N, --seed=N    Use seed N instead of the numbers specified in .conf files\n"</span>
<a name="l00407"></a>00407 <span class="stringliteral">"-o DIR, --output=DIR\n"</span>
<a name="l00408"></a>00408 <span class="stringliteral">"                  output the results to DIR.\n"</span>
<a name="l00409"></a>00409 <span class="stringliteral">"-c FILE.conf, --conf=FILE.conf\n"</span>
<a name="l00410"></a>00410 <span class="stringliteral">"                  Use FILE.conf as the baseline config instead of nfiraos.conf\n"</span>
<a name="l00411"></a>00411       );
<a name="l00412"></a>00412 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="cb9c938dc842d5c52a16c7443fdb4ae3"></a><!-- doxytag: member="utils.c::parse_args" ref="cb9c938dc842d5c52a16c7443fdb4ae3" args="(int argc, char **argv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structARG__T.html">ARG_T</a>* parse_args           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>argv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Parse command line arguments argc, argv. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00416"></a>00416                                          {
<a name="l00417"></a>00417     <a class="code" href="structARG__T.html" title="ARG_T is used for command line parsing.">ARG_T</a> *arg=calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structARG__T.html" title="ARG_T is used for command line parsing.">ARG_T</a>));
<a name="l00418"></a>00418     arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>=1;<span class="comment">//default is 1 thread.</span>
<a name="l00419"></a>00419     <span class="keyword">static</span> <span class="keyword">struct </span>option long_options[]={
<a name="l00420"></a>00420     {<span class="stringliteral">"help"</span>,0,0,<span class="charliteral">'h'</span>},
<a name="l00421"></a>00421     {<span class="stringliteral">"detach"</span>,0,0,<span class="charliteral">'d'</span>},
<a name="l00422"></a>00422     {<span class="stringliteral">"force"</span>,0,0,<span class="charliteral">'f'</span>},
<a name="l00423"></a>00423     {<span class="stringliteral">"output"</span>,1,0,<span class="charliteral">'o'</span>},
<a name="l00424"></a>00424     {<span class="stringliteral">"nthread"</span>,1,0,<span class="charliteral">'n'</span>},
<a name="l00425"></a>00425     {<span class="stringliteral">"conf"</span>,1,0,<span class="charliteral">'c'</span>},
<a name="l00426"></a>00426     {<span class="stringliteral">"seed"</span>,1,0,<span class="charliteral">'s'</span>},
<a name="l00427"></a>00427     {<span class="stringliteral">"path"</span>,1,0,<span class="charliteral">'p'</span>},
<a name="l00428"></a>00428     {NULL,0,0,0}
<a name="l00429"></a>00429     };
<a name="l00430"></a>00430     <span class="keywordflow">while</span>(1){
<a name="l00431"></a>00431     <span class="keywordtype">int</span> option_index = 0;
<a name="l00432"></a>00432     <span class="keywordtype">int</span> c = getopt_long(argc, argv, <span class="stringliteral">"hdfo:n:c:s:p:"</span>,
<a name="l00433"></a>00433                         long_options, &amp;option_index);
<a name="l00434"></a>00434     <span class="keywordflow">if</span>(c==-1) <span class="keywordflow">break</span>;
<a name="l00435"></a>00435     <span class="keywordflow">switch</span>(c){
<a name="l00436"></a>00436     <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
<a name="l00437"></a>00437         <a class="code" href="maos_2utils_8c.html#0edd37fe65f6a8b1e530370f6e6402f3" title="Print out usage information.">print_usage</a>();
<a name="l00438"></a>00438         exit(0);
<a name="l00439"></a>00439         <span class="keywordflow">break</span>;
<a name="l00440"></a>00440     <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
<a name="l00441"></a>00441         arg-&gt;<a class="code" href="structARG__T.html#2c3209f38638cec0a050260bab246299" title="Detach from the command line and run in background.">detach</a>=1;
<a name="l00442"></a>00442         <span class="keywordflow">break</span>;
<a name="l00443"></a>00443     <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
<a name="l00444"></a>00444         arg-&gt;<a class="code" href="structARG__T.html#c55657110f55a48957f1d60a18c4bf08" title="For start, bypassing scheduler.">force</a>=1; 
<a name="l00445"></a>00445         <span class="keywordflow">break</span>;
<a name="l00446"></a>00446     <span class="keywordflow">case</span> <span class="charliteral">'o'</span>:
<a name="l00447"></a>00447         <span class="keywordflow">if</span>(arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>){
<a name="l00448"></a>00448         error(<span class="stringliteral">"Duplicate argument for dirout\n"</span>);
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450         arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>=strdup(optarg);
<a name="l00451"></a>00451         <span class="keywordflow">break</span>;
<a name="l00452"></a>00452     <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
<a name="l00453"></a>00453         arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>=strtol(optarg,NULL,10);
<a name="l00454"></a>00454         <span class="keywordflow">if</span>(arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>&lt;=0){
<a name="l00455"></a>00455         warning(<span class="stringliteral">"illigal nthread. set to 1.\n"</span>);
<a name="l00456"></a>00456         arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>=1;
<a name="l00457"></a>00457         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>&gt;NCPU){
<a name="l00458"></a>00458         warning(<span class="stringliteral">"nthread is larger than number of cpus, reset to %d\n"</span>,
<a name="l00459"></a>00459             NCPU);
<a name="l00460"></a>00460         arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>=NCPU;
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462         <span class="keywordflow">break</span>;
<a name="l00463"></a>00463     <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
<a name="l00464"></a>00464         <span class="keywordflow">if</span>(arg-&gt;<a class="code" href="structARG__T.html#989ce68b27a48e963ca257974c3e720d">conf</a>){
<a name="l00465"></a>00465         error(<span class="stringliteral">"Multiple -c switches found\n"</span>);
<a name="l00466"></a>00466         }
<a name="l00467"></a>00467         arg-&gt;<a class="code" href="structARG__T.html#989ce68b27a48e963ca257974c3e720d">conf</a>=strdup(optarg);
<a name="l00468"></a>00468         <span class="keywordflow">break</span>;
<a name="l00469"></a>00469     <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:{
<a name="l00470"></a>00470         arg-&gt;<a class="code" href="structARG__T.html#1b6b5a8ef6b705c9f1462b9c4eaed72e" title="Number of seeds.">nseed</a>++;
<a name="l00471"></a>00471         arg-&gt;<a class="code" href="structARG__T.html#e850f463984604b4981a0f3020554613" title="Array of seeds.">seeds</a>=realloc(arg-&gt;<a class="code" href="structARG__T.html#e850f463984604b4981a0f3020554613" title="Array of seeds.">seeds</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*arg-&gt;<a class="code" href="structARG__T.html#1b6b5a8ef6b705c9f1462b9c4eaed72e" title="Number of seeds.">nseed</a>);
<a name="l00472"></a>00472         arg-&gt;<a class="code" href="structARG__T.html#e850f463984604b4981a0f3020554613" title="Array of seeds.">seeds</a>[arg-&gt;<a class="code" href="structARG__T.html#1b6b5a8ef6b705c9f1462b9c4eaed72e" title="Number of seeds.">nseed</a>-1]=strtol(optarg,NULL,10);
<a name="l00473"></a>00473         <span class="comment">//info2("Command line supplied seed %d\n",arg-&gt;seeds[arg-&gt;nseed-1]);</span>
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475         <span class="keywordflow">break</span>;
<a name="l00476"></a>00476     <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:{
<a name="l00477"></a>00477         <a class="code" href="path_8c.html#8539b4e587a7ea71221206e43f29ead5" title="Add a directory to path.">addpath</a>(optarg);
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
<a name="l00480"></a>00480         warning(<span class="stringliteral">"Unregonized option. exit.\n"</span>);exit(1);
<a name="l00481"></a>00481         <span class="keywordflow">break</span>;
<a name="l00482"></a>00482     <span class="keywordflow">default</span>:
<a name="l00483"></a>00483         printf(<span class="stringliteral">"?? getopt returned 0%o ??\n"</span>, c);exit(1);
<a name="l00484"></a>00484         <span class="keywordflow">break</span>;
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487     <span class="keywordflow">if</span>(!arg-&gt;<a class="code" href="structARG__T.html#2c3209f38638cec0a050260bab246299" title="Detach from the command line and run in background.">detach</a>){<span class="comment">//foreground task will start immediately.</span>
<a name="l00488"></a>00488     arg-&gt;<a class="code" href="structARG__T.html#c55657110f55a48957f1d60a18c4bf08" title="For start, bypassing scheduler.">force</a>=1;
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490     arg-&gt;<a class="code" href="structARG__T.html#5a7a939d078b18f4adef274ea091a5b1" title="derived parameter marking the starting of .conf arguments">iconf</a>=optind;
<a name="l00491"></a>00491     arg-&gt;<a class="code" href="structARG__T.html#7f6595d404dbfe24aef49eb09edb4b62" title="argument count">argc</a>=argc;
<a name="l00492"></a>00492     arg-&gt;<a class="code" href="structARG__T.html#e0f7df18bc6ad14f2450a4af7713b670" title="Array of arguments.">argv</a>=argv;
<a name="l00493"></a>00493     <span class="keywordflow">if</span>(!arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>){
<a name="l00494"></a>00494     arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>=strtime();
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496     
<a name="l00497"></a>00497     <span class="keywordflow">if</span>(!arg-&gt;<a class="code" href="structARG__T.html#989ce68b27a48e963ca257974c3e720d">conf</a>){
<a name="l00498"></a>00498     <span class="comment">/*If -c is not specifid in path, will use nfiraos.conf*/</span>
<a name="l00499"></a>00499     arg-&gt;<a class="code" href="structARG__T.html#989ce68b27a48e963ca257974c3e720d">conf</a>=strdup(<span class="stringliteral">"nfiraos.conf"</span>);
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501     info2(<span class="stringliteral">"Main config file is %s\n"</span>,arg-&gt;<a class="code" href="structARG__T.html#989ce68b27a48e963ca257974c3e720d">conf</a>);
<a name="l00502"></a>00502     <span class="comment">//Setup PATH and result directory</span>
<a name="l00503"></a>00503     <span class="keyword">const</span> <span class="keywordtype">char</span> *aos_config_path=getenv(<span class="stringliteral">"AOS_CONFIG_PATH"</span>);
<a name="l00504"></a>00504     <span class="keywordtype">char</span> *config_path=NULL;
<a name="l00505"></a>00505     <span class="keywordflow">if</span>(aos_config_path){
<a name="l00506"></a>00506     config_path=stradd(aos_config_path,<span class="stringliteral">"/maos/"</span>,NULL);
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     <span class="keywordflow">if</span>(!exist(config_path) &amp;&amp; exist(SRCDIR)){
<a name="l00509"></a>00509     <span class="comment">/*If not specified, assume it is in the source tree*/</span>
<a name="l00510"></a>00510     <span class="keywordflow">if</span>(config_path) free(config_path);
<a name="l00511"></a>00511     config_path=stradd(SRCDIR,<span class="stringliteral">"/config/maos/"</span>,NULL);
<a name="l00512"></a>00512     }
<a name="l00513"></a>00513     <span class="keywordflow">if</span>(!exist(config_path)){
<a name="l00514"></a>00514     free(config_path);
<a name="l00515"></a>00515     config_path=stradd(getenv(<span class="stringliteral">"HOME"</span>),<span class="stringliteral">"/.aos/config/maos/"</span>,NULL);
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     <span class="keywordflow">if</span>(!exist(config_path)){
<a name="l00518"></a>00518     warning(<span class="stringliteral">"Unable to determine the path to the configuration files.\n"</span>);
<a name="l00519"></a>00519     warning(<span class="stringliteral">"Will download a copy from the website and put in %ss/.aos/config\n"</span>,getenv(<span class="stringliteral">"HOME"</span>));
<a name="l00520"></a>00520     <span class="keywordtype">char</span> cmd[400];
<a name="l00521"></a>00521     snprintf(cmd,400,<span class="stringliteral">"wget %s/maos_config.tar.bz2 -C /tmp/ &amp;&amp; tar axvf /tmp/maos_config.tar.bz2 -C %s/.aos/"</span>,BASEURL, getenv(<span class="stringliteral">"HOME"</span>));
<a name="l00522"></a>00522     <span class="keywordflow">if</span>(system(cmd)){
<a name="l00523"></a>00523         error(<span class="stringliteral">"Unable to download the configuration files from the internet and extract to %s/.aos/config"</span>, getenv(<span class="stringliteral">"HOME"</span>));
<a name="l00524"></a>00524     }
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">if</span>(!exist(config_path)){
<a name="l00527"></a>00527     warning(<span class="stringliteral">"Unable to determine the path to the configuration files.\n"</span>);
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     <a class="code" href="path_8c.html#8539b4e587a7ea71221206e43f29ead5" title="Add a directory to path.">addpath</a>(config_path);
<a name="l00530"></a>00530     <span class="keywordtype">char</span> *bin_path=stradd(config_path, <span class="stringliteral">"/bin"</span>, NULL);
<a name="l00531"></a>00531     <a class="code" href="path_8c.html#8539b4e587a7ea71221206e43f29ead5" title="Add a directory to path.">addpath</a>(bin_path);
<a name="l00532"></a>00532     free(bin_path);
<a name="l00533"></a>00533     free(config_path);
<a name="l00534"></a>00534     <a class="code" href="path_8c.html#8539b4e587a7ea71221206e43f29ead5" title="Add a directory to path.">addpath</a>(<span class="stringliteral">"."</span>);
<a name="l00535"></a>00535     mymkdir(<span class="stringliteral">"%s"</span>,arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>);
<a name="l00536"></a>00536     <span class="keywordflow">if</span>(chdir(arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>)){
<a name="l00537"></a>00537     error(<span class="stringliteral">"Unable to chdir to %s\n"</span>, arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>);
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     info2(<span class="stringliteral">"Output folder is '%s' %d threads\n"</span>,arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>, arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="keywordflow">return</span> arg;
<a name="l00542"></a>00542 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="23f278c19893472d21761319c7eb4ebc"></a><!-- doxytag: member="utils.c::strehlcomp" ref="23f278c19893472d21761319c7eb4ebc" args="(const dmat *iopdevl, const double *amp, const int nwvl, const double *wvl)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structccell.html">ccell</a>* strehlcomp           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>iopdevl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>amp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>nwvl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>wvl</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Computes strehl from OPD without doing FFT. 
<p>
The strehl is simply<p>
<img class="formulaInl" alt="$s=\sum(A*exp[\frac{2\pi i}{\lambda}*\textrm{OPD}]) $" src="form_64.png"><p>
where A is the amplitude map. <div class="fragment"><pre class="fragment"><a name="l00550"></a>00550                                                                                            {
<a name="l00551"></a>00551     <a class="code" href="structccell.html" title="an 2-d block matrix of cmat.">ccell</a> *psf2s=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(nwvl,1);
<a name="l00552"></a>00552     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00553"></a>00553     dcomplex i2pi=I*2*M_PI/wvl[iwvl];
<a name="l00554"></a>00554     dcomplex strehl=0;
<a name="l00555"></a>00555     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;iopdevl-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; iloc++){
<a name="l00556"></a>00556         strehl+=amp[iloc]*cexp(i2pi*iopdevl-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iloc]);
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558     psf2s-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[iwvl]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(1,1);
<a name="l00559"></a>00559     psf2s-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[iwvl]-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[0]=strehl;
<a name="l00560"></a>00560     }
<a name="l00561"></a>00561     <span class="keywordflow">return</span> psf2s;
<a name="l00562"></a>00562 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="ae7f6abee9a2af7836c61f3d76e3eda2"></a><!-- doxytag: member="utils.c::psfcomp" ref="ae7f6abee9a2af7836c61f3d76e3eda2" args="(const dmat *iopdevl, const double *amp, int **embeds, const int *nembeds, const int psfsize, const int nwvl, const double *wvl)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structccell.html">ccell</a>* psfcomp           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>iopdevl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>amp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int **&nbsp;</td>
          <td class="paramname"> <em>embeds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int *&nbsp;</td>
          <td class="paramname"> <em>nembeds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>psfsize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>nwvl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>wvl</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Computes PSF from OPD by doing FFT. 
<p>
The PSF is computed as<p>
<img class="formulaInl" alt="$\textrm{PSF}=\mathcal{F}[A\times exp[\frac{2\pi i}{\lambda}*\textrm{OPD}]]$" src="form_65.png"><p>
The peak value (center) in the computed PSF is normalized by the peak value in the differaction limited PSF. In other words, the peak value in the computed PSF is the Strehl. Keep this in mind when you compute enclosed energy. <div class="fragment"><pre class="fragment"><a name="l00575"></a>00575                                              {
<a name="l00576"></a>00576     <span class="keywordflow">if</span>(psfsize==1){
<a name="l00577"></a>00577     <span class="keywordflow">return</span> <a class="code" href="maos_2utils_8c.html#23f278c19893472d21761319c7eb4ebc" title="Computes strehl from OPD without doing FFT.">strehlcomp</a>(iopdevl, amp, nwvl, wvl);
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579     <a class="code" href="structccell.html" title="an 2-d block matrix of cmat.">ccell</a> *psf2s=<a class="code" href="cmat_8h.html#cdcbda2dbd5dfec8344b8bada36a0a35" title="create a new block matrix.">ccellnew</a>(nwvl,1);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;nwvl; iwvl++){
<a name="l00582"></a>00582     <span class="keywordtype">int</span> nembed=nembeds[iwvl];
<a name="l00583"></a>00583     <span class="keywordtype">int</span> *embed=embeds[iwvl];
<a name="l00584"></a>00584     <span class="comment">//warning("Output PSF for direction %d\n",ievl);</span>
<a name="l00585"></a>00585     <a class="code" href="structcmat.html" title="a double complex matrix object contains 2-d arrays of double complex numbers.">cmat</a> *psf2=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(nembed,nembed);
<a name="l00586"></a>00586     <span class="keywordtype">int</span> ncomp;
<a name="l00587"></a>00587     <span class="keywordtype">int</span> use1d;
<a name="l00588"></a>00588     <span class="keywordtype">int</span> use1d_enable=0;
<a name="l00589"></a>00589     <span class="keywordflow">if</span>(nembed&lt;psfsize){
<a name="l00590"></a>00590         ncomp=nembed;
<a name="l00591"></a>00591         <span class="keywordflow">if</span>(use1d_enable){
<a name="l00592"></a>00592         use1d=1;
<a name="l00593"></a>00593         <a class="code" href="fft_8c.html#c952e6cd84358728122ec12213811b90" title="make plans for cfft2partial">cfft2partialplan</a>(psf2, ncomp, -1);
<a name="l00594"></a>00594         }<span class="keywordflow">else</span>{
<a name="l00595"></a>00595         use1d=0;
<a name="l00596"></a>00596         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(psf2, -1);
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598     }<span class="keywordflow">else</span>{
<a name="l00599"></a>00599         ncomp=psfsize;
<a name="l00600"></a>00600         use1d=0;
<a name="l00601"></a>00601         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(psf2, -1);
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603     <span class="comment">//PCMAT(psf2, ppsf2);</span>
<a name="l00604"></a>00604     <span class="comment">//double psfnorm=1./(sqrt(aper-&gt;sumamp2)*aper-&gt;nembed);//This makes sum(psf)=1;</span>
<a name="l00605"></a>00605     <span class="keywordtype">double</span> psfnorm=1; <span class="comment">/*since sum(aper-&gt;amp)=1, this makes psf normalized by</span>
<a name="l00606"></a>00606 <span class="comment">                differaction limited PSF. max(psf) is strehl.*/</span>
<a name="l00607"></a>00607     dcomplex i2pi=I*2*M_PI/wvl[iwvl];
<a name="l00608"></a>00608     psf2s-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[iwvl]=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncomp,ncomp);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <a class="code" href="cmat_8h.html#5f6b5be2adda9848d051174da45fc340" title="initialize all numbers in a X(mat) object to 0">czero</a>(psf2);
<a name="l00611"></a>00611     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iloc=0; iloc&lt;iopdevl-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>; iloc++){
<a name="l00612"></a>00612         psf2-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>[embed[iloc]]=amp[iloc]*cexp(i2pi*iopdevl-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[iloc]);
<a name="l00613"></a>00613         <span class="comment">/*</span>
<a name="l00614"></a>00614 <span class="comment">        int ix=embed[iloc][0];</span>
<a name="l00615"></a>00615 <span class="comment">        int iy=embed[iloc][1];</span>
<a name="l00616"></a>00616 <span class="comment">        ppsf2[iy][ix]=amp[iloc]*cexp(i2pi*iopdevl-&gt;p[iloc]);</span>
<a name="l00617"></a>00617 <span class="comment">        */</span>
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619     <span class="keywordflow">if</span>(use1d==1){
<a name="l00620"></a>00620         <a class="code" href="fft_8c.html#b3159a1cba08cacee28341ac4fc74cd9" title="Apply 2d FFT partially over ncomp ncomp region use two 1d plans that takes 1d fft...">cfft2partial</a>(psf2,ncomp,-1);
<a name="l00621"></a>00621     }<span class="keywordflow">else</span>{
<a name="l00622"></a>00622         <a class="code" href="fft_8c.html#5e22d51b30da1c5c057cb5b8f121273d" title="Do 2d FFT transforms.">cfft2</a>(psf2,-1);
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624     <a class="code" href="cmat_8h.html#72f5647463dae0b89a5c8e444f580de0" title="reorder B and embed/crop into center of A">ccpcorner2center</a>(psf2s-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[iwvl], psf2);
<a name="l00625"></a>00625     
<a name="l00626"></a>00626     <span class="keywordflow">if</span>(fabs(psfnorm-1)&gt;1.e-15)
<a name="l00627"></a>00627         <a class="code" href="cmat_8h.html#204751357459432e00c5f5ee8d261f56" title="scale each element of A by w">cscale</a>(psf2s-&gt;<a class="code" href="structccell.html#be5a18937f4edac1e20c91da302d4838" title="Contains an array of pointers to cmat.">p</a>[iwvl], psfnorm);
<a name="l00628"></a>00628     cfree(psf2);
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630     <span class="keywordflow">return</span> psf2s;
<a name="l00631"></a>00631 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="bd8c62a4ca2f063bea3a863d2f7e0107"></a><!-- doxytag: member="utils.c::embed_in" ref="bd8c62a4ca2f063bea3a863d2f7e0107" args="(double *out, const double *in, long nin, long *embed)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void embed_in           </td>
          <td>(</td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&nbsp;</td>
          <td class="paramname"> <em>nin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long *&nbsp;</td>
          <td class="paramname"> <em>embed</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Simple embed and accumulation. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00635"></a>00635                                                                    {
<a name="l00636"></a>00636     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i=0; i&lt;nin; i++){
<a name="l00637"></a>00637     out[embed[i]]+=in[i];
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="82fb97c6bab04cdbdc0867c62c76626a"></a><!-- doxytag: member="utils.c::embed_out" ref="82fb97c6bab04cdbdc0867c62c76626a" args="(const double *out, double *in, long nin, long *embed)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void embed_out           </td>
          <td>(</td>
          <td class="paramtype">const double *&nbsp;</td>
          <td class="paramname"> <em>out</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>in</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&nbsp;</td>
          <td class="paramname"> <em>nin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long *&nbsp;</td>
          <td class="paramname"> <em>embed</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Simple embed and accumulation. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00643"></a>00643                                                                     {
<a name="l00644"></a>00644     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i=0; i&lt;nin; i++){
<a name="l00645"></a>00645     in[i]+=out[embed[i]];
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="a54aacd870579af5c2d7f1023f7a5624"></a><!-- doxytag: member="utils.c::lock_seeds" ref="a54aacd870579af5c2d7f1023f7a5624" args="(PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int lock_seeds           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Try to lock file for each seed. 
<p>
If file is already locked by other process, will not run that seed tox not step over other process's feet. <div class="fragment"><pre class="fragment"><a name="l00653"></a>00653                               {
<a name="l00654"></a>00654     <span class="keywordtype">char</span> fn[80];
<a name="l00655"></a>00655     <span class="keywordtype">int</span> to_run=0;
<a name="l00656"></a>00656     parms-&gt;<a class="code" href="structPARMS__T.html#9056c1024a1abf5fac4ac86f7edaf195" title="Records the fd of the seed lock file.">fdlock</a>=calloc(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#6021b395d1b8ca9bb3f3449b67ed7935" title="How many simulation seed.">nseed</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00657"></a>00657     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iseed=0; iseed&lt;parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#6021b395d1b8ca9bb3f3449b67ed7935" title="How many simulation seed.">nseed</a>; iseed++){
<a name="l00658"></a>00658     snprintf(fn, 80, <span class="stringliteral">"Res_%d.lock"</span>,parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#483429d04a2de324a443780025083dda" title="simulation seeds">seeds</a>[iseed]);
<a name="l00659"></a>00659     parms-&gt;<a class="code" href="structPARMS__T.html#9056c1024a1abf5fac4ac86f7edaf195" title="Records the fd of the seed lock file.">fdlock</a>[iseed]=lock_file(fn, 0);
<a name="l00660"></a>00660     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#9056c1024a1abf5fac4ac86f7edaf195" title="Records the fd of the seed lock file.">fdlock</a>[iseed]&lt;0){
<a name="l00661"></a>00661         warning(<span class="stringliteral">"Another MAOS is already running with seed %d. Skip\n"</span>,
<a name="l00662"></a>00662             parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#483429d04a2de324a443780025083dda" title="simulation seeds">seeds</a>[iseed]);
<a name="l00663"></a>00663     }<span class="keywordflow">else</span>{
<a name="l00664"></a>00664         to_run++;
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     }
<a name="l00667"></a>00667     <span class="keywordflow">return</span> to_run;
<a name="l00668"></a>00668 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="5c7b446004c896c4369a93a863815d77"></a><!-- doxytag: member="utils.c::calc_aniso" ref="5c7b446004c896c4369a93a863815d77" args="(double r0, int nht, double *ht, double *wt)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double calc_aniso           </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>r0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>nht</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>ht</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>wt</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Estimate anisoplanatic angle theta0 from Fried parameter r0, layer height and weights. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00672"></a>00672                                                              {
<a name="l00673"></a>00673     <span class="keywordtype">double</span> wh=0;
<a name="l00674"></a>00674     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iht=0; iht&lt;nht; iht++){
<a name="l00675"></a>00675     wh+=pow(ht[iht],5./3.)*wt[iht];
<a name="l00676"></a>00676     }
<a name="l00677"></a>00677     <span class="keywordflow">return</span> 0.3144*r0*pow(wh,-3./5.);
<a name="l00678"></a>00678 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="066f38258e20d362d1e184a397697828"></a><!-- doxytag: member="utils.c::calc_aniso2" ref="066f38258e20d362d1e184a397697828" args="(double r0, int nht, double *ht, double *wt, double hc1, double hc2)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double calc_aniso2           </td>
          <td>(</td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>r0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>nht</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>ht</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double *&nbsp;</td>
          <td class="paramname"> <em>wt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>hc1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>hc2</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Estimate generalized aniso angle theta2 from Fried parameter r0, and layer height and weights, and deformable mirror conjugation heights hc1 hc2 of the ground and altitude DMs. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00683"></a>00683                                                                                       {
<a name="l00684"></a>00684     <span class="keywordtype">double</span> wh=0;
<a name="l00685"></a>00685     <span class="keywordtype">double</span> hh=pow(hc2-hc1,5./3.);
<a name="l00686"></a>00686     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iht=0; iht&lt;nht; iht++){
<a name="l00687"></a>00687     <span class="keywordtype">double</span> t1=0.5*pow(fabs(ht[iht]-hc1),5./3.)+0.5*pow(fabs(ht[iht]-hc2),5./3.);
<a name="l00688"></a>00688     <span class="keywordtype">double</span> t2=-0.25*hh-0.25/hh*pow(pow(fabs(ht[iht]-hc1),5./3.)-pow(fabs(ht[iht]-hc2),5./3.),2);
<a name="l00689"></a>00689     wh+=wt[iht]*(t1+t2);
<a name="l00690"></a>00690     }
<a name="l00691"></a>00691     <span class="keywordflow">return</span> 0.3144*r0*pow(wh,-3./5.);
<a name="l00692"></a>00692 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 21:16:58 2010 for maos-0.7.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
