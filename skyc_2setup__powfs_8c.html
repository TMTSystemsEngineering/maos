<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.7.0: skyc/setup_powfs.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>skyc/setup_powfs.c File Reference</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="skyc_2setup__powfs_8c.html#6e9ea05733a2e89ae27d5e629222c5eb">setup_powfs_dtf</a> (<a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the detector transfer functions.  <a href="#6e9ea05733a2e89ae27d5e629222c5eb"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="skyc_2setup__powfs_8c.html#01e3c9cc1622aa109662cc79432f9362">read_powfs_locamp</a> (<a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Read in the WFS grid and amplitude map.  <a href="#01e3c9cc1622aa109662cc79432f9362"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="skyc_2setup__powfs_8c.html#e350ab3f79bb8723c5e20e7950827f3d">setup_powfs_coarseloc</a> (<a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup the corase loc grid corresponding to coarse sampled complex pupil function.  <a href="#e350ab3f79bb8723c5e20e7950827f3d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="skyc_2setup__powfs_8c.html#0680a79e841767fcc4ce6023b600aced">setup_powfs_dettf</a> (<a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Method to demote TTF.  <a href="#0680a79e841767fcc4ce6023b600aced"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="skyc_2setup__powfs_8c.html#9fd5284932263fee238a4f1bcf8f78d1">setup_powfs</a> (<a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Setup <a class="el" href="structPOWFS__S.html" title="Struct for POWFS.">POWFS_S</a> struct.  <a href="#9fd5284932263fee238a4f1bcf8f78d1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="skyc_2setup__powfs_8c.html#81c84b70d9bcb9f0e5f104289fff4bf8">free_powfs</a> (<a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Release memory.  <a href="#81c84b70d9bcb9f0e5f104289fff4bf8"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="6e9ea05733a2e89ae27d5e629222c5eb"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_dtf" ref="6e9ea05733a2e89ae27d5e629222c5eb" args="(POWFS_S *powfs, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_dtf           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__S.html">POWFS_S</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup the detector transfer functions. 
<p>
See <a class="el" href="maos_2setup__powfs_8c.html" title="Setting up WFS geometry like the subaperture location, subaperture grid points, physical...">maos/setup_powfs.c</a> <div class="fragment"><pre class="fragment"><a name="l00029"></a>00029                                                                  {
<a name="l00030"></a>00030     <span class="keyword">const</span> <span class="keywordtype">int</span> npowfs=parms-&gt;maos.npowfs;
<a name="l00031"></a>00031     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs; ipowfs++){
<a name="l00032"></a>00032     <span class="keyword">const</span> <span class="keywordtype">int</span> ncomp=parms-&gt;maos.ncomp[ipowfs];
<a name="l00033"></a>00033     <span class="keyword">const</span> <span class="keywordtype">int</span> ncomp2=ncomp&gt;&gt;1;
<a name="l00034"></a>00034     <span class="keyword">const</span> <span class="keywordtype">int</span> embfac=parms-&gt;maos.embfac[ipowfs];
<a name="l00035"></a>00035     <span class="keyword">const</span> <span class="keywordtype">int</span> pixpsa=parms-&gt;skyc.pixpsa[ipowfs];
<a name="l00036"></a>00036     <span class="keyword">const</span> <span class="keywordtype">double</span> pixtheta=parms-&gt;skyc.pixtheta[ipowfs];
<a name="l00037"></a>00037     <span class="keyword">const</span> <span class="keywordtype">double</span> blur=parms-&gt;skyc.pixblur[ipowfs]*pixtheta;
<a name="l00038"></a>00038     <span class="keyword">const</span> <span class="keywordtype">double</span> e0=exp(-2*M_PI*M_PI*blur*blur);
<a name="l00039"></a>00039     <span class="keyword">const</span> <span class="keywordtype">double</span> dxsa=parms-&gt;maos.dxsa[ipowfs];
<a name="l00040"></a>00040     <span class="keyword">const</span> <span class="keywordtype">double</span> pixoffx=parms-&gt;skyc.pixoffx[ipowfs];
<a name="l00041"></a>00041     <span class="keyword">const</span> <span class="keywordtype">double</span> pixoffy=parms-&gt;skyc.pixoffy[ipowfs];
<a name="l00042"></a>00042     <span class="keyword">const</span> <span class="keywordtype">double</span> pxo=-(pixpsa/2-0.5+pixoffx)*pixtheta;
<a name="l00043"></a>00043     <span class="keyword">const</span> <span class="keywordtype">double</span> pyo=-(pixpsa/2-0.5+pixoffy)*pixtheta;
<a name="l00044"></a>00044     <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc_ccd=<a class="code" href="loc_8c.html#9b68fa77107ecb06a9407fe1ad31eb24" title="Create a loc array contains coorindates in a square map of size nx*ny, with sampling...">mksqloc</a>(pixpsa, pixpsa, pixtheta, pxo, pyo);
<a name="l00045"></a>00045     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#2ec71b0be1ddaad0b8bf97d534779c19" title="array of dtf for each wvl">dtf</a>=calloc(parms-&gt;maos.nwvl, <span class="keyword">sizeof</span>(<a class="code" href="structDTF__S.html" title="Detector transfer function.">DTF_S</a>));
<a name="l00046"></a>00046     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;parms-&gt;maos.nwvl; iwvl++){
<a name="l00047"></a>00047         <span class="keyword">const</span> <span class="keywordtype">double</span> wvl=parms-&gt;maos.wvl[iwvl];
<a name="l00048"></a>00048         <span class="keyword">const</span> <span class="keywordtype">double</span> dtheta=wvl/(dxsa*embfac);
<a name="l00049"></a>00049         <span class="keyword">const</span> <span class="keywordtype">double</span> pdtheta=pixtheta*pixtheta/(dtheta*dtheta);
<a name="l00050"></a>00050         <span class="keyword">const</span> <span class="keywordtype">double</span> du=1./(dtheta*ncomp);
<a name="l00051"></a>00051         <span class="keyword">const</span> <span class="keywordtype">double</span> du2=du*du;
<a name="l00052"></a>00052         <span class="keyword">const</span> <span class="keywordtype">double</span> dupth=du*pixtheta;
<a name="l00053"></a>00053         <a class="code" href="structcmat.html" title="a double complex matrix object contains 2-d arrays of double complex numbers.">cmat</a> *nominal=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncomp,ncomp);
<a name="l00054"></a>00054         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(nominal,-1);
<a name="l00055"></a>00055         <a class="code" href="fft_8c.html#8b872386a7d070a175aa54dadcf2c68e" title="Create FFTW plans for 2d FFT transforms.">cfft2plan</a>(nominal,1);
<a name="l00056"></a>00056         PCMAT(nominal,pn);
<a name="l00057"></a>00057         <span class="keyword">const</span> <span class="keywordtype">double</span> theta=0;
<a name="l00058"></a>00058         <span class="keyword">const</span> <span class="keywordtype">double</span> ct=cos(theta);
<a name="l00059"></a>00059         <span class="keyword">const</span> <span class="keywordtype">double</span> st=sin(theta);
<a name="l00060"></a>00060         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy=0; iy&lt;ncomp; iy++){
<a name="l00061"></a>00061         <span class="keywordtype">int</span> jy=iy-ncomp2;
<a name="l00062"></a>00062         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;ncomp; ix++){
<a name="l00063"></a>00063             <span class="keywordtype">int</span> jx=ix-ncomp2;
<a name="l00064"></a>00064             <span class="keywordtype">double</span> ir=ct*jx+st*jy;
<a name="l00065"></a>00065             <span class="keywordtype">double</span> ia=-st*jx+ct*jy;
<a name="l00066"></a>00066             pn[iy][ix]=sinc(ir*dupth)*sinc(ia*dupth)
<a name="l00067"></a>00067             *pow(e0,ir*ir*du2)*pow(e0,ia*ia*du2)
<a name="l00068"></a>00068             *pdtheta;
<a name="l00069"></a>00069         }
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071         <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(nominal);
<a name="l00072"></a>00072         <a class="code" href="fft_8c.html#5e22d51b30da1c5c057cb5b8f121273d" title="Do 2d FFT transforms.">cfft2</a>(nominal,-1);
<a name="l00073"></a>00073         <a class="code" href="cmat_8h.html#2e68e24dcc5d7ffd8d9b2c575e0830b9" title="shift frequency components by n/2">cfftshift</a>(nominal);
<a name="l00074"></a>00074         <a class="code" href="fft_8c.html#b773d97e4de22b835cebd7b622f60ee2" title="Do 2d inverse FFT (scaling factor of 1/(nx*ny) is applied).">cifft2</a>(nominal,1);
<a name="l00075"></a>00075         <a class="code" href="cmat_8h.html#db3c55ee96a9e7249403f738d251688c" title="copy the values from one X(mat) to another.">ccp</a>(&amp;powfs[ipowfs].dtf[iwvl].nominal, nominal);
<a name="l00076"></a>00076         cfree(nominal);
<a name="l00077"></a>00077 
<a name="l00078"></a>00078         <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc_psf=<a class="code" href="loc_8c.html#9b68fa77107ecb06a9407fe1ad31eb24" title="Create a loc array contains coorindates in a square map of size nx*ny, with sampling...">mksqloc</a>(ncomp, ncomp, dtheta, -ncomp2*dtheta, -ncomp2*dtheta);
<a name="l00079"></a>00079         powfs[ipowfs].<a class="code" href="structPOWFS__S.html#2ec71b0be1ddaad0b8bf97d534779c19" title="array of dtf for each wvl">dtf</a>[iwvl].<a class="code" href="structDTF__S.html#48ac12e36ce9ecde7e21ad9a240b5f8b" title="The pixel selection.">si</a>=<a class="code" href="mkh_8c.html#7164e1a11394d36094ddd13e916a0340" title="Create ray tracing operator from coordinate locin to locout.">mkh</a>(loc_psf,loc_ccd,NULL,0,0,1,0,0);
<a name="l00080"></a>00080         locfree(loc_psf);
<a name="l00081"></a>00081         <span class="keywordflow">if</span>(parms-&gt;skyc.dbg){
<a name="l00082"></a>00082         <a class="code" href="cmat_8h.html#9593e890699be4f48e826d9048018c04" title="User callable function to write dense matrix into a file.">cwrite</a>(powfs[ipowfs].dtf[iwvl].nominal,
<a name="l00083"></a>00083                <span class="stringliteral">"%s/powfs%d_dtf%d_nominal.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l00084"></a>00084         <a class="code" href="dmat_8h.html#779cefb17e24b648212cc59f9324f5ae" title="User callable function to write sparse matrix into file.">spwrite</a>(powfs[ipowfs].dtf[iwvl].si,
<a name="l00085"></a>00085             <span class="stringliteral">"%s/powfs%d_dtf%d_si.bin.gz"</span>,dirsetup,ipowfs,iwvl);
<a name="l00086"></a>00086         }
<a name="l00087"></a>00087         powfs[ipowfs].<a class="code" href="structPOWFS__S.html#2ec71b0be1ddaad0b8bf97d534779c19" title="array of dtf for each wvl">dtf</a>[iwvl].<a class="code" href="structDTF__S.html#bab8285eff3c934cab29be046162a15b" title="Special frequency vector along x.">U</a>=<a class="code" href="cmat_8h.html#bb2b86ffc48237c760e652708aaf1415" title="Create a new T matrix object.">cnew</a>(ncomp,1);
<a name="l00088"></a>00088         dcomplex *U=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#2ec71b0be1ddaad0b8bf97d534779c19" title="array of dtf for each wvl">dtf</a>[iwvl].<a class="code" href="structDTF__S.html#bab8285eff3c934cab29be046162a15b" title="Special frequency vector along x.">U</a>-&gt;<a class="code" href="structcmat.html#8b3042714ec7576bcdb1204030e8532a" title="the pointer to allocated memory.">p</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix=0; ix&lt;ncomp; ix++){
<a name="l00091"></a>00091         <span class="keywordtype">int</span> jx=ix&lt;ncomp2?ix:(ix-ncomp);
<a name="l00092"></a>00092         U[ix]=-2.*I*M_PI*jx*du;
<a name="l00093"></a>00093         }
<a name="l00094"></a>00094     }<span class="comment">//iwvl</span>
<a name="l00095"></a>00095     locfree(loc_ccd);
<a name="l00096"></a>00096     }<span class="comment">//ipowfs</span>
<a name="l00097"></a>00097 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="01e3c9cc1622aa109662cc79432f9362"></a><!-- doxytag: member="setup_powfs.c::read_powfs_locamp" ref="01e3c9cc1622aa109662cc79432f9362" args="(POWFS_S *powfs, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void read_powfs_locamp           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__S.html">POWFS_S</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Read in the WFS grid and amplitude map. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00101"></a>00101                                                                    {
<a name="l00102"></a>00102     <span class="keyword">const</span> <span class="keywordtype">int</span> npowfs=parms-&gt;maos.npowfs;
<a name="l00103"></a>00103     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs; ipowfs++){
<a name="l00104"></a>00104     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#e045c7d644a0dd7bd9ae8d80412ba283" title="explicit pts in a regular grid.">loc</a>=locread(<span class="stringliteral">"%s"</span>,parms-&gt;maos.fnwfsloc[ipowfs]);
<a name="l00105"></a>00105     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#e1b5990c1739ccabf1c16ecfbe6e4e1f" title="amplitude map defined on loc">amp</a>=<a class="code" href="dmat_8h.html#6406403e91ec976bb0d6c2e12b5d5a0f" title="User callable function to read dense matrix into memory from file.">dread</a>(<span class="stringliteral">"%s"</span>,parms-&gt;maos.fnwfsamp[ipowfs]);
<a name="l00106"></a>00106     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#25e4b1023ba3b2ce11fd793583b287af" title="subaperture location">saloc</a>=locread(<span class="stringliteral">"%s"</span>,parms-&gt;maos.fnsaloc[ipowfs]);
<a name="l00107"></a>00107     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#25e4b1023ba3b2ce11fd793583b287af" title="subaperture location">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ae9e38522a793c7d018028a38fc34ce0" title="Sampling.">dx</a>=parms-&gt;maos.dxsa[ipowfs];
<a name="l00108"></a>00108     <span class="keyword">const</span> <a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a> *loc=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#e045c7d644a0dd7bd9ae8d80412ba283" title="explicit pts in a regular grid.">loc</a>;
<a name="l00109"></a>00109     <span class="keyword">const</span> <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *amp=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#e1b5990c1739ccabf1c16ecfbe6e4e1f" title="amplitude map defined on loc">amp</a>;
<a name="l00110"></a>00110     <span class="keyword">const</span> <span class="keywordtype">long</span> nsa=parms-&gt;maos.nsa[ipowfs];
<a name="l00111"></a>00111     <span class="keyword">const</span> <span class="keywordtype">long</span> ptspsa=loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>/nsa;
<a name="l00112"></a>00112     <span class="keywordflow">if</span>(loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>!=nsa*ptspsa){
<a name="l00113"></a>00113         error(<span class="stringliteral">"loc %ld does not divide to %ld sa\n"</span>,loc-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>, nsa);
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#70d0cb0bbf7ca40967b8ba9269ada83d" title="dot(loc-&amp;gt;locx,amp);">locxamp</a>=calloc(nsa,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00116"></a>00116     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#4914f5c1129c558188f045183e27f02e" title="dot(loc-&amp;gt;locy,amp);">locyamp</a>=calloc(nsa,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00117"></a>00117     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> isa=0; isa&lt;nsa; isa++){
<a name="l00118"></a>00118         <span class="keyword">const</span> <span class="keywordtype">double</span>* iamp=amp-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>+isa*ptspsa;
<a name="l00119"></a>00119         <span class="keyword">const</span> <span class="keywordtype">double</span>* locx=loc-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>+isa*ptspsa;
<a name="l00120"></a>00120         <span class="keyword">const</span> <span class="keywordtype">double</span>* locy=loc-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>+isa*ptspsa;
<a name="l00121"></a>00121         <span class="keywordtype">double</span> ampsum=0, locxamp=0, locyamp=0;
<a name="l00122"></a>00122         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> iloc=0; iloc&lt;ptspsa; iloc++){
<a name="l00123"></a>00123         ampsum+=iamp[iloc];
<a name="l00124"></a>00124         locxamp+=iamp[iloc]*locx[iloc];
<a name="l00125"></a>00125         locyamp+=iamp[iloc]*locy[iloc];
<a name="l00126"></a>00126         }
<a name="l00127"></a>00127         powfs[ipowfs].<a class="code" href="structPOWFS__S.html#70d0cb0bbf7ca40967b8ba9269ada83d" title="dot(loc-&amp;gt;locx,amp);">locxamp</a>[isa]=locxamp/ampsum;
<a name="l00128"></a>00128         powfs[ipowfs].<a class="code" href="structPOWFS__S.html#4914f5c1129c558188f045183e27f02e" title="dot(loc-&amp;gt;locy,amp);">locyamp</a>[isa]=locyamp/ampsum;
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="e350ab3f79bb8723c5e20e7950827f3d"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_coarseloc" ref="e350ab3f79bb8723c5e20e7950827f3d" args="(POWFS_S *powfs, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_coarseloc           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__S.html">POWFS_S</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup the corase loc grid corresponding to coarse sampled complex pupil function. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00135"></a>00135                                                                        {
<a name="l00136"></a>00136     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ipowfs=0; ipowfs&lt;parms-&gt;maos.npowfs; ipowfs++){
<a name="l00137"></a>00137     <span class="keyword">const</span> <span class="keywordtype">long</span> nsa=parms-&gt;maos.nsa[ipowfs];
<a name="l00138"></a>00138     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#980481967ff7298e53c5e3d3b14ee1e3" title="coarse loc;">cloc</a>=calloc(nsa, <span class="keyword">sizeof</span>(<a class="code" href="structLOC__T.html" title="Struct for loc like plocs, xloc, aloc etc.">LOC_T</a>*));
<a name="l00139"></a>00139     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#00ea5fe621e43878a94db6a087e2cf9a" title="focus-piston-coupling.">fpc</a>=calloc(nsa,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="keyword">const</span> <span class="keywordtype">long</span> ptspsa=parms-&gt;maos.ncomp[ipowfs]/2;
<a name="l00142"></a>00142     <span class="keyword">const</span> <span class="keywordtype">double</span> dxsa=parms-&gt;maos.dxsa[ipowfs];
<a name="l00143"></a>00143     <span class="keywordtype">double</span> dx=dxsa/ptspsa;
<a name="l00144"></a>00144     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> isa=0; isa&lt;nsa; isa++){
<a name="l00145"></a>00145         <span class="keywordtype">double</span> ox=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#25e4b1023ba3b2ce11fd793583b287af" title="subaperture location">saloc</a>-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>[isa]+dx*0.5;
<a name="l00146"></a>00146         <span class="keywordtype">double</span> oy=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#25e4b1023ba3b2ce11fd793583b287af" title="subaperture location">saloc</a>-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>[isa]+dx*0.5;
<a name="l00147"></a>00147         powfs[ipowfs].<a class="code" href="structPOWFS__S.html#980481967ff7298e53c5e3d3b14ee1e3" title="coarse loc;">cloc</a>[isa]=<a class="code" href="loc_8c.html#9b68fa77107ecb06a9407fe1ad31eb24" title="Create a loc array contains coorindates in a square map of size nx*ny, with sampling...">mksqloc</a>(ptspsa,ptspsa,dx,ox,oy);
<a name="l00148"></a>00148         <span class="keywordflow">if</span>(parms-&gt;skyc.dbg){
<a name="l00149"></a>00149         locwrite(powfs[ipowfs].cloc[isa],<span class="stringliteral">"%s/powfs%ld_cloc%ld.bin.gz"</span>,
<a name="l00150"></a>00150              dirsetup, ipowfs, isa);
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152         <span class="keywordtype">double</span> fpc=0;
<a name="l00153"></a>00153         <span class="keyword">const</span> <span class="keywordtype">double</span> *locx=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#980481967ff7298e53c5e3d3b14ee1e3" title="coarse loc;">cloc</a>[isa]-&gt;<a class="code" href="structLOC__T.html#ed5d420f317a8b4d3f723c02d66a81d4" title="x coordinates of each point">locx</a>;
<a name="l00154"></a>00154         <span class="keyword">const</span> <span class="keywordtype">double</span> *locy=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#980481967ff7298e53c5e3d3b14ee1e3" title="coarse loc;">cloc</a>[isa]-&gt;<a class="code" href="structLOC__T.html#a265d16ab090298e35c3315fcb8daf59" title="y coordinates of each point">locy</a>;
<a name="l00155"></a>00155         <span class="keyword">const</span> <span class="keywordtype">long</span> nloc=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#980481967ff7298e53c5e3d3b14ee1e3" title="coarse loc;">cloc</a>[isa]-&gt;<a class="code" href="structLOC__T.html#fa098eeedb2e665fdd77526f1ff2ca8a" title="number of points">nloc</a>;
<a name="l00156"></a>00156         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> iloc=0; iloc&lt;nloc; iloc++){
<a name="l00157"></a>00157         fpc+=locx[iloc]*locx[iloc]+locy[iloc]*locy[iloc];
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159         powfs[ipowfs].<a class="code" href="structPOWFS__S.html#00ea5fe621e43878a94db6a087e2cf9a" title="focus-piston-coupling.">fpc</a>[isa]=fpc/nloc;
<a name="l00160"></a>00160         <span class="comment">//info("powfs[%ld].fpc[%ld]=%g\n",ipowfs,isa,powfs[ipowfs].fpc[isa]);</span>
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162     }
<a name="l00163"></a>00163 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0680a79e841767fcc4ce6023b600aced"></a><!-- doxytag: member="setup_powfs.c::setup_powfs_dettf" ref="0680a79e841767fcc4ce6023b600aced" args="(POWFS_S *powfs, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_powfs_dettf           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__S.html">POWFS_S</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Method to demote TTF. 
<p>
deprecated. <div class="fragment"><pre class="fragment"><a name="l00167"></a>00167                                                                    {
<a name="l00168"></a>00168     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ipowfs=0; ipowfs&lt;parms-&gt;maos.npowfs; ipowfs++){
<a name="l00169"></a>00169     <span class="keyword">const</span> <span class="keywordtype">long</span> nsa=parms-&gt;maos.nsa[ipowfs];
<a name="l00170"></a>00170     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#8b4c24e9dee6a649d2cc212e65693f96" title="matrix to demote TTF to TT">dettf</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(2,nsa*2);  
<a name="l00171"></a>00171     <span class="keywordflow">if</span>(nsa==1){
<a name="l00172"></a>00172         <a class="code" href="dmat_8h.html#42490ea31b5b30b0b618f417c76bd712" title="add val to diagonal values of A.">daddI</a>(powfs[ipowfs].dettf, 1);
<a name="l00173"></a>00173     }<span class="keywordflow">else</span>{
<a name="l00174"></a>00174         PDMAT(powfs[ipowfs].dettf, ppdettf);
<a name="l00175"></a>00175         <span class="keywordtype">double</span> insa=1./nsa;
<a name="l00176"></a>00176         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> ig=0; ig&lt;2; ig++){
<a name="l00177"></a>00177         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> isa=0; isa&lt;nsa; isa++){
<a name="l00178"></a>00178             ppdettf[isa+nsa*ig][ig]=insa;
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="9fd5284932263fee238a4f1bcf8f78d1"></a><!-- doxytag: member="setup_powfs.c::setup_powfs" ref="9fd5284932263fee238a4f1bcf8f78d1" args="(POWFS_S *powfs, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup_powfs           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__S.html">POWFS_S</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Setup <a class="el" href="structPOWFS__S.html" title="Struct for POWFS.">POWFS_S</a> struct. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00187"></a>00187                                                       {
<a name="l00188"></a>00188     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;parms-&gt;maos.npowfs; ipowfs++){
<a name="l00189"></a>00189     powfs[ipowfs].<a class="code" href="structPOWFS__S.html#9f66199497a89d6622b6ca31b76bc7a8" title="Which ipowfs this is.">ipowfs</a>=ipowfs;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191     <a class="code" href="maos_2setup__powfs_8c.html#b1890fbc6facc2013338054962b1398a" title="Setting up Detector transfer function used to translate PSFs from FFTs to detector...">setup_powfs_dtf</a>(powfs, parms);
<a name="l00192"></a>00192     <a class="code" href="skyc_2setup__powfs_8c.html#01e3c9cc1622aa109662cc79432f9362" title="Read in the WFS grid and amplitude map.">read_powfs_locamp</a>(powfs, parms);
<a name="l00193"></a>00193     <a class="code" href="skyc_2setup__powfs_8c.html#e350ab3f79bb8723c5e20e7950827f3d" title="Setup the corase loc grid corresponding to coarse sampled complex pupil function...">setup_powfs_coarseloc</a>(powfs,parms);
<a name="l00194"></a>00194     <a class="code" href="skyc_2setup__powfs_8c.html#0680a79e841767fcc4ce6023b600aced" title="Method to demote TTF.">setup_powfs_dettf</a>(powfs,parms);
<a name="l00195"></a>00195 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="81c84b70d9bcb9f0e5f104289fff4bf8"></a><!-- doxytag: member="setup_powfs.c::free_powfs" ref="81c84b70d9bcb9f0e5f104289fff4bf8" args="(POWFS_S *powfs, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_powfs           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPOWFS__S.html">POWFS_S</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Release memory. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00199"></a>00199                                                      {
<a name="l00200"></a>00200     <span class="keyword">const</span> <span class="keywordtype">int</span> npowfs=parms-&gt;maos.npowfs;
<a name="l00201"></a>00201     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs; ipowfs++){
<a name="l00202"></a>00202     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iwvl=0; iwvl&lt;parms-&gt;maos.nwvl; iwvl++){
<a name="l00203"></a>00203         cfree(powfs[ipowfs].dtf[iwvl].U);
<a name="l00204"></a>00204         cfree(powfs[ipowfs].dtf[iwvl].nominal);
<a name="l00205"></a>00205         spfree(powfs[ipowfs].dtf[iwvl].si);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207     free(powfs[ipowfs].dtf);
<a name="l00208"></a>00208     locfree(powfs[ipowfs].loc);
<a name="l00209"></a>00209     locfree(powfs[ipowfs].saloc);
<a name="l00210"></a>00210     locarrfree(powfs[ipowfs].cloc, parms-&gt;maos.nsa[ipowfs]);
<a name="l00211"></a>00211     free(powfs[ipowfs].fpc);
<a name="l00212"></a>00212     dfree(powfs[ipowfs].amp);
<a name="l00213"></a>00213     free(powfs[ipowfs].locxamp);
<a name="l00214"></a>00214     free(powfs[ipowfs].locyamp);
<a name="l00215"></a>00215     dfree(powfs[ipowfs].dettf);
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 21:16:58 2010 for maos-0.7.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
