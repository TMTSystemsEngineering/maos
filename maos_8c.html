<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.6.1: maos/maos.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>maos/maos.c File Reference</h1>Contains <a class="el" href="maos_8c.html#3c04138a5bfe5d72780bb7e82a18e627" title="This is the standard entrance routine to the program.">main()</a> and the entry into simulation <a class="el" href="maos_8c.html#03b12a216d3e6a33a008f5e35da726e3" title="This is the routine that calls various functions to do the simulation.">maos()</a>.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_8c.html#03b12a216d3e6a33a008f5e35da726e3">maos</a> (const <a class="el" href="structPARMS__T.html">PARMS_T</a> *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This is the routine that calls various functions to do the simulation.  <a href="#03b12a216d3e6a33a008f5e35da726e3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="maos_8c.html#3c04138a5bfe5d72780bb7e82a18e627">main</a> (int argc, char **argv)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This is the standard entrance routine to the program.  <a href="#3c04138a5bfe5d72780bb7e82a18e627"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
Contains <a class="el" href="maos_8c.html#3c04138a5bfe5d72780bb7e82a18e627" title="This is the standard entrance routine to the program.">main()</a> and the entry into simulation <a class="el" href="maos_8c.html#03b12a216d3e6a33a008f5e35da726e3" title="This is the routine that calls various functions to do the simulation.">maos()</a>. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="03b12a216d3e6a33a008f5e35da726e3"></a><!-- doxytag: member="maos.c::maos" ref="03b12a216d3e6a33a008f5e35da726e3" args="(const PARMS_T *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void maos           </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structPARMS__T.html">PARMS_T</a> *&nbsp;</td>
          <td class="paramname"> <em>parms</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This is the routine that calls various functions to do the simulation. 
<p>
<a class="el" href="maos_8c.html#03b12a216d3e6a33a008f5e35da726e3" title="This is the routine that calls various functions to do the simulation.">maos()</a> calls <a class="el" href="setup__aper_8c.html#bf63108c7633e5a353e73cd913fc9c26" title="Setting up aperture cordinate grid aper_locs, and amplitude map for performance evaluation...">setup_aper()</a>, <a class="el" href="maos_2setup__powfs_8c.html#c7b704504acb96d7fbcbdd60f15c6cf8" title="Setup the powfs struct based on parms and aper.">setup_powfs()</a>, and <a class="el" href="setup__recon_8c.html#6ec32666222d37047d7775b874969a2e" title="Sets up the reconstruction structs including wavefront reconstructor and DM fitting...">setup_recon()</a> to set up the aperture (of type <a class="el" href="structAPER__T.html" title="contains the data associated with the aperture and performance evaluation.">APER_T</a>), wfs (of type <a class="el" href="structPOWFS__T.html" title="contains the data associated with a certain type of WFS.">POWFS_T</a>), and reconstructor (of type <a class="el" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a>) structs and then hands control to <a class="el" href="sim_8c.html#b5fd8ff2c1fe7a6270dad89ec5da4873" title="Closed loop simulation main loop.">sim()</a>, which then stars the simulation. <div class="fragment"><pre class="fragment"><a name="l00530"></a>00530                                {    
<a name="l00531"></a>00531     <a class="code" href="structAPER__T.html" title="contains the data associated with the aperture and performance evaluation.">APER_T</a>  * aper;
<a name="l00532"></a>00532     <a class="code" href="structPOWFS__T.html" title="contains the data associated with a certain type of WFS.">POWFS_T</a> * powfs;
<a name="l00533"></a>00533     <a class="code" href="structRECON__T.html" title="contains data related to wavefront reconstruction and DM fitting.">RECON_T</a> * recon;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     aper  = <a class="code" href="setup__aper_8c.html#bf63108c7633e5a353e73cd913fc9c26" title="Setting up aperture cordinate grid aper_locs, and amplitude map for performance evaluation...">setup_aper</a>(parms);
<a name="l00536"></a>00536     info2(<span class="stringliteral">"After setup_aper:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l00537"></a>00537     powfs = <a class="code" href="maos_2setup__powfs_8c.html#c7b704504acb96d7fbcbdd60f15c6cf8" title="Setup the powfs struct based on parms and aper.">setup_powfs</a>(parms, aper);
<a name="l00538"></a>00538     info2(<span class="stringliteral">"After setup_powfs:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l00539"></a>00539     
<a name="l00540"></a>00540     recon = <a class="code" href="setup__recon_8c.html#6ec32666222d37047d7775b874969a2e" title="Sets up the reconstruction structs including wavefront reconstructor and DM fitting...">setup_recon</a>(parms, powfs, aper);
<a name="l00541"></a>00541     info2(<span class="stringliteral">"After setup_recon:\t%.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l00542"></a>00542     <span class="comment">/*</span>
<a name="l00543"></a>00543 <span class="comment">      Before entering real simulation, make sure to delete all variables that</span>
<a name="l00544"></a>00544 <span class="comment">      won't be used later on to save memory.</span>
<a name="l00545"></a>00545 <span class="comment">    */</span>
<a name="l00546"></a>00546     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#8fdfce1e68e018f54640c3d7214fcc33" title="Specify debugging parameters.">dbg</a>.<a class="code" href="structDBG__CFG__T.html#3de775b1c4b44f88d8a856cbe05f8def" title="evaluate open loop error only">evlol</a>){
<a name="l00547"></a>00547     <a class="code" href="sim__utils_8c.html#1e1e48b76ff317024b24ae00f7096a56" title="Just do open loop error evalution.">sim_evlol</a>(parms, powfs, aper, recon);
<a name="l00548"></a>00548     }<span class="keywordflow">else</span>{
<a name="l00549"></a>00549     <a class="code" href="sim_8c.html#b5fd8ff2c1fe7a6270dad89ec5da4873" title="Closed loop simulation main loop.">sim</a>(parms, powfs, aper, recon);
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551     <span class="comment">/*Free all allocated memory in setup_* functions. So that we</span>
<a name="l00552"></a>00552 <span class="comment">      keep track of all the memory allocation.*/</span>
<a name="l00553"></a>00553     free_recon(parms, recon); recon=NULL;
<a name="l00554"></a>00554     <a class="code" href="maos_2setup__powfs_8c.html#4fdd29141f0d60af1fd7c6b2385f0031" title="Free all parameters of powfs at the end of simulation.">free_powfs</a>(parms, powfs); powfs=NULL;
<a name="l00555"></a>00555     <a class="code" href="setup__aper_8c.html#ea65e60525339d2921549850d52e8464" title="Free the aper structure after simulation.">free_aper</a>(aper); powfs=NULL;
<a name="l00556"></a>00556 <span class="preprocessor">#if USE_PTHREAD == 2</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7691a6a576a70e837fa68092a6ca26de" title="Number of threads to run the simulation.">nthread</a>&gt;1)
<a name="l00558"></a>00558     thr_pool_destroy(default_pool);
<a name="l00559"></a>00559 <span class="preprocessor">#endif</span>
<a name="l00560"></a>00560 <span class="preprocessor"></span>}
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="maos_8c_03b12a216d3e6a33a008f5e35da726e3_cgraph.png" border="0" usemap="#maos_8c_03b12a216d3e6a33a008f5e35da726e3_cgraph_map" alt=""></center>
<map name="maos_8c_03b12a216d3e6a33a008f5e35da726e3_cgraph_map">
<area shape="rect" id="node3" href="setup__aper_8c.html#ea65e60525339d2921549850d52e8464" title="Free the aper structure after simulation." alt="" coords="120,165,195,195"><area shape="rect" id="node5" href="maos_2setup__powfs_8c.html#4fdd29141f0d60af1fd7c6b2385f0031" title="Free all parameters of powfs at the end of simulation." alt="" coords="116,219,199,248"><area shape="rect" id="node7" href="setup__aper_8c.html#bf63108c7633e5a353e73cd913fc9c26" title="Setting up aperture cordinate grid aper_locs, and amplitude map for performance evaluation..." alt="" coords="115,272,200,301"><area shape="rect" id="node9" href="maos_2setup__powfs_8c.html#c7b704504acb96d7fbcbdd60f15c6cf8" title="Setup the powfs struct based on parms and aper." alt="" coords="111,325,204,355"><area shape="rect" id="node31" href="setup__recon_8c.html#6ec32666222d37047d7775b874969a2e" title="Sets up the reconstruction structs including wavefront reconstructor and DM fitting..." alt="" coords="111,1605,204,1635"><area shape="rect" id="node69" href="sim_8c.html#b5fd8ff2c1fe7a6270dad89ec5da4873" title="Closed loop simulation main loop." alt="" coords="136,805,179,835"><area shape="rect" id="node96" href="sim__utils_8c.html#1e1e48b76ff317024b24ae00f7096a56" title="Just do open loop error evalution." alt="" coords="120,619,195,648"><area shape="rect" id="node11" href="maos_2setup__powfs_8c.html#b1890fbc6facc2013338054962b1398a" title="Setting up Detector transfer function used to translate PSFs from FFTs to detector..." alt="" coords="283,5,397,35"><area shape="rect" id="node13" href="maos_2setup__powfs_8c.html#bd59ad37c2a3372a70066e4b5cf34ac1" title="Compute Elongation Transfer function." alt="" coords="283,59,397,88"><area shape="rect" id="node15" href="maos_2setup__powfs_8c.html#7bbae2bc69e06f553d55c7c2d8c68ff3" title="setup the range to sodium layer as an additional parameter." alt="" coords="275,112,405,141"><area shape="rect" id="node17" href="maos_2setup__powfs_8c.html#77b6fd986d6105964adf2c844ee9df87" title="setting up subaperture geometry." alt="" coords="273,165,407,195"><area shape="rect" id="node19" href="maos_2setup__powfs_8c.html#e92ae33f8f650cb9c7975044bd82432f" title="Creating geometric wavefront gradient operator GS0 and ZA0 from WFS OPD to subaperture..." alt="" coords="277,219,403,248"><area shape="rect" id="node21" href="maos_2setup__powfs_8c.html#a8ee626a374ebefb84c2d560793c4c1e" title="setting up uplink pts/amp lotf" alt="" coords="285,272,395,301"><area shape="rect" id="node23" href="maos_2setup__powfs_8c.html#a16bf88378b48f5765294689df77c22f" title="Setup the matched filter pixel processing parameters for physical optics wfs." alt="" coords="275,325,405,355"><area shape="rect" id="node25" href="maos_2setup__powfs_8c.html#2589e29c8b5c4bd05b33da3638e8ae53" title="Set up NCPA maps for each WFS." alt="" coords="276,379,404,408"><area shape="rect" id="node27" href="maos_2setup__powfs_8c.html#b1409e69dddf8131559ea35731109bda" title="Prepare the parameters for physical optics setup." alt="" coords="263,432,417,461"><area shape="rect" id="node29" href="maos_2setup__powfs_8c.html#e2eab1b8ad97f659e38afe630140834e" title="Load and smooth out sodium profile." alt="" coords="269,485,411,515"><area shape="rect" id="node33" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object." alt="" coords="476,1205,527,1235"><area shape="rect" id="node35" href="dmat_8h.html#a9c20ae37907780af63d91312d4fea38" title="creat a X(mat) reference an existing X(mat)." alt="" coords="319,1869,361,1899"><area shape="rect" id="node37" href="dmat_8h.html#705d6399ce6e7f7064d12f4eb131d47d" title="set values of each element in a X(mat) to val." alt="" coords="317,1923,363,1952"><area shape="rect" id="node39" href="fdpcg_8c.html#8af00f91380661f9d85542ac9738ba95" title="Prepare data for Tomography Fourier Domain Preconditioner." alt="" coords="289,1976,391,2005"><area shape="rect" id="node41" href="ahst_8c.html#55c65679c193d90bc7f5175ebb17733f" title="setup NGS modes and reconstructor using AHST for one or two DMs." alt="" coords="287,2029,393,2059"><area shape="rect" id="node43" href="setup__recon_8c.html#0182734530b87fcf5498aea2e8d1e5c0" title="Setup the deformable mirrors grid aloc." alt="" coords="279,2083,401,2112"><area shape="rect" id="node45" href="setup__recon_8c.html#f7a8a7478b06b8b4f0d27784819f41c2" title="Assemble the DM fitting matrix." alt="" coords="264,1179,416,1208"><area shape="rect" id="node47" href="setup__recon_8c.html#4f4abf13c9b0972de67fab348bb9f470" title="Create the reconstructor to reconstruct the residual focus error due to LGS sodium..." alt="" coords="275,1232,405,1261"><area shape="rect" id="node49" href="setup__recon_8c.html#61353f3760139816643f225db8e6d3bc" title="Setup gradient operator G0, GA on xloc, aloc." alt="" coords="272,1285,408,1315"><area shape="rect" id="node51" href="setup__recon_8c.html#fa92eb0639f142dd512c13688b21d813" title="Setup ray tracing operator HX,HA from xloc, aloc to aperture ploc." alt="" coords="273,1339,407,1368"><area shape="rect" id="node53" href="setup__recon_8c.html#3a5b99570039882f39e51b69236b1a0e" title="Prepare the propagation H matrix for MOAO and compute the reconstructor." alt="" coords="275,1392,405,1421"><area shape="rect" id="node55" href="setup__recon_8c.html#2bd8394adbdb99d342f9ac9d3a0faa6f" title="compute the MVST split tomography NGS mode reconstructor." alt="" coords="277,1445,403,1475"><area shape="rect" id="node57" href="setup__recon_8c.html#928f34035de84ed317aa075e7a7ddac9" title="Setting up PLOC grid, which is a coarse sampled (similar to subaperture spacing)..." alt="" coords="279,1499,401,1528"><area shape="rect" id="node59" href="setup__recon_8c.html#3f6cf2f9b4c4e8dbe3cba7df6a41fa9b" title="Setup the matrix of the inverse of gradient measurement noise equivalent angle covariance..." alt="" coords="271,1552,409,1581"><area shape="rect" id="node61" href="setup__recon_8c.html#764bf903a38cfc81220e42699e911884" title="assemble tomography matrix." alt="" coords="255,1605,425,1635"><area shape="rect" id="node63" href="setup__recon_8c.html#2ade74dd6feba7dba0a4b6f38fe134a8" title="Prepares for tomography." alt="" coords="260,1659,420,1688"><area shape="rect" id="node65" href="setup__recon_8c.html#caa963e8fb3e5e0201f312327e4d94e8" title="wrapps setup_recon_TTR() and setup_recon_DFR() to removal global tip/tilt and differential..." alt="" coords="275,1712,405,1741"><area shape="rect" id="node67" href="setup__recon_8c.html#93517d5a67108f02872fea3ca166df0a" title="Setup the tomography grids xloc which is used for Tomography." alt="" coords="279,1765,401,1795"><area shape="rect" id="node71" href="filter_8c.html#afaf3cf93da63d63bd5f43be060ffa9c" title="Does the servo filtering by calling filter_cl() or filter_ol()." alt="" coords="317,859,363,888"><area shape="rect" id="node73" href="sim__utils_8c.html#84b825eee317f2e6b919c95773cd847f" title="Release memory of simu (of type SIM_T) and close files." alt="" coords="301,645,379,675"><area shape="rect" id="node75" href="sim__utils_8c.html#399be906c89239f2d06949ee5df937ee" title="wrap of the generic vonkarman_genscreen to generate turbulence screens." alt="" coords="299,592,381,621"><area shape="rect" id="node78" href="sim__utils_8c.html#27c195134fbcb70dbf90b5ff2ee82a84" title="Initialize simu (of type SIM_T) and various simulation data structs." alt="" coords="303,699,377,728"><area shape="rect" id="node80" href="recon_8c.html#f62a4685464fea7bdd37d04c821c3caf" title="mao_recon happens after the common DM fitting and its integrator output to take into..." alt="" coords="293,912,387,941"><area shape="rect" id="node82" href="perfevl_8c.html#19afa47f9c816174b2fab7b46eba5c32" title="Evaluate performance by calling perfevl_ievl in parallel and then calls perfevl_mean..." alt="" coords="311,752,369,781"><area shape="rect" id="node84" href="sim__utils_8c.html#0be16bd01f2529c9b983cbc5db7fe691" title="Print out wavefront error information and timing at each time step." alt="" coords="288,539,392,568"><area shape="rect" id="node86" href="sim__utils_8c.html#245796513a02d7892e76cea88316394e" title="Save telemetry data during simulation every 50 time steps." alt="" coords="299,965,381,995"><area shape="rect" id="node88" href="sim__utils_8c.html#f566f334aaf19cf9ad3ed5a847c2aee9" title="Output parameters necessary to run postproc using skyc/skyc.c." alt="" coords="299,1019,381,1048"><area shape="rect" id="node90" href="sim__utils_8c.html#de5601f0c0ffa73c27aa90ec087d54ac" title="Evolving the Sodium layer by updating the elongation transfer function." alt="" coords="285,1072,395,1101"><area shape="rect" id="node92" href="recon_8c.html#17defa53668245c14cd494b9fab761f1" title="Calls tomo() and fit() to do the tomography and DM fit." alt="" coords="309,1125,371,1155"><area shape="rect" id="node94" href="wfsgrad_8c.html#99e7e23b2226afc767fc176f352f6e11" title="Calls wfsgrad_iwfs() to computes WFS gradient in parallel." alt="" coords="307,805,373,835"></map>
</div>

</div>
</div><p>
<a class="anchor" name="3c04138a5bfe5d72780bb7e82a18e627"></a><!-- doxytag: member="maos.c::main" ref="3c04138a5bfe5d72780bb7e82a18e627" args="(int argc, char **argv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main           </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>argv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This is the standard entrance routine to the program. 
<p>
It first calls <a class="el" href="maos_2parms_8h.html#97bc282d28009f59b0b4e51013062588" title="This routine calles other routines in this file to setup the parms parameter struct...">setup_parms()</a> to setup the simulation parameters and check for possible errors. It then waits for starting signal from the scheduler if in batch mode. Finally it hands the control to <a class="el" href="maos_8c.html#03b12a216d3e6a33a008f5e35da726e3" title="This is the routine that calls various functions to do the simulation.">maos()</a> to start the actual simulation.<p>
Call maos with overriding *.conf files or embed the overriding parameters in the command line to override the default parameters, e.g.<p>
<code>maos base.conf save.setup=1 'powfs.phystep=[0 100 100]'</code><p>
Any duplicate parameters will override the pervious specified value. The configure file nfiraos.conf will be loaded as the master .conf unless a -c switch is used with another .conf file. For scao simulations, call maos with -c switch and the right base .conf file.<p>
<code>maos -c scao_ngs.conf override.conf</code><p>
for scao NGS simulations<p>
<code>maos -c scao_lgs.conf override.conf</code><p>
for scao LGS simulations. With -c switch, nfiraos.conf will not be read, instead scao_ngs.conf or scao_lgs.conf are read as the master config file. Do not specify any parameter that are not understood by the code, otherwise maos will complain and exit to prevent accidental mistakes.<p>
Generally you link the maos executable into a folder that is in your PATH evironment or into the folder where you run simulations.<p>
Other optional parameters: <div class="fragment"><pre class="fragment">
   -d          do detach from console and not exit when logged out
   -s 2 -s 4   set seeds to [2 4]
   -n 4        launch 4 threads.
   -f          To disable job scheduler and force proceed
   </pre></div> In detached mode, drawing is automatically disabled. <div class="fragment"><pre class="fragment"><a name="l00602"></a>00602                                {
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordtype">char</span>*fn=mybasename(argv[0]);
<a name="l00605"></a>00605     <span class="keywordflow">if</span>(!strncmp(fn, <span class="stringliteral">"scheduler"</span>,9)){<span class="comment">//launch the scheduler.</span>
<a name="l00606"></a>00606     scheduler();
<a name="l00607"></a>00607     exit(0);
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609     <span class="keywordtype">char</span> *scmd=argv2str(argc,argv);
<a name="l00610"></a>00610     strcpy(argv[0],fn);
<a name="l00611"></a>00611     free(fn);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613     <a class="code" href="structARG__T.html" title="ARG_T is used for command line parsing.">ARG_T</a>* arg=<a class="code" href="maos_2utils_8c.html#cb9c938dc842d5c52a16c7443fdb4ae3" title="Parse command line arguments argc, argv.">parse_args</a>(argc,argv);
<a name="l00614"></a>00614     <span class="comment">/*In detach mode send to background and disable drawing*/</span>
<a name="l00615"></a>00615     <span class="keywordflow">if</span>(arg-&gt;<a class="code" href="structARG__T.html#2c3209f38638cec0a050260bab246299" title="Detach from the command line and run in background.">detach</a>){
<a name="l00616"></a>00616     disable_draw=1;<span class="comment">//disable drawing.</span>
<a name="l00617"></a>00617     <span class="comment">//info2("Sending to background\n");</span>
<a name="l00618"></a>00618     daemonize();
<a name="l00619"></a>00619     fprintf(stderr, <span class="stringliteral">"%s\n"</span>, scmd);
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621     info2(<span class="stringliteral">"MAOS Version %s. "</span>, PACKAGE_VERSION);
<a name="l00622"></a>00622 <span class="preprocessor">#ifdef SVN_REV</span>
<a name="l00623"></a>00623 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(strlen(SVN_REV)&gt;1 &amp;&amp; strcmp(SVN_REV,<span class="stringliteral">"exported"</span>)){
<a name="l00624"></a>00624     info2(<span class="stringliteral">"Revision %s. "</span>, SVN_REV);
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 <span class="preprocessor">#endif</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span>    info2(<span class="stringliteral">"Launched at %s in %s.\n"</span>,myasctime(),myhostname());
<a name="l00628"></a>00628     info2(<span class="stringliteral">"Compiled on %s %s by %s "</span>, __DATE__, __TIME__, __VERSION__);
<a name="l00629"></a>00629 <span class="preprocessor">#ifdef __OPTIMIZE__</span>
<a name="l00630"></a>00630 <span class="preprocessor"></span>    info2(<span class="stringliteral">"with optimization.\n"</span>);
<a name="l00631"></a>00631 <span class="preprocessor">#else</span>
<a name="l00632"></a>00632 <span class="preprocessor"></span>    info2(<span class="stringliteral">"without optimization!!!\n"</span>);
<a name="l00633"></a>00633 <span class="preprocessor">#endif</span>
<a name="l00634"></a>00634 <span class="preprocessor"></span>    <span class="comment">//register signal handler</span>
<a name="l00635"></a>00635     register_signal_handler(<a class="code" href="maos_2utils_8c.html#6331baae7550213ee98a12f9c3bbc5ce" title="Handles signals.">maos_signal_handler</a>);
<a name="l00636"></a>00636   
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     scheduler_start(scmd,arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>,!arg-&gt;<a class="code" href="structARG__T.html#c55657110f55a48957f1d60a18c4bf08" title="For start, bypassing scheduler.">force</a>);
<a name="l00639"></a>00639     <span class="comment">//setting up parameters before asking scheduler to check for any errors.</span>
<a name="l00640"></a>00640     <a class="code" href="structPARMS__T.html" title="is a wrapper of all _CFG_T data types.">PARMS_T</a> * parms=<a class="code" href="maos_2parms_8h.html#97bc282d28009f59b0b4e51013062588" title="This routine calles other routines in this file to setup the parms parameter struct...">setup_parms</a>(arg);
<a name="l00641"></a>00641     info2(<span class="stringliteral">"After setup_parms:\t %.2f MiB\n"</span>,get_job_mem()/1024.);
<a name="l00642"></a>00642     <span class="keywordflow">if</span>(!<a class="code" href="maos_2utils_8c.html#a54aacd870579af5c2d7f1023f7a5624" title="Try to lock file for each seed.">lock_seeds</a>(parms)){
<a name="l00643"></a>00643     warning(<span class="stringliteral">"There are no seed to run. Exit\n"</span>);
<a name="l00644"></a>00644     maos_done(0);
<a name="l00645"></a>00645     <span class="keywordflow">return</span> 1;
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647     <span class="keywordflow">if</span>(!arg-&gt;<a class="code" href="structARG__T.html#c55657110f55a48957f1d60a18c4bf08" title="For start, bypassing scheduler.">force</a>){
<a name="l00648"></a>00648     <span class="comment">/*</span>
<a name="l00649"></a>00649 <span class="comment">      Ask job scheduler for permission to proceed. If no CPUs are</span>
<a name="l00650"></a>00650 <span class="comment">      available, will block until ones are available.</span>
<a name="l00651"></a>00651 <span class="comment">      if arg-&gt;force==1, will run immediately.</span>
<a name="l00652"></a>00652 <span class="comment">    */</span>
<a name="l00653"></a>00653     info2(<span class="stringliteral">"Waiting start signal from the scheduler ...\n"</span>);
<a name="l00654"></a>00654     <span class="keywordtype">int</span> count=0;
<a name="l00655"></a>00655     <span class="keywordflow">while</span>(scheduler_wait()&amp;&amp; count&lt;60){
<a name="l00656"></a>00656         <span class="comment">/*Failed to wait. fall back to own checking.*/</span>
<a name="l00657"></a>00657         warning3(<span class="stringliteral">"failed to get reply from scheduler. retry\n"</span>);
<a name="l00658"></a>00658         sleep(10);
<a name="l00659"></a>00659         count++;
<a name="l00660"></a>00660         scheduler_start(scmd,arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>,!arg-&gt;<a class="code" href="structARG__T.html#c55657110f55a48957f1d60a18c4bf08" title="For start, bypassing scheduler.">force</a>);
<a name="l00661"></a>00661     }
<a name="l00662"></a>00662     <span class="keywordflow">if</span>(count&gt;=60){
<a name="l00663"></a>00663         warning3(<span class="stringliteral">"fall back to own checker\n"</span>);
<a name="l00664"></a>00664         wait_cpu(arg-&gt;<a class="code" href="structARG__T.html#18bb19154482544ae53621864bab3756" title="Number of threads.">nthread</a>);
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     }
<a name="l00667"></a>00667     info2(<span class="stringliteral">"\n*** Simulation started at %s in %s. ***\n\n"</span>,myasctime(),myhostname());
<a name="l00668"></a>00668     free(scmd);
<a name="l00669"></a>00669     free(arg-&gt;<a class="code" href="structARG__T.html#e850f463984604b4981a0f3020554613" title="Array of seeds.">seeds</a>);
<a name="l00670"></a>00670     free(arg-&gt;<a class="code" href="structARG__T.html#e50d58a11ebd55e899f48ad1b073e3e7" title="Result output directory.">dirout</a>);
<a name="l00671"></a>00671     free(arg-&gt;<a class="code" href="structARG__T.html#989ce68b27a48e963ca257974c3e720d">conf</a>);
<a name="l00672"></a>00672     free(arg);
<a name="l00673"></a>00673     
<a name="l00674"></a>00674 <span class="preprocessor">#if USE_PTHREAD == 2</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>    <span class="comment">//Create thread pool.</span>
<a name="l00676"></a>00676     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7691a6a576a70e837fa68092a6ca26de" title="Number of threads to run the simulation.">nthread</a>&gt;1)
<a name="l00677"></a>00677     default_pool=thr_pool_create(1,parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#7691a6a576a70e837fa68092a6ca26de" title="Number of threads to run the simulation.">nthread</a>,3600,NULL);
<a name="l00678"></a>00678 <span class="preprocessor">#endif</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span>    dirsetup=stradd(<span class="stringliteral">"setup"</span>,NULL);
<a name="l00680"></a>00680     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#e8cbc9dfdcddc18df6c55c9a76edfdc2" title="Specify what to save to file for debugging.">save</a>.<a class="code" href="structSAVE__CFG__T.html#6eb5125b66e8369f1478f475c55cc220" title="save preparation matrices">setup</a>){
<a name="l00681"></a>00681     mymkdir(<span class="stringliteral">"%s"</span>,dirsetup);
<a name="l00682"></a>00682     <a class="code" href="path_8c.html#8539b4e587a7ea71221206e43f29ead5" title="Add a directory to path.">addpath</a>(dirsetup);
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     <span class="keywordflow">if</span>(parms-&gt;<a class="code" href="structPARMS__T.html#fc4942859637870067cc23401f5eeedc" title="Simulation information.">sim</a>.<a class="code" href="structSIM__CFG__T.html#8615676f068e88311d6f774e6cb92354" title="1: we are doing skycoverage preprocessing">skysim</a>){
<a name="l00685"></a>00685     dirskysim=stradd(<span class="stringliteral">"skysim"</span>,NULL);
<a name="l00686"></a>00686     mymkdir(<span class="stringliteral">"%s"</span>,dirskysim);
<a name="l00687"></a>00687     }<span class="keywordflow">else</span>{
<a name="l00688"></a>00688     dirskysim=mystrdup(<span class="stringliteral">"."</span>);
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="comment">/*Loads the main software*/</span>
<a name="l00692"></a>00692     <a class="code" href="maos_8c.html#03b12a216d3e6a33a008f5e35da726e3" title="This is the routine that calls various functions to do the simulation.">maos</a>(parms);
<a name="l00693"></a>00693     maos_done(0);
<a name="l00694"></a>00694     free_parms(parms);
<a name="l00695"></a>00695     free(dirsetup);
<a name="l00696"></a>00696     free(dirskysim);
<a name="l00697"></a>00697     info2(<span class="stringliteral">"Job finished at %s\t%.2f MiB\n"</span>,myasctime(),get_job_mem()/1024.);
<a name="l00698"></a>00698     exit_success=1;<span class="comment">//tell mem.c to print non-freed memory in debug mode.</span>
<a name="l00699"></a>00699     <span class="keywordflow">return</span> 0;
<a name="l00700"></a>00700 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<p><center><img src="maos_8c_3c04138a5bfe5d72780bb7e82a18e627_cgraph.png" border="0" usemap="#maos_8c_3c04138a5bfe5d72780bb7e82a18e627_cgraph_map" alt=""></center>
<map name="maos_8c_3c04138a5bfe5d72780bb7e82a18e627_cgraph_map">
<area shape="rect" id="node3" href="path_8c.html#8539b4e587a7ea71221206e43f29ead5" title="Add a directory to path." alt="" coords="143,59,209,88"><area shape="rect" id="node5" href="maos_2utils_8c.html#a54aacd870579af5c2d7f1023f7a5624" title="Try to lock file for each seed." alt="" coords="132,112,220,141"><area shape="rect" id="node7" href="maos_8c.html#03b12a216d3e6a33a008f5e35da726e3" title="This is the routine that calls various functions to do the simulation." alt="" coords="149,165,203,195"><area shape="rect" id="node23" href="maos_2utils_8c.html#6331baae7550213ee98a12f9c3bbc5ce" title="Handles signals." alt="" coords="104,219,248,248"><area shape="rect" id="node25" href="maos_2utils_8c.html#cb9c938dc842d5c52a16c7443fdb4ae3" title="Parse command line arguments argc, argv." alt="" coords="133,272,219,301"><area shape="rect" id="node27" href="maos_2parms_8h.html#97bc282d28009f59b0b4e51013062588" title="This routine calles other routines in this file to setup the parms parameter struct..." alt="" coords="128,325,224,355"><area shape="rect" id="node9" href="setup__aper_8c.html#ea65e60525339d2921549850d52e8464" title="Free the aper structure after simulation." alt="" coords="307,5,381,35"><area shape="rect" id="node11" href="maos_2setup__powfs_8c.html#4fdd29141f0d60af1fd7c6b2385f0031" title="Free all parameters of powfs at the end of simulation." alt="" coords="303,59,385,88"><area shape="rect" id="node13" href="setup__aper_8c.html#bf63108c7633e5a353e73cd913fc9c26" title="Setting up aperture cordinate grid aper_locs, and amplitude map for performance evaluation..." alt="" coords="301,112,387,141"><area shape="rect" id="node15" href="maos_2setup__powfs_8c.html#c7b704504acb96d7fbcbdd60f15c6cf8" title="Setup the powfs struct based on parms and aper." alt="" coords="297,165,391,195"><area shape="rect" id="node17" href="setup__recon_8c.html#6ec32666222d37047d7775b874969a2e" title="Sets up the reconstruction structs including wavefront reconstructor and DM fitting..." alt="" coords="297,219,391,248"><area shape="rect" id="node19" href="sim_8c.html#b5fd8ff2c1fe7a6270dad89ec5da4873" title="Closed loop simulation main loop." alt="" coords="323,272,365,301"><area shape="rect" id="node21" href="sim__utils_8c.html#1e1e48b76ff317024b24ae00f7096a56" title="Just do open loop error evalution." alt="" coords="307,325,381,355"></map>
</div>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Oct 27 12:43:14 2010 for maos-0.6.1 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
