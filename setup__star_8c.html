<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>maos-0.7.0: skyc/setup_star.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>skyc/setup_star.c File Reference</h1>setup stars.  
<a href="#_details">More...</a>
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="structSTAR__S.html">STAR_S</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__star_8c.html#55834d472dae40cf969cf8c226c81402">setup_star_create</a> (const PARMS_S *parms, <a class="el" href="structdmat.html">dmat</a> *coord)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create "star" data array from star information.  <a href="#55834d472dae40cf969cf8c226c81402"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="5a3f63c64013317d75058f726e01ef84"></a><!-- doxytag: member="setup_star.c::setup_star_read_pistat" ref="5a3f63c64013317d75058f726e01ef84" args="(SIM_S *simu, STAR_S *star, int nstar, int seed)" -->
static void&nbsp;</td><td class="memItemRight" valign="bottom"><b>setup_star_read_pistat</b> (<a class="el" href="structSIM__S.html">SIM_S</a> *simu, <a class="el" href="structSTAR__S.html">STAR_S</a> *star, int nstar, int seed)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="60b30495f89c0e2de14c259ce431ab92"></a><!-- doxytag: member="setup_star.c::setup_star_siglev" ref="60b30495f89c0e2de14c259ce431ab92" args="(const PARMS_S *parms, STAR_S *star, int nstar)" -->
static void&nbsp;</td><td class="memItemRight" valign="bottom"><b>setup_star_siglev</b> (const PARMS_S *parms, <a class="el" href="structSTAR__S.html">STAR_S</a> *star, int nstar)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="9a5438327c79c444bafa373efc14211f"></a><!-- doxytag: member="setup_star.c::setup_star_gnea" ref="9a5438327c79c444bafa373efc14211f" args="(const PARMS_S *parms, STAR_S *star, int nstar)" -->
static void&nbsp;</td><td class="memItemRight" valign="bottom"><b>setup_star_gnea</b> (const PARMS_S *parms, <a class="el" href="structSTAR__S.html">STAR_S</a> *star, int nstar)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="81b31aea2e35ac3498b7acc580d8eebb"></a><!-- doxytag: member="setup_star.c::setup_star_mtch" ref="81b31aea2e35ac3498b7acc580d8eebb" args="(const PARMS_S *parms, POWFS_S *powfs, STAR_S *star, int nstar)" -->
static void&nbsp;</td><td class="memItemRight" valign="bottom"><b>setup_star_mtch</b> (const PARMS_S *parms, <a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, <a class="el" href="structSTAR__S.html">STAR_S</a> *star, int nstar)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__star_8c.html#022f335d410049d72542d00005e4c3a1">setup_star_g</a> (const PARMS_S *parms, <a class="el" href="structPOWFS__S.html">POWFS_S</a> *powfs, <a class="el" href="structSTAR__S.html">STAR_S</a> *star, int nstar)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Compute Modal to gradient operator using average gradients.  <a href="#022f335d410049d72542d00005e4c3a1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="anchor" name="e68644330581363ba83630ac90ad9c9b"></a><!-- doxytag: member="setup_star.c::setup_star_read_wvf" ref="e68644330581363ba83630ac90ad9c9b" args="(STAR_S *star, int nstar, const PARMS_S *parms, int seed)" -->
long&nbsp;</td><td class="memItemRight" valign="bottom"><b>setup_star_read_wvf</b> (<a class="el" href="structSTAR__S.html">STAR_S</a> *star, int nstar, const PARMS_S *parms, int seed)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="structSTAR__S.html">STAR_S</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__star_8c.html#519487a9955705e723549fdc79195ec9">setup_star</a> (int *nstarout, <a class="el" href="structSIM__S.html">SIM_S</a> *simu, <a class="el" href="structdmat.html">dmat</a> *stars, int seed)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">setup "star" data array from star information and read in average pixel intensitys.  <a href="#519487a9955705e723549fdc79195ec9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__star_8c.html#b97c8d95f69d06729275e014775fc25a">free_star</a> (<a class="el" href="structSTAR__S.html">STAR_S</a> *star, int nstar, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free array of <a class="el" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a>.  <a href="#b97c8d95f69d06729275e014775fc25a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="setup__star_8c.html#f261402679395e8775009c60f13b05ab">free_pistat</a> (<a class="el" href="structPISTAT__S.html">PISTAT_S</a> *pistat, int npistat, const PARMS_S *parms)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free pixel intensities.  <a href="#f261402679395e8775009c60f13b05ab"></a><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
setup stars. 
<p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="55834d472dae40cf969cf8c226c81402"></a><!-- doxytag: member="setup_star.c::setup_star_create" ref="55834d472dae40cf969cf8c226c81402" args="(const PARMS_S *parms, dmat *coord)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="structSTAR__S.html">STAR_S</a>* setup_star_create           </td>
          <td>(</td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>coord</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Create "star" data array from star information. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00032"></a>00032                                                                    {
<a name="l00033"></a>00033     <span class="keywordflow">if</span>(!coord){
<a name="l00034"></a>00034     <span class="keywordflow">return</span> NULL;<span class="comment">//there are no stars available.</span>
<a name="l00035"></a>00035     }
<a name="l00036"></a>00036     <span class="keywordtype">int</span> nstar=coord-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>;
<a name="l00037"></a>00037     PDMAT(coord,pc);
<a name="l00038"></a>00038     <span class="keywordtype">int</span> nwvl=parms-&gt;maos.nwvl;
<a name="l00039"></a>00039     <a class="code" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a> *star=calloc(nstar, <span class="keyword">sizeof</span>(<a class="code" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a>));
<a name="l00040"></a>00040     <span class="keywordtype">double</span> ngsgrid=parms-&gt;maos.ngsgrid/206265;
<a name="l00041"></a>00041     <span class="keywordtype">double</span> r2=pow(parms-&gt;skyc.patfov/206265./2.,2);
<a name="l00042"></a>00042     <span class="keywordtype">double</span> keepout=pow(parms-&gt;skyc.keepout/206265,2);
<a name="l00043"></a>00043     <span class="keywordtype">int</span> jstar=0;
<a name="l00044"></a>00044     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> istar=0; istar&lt;nstar; istar++){
<a name="l00045"></a>00045     <span class="keywordflow">if</span>(parms-&gt;skyc.ngsalign){
<a name="l00046"></a>00046         star[jstar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>=round(pc[istar][0]/ngsgrid)*ngsgrid;
<a name="l00047"></a>00047         star[jstar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>=round(pc[istar][1]/ngsgrid)*ngsgrid;
<a name="l00048"></a>00048         <span class="keywordflow">if</span>(pow(star[jstar].thetax,2)+pow(star[jstar].thetay,2)&gt;r2){
<a name="l00049"></a>00049         star[jstar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>=trunc(pc[istar][0]/ngsgrid)*ngsgrid;
<a name="l00050"></a>00050         star[jstar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>=round(pc[istar][1]/ngsgrid)*ngsgrid;
<a name="l00051"></a>00051         <span class="keywordflow">if</span>(pow(star[jstar].thetax,2)+pow(star[jstar].thetay,2)&gt;r2){
<a name="l00052"></a>00052             star[jstar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>=round(pc[istar][0]/ngsgrid)*ngsgrid;
<a name="l00053"></a>00053             star[jstar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>=trunc(pc[istar][1]/ngsgrid)*ngsgrid;
<a name="l00054"></a>00054             <span class="keywordflow">if</span>(pow(star[jstar].thetax,2)+pow(star[jstar].thetay,2)&gt;r2){
<a name="l00055"></a>00055             star[jstar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>=trunc(pc[istar][0]/ngsgrid)*ngsgrid;
<a name="l00056"></a>00056             star[jstar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>=trunc(pc[istar][1]/ngsgrid)*ngsgrid;
<a name="l00057"></a>00057             <span class="keywordflow">if</span>(pow(star[jstar].thetax,2)+pow(star[jstar].thetay,2)&gt;r2){
<a name="l00058"></a>00058                 error(<span class="stringliteral">"What?\n"</span>);
<a name="l00059"></a>00059             }
<a name="l00060"></a>00060             }
<a name="l00061"></a>00061         }
<a name="l00062"></a>00062         }
<a name="l00063"></a>00063     }<span class="keywordflow">else</span>{
<a name="l00064"></a>00064         star[jstar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>=pc[istar][0];
<a name="l00065"></a>00065         star[jstar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>=pc[istar][1];
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> kstar=0; kstar&lt;jstar; kstar++){
<a name="l00068"></a>00068         <span class="keywordflow">if</span>(pow(star[jstar].thetax-star[kstar].thetax,2)
<a name="l00069"></a>00069            +pow(star[jstar].thetay-star[kstar].thetay,2)&lt;keepout){
<a name="l00070"></a>00070         <span class="comment">//warning("start %d is too close to %d. use J brightest.\n", jstar, kstar);</span>
<a name="l00071"></a>00071         <span class="keywordflow">if</span>(pc[istar][0]&lt;star[kstar].mags-&gt;p[0]){
<a name="l00072"></a>00072             memcpy(star[kstar].mags-&gt;p, pc[istar]+2, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*nwvl);
<a name="l00073"></a>00073             star[kstar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>=star[jstar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>;
<a name="l00074"></a>00074             star[kstar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>=star[jstar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>;
<a name="l00075"></a>00075         }
<a name="l00076"></a>00076         <span class="keywordflow">continue</span>;
<a name="l00077"></a>00077         }
<a name="l00078"></a>00078     }
<a name="l00079"></a>00079     star[jstar].<a class="code" href="structSTAR__S.html#edb9ee12559f545b7753087f431db43e" title="star magnitude at each wavelength">mags</a>=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nwvl,1);
<a name="l00080"></a>00080     memcpy(star[jstar].mags-&gt;p, pc[istar]+2, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*nwvl);
<a name="l00081"></a>00081     star[jstar].<a class="code" href="structSTAR__S.html#a23329e6d8c5e94f4b682c1a6975fc5c" title="whether this star is used in phy simulations, of size npowfs*1">use</a>=calloc(parms-&gt;maos.npowfs, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00082"></a>00082     jstar++;
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084     <span class="keywordflow">if</span>(jstar&lt;nstar){
<a name="l00085"></a>00085     <span class="comment">//warning2("%d stars dropped\n", nstar-jstar);</span>
<a name="l00086"></a>00086     coord-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>=jstar;
<a name="l00087"></a>00087     star=realloc(star, jstar*<span class="keyword">sizeof</span>(<a class="code" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a>));
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089     <span class="keywordflow">return</span> star;
<a name="l00090"></a>00090 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="022f335d410049d72542d00005e4c3a1"></a><!-- doxytag: member="setup_star.c::setup_star_g" ref="022f335d410049d72542d00005e4c3a1" args="(const PARMS_S *parms, POWFS_S *powfs, STAR_S *star, int nstar)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void setup_star_g           </td>
          <td>(</td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structPOWFS__S.html">POWFS_S</a> *&nbsp;</td>
          <td class="paramname"> <em>powfs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structSTAR__S.html">STAR_S</a> *&nbsp;</td>
          <td class="paramname"> <em>star</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>nstar</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Compute Modal to gradient operator using average gradients. 
<p>
Similar to Z tilt since the mode is low order <div class="fragment"><pre class="fragment"><a name="l00355"></a>00355                                                                                        {
<a name="l00356"></a>00356     <span class="keyword">const</span> <span class="keywordtype">long</span> npowfs=parms-&gt;maos.npowfs;
<a name="l00357"></a>00357     
<a name="l00358"></a>00358     <span class="keyword">const</span> <span class="keywordtype">double</span> hc=parms-&gt;maos.hc;
<a name="l00359"></a>00359     <span class="keyword">const</span> <span class="keywordtype">double</span> hs=parms-&gt;maos.hs;
<a name="l00360"></a>00360     <span class="keyword">const</span> <span class="keywordtype">double</span> scale=pow(1.-hc/hs, -2);
<a name="l00361"></a>00361     <span class="keyword">const</span> <span class="keywordtype">double</span> scale1=1.-scale;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> istar=0; istar&lt;nstar; istar++){
<a name="l00364"></a>00364     star[istar].<a class="code" href="structSTAR__S.html#968e890d9c85564d8e4e9d2e92ba8f93" title="gradient operator of size npowfs*1">g</a>=dcellnew(npowfs, 1);
<a name="l00365"></a>00365     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs; ipowfs++){
<a name="l00366"></a>00366         <span class="keyword">const</span> <span class="keywordtype">long</span> nsa=parms-&gt;maos.nsa[ipowfs];
<a name="l00367"></a>00367         <span class="keyword">const</span> <span class="keywordtype">double</span> thetax=star[istar].<a class="code" href="structSTAR__S.html#63d20ad36dedd4dfd81515b441c7c7fc" title="star location">thetax</a>;
<a name="l00368"></a>00368         <span class="keyword">const</span> <span class="keywordtype">double</span> thetay=star[istar].<a class="code" href="structSTAR__S.html#a32f7d5cd4938f0d5cedd9d78deab27b" title="star location">thetay</a>;
<a name="l00369"></a>00369         star[istar].<a class="code" href="structSTAR__S.html#968e890d9c85564d8e4e9d2e92ba8f93" title="gradient operator of size npowfs*1">g</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[ipowfs]=<a class="code" href="dmat_8h.html#0d7497e2dbb79adb228de6bdde4a201e" title="Create a new T matrix object.">dnew</a>(nsa*2, parms-&gt;maos.nmod);
<a name="l00370"></a>00370         PDMAT(star[istar].g-&gt;p[ipowfs], pg);
<a name="l00371"></a>00371         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> isa=0; isa&lt;nsa; isa++){
<a name="l00372"></a>00372         <span class="keyword">const</span> <span class="keywordtype">double</span> xm=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#70d0cb0bbf7ca40967b8ba9269ada83d" title="dot(loc-&amp;gt;locx,amp);">locxamp</a>[isa];<span class="comment">//dot of x with amp.</span>
<a name="l00373"></a>00373         <span class="keyword">const</span> <span class="keywordtype">double</span> ym=powfs[ipowfs].<a class="code" href="structPOWFS__S.html#4914f5c1129c558188f045183e27f02e" title="dot(loc-&amp;gt;locy,amp);">locyamp</a>[isa];
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         pg[0][isa]     = 1.;
<a name="l00376"></a>00376         pg[1][isa+nsa] = 1.;
<a name="l00377"></a>00377         pg[2][isa]     = (scale1*2*xm - 2*thetax*hc*scale);
<a name="l00378"></a>00378         pg[2][isa+nsa] = (scale1*2*ym - 2*thetay*hc*scale);
<a name="l00379"></a>00379         pg[3][isa]     = (scale1*2*xm - 2*thetax*hc*scale);
<a name="l00380"></a>00380         pg[3][isa+nsa] = (-scale1*2*ym+ 2*thetay*hc*scale);
<a name="l00381"></a>00381         pg[4][isa]     = (scale1*ym   - thetay*hc*scale);
<a name="l00382"></a>00382         pg[4][isa+nsa] = (scale1*xm   - thetax*hc*scale);
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385     <span class="keywordflow">if</span>(parms-&gt;skyc.dbg){
<a name="l00386"></a>00386         <a class="code" href="dmat_8h.html#70cd951a3932002ccc9270944d2005ec" title="User callable function to write cell array of dense matrix into a file.">dcellwrite</a>(star[istar].g,<span class="stringliteral">"%s/star%d_g"</span>,dirsetup,istar);
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="519487a9955705e723549fdc79195ec9"></a><!-- doxytag: member="setup_star.c::setup_star" ref="519487a9955705e723549fdc79195ec9" args="(int *nstarout, SIM_S *simu, dmat *stars, int seed)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structSTAR__S.html">STAR_S</a>* setup_star           </td>
          <td>(</td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>nstarout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structSIM__S.html">SIM_S</a> *&nbsp;</td>
          <td class="paramname"> <em>simu</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structdmat.html">dmat</a> *&nbsp;</td>
          <td class="paramname"> <em>stars</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>seed</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
setup "star" data array from star information and read in average pixel intensitys. 
<p>
Check for star PSF size. If it is larger than 5, we don't use the star because the PSF is too broad. <div class="fragment"><pre class="fragment"><a name="l00547"></a>00547                                                                     {
<a name="l00548"></a>00548     <span class="keyword">const</span> PARMS_S *parms=simu-&gt;<a class="code" href="structSIM__S.html#11bdee524a845bb9e8a9a909eb6868e0" title="input parameters">parms</a>;
<a name="l00549"></a>00549     <a class="code" href="structPOWFS__S.html" title="Struct for POWFS.">POWFS_S</a> *powfs=simu-&gt;<a class="code" href="structSIM__S.html#237d4ada723433a142306d23cfd4a934" title="structs about POWFS">powfs</a>;
<a name="l00550"></a>00550     <span class="keywordflow">if</span>(!stars){
<a name="l00551"></a>00551     <span class="keywordflow">return</span> NULL;
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553     <a class="code" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a> *star=<a class="code" href="setup__star_8c.html#55834d472dae40cf969cf8c226c81402" title="Create &amp;quot;star&amp;quot; data array from star information.">setup_star_create</a>(parms, stars);
<a name="l00554"></a>00554     <span class="keywordtype">int</span> nstar=stars-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>;
<a name="l00555"></a>00555     setup_star_read_pistat(simu, star, nstar, seed);
<a name="l00556"></a>00556     <span class="keywordtype">int</span> jstar=0;
<a name="l00557"></a>00557     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> istar=0; istar&lt;nstar; istar++){
<a name="l00558"></a>00558     <a class="code" href="structdmat.html" title="a double matrix object contains 2-d array of double numbers">dmat</a> *pistat=star[istar].<a class="code" href="structSTAR__S.html#f48bf08f6c5e3895163c14859723fe82" title="pixel intensity statstics npowf*1">pistat</a>[parms-&gt;skyc.npowfs-1].<a class="code" href="structPISTAT__S.html#24a2b44eb21bbe993ba16947b079ee6f" title="short exposure PSF">psf</a>-&gt;<a class="code" href="structdcell.html#c6bfb5d224d69b6fa412f4e84b550d6f" title="Contains an array of pointers to dmat.">p</a>[0];
<a name="l00559"></a>00559     <span class="keywordtype">double</span> pmax=<a class="code" href="dmat_8h.html#abb4fecd296ac9ec19263e0f9d853be7" title="find the maximum value of a X(mat) object">dmax</a>(pistat);
<a name="l00560"></a>00560     <span class="keywordtype">int</span> size=0;
<a name="l00561"></a>00561     <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i=0; i&lt;pistat-&gt;<a class="code" href="structdmat.html#983086836d817046db8588de2873dd36" title="number of rows">nx</a>*pistat-&gt;<a class="code" href="structdmat.html#690854282ff0f4fbd5d734d6c377c9b2" title="number of columns">ny</a>; i++){
<a name="l00562"></a>00562         <span class="keywordflow">if</span>(pistat-&gt;<a class="code" href="structdmat.html#653d0780e19f58a3f74ead17630d9dcb" title="the pointer to allocated memory.">p</a>[i]&gt;pmax*0.5){
<a name="l00563"></a>00563         size++;
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566     <span class="keywordflow">if</span>(size&gt;5){
<a name="l00567"></a>00567         <a class="code" href="setup__star_8c.html#f261402679395e8775009c60f13b05ab" title="Free pixel intensities.">free_pistat</a>(star[istar].pistat, parms-&gt;skyc.npowfs, parms);
<a name="l00568"></a>00568         warning(<span class="stringliteral">"star %d doesn't have sharpen cores. size=%d\n"</span>,istar,size);
<a name="l00569"></a>00569     }<span class="keywordflow">else</span>{
<a name="l00570"></a>00570         <span class="keywordflow">if</span>(istar!=jstar){
<a name="l00571"></a>00571         memcpy(&amp;star[jstar], &amp;star[istar], <span class="keyword">sizeof</span>(<a class="code" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a>));
<a name="l00572"></a>00572         }
<a name="l00573"></a>00573         jstar++;
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576     <span class="keywordflow">if</span>(jstar==0){
<a name="l00577"></a>00577     free(star);
<a name="l00578"></a>00578     <span class="keywordflow">return</span> NULL;
<a name="l00579"></a>00579     }
<a name="l00580"></a>00580     <span class="keywordflow">if</span>(jstar&gt;parms-&gt;skyc.maxstar){
<a name="l00581"></a>00581     jstar=parms-&gt;skyc.maxstar;<span class="comment">//we only keed maxstar number of brightest stars.</span>
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583     <span class="keywordflow">if</span>(jstar!=nstar){
<a name="l00584"></a>00584     star=realloc(star,<span class="keyword">sizeof</span>(<a class="code" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a>)*jstar);
<a name="l00585"></a>00585     nstar=jstar;
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587     <span class="keywordflow">if</span>(parms-&gt;skyc.verbose){
<a name="l00588"></a>00588     info2(<span class="stringliteral">"There are %d stars usable from %d stars\n"</span>,jstar,nstar);
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590     *nstarout=nstar;
<a name="l00591"></a>00591     setup_star_siglev(parms, star, nstar);
<a name="l00592"></a>00592     setup_star_gnea(parms, star, nstar);
<a name="l00593"></a>00593     setup_star_mtch(parms, powfs, star, nstar);
<a name="l00594"></a>00594     <a class="code" href="setup__star_8c.html#022f335d410049d72542d00005e4c3a1" title="Compute Modal to gradient operator using average gradients.">setup_star_g</a>(parms, powfs, star, nstar);
<a name="l00595"></a>00595     <span class="keywordflow">return</span> star;
<a name="l00596"></a>00596 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b97c8d95f69d06729275e014775fc25a"></a><!-- doxytag: member="setup_star.c::free_star" ref="b97c8d95f69d06729275e014775fc25a" args="(STAR_S *star, int nstar, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_star           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structSTAR__S.html">STAR_S</a> *&nbsp;</td>
          <td class="paramname"> <em>star</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>nstar</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Free array of <a class="el" href="structSTAR__S.html" title="Data for each available star.">STAR_S</a>. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00600"></a>00600                                                              {
<a name="l00601"></a>00601     <span class="keyword">const</span> <span class="keywordtype">long</span> npowfs=parms-&gt;maos.npowfs;
<a name="l00602"></a>00602     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> istar=0; istar&lt;nstar; istar++){
<a name="l00603"></a>00603     <a class="code" href="setup__star_8c.html#f261402679395e8775009c60f13b05ab" title="Free pixel intensities.">free_pistat</a>(star[istar].pistat,npowfs, parms);
<a name="l00604"></a>00604     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipowfs=0; ipowfs&lt;npowfs; ipowfs++){
<a name="l00605"></a>00605         <span class="keywordflow">if</span>(star[istar].wvfout[ipowfs]){
<a name="l00606"></a>00606         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> istep=0; istep&lt;star[istar].<a class="code" href="structSTAR__S.html#72e351fbfd4331b32dcb920d9412e738" title="number of time steps available.">nstep</a>; istep++){
<a name="l00607"></a>00607             ccellfree(star[istar].wvfout[ipowfs][istep]);
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609         }
<a name="l00610"></a>00610         free(star[istar].wvfout[ipowfs]);
<a name="l00611"></a>00611         dcellfree(star[istar].ztiltout[ipowfs]);
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613     free(star[istar].wvfout);
<a name="l00614"></a>00614     free(star[istar].ztiltout);
<a name="l00615"></a>00615     dcellfree(star[istar].g);
<a name="l00616"></a>00616     dfree(star[istar].mags);
<a name="l00617"></a>00617     free(star[istar].use);
<a name="l00618"></a>00618     dfree(star[istar].siglev);
<a name="l00619"></a>00619     dfree(star[istar].siglevtot);
<a name="l00620"></a>00620     dfree(star[istar].bkgrnd);
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622     free(star);
<a name="l00623"></a>00623 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f261402679395e8775009c60f13b05ab"></a><!-- doxytag: member="setup_star.c::free_pistat" ref="f261402679395e8775009c60f13b05ab" args="(PISTAT_S *pistat, int npistat, const PARMS_S *parms)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_pistat           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structPISTAT__S.html">PISTAT_S</a> *&nbsp;</td>
          <td class="paramname"> <em>pistat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>npistat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const PARMS_S *&nbsp;</td>
          <td class="paramname"> <em>parms</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Free pixel intensities. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00627"></a>00627                                                                      {
<a name="l00628"></a>00628     <span class="keywordflow">if</span>(!pistat) <span class="keywordflow">return</span>;
<a name="l00629"></a>00629     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ipistat=0; ipistat&lt;npistat; ipistat++){
<a name="l00630"></a>00630     dcellfree(pistat[ipistat].psf);
<a name="l00631"></a>00631     dcellfree(pistat[ipistat].i0);
<a name="l00632"></a>00632     dcellfree(pistat[ipistat].gx);
<a name="l00633"></a>00633     dcellfree(pistat[ipistat].gy);
<a name="l00634"></a>00634     dcellfree(pistat[ipistat].i0s);
<a name="l00635"></a>00635     dcellfree(pistat[ipistat].gxs);
<a name="l00636"></a>00636     dcellfree(pistat[ipistat].gys);
<a name="l00637"></a>00637     dcellfree(pistat[ipistat].sanea);
<a name="l00638"></a>00638     dfree(pistat[ipistat].scale);
<a name="l00639"></a>00639     dfree(pistat[ipistat].grad);
<a name="l00640"></a>00640     dcellfree(pistat[ipistat].gnea);
<a name="l00641"></a>00641     <span class="keywordtype">int</span> ndtrat=parms-&gt;skyc.ndtrat;
<a name="l00642"></a>00642     <span class="keywordflow">if</span>(pistat[ipistat].mtche){
<a name="l00643"></a>00643        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> idtrat=0; idtrat&lt;ndtrat; idtrat++){
<a name="l00644"></a>00644            dcellfree(pistat[ipistat].mtche[idtrat]);
<a name="l00645"></a>00645        }
<a name="l00646"></a>00646        free(pistat[ipistat].mtche);
<a name="l00647"></a>00647        pistat[ipistat].<a class="code" href="structPISTAT__S.html#0495c38753820337ee10cb3620bd6cea" title="matched filter estimator">mtche</a>=NULL;
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651     free(pistat);
<a name="l00652"></a>00652 }
</pre></div>
<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 29 21:16:58 2010 for maos-0.7.0 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
